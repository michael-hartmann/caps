#include "libcaps.h"
#include "misc.h"
#include "unittest.h"

#include "test_fresnel.h"

int test_caps_fresnel()
{
    unittest_t test;
    caps_t *caps;
    double rTE, rTM;
    double userdata[2];

    unittest_init(&test, "caps_fresnel", "Fresnel coefficients", 2e-15);

    caps = caps_init(1.000000e-04,1.000000e-06);

    userdata[0] = 0.01/CAPS_HBAR_EV; /* 0.01eV */
    userdata[1] = 1e-05/CAPS_HBAR_EV; /* 1e-05eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999604623024525);
    AssertAlmostEqual(&test, rTM, 0.9999802309558168);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997190657838733);
    AssertAlmostEqual(&test, rTM, 0.9999972180861549);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9972079734259837);
    AssertAlmostEqual(&test, rTM, 0.9999997204344764);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9724301509764021);
    AssertAlmostEqual(&test, rTM, 0.9999999720393561);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7567845818886872);
    AssertAlmostEqual(&test, rTM, 0.999999997177023);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1029494263662654);
    AssertAlmostEqual(&test, rTM, 0.9999999995194722);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001276089014521366);
    AssertAlmostEqual(&test, rTM, 0.9999999996081784);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.27931933166733e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999996091672);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279351738106307e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999996091771);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.27935206218106e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999996091772);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279352065421808e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999996091772);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279352065454216e-13);
    AssertAlmostEqual(&test, rTM, 0.9999999996091772);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.27935206545454e-15);
    AssertAlmostEqual(&test, rTM, 0.9999999996091772);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999110742059516);
    AssertAlmostEqual(&test, rTM, 0.9999119546205965);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998748663249644);
    AssertAlmostEqual(&test, rTM, 0.9999374312049939);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991110978549883);
    AssertAlmostEqual(&test, rTM, 0.9999911951123446);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.99118978517347);
    AssertAlmostEqual(&test, rTM, 0.9999991151519049);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9153400839481458);
    AssertAlmostEqual(&test, rTM, 0.9999999114250736);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4238840369425579);
    AssertAlmostEqual(&test, rTM, 0.9999999903237414);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01245492462555115);
    AssertAlmostEqual(&test, rTM, 0.9999999959861464);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001276780795135127);
    AssertAlmostEqual(&test, rTM, 0.9999999960839011);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.27710362943424e-06);
    AssertAlmostEqual(&test, rTM, 0.999999996084891);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.277106858807823e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999960849009);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.277106891101662e-10);
    AssertAlmostEqual(&test, rTM, 0.999999996084901);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.2771068914246e-12);
    AssertAlmostEqual(&test, rTM, 0.999999996084901);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.277106891427829e-14);
    AssertAlmostEqual(&test, rTM, 0.999999996084901);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9990339387860411);
    AssertAlmostEqual(&test, rTM, 0.9990339397516345);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9990338909903526);
    AssertAlmostEqual(&test, rTM, 0.9990339875449118);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999029123321052);
    AssertAlmostEqual(&test, rTM, 0.9990387313390288);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9986340572660607);
    AssertAlmostEqual(&test, rTM, 0.9993167951689124);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.990333578086697);
    AssertAlmostEqual(&test, rTM, 0.9999038304114183);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9079009285403404);
    AssertAlmostEqual(&test, rTM, 0.9999903239749219);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3936135049958998);
    AssertAlmostEqual(&test, rTM, 0.9999989265270348);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01048140020709287);
    AssertAlmostEqual(&test, rTM, 0.9999995230171358);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000107023320169037);
    AssertAlmostEqual(&test, rTM, 0.9999995328123256);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.070460026625102e-06);
    AssertAlmostEqual(&test, rTM, 0.9999995329113147);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.070462295481388e-08);
    AssertAlmostEqual(&test, rTM, 0.9999995329123047);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.070462318170011e-10);
    AssertAlmostEqual(&test, rTM, 0.9999995329123147);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.070462318396898e-12);
    AssertAlmostEqual(&test, rTM, 0.9999995329123147);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9952070285771343);
    AssertAlmostEqual(&test, rTM, 0.9952070286249489);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9952070262103134);
    AssertAlmostEqual(&test, rTM, 0.9952070309917685);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.995206789534171);
    AssertAlmostEqual(&test, rTM, 0.9952072676560172);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9951831810707509);
    AssertAlmostEqual(&test, rTM, 0.9952307583471078);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9932284561547626);
    AssertAlmostEqual(&test, rTM, 0.9966084670935594);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9528670140848164);
    AssertAlmostEqual(&test, rTM, 0.9995219122380034);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6212831546445051);
    AssertAlmostEqual(&test, rTM, 0.9999505920019873);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03993083299880098);
    AssertAlmostEqual(&test, rTM, 0.9999874984760788);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004328403241471885);
    AssertAlmostEqual(&test, rTM, 0.9999884485317057);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.332115198789758e-06);
    AssertAlmostEqual(&test, rTM, 0.9999884584272062);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.332152358555834e-08);
    AssertAlmostEqual(&test, rTM, 0.9999884585262041);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.332152730157519e-10);
    AssertAlmostEqual(&test, rTM, 0.9999884585271941);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.332152733873536e-12);
    AssertAlmostEqual(&test, rTM, 0.999988458527204);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9607322815927107);
    AssertAlmostEqual(&test, rTM, 0.9607322815965589);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9607322814022283);
    AssertAlmostEqual(&test, rTM, 0.9607322817870413);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9607322623539892);
    AssertAlmostEqual(&test, rTM, 0.9607323008352712);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9607303575796227);
    AssertAlmostEqual(&test, rTM, 0.9607342055172677);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.960540373076947);
    AssertAlmostEqual(&test, rTM, 0.9609232753844565);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9449257839727582);
    AssertAlmostEqual(&test, rTM, 0.9720674101900894);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.670354331861994);
    AssertAlmostEqual(&test, rTM, 0.9959435677173295);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05556848563178084);
    AssertAlmostEqual(&test, rTM, 0.9991038390080458);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006222858626727195);
    AssertAlmostEqual(&test, rTM, 0.9991971565403953);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.230539184183149e-06);
    AssertAlmostEqual(&test, rTM, 0.9991981447270015);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.230616109417299e-08);
    AssertAlmostEqual(&test, rTM, 0.9991981546150349);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.230616878681628e-10);
    AssertAlmostEqual(&test, rTM, 0.9991981547139158);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.230616886374273e-12);
    AssertAlmostEqual(&test, rTM, 0.9991981547149047);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6775428056058794);
    AssertAlmostEqual(&test, rTM, 0.67754280560614);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.677542805592986);
    AssertAlmostEqual(&test, rTM, 0.6775428056190335);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6775428043036372);
    AssertAlmostEqual(&test, rTM, 0.6775428069083821);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6775426753688117);
    AssertAlmostEqual(&test, rTM, 0.6775429358431653);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6775297823443511);
    AssertAlmostEqual(&test, rTM, 0.6775558284428077);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6762450372613529);
    AssertAlmostEqual(&test, rTM, 0.6788363685652938);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5785904806533552);
    AssertAlmostEqual(&test, rTM, 0.756838950252106);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05733101837211199);
    AssertAlmostEqual(&test, rTM, 0.9204127924917331);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006507044701049258);
    AssertAlmostEqual(&test, rTM, 0.9286465843119703);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.516081416440753e-06);
    AssertAlmostEqual(&test, rTM, 0.9287351816323791);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.516171937699407e-08);
    AssertAlmostEqual(&test, rTM, 0.9287360683121875);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.516172842927434e-10);
    AssertAlmostEqual(&test, rTM, 0.9287360771790564);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.516172851979716e-12);
    AssertAlmostEqual(&test, rTM, 0.928736077267725);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05807869275950553);
    AssertAlmostEqual(&test, rTM, 0.05807869275950656);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05807869275945434);
    AssertAlmostEqual(&test, rTM, 0.05807869275955774);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05807869275433577);
    AssertAlmostEqual(&test, rTM, 0.05807869276467632);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05807869224247874);
    AssertAlmostEqual(&test, rTM, 0.05807869327653335);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05807864105682106);
    AssertAlmostEqual(&test, rTM, 0.05807874446219072);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05807352294817292);
    AssertAlmostEqual(&test, rTM, 0.05808386256772412);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05756624267702897);
    AssertAlmostEqual(&test, rTM, 0.05859111223704998);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03074894098636187);
    AssertAlmostEqual(&test, rTM, 0.08532166756813654);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006472973054225108);
    AssertAlmostEqual(&test, rTM, 0.1151282181243579);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.545434446150154e-06);
    AssertAlmostEqual(&test, rTM, 0.1157604305106686);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546167281214509e-08);
    AssertAlmostEqual(&test, rTM, 0.1157668236439184);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546174610396626e-10);
    AssertAlmostEqual(&test, rTM, 0.1157668875824319);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546174683688531e-12);
    AssertAlmostEqual(&test, rTM, 0.1157668882218177);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540625711025422);
    AssertAlmostEqual(&test, rTM, 0.0006540625711025424);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540625711025358);
    AssertAlmostEqual(&test, rTM, 0.0006540625711025488);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000654062571101889);
    AssertAlmostEqual(&test, rTM, 0.0006540625711031955);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540625710372215);
    AssertAlmostEqual(&test, rTM, 0.0006540625711678631);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540625645704669);
    AssertAlmostEqual(&test, rTM, 0.0006540625776346175);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540619178956599);
    AssertAlmostEqual(&test, rTM, 0.0006540632243094245);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006539972568719641);
    AssertAlmostEqual(&test, rTM, 0.0006541278853331148);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006475950860860073);
    AssertAlmostEqual(&test, rTM, 0.0006605300560643604);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003272452194276659);
    AssertAlmostEqual(&test, rTM, 0.0009808797830571198);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.484262511313918e-06);
    AssertAlmostEqual(&test, rTM, 0.001301640331121694);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54853435829926e-08);
    AssertAlmostEqual(&test, rTM, 0.001308059097360674);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549183511725105e-10);
    AssertAlmostEqual(&test, rTM, 0.001308123927674974);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549190003909303e-12);
    AssertAlmostEqual(&test, rTM, 0.001308124576043026);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549405970508387e-06);
    AssertAlmostEqual(&test, rTM, 6.549405970508387e-06);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549405970508387e-06);
    AssertAlmostEqual(&test, rTM, 6.549405970508388e-06);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549405970508322e-06);
    AssertAlmostEqual(&test, rTM, 6.549405970508453e-06);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549405970501838e-06);
    AssertAlmostEqual(&test, rTM, 6.549405970514937e-06);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549405969853455e-06);
    AssertAlmostEqual(&test, rTM, 6.54940597116332e-06);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549405905015187e-06);
    AssertAlmostEqual(&test, rTM, 6.549406036001589e-06);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549399421194755e-06);
    AssertAlmostEqual(&test, rTM, 6.54941251982202e-06);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54875110397602e-06);
    AssertAlmostEqual(&test, rTM, 6.550060837040755e-06);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.484561207825079e-06);
    AssertAlmostEqual(&test, rTM, 6.614250733191641e-06);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.274724432648593e-06);
    AssertAlmostEqual(&test, rTM, 9.824087508227716e-06);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.484644466698861e-08);
    AssertAlmostEqual(&test, rTM, 1.303396549579899e-05);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.548836868523169e-10);
    AssertAlmostEqual(&test, rTM, 1.309815705676817e-05);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549485211217329e-12);
    AssertAlmostEqual(&test, rTM, 1.309880539096969e-05);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549521073522593e-08);
    AssertAlmostEqual(&test, rTM, 6.549521073522593e-08);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549521073522593e-08);
    AssertAlmostEqual(&test, rTM, 6.549521073522593e-08);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549521073522592e-08);
    AssertAlmostEqual(&test, rTM, 6.549521073522593e-08);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549521073522527e-08);
    AssertAlmostEqual(&test, rTM, 6.549521073522658e-08);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549521073516043e-08);
    AssertAlmostEqual(&test, rTM, 6.549521073529143e-08);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549521072867641e-08);
    AssertAlmostEqual(&test, rTM, 6.549521074177546e-08);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549521008027392e-08);
    AssertAlmostEqual(&test, rTM, 6.549521139017795e-08);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549514524008927e-08);
    AssertAlmostEqual(&test, rTM, 6.54952762303626e-08);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.548866186989679e-08);
    AssertAlmostEqual(&test, rTM, 6.550175960055508e-08);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.48467433863059e-08);
    AssertAlmostEqual(&test, rTM, 6.614367808414597e-08);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.274760751242431e-08);
    AssertAlmostEqual(&test, rTM, 9.824281395802742e-08);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.484675171240494e-10);
    AssertAlmostEqual(&test, rTM, 1.303419539533273e-07);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.548867044656954e-12);
    AssertAlmostEqual(&test, rTM, 1.309838726034066e-07);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549524939949125e-10);
    AssertAlmostEqual(&test, rTM, 6.549524939949125e-10);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549524939949125e-10);
    AssertAlmostEqual(&test, rTM, 6.549524939949125e-10);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549524939949125e-10);
    AssertAlmostEqual(&test, rTM, 6.549524939949125e-10);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549524939949124e-10);
    AssertAlmostEqual(&test, rTM, 6.549524939949125e-10);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549524939949059e-10);
    AssertAlmostEqual(&test, rTM, 6.54952493994919e-10);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549524939942575e-10);
    AssertAlmostEqual(&test, rTM, 6.549524939955675e-10);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549524939294172e-10);
    AssertAlmostEqual(&test, rTM, 6.549524940604078e-10);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549524874453876e-10);
    AssertAlmostEqual(&test, rTM, 6.549525005444373e-10);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549518390430743e-10);
    AssertAlmostEqual(&test, rTM, 6.549531489467507e-10);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.548870052944688e-10);
    AssertAlmostEqual(&test, rTM, 6.550179826953561e-10);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.484678158449573e-10);
    AssertAlmostEqual(&test, rTM, 6.614371721448677e-10);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.274762472119376e-10);
    AssertAlmostEqual(&test, rTM, 9.824287407778873e-10);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.484678166775679e-12);
    AssertAlmostEqual(&test, rTM, 1.303420309823049e-09);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549525250150858e-12);
    AssertAlmostEqual(&test, rTM, 6.549525250150858e-12);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549525250150858e-12);
    AssertAlmostEqual(&test, rTM, 6.549525250150858e-12);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549525250150858e-12);
    AssertAlmostEqual(&test, rTM, 6.549525250150858e-12);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549525250150858e-12);
    AssertAlmostEqual(&test, rTM, 6.549525250150858e-12);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549525250150857e-12);
    AssertAlmostEqual(&test, rTM, 6.549525250150859e-12);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549525250150792e-12);
    AssertAlmostEqual(&test, rTM, 6.549525250150923e-12);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549525250144308e-12);
    AssertAlmostEqual(&test, rTM, 6.549525250157407e-12);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549525249495905e-12);
    AssertAlmostEqual(&test, rTM, 6.54952525080581e-12);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549525184655606e-12);
    AssertAlmostEqual(&test, rTM, 6.54952531564611e-12);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549518700632158e-12);
    AssertAlmostEqual(&test, rTM, 6.549531799669559e-12);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.548870363114555e-12);
    AssertAlmostEqual(&test, rTM, 6.550180137187161e-12);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.48467846549674e-12);
    AssertAlmostEqual(&test, rTM, 6.614372034804976e-12);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.274762625096877e-12);
    AssertAlmostEqual(&test, rTM, 9.824287875204839e-12);

    userdata[0] = 0.01/CAPS_HBAR_EV; /* 0.01eV */
    userdata[1] = 0.0001/CAPS_HBAR_EV; /* 0.0001eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998749871562567);
    AssertAlmostEqual(&test, rTM, 0.9999374916244187);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991119558669819);
    AssertAlmostEqual(&test, rTM, 0.9999912036149958);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9911982553972627);
    AssertAlmostEqual(&test, rTM, 0.9999991160063996);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.915418227964539);
    AssertAlmostEqual(&test, rTM, 0.9999999115107754);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.424215434077052);
    AssertAlmostEqual(&test, rTM, 0.9999999903346132);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01247842060738755);
    AssertAlmostEqual(&test, rTM, 0.9999999959937066);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001279249658355539);
    AssertAlmostEqual(&test, rTM, 0.9999999960914588);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279573742484973e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999960924487);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.27957698436285e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999960924586);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279577016781733e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999960924587);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279577017105921e-12);
    AssertAlmostEqual(&test, rTM, 0.9999999960924587);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279577017109163e-14);
    AssertAlmostEqual(&test, rTM, 0.9999999960924587);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279577017109196e-16);
    AssertAlmostEqual(&test, rTM, 0.9999999960924587);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997190657838733);
    AssertAlmostEqual(&test, rTM, 0.9997218469238661);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999604693364986);
    AssertAlmostEqual(&test, rTM, 0.9998023271432831);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9971942076732973);
    AssertAlmostEqual(&test, rTM, 0.9999721811831623);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9724288053798036);
    AssertAlmostEqual(&test, rTM, 0.9999972040779022);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7567844781645293);
    AssertAlmostEqual(&test, rTM, 0.9999997177024833);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1029494255373305);
    AssertAlmostEqual(&test, rTM, 0.999999951947213);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001276089014395356);
    AssertAlmostEqual(&test, rTM, 0.9999999608178457);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279319331666064e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999609167182);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279351738106294e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999609177082);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.27935206218106e-09);
    AssertAlmostEqual(&test, rTM, 0.999999960917718);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279352065421808e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999609177181);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279352065454216e-13);
    AssertAlmostEqual(&test, rTM, 0.9999999609177181);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.27935206545454e-15);
    AssertAlmostEqual(&test, rTM, 0.9999999609177181);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9971812835936562);
    AssertAlmostEqual(&test, rTM, 0.9971812864083915);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9971811442677116);
    AssertAlmostEqual(&test, rTM, 0.9971814257273205);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9971672464252195);
    AssertAlmostEqual(&test, rTM, 0.9971952541020823);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960160647039784);
    AssertAlmostEqual(&test, rTM, 0.9980060424386694);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9720317673843616);
    AssertAlmostEqual(&test, rTM, 0.9997191430048321);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7547605095735995);
    AssertAlmostEqual(&test, rTM, 0.9999714951598181);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1013554757660668);
    AssertAlmostEqual(&test, rTM, 0.9999951175716815);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001251940470942476);
    AssertAlmostEqual(&test, rTM, 0.9999960062221125);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.255049586218054e-05);
    AssertAlmostEqual(&test, rTM, 0.9999960161095351);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.255080774879052e-07);
    AssertAlmostEqual(&test, rTM, 0.9999960162085333);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.255081086775447e-09);
    AssertAlmostEqual(&test, rTM, 0.9999960162095233);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.255081089894412e-11);
    AssertAlmostEqual(&test, rTM, 0.9999960162095332);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.255081089925601e-13);
    AssertAlmostEqual(&test, rTM, 0.9999960162095333);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9903813188177689);
    AssertAlmostEqual(&test, rTM, 0.9903813189134909);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9903813140795321);
    AssertAlmostEqual(&test, rTM, 0.9903813236517254);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9903808402678071);
    AssertAlmostEqual(&test, rTM, 0.9903817974397554);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.990333578086697);
    AssertAlmostEqual(&test, rTM, 0.9904288249949897);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9864243324534478);
    AssertAlmostEqual(&test, rTM, 0.9931888919097651);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9074682624586705);
    AssertAlmostEqual(&test, rTM, 0.9990376211884398);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3935965503084503);
    AssertAlmostEqual(&test, rTM, 0.9998926651956794);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01048139004578263);
    AssertAlmostEqual(&test, rTM, 0.9999523039434599);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001070233191097329);
    AssertAlmostEqual(&test, rTM, 0.9999532833930372);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.070460026519127e-06);
    AssertAlmostEqual(&test, rTM, 0.9999532932912735);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.070462295480328e-08);
    AssertAlmostEqual(&test, rTM, 0.9999532933902664);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.070462318170001e-10);
    AssertAlmostEqual(&test, rTM, 0.9999532933912564);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.070462318396898e-12);
    AssertAlmostEqual(&test, rTM, 0.9999532933912663);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9530953082676863);
    AssertAlmostEqual(&test, rTM, 0.9530953082722641);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.953095308041084);
    AssertAlmostEqual(&test, rTM, 0.9530953084988665);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9530952853808567);
    AssertAlmostEqual(&test, rTM, 0.9530953311590827);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9530930194175289);
    AssertAlmostEqual(&test, rTM, 0.9530975970134177);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9528670140848164);
    AssertAlmostEqual(&test, rTM, 0.9533225231154185);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9343232438085881);
    AssertAlmostEqual(&test, rTM, 0.9665945077003363);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6198519326646841);
    AssertAlmostEqual(&test, rTM, 0.9950968834115199);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0399271837670649);
    AssertAlmostEqual(&test, rTM, 0.9987513428028746);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004328398960064893);
    AssertAlmostEqual(&test, rTM, 0.9988461721128812);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.33211515590219e-06);
    AssertAlmostEqual(&test, rTM, 0.9988471599680422);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.332152358126951e-08);
    AssertAlmostEqual(&test, rTM, 0.9988471698508858);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.33215273015323e-10);
    AssertAlmostEqual(&test, rTM, 0.9988471699497147);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.332152733873493e-12);
    AssertAlmostEqual(&test, rTM, 0.998847169950703);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6716688548481241);
    AssertAlmostEqual(&test, rTM, 0.6716688548483879);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6716688548350639);
    AssertAlmostEqual(&test, rTM, 0.6716688548614482);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6716688535290366);
    AssertAlmostEqual(&test, rTM, 0.6716688561674754);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6716687229263597);
    AssertAlmostEqual(&test, rTM, 0.6716689867701098);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6716556631259593);
    AssertAlmostEqual(&test, rTM, 0.6716820461446487);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.670354331861994);
    AssertAlmostEqual(&test, rTM, 0.6729791621875733);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.571638658760516);
    AssertAlmostEqual(&test, rTM, 0.7520257533964058);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05508066163348157);
    AssertAlmostEqual(&test, rTM, 0.9174096156137859);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006222243391428709);
    AssertAlmostEqual(&test, rTM, 0.925623539957793);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.230533016032387e-06);
    AssertAlmostEqual(&test, rTM, 0.925711712971059);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.230616047734208e-08);
    AssertAlmostEqual(&test, rTM, 0.9257125953791353);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.230616878064798e-10);
    AssertAlmostEqual(&test, rTM, 0.9257126042032839);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.230616886368104e-12);
    AssertAlmostEqual(&test, rTM, 0.9257126042915255);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05784161748324146);
    AssertAlmostEqual(&test, rTM, 0.05784161748324249);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05784161748319046);
    AssertAlmostEqual(&test, rTM, 0.05784161748329349);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05784161747809036);
    AssertAlmostEqual(&test, rTM, 0.05784161748839359);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05784161696808013);
    AssertAlmostEqual(&test, rTM, 0.05784161799840382);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05784156596710273);
    AssertAlmostEqual(&test, rTM, 0.05784166899938092);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05783646632503715);
    AssertAlmostEqual(&test, rTM, 0.05784676863836691);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05733101837211199);
    AssertAlmostEqual(&test, rTM, 0.0583521863349777);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03061638762457291);
    AssertAlmostEqual(&test, rTM, 0.08498108458560803);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006443344918340589);
    AssertAlmostEqual(&test, rTM, 0.1146616733485741);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.515436397288499e-06);
    AssertAlmostEqual(&test, rTM, 0.1152910607793668);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.516165486696481e-08);
    AssertAlmostEqual(&test, rTM, 0.1152974253121392);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.516172778417323e-10);
    AssertAlmostEqual(&test, rTM, 0.1152974889646124);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.516172851334614e-12);
    AssertAlmostEqual(&test, rTM, 0.1152974896011378);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006537618204136613);
    AssertAlmostEqual(&test, rTM, 0.0006537618204136614);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006537618204136549);
    AssertAlmostEqual(&test, rTM, 0.0006537618204136679);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006537618204130085);
    AssertAlmostEqual(&test, rTM, 0.0006537618204143143);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006537618203483706);
    AssertAlmostEqual(&test, rTM, 0.0006537618204789521);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006537618138845857);
    AssertAlmostEqual(&test, rTM, 0.0006537618269427369);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006537611675067435);
    AssertAlmostEqual(&test, rTM, 0.0006537624733205791);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006536965361765719);
    AssertAlmostEqual(&test, rTM, 0.0006538271046507452);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006472973054225109);
    AssertAlmostEqual(&test, rTM, 0.0006602263353501704);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003270946473704986);
    AssertAlmostEqual(&test, rTM, 0.0009804288539290911);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.48127705897052e-06);
    AssertAlmostEqual(&test, rTM, 0.001301041815952654);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.545519275539075e-08);
    AssertAlmostEqual(&test, rTM, 0.001307457626905193);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546168129690251e-10);
    AssertAlmostEqual(&test, rTM, 0.001307522427370357);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546174618881402e-12);
    AssertAlmostEqual(&test, rTM, 0.001307523075439887);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549104287110364e-06);
    AssertAlmostEqual(&test, rTM, 6.549104287110364e-06);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549104287110363e-06);
    AssertAlmostEqual(&test, rTM, 6.549104287110365e-06);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549104287110299e-06);
    AssertAlmostEqual(&test, rTM, 6.54910428711043e-06);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549104287103815e-06);
    AssertAlmostEqual(&test, rTM, 6.549104287116913e-06);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549104286455463e-06);
    AssertAlmostEqual(&test, rTM, 6.549104287765266e-06);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549104221620179e-06);
    AssertAlmostEqual(&test, rTM, 6.549104352600548e-06);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549097738098407e-06);
    AssertAlmostEqual(&test, rTM, 6.549110836122321e-06);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54844945074253e-06);
    AssertAlmostEqual(&test, rTM, 6.549759123478199e-06);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.484262511313918e-06);
    AssertAlmostEqual(&test, rTM, 6.613946062906755e-06);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.274573588973775e-06);
    AssertAlmostEqual(&test, rTM, 9.823634985106507e-06);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.48434576251758e-08);
    AssertAlmostEqual(&test, rTM, 1.303336511604483e-05);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.548535207388727e-10);
    AssertAlmostEqual(&test, rTM, 1.309755372013831e-05);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549183520217683e-12);
    AssertAlmostEqual(&test, rTM, 1.309820202447542e-05);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549490902871626e-08);
    AssertAlmostEqual(&test, rTM, 6.549490902871626e-08);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549490902871626e-08);
    AssertAlmostEqual(&test, rTM, 6.549490902871626e-08);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549490902871626e-08);
    AssertAlmostEqual(&test, rTM, 6.549490902871628e-08);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549490902871561e-08);
    AssertAlmostEqual(&test, rTM, 6.549490902871692e-08);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549490902865076e-08);
    AssertAlmostEqual(&test, rTM, 6.549490902878176e-08);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549490902216678e-08);
    AssertAlmostEqual(&test, rTM, 6.549490903526576e-08);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549490837376727e-08);
    AssertAlmostEqual(&test, rTM, 6.549490968366526e-08);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549484353388131e-08);
    AssertAlmostEqual(&test, rTM, 6.549497452355121e-08);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.548836019355474e-08);
    AssertAlmostEqual(&test, rTM, 6.550145786387779e-08);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.484644466698861e-08);
    AssertAlmostEqual(&test, rTM, 6.614337339044392e-08);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.274745665914972e-08);
    AssertAlmostEqual(&test, rTM, 9.824236139828266e-08);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.484645299301095e-10);
    AssertAlmostEqual(&test, rTM, 1.303413535275019e-07);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.548836877014848e-12);
    AssertAlmostEqual(&test, rTM, 1.309832692205549e-07);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549521922867957e-10);
    AssertAlmostEqual(&test, rTM, 6.549521922867957e-10);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549521922867957e-10);
    AssertAlmostEqual(&test, rTM, 6.549521922867957e-10);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549521922867957e-10);
    AssertAlmostEqual(&test, rTM, 6.549521922867957e-10);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549521922867956e-10);
    AssertAlmostEqual(&test, rTM, 6.549521922867958e-10);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549521922867892e-10);
    AssertAlmostEqual(&test, rTM, 6.549521922868023e-10);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549521922861408e-10);
    AssertAlmostEqual(&test, rTM, 6.549521922874507e-10);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549521922213005e-10);
    AssertAlmostEqual(&test, rTM, 6.54952192352291e-10);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549521857372738e-10);
    AssertAlmostEqual(&test, rTM, 6.549521988363176e-10);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549515373352593e-10);
    AssertAlmostEqual(&test, rTM, 6.549528472383322e-10);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.548867036165199e-10);
    AssertAlmostEqual(&test, rTM, 6.550176809570716e-10);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.484675171240495e-10);
    AssertAlmostEqual(&test, rTM, 6.61436867449542e-10);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.27476096357879e-10);
    AssertAlmostEqual(&test, rTM, 9.824282882157124e-10);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.484675179566594e-12);
    AssertAlmostEqual(&test, rTM, 1.303419709394025e-09);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549524948442588e-12);
    AssertAlmostEqual(&test, rTM, 6.549524948442588e-12);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549524948442588e-12);
    AssertAlmostEqual(&test, rTM, 6.549524948442588e-12);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549524948442588e-12);
    AssertAlmostEqual(&test, rTM, 6.549524948442588e-12);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549524948442588e-12);
    AssertAlmostEqual(&test, rTM, 6.549524948442588e-12);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549524948442587e-12);
    AssertAlmostEqual(&test, rTM, 6.549524948442588e-12);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549524948442522e-12);
    AssertAlmostEqual(&test, rTM, 6.549524948442653e-12);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549524948436038e-12);
    AssertAlmostEqual(&test, rTM, 6.549524948449137e-12);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549524947787635e-12);
    AssertAlmostEqual(&test, rTM, 6.54952494909754e-12);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549524882947339e-12);
    AssertAlmostEqual(&test, rTM, 6.549525013937836e-12);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549518398924189e-12);
    AssertAlmostEqual(&test, rTM, 6.549531497960986e-12);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.548870061436453e-12);
    AssertAlmostEqual(&test, rTM, 6.550179835448723e-12);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.48467816677568e-12);
    AssertAlmostEqual(&test, rTM, 6.614371730109495e-12);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.274762474242741e-12);
    AssertAlmostEqual(&test, rTM, 9.824287422642434e-12);

    userdata[0] = 0.01/CAPS_HBAR_EV; /* 0.01eV */
    userdata[1] = 0.001/CAPS_HBAR_EV; /* 0.001eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996047315818192);
    AssertAlmostEqual(&test, rTM, 0.9998023462554779);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9971944785997903);
    AssertAlmostEqual(&test, rTM, 0.9999721838730856);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.972431434128665);
    AssertAlmostEqual(&test, rTM, 0.9999972043483079);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7568047404149441);
    AssertAlmostEqual(&test, rTM, 0.9999997177303034);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1029656201194936);
    AssertAlmostEqual(&test, rTM, 0.9999999519549327);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001276335205182806);
    AssertAlmostEqual(&test, rTM, 0.9999999608254035);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279566770173473e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999609242759);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279599189150764e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999609252659);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279599513350907e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999609252758);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279599516592909e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999609252759);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279599516625329e-13);
    AssertAlmostEqual(&test, rTM, 0.9999999609252759);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279599516625654e-15);
    AssertAlmostEqual(&test, rTM, 0.9999999609252759);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279599516625657e-17);
    AssertAlmostEqual(&test, rTM, 0.9999999609252759);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991119558669819);
    AssertAlmostEqual(&test, rTM, 0.9991207445159992);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9987505746781753);
    AssertAlmostEqual(&test, rTM, 0.9993750920231088);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9911549914387835);
    AssertAlmostEqual(&test, rTM, 0.9999120387896268);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9154142261610254);
    AssertAlmostEqual(&test, rTM, 0.999991151555139);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4242152642895281);
    AssertAlmostEqual(&test, rTM, 0.9999990334623692);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01247842048689627);
    AssertAlmostEqual(&test, rTM, 0.9999995993708161);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001279249658228926);
    AssertAlmostEqual(&test, rTM, 0.9999996091460387);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279573742483707e-06);
    AssertAlmostEqual(&test, rTM, 0.9999996092450258);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279576984362838e-08);
    AssertAlmostEqual(&test, rTM, 0.9999996092460158);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279577016781733e-10);
    AssertAlmostEqual(&test, rTM, 0.9999996092460258);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279577017105922e-12);
    AssertAlmostEqual(&test, rTM, 0.9999996092460259);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279577017109163e-14);
    AssertAlmostEqual(&test, rTM, 0.9999996092460259);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279577017109196e-16);
    AssertAlmostEqual(&test, rTM, 0.9999996092460259);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.991190219316938);
    AssertAlmostEqual(&test, rTM, 0.9911902280877322);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.99118978517347);
    AssertAlmostEqual(&test, rTM, 0.9911906622094711);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9911464797673536);
    AssertAlmostEqual(&test, rTM, 0.991233752456548);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9875639065141799);
    AssertAlmostEqual(&test, rTM, 0.9937624391954201);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9149366326430387);
    AssertAlmostEqual(&test, rTM, 0.9991190429177941);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4238668887838006);
    AssertAlmostEqual(&test, rTM, 0.9999032480337134);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01245491247828691);
    AssertAlmostEqual(&test, rTM, 0.9999598630564425);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001276780782371855);
    AssertAlmostEqual(&test, rTM, 0.999960840543927);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.277103629306543e-06);
    AssertAlmostEqual(&test, rTM, 0.9999608504420689);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.277106858806546e-08);
    AssertAlmostEqual(&test, rTM, 0.999960850541063);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.277106891101649e-10);
    AssertAlmostEqual(&test, rTM, 0.999960850542053);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.2771068914246e-12);
    AssertAlmostEqual(&test, rTM, 0.9999608505420629);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.277106891427829e-14);
    AssertAlmostEqual(&test, rTM, 0.999960850542063);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9721686094275196);
    AssertAlmostEqual(&test, rTM, 0.972168609701906);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9721685958454004);
    AssertAlmostEqual(&test, rTM, 0.9721686232840185);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9721672376683953);
    AssertAlmostEqual(&test, rTM, 0.9721699813943628);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9720317673843616);
    AssertAlmostEqual(&test, rTM, 0.972304791610484);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9608698610186748);
    AssertAlmostEqual(&test, rTM, 0.9802377476940243);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7537196740938393);
    AssertAlmostEqual(&test, rTM, 0.9971677816664118);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1013472891023817);
    AssertAlmostEqual(&test, rTM, 0.9995119794246028);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001251939234622126);
    AssertAlmostEqual(&test, rTM, 0.9996007798601301);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.255049573793375e-05);
    AssertAlmostEqual(&test, rTM, 0.9996017680162866);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.255080774754799e-07);
    AssertAlmostEqual(&test, rTM, 0.9996017779102482);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.255081086774204e-09);
    AssertAlmostEqual(&test, rTM, 0.999601778009189);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.255081089894399e-11);
    AssertAlmostEqual(&test, rTM, 0.9996017780101785);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.255081089925601e-13);
    AssertAlmostEqual(&test, rTM, 0.9996017780101883);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9079053108792529);
    AssertAlmostEqual(&test, rTM, 0.9079053108880178);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.907905310445389);
    AssertAlmostEqual(&test, rTM, 0.9079053113218817);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9079052670590105);
    AssertAlmostEqual(&test, rTM, 0.9079053547082403);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9079009285403404);
    AssertAlmostEqual(&test, rTM, 0.9079096930284706);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9074682624586705);
    AssertAlmostEqual(&test, rTM, 0.9083403942244029);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.872335245154248);
    AssertAlmostEqual(&test, rTM, 0.9339146140361048);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3919097588691506);
    AssertAlmostEqual(&test, rTM, 0.9893899239093975);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01048037401425547);
    AssertAlmostEqual(&test, rTM, 0.9952525883422696);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001070232131794294);
    AssertAlmostEqual(&test, rTM, 0.9953498437160606);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.070460015921595e-06);
    AssertAlmostEqual(&test, rTM, 0.995350826714998);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.070462295374353e-08);
    AssertAlmostEqual(&test, rTM, 0.9953508365460542);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.070462318168941e-10);
    AssertAlmostEqual(&test, rTM, 0.9953508366443649);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.070462318396887e-12);
    AssertAlmostEqual(&test, rTM, 0.995350836645348);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6212976663488101);
    AssertAlmostEqual(&test, rTM, 0.6212976663491003);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6212976663344429);
    AssertAlmostEqual(&test, rTM, 0.6212976663634675);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6212976648977295);
    AssertAlmostEqual(&test, rTM, 0.6212976678001808);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6212975212264453);
    AssertAlmostEqual(&test, rTM, 0.6212978114714225);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6212831546445051);
    AssertAlmostEqual(&test, rTM, 0.6213121776272253);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6198519326646841);
    AssertAlmostEqual(&test, rTM, 0.622739182323004);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5132335499853441);
    AssertAlmostEqual(&test, rTM, 0.709969234688272);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03956560366247851);
    AssertAlmostEqual(&test, rTM, 0.8884765392735432);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004327970862134224);
    AssertAlmostEqual(&test, rTM, 0.8964414842780565);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.332110867149633e-06);
    AssertAlmostEqual(&test, rTM, 0.89652559934862);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.332152315238647e-08);
    AssertAlmostEqual(&test, rTM, 0.8965264409853377);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.332152729724347e-10);
    AssertAlmostEqual(&test, rTM, 0.8965264494017536);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.332152733869204e-12);
    AssertAlmostEqual(&test, rTM, 0.8965264494859178);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05557345736897713);
    AssertAlmostEqual(&test, rTM, 0.05557345736897813);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0555734573689279);
    AssertAlmostEqual(&test, rTM, 0.05557345736902735);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05557345736400544);
    AssertAlmostEqual(&test, rTM, 0.05557345737394981);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05557345687175929);
    AssertAlmostEqual(&test, rTM, 0.05557345786619596);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05557340764718827);
    AssertAlmostEqual(&test, rTM, 0.05557350709076671);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05556848563178084);
    AssertAlmostEqual(&test, rTM, 0.05557842910341855);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05508066163348157);
    AssertAlmostEqual(&test, rTM, 0.05606622603057573);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02935116395116615);
    AssertAlmostEqual(&test, rTM, 0.0817193119129833);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006161328194671335);
    AssertAlmostEqual(&test, rTM, 0.1101960947869051);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.229916262624601e-06);
    AssertAlmostEqual(&test, rTM, 0.1107985510416759);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.230609879431258e-08);
    AssertAlmostEqual(&test, rTM, 0.1108046429321275);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.230616816381691e-10);
    AssertAlmostEqual(&test, rTM, 0.1108047038578403);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.230616885751273e-12);
    AssertAlmostEqual(&test, rTM, 0.1108047044670981);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006507694559152937);
    AssertAlmostEqual(&test, rTM, 0.0006507694559152938);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006507694559152873);
    AssertAlmostEqual(&test, rTM, 0.0006507694559153002);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006507694559146439);
    AssertAlmostEqual(&test, rTM, 0.0006507694559159437);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006507694558503015);
    AssertAlmostEqual(&test, rTM, 0.0006507694559802861);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006507694494160638);
    AssertAlmostEqual(&test, rTM, 0.0006507694624145238);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006507688059929379);
    AssertAlmostEqual(&test, rTM, 0.0006507701058376497);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006507044701049259);
    AssertAlmostEqual(&test, rTM, 0.0006508344417256561);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000644334491834059);
    AssertAlmostEqual(&test, rTM, 0.0006572044199426334);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003255965128277767);
    AssertAlmostEqual(&test, rTM, 0.0009759422613814145);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.451573042784302e-06);
    AssertAlmostEqual(&test, rTM, 0.001295086798459961);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.51552045090094e-08);
    AssertAlmostEqual(&test, rTM, 0.001301473205533799);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.516166327412732e-10);
    AssertAlmostEqual(&test, rTM, 0.001301537709012411);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.516172786824504e-12);
    AssertAlmostEqual(&test, rTM, 0.001301538354111779);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546088981025427e-06);
    AssertAlmostEqual(&test, rTM, 6.546088981025427e-06);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546088981025426e-06);
    AssertAlmostEqual(&test, rTM, 6.546088981025428e-06);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546088981025361e-06);
    AssertAlmostEqual(&test, rTM, 6.546088981025492e-06);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546088981018881e-06);
    AssertAlmostEqual(&test, rTM, 6.546088981031973e-06);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546088980370826e-06);
    AssertAlmostEqual(&test, rTM, 6.546088981680026e-06);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546088915565394e-06);
    AssertAlmostEqual(&test, rTM, 6.546089046485458e-06);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546082435028693e-06);
    AssertAlmostEqual(&test, rTM, 6.54609552702216e-06);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.545434446150154e-06);
    AssertAlmostEqual(&test, rTM, 6.546743515900698e-06);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.481277058970521e-06);
    AssertAlmostEqual(&test, rTM, 6.610900903080277e-06);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.27306591618825e-06);
    AssertAlmostEqual(&test, rTM, 9.819112045722351e-06);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.481360233531242e-08);
    AssertAlmostEqual(&test, rTM, 1.302736435916558e-05);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.545520123846845e-10);
    AssertAlmostEqual(&test, rTM, 1.309152340947756e-05);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54616813817501e-12);
    AssertAlmostEqual(&test, rTM, 1.30921714153217e-05);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549189211649315e-08);
    AssertAlmostEqual(&test, rTM, 6.549189211649315e-08);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549189211649315e-08);
    AssertAlmostEqual(&test, rTM, 6.549189211649315e-08);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549189211649315e-08);
    AssertAlmostEqual(&test, rTM, 6.549189211649316e-08);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54918921164925e-08);
    AssertAlmostEqual(&test, rTM, 6.549189211649381e-08);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549189211642766e-08);
    AssertAlmostEqual(&test, rTM, 6.549189211655865e-08);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549189210994397e-08);
    AssertAlmostEqual(&test, rTM, 6.549189212304234e-08);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549189146157433e-08);
    AssertAlmostEqual(&test, rTM, 6.549189277141198e-08);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54918266246751e-08);
    AssertAlmostEqual(&test, rTM, 6.549195760831119e-08);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54853435829926e-08);
    AssertAlmostEqual(&test, rTM, 6.54984406499937e-08);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.48434576251758e-08);
    AssertAlmostEqual(&test, rTM, 6.61403266078105e-08);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.274594820284058e-08);
    AssertAlmostEqual(&test, rTM, 9.823783603014558e-08);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.484346595043111e-10);
    AssertAlmostEqual(&test, rTM, 1.303353495734814e-07);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.548535215879623e-12);
    AssertAlmostEqual(&test, rTM, 1.309772356977699e-07);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549491752209165e-10);
    AssertAlmostEqual(&test, rTM, 6.549491752209165e-10);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549491752209165e-10);
    AssertAlmostEqual(&test, rTM, 6.549491752209165e-10);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549491752209165e-10);
    AssertAlmostEqual(&test, rTM, 6.549491752209165e-10);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549491752209164e-10);
    AssertAlmostEqual(&test, rTM, 6.549491752209166e-10);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.5494917522091e-10);
    AssertAlmostEqual(&test, rTM, 6.54949175220923e-10);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549491752202616e-10);
    AssertAlmostEqual(&test, rTM, 6.549491752215714e-10);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549491751554216e-10);
    AssertAlmostEqual(&test, rTM, 6.549491752864114e-10);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549491686714248e-10);
    AssertAlmostEqual(&test, rTM, 6.549491817704082e-10);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549485202723971e-10);
    AssertAlmostEqual(&test, rTM, 6.549498301694359e-10);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.548836868523171e-10);
    AssertAlmostEqual(&test, rTM, 6.55014663589516e-10);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.484645299301096e-10);
    AssertAlmostEqual(&test, rTM, 6.614338205117234e-10);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.274745878249375e-10);
    AssertAlmostEqual(&test, rTM, 9.824237626168957e-10);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.484645307627119e-12);
    AssertAlmostEqual(&test, rTM, 1.303413705134206e-09);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549521931361413e-12);
    AssertAlmostEqual(&test, rTM, 6.549521931361413e-12);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549521931361413e-12);
    AssertAlmostEqual(&test, rTM, 6.549521931361413e-12);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549521931361413e-12);
    AssertAlmostEqual(&test, rTM, 6.549521931361413e-12);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549521931361413e-12);
    AssertAlmostEqual(&test, rTM, 6.549521931361413e-12);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549521931361412e-12);
    AssertAlmostEqual(&test, rTM, 6.549521931361413e-12);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549521931361347e-12);
    AssertAlmostEqual(&test, rTM, 6.549521931361478e-12);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549521931354863e-12);
    AssertAlmostEqual(&test, rTM, 6.549521931367962e-12);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54952193070646e-12);
    AssertAlmostEqual(&test, rTM, 6.549521932016365e-12);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549521865866194e-12);
    AssertAlmostEqual(&test, rTM, 6.549521996856631e-12);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549515381846031e-12);
    AssertAlmostEqual(&test, rTM, 6.549528480876795e-12);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.548867044656956e-12);
    AssertAlmostEqual(&test, rTM, 6.55017681806587e-12);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.484675179566596e-12);
    AssertAlmostEqual(&test, rTM, 6.614368683156229e-12);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.274760965702154e-12);
    AssertAlmostEqual(&test, rTM, 9.82428289702067e-12);

    userdata[0] = 0.01/CAPS_HBAR_EV; /* 0.01eV */
    userdata[1] = 0.003/CAPS_HBAR_EV; /* 0.003eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993154745255003);
    AssertAlmostEqual(&test, rTM, 0.9996576786607736);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9951456919660049);
    AssertAlmostEqual(&test, rTM, 0.9999518214836303);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9527359109309693);
    AssertAlmostEqual(&test, rTM, 0.9999951568516745);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6190376481235549);
    AssertAlmostEqual(&test, rTM, 0.9999995018141582);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03936164323112838);
    AssertAlmostEqual(&test, rTM, 0.9999998731696078);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000426170253214032);
    AssertAlmostEqual(&test, rTM, 0.9999998826760322);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.265300891806151e-06);
    AssertAlmostEqual(&test, rTM, 0.9999998827749896);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.265336913764561e-08);
    AssertAlmostEqual(&test, rTM, 0.9999998827759796);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.265337273987986e-10);
    AssertAlmostEqual(&test, rTM, 0.9999998827759895);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.26533727759022e-12);
    AssertAlmostEqual(&test, rTM, 0.9999998827759896);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.265337277626242e-14);
    AssertAlmostEqual(&test, rTM, 0.9999998827759896);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.265337277626602e-16);
    AssertAlmostEqual(&test, rTM, 0.9999998827759896);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.265337277626606e-18);
    AssertAlmostEqual(&test, rTM, 0.9999998827759896);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9984623725554421);
    AssertAlmostEqual(&test, rTM, 0.9984775849919812);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.997836936000387);
    AssertAlmostEqual(&test, rTM, 0.9989178821941082);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9847298319020747);
    AssertAlmostEqual(&test, rTM, 0.9998476496652394);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8581504342768106);
    AssertAlmostEqual(&test, rTM, 0.9999846443415688);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2438648658162676);
    AssertAlmostEqual(&test, rTM, 0.9999980716214995);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.004229309874747025);
    AssertAlmostEqual(&test, rTM, 0.9999988177965727);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.264948458397238e-05);
    AssertAlmostEqual(&test, rTM, 0.9999988276542665);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.265308639227547e-07);
    AssertAlmostEqual(&test, rTM, 0.999998827753262);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.265312241419878e-09);
    AssertAlmostEqual(&test, rTM, 0.9999988277542521);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.265312277441839e-11);
    AssertAlmostEqual(&test, rTM, 0.999998827754262);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.265312277802059e-13);
    AssertAlmostEqual(&test, rTM, 0.9999988277542621);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.265312277805661e-15);
    AssertAlmostEqual(&test, rTM, 0.9999988277542621);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.265312277805698e-17);
    AssertAlmostEqual(&test, rTM, 0.9999988277542621);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9848001671105663);
    AssertAlmostEqual(&test, rTM, 0.9848001821939821);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9847994205002514);
    AssertAlmostEqual(&test, rTM, 0.9848009287671713);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9847249480257796);
    AssertAlmostEqual(&test, rTM, 0.9848750336257175);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9785722785821303);
    AssertAlmostEqual(&test, rTM, 0.9892278084628674);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8574613919302401);
    AssertAlmostEqual(&test, rTM, 0.9984726832489731);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2437546566316268);
    AssertAlmostEqual(&test, rTM, 0.9998071126566702);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.004226603668063391);
    AssertAlmostEqual(&test, rTM, 0.9998817178718085);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.262200692508577e-05);
    AssertAlmostEqual(&test, rTM, 0.9998827034707197);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.262560451146097e-07);
    AssertAlmostEqual(&test, rTM, 0.9998827133685518);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.262564049115829e-09);
    AssertAlmostEqual(&test, rTM, 0.9998827134675343);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.262564085095564e-11);
    AssertAlmostEqual(&test, rTM, 0.9998827134685242);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.262564085455361e-13);
    AssertAlmostEqual(&test, rTM, 0.9998827134685341);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.26256408545896e-15);
    AssertAlmostEqual(&test, rTM, 0.9998827134685342);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9525883171264946);
    AssertAlmostEqual(&test, rTM, 0.9525883175890992);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.952588294227574);
    AssertAlmostEqual(&test, rTM, 0.9525883404880089);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9525860043955582);
    AssertAlmostEqual(&test, rTM, 0.9525906302099436);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9523576187295464);
    AssertAlmostEqual(&test, rTM, 0.952817925871361);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9336206544066291);
    AssertAlmostEqual(&test, rTM, 0.9662306932197547);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6166383298153925);
    AssertAlmostEqual(&test, rTM, 0.9950397325135394);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03912254457228512);
    AssertAlmostEqual(&test, rTM, 0.9987256130790729);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004234149886917867);
    AssertAlmostEqual(&test, rTM, 0.9988205190333139);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.237706049382489e-06);
    AssertAlmostEqual(&test, rTM, 0.9988215068598336);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.237741648700453e-08);
    AssertAlmostEqual(&test, rTM, 0.9988215167422976);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.237742004697407e-10);
    AssertAlmostEqual(&test, rTM, 0.9988215168411226);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.237742008257377e-12);
    AssertAlmostEqual(&test, rTM, 0.9988215168421108);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.237742008292976e-14);
    AssertAlmostEqual(&test, rTM, 0.9988215168421207);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8539692065999012);
    AssertAlmostEqual(&test, rTM, 0.8539692066133541);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8539692059339854);
    AssertAlmostEqual(&test, rTM, 0.8539692072792698);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8539691393424228);
    AssertAlmostEqual(&test, rTM, 0.8539692738708039);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8539624803798709);
    AssertAlmostEqual(&test, rTM, 0.8539759325479871);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8532985115253956);
    AssertAlmostEqual(&test, rTM, 0.8546370758851766);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8001009499579576);
    AssertAlmostEqual(&test, rTM, 0.8941745821582564);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.233155799405522);
    AssertAlmostEqual(&test, rTM, 0.9802433533257715);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.003972396973814765);
    AssertAlmostEqual(&test, rTM, 0.9875704107363229);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.004221617746405e-05);
    AssertAlmostEqual(&test, rTM, 0.9876671825217199);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.004543070045451e-07);
    AssertAlmostEqual(&test, rTM, 0.9876681542434536);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.004546284892644e-09);
    AssertAlmostEqual(&test, rTM, 0.9876681639610745);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.004546317041149e-11);
    AssertAlmostEqual(&test, rTM, 0.9876681640582506);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.004546317362634e-13);
    AssertAlmostEqual(&test, rTM, 0.9876681640592224);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5419533074447711);
    AssertAlmostEqual(&test, rTM, 0.5419533074450932);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5419533074288331);
    AssertAlmostEqual(&test, rTM, 0.5419533074610312);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5419533058350265);
    AssertAlmostEqual(&test, rTM, 0.5419533090548377);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.541953146454444);
    AssertAlmostEqual(&test, rTM, 0.5419534684353805);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5419372090664226);
    AssertAlmostEqual(&test, rTM, 0.5419694054257336);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.540350136358117);
    AssertAlmostEqual(&test, rTM, 0.5435525439058442);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4258130659848446);
    AssertAlmostEqual(&test, rTM, 0.6405246587606461);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02434520098821749);
    AssertAlmostEqual(&test, rTM, 0.8304188096334446);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002581515185977901);
    AssertAlmostEqual(&test, rTM, 0.8377489663920409);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.583090903381753e-06);
    AssertAlmostEqual(&test, rTM, 0.8378251546225755);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.583106671975063e-08);
    AssertAlmostEqual(&test, rTM, 0.8378259168097059);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.583106829662138e-10);
    AssertAlmostEqual(&test, rTM, 0.8378259244316076);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.583106831239009e-12);
    AssertAlmostEqual(&test, rTM, 0.8378259245078267);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0511204564980125);
    AssertAlmostEqual(&test, rTM, 0.05112045649801342);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05112045649796682);
    AssertAlmostEqual(&test, rTM, 0.05112045649805911);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05112045649339816);
    AssertAlmostEqual(&test, rTM, 0.05112045650262777);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0511204560365325);
    AssertAlmostEqual(&test, rTM, 0.05112045695949342);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05112041035000849);
    AssertAlmostEqual(&test, rTM, 0.05112050264601721);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05111584211103601);
    AssertAlmostEqual(&test, rTM, 0.05112507088280725);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05066311531895143);
    AssertAlmostEqual(&test, rTM, 0.05157777623724135);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02688270358970822);
    AssertAlmostEqual(&test, rTM, 0.07529813795121811);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005615175270203634);
    AssertAlmostEqual(&test, rTM, 0.1014187128783673);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.677069318356932e-06);
    AssertAlmostEqual(&test, rTM, 0.1019688050887357);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.677695168095326e-08);
    AssertAlmostEqual(&test, rTM, 0.1019743669401539);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.677701427291368e-10);
    AssertAlmostEqual(&test, rTM, 0.1019744225648287);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.6777014898834e-12);
    AssertAlmostEqual(&test, rTM, 0.101974423121076);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006442168432298784);
    AssertAlmostEqual(&test, rTM, 0.0006442168432298786);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006442168432298721);
    AssertAlmostEqual(&test, rTM, 0.0006442168432298849);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006442168432292351);
    AssertAlmostEqual(&test, rTM, 0.0006442168432305218);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006442168431655397);
    AssertAlmostEqual(&test, rTM, 0.0006442168432942172);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006442168367960051);
    AssertAlmostEqual(&test, rTM, 0.0006442168496637519);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006442161998431741);
    AssertAlmostEqual(&test, rTM, 0.0006442174866165828);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006441525109201363);
    AssertAlmostEqual(&test, rTM, 0.0006442811755396153);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000637846590292519);
    AssertAlmostEqual(&test, rTM, 0.0006505870961149531);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003223159626839372);
    AssertAlmostEqual(&test, rTM, 0.0009661175902680931);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.386529083920992e-06);
    AssertAlmostEqual(&test, rTM, 0.001282046633205781);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.449830951627224e-08);
    AssertAlmostEqual(&test, rTM, 0.001288368653537783);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.450470308020024e-10);
    AssertAlmostEqual(&test, rTM, 0.001288432506694273);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.45047670222407e-12);
    AssertAlmostEqual(&test, rTM, 0.001288433145289767);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.539398231534289e-06);
    AssertAlmostEqual(&test, rTM, 6.539398231534289e-06);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.539398231534289e-06);
    AssertAlmostEqual(&test, rTM, 6.53939823153429e-06);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.539398231534224e-06);
    AssertAlmostEqual(&test, rTM, 6.539398231534355e-06);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.53939823152775e-06);
    AssertAlmostEqual(&test, rTM, 6.539398231540828e-06);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.539398230880358e-06);
    AssertAlmostEqual(&test, rTM, 6.539398232188221e-06);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.539398166141163e-06);
    AssertAlmostEqual(&test, rTM, 6.539398296927416e-06);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.539391692228124e-06);
    AssertAlmostEqual(&test, rTM, 6.539404770840455e-06);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.53874436564956e-06);
    AssertAlmostEqual(&test, rTM, 6.54005209741902e-06);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.474652552807335e-06);
    AssertAlmostEqual(&test, rTM, 6.604143910261189e-06);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.269720497666716e-06);
    AssertAlmostEqual(&test, rTM, 9.80907596526204e-06);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.474735557428882e-08);
    AssertAlmostEqual(&test, rTM, 1.301404910694601e-05);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.538829868292761e-10);
    AssertAlmostEqual(&test, rTM, 1.307814257952256e-05);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.539477220268955e-12);
    AssertAlmostEqual(&test, rTM, 1.307878992303206e-05);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.5485188862093e-08);
    AssertAlmostEqual(&test, rTM, 6.5485188862093e-08);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.5485188862093e-08);
    AssertAlmostEqual(&test, rTM, 6.5485188862093e-08);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.548518886209298e-08);
    AssertAlmostEqual(&test, rTM, 6.5485188862093e-08);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.548518886209233e-08);
    AssertAlmostEqual(&test, rTM, 6.548518886209364e-08);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.548518886202751e-08);
    AssertAlmostEqual(&test, rTM, 6.548518886215848e-08);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.548518885554448e-08);
    AssertAlmostEqual(&test, rTM, 6.548518886864151e-08);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54851882072412e-08);
    AssertAlmostEqual(&test, rTM, 6.548518951694478e-08);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54851233769782e-08);
    AssertAlmostEqual(&test, rTM, 6.548525434720779e-08);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.547864099885068e-08);
    AssertAlmostEqual(&test, rTM, 6.54917367253353e-08);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.483682073961388e-08);
    AssertAlmostEqual(&test, rTM, 6.613355698457211e-08);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.274259657520151e-08);
    AssertAlmostEqual(&test, rTM, 9.822778114898433e-08);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.483682906316505e-10);
    AssertAlmostEqual(&test, rTM, 1.303220094335538e-07);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.547864957289889e-12);
    AssertAlmostEqual(&test, rTM, 1.309638298592281e-07);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549424707295911e-10);
    AssertAlmostEqual(&test, rTM, 6.549424707295911e-10);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549424707295911e-10);
    AssertAlmostEqual(&test, rTM, 6.549424707295911e-10);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549424707295911e-10);
    AssertAlmostEqual(&test, rTM, 6.549424707295911e-10);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54942470729591e-10);
    AssertAlmostEqual(&test, rTM, 6.549424707295911e-10);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549424707295845e-10);
    AssertAlmostEqual(&test, rTM, 6.549424707295977e-10);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549424707289361e-10);
    AssertAlmostEqual(&test, rTM, 6.549424707302461e-10);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549424706640968e-10);
    AssertAlmostEqual(&test, rTM, 6.549424707950853e-10);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549424641801664e-10);
    AssertAlmostEqual(&test, rTM, 6.549424772790157e-10);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549418157877761e-10);
    AssertAlmostEqual(&test, rTM, 6.54943125671406e-10);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.548769830313738e-10);
    AssertAlmostEqual(&test, rTM, 6.550079584278084e-10);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.484578918198863e-10);
    AssertAlmostEqual(&test, rTM, 6.61427049639296e-10);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.274712355792703e-10);
    AssertAlmostEqual(&test, rTM, 9.824137058799119e-10);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.484578926524714e-12);
    AssertAlmostEqual(&test, rTM, 1.303400362532657e-09);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54951522674653e-12);
    AssertAlmostEqual(&test, rTM, 6.54951522674653e-12);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54951522674653e-12);
    AssertAlmostEqual(&test, rTM, 6.54951522674653e-12);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54951522674653e-12);
    AssertAlmostEqual(&test, rTM, 6.54951522674653e-12);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54951522674653e-12);
    AssertAlmostEqual(&test, rTM, 6.54951522674653e-12);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54951522674653e-12);
    AssertAlmostEqual(&test, rTM, 6.549515226746531e-12);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549515226746465e-12);
    AssertAlmostEqual(&test, rTM, 6.549515226746597e-12);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549515226739982e-12);
    AssertAlmostEqual(&test, rTM, 6.54951522675308e-12);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549515226091579e-12);
    AssertAlmostEqual(&test, rTM, 6.549515227401482e-12);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549515161251379e-12);
    AssertAlmostEqual(&test, rTM, 6.549515292241682e-12);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549508677237853e-12);
    AssertAlmostEqual(&test, rTM, 6.549521776255208e-12);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.548860340712468e-12);
    AssertAlmostEqual(&test, rTM, 6.550170112780593e-12);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.48466854133404e-12);
    AssertAlmostEqual(&test, rTM, 6.614361912159021e-12);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.274757613394713e-12);
    AssertAlmostEqual(&test, rTM, 9.824272840098349e-12);

    userdata[0] = 0.01/CAPS_HBAR_EV; /* 0.01eV */
    userdata[1] = 0.035/CAPS_HBAR_EV; /* 0.035eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9976638340553684);
    AssertAlmostEqual(&test, rTM, 0.9988312336213562);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9835165505885886);
    AssertAlmostEqual(&test, rTM, 0.9998354435708366);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8477194734412136);
    AssertAlmostEqual(&test, rTM, 0.999983406006225);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2215487336207999);
    AssertAlmostEqual(&test, rTM, 0.9999978539404817);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.003629514632001787);
    AssertAlmostEqual(&test, rTM, 0.9999986224253854);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.655738254224982e-05);
    AssertAlmostEqual(&test, rTM, 0.9999986322890736);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.656002884415474e-07);
    AssertAlmostEqual(&test, rTM, 0.9999986323880697);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.656005530959225e-09);
    AssertAlmostEqual(&test, rTM, 0.9999986323890597);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.656005557424687e-11);
    AssertAlmostEqual(&test, rTM, 0.9999986323890696);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.656005557689341e-13);
    AssertAlmostEqual(&test, rTM, 0.9999986323890697);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.656005557691987e-15);
    AssertAlmostEqual(&test, rTM, 0.9999986323890697);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.656005557692014e-17);
    AssertAlmostEqual(&test, rTM, 0.9999986323890697);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.656005557692014e-19);
    AssertAlmostEqual(&test, rTM, 0.9999986323890697);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9947577703499378);
    AssertAlmostEqual(&test, rTM, 0.9948095385588605);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9926310499735971);
    AssertAlmostEqual(&test, rTM, 0.996308699586713);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9488028985645895);
    AssertAlmostEqual(&test, rTM, 0.9994795608941184);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5961666109378779);
    AssertAlmostEqual(&test, rTM, 0.9999459463947143);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03410851925611801);
    AssertAlmostEqual(&test, rTM, 0.9999853581819225);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003653332852685457);
    AssertAlmostEqual(&test, rTM, 0.9999863140560152);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.655976988110773e-06);
    AssertAlmostEqual(&test, rTM, 0.9999863239521591);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.656003453627553e-08);
    AssertAlmostEqual(&test, rTM, 0.9999863240511567);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.65600371828514e-10);
    AssertAlmostEqual(&test, rTM, 0.9999863240521467);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.656003720931715e-12);
    AssertAlmostEqual(&test, rTM, 0.9999863240521566);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.656003720958181e-14);
    AssertAlmostEqual(&test, rTM, 0.9999863240521567);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.656003720958446e-16);
    AssertAlmostEqual(&test, rTM, 0.9999863240521567);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.656003720958448e-18);
    AssertAlmostEqual(&test, rTM, 0.9999863240521567);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9490489419395279);
    AssertAlmostEqual(&test, rTM, 0.9490489915586008);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9490464858594956);
    AssertAlmostEqual(&test, rTM, 0.9490514475210097);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9488015211041307);
    AssertAlmostEqual(&test, rTM, 0.9492952475887828);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9287202542954748);
    AssertAlmostEqual(&test, rTM, 0.963689156939934);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.59467094784434);
    AssertAlmostEqual(&test, rTM, 0.9946372473694772);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03410360521874174);
    AssertAlmostEqual(&test, rTM, 0.9985378013953867);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003653127504342103);
    AssertAlmostEqual(&test, rTM, 0.9986331813666373);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.65577492544717e-06);
    AssertAlmostEqual(&test, rTM, 0.9986341689732928);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.655801423869097e-08);
    AssertAlmostEqual(&test, rTM, 0.998634178852983);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.65580168885574e-10);
    AssertAlmostEqual(&test, rTM, 0.9986341789517803);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.655801691505606e-12);
    AssertAlmostEqual(&test, rTM, 0.9986341789527683);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.655801691532105e-14);
    AssertAlmostEqual(&test, rTM, 0.9986341789527782);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.65580169153237e-16);
    AssertAlmostEqual(&test, rTM, 0.9986341789527782);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8476874712865232);
    AssertAlmostEqual(&test, rTM, 0.8476874726840909);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8476874021069397);
    AssertAlmostEqual(&test, rTM, 0.8476875418636451);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.847680484351195);
    AssertAlmostEqual(&test, rTM, 0.8476944593252863);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8469907247160908);
    AssertAlmostEqual(&test, rTM, 0.8483813069747613);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7918170465650657);
    AssertAlmostEqual(&test, rTM, 0.8894886196448808);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2200679094721478);
    AssertAlmostEqual(&test, rTM, 0.9789632249587236);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.003627144515703966);
    AssertAlmostEqual(&test, rTM, 0.9864033420156756);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.653695425613252e-05);
    AssertAlmostEqual(&test, rTM, 0.9864999765032011);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.653963377183353e-07);
    AssertAlmostEqual(&test, rTM, 0.9865009465100624);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.653966056945816e-09);
    AssertAlmostEqual(&test, rTM, 0.9865009562104998);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.653966083743466e-11);
    AssertAlmostEqual(&test, rTM, 0.9865009563075042);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.653966084011442e-13);
    AssertAlmostEqual(&test, rTM, 0.9865009563084743);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.653966084014122e-15);
    AssertAlmostEqual(&test, rTM, 0.986500956308484);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5953416800705605);
    AssertAlmostEqual(&test, rTM, 0.5953416801007622);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5953416785755775);
    AssertAlmostEqual(&test, rTM, 0.5953416815957452);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5953415290773398);
    AssertAlmostEqual(&test, rTM, 0.5953418310939408);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5953265798408695);
    AssertAlmostEqual(&test, rTM, 0.5953567799099106);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.593837498164478);
    AssertAlmostEqual(&test, rTM, 0.5968417004902586);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4840051873409202);
    AssertAlmostEqual(&test, rTM, 0.68771039201913);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03361754826397104);
    AssertAlmostEqual(&test, rTM, 0.8712319864611141);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003632706601326185);
    AssertAlmostEqual(&test, rTM, 0.8790192462543476);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.635680814183758e-06);
    AssertAlmostEqual(&test, rTM, 0.8791009744989374);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.635710585660193e-08);
    AssertAlmostEqual(&test, rTM, 0.879101792196025);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.635710883377896e-10);
    AssertAlmostEqual(&test, rTM, 0.8791018003730374);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.635710886355073e-12);
    AssertAlmostEqual(&test, rTM, 0.8791018004548076);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.635710886384844e-14);
    AssertAlmostEqual(&test, rTM, 0.8791018004556252);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2139514861177887);
    AssertAlmostEqual(&test, rTM, 0.2139514861180658);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2139514861040737);
    AssertAlmostEqual(&test, rTM, 0.2139514861317809);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2139514847325651);
    AssertAlmostEqual(&test, rTM, 0.2139514875032894);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2139513475818033);
    AssertAlmostEqual(&test, rTM, 0.2139516246540427);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.213937633436133);
    AssertAlmostEqual(&test, rTM, 0.2139653387136699);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2125754584269058);
    AssertAlmostEqual(&test, rTM, 0.2153266652518543);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1308042368409233);
    AssertAlmostEqual(&test, rTM, 0.2941099688357157);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.003405120884454352);
    AssertAlmostEqual(&test, rTM, 0.4063339990152889);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.462127886432924e-05);
    AssertAlmostEqual(&test, rTM, 0.4091441561526943);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.462708001454562e-07);
    AssertAlmostEqual(&test, rTM, 0.4091726931605364);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.462713803627636e-09);
    AssertAlmostEqual(&test, rTM, 0.4091729785748669);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.462713861649469e-11);
    AssertAlmostEqual(&test, rTM, 0.4091729814290146);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.462713862229687e-13);
    AssertAlmostEqual(&test, rTM, 0.4091729814575561);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02242247275892318);
    AssertAlmostEqual(&test, rTM, 0.02242247275892361);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02242247275890196);
    AssertAlmostEqual(&test, rTM, 0.02242247275894484);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0224224727567795);
    AssertAlmostEqual(&test, rTM, 0.0224224727610673);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0224224725445335);
    AssertAlmostEqual(&test, rTM, 0.0224224729733133);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02242245131995361);
    AssertAlmostEqual(&test, rTM, 0.02242249419789317);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0224203290649635);
    AssertAlmostEqual(&test, rTM, 0.02242461645267712);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02221011430859486);
    AssertAlmostEqual(&test, rTM, 0.02263482918592128);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01146399723943593);
    AssertAlmostEqual(&test, rTM, 0.03337556286922145);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002321977487366386);
    AssertAlmostEqual(&test, rTM, 0.04459067661232957);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.34604112766608e-06);
    AssertAlmostEqual(&test, rTM, 0.04482006894827828);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.346284284350918e-08);
    AssertAlmostEqual(&test, rTM, 0.04482238686063695);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.346286716172436e-10);
    AssertAlmostEqual(&test, rTM, 0.04482241004218454);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.346286740490677e-12);
    AssertAlmostEqual(&test, rTM, 0.04482241027400026);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005548311294033434);
    AssertAlmostEqual(&test, rTM, 0.0005548311294033435);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005548311294033379);
    AssertAlmostEqual(&test, rTM, 0.0005548311294033489);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005548311294027891);
    AssertAlmostEqual(&test, rTM, 0.0005548311294038976);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005548311293479218);
    AssertAlmostEqual(&test, rTM, 0.000554831129458765);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005548311238611855);
    AssertAlmostEqual(&test, rTM, 0.0005548311349455013);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005548305751881013);
    AssertAlmostEqual(&test, rTM, 0.0005548316836185854);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005547757133592391);
    AssertAlmostEqual(&test, rTM, 0.0005548865454474444);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000549343784059797);
    AssertAlmostEqual(&test, rTM, 0.0005603184747134768);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002775695048306346);
    AssertAlmostEqual(&test, rTM, 0.0008320926686718663);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.499417901817327e-06);
    AssertAlmostEqual(&test, rTM, 0.001104162506047374);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.553917164707792e-08);
    AssertAlmostEqual(&test, rTM, 0.001109606378107783);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.554467612767882e-10);
    AssertAlmostEqual(&test, rTM, 0.001109661361764968);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.554473117799488e-12);
    AssertAlmostEqual(&test, rTM, 0.001109661911656579);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.434176410879593e-06);
    AssertAlmostEqual(&test, rTM, 6.434176410879593e-06);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.434176410879592e-06);
    AssertAlmostEqual(&test, rTM, 6.434176410879594e-06);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.434176410879528e-06);
    AssertAlmostEqual(&test, rTM, 6.434176410879657e-06);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.434176410873159e-06);
    AssertAlmostEqual(&test, rTM, 6.434176410886027e-06);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.434176410236183e-06);
    AssertAlmostEqual(&test, rTM, 6.434176411523002e-06);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.434176346538658e-06);
    AssertAlmostEqual(&test, rTM, 6.434176475220528e-06);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.434169976792413e-06);
    AssertAlmostEqual(&test, rTM, 6.434182844966773e-06);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.433533065851852e-06);
    AssertAlmostEqual(&test, rTM, 6.434819755907334e-06);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.37047250559329e-06);
    AssertAlmostEqual(&test, rTM, 6.497880316165843e-06);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.217108904786135e-06);
    AssertAlmostEqual(&test, rTM, 9.651243916839869e-06);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.370552860529829e-08);
    AssertAlmostEqual(&test, rTM, 1.280464729263165e-05);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.433615839067852e-10);
    AssertAlmostEqual(&test, rTM, 1.286770945964265e-05);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.434252774595296e-12);
    AssertAlmostEqual(&test, rTM, 1.286834638697368e-05);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.537812310425088e-08);
    AssertAlmostEqual(&test, rTM, 6.537812310425088e-08);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.537812310425088e-08);
    AssertAlmostEqual(&test, rTM, 6.537812310425088e-08);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.537812310425087e-08);
    AssertAlmostEqual(&test, rTM, 6.537812310425088e-08);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.537812310425024e-08);
    AssertAlmostEqual(&test, rTM, 6.537812310425153e-08);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.53781231041855e-08);
    AssertAlmostEqual(&test, rTM, 6.537812310431626e-08);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.537812309771307e-08);
    AssertAlmostEqual(&test, rTM, 6.537812311078869e-08);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.537812245046975e-08);
    AssertAlmostEqual(&test, rTM, 6.537812375803202e-08);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.53780577262017e-08);
    AssertAlmostEqual(&test, rTM, 6.537818848230006e-08);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.5371585946511e-08);
    AssertAlmostEqual(&test, rTM, 6.538466026199076e-08);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.473081503850541e-08);
    AssertAlmostEqual(&test, rTM, 6.602543116999636e-08);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.268906368927497e-08);
    AssertAlmostEqual(&test, rTM, 9.806718251922666e-08);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.473082333486146e-10);
    AssertAlmostEqual(&test, rTM, 1.301089379751526e-07);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.537159449254565e-12);
    AssertAlmostEqual(&test, rTM, 1.307497090490519e-07);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.5483521753312e-10);
    AssertAlmostEqual(&test, rTM, 6.5483521753312e-10);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.5483521753312e-10);
    AssertAlmostEqual(&test, rTM, 6.5483521753312e-10);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.5483521753312e-10);
    AssertAlmostEqual(&test, rTM, 6.5483521753312e-10);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.548352175331199e-10);
    AssertAlmostEqual(&test, rTM, 6.548352175331201e-10);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.548352175331135e-10);
    AssertAlmostEqual(&test, rTM, 6.548352175331265e-10);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.548352175324652e-10);
    AssertAlmostEqual(&test, rTM, 6.548352175337748e-10);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.548352174676365e-10);
    AssertAlmostEqual(&test, rTM, 6.548352175986036e-10);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54835210984768e-10);
    AssertAlmostEqual(&test, rTM, 6.548352240814721e-10);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.548345626985582e-10);
    AssertAlmostEqual(&test, rTM, 6.548358723676819e-10);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.547697405591499e-10);
    AssertAlmostEqual(&test, rTM, 6.549006945070902e-10);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.483517005362488e-10);
    AssertAlmostEqual(&test, rTM, 6.613187345299912e-10);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.274176089809646e-10);
    AssertAlmostEqual(&test, rTM, 9.822528260852755e-10);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.483517013685614e-12);
    AssertAlmostEqual(&test, rTM, 1.303186918052554e-09);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54940795477523e-12);
    AssertAlmostEqual(&test, rTM, 6.54940795477523e-12);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54940795477523e-12);
    AssertAlmostEqual(&test, rTM, 6.54940795477523e-12);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54940795477523e-12);
    AssertAlmostEqual(&test, rTM, 6.54940795477523e-12);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54940795477523e-12);
    AssertAlmostEqual(&test, rTM, 6.54940795477523e-12);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54940795477523e-12);
    AssertAlmostEqual(&test, rTM, 6.549407954775231e-12);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549407954775164e-12);
    AssertAlmostEqual(&test, rTM, 6.549407954775295e-12);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549407954768681e-12);
    AssertAlmostEqual(&test, rTM, 6.549407954781779e-12);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549407954120289e-12);
    AssertAlmostEqual(&test, rTM, 6.549407955430171e-12);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549407889281151e-12);
    AssertAlmostEqual(&test, rTM, 6.549408020269309e-12);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549401405373824e-12);
    AssertAlmostEqual(&test, rTM, 6.549414504176635e-12);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.548753079467292e-12);
    AssertAlmostEqual(&test, rTM, 6.550062830083168e-12);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.484562331461465e-12);
    AssertAlmostEqual(&test, rTM, 6.614253578088995e-12);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.274703977409062e-12);
    AssertAlmostEqual(&test, rTM, 9.824111932141399e-12);

    userdata[0] = 0.01/CAPS_HBAR_EV; /* 0.01eV */
    userdata[1] = 0.05/CAPS_HBAR_EV; /* 0.05eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9972083850761646);
    AssertAlmostEqual(&test, rTM, 0.9986032163550015);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9803304472377647);
    AssertAlmostEqual(&test, rTM, 0.9998033177563155);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8208930063547265);
    AssertAlmostEqual(&test, rTM, 0.9999801375756497);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1744274831007834);
    AssertAlmostEqual(&test, rTM, 0.9999972207023463);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002546188070239095);
    AssertAlmostEqual(&test, rTM, 0.9999980362967686);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.5590729508704e-05);
    AssertAlmostEqual(&test, rTM, 0.9999980461712803);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559202623334873e-07);
    AssertAlmostEqual(&test, rTM, 0.9999980462702774);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559203920142474e-09);
    AssertAlmostEqual(&test, rTM, 0.9999980462712674);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559203933110558e-11);
    AssertAlmostEqual(&test, rTM, 0.9999980462712773);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559203933240239e-13);
    AssertAlmostEqual(&test, rTM, 0.9999980462712774);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559203933241535e-15);
    AssertAlmostEqual(&test, rTM, 0.9999980462712774);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559203933241549e-17);
    AssertAlmostEqual(&test, rTM, 0.9999980462712774);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559203933241549e-19);
    AssertAlmostEqual(&test, rTM, 0.9999980462712774);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9937375515111583);
    AssertAlmostEqual(&test, rTM, 0.9937993631143146);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9911987773901938);
    AssertAlmostEqual(&test, rTM, 0.9955896416658377);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9391207852087837);
    AssertAlmostEqual(&test, rTM, 0.9993778978096253);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5404393580283182);
    AssertAlmostEqual(&test, rTM, 0.9999345139826938);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02436033222060482);
    AssertAlmostEqual(&test, rTM, 0.9999794874398077);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002557893941120515);
    AssertAlmostEqual(&test, rTM, 0.9999804530522836);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559189934029495e-06);
    AssertAlmostEqual(&test, rTM, 0.9999804629494358);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559202902248982e-08);
    AssertAlmostEqual(&test, rTM, 0.9999804630484326);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559203031932007e-10);
    AssertAlmostEqual(&test, rTM, 0.9999804630494226);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559203033228837e-12);
    AssertAlmostEqual(&test, rTM, 0.9999804630494324);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559203033241805e-14);
    AssertAlmostEqual(&test, rTM, 0.9999804630494326);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559203033241935e-16);
    AssertAlmostEqual(&test, rTM, 0.9999804630494326);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559203033241936e-18);
    AssertAlmostEqual(&test, rTM, 0.9999804630494326);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9394123133863407);
    AssertAlmostEqual(&test, rTM, 0.9394123720811971);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9394094080675028);
    AssertAlmostEqual(&test, rTM, 0.9394152772623503);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.939119644666793);
    AssertAlmostEqual(&test, rTM, 0.9397036773361594);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9154174786430216);
    AssertAlmostEqual(&test, rTM, 0.9567538913712645);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5388437188402203);
    AssertAlmostEqual(&test, rTM, 0.9935077933473594);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02435713805220404);
    AssertAlmostEqual(&test, rTM, 0.997952736485924);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002557792515350226);
    AssertAlmostEqual(&test, rTM, 0.9980490042998739);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559090913614931e-06);
    AssertAlmostEqual(&test, rTM, 0.9980499911495077);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559103905912686e-08);
    AssertAlmostEqual(&test, rTM, 0.9980500010205434);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559104035836495e-10);
    AssertAlmostEqual(&test, rTM, 0.998050001119254);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559104037135734e-12);
    AssertAlmostEqual(&test, rTM, 0.9980500011202411);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559104037148726e-14);
    AssertAlmostEqual(&test, rTM, 0.998050001120251);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559104037148856e-16);
    AssertAlmostEqual(&test, rTM, 0.9980500011202511);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8208695368346315);
    AssertAlmostEqual(&test, rTM, 0.8208695384497141);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8208694568880648);
    AssertAlmostEqual(&test, rTM, 0.8208696183962481);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8208614624724764);
    AssertAlmostEqual(&test, rTM, 0.8208776124836671);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8200644197046066);
    AssertAlmostEqual(&test, rTM, 0.8216714060652931);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7567641186016318);
    AssertAlmostEqual(&test, rTM, 0.8693364316377994);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1731625997560476);
    AssertAlmostEqual(&test, rTM, 0.9729089171065232);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002544945516371544);
    AssertAlmostEqual(&test, rTM, 0.9807328423067638);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.558070986068187e-05);
    AssertAlmostEqual(&test, rTM, 0.9808287520877824);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.558203089372259e-07);
    AssertAlmostEqual(&test, rTM, 0.9808297137755392);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.558204410490775e-09);
    AssertAlmostEqual(&test, rTM, 0.980829723392677);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.558204423701968e-11);
    AssertAlmostEqual(&test, rTM, 0.9808297234888484);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.55820442383408e-13);
    AssertAlmostEqual(&test, rTM, 0.9808297234898101);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.558204423835402e-15);
    AssertAlmostEqual(&test, rTM, 0.9808297234898198);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.539826588546233);
    AssertAlmostEqual(&test, rTM, 0.5398265885784982);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.539826586949107);
    AssertAlmostEqual(&test, rTM, 0.5398265901756242);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5398264272365774);
    AssertAlmostEqual(&test, rTM, 0.5398267498881141);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5398104566570995);
    AssertAlmostEqual(&test, rTM, 0.539842720071124);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5382200971155761);
    AssertAlmostEqual(&test, rTM, 0.5414291573008476);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4235499341315477);
    AssertAlmostEqual(&test, rTM, 0.6386032524999031);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02404102492207204);
    AssertAlmostEqual(&test, rTM, 0.828638567796903);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002547689416465182);
    AssertAlmostEqual(&test, rTM, 0.8359481556132771);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.549227409391396e-06);
    AssertAlmostEqual(&test, rTM, 0.8360241058273101);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.549242800337059e-08);
    AssertAlmostEqual(&test, rTM, 0.8360248656306843);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.549242954247618e-10);
    AssertAlmostEqual(&test, rTM, 0.8360248732287483);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.549242955786724e-12);
    AssertAlmostEqual(&test, rTM, 0.8360248733047289);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.549242955802115e-14);
    AssertAlmostEqual(&test, rTM, 0.8360248733054887);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1697683515205767);
    AssertAlmostEqual(&test, rTM, 0.1697683515208177);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1697683515086481);
    AssertAlmostEqual(&test, rTM, 0.1697683515327464);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1697683503157829);
    AssertAlmostEqual(&test, rTM, 0.1697683527256115);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1697682310293579);
    AssertAlmostEqual(&test, rTM, 0.1697684720120314);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.169756303258451);
    AssertAlmostEqual(&test, rTM, 0.1697803997321936);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1685721770971581);
    AssertAlmostEqual(&test, rTM, 0.1709640259154392);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.09979541861626358);
    AssertAlmostEqual(&test, rTM, 0.2380703813305414);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002426757452085647);
    AssertAlmostEqual(&test, rTM, 0.3278607801394779);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.462596993032555e-05);
    AssertAlmostEqual(&test, rTM, 0.3300030130251303);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.46296088082266e-07);
    AssertAlmostEqual(&test, rTM, 0.3300247375292281);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.462964520258429e-09);
    AssertAlmostEqual(&test, rTM, 0.3300249548049259);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.462964556652843e-11);
    AssertAlmostEqual(&test, rTM, 0.3300249569776859);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.462964557016787e-13);
    AssertAlmostEqual(&test, rTM, 0.3300249569994135);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01775404972875769);
    AssertAlmostEqual(&test, rTM, 0.01775404972875804);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01775404972874073);
    AssertAlmostEqual(&test, rTM, 0.017754049728775);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0177540497270444);
    AssertAlmostEqual(&test, rTM, 0.01775404973047133);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01775404955741152);
    AssertAlmostEqual(&test, rTM, 0.01775404990010421);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01775403259414011);
    AssertAlmostEqual(&test, rTM, 0.01775406686337561);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01775233643073257);
    AssertAlmostEqual(&test, rTM, 0.0177557630266789);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01758434176800727);
    AssertAlmostEqual(&test, rTM, 0.0179237566665308);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.009035315001121261);
    AssertAlmostEqual(&test, rTM, 0.02647008524563085);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001821282670736536);
    AssertAlmostEqual(&test, rTM, 0.03531501065245439);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.839974959587479e-06);
    AssertAlmostEqual(&test, rTM, 0.03549507295165378);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.840163820906984e-08);
    AssertAlmostEqual(&test, rTM, 0.03549689222985693);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.840165709716033e-10);
    AssertAlmostEqual(&test, rTM, 0.03549691042452382);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.840165728604144e-12);
    AssertAlmostEqual(&test, rTM, 0.03549691060647068);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000520948868123868);
    AssertAlmostEqual(&test, rTM, 0.0005209488681238681);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005209488681238629);
    AssertAlmostEqual(&test, rTM, 0.0005209488681238733);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005209488681233476);
    AssertAlmostEqual(&test, rTM, 0.0005209488681243885);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005209488680718274);
    AssertAlmostEqual(&test, rTM, 0.0005209488681759087);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005209488629198043);
    AssertAlmostEqual(&test, rTM, 0.0005209488733279318);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005209483477180126);
    AssertAlmostEqual(&test, rTM, 0.0005209493885297235);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005208968326844658);
    AssertAlmostEqual(&test, rTM, 0.0005210009035632675);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005157962766428425);
    AssertAlmostEqual(&test, rTM, 0.000526101459577232);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002606101455867159);
    AssertAlmostEqual(&test, rTM, 0.0007812875200450983);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.163234483610805e-06);
    AssertAlmostEqual(&test, rTM, 0.001036734224583122);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.21439869630133e-08);
    AssertAlmostEqual(&test, rTM, 0.001041845309559198);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.214915459669924e-10);
    AssertAlmostEqual(&test, rTM, 0.001041896931998579);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.214920627820861e-12);
    AssertAlmostEqual(&test, rTM, 0.001041897448274643);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.38601059269961e-06);
    AssertAlmostEqual(&test, rTM, 6.38601059269961e-06);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.38601059269961e-06);
    AssertAlmostEqual(&test, rTM, 6.386010592699611e-06);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.386010592699547e-06);
    AssertAlmostEqual(&test, rTM, 6.386010592699674e-06);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.386010592693224e-06);
    AssertAlmostEqual(&test, rTM, 6.386010592705997e-06);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.386010592061018e-06);
    AssertAlmostEqual(&test, rTM, 6.386010593338203e-06);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.386010528840321e-06);
    AssertAlmostEqual(&test, rTM, 6.3860106565589e-06);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.386004206776965e-06);
    AssertAlmostEqual(&test, rTM, 6.386016978622256e-06);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.385372063648604e-06);
    AssertAlmostEqual(&test, rTM, 6.386649121750617e-06);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.322783564595777e-06);
    AssertAlmostEqual(&test, rTM, 6.449237620803392e-06);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.193025686948003e-06);
    AssertAlmostEqual(&test, rTM, 9.578995498321005e-06);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.322862720966166e-08);
    AssertAlmostEqual(&test, rTM, 1.270879255767896e-05);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.385453602227641e-10);
    AssertAlmostEqual(&test, rTM, 1.277138263951824e-05);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.386085769576149e-12);
    AssertAlmostEqual(&test, rTM, 1.27720147987926e-05);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.53280564546804e-08);
    AssertAlmostEqual(&test, rTM, 6.53280564546804e-08);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.53280564546804e-08);
    AssertAlmostEqual(&test, rTM, 6.53280564546804e-08);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.53280564546804e-08);
    AssertAlmostEqual(&test, rTM, 6.532805645468041e-08);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.532805645467975e-08);
    AssertAlmostEqual(&test, rTM, 6.532805645468106e-08);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.532805645461507e-08);
    AssertAlmostEqual(&test, rTM, 6.532805645474572e-08);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.53280564481476e-08);
    AssertAlmostEqual(&test, rTM, 6.53280564612132e-08);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.532805580139992e-08);
    AssertAlmostEqual(&test, rTM, 6.532805710796087e-08);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.532799112669781e-08);
    AssertAlmostEqual(&test, rTM, 6.532812178266299e-08);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.532152430310355e-08);
    AssertAlmostEqual(&test, rTM, 6.533458860625725e-08);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.468124409820832e-08);
    AssertAlmostEqual(&test, rTM, 6.597486881115249e-08);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.266403036121771e-08);
    AssertAlmostEqual(&test, rTM, 9.799208254814295e-08);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.46812523818625e-10);
    AssertAlmostEqual(&test, rTM, 1.300093003855416e-07);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.532153283605408e-12);
    AssertAlmostEqual(&test, rTM, 1.306495807560767e-07);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.547849546885787e-10);
    AssertAlmostEqual(&test, rTM, 6.547849546885787e-10);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.547849546885787e-10);
    AssertAlmostEqual(&test, rTM, 6.547849546885787e-10);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.547849546885787e-10);
    AssertAlmostEqual(&test, rTM, 6.547849546885787e-10);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.547849546885786e-10);
    AssertAlmostEqual(&test, rTM, 6.547849546885788e-10);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.547849546885722e-10);
    AssertAlmostEqual(&test, rTM, 6.547849546885853e-10);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.547849546879239e-10);
    AssertAlmostEqual(&test, rTM, 6.547849546892336e-10);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.547849546231003e-10);
    AssertAlmostEqual(&test, rTM, 6.547849547540572e-10);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.547849481407293e-10);
    AssertAlmostEqual(&test, rTM, 6.547849612364282e-10);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.547842999042797e-10);
    AssertAlmostEqual(&test, rTM, 6.547856094728778e-10);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.547194827403905e-10);
    AssertAlmostEqual(&test, rTM, 6.54850426636767e-10);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.483019353436324e-10);
    AssertAlmostEqual(&test, rTM, 6.612679740335251e-10);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.27392477558661e-10);
    AssertAlmostEqual(&test, rTM, 9.821774318184965e-10);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.483019361758172e-12);
    AssertAlmostEqual(&test, rTM, 1.303086890015399e-09);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549357672248304e-12);
    AssertAlmostEqual(&test, rTM, 6.549357672248304e-12);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549357672248304e-12);
    AssertAlmostEqual(&test, rTM, 6.549357672248304e-12);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549357672248304e-12);
    AssertAlmostEqual(&test, rTM, 6.549357672248304e-12);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549357672248304e-12);
    AssertAlmostEqual(&test, rTM, 6.549357672248304e-12);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549357672248303e-12);
    AssertAlmostEqual(&test, rTM, 6.549357672248304e-12);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549357672248238e-12);
    AssertAlmostEqual(&test, rTM, 6.549357672248369e-12);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549357672241754e-12);
    AssertAlmostEqual(&test, rTM, 6.549357672254853e-12);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549357671593367e-12);
    AssertAlmostEqual(&test, rTM, 6.549357672903239e-12);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549357606754727e-12);
    AssertAlmostEqual(&test, rTM, 6.54935773774188e-12);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54935112289718e-12);
    AssertAlmostEqual(&test, rTM, 6.549364221599426e-12);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.548702801968116e-12);
    AssertAlmostEqual(&test, rTM, 6.550012542528492e-12);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.48451254678134e-12);
    AssertAlmostEqual(&test, rTM, 6.614202797715267e-12);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.274678836145598e-12);
    AssertAlmostEqual(&test, rTM, 9.824036508351009e-12);

    userdata[0] = 0.01/CAPS_HBAR_EV; /* 0.01eV */
    userdata[1] = 0.1/CAPS_HBAR_EV; /* 0.1eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960543454303076);
    AssertAlmostEqual(&test, rTM, 0.9980252209155606);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9722972576027546);
    AssertAlmostEqual(&test, rTM, 0.9997218471901919);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7567945716835978);
    AssertAlmostEqual(&test, rTM, 0.999971774877456);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.102965699187465);
    AssertAlmostEqual(&test, rTM, 0.9999951955225215);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001276337654966869);
    AssertAlmostEqual(&test, rTM, 0.9999960825630874);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279569244915241e-05);
    AssertAlmostEqual(&test, rTM, 0.9999960924502671);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279601664143347e-07);
    AssertAlmostEqual(&test, rTM, 0.9999960925492652);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279601988345998e-09);
    AssertAlmostEqual(&test, rTM, 0.9999960925502552);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279601991588025e-11);
    AssertAlmostEqual(&test, rTM, 0.9999960925502651);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279601991620445e-13);
    AssertAlmostEqual(&test, rTM, 0.9999960925502652);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.27960199162077e-15);
    AssertAlmostEqual(&test, rTM, 0.9999960925502652);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279601991620773e-17);
    AssertAlmostEqual(&test, rTM, 0.9999960925502652);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279601991620773e-19);
    AssertAlmostEqual(&test, rTM, 0.9999960925502652);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9911550765974171);
    AssertAlmostEqual(&test, rTM, 0.9912422649202735);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9875759601088137);
    AssertAlmostEqual(&test, rTM, 0.9937685039798593);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9150159164055114);
    AssertAlmostEqual(&test, rTM, 0.9991199034306474);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4242016035411439);
    AssertAlmostEqual(&test, rTM, 0.9999033578191643);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01247864384513215);
    AssertAlmostEqual(&test, rTM, 0.9999599394078651);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001279274382417363);
    AssertAlmostEqual(&test, rTM, 0.9999609168717341);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279598491741976e-06);
    AssertAlmostEqual(&test, rTM, 0.9999609267698746);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279601733871929e-08);
    AssertAlmostEqual(&test, rTM, 0.9999609268688687);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279601766293333e-10);
    AssertAlmostEqual(&test, rTM, 0.9999609268698586);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279601766617546e-12);
    AssertAlmostEqual(&test, rTM, 0.9999609268698686);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279601766620789e-14);
    AssertAlmostEqual(&test, rTM, 0.9999609268698686);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279601766620821e-16);
    AssertAlmostEqual(&test, rTM, 0.9999609268698686);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279601766620821e-18);
    AssertAlmostEqual(&test, rTM, 0.9999609268698686);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.915418227964539);
    AssertAlmostEqual(&test, rTM, 0.9154183088112394);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9154142261610254);
    AssertAlmostEqual(&test, rTM, 0.9154223104301292);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9150151310039355);
    AssertAlmostEqual(&test, rTM, 0.915819577497098);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8825504004136472);
    AssertAlmostEqual(&test, rTM, 0.9393843384327727);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.422508815692245);
    AssertAlmostEqual(&test, rTM, 0.9904394150572405);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0124772036436392);
    AssertAlmostEqual(&test, rTM, 0.996009506360603);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001279248379435693);
    AssertAlmostEqual(&test, rTM, 0.9961066741387614);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279573729689282e-06);
    AssertAlmostEqual(&test, rTM, 0.9961076582374929);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279576984234893e-08);
    AssertAlmostEqual(&test, rTM, 0.9961076680797539);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279577016780453e-10);
    AssertAlmostEqual(&test, rTM, 0.9961076681781766);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279577017105909e-12);
    AssertAlmostEqual(&test, rTM, 0.9961076681791609);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279577017109163e-14);
    AssertAlmostEqual(&test, rTM, 0.9961076681791707);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279577017109196e-16);
    AssertAlmostEqual(&test, rTM, 0.9961076681791707);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7567845818886872);
    AssertAlmostEqual(&test, rTM, 0.7567845839841254);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7567844781645293);
    AssertAlmostEqual(&test, rTM, 0.7567846877082445);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7567741060847643);
    AssertAlmostEqual(&test, rTM, 0.7567950593992377);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.755740241385508);
    AssertAlmostEqual(&test, rTM, 0.7578250752552347);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6751275546991901);
    AssertAlmostEqual(&test, rTM, 0.8201210077178054);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1021189445744698);
    AssertAlmostEqual(&test, rTM, 0.9540288043775249);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001275961743581428);
    AssertAlmostEqual(&test, rTM, 0.9622933970539029);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279318052382023e-05);
    AssertAlmostEqual(&test, rTM, 0.9623867472178201);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279351725312793e-07);
    AssertAlmostEqual(&test, rTM, 0.9623876820503336);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279352062053125e-09);
    AssertAlmostEqual(&test, rTM, 0.9623876913987922);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279352065420529e-11);
    AssertAlmostEqual(&test, rTM, 0.9623876914922769);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279352065454203e-13);
    AssertAlmostEqual(&test, rTM, 0.9623876914932117);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.27935206545454e-15);
    AssertAlmostEqual(&test, rTM, 0.962387691493221);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4238840386404791);
    AssertAlmostEqual(&test, rTM, 0.4238840386747806);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4238840369425579);
    AssertAlmostEqual(&test, rTM, 0.4238840403727018);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4238838671505174);
    AssertAlmostEqual(&test, rTM, 0.4238842101647119);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4238668887838006);
    AssertAlmostEqual(&test, rTM, 0.4239011882275059);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4221773770615926);
    AssertAlmostEqual(&test, rTM, 0.4255876954088754);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3068221115102545);
    AssertAlmostEqual(&test, rTM, 0.5283123814249407);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01233461340918023);
    AssertAlmostEqual(&test, rTM, 0.7126260657185531);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001276653162416125);
    AssertAlmostEqual(&test, rTM, 0.7185820852521931);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.277102352335162e-06);
    AssertAlmostEqual(&test, rTM, 0.7186432060700054);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.277106846036755e-08);
    AssertAlmostEqual(&test, rTM, 0.7186438174392981);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.277106890973951e-10);
    AssertAlmostEqual(&test, rTM, 0.718643823553007);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.277106891423323e-12);
    AssertAlmostEqual(&test, rTM, 0.7186438236141441);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.277106891427817e-14);
    AssertAlmostEqual(&test, rTM, 0.7186438236147555);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.101355558466374);
    AssertAlmostEqual(&test, rTM, 0.1013555584665394);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1013555584581867);
    AssertAlmostEqual(&test, rTM, 0.1013555584747268);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1013555576394522);
    AssertAlmostEqual(&test, rTM, 0.1013555592934613);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1013554757660668);
    AssertAlmostEqual(&test, rTM, 0.1013556411668453);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1013472891023817);
    AssertAlmostEqual(&test, rTM, 0.101363827816526);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1005353155080313);
    AssertAlmostEqual(&test, rTM, 0.102175663648685);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05593061778999865);
    AssertAlmostEqual(&test, rTM, 0.146361774046572);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001239575725063476);
    AssertAlmostEqual(&test, rTM, 0.1994598852723253);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.254924097083792e-05);
    AssertAlmostEqual(&test, rTM, 0.2006378071638336);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.255079519801102e-07);
    AssertAlmostEqual(&test, rTM, 0.2006497307431778);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.255081074224649e-09);
    AssertAlmostEqual(&test, rTM, 0.2006498499935861);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.255081089768904e-11);
    AssertAlmostEqual(&test, rTM, 0.2006498511860916);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.255081089924346e-13);
    AssertAlmostEqual(&test, rTM, 0.2006498511980167);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01048140030973236);
    AssertAlmostEqual(&test, rTM, 0.01048140030973257);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0104814003097222);
    AssertAlmostEqual(&test, rTM, 0.01048140030974273);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01048140030870607);
    AssertAlmostEqual(&test, rTM, 0.01048140031075886);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01048140020709287);
    AssertAlmostEqual(&test, rTM, 0.01048140041237207);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01048139004578263);
    AssertAlmostEqual(&test, rTM, 0.0104814105736823);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01048037401425547);
    AssertAlmostEqual(&test, rTM, 0.01048242660518738);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01037975617409794);
    AssertAlmostEqual(&test, rTM, 0.01058304422876585);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.005295772450129483);
    AssertAlmostEqual(&test, rTM, 0.01566646446354114);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001059639078888816);
    AssertAlmostEqual(&test, rTM, 0.02085458031566135);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.070352991556171e-06);
    AssertAlmostEqual(&test, rTM, 0.02095942802158984);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.070461225020196e-08);
    AssertAlmostEqual(&test, rTM, 0.02096048720444461);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.070462307465389e-10);
    AssertAlmostEqual(&test, rTM, 0.02096049779735467);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.070462318289851e-12);
    AssertAlmostEqual(&test, rTM, 0.02096049790328388);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004328403284718463);
    AssertAlmostEqual(&test, rTM, 0.0004328403284718464);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000432840328471842);
    AssertAlmostEqual(&test, rTM, 0.0004328403284718507);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004328403284714139);
    AssertAlmostEqual(&test, rTM, 0.0004328403284722788);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004328403284285998);
    AssertAlmostEqual(&test, rTM, 0.0004328403285150929);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004328403241471885);
    AssertAlmostEqual(&test, rTM, 0.0004328403327965042);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004328398960064893);
    AssertAlmostEqual(&test, rTM, 0.0004328407609372034);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004327970862134225);
    AssertAlmostEqual(&test, rTM, 0.0004328835707302687);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004285584522992944);
    AssertAlmostEqual(&test, rTM, 0.0004371222046285265);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002165138497431305);
    AssertAlmostEqual(&test, rTM, 0.0006491667666891787);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.289223337474808e-06);
    AssertAlmostEqual(&test, rTM, 0.0008613912746187574);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.331719186679029e-08);
    AssertAlmostEqual(&test, rTM, 0.0008656371775983964);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.332148398009168e-10);
    AssertAlmostEqual(&test, rTM, 0.0008656800615432877);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.33215269055201e-12);
    AssertAlmostEqual(&test, rTM, 0.0008656804904256534);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.230539246487766e-06);
    AssertAlmostEqual(&test, rTM, 6.230539246487766e-06);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.230539246487765e-06);
    AssertAlmostEqual(&test, rTM, 6.230539246487766e-06);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.230539246487703e-06);
    AssertAlmostEqual(&test, rTM, 6.230539246487828e-06);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.230539246481535e-06);
    AssertAlmostEqual(&test, rTM, 6.230539246493996e-06);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.230539245864719e-06);
    AssertAlmostEqual(&test, rTM, 6.230539247110812e-06);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.23053918418315e-06);
    AssertAlmostEqual(&test, rTM, 6.23053930879238e-06);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.230533016032388e-06);
    AssertAlmostEqual(&test, rTM, 6.230545476943142e-06);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.229916262624602e-06);
    AssertAlmostEqual(&test, rTM, 6.231162230350928e-06);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.168851500186562e-06);
    AssertAlmostEqual(&test, rTM, 6.292226992788922e-06);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.115289033083767e-06);
    AssertAlmostEqual(&test, rTM, 9.345789459770832e-06);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.168926849235251e-08);
    AssertAlmostEqual(&test, rTM, 1.239938922400898e-05);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.229993879300705e-10);
    AssertAlmostEqual(&test, rTM, 1.246045549310396e-05);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.23061065576368e-12);
    AssertAlmostEqual(&test, rTM, 1.246107226188114e-05);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.516172002861119e-08);
    AssertAlmostEqual(&test, rTM, 6.516172002861119e-08);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.516172002861119e-08);
    AssertAlmostEqual(&test, rTM, 6.516172002861119e-08);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.516172002861117e-08);
    AssertAlmostEqual(&test, rTM, 6.516172002861119e-08);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.516172002861054e-08);
    AssertAlmostEqual(&test, rTM, 6.516172002861183e-08);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.516172002854602e-08);
    AssertAlmostEqual(&test, rTM, 6.516172002867634e-08);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.516172002209501e-08);
    AssertAlmostEqual(&test, rTM, 6.516172003512736e-08);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.516171937699407e-08);
    AssertAlmostEqual(&test, rTM, 6.51617206802283e-08);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.516165486696481e-08);
    AssertAlmostEqual(&test, rTM, 6.516178519025756e-08);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.51552045090094e-08);
    AssertAlmostEqual(&test, rTM, 6.516823554821296e-08);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.451655456702116e-08);
    AssertAlmostEqual(&test, rTM, 6.580688549020121e-08);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.258086213733051e-08);
    AssertAlmostEqual(&test, rTM, 9.774257791989172e-08);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.451656280854586e-10);
    AssertAlmostEqual(&test, rTM, 1.296782744291364e-07);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.515521299856255e-12);
    AssertAlmostEqual(&test, rTM, 1.30316924535922e-07);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546174675858375e-10);
    AssertAlmostEqual(&test, rTM, 6.546174675858375e-10);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546174675858375e-10);
    AssertAlmostEqual(&test, rTM, 6.546174675858375e-10);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546174675858375e-10);
    AssertAlmostEqual(&test, rTM, 6.546174675858375e-10);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546174675858374e-10);
    AssertAlmostEqual(&test, rTM, 6.546174675858375e-10);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546174675858308e-10);
    AssertAlmostEqual(&test, rTM, 6.54617467585844e-10);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546174675851827e-10);
    AssertAlmostEqual(&test, rTM, 6.546174675864921e-10);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546174675203756e-10);
    AssertAlmostEqual(&test, rTM, 6.546174676512992e-10);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546174610396629e-10);
    AssertAlmostEqual(&test, rTM, 6.54617474132012e-10);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546168129690253e-10);
    AssertAlmostEqual(&test, rTM, 6.546181222026495e-10);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.545520123846846e-10);
    AssertAlmostEqual(&test, rTM, 6.546829227869902e-10);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.481361065290327e-10);
    AssertAlmostEqual(&test, rTM, 6.610988286426421e-10);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.273087340071807e-10);
    AssertAlmostEqual(&test, rTM, 9.819262011644941e-10);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.481361073607918e-12);
    AssertAlmostEqual(&test, rTM, 1.302753574098067e-09);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549190069401204e-12);
    AssertAlmostEqual(&test, rTM, 6.549190069401204e-12);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549190069401204e-12);
    AssertAlmostEqual(&test, rTM, 6.549190069401204e-12);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549190069401204e-12);
    AssertAlmostEqual(&test, rTM, 6.549190069401204e-12);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549190069401204e-12);
    AssertAlmostEqual(&test, rTM, 6.549190069401204e-12);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549190069401203e-12);
    AssertAlmostEqual(&test, rTM, 6.549190069401204e-12);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549190069401139e-12);
    AssertAlmostEqual(&test, rTM, 6.54919006940127e-12);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549190069394655e-12);
    AssertAlmostEqual(&test, rTM, 6.549190069407753e-12);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549190068746285e-12);
    AssertAlmostEqual(&test, rTM, 6.549190070056123e-12);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549190003909304e-12);
    AssertAlmostEqual(&test, rTM, 6.549190134893104e-12);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549183520217683e-12);
    AssertAlmostEqual(&test, rTM, 6.549196618584724e-12);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.548535215879624e-12);
    AssertAlmostEqual(&test, rTM, 6.549844922922783e-12);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.484346603368369e-12);
    AssertAlmostEqual(&test, rTM, 6.614033535434038e-12);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.274595034722047e-12);
    AssertAlmostEqual(&test, rTM, 9.82378510408036e-12);

    userdata[0] = 0.01/CAPS_HBAR_EV; /* 0.01eV */
    userdata[1] = 0.5/CAPS_HBAR_EV; /* 0.5eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9911987790849971);
    AssertAlmostEqual(&test, rTM, 0.9955896425170058);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9391207966143221);
    AssertAlmostEqual(&test, rTM, 0.9993778979300307);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5404394203982652);
    AssertAlmostEqual(&test, rTM, 0.9999345139964867);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0243603411959297);
    AssertAlmostEqual(&test, rTM, 0.9999794874473741);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002557894930107642);
    AssertAlmostEqual(&test, rTM, 0.9999804530598411);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559190924018969e-06);
    AssertAlmostEqual(&test, rTM, 0.9999804629569933);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.55920389224849e-08);
    AssertAlmostEqual(&test, rTM, 0.9999804630559901);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559204021931615e-10);
    AssertAlmostEqual(&test, rTM, 0.9999804630569801);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559204023228446e-12);
    AssertAlmostEqual(&test, rTM, 0.99998046305699);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559204023241414e-14);
    AssertAlmostEqual(&test, rTM, 0.9999804630569901);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559204023241544e-16);
    AssertAlmostEqual(&test, rTM, 0.9999804630569901);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559204023241545e-18);
    AssertAlmostEqual(&test, rTM, 0.9999804630569901);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559204023241545e-20);
    AssertAlmostEqual(&test, rTM, 0.9999804630569901);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9803304472377647);
    AssertAlmostEqual(&test, rTM, 0.980523279921141);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.97243281921177);
    AssertAlmostEqual(&test, rTM, 0.9861194104284123);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8200960870354445);
    AssertAlmostEqual(&test, rTM, 0.998025544117796);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1744153450898382);
    AssertAlmostEqual(&test, rTM, 0.9997221422901351);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002546185562319286);
    AssertAlmostEqual(&test, rTM, 0.9998036677492038);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559072925536875e-05);
    AssertAlmostEqual(&test, rTM, 0.9998046549124721);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559202623081513e-07);
    AssertAlmostEqual(&test, rTM, 0.9998046648093156);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559203920139941e-09);
    AssertAlmostEqual(&test, rTM, 0.9998046649082866);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559203933110534e-11);
    AssertAlmostEqual(&test, rTM, 0.9998046649092763);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559203933240239e-13);
    AssertAlmostEqual(&test, rTM, 0.9998046649092862);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559203933241536e-15);
    AssertAlmostEqual(&test, rTM, 0.9998046649092863);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559203933241549e-17);
    AssertAlmostEqual(&test, rTM, 0.9998046649092863);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559203933241549e-19);
    AssertAlmostEqual(&test, rTM, 0.9998046649092863);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8209006871914492);
    AssertAlmostEqual(&test, rTM, 0.8209008486748485);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8208926940026255);
    AssertAlmostEqual(&test, rTM, 0.8209088415355393);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8200957734609057);
    AssertAlmostEqual(&test, rTM, 0.8217025132537383);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7568046404978688);
    AssertAlmostEqual(&test, rTM, 0.8693600423747686);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.17320980591404);
    AssertAlmostEqual(&test, rTM, 0.972916550825887);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002545924996674817);
    AssertAlmostEqual(&test, rTM, 0.9807401121889702);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559060493249186e-05);
    AssertAlmostEqual(&test, rTM, 0.9808360229378582);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559192697794724e-07);
    AssertAlmostEqual(&test, rTM, 0.9808369846362642);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559194019925753e-09);
    AssertAlmostEqual(&test, rTM, 0.9808369942535087);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559194033147071e-11);
    AssertAlmostEqual(&test, rTM, 0.9808369943496812);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559194033279284e-13);
    AssertAlmostEqual(&test, rTM, 0.9808369943506429);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559194033280606e-15);
    AssertAlmostEqual(&test, rTM, 0.9808369943506525);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.55919403328062e-17);
    AssertAlmostEqual(&test, rTM, 0.9808369943506526);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5404492416646361);
    AssertAlmostEqual(&test, rTM, 0.5404492448892001);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5404490820487861);
    AssertAlmostEqual(&test, rTM, 0.5404494045050106);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5404331211363113);
    AssertAlmostEqual(&test, rTM, 0.5404653650206637);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5388437188402203);
    AssertAlmostEqual(&test, rTM, 0.5420508414945572);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4242120851871606);
    AssertAlmostEqual(&test, rTM, 0.6391661425032755);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02412963896592846);
    AssertAlmostEqual(&test, rTM, 0.8291610343805133);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002557539448689527);
    AssertAlmostEqual(&test, rTM, 0.8364766620951108);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559088380130427e-06);
    AssertAlmostEqual(&test, rTM, 0.8365526821303079);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559103880577559e-08);
    AssertAlmostEqual(&test, rTM, 0.83655344263294);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559104035583145e-10);
    AssertAlmostEqual(&test, rTM, 0.8365534502379965);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559104037133201e-12);
    AssertAlmostEqual(&test, rTM, 0.836553450314047);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559104037148701e-14);
    AssertAlmostEqual(&test, rTM, 0.8365534503148075);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559104037148856e-16);
    AssertAlmostEqual(&test, rTM, 0.8365534503148152);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1743797126236201);
    AssertAlmostEqual(&test, rTM, 0.1743797126481388);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1743797114099435);
    AssertAlmostEqual(&test, rTM, 0.1743797138618154);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1743795900423754);
    AssertAlmostEqual(&test, rTM, 0.1743798352293781);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1743674541654138);
    AssertAlmostEqual(&test, rTM, 0.1743919710522937);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1731625997560477);
    AssertAlmostEqual(&test, rTM, 0.175596292906486);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1029330734369431);
    AssertAlmostEqual(&test, rTM, 0.2440362379205504);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002520125424805208);
    AssertAlmostEqual(&test, rTM, 0.3362338932319653);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.557817775316608e-05);
    AssertAlmostEqual(&test, rTM, 0.3384445697875544);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.55820055675503e-07);
    AssertAlmostEqual(&test, rTM, 0.3384669914105491);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.558204385164551e-09);
    AssertAlmostEqual(&test, rTM, 0.3384672156587277);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.558204423448706e-11);
    AssertAlmostEqual(&test, rTM, 0.3384672179012127);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.558204423831547e-13);
    AssertAlmostEqual(&test, rTM, 0.3384672179236375);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.558204423835376e-15);
    AssertAlmostEqual(&test, rTM, 0.3384672179238618);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02427004087360479);
    AssertAlmostEqual(&test, rTM, 0.02427004087365103);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02427004087131592);
    AssertAlmostEqual(&test, rTM, 0.0242700408759399);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02427004064242906);
    AssertAlmostEqual(&test, rTM, 0.02427004110482676);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02427001775376452);
    AssertAlmostEqual(&test, rTM, 0.02427006399349127);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02426772910543652);
    AssertAlmostEqual(&test, rTM, 0.02427235264155973);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02404102492207205);
    AssertAlmostEqual(&test, rTM, 0.02449905427786656);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01243128098280803);
    AssertAlmostEqual(&test, rTM, 0.03610199747147214);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002522729611784004);
    AssertAlmostEqual(&test, rTM, 0.04825982442686817);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.548975062399149e-06);
    AssertAlmostEqual(&test, rTM, 0.04850896380078324);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.549240276589339e-08);
    AssertAlmostEqual(&test, rTM, 0.04851148134507827);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.549242929010113e-10);
    AssertAlmostEqual(&test, rTM, 0.04851150652316374);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.549242955534349e-12);
    AssertAlmostEqual(&test, rTM, 0.04851150677494486);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.549242955799591e-14);
    AssertAlmostEqual(&test, rTM, 0.04851150677746267);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002450906360906678);
    AssertAlmostEqual(&test, rTM, 0.002450906360906727);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002450906360904264);
    AssertAlmostEqual(&test, rTM, 0.002450906360909141);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.00245090636066281);
    AssertAlmostEqual(&test, rTM, 0.002450906361150595);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002450906336517484);
    AssertAlmostEqual(&test, rTM, 0.002450906385295921);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.00245090392198728);
    AssertAlmostEqual(&test, rTM, 0.002450908799826125);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002450662492989409);
    AssertAlmostEqual(&test, rTM, 0.002451150228823705);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002426757452085648);
    AssertAlmostEqual(&test, rTM, 0.002475055266869151);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001228458487238926);
    AssertAlmostEqual(&test, rTM, 0.003673346909409339);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.43845984324912e-05);
    AssertAlmostEqual(&test, rTM, 0.004877399261638982);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.46271707219642e-07);
    AssertAlmostEqual(&test, rTM, 0.004901537011295384);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.462962081926005e-09);
    AssertAlmostEqual(&test, rTM, 0.004901780814182709);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.462964532269494e-11);
    AssertAlmostEqual(&test, rTM, 0.004901783252456559);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.462964556772954e-13);
    AssertAlmostEqual(&test, rTM, 0.004901783276839322);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001839488798211977);
    AssertAlmostEqual(&test, rTM, 0.0001839488798211977);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001839488798211958);
    AssertAlmostEqual(&test, rTM, 0.0001839488798211995);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001839488798210138);
    AssertAlmostEqual(&test, rTM, 0.0001839488798213816);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001839488798028096);
    AssertAlmostEqual(&test, rTM, 0.0001839488798395858);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001839488779823855);
    AssertAlmostEqual(&test, rTM, 0.0001839488816600098);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001839486959401636);
    AssertAlmostEqual(&test, rTM, 0.0001839490637022318);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001839304935373611);
    AssertAlmostEqual(&test, rTM, 0.0001839672661050341);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001821282670736536);
    AssertAlmostEqual(&test, rTM, 0.0001857694925675223);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -9.19913592836886e-05);
    AssertAlmostEqual(&test, rTM, 0.000275906397247695);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.821939627187443e-06);
    AssertAlmostEqual(&test, rTM, 0.0003660758078119578);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.839981662911218e-08);
    AssertAlmostEqual(&test, rTM, 0.0003678793473796304);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.840163887953803e-10);
    AssertAlmostEqual(&test, rTM, 0.0003678975631774054);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.840165710386503e-12);
    AssertAlmostEqual(&test, rTM, 0.0003678977453536038);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.21486628993816e-06);
    AssertAlmostEqual(&test, rTM, 5.21486628993816e-06);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.214866289938159e-06);
    AssertAlmostEqual(&test, rTM, 5.21486628993816e-06);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.214866289938107e-06);
    AssertAlmostEqual(&test, rTM, 5.214866289938212e-06);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.214866289932945e-06);
    AssertAlmostEqual(&test, rTM, 5.214866289943374e-06);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.214866289416678e-06);
    AssertAlmostEqual(&test, rTM, 5.214866290459641e-06);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.214866237790041e-06);
    AssertAlmostEqual(&test, rTM, 5.214866342086279e-06);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.214861075131474e-06);
    AssertAlmostEqual(&test, rTM, 5.214871504744846e-06);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.214344860890464e-06);
    AssertAlmostEqual(&test, rTM, 5.215387718985855e-06);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.163234483610806e-06);
    AssertAlmostEqual(&test, rTM, 5.266498096265485e-06);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.607446742402018e-06);
    AssertAlmostEqual(&test, rTM, 7.822285837403394e-06);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.163287268813664e-08);
    AssertAlmostEqual(&test, rTM, 1.037809970691014e-05);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.214399234662456e-10);
    AssertAlmostEqual(&test, rTM, 1.042921113966928e-05);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.214915465054603e-12);
    AssertAlmostEqual(&test, rTM, 1.042972736467722e-05);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.386091340100152e-08);
    AssertAlmostEqual(&test, rTM, 6.386091340100152e-08);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.386091340100152e-08);
    AssertAlmostEqual(&test, rTM, 6.386091340100152e-08);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.386091340100152e-08);
    AssertAlmostEqual(&test, rTM, 6.386091340100154e-08);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.386091340100089e-08);
    AssertAlmostEqual(&test, rTM, 6.386091340100216e-08);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.386091340093767e-08);
    AssertAlmostEqual(&test, rTM, 6.386091340106538e-08);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.386091339461544e-08);
    AssertAlmostEqual(&test, rTM, 6.386091340738762e-08);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.386091276239248e-08);
    AssertAlmostEqual(&test, rTM, 6.386091403961057e-08);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.386084954016015e-08);
    AssertAlmostEqual(&test, rTM, 6.386097726184291e-08);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.385452794902219e-08);
    AssertAlmostEqual(&test, rTM, 6.386729885298087e-08);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.322862720966166e-08);
    AssertAlmostEqual(&test, rTM, 6.449319959234139e-08);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.193045873960892e-08);
    AssertAlmostEqual(&test, rTM, 9.579136806239399e-08);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.322863512542381e-10);
    AssertAlmostEqual(&test, rTM, 1.270895404507483e-07);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.385453610300896e-12);
    AssertAlmostEqual(&test, rTM, 1.277154413483922e-07);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.532806490483605e-10);
    AssertAlmostEqual(&test, rTM, 6.532806490483605e-10);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.532806490483605e-10);
    AssertAlmostEqual(&test, rTM, 6.532806490483605e-10);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.532806490483605e-10);
    AssertAlmostEqual(&test, rTM, 6.532806490483605e-10);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.532806490483604e-10);
    AssertAlmostEqual(&test, rTM, 6.532806490483606e-10);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.53280649048354e-10);
    AssertAlmostEqual(&test, rTM, 6.53280649048367e-10);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.532806490477072e-10);
    AssertAlmostEqual(&test, rTM, 6.532806490490138e-10);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.532806489830325e-10);
    AssertAlmostEqual(&test, rTM, 6.532806491136885e-10);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.532806425155541e-10);
    AssertAlmostEqual(&test, rTM, 6.532806555811669e-10);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.532799957683656e-10);
    AssertAlmostEqual(&test, rTM, 6.532813023283554e-10);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.532153275156943e-10);
    AssertAlmostEqual(&test, rTM, 6.533459705810267e-10);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.468125238186252e-10);
    AssertAlmostEqual(&test, rTM, 6.597487742780957e-10);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.26640324737568e-10);
    AssertAlmostEqual(&test, rTM, 9.79920973359153e-10);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.468125246469906e-12);
    AssertAlmostEqual(&test, rTM, 1.300093172850251e-09);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.547849555374905e-12);
    AssertAlmostEqual(&test, rTM, 6.547849555374905e-12);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.547849555374905e-12);
    AssertAlmostEqual(&test, rTM, 6.547849555374905e-12);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.547849555374905e-12);
    AssertAlmostEqual(&test, rTM, 6.547849555374905e-12);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.547849555374905e-12);
    AssertAlmostEqual(&test, rTM, 6.547849555374905e-12);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.547849555374904e-12);
    AssertAlmostEqual(&test, rTM, 6.547849555374906e-12);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54784955537484e-12);
    AssertAlmostEqual(&test, rTM, 6.547849555374971e-12);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.547849555368357e-12);
    AssertAlmostEqual(&test, rTM, 6.547849555381453e-12);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.547849554720121e-12);
    AssertAlmostEqual(&test, rTM, 6.547849556029691e-12);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.547849489896411e-12);
    AssertAlmostEqual(&test, rTM, 6.547849620853401e-12);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.547843007531898e-12);
    AssertAlmostEqual(&test, rTM, 6.547856103217913e-12);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.547194835891325e-12);
    AssertAlmostEqual(&test, rTM, 6.548504274858486e-12);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.483019361758172e-12);
    AssertAlmostEqual(&test, rTM, 6.612679748991638e-12);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.273924777708889e-12);
    AssertAlmostEqual(&test, rTM, 9.821774333040921e-12);

    userdata[0] = 0.01/CAPS_HBAR_EV; /* 0.01eV */
    userdata[1] = 1/CAPS_HBAR_EV; /* 1eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9875759613028288);
    AssertAlmostEqual(&test, rTM, 0.9937685045806279);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9150159242595689);
    AssertAlmostEqual(&test, rTM, 0.9991199035158881);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4242016367131343);
    AssertAlmostEqual(&test, rTM, 0.9999033578300374);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01247864619925054);
    AssertAlmostEqual(&test, rTM, 0.9999599394154246);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001279274629790692);
    AssertAlmostEqual(&test, rTM, 0.9999609168792913);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.27959873924066e-06);
    AssertAlmostEqual(&test, rTM, 0.9999609267774319);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279601981371868e-08);
    AssertAlmostEqual(&test, rTM, 0.9999609268764259);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279602013793284e-10);
    AssertAlmostEqual(&test, rTM, 0.9999609268774159);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279602014117498e-12);
    AssertAlmostEqual(&test, rTM, 0.9999609268774258);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.27960201412074e-14);
    AssertAlmostEqual(&test, rTM, 0.9999609268774259);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279602014120772e-16);
    AssertAlmostEqual(&test, rTM, 0.9999609268774259);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279602014120772e-18);
    AssertAlmostEqual(&test, rTM, 0.9999609268774259);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279602014120773e-20);
    AssertAlmostEqual(&test, rTM, 0.9999609268774259);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9722972576027546);
    AssertAlmostEqual(&test, rTM, 0.9725677272137333);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9612391519912238);
    AssertAlmostEqual(&test, rTM, 0.9804261526383015);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7557607779856446);
    AssertAlmostEqual(&test, rTM, 0.9971955301162659);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1029574094832334);
    AssertAlmostEqual(&test, rTM, 0.9995197673966897);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001276336394615232);
    AssertAlmostEqual(&test, rTM, 0.9996084079857922);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.27956923224783e-05);
    AssertAlmostEqual(&test, rTM, 0.9996093961288788);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279601664016666e-07);
    AssertAlmostEqual(&test, rTM, 0.9996094060229512);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279601988344731e-09);
    AssertAlmostEqual(&test, rTM, 0.9996094061218932);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279601991588013e-11);
    AssertAlmostEqual(&test, rTM, 0.9996094061228826);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279601991620445e-13);
    AssertAlmostEqual(&test, rTM, 0.9996094061228925);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.27960199162077e-15);
    AssertAlmostEqual(&test, rTM, 0.9996094061228926);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279601991620773e-17);
    AssertAlmostEqual(&test, rTM, 0.9996094061228926);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279601991620773e-19);
    AssertAlmostEqual(&test, rTM, 0.9996094061228926);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7568047404149441);
    AssertAlmostEqual(&test, rTM, 0.7568049499443955);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.756794369041208);
    AssertAlmostEqual(&test, rTM, 0.7568153209293744);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7557605746402125);
    AssertAlmostEqual(&test, rTM, 0.7578452666316569);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6751528765943571);
    AssertAlmostEqual(&test, rTM, 0.8201368255809262);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1021350355084254);
    AssertAlmostEqual(&test, rTM, 0.9540358631934468);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001276207909877698);
    AssertAlmostEqual(&test, rTM, 0.9623003960648657);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279565490642007e-05);
    AssertAlmostEqual(&test, rTM, 0.9623937472174925);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279599176354789e-07);
    AssertAlmostEqual(&test, rTM, 0.962394682060138);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279599513222947e-09);
    AssertAlmostEqual(&test, rTM, 0.9623946914086979);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.27959951659163e-11);
    AssertAlmostEqual(&test, rTM, 0.9623946915021835);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279599516625317e-13);
    AssertAlmostEqual(&test, rTM, 0.9623946915031183);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279599516625653e-15);
    AssertAlmostEqual(&test, rTM, 0.9623946915031277);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279599516625657e-17);
    AssertAlmostEqual(&test, rTM, 0.9623946915031278);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4242154340770521);
    AssertAlmostEqual(&test, rTM, 0.4242154375071047);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4242152642895281);
    AssertAlmostEqual(&test, rTM, 0.4242156072945983);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4241982863740559);
    AssertAlmostEqual(&test, rTM, 0.4242325849058221);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.422508815692245);
    AssertAlmostEqual(&test, rTM, 0.4259190478193379);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3071366390974608);
    AssertAlmostEqual(&test, rTM, 0.5286445246414848);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0123578880371822);
    AssertAlmostEqual(&test, rTM, 0.7130121140582896);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001279121778901065);
    AssertAlmostEqual(&test, rTM, 0.7189725715612008);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279572462915798e-06);
    AssertAlmostEqual(&test, rTM, 0.7190337394738084);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279576971567081e-08);
    AssertAlmostEqual(&test, rTM, 0.7190343513143361);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279577016653775e-10);
    AssertAlmostEqual(&test, rTM, 0.7190343574327576);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279577017104642e-12);
    AssertAlmostEqual(&test, rTM, 0.7190343574939418);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279577017109151e-14);
    AssertAlmostEqual(&test, rTM, 0.7190343574945537);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279577017109196e-16);
    AssertAlmostEqual(&test, rTM, 0.7190343574945598);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1029494263662654);
    AssertAlmostEqual(&test, rTM, 0.1029494263830116);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1029494255373305);
    AssertAlmostEqual(&test, rTM, 0.1029494272119465);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1029493426439036);
    AssertAlmostEqual(&test, rTM, 0.102949510105372);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1029410539824988);
    AssertAlmostEqual(&test, rTM, 0.1029577987521907);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1021189445744698);
    AssertAlmostEqual(&test, rTM, 0.1037797646699546);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05689570980941892);
    AssertAlmostEqual(&test, rTM, 0.1485659548575681);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001263486356484799);
    AssertAlmostEqual(&test, rTM, 0.2025281513007322);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.27919141579871e-05);
    AssertAlmostEqual(&test, rTM, 0.2037272414824166);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279350458756175e-07);
    AssertAlmostEqual(&test, rTM, 0.2037393798144319);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.27935204938754e-09);
    AssertAlmostEqual(&test, rTM, 0.2037395012126784);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279352065293873e-11);
    AssertAlmostEqual(&test, rTM, 0.2037395024266623);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279352065452937e-13);
    AssertAlmostEqual(&test, rTM, 0.2037395024388022);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279352065454527e-15);
    AssertAlmostEqual(&test, rTM, 0.2037395024389236);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01245492462675385);
    AssertAlmostEqual(&test, rTM, 0.01245492462677815);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01245492462555115);
    AssertAlmostEqual(&test, rTM, 0.01245492462798085);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01245492450528109);
    AssertAlmostEqual(&test, rTM, 0.01245492474825091);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01245491247828691);
    AssertAlmostEqual(&test, rTM, 0.01245493677524509);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01245370989617476);
    AssertAlmostEqual(&test, rTM, 0.01245613935732048);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01233461340918023);
    AssertAlmostEqual(&test, rTM, 0.0125752354837321);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.006305263369641243);
    AssertAlmostEqual(&test, rTM, 0.01860364383307662);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001264142596824081);
    AssertAlmostEqual(&test, rTM, 0.02477964946717012);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.276975932167202e-06);
    AssertAlmostEqual(&test, rTM, 0.02490470952497211);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.277105581702274e-08);
    AssertAlmostEqual(&test, rTM, 0.02490597294569249);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.277106878330593e-10);
    AssertAlmostEqual(&test, rTM, 0.02490598558119486);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.277106891296889e-12);
    AssertAlmostEqual(&test, rTM, 0.02490598570755001);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.277106891426552e-14);
    AssertAlmostEqual(&test, rTM, 0.02490598570881356);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001251940483430561);
    AssertAlmostEqual(&test, rTM, 0.001251940483430585);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001251940483429324);
    AssertAlmostEqual(&test, rTM, 0.001251940483431822);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001251940483305692);
    AssertAlmostEqual(&test, rTM, 0.001251940483555454);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001251940470942476);
    AssertAlmostEqual(&test, rTM, 0.00125194049591867);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001251939234622126);
    AssertAlmostEqual(&test, rTM, 0.00125194173223902);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001251815614916913);
    AssertAlmostEqual(&test, rTM, 0.001252065351944194);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001239575725063476);
    AssertAlmostEqual(&test, rTM, 0.001264305241414858);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006267541641744385);
    AssertAlmostEqual(&test, rTM, 0.001877125824024964);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.242623661634181e-05);
    AssertAlmostEqual(&test, rTM, 0.002491450883299094);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.25495527938387e-07);
    AssertAlmostEqual(&test, rTM, 0.002503751547655813);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.255079831695631e-09);
    AssertAlmostEqual(&test, rTM, 0.002503875787325046);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.255081077343601e-11);
    AssertAlmostEqual(&test, rTM, 0.002503877029846277);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.255081089800093e-13);
    AssertAlmostEqual(&test, rTM, 0.002503877042271502);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001070233201797371);
    AssertAlmostEqual(&test, rTM, 0.0001070233201797371);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000107023320179736);
    AssertAlmostEqual(&test, rTM, 0.0001070233201797382);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001070233201796301);
    AssertAlmostEqual(&test, rTM, 0.0001070233201798441);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000107023320169037);
    AssertAlmostEqual(&test, rTM, 0.0001070233201904371);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001070233191097329);
    AssertAlmostEqual(&test, rTM, 0.0001070233212497412);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001070232131794294);
    AssertAlmostEqual(&test, rTM, 0.0001070234271800448);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001070126212079404);
    AssertAlmostEqual(&test, rTM, 0.0001070340191515338);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001059639078888816);
    AssertAlmostEqual(&test, rTM, 0.0001080827324703523);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.35173872386138e-05);
    AssertAlmostEqual(&test, rTM, 0.0001605292525080695);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.059861434967262e-06);
    AssertAlmostEqual(&test, rTM, 0.0002129867765211368);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.070355259957694e-08);
    AssertAlmostEqual(&test, rTM, 0.0002140359343556767);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.070461247708764e-10);
    AssertAlmostEqual(&test, rTM, 0.000214046530861666);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.070462307692275e-12);
    AssertAlmostEqual(&test, rTM, 0.0002140466368373236);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.332115199222966e-06);
    AssertAlmostEqual(&test, rTM, 4.332115199222966e-06);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.332115199222966e-06);
    AssertAlmostEqual(&test, rTM, 4.332115199222967e-06);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.332115199222923e-06);
    AssertAlmostEqual(&test, rTM, 4.33211519922301e-06);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.332115199218635e-06);
    AssertAlmostEqual(&test, rTM, 4.332115199227299e-06);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.332115198789759e-06);
    AssertAlmostEqual(&test, rTM, 4.332115199656175e-06);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.33211515590219e-06);
    AssertAlmostEqual(&test, rTM, 4.332115242543743e-06);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.332110867149634e-06);
    AssertAlmostEqual(&test, rTM, 4.3321195312963e-06);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.331682034772543e-06);
    AssertAlmostEqual(&test, rTM, 4.332548363673391e-06);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.289223337474809e-06);
    AssertAlmostEqual(&test, rTM, 4.375007060971108e-06);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.166066983232696e-06);
    AssertAlmostEqual(&test, rTM, 6.498163415172587e-06);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.289259764630209e-08);
    AssertAlmostEqual(&test, rTM, 8.621337800640232e-06);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.331719558202117e-10);
    AssertAlmostEqual(&test, rTM, 8.663797226327542e-06);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.332148401725135e-12);
    AssertAlmostEqual(&test, rTM, 8.664226066134928e-06);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.230616110040362e-08);
    AssertAlmostEqual(&test, rTM, 6.230616110040362e-08);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.230616110040362e-08);
    AssertAlmostEqual(&test, rTM, 6.230616110040362e-08);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.230616110040361e-08);
    AssertAlmostEqual(&test, rTM, 6.230616110040362e-08);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.230616110040299e-08);
    AssertAlmostEqual(&test, rTM, 6.230616110040425e-08);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.230616110034131e-08);
    AssertAlmostEqual(&test, rTM, 6.230616110046592e-08);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.230616109417301e-08);
    AssertAlmostEqual(&test, rTM, 6.230616110663424e-08);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.23061604773421e-08);
    AssertAlmostEqual(&test, rTM, 6.230616172346515e-08);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.230609879431258e-08);
    AssertAlmostEqual(&test, rTM, 6.230622340649465e-08);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.229993110806915e-08);
    AssertAlmostEqual(&test, rTM, 6.231239109273809e-08);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.168926849235252e-08);
    AssertAlmostEqual(&test, rTM, 6.292305370845471e-08);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.11530824912307e-08);
    AssertAlmostEqual(&test, rTM, 9.345923970957642e-08);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.168927602737358e-10);
    AssertAlmostEqual(&test, rTM, 1.23995429440533e-07);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.229993886985645e-12);
    AssertAlmostEqual(&test, rTM, 1.246060922069198e-07);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.516172843579053e-10);
    AssertAlmostEqual(&test, rTM, 6.516172843579053e-10);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.516172843579053e-10);
    AssertAlmostEqual(&test, rTM, 6.516172843579053e-10);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.516172843579053e-10);
    AssertAlmostEqual(&test, rTM, 6.516172843579053e-10);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.516172843579052e-10);
    AssertAlmostEqual(&test, rTM, 6.516172843579054e-10);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.516172843578987e-10);
    AssertAlmostEqual(&test, rTM, 6.516172843579118e-10);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.516172843572536e-10);
    AssertAlmostEqual(&test, rTM, 6.516172843585569e-10);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.516172842927435e-10);
    AssertAlmostEqual(&test, rTM, 6.51617284423067e-10);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.516172778417325e-10);
    AssertAlmostEqual(&test, rTM, 6.51617290874078e-10);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.516166327412734e-10);
    AssertAlmostEqual(&test, rTM, 6.516179359745371e-10);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.515521291450757e-10);
    AssertAlmostEqual(&test, rTM, 6.516824395707349e-10);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.451656280854587e-10);
    AssertAlmostEqual(&test, rTM, 6.580689406303519e-10);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.258086423912552e-10);
    AssertAlmostEqual(&test, rTM, 9.774259263245554e-10);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.451656289096112e-12);
    AssertAlmostEqual(&test, rTM, 1.296782912426714e-09);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54617468434315e-12);
    AssertAlmostEqual(&test, rTM, 6.54617468434315e-12);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54617468434315e-12);
    AssertAlmostEqual(&test, rTM, 6.54617468434315e-12);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54617468434315e-12);
    AssertAlmostEqual(&test, rTM, 6.54617468434315e-12);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54617468434315e-12);
    AssertAlmostEqual(&test, rTM, 6.54617468434315e-12);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546174684343149e-12);
    AssertAlmostEqual(&test, rTM, 6.546174684343151e-12);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546174684343085e-12);
    AssertAlmostEqual(&test, rTM, 6.546174684343215e-12);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546174684336604e-12);
    AssertAlmostEqual(&test, rTM, 6.546174684349696e-12);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546174683688533e-12);
    AssertAlmostEqual(&test, rTM, 6.546174684997767e-12);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546174618881404e-12);
    AssertAlmostEqual(&test, rTM, 6.546174749804896e-12);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546168138175012e-12);
    AssertAlmostEqual(&test, rTM, 6.546181230511288e-12);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.545520132329925e-12);
    AssertAlmostEqual(&test, rTM, 6.546829236356374e-12);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.481361073607919e-12);
    AssertAlmostEqual(&test, rTM, 6.610988295078381e-12);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.273087342193001e-12);
    AssertAlmostEqual(&test, rTM, 9.8192620264933e-12);

    userdata[0] = 0.1/CAPS_HBAR_EV; /* 0.1eV */
    userdata[1] = 1e-05/CAPS_HBAR_EV; /* 1e-05eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999960461598979);
    AssertAlmostEqual(&test, rTM, 0.9999980230779948);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999719030260823);
    AssertAlmostEqual(&test, rTM, 0.9999997218082699);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997204458373473);
    AssertAlmostEqual(&test, rTM, 0.9999999720434711);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9972081114277179);
    AssertAlmostEqual(&test, rTM, 0.999999997204206);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9724301644327139);
    AssertAlmostEqual(&test, rTM, 0.9999999997203934);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7567845829259292);
    AssertAlmostEqual(&test, rTM, 0.9999999999717702);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1029494263745548);
    AssertAlmostEqual(&test, rTM, 0.9999999999951947);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001276089014522627);
    AssertAlmostEqual(&test, rTM, 0.9999999999960818);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279319331667343e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999960917);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279351738106307e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999960918);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.27935206218106e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999999960918);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279352065421808e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999999960918);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279352065454216e-13);
    AssertAlmostEqual(&test, rTM, 0.9999999999960918);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999911070647214);
    AssertAlmostEqual(&test, rTM, 0.9999911951131979);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999874859278028);
    AssertAlmostEqual(&test, rTM, 0.999993742944326);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999110742059516);
    AssertAlmostEqual(&test, rTM, 0.9999991195078303);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991154631514827);
    AssertAlmostEqual(&test, rTM, 0.9999999115160125);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.991190219316938);
    AssertAlmostEqual(&test, rTM, 0.9999999911510772);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9153401240024595);
    AssertAlmostEqual(&test, rTM, 0.9999999991142503);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4238840386404791);
    AssertAlmostEqual(&test, rTM, 0.9999999999032374);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01245492462675385);
    AssertAlmostEqual(&test, rTM, 0.9999999999598614);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000127678079513639);
    AssertAlmostEqual(&test, rTM, 0.999999999960839);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.277103629434252e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999608489);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.277106858807823e-08);
    AssertAlmostEqual(&test, rTM, 0.999999999960849);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.277106891101662e-10);
    AssertAlmostEqual(&test, rTM, 0.999999999960849);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.2771068914246e-12);
    AssertAlmostEqual(&test, rTM, 0.999999999960849);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999033518518242);
    AssertAlmostEqual(&test, rTM, 0.9999033519484676);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999033470680952);
    AssertAlmostEqual(&test, rTM, 0.9999033567319551);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999028698851563);
    AssertAlmostEqual(&test, rTM, 0.9999038315232176);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998633216823868);
    AssertAlmostEqual(&test, rTM, 0.9999316585058337);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999029123321052);
    AssertAlmostEqual(&test, rTM, 0.999990382735004);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9903808402678071);
    AssertAlmostEqual(&test, rTM, 0.999999033509799);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9079052670590105);
    AssertAlmostEqual(&test, rTM, 0.9999999032344851);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3936136745515032);
    AssertAlmostEqual(&test, rTM, 0.9999999892652579);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01048140030870607);
    AssertAlmostEqual(&test, rTM, 0.9999999952301691);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001070233201796301);
    AssertAlmostEqual(&test, rTM, 0.9999999953281211);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.070460026626162e-06);
    AssertAlmostEqual(&test, rTM, 0.999999995329111);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.070462295481399e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999953291209);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.070462318170012e-10);
    AssertAlmostEqual(&test, rTM, 0.999999995329121);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995196654855888);
    AssertAlmostEqual(&test, rTM, 0.999519665490391);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995196652478804);
    AssertAlmostEqual(&test, rTM, 0.9995196657280992);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995196414776343);
    AssertAlmostEqual(&test, rTM, 0.9995196894971456);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995172703681532);
    AssertAlmostEqual(&test, rTM, 0.9995220487269985);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993207720081969);
    AssertAlmostEqual(&test, rTM, 0.9996603283058727);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9951831810707509);
    AssertAlmostEqual(&test, rTM, 0.9999521944528841);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9530930194175289);
    AssertAlmostEqual(&test, rTM, 0.999995194366729);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6212975212264453);
    AssertAlmostEqual(&test, rTM, 0.9999995058819905);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03993086949449237);
    AssertAlmostEqual(&test, rTM, 0.9999998749832638);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004328403284285997);
    AssertAlmostEqual(&test, rTM, 0.9999998844839966);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.332115199218635e-06);
    AssertAlmostEqual(&test, rTM, 0.9999998845829533);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.332152358560123e-08);
    AssertAlmostEqual(&test, rTM, 0.9999998845839433);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.332152730157562e-10);
    AssertAlmostEqual(&test, rTM, 0.9999998845839532);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960017997892194);
    AssertAlmostEqual(&test, rTM, 0.9960017997896184);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.996001799769468);
    AssertAlmostEqual(&test, rTM, 0.9960017998093699);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960017977943237);
    AssertAlmostEqual(&test, rTM, 0.9960018017845131);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960016002848565);
    AssertAlmostEqual(&test, rTM, 0.9960019992840468);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9959818986610083);
    AssertAlmostEqual(&test, rTM, 0.9960216025466188);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.994350380540905);
    AssertAlmostEqual(&test, rTM, 0.9971711835179783);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.960540373076947);
    AssertAlmostEqual(&test, rTM, 0.9996013668068183);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6716556631259593);
    AssertAlmostEqual(&test, rTM, 0.9999591449603746);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05557340764718827);
    AssertAlmostEqual(&test, rTM, 0.9999910307629954);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006222864779694588);
    AssertAlmostEqual(&test, rTM, 0.9999919651831725);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.230539245864719e-06);
    AssertAlmostEqual(&test, rTM, 0.999991975076831);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.230616110034131e-08);
    AssertAlmostEqual(&test, rTM, 0.9999919751758292);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.230616878687797e-10);
    AssertAlmostEqual(&test, rTM, 0.9999919751768191);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9615852857967148);
    AssertAlmostEqual(&test, rTM, 0.9615852857967524);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9615852857948505);
    AssertAlmostEqual(&test, rTM, 0.9615852857986167);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9615852856084215);
    AssertAlmostEqual(&test, rTM, 0.9615852859850457);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9615852669655287);
    AssertAlmostEqual(&test, rTM, 0.9615853046279293);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9615834027246973);
    AssertAlmostEqual(&test, rTM, 0.9615871687782745);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9613974606664578);
    AssertAlmostEqual(&test, rTM, 0.9617722148537505);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9461122521838218);
    AssertAlmostEqual(&test, rTM, 0.9726778516531526);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6762450372613529);
    AssertAlmostEqual(&test, rTM, 0.9960365773317024);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05783646632503715);
    AssertAlmostEqual(&test, rTM, 0.9991391725741638);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006507688059929378);
    AssertAlmostEqual(&test, rTM, 0.9992322685597081);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.516087867277222e-06);
    AssertAlmostEqual(&test, rTM, 0.9992332567699483);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.516172002209501e-08);
    AssertAlmostEqual(&test, rTM, 0.9992332666585);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.516172843572535e-10);
    AssertAlmostEqual(&test, rTM, 0.9992332667573862);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6781406715081506);
    AssertAlmostEqual(&test, rTM, 0.6781406715081532);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6781406715080218);
    AssertAlmostEqual(&test, rTM, 0.6781406715082819);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6781406714951455);
    AssertAlmostEqual(&test, rTM, 0.6781406715211583);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6781406702075106);
    AssertAlmostEqual(&test, rTM, 0.6781406728087931);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6781405414440712);
    AssertAlmostEqual(&test, rTM, 0.67814080157219);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6781276655572938);
    AssertAlmostEqual(&test, rTM, 0.6781536770342679);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6768446249460981);
    AssertAlmostEqual(&test, rTM, 0.6794325138501163);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5792996766992881);
    AssertAlmostEqual(&test, rTM, 0.7573278352224876);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05756624267702897);
    AssertAlmostEqual(&test, rTM, 0.9207142778492156);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006536965361765717);
    AssertAlmostEqual(&test, rTM, 0.9289499751584115);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546082435028693e-06);
    AssertAlmostEqual(&test, rTM, 0.929038615098604);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546173761919205e-08);
    AssertAlmostEqual(&test, rTM, 0.9290395022076192);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546174675203755e-10);
    AssertAlmostEqual(&test, rTM, 0.9290395110787805);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810250758014589);
    AssertAlmostEqual(&test, rTM, 0.05810250758014589);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810250758014537);
    AssertAlmostEqual(&test, rTM, 0.05810250758014641);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810250758009416);
    AssertAlmostEqual(&test, rTM, 0.05810250758019761);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810250757497375);
    AssertAlmostEqual(&test, rTM, 0.05810250758531803);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0581025070629313);
    AssertAlmostEqual(&test, rTM, 0.05810250809736048);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810245585873239);
    AssertAlmostEqual(&test, rTM, 0.05810255930155907);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05809733589610716);
    AssertAlmostEqual(&test, rTM, 0.05810767926106604);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05758987166609777);
    AssertAlmostEqual(&test, rTM, 0.05861511285441798);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03076225953744344);
    AssertAlmostEqual(&test, rTM, 0.08535587635934321);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006475950860860072);
    AssertAlmostEqual(&test, rTM, 0.1151750815018342);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.548449450742529e-06);
    AssertAlmostEqual(&test, rTM, 0.1158075777667452);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54918266246751e-08);
    AssertAlmostEqual(&test, rTM, 0.1158139737740615);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549189995416708e-10);
    AssertAlmostEqual(&test, rTM, 0.1158140377413192);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540926613911466);
    AssertAlmostEqual(&test, rTM, 0.0006540926613911466);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540926613911466);
    AssertAlmostEqual(&test, rTM, 0.0006540926613911467);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540926613911401);
    AssertAlmostEqual(&test, rTM, 0.0006540926613911531);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540926613904934);
    AssertAlmostEqual(&test, rTM, 0.0006540926613917998);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540926613258229);
    AssertAlmostEqual(&test, rTM, 0.0006540926614564703);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540926548587713);
    AssertAlmostEqual(&test, rTM, 0.000654092667923522);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540920081542527);
    AssertAlmostEqual(&test, rTM, 0.0006540933146280405);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540273441597038);
    AssertAlmostEqual(&test, rTM, 0.0006541579786225838);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006476248792219677);
    AssertAlmostEqual(&test, rTM, 0.0006605604435056013);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003272602842581755);
    AssertAlmostEqual(&test, rTM, 0.0009809248987845429);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.484561207825079e-06);
    AssertAlmostEqual(&test, rTM, 0.001301700212926678);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.548836019355474e-08);
    AssertAlmostEqual(&test, rTM, 0.001308119274844049);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54948520272397e-10);
    AssertAlmostEqual(&test, rTM, 0.001308184108144775);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549436140376867e-06);
    AssertAlmostEqual(&test, rTM, 6.549436140376867e-06);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549436140376867e-06);
    AssertAlmostEqual(&test, rTM, 6.549436140376867e-06);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549436140376866e-06);
    AssertAlmostEqual(&test, rTM, 6.549436140376867e-06);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549436140376801e-06);
    AssertAlmostEqual(&test, rTM, 6.549436140376932e-06);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549436140370317e-06);
    AssertAlmostEqual(&test, rTM, 6.549436140383416e-06);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549436139721932e-06);
    AssertAlmostEqual(&test, rTM, 6.549436141031802e-06);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549436074883364e-06);
    AssertAlmostEqual(&test, rTM, 6.549436205870369e-06);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549429591033065e-06);
    AssertAlmostEqual(&test, rTM, 6.549442689720668e-06);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.548781270827892e-06);
    AssertAlmostEqual(&test, rTM, 6.55009100992584e-06);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.484591078989737e-06);
    AssertAlmostEqual(&test, rTM, 6.614281201763941e-06);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.274739517780429e-06);
    AssertAlmostEqual(&test, rTM, 9.824132762832836e-06);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.48467433863059e-08);
    AssertAlmostEqual(&test, rTM, 1.303402553681662e-05);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.548867036165198e-10);
    AssertAlmostEqual(&test, rTM, 1.309821739348835e-05);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54952409060298e-08);
    AssertAlmostEqual(&test, rTM, 6.54952409060298e-08);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54952409060298e-08);
    AssertAlmostEqual(&test, rTM, 6.54952409060298e-08);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54952409060298e-08);
    AssertAlmostEqual(&test, rTM, 6.54952409060298e-08);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54952409060298e-08);
    AssertAlmostEqual(&test, rTM, 6.549524090602981e-08);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549524090602915e-08);
    AssertAlmostEqual(&test, rTM, 6.549524090603046e-08);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54952409059643e-08);
    AssertAlmostEqual(&test, rTM, 6.54952409060953e-08);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549524089948028e-08);
    AssertAlmostEqual(&test, rTM, 6.549524091257932e-08);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549524025107748e-08);
    AssertAlmostEqual(&test, rTM, 6.549524156098212e-08);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549517541086297e-08);
    AssertAlmostEqual(&test, rTM, 6.549530640119663e-08);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.548869203768387e-08);
    AssertAlmostEqual(&test, rTM, 6.550178977437573e-08);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.484677325838901e-08);
    AssertAlmostEqual(&test, rTM, 6.614370855367059e-08);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.274762259782822e-08);
    AssertAlmostEqual(&test, rTM, 9.824285921423124e-08);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.484678158449572e-10);
    AssertAlmostEqual(&test, rTM, 1.303420139962141e-07);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549525241657395e-10);
    AssertAlmostEqual(&test, rTM, 6.549525241657395e-10);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549525241657395e-10);
    AssertAlmostEqual(&test, rTM, 6.549525241657395e-10);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549525241657395e-10);
    AssertAlmostEqual(&test, rTM, 6.549525241657395e-10);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549525241657395e-10);
    AssertAlmostEqual(&test, rTM, 6.549525241657395e-10);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549525241657394e-10);
    AssertAlmostEqual(&test, rTM, 6.549525241657395e-10);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549525241657329e-10);
    AssertAlmostEqual(&test, rTM, 6.54952524165746e-10);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549525241650845e-10);
    AssertAlmostEqual(&test, rTM, 6.549525241663944e-10);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549525241002442e-10);
    AssertAlmostEqual(&test, rTM, 6.549525242312348e-10);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549525176162143e-10);
    AssertAlmostEqual(&test, rTM, 6.549525307152646e-10);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549518692138712e-10);
    AssertAlmostEqual(&test, rTM, 6.549531791176079e-10);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54887035462279e-10);
    AssertAlmostEqual(&test, rTM, 6.550180128691999e-10);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.484678457170632e-10);
    AssertAlmostEqual(&test, rTM, 6.614372026144158e-10);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.274762622973511e-10);
    AssertAlmostEqual(&test, rTM, 9.824287860341279e-10);

    userdata[0] = 0.1/CAPS_HBAR_EV; /* 0.1eV */
    userdata[1] = 0.0001/CAPS_HBAR_EV; /* 0.0001eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999874980122924);
    AssertAlmostEqual(&test, rTM, 0.9999937489866085);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999111600758263);
    AssertAlmostEqual(&test, rTM, 0.9999991203581019);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999116316951742);
    AssertAlmostEqual(&test, rTM, 0.9999999116014596);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9911986891252023);
    AssertAlmostEqual(&test, rTM, 0.9999999911596226);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9154182679836648);
    AssertAlmostEqual(&test, rTM, 0.9999999991151073);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4242154357749281);
    AssertAlmostEqual(&test, rTM, 0.9999999999033461);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01247842060859247);
    AssertAlmostEqual(&test, rTM, 0.999999999959937);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001279249658356806);
    AssertAlmostEqual(&test, rTM, 0.9999999999609146);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279573742484986e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999609245);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.27957698436285e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999609246);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279577016781733e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999999609246);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279577017105921e-12);
    AssertAlmostEqual(&test, rTM, 0.9999999999609246);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279577017109163e-14);
    AssertAlmostEqual(&test, rTM, 0.9999999999609246);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999719030260823);
    AssertAlmostEqual(&test, rTM, 0.9999721812100734);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999604623024525);
    AssertAlmostEqual(&test, rTM, 0.9999802309558168);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997190657838733);
    AssertAlmostEqual(&test, rTM, 0.9999972180861549);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9972079734259837);
    AssertAlmostEqual(&test, rTM, 0.9999997204344764);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9724301509764021);
    AssertAlmostEqual(&test, rTM, 0.9999999720393561);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7567845818886872);
    AssertAlmostEqual(&test, rTM, 0.999999997177023);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1029494263662654);
    AssertAlmostEqual(&test, rTM, 0.9999999995194722);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001276089014521367);
    AssertAlmostEqual(&test, rTM, 0.9999999996081784);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.27931933166733e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999996091672);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279351738106307e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999996091771);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.27935206218106e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999996091772);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279352065421809e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999996091772);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279352065454216e-13);
    AssertAlmostEqual(&test, rTM, 0.9999999996091772);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997177700947526);
    AssertAlmostEqual(&test, rTM, 0.9997177703769423);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997177561267038);
    AssertAlmostEqual(&test, rTM, 0.999717784344286);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997163627970265);
    AssertAlmostEqual(&test, rTM, 0.999719170691784);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996008901724517);
    AssertAlmostEqual(&test, rTM, 0.9998004251691822);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9971672464252195);
    AssertAlmostEqual(&test, rTM, 0.9999719134918308);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9721672376683953);
    AssertAlmostEqual(&test, rTM, 0.9999971771680437);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7547709516640665);
    AssertAlmostEqual(&test, rTM, 0.9999997149331799);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1013555576394522);
    AssertAlmostEqual(&test, rTM, 0.9999999511754945);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001251940483305692);
    AssertAlmostEqual(&test, rTM, 0.9999999600620634);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.255049586342301e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999601609382);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.255080774880294e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999601619282);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.255081086775459e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999601619382);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.255081089894412e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999601619383);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.99903393926401);
    AssertAlmostEqual(&test, rTM, 0.9990339392736659);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9990339387860411);
    AssertAlmostEqual(&test, rTM, 0.9990339397516345);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9990338909903526);
    AssertAlmostEqual(&test, rTM, 0.9990339875449118);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999029123321052);
    AssertAlmostEqual(&test, rTM, 0.9990387313390288);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9986340572660607);
    AssertAlmostEqual(&test, rTM, 0.9993167951689124);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.990333578086697);
    AssertAlmostEqual(&test, rTM, 0.9999038304114183);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9079009285403404);
    AssertAlmostEqual(&test, rTM, 0.9999903239749219);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3936135049958998);
    AssertAlmostEqual(&test, rTM, 0.9999989265270348);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01048140020709287);
    AssertAlmostEqual(&test, rTM, 0.9999995230171358);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000107023320169037);
    AssertAlmostEqual(&test, rTM, 0.9999995328123256);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.070460026625102e-06);
    AssertAlmostEqual(&test, rTM, 0.9999995329113147);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.070462295481388e-08);
    AssertAlmostEqual(&test, rTM, 0.9999995329123047);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.070462318170012e-10);
    AssertAlmostEqual(&test, rTM, 0.9999995329123147);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9952070286008026);
    AssertAlmostEqual(&test, rTM, 0.9952070286012806);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9952070285771343);
    AssertAlmostEqual(&test, rTM, 0.9952070286249489);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9952070262103134);
    AssertAlmostEqual(&test, rTM, 0.9952070309917685);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.995206789534171);
    AssertAlmostEqual(&test, rTM, 0.9952072676560172);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9951831810707509);
    AssertAlmostEqual(&test, rTM, 0.9952307583471078);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9932284561547626);
    AssertAlmostEqual(&test, rTM, 0.9966084670935594);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9528670140848164);
    AssertAlmostEqual(&test, rTM, 0.9995219122380034);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6212831546445051);
    AssertAlmostEqual(&test, rTM, 0.9999505920019873);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03993083299880099);
    AssertAlmostEqual(&test, rTM, 0.9999874984760788);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004328403241471885);
    AssertAlmostEqual(&test, rTM, 0.9999884485317057);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.332115198789759e-06);
    AssertAlmostEqual(&test, rTM, 0.9999884584272062);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.332152358555834e-08);
    AssertAlmostEqual(&test, rTM, 0.9999884585262041);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.332152730157519e-10);
    AssertAlmostEqual(&test, rTM, 0.9999884585271941);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9607322815946155);
    AssertAlmostEqual(&test, rTM, 0.9607322815946541);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9607322815927107);
    AssertAlmostEqual(&test, rTM, 0.9607322815965589);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9607322814022283);
    AssertAlmostEqual(&test, rTM, 0.9607322817870413);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9607322623539892);
    AssertAlmostEqual(&test, rTM, 0.9607323008352712);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9607303575796227);
    AssertAlmostEqual(&test, rTM, 0.9607342055172677);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.960540373076947);
    AssertAlmostEqual(&test, rTM, 0.9609232753844565);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9449257839727582);
    AssertAlmostEqual(&test, rTM, 0.9720674101900894);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.670354331861994);
    AssertAlmostEqual(&test, rTM, 0.9959435677173295);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05556848563178084);
    AssertAlmostEqual(&test, rTM, 0.9991038390080458);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006222858626727194);
    AssertAlmostEqual(&test, rTM, 0.9991971565403953);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.230539184183149e-06);
    AssertAlmostEqual(&test, rTM, 0.9991981447270015);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.230616109417301e-08);
    AssertAlmostEqual(&test, rTM, 0.9991981546150349);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.230616878681629e-10);
    AssertAlmostEqual(&test, rTM, 0.9991981547139158);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6775428056060084);
    AssertAlmostEqual(&test, rTM, 0.677542805606011);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6775428056058794);
    AssertAlmostEqual(&test, rTM, 0.67754280560614);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.677542805592986);
    AssertAlmostEqual(&test, rTM, 0.6775428056190335);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6775428043036372);
    AssertAlmostEqual(&test, rTM, 0.6775428069083821);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6775426753688117);
    AssertAlmostEqual(&test, rTM, 0.6775429358431653);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6775297823443511);
    AssertAlmostEqual(&test, rTM, 0.6775558284428077);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6762450372613529);
    AssertAlmostEqual(&test, rTM, 0.6788363685652938);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5785904806533553);
    AssertAlmostEqual(&test, rTM, 0.7568389502521059);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05733101837211199);
    AssertAlmostEqual(&test, rTM, 0.9204127924917331);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006507044701049258);
    AssertAlmostEqual(&test, rTM, 0.9286465843119703);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.516081416440753e-06);
    AssertAlmostEqual(&test, rTM, 0.9287351816323791);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.516171937699407e-08);
    AssertAlmostEqual(&test, rTM, 0.9287360683121875);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.516172842927435e-10);
    AssertAlmostEqual(&test, rTM, 0.9287360771790564);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05807869275950605);
    AssertAlmostEqual(&test, rTM, 0.05807869275950606);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05807869275950554);
    AssertAlmostEqual(&test, rTM, 0.05807869275950657);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05807869275945435);
    AssertAlmostEqual(&test, rTM, 0.05807869275955776);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05807869275433578);
    AssertAlmostEqual(&test, rTM, 0.05807869276467632);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05807869224247875);
    AssertAlmostEqual(&test, rTM, 0.05807869327653336);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05807864105682107);
    AssertAlmostEqual(&test, rTM, 0.05807874446219072);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05807352294817293);
    AssertAlmostEqual(&test, rTM, 0.05808386256772414);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05756624267702898);
    AssertAlmostEqual(&test, rTM, 0.05859111223704999);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03074894098636188);
    AssertAlmostEqual(&test, rTM, 0.08532166756813656);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006472973054225108);
    AssertAlmostEqual(&test, rTM, 0.1151282181243579);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.545434446150154e-06);
    AssertAlmostEqual(&test, rTM, 0.1157604305106686);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54616728121451e-08);
    AssertAlmostEqual(&test, rTM, 0.1157668236439184);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546174610396628e-10);
    AssertAlmostEqual(&test, rTM, 0.1157668875824319);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540625711025422);
    AssertAlmostEqual(&test, rTM, 0.0006540625711025422);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540625711025422);
    AssertAlmostEqual(&test, rTM, 0.0006540625711025423);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540625711025357);
    AssertAlmostEqual(&test, rTM, 0.0006540625711025488);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000654062571101889);
    AssertAlmostEqual(&test, rTM, 0.0006540625711031954);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540625710372215);
    AssertAlmostEqual(&test, rTM, 0.000654062571167863);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540625645704669);
    AssertAlmostEqual(&test, rTM, 0.0006540625776346175);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540619178956599);
    AssertAlmostEqual(&test, rTM, 0.0006540632243094245);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006539972568719641);
    AssertAlmostEqual(&test, rTM, 0.0006541278853331147);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006475950860860073);
    AssertAlmostEqual(&test, rTM, 0.0006605300560643604);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003272452194276658);
    AssertAlmostEqual(&test, rTM, 0.0009808797830571198);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.484262511313918e-06);
    AssertAlmostEqual(&test, rTM, 0.001301640331121694);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54853435829926e-08);
    AssertAlmostEqual(&test, rTM, 0.001308059097360674);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549183511725106e-10);
    AssertAlmostEqual(&test, rTM, 0.001308123927674974);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549405970508387e-06);
    AssertAlmostEqual(&test, rTM, 6.549405970508387e-06);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549405970508387e-06);
    AssertAlmostEqual(&test, rTM, 6.549405970508387e-06);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549405970508387e-06);
    AssertAlmostEqual(&test, rTM, 6.549405970508388e-06);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549405970508322e-06);
    AssertAlmostEqual(&test, rTM, 6.549405970508453e-06);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549405970501838e-06);
    AssertAlmostEqual(&test, rTM, 6.549405970514937e-06);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549405969853455e-06);
    AssertAlmostEqual(&test, rTM, 6.54940597116332e-06);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549405905015187e-06);
    AssertAlmostEqual(&test, rTM, 6.549406036001589e-06);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549399421194756e-06);
    AssertAlmostEqual(&test, rTM, 6.54941251982202e-06);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54875110397602e-06);
    AssertAlmostEqual(&test, rTM, 6.550060837040755e-06);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.484561207825079e-06);
    AssertAlmostEqual(&test, rTM, 6.614250733191641e-06);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.274724432648594e-06);
    AssertAlmostEqual(&test, rTM, 9.824087508227716e-06);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.484644466698861e-08);
    AssertAlmostEqual(&test, rTM, 1.303396549579899e-05);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54883686852317e-10);
    AssertAlmostEqual(&test, rTM, 1.309815705676817e-05);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549521073522595e-08);
    AssertAlmostEqual(&test, rTM, 6.549521073522595e-08);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549521073522595e-08);
    AssertAlmostEqual(&test, rTM, 6.549521073522595e-08);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549521073522595e-08);
    AssertAlmostEqual(&test, rTM, 6.549521073522595e-08);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549521073522595e-08);
    AssertAlmostEqual(&test, rTM, 6.549521073522596e-08);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54952107352253e-08);
    AssertAlmostEqual(&test, rTM, 6.549521073522661e-08);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549521073516046e-08);
    AssertAlmostEqual(&test, rTM, 6.549521073529145e-08);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549521072867644e-08);
    AssertAlmostEqual(&test, rTM, 6.549521074177547e-08);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549521008027393e-08);
    AssertAlmostEqual(&test, rTM, 6.549521139017796e-08);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549514524008929e-08);
    AssertAlmostEqual(&test, rTM, 6.549527623036261e-08);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54886618698968e-08);
    AssertAlmostEqual(&test, rTM, 6.550175960055511e-08);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.484674338630591e-08);
    AssertAlmostEqual(&test, rTM, 6.6143678084146e-08);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.274760751242432e-08);
    AssertAlmostEqual(&test, rTM, 9.824281395802744e-08);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.484675171240495e-10);
    AssertAlmostEqual(&test, rTM, 1.303419539533273e-07);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549524939949125e-10);
    AssertAlmostEqual(&test, rTM, 6.549524939949125e-10);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549524939949125e-10);
    AssertAlmostEqual(&test, rTM, 6.549524939949125e-10);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549524939949125e-10);
    AssertAlmostEqual(&test, rTM, 6.549524939949125e-10);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549524939949125e-10);
    AssertAlmostEqual(&test, rTM, 6.549524939949125e-10);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549524939949124e-10);
    AssertAlmostEqual(&test, rTM, 6.549524939949126e-10);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54952493994906e-10);
    AssertAlmostEqual(&test, rTM, 6.54952493994919e-10);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549524939942576e-10);
    AssertAlmostEqual(&test, rTM, 6.549524939955675e-10);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549524939294173e-10);
    AssertAlmostEqual(&test, rTM, 6.549524940604078e-10);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549524874453876e-10);
    AssertAlmostEqual(&test, rTM, 6.549525005444374e-10);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549518390430744e-10);
    AssertAlmostEqual(&test, rTM, 6.549531489467507e-10);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.548870052944688e-10);
    AssertAlmostEqual(&test, rTM, 6.550179826953562e-10);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.484678158449573e-10);
    AssertAlmostEqual(&test, rTM, 6.614371721448678e-10);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.274762472119376e-10);
    AssertAlmostEqual(&test, rTM, 9.824287407778875e-10);

    userdata[0] = 0.1/CAPS_HBAR_EV; /* 0.1eV */
    userdata[1] = 0.001/CAPS_HBAR_EV; /* 0.001eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999604661254959);
    AssertAlmostEqual(&test, rTM, 0.9999802328673763);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997190929451434);
    AssertAlmostEqual(&test, rTM, 0.9999972183551532);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9972082430251229);
    AssertAlmostEqual(&test, rTM, 0.9999997204615092);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9724327795988127);
    AssertAlmostEqual(&test, rTM, 0.9999999720420603);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7568048441320414);
    AssertAlmostEqual(&test, rTM, 0.9999999971773013);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1029656209485318);
    AssertAlmostEqual(&test, rTM, 0.9999999995195493);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001276335205308842);
    AssertAlmostEqual(&test, rTM, 0.999999999608254);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.27956677017474e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999996092428);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279599189150777e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999996092527);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279599513350907e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999996092528);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279599516592909e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999996092528);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279599516625329e-13);
    AssertAlmostEqual(&test, rTM, 0.9999999996092528);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279599516625654e-15);
    AssertAlmostEqual(&test, rTM, 0.9999999996092528);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999111600758263);
    AssertAlmostEqual(&test, rTM, 0.999912039640349);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998749871562567);
    AssertAlmostEqual(&test, rTM, 0.9999374916244187);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991119558669819);
    AssertAlmostEqual(&test, rTM, 0.9999912036149958);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9911982553972627);
    AssertAlmostEqual(&test, rTM, 0.9999991160063996);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.915418227964539);
    AssertAlmostEqual(&test, rTM, 0.9999999115107754);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4242154340770521);
    AssertAlmostEqual(&test, rTM, 0.9999999903346132);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01247842060738756);
    AssertAlmostEqual(&test, rTM, 0.9999999959937066);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000127924965835554);
    AssertAlmostEqual(&test, rTM, 0.9999999960914588);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279573742484974e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999960924487);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.27957698436285e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999960924586);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279577016781733e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999960924587);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279577017105922e-12);
    AssertAlmostEqual(&test, rTM, 0.9999999960924587);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279577017109164e-14);
    AssertAlmostEqual(&test, rTM, 0.9999999960924587);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991155069133915);
    AssertAlmostEqual(&test, rTM, 0.9991155077974924);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991154631514827);
    AssertAlmostEqual(&test, rTM, 0.9991155515571933);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991110978549883);
    AssertAlmostEqual(&test, rTM, 0.9991198949916958);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9987493677249552);
    AssertAlmostEqual(&test, rTM, 0.999374488168786);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9911464797673536);
    AssertAlmostEqual(&test, rTM, 0.9999119537674048);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9153360786259461);
    AssertAlmostEqual(&test, rTM, 0.9999911429854678);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4238838671505174);
    AssertAlmostEqual(&test, rTM, 0.9999990323751941);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01245492450528109);
    AssertAlmostEqual(&test, rTM, 0.9999995986148017);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001276780795008758);
    AssertAlmostEqual(&test, rTM, 0.9999996083902594);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.277103629432975e-06);
    AssertAlmostEqual(&test, rTM, 0.9999996084892465);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.27710685880781e-08);
    AssertAlmostEqual(&test, rTM, 0.9999996084902365);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.277106891101662e-10);
    AssertAlmostEqual(&test, rTM, 0.9999996084902464);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.2771068914246e-12);
    AssertAlmostEqual(&test, rTM, 0.9999996084902465);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9971812849869506);
    AssertAlmostEqual(&test, rTM, 0.997181285015098);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9971812835936562);
    AssertAlmostEqual(&test, rTM, 0.9971812864083915);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9971811442677116);
    AssertAlmostEqual(&test, rTM, 0.9971814257273205);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9971672464252195);
    AssertAlmostEqual(&test, rTM, 0.9971952541020823);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960160647039784);
    AssertAlmostEqual(&test, rTM, 0.9980060424386694);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9720317673843616);
    AssertAlmostEqual(&test, rTM, 0.9997191430048321);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7547605095735995);
    AssertAlmostEqual(&test, rTM, 0.9999714951598181);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1013554757660668);
    AssertAlmostEqual(&test, rTM, 0.9999951175716815);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001251940470942476);
    AssertAlmostEqual(&test, rTM, 0.9999960062221125);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.255049586218054e-05);
    AssertAlmostEqual(&test, rTM, 0.9999960161095351);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.255080774879052e-07);
    AssertAlmostEqual(&test, rTM, 0.9999960162085333);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.255081086775447e-09);
    AssertAlmostEqual(&test, rTM, 0.9999960162095233);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.255081089894412e-11);
    AssertAlmostEqual(&test, rTM, 0.9999960162095332);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9903813188651513);
    AssertAlmostEqual(&test, rTM, 0.9903813188661086);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9903813188177689);
    AssertAlmostEqual(&test, rTM, 0.9903813189134909);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9903813140795321);
    AssertAlmostEqual(&test, rTM, 0.9903813236517254);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9903808402678071);
    AssertAlmostEqual(&test, rTM, 0.9903817974397554);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.990333578086697);
    AssertAlmostEqual(&test, rTM, 0.9904288249949897);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9864243324534478);
    AssertAlmostEqual(&test, rTM, 0.9931888919097651);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9074682624586705);
    AssertAlmostEqual(&test, rTM, 0.9990376211884398);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3935965503084503);
    AssertAlmostEqual(&test, rTM, 0.9998926651956794);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01048139004578264);
    AssertAlmostEqual(&test, rTM, 0.9999523039434599);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001070233191097329);
    AssertAlmostEqual(&test, rTM, 0.9999532833930372);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.070460026519127e-06);
    AssertAlmostEqual(&test, rTM, 0.9999532932912735);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.070462295480328e-08);
    AssertAlmostEqual(&test, rTM, 0.9999532933902664);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.070462318170001e-10);
    AssertAlmostEqual(&test, rTM, 0.9999532933912564);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9530953082699523);
    AssertAlmostEqual(&test, rTM, 0.9530953082699981);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9530953082676863);
    AssertAlmostEqual(&test, rTM, 0.9530953082722641);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.953095308041084);
    AssertAlmostEqual(&test, rTM, 0.9530953084988665);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9530952853808567);
    AssertAlmostEqual(&test, rTM, 0.9530953311590827);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9530930194175289);
    AssertAlmostEqual(&test, rTM, 0.9530975970134177);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9528670140848164);
    AssertAlmostEqual(&test, rTM, 0.9533225231154185);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9343232438085881);
    AssertAlmostEqual(&test, rTM, 0.9665945077003363);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6198519326646841);
    AssertAlmostEqual(&test, rTM, 0.9950968834115199);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0399271837670649);
    AssertAlmostEqual(&test, rTM, 0.9987513428028746);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004328398960064893);
    AssertAlmostEqual(&test, rTM, 0.9988461721128812);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.33211515590219e-06);
    AssertAlmostEqual(&test, rTM, 0.9988471599680422);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.332152358126951e-08);
    AssertAlmostEqual(&test, rTM, 0.9988471698508858);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.33215273015323e-10);
    AssertAlmostEqual(&test, rTM, 0.9988471699497147);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6716688548482547);
    AssertAlmostEqual(&test, rTM, 0.6716688548482573);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6716688548481241);
    AssertAlmostEqual(&test, rTM, 0.6716688548483879);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6716688548350639);
    AssertAlmostEqual(&test, rTM, 0.6716688548614482);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6716688535290366);
    AssertAlmostEqual(&test, rTM, 0.6716688561674754);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6716687229263597);
    AssertAlmostEqual(&test, rTM, 0.6716689867701098);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6716556631259593);
    AssertAlmostEqual(&test, rTM, 0.6716820461446487);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.670354331861994);
    AssertAlmostEqual(&test, rTM, 0.6729791621875733);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.571638658760516);
    AssertAlmostEqual(&test, rTM, 0.7520257533964058);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05508066163348157);
    AssertAlmostEqual(&test, rTM, 0.9174096156137859);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006222243391428708);
    AssertAlmostEqual(&test, rTM, 0.925623539957793);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.230533016032387e-06);
    AssertAlmostEqual(&test, rTM, 0.925711712971059);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.23061604773421e-08);
    AssertAlmostEqual(&test, rTM, 0.9257125953791353);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.230616878064798e-10);
    AssertAlmostEqual(&test, rTM, 0.9257126042032839);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05784161748324198);
    AssertAlmostEqual(&test, rTM, 0.05784161748324199);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05784161748324147);
    AssertAlmostEqual(&test, rTM, 0.0578416174832425);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05784161748319047);
    AssertAlmostEqual(&test, rTM, 0.0578416174832935);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05784161747809036);
    AssertAlmostEqual(&test, rTM, 0.0578416174883936);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05784161696808014);
    AssertAlmostEqual(&test, rTM, 0.05784161799840384);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05784156596710274);
    AssertAlmostEqual(&test, rTM, 0.05784166899938093);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05783646632503715);
    AssertAlmostEqual(&test, rTM, 0.05784676863836692);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.057331018372112);
    AssertAlmostEqual(&test, rTM, 0.05835218633497771);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03061638762457291);
    AssertAlmostEqual(&test, rTM, 0.08498108458560805);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006443344918340589);
    AssertAlmostEqual(&test, rTM, 0.1146616733485741);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.515436397288499e-06);
    AssertAlmostEqual(&test, rTM, 0.1152910607793668);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.516165486696481e-08);
    AssertAlmostEqual(&test, rTM, 0.1152974253121392);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.516172778417324e-10);
    AssertAlmostEqual(&test, rTM, 0.1152974889646124);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006537618204136613);
    AssertAlmostEqual(&test, rTM, 0.0006537618204136613);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006537618204136613);
    AssertAlmostEqual(&test, rTM, 0.0006537618204136614);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006537618204136548);
    AssertAlmostEqual(&test, rTM, 0.0006537618204136678);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006537618204130084);
    AssertAlmostEqual(&test, rTM, 0.0006537618204143142);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006537618203483705);
    AssertAlmostEqual(&test, rTM, 0.000653761820478952);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006537618138845857);
    AssertAlmostEqual(&test, rTM, 0.0006537618269427369);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006537611675067435);
    AssertAlmostEqual(&test, rTM, 0.000653762473320579);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006536965361765718);
    AssertAlmostEqual(&test, rTM, 0.0006538271046507452);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006472973054225109);
    AssertAlmostEqual(&test, rTM, 0.0006602263353501704);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003270946473704986);
    AssertAlmostEqual(&test, rTM, 0.0009804288539290908);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.481277058970521e-06);
    AssertAlmostEqual(&test, rTM, 0.001301041815952653);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.545519275539077e-08);
    AssertAlmostEqual(&test, rTM, 0.001307457626905192);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546168129690252e-10);
    AssertAlmostEqual(&test, rTM, 0.001307522427370356);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549104287110364e-06);
    AssertAlmostEqual(&test, rTM, 6.549104287110364e-06);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549104287110364e-06);
    AssertAlmostEqual(&test, rTM, 6.549104287110364e-06);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549104287110363e-06);
    AssertAlmostEqual(&test, rTM, 6.549104287110365e-06);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549104287110299e-06);
    AssertAlmostEqual(&test, rTM, 6.54910428711043e-06);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549104287103815e-06);
    AssertAlmostEqual(&test, rTM, 6.549104287116913e-06);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549104286455463e-06);
    AssertAlmostEqual(&test, rTM, 6.549104287765266e-06);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549104221620179e-06);
    AssertAlmostEqual(&test, rTM, 6.549104352600548e-06);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549097738098407e-06);
    AssertAlmostEqual(&test, rTM, 6.549110836122321e-06);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54844945074253e-06);
    AssertAlmostEqual(&test, rTM, 6.549759123478199e-06);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.484262511313918e-06);
    AssertAlmostEqual(&test, rTM, 6.613946062906755e-06);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.274573588973776e-06);
    AssertAlmostEqual(&test, rTM, 9.823634985106507e-06);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.484345762517581e-08);
    AssertAlmostEqual(&test, rTM, 1.303336511604483e-05);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.548535207388727e-10);
    AssertAlmostEqual(&test, rTM, 1.309755372013831e-05);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549490902871628e-08);
    AssertAlmostEqual(&test, rTM, 6.549490902871628e-08);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549490902871628e-08);
    AssertAlmostEqual(&test, rTM, 6.549490902871628e-08);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549490902871628e-08);
    AssertAlmostEqual(&test, rTM, 6.549490902871628e-08);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549490902871628e-08);
    AssertAlmostEqual(&test, rTM, 6.549490902871629e-08);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549490902871563e-08);
    AssertAlmostEqual(&test, rTM, 6.549490902871694e-08);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549490902865079e-08);
    AssertAlmostEqual(&test, rTM, 6.549490902878178e-08);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549490902216679e-08);
    AssertAlmostEqual(&test, rTM, 6.549490903526577e-08);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549490837376728e-08);
    AssertAlmostEqual(&test, rTM, 6.549490968366529e-08);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549484353388132e-08);
    AssertAlmostEqual(&test, rTM, 6.549497452355124e-08);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.548836019355475e-08);
    AssertAlmostEqual(&test, rTM, 6.55014578638778e-08);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.484644466698862e-08);
    AssertAlmostEqual(&test, rTM, 6.614337339044393e-08);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.274745665914973e-08);
    AssertAlmostEqual(&test, rTM, 9.82423613982827e-08);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.484645299301095e-10);
    AssertAlmostEqual(&test, rTM, 1.303413535275019e-07);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549521922867957e-10);
    AssertAlmostEqual(&test, rTM, 6.549521922867957e-10);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549521922867957e-10);
    AssertAlmostEqual(&test, rTM, 6.549521922867957e-10);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549521922867957e-10);
    AssertAlmostEqual(&test, rTM, 6.549521922867957e-10);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549521922867957e-10);
    AssertAlmostEqual(&test, rTM, 6.549521922867957e-10);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549521922867957e-10);
    AssertAlmostEqual(&test, rTM, 6.549521922867958e-10);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549521922867892e-10);
    AssertAlmostEqual(&test, rTM, 6.549521922868024e-10);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549521922861408e-10);
    AssertAlmostEqual(&test, rTM, 6.549521922874508e-10);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549521922213006e-10);
    AssertAlmostEqual(&test, rTM, 6.54952192352291e-10);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549521857372739e-10);
    AssertAlmostEqual(&test, rTM, 6.549521988363176e-10);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549515373352593e-10);
    AssertAlmostEqual(&test, rTM, 6.549528472383323e-10);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.5488670361652e-10);
    AssertAlmostEqual(&test, rTM, 6.550176809570716e-10);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.484675171240496e-10);
    AssertAlmostEqual(&test, rTM, 6.61436867449542e-10);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.27476096357879e-10);
    AssertAlmostEqual(&test, rTM, 9.824282882157126e-10);

    userdata[0] = 0.1/CAPS_HBAR_EV; /* 0.1eV */
    userdata[1] = 0.003/CAPS_HBAR_EV; /* 0.003eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999315263561991);
    AssertAlmostEqual(&test, rTM, 0.9999657625919894);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995135050561457);
    AssertAlmostEqual(&test, rTM, 0.9999951820577466);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.995169483726114);
    AssertAlmostEqual(&test, rTM, 0.9999995158245502);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9527381937072755);
    AssertAlmostEqual(&test, rTM, 0.999999951566002);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6190377923274856);
    AssertAlmostEqual(&test, rTM, 0.9999999950181377);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0393616435912935);
    AssertAlmostEqual(&test, rTM, 0.9999999987316959);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004261702532561869);
    AssertAlmostEqual(&test, rTM, 0.9999999988267602);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.265300891810375e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999988277498);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.265336913764604e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999988277597);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.265337273987986e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999988277598);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.26533727759022e-12);
    AssertAlmostEqual(&test, rTM, 0.9999999988277598);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.265337277626242e-14);
    AssertAlmostEqual(&test, rTM, 0.9999999988277598);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.265337277626603e-16);
    AssertAlmostEqual(&test, rTM, 0.9999999988277598);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998461307433739);
    AssertAlmostEqual(&test, rTM, 0.9998476540853051);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997834827212089);
    AssertAlmostEqual(&test, rTM, 0.9998917354996862);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9984623725554421);
    AssertAlmostEqual(&test, rTM, 0.9999847643595769);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9848042807506662);
    AssertAlmostEqual(&test, rTM, 0.9999984688587271);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8581569193485541);
    AssertAlmostEqual(&test, rTM, 0.9999998464346027);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2438650125772096);
    AssertAlmostEqual(&test, rTM, 0.9999999807161793);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.004229309916264521);
    AssertAlmostEqual(&test, rTM, 0.999999988177952);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.264948458819432e-05);
    AssertAlmostEqual(&test, rTM, 0.999999988276529);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.26530863923177e-07);
    AssertAlmostEqual(&test, rTM, 0.999999988277519);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.26531224141992e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999882775289);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.26531227744184e-11);
    AssertAlmostEqual(&test, rTM, 0.999999988277529);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.265312277802059e-13);
    AssertAlmostEqual(&test, rTM, 0.999999988277529);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.265312277805661e-15);
    AssertAlmostEqual(&test, rTM, 0.999999988277529);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9984695041409808);
    AssertAlmostEqual(&test, rTM, 0.998469505670303);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9984694284414071);
    AssertAlmostEqual(&test, rTM, 0.99846958136606);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9984618773413868);
    AssertAlmostEqual(&test, rTM, 0.998477094673561);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9978362395743874);
    AssertAlmostEqual(&test, rTM, 0.9989175336035255);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9847249480257796);
    AssertAlmostEqual(&test, rTM, 0.9998476005618179);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.85810820577311);
    AssertAlmostEqual(&test, rTM, 0.9999846393634458);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2437693290085197);
    AssertAlmostEqual(&test, rTM, 0.9999980707701857);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.004226607817178744);
    AssertAlmostEqual(&test, rTM, 0.9999988170407675);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.262200734700767e-05);
    AssertAlmostEqual(&test, rTM, 0.9999988268984883);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.262560451568089e-07);
    AssertAlmostEqual(&test, rTM, 0.9999988269974839);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.262564049120049e-09);
    AssertAlmostEqual(&test, rTM, 0.9999988269984739);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.262564085095607e-11);
    AssertAlmostEqual(&test, rTM, 0.9999988269984837);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.262564085455363e-13);
    AssertAlmostEqual(&test, rTM, 0.9999988269984839);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.995154061420695);
    AssertAlmostEqual(&test, rTM, 0.9951540614690366);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9951540590277822);
    AssertAlmostEqual(&test, rTM, 0.9951540638619483);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9951538197425138);
    AssertAlmostEqual(&test, rTM, 0.9951543031351923);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9951299510217613);
    AssertAlmostEqual(&test, rTM, 0.9951780527916417);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9931536992487242);
    AssertAlmostEqual(&test, rTM, 0.9965709604055928);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9523576187295464);
    AssertAlmostEqual(&test, rTM, 0.9995166142300626);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6180770435103453);
    AssertAlmostEqual(&test, rTM, 0.999950014331214);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03912612603071274);
    AssertAlmostEqual(&test, rTM, 0.9999872405475717);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004234154075177963);
    AssertAlmostEqual(&test, rTM, 0.9999881914074291);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.237706091335424e-06);
    AssertAlmostEqual(&test, rTM, 0.99998820130302);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.23774164911999e-08);
    AssertAlmostEqual(&test, rTM, 0.9999882014020178);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.237742004701602e-10);
    AssertAlmostEqual(&test, rTM, 0.9999882014030078);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.237742008257419e-12);
    AssertAlmostEqual(&test, rTM, 0.9999882014030178);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9843219543266528);
    AssertAlmostEqual(&test, rTM, 0.9843219543282082);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9843219542496596);
    AssertAlmostEqual(&test, rTM, 0.9843219544052013);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9843219465503454);
    AssertAlmostEqual(&test, rTM, 0.9843219621045117);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9843211766384765);
    AssertAlmostEqual(&test, rTM, 0.9843227319781148);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9842443799871644);
    AssertAlmostEqual(&test, rTM, 0.9843991497258141);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9779003378044785);
    AssertAlmostEqual(&test, rTM, 0.9888880905862347);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8532985115253956);
    AssertAlmostEqual(&test, rTM, 0.9984239932704111);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2345862032494558);
    AssertAlmostEqual(&test, rTM, 0.9997986410314941);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.003972787128354658);
    AssertAlmostEqual(&test, rTM, 0.9998741616595115);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.004225581608309e-05);
    AssertAlmostEqual(&test, rTM, 0.9998751475009936);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.004543109690397e-07);
    AssertAlmostEqual(&test, rTM, 0.9998751573987393);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.004546285289094e-09);
    AssertAlmostEqual(&test, rTM, 0.9998751574977207);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.004546317045114e-11);
    AssertAlmostEqual(&test, rTM, 0.9998751574987106);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9396857224525045);
    AssertAlmostEqual(&test, rTM, 0.939685722452563);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9396857224496118);
    AssertAlmostEqual(&test, rTM, 0.9396857224554557);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9396857221603396);
    AssertAlmostEqual(&test, rTM, 0.9396857227447278);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9396856932331351);
    AssertAlmostEqual(&test, rTM, 0.9396857516719187);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9396828005895489);
    AssertAlmostEqual(&test, rTM, 0.9396886441783798);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9393943011456484);
    AssertAlmostEqual(&test, rTM, 0.9399757858358248);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9157940606103179);
    AssertAlmostEqual(&test, rTM, 0.9569509511645155);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.540350136358117);
    AssertAlmostEqual(&test, rTM, 0.9935405593258526);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02457463253258452);
    AssertAlmostEqual(&test, rTM, 0.9979708403358701);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000258177062379531);
    AssertAlmostEqual(&test, rTM, 0.9980670890856875);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.583093460628511e-06);
    AssertAlmostEqual(&test, rTM, 0.998068075959745);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.583106697547817e-08);
    AssertAlmostEqual(&test, rTM, 0.9980680858310487);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.583106829917866e-10);
    AssertAlmostEqual(&test, rTM, 0.9980680859297619);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6592481750739357);
    AssertAlmostEqual(&test, rTM, 0.6592481750739385);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6592481750738017);
    AssertAlmostEqual(&test, rTM, 0.6592481750740725);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6592481750603985);
    AssertAlmostEqual(&test, rTM, 0.6592481750874758);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6592481737200708);
    AssertAlmostEqual(&test, rTM, 0.6592481764278034);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6592480396873563);
    AssertAlmostEqual(&test, rTM, 0.6592483104604752);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6592346369026727);
    AssertAlmostEqual(&test, rTM, 0.6592617128178004);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6578992009083225);
    AssertAlmostEqual(&test, rTM, 0.6605929189256675);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5570345990417578);
    AssertAlmostEqual(&test, rTM, 0.7417874751955807);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05066311531895143);
    AssertAlmostEqual(&test, rTM, 0.9108103617513233);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000567069694169318);
    AssertAlmostEqual(&test, rTM, 0.9189756245191844);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.677631341275467e-06);
    AssertAlmostEqual(&test, rTM, 0.9190628668827221);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.677700789012848e-08);
    AssertAlmostEqual(&test, rTM, 0.9190637399286806);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.677701483500613e-10);
    AssertAlmostEqual(&test, rTM, 0.9190637486592025);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05732167333058279);
    AssertAlmostEqual(&test, rTM, 0.0573216733305828);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05732167333058229);
    AssertAlmostEqual(&test, rTM, 0.05732167333058331);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0573216733305317);
    AssertAlmostEqual(&test, rTM, 0.05732167333063391);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05732167332547216);
    AssertAlmostEqual(&test, rTM, 0.05732167333569344);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05732167281951885);
    AssertAlmostEqual(&test, rTM, 0.05732167384164674);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0573216222242335);
    AssertAlmostEqual(&test, rTM, 0.0573217244369318);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05731656314819246);
    AssertAlmostEqual(&test, rTM, 0.05732678350996948);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05681514024308321);
    AssertAlmostEqual(&test, rTM, 0.05782817690812821);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03032588111554581);
    AssertAlmostEqual(&test, rTM, 0.08423390064178705);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006378465902925189);
    AssertAlmostEqual(&test, rTM, 0.1136383241609526);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.449748584315169e-06);
    AssertAlmostEqual(&test, rTM, 0.1142615226405424);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.450469484170526e-08);
    AssertAlmostEqual(&test, rTM, 0.1142678245160338);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.450476693985558e-10);
    AssertAlmostEqual(&test, rTM, 0.1142678875418565);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000653094474771056);
    AssertAlmostEqual(&test, rTM, 0.000653094474771056);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006530944747710559);
    AssertAlmostEqual(&test, rTM, 0.0006530944747710561);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006530944747710495);
    AssertAlmostEqual(&test, rTM, 0.0006530944747710625);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006530944747704038);
    AssertAlmostEqual(&test, rTM, 0.0006530944747717083);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006530944747058318);
    AssertAlmostEqual(&test, rTM, 0.0006530944748362802);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006530944682486364);
    AssertAlmostEqual(&test, rTM, 0.0006530944812934757);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006530938225297407);
    AssertAlmostEqual(&test, rTM, 0.0006530951270123713);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006530292570876387);
    AssertAlmostEqual(&test, rTM, 0.0006531596924544678);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006466365500800254);
    AssertAlmostEqual(&test, rTM, 0.0006595523994076123);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003267605383800112);
    AssertAlmostEqual(&test, rTM, 0.0009794282720610263);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.474652552807335e-06);
    AssertAlmostEqual(&test, rTM, 0.001299713750849474);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.538829021718237e-08);
    AssertAlmostEqual(&test, rTM, 0.001306123004231789);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.539477211801532e-10);
    AssertAlmostEqual(&test, rTM, 0.001306187738463846);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.548433979053783e-06);
    AssertAlmostEqual(&test, rTM, 6.548433979053783e-06);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.548433979053783e-06);
    AssertAlmostEqual(&test, rTM, 6.548433979053783e-06);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.548433979053782e-06);
    AssertAlmostEqual(&test, rTM, 6.548433979053784e-06);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.548433979053718e-06);
    AssertAlmostEqual(&test, rTM, 6.548433979053848e-06);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.548433979047234e-06);
    AssertAlmostEqual(&test, rTM, 6.548433979060331e-06);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.548433978398948e-06);
    AssertAlmostEqual(&test, rTM, 6.548433979708618e-06);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.548433913570302e-06);
    AssertAlmostEqual(&test, rTM, 6.548434044537265e-06);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.548427430712115e-06);
    AssertAlmostEqual(&test, rTM, 6.54844052739545e-06);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.547779209708296e-06);
    AssertAlmostEqual(&test, rTM, 6.54908874839927e-06);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.483598839798643e-06);
    AssertAlmostEqual(&test, rTM, 6.613269118308869e-06);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.274238430555781e-06);
    AssertAlmostEqual(&test, rTM, 9.822629527411381e-06);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.483682073961388e-08);
    AssertAlmostEqual(&test, rTM, 1.30320311368174e-05);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.547864948800732e-10);
    AssertAlmostEqual(&test, rTM, 1.309621317105118e-05);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549423857975762e-08);
    AssertAlmostEqual(&test, rTM, 6.549423857975762e-08);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549423857975762e-08);
    AssertAlmostEqual(&test, rTM, 6.549423857975762e-08);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549423857975762e-08);
    AssertAlmostEqual(&test, rTM, 6.549423857975762e-08);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549423857975762e-08);
    AssertAlmostEqual(&test, rTM, 6.549423857975764e-08);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549423857975698e-08);
    AssertAlmostEqual(&test, rTM, 6.549423857975829e-08);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549423857969214e-08);
    AssertAlmostEqual(&test, rTM, 6.549423857982312e-08);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549423857320821e-08);
    AssertAlmostEqual(&test, rTM, 6.549423858630705e-08);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549423792481534e-08);
    AssertAlmostEqual(&test, rTM, 6.549423923469992e-08);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549417308559313e-08);
    AssertAlmostEqual(&test, rTM, 6.549430407392214e-08);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.548768981163427e-08);
    AssertAlmostEqual(&test, rTM, 6.550078734788098e-08);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.484578085613676e-08);
    AssertAlmostEqual(&test, rTM, 6.61426963033785e-08);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.274712143462649e-08);
    AssertAlmostEqual(&test, rTM, 9.824135572488863e-08);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.484578918198862e-10);
    AssertAlmostEqual(&test, rTM, 1.303400192676948e-07);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549515218253093e-10);
    AssertAlmostEqual(&test, rTM, 6.549515218253093e-10);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549515218253093e-10);
    AssertAlmostEqual(&test, rTM, 6.549515218253093e-10);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549515218253093e-10);
    AssertAlmostEqual(&test, rTM, 6.549515218253093e-10);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549515218253093e-10);
    AssertAlmostEqual(&test, rTM, 6.549515218253093e-10);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549515218253093e-10);
    AssertAlmostEqual(&test, rTM, 6.549515218253094e-10);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549515218253028e-10);
    AssertAlmostEqual(&test, rTM, 6.549515218253159e-10);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549515218246544e-10);
    AssertAlmostEqual(&test, rTM, 6.549515218259643e-10);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549515217598142e-10);
    AssertAlmostEqual(&test, rTM, 6.549515218908045e-10);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549515152757942e-10);
    AssertAlmostEqual(&test, rTM, 6.549515283748245e-10);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549508668744433e-10);
    AssertAlmostEqual(&test, rTM, 6.549521767761753e-10);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.548860332220729e-10);
    AssertAlmostEqual(&test, rTM, 6.550170104285457e-10);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.484668533007956e-10);
    AssertAlmostEqual(&test, rTM, 6.61436190349823e-10);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.274757611271354e-10);
    AssertAlmostEqual(&test, rTM, 9.824272825234834e-10);

    userdata[0] = 0.1/CAPS_HBAR_EV; /* 0.1eV */
    userdata[1] = 0.035/CAPS_HBAR_EV; /* 0.035eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997661373935688);
    AssertAlmostEqual(&test, rTM, 0.9998830618591202);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.998339280279573);
    AssertAlmostEqual(&test, rTM, 0.9999835436898815);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9835968650478079);
    AssertAlmostEqual(&test, rTM, 0.9999983461757705);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8477263895983768);
    AssertAlmostEqual(&test, rTM, 0.9999998340504288);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2215488733943358);
    AssertAlmostEqual(&test, rTM, 0.9999999785393612);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.003629514667674093);
    AssertAlmostEqual(&test, rTM, 0.9999999862242351);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.655738254586874e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999863228722);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.656002884419094e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999863238622);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.656005530959261e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999863238721);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.656005557424687e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999863238722);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.656005557689341e-13);
    AssertAlmostEqual(&test, rTM, 0.9999999863238722);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.656005557691988e-15);
    AssertAlmostEqual(&test, rTM, 0.9999999863238722);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.656005557692014e-17);
    AssertAlmostEqual(&test, rTM, 0.9999999863238722);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999474535671203);
    AssertAlmostEqual(&test, rTM, 0.9994797369345995);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9992606483000952);
    AssertAlmostEqual(&test, rTM, 0.9996302557820196);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9947577703499378);
    AssertAlmostEqual(&test, rTM, 0.9999479613323945);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9490478569109327);
    AssertAlmostEqual(&test, rTM, 0.9999947685478546);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5961815423297265);
    AssertAlmostEqual(&test, rTM, 0.9999994594207805);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03410855079601335);
    AssertAlmostEqual(&test, rTM, 0.9999998535797575);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003653332888827036);
    AssertAlmostEqual(&test, rTM, 0.9999998631387065);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.655976988472713e-06);
    AssertAlmostEqual(&test, rTM, 0.99999986323767);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.656003453631173e-08);
    AssertAlmostEqual(&test, rTM, 0.99999986323866);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.656003718285175e-10);
    AssertAlmostEqual(&test, rTM, 0.9999998632386699);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.656003720931716e-12);
    AssertAlmostEqual(&test, rTM, 0.99999986323867);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.656003720958181e-14);
    AssertAlmostEqual(&test, rTM, 0.99999986323867);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.656003720958446e-16);
    AssertAlmostEqual(&test, rTM, 0.99999986323867);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9947835721514474);
    AssertAlmostEqual(&test, rTM, 0.9947835773542288);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9947833146201699);
    AssertAlmostEqual(&test, rTM, 0.9947838348725699);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9947576258827608);
    AssertAlmostEqual(&test, rTM, 0.9948093955145978);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9926308471154146);
    AssertAlmostEqual(&test, rTM, 0.9963085977807824);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9488015211041307);
    AssertAlmostEqual(&test, rTM, 0.9994795465079014);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.596158275772298);
    AssertAlmostEqual(&test, rTM, 0.9999459448056183);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03410675876173581);
    AssertAlmostEqual(&test, rTM, 0.9999853574244038);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003653131118296882);
    AssertAlmostEqual(&test, rTM, 0.9999863133002558);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.655774961639077e-06);
    AssertAlmostEqual(&test, rTM, 0.9999863231963999);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.655801424231021e-08);
    AssertAlmostEqual(&test, rTM, 0.9999863232953975);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.655801688859359e-10);
    AssertAlmostEqual(&test, rTM, 0.9999863232963875);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.655801691505643e-12);
    AssertAlmostEqual(&test, rTM, 0.9999863232963974);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.655801691532106e-14);
    AssertAlmostEqual(&test, rTM, 0.9999863232963975);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9835931392694416);
    AssertAlmostEqual(&test, rTM, 0.9835931394321532);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9835931312152221);
    AssertAlmostEqual(&test, rTM, 0.9835931474863687);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9835923258137302);
    AssertAlmostEqual(&test, rTM, 0.9835939528478608);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9835119893169477);
    AssertAlmostEqual(&test, rTM, 0.983673893271078);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9768765524664891);
    AssertAlmostEqual(&test, rTM, 0.9883702599263879);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8469907247160908);
    AssertAlmostEqual(&test, rTM, 0.9983496949496252);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2214559861881082);
    AssertAlmostEqual(&test, rTM, 0.9997853534959049);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.003627501006891066);
    AssertAlmostEqual(&test, rTM, 0.9998621849415955);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.653699042507377e-05);
    AssertAlmostEqual(&test, rTM, 0.9998631711105452);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.653963413357564e-07);
    AssertAlmostEqual(&test, rTM, 0.9998631810081482);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.653966057307559e-09);
    AssertAlmostEqual(&test, rTM, 0.9998631811071278);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.653966083747083e-11);
    AssertAlmostEqual(&test, rTM, 0.9998631811081177);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.653966084011479e-13);
    AssertAlmostEqual(&test, rTM, 0.9998631811081276);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9489120689688901);
    AssertAlmostEqual(&test, rTM, 0.948912068973865);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9489120687226339);
    AssertAlmostEqual(&test, rTM, 0.9489120692201213);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.948912044097017);
    AssertAlmostEqual(&test, rTM, 0.9489120938457264);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9489095816001489);
    AssertAlmostEqual(&test, rTM, 0.9489145562246812);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9486639769323799);
    AssertAlmostEqual(&test, rTM, 0.94915899333485);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9285308691200456);
    AssertAlmostEqual(&test, rTM, 0.9635907929386812);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5938374981644781);
    AssertAlmostEqual(&test, rTM, 0.9946215533891182);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03392848497041525);
    AssertAlmostEqual(&test, rTM, 0.9985302479019955);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003633065977697557);
    AssertAlmostEqual(&test, rTM, 0.9986256442642518);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.635684413481556e-06);
    AssertAlmostEqual(&test, rTM, 0.998626631861731);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.635710621653726e-08);
    AssertAlmostEqual(&test, rTM, 0.9986266417413096);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.635710883737831e-10);
    AssertAlmostEqual(&test, rTM, 0.9986266418401056);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.635710886358673e-12);
    AssertAlmostEqual(&test, rTM, 0.9986266418410936);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8438887188486108);
    AssertAlmostEqual(&test, rTM, 0.8438887188487537);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8438887188415375);
    AssertAlmostEqual(&test, rTM, 0.8438887188558269);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.843888718134211);
    AssertAlmostEqual(&test, rTM, 0.8438887195631535);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8438886474015775);
    AssertAlmostEqual(&test, rTM, 0.8438887902957569);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8438815743462461);
    AssertAlmostEqual(&test, rTM, 0.8438958630518423);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8431763385071422);
    AssertAlmostEqual(&test, rTM, 0.8445981359982312);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7868208937859522);
    AssertAlmostEqual(&test, rTM, 0.8866486798931031);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2125754584269058);
    AssertAlmostEqual(&test, rTM, 0.9781645869345263);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.003438597189167236);
    AssertAlmostEqual(&test, rTM, 0.985668467274092);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.462470613016495e-05);
    AssertAlmostEqual(&test, rTM, 0.9857650124927297);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.462711429533075e-07);
    AssertAlmostEqual(&test, rTM, 0.9857659814201707);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.462713837908502e-09);
    AssertAlmostEqual(&test, rTM, 0.985765991109795);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.462713861992278e-11);
    AssertAlmostEqual(&test, rTM, 0.9857659912066913);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5263581018717739);
    AssertAlmostEqual(&test, rTM, 0.5263581018717772);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5263581018716122);
    AssertAlmostEqual(&test, rTM, 0.5263581018719389);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5263581018554422);
    AssertAlmostEqual(&test, rTM, 0.5263581018881089);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5263581002384417);
    AssertAlmostEqual(&test, rTM, 0.5263581035051095);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5263579385384508);
    AssertAlmostEqual(&test, rTM, 0.5263582652050615);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5263417692333279);
    AssertAlmostEqual(&test, rTM, 0.5263744341217983);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5247317404513516);
    AssertAlmostEqual(&test, rTM, 0.5279806208123596);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4093170996061843);
    AssertAlmostEqual(&test, rTM, 0.62635650410697);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02221011430859486);
    AssertAlmostEqual(&test, rTM, 0.8170819737724601);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002344951988603361);
    AssertAlmostEqual(&test, rTM, 0.8242573621254532);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.346273384415583e-06);
    AssertAlmostEqual(&test, rTM, 0.824331774785903);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.346286607172227e-08);
    AssertAlmostEqual(&test, rTM, 0.8243325191921147);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.346286739400674e-10);
    AssertAlmostEqual(&test, rTM, 0.8243325266362047);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05011679517049564);
    AssertAlmostEqual(&test, rTM, 0.05011679517049565);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05011679517049519);
    AssertAlmostEqual(&test, rTM, 0.0501167951704961);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05011679517045031);
    AssertAlmostEqual(&test, rTM, 0.05011679517054098);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05011679516596233);
    AssertAlmostEqual(&test, rTM, 0.05011679517502896);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05011679471716415);
    AssertAlmostEqual(&test, rTM, 0.05011679562382714);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05011674983738693);
    AssertAlmostEqual(&test, rTM, 0.05011684050360416);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05011226226656905);
    AssertAlmostEqual(&test, rTM, 0.05012132807235754);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04966753757272638);
    AssertAlmostEqual(&test, rTM, 0.05056603248785498);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02632917159976537);
    AssertAlmostEqual(&test, rTM, 0.07384769423513443);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005493437840597969);
    AssertAlmostEqual(&test, rTM, 0.09943858292236499);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.553856090478879e-06);
    AssertAlmostEqual(&test, rTM, 0.0999769667274867);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.55446700189618e-08);
    AssertAlmostEqual(&test, rTM, 0.09998241007812662);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.554473111690759e-10);
    AssertAlmostEqual(&test, rTM, 0.09998246451765024);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006425992565485805);
    AssertAlmostEqual(&test, rTM, 0.0006425992565485805);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006425992565485805);
    AssertAlmostEqual(&test, rTM, 0.0006425992565485807);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006425992565485742);
    AssertAlmostEqual(&test, rTM, 0.0006425992565485869);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006425992565479388);
    AssertAlmostEqual(&test, rTM, 0.0006425992565492223);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006425992564844032);
    AssertAlmostEqual(&test, rTM, 0.0006425992566127579);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006425992501308415);
    AssertAlmostEqual(&test, rTM, 0.0006425992629663197);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006425986147753023);
    AssertAlmostEqual(&test, rTM, 0.0006425998983218589);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006425350855655095);
    AssertAlmostEqual(&test, rTM, 0.0006426634275316463);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006362449785488751);
    AssertAlmostEqual(&test, rTM, 0.0006489535344963937);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000321506128324097);
    AssertAlmostEqual(&test, rTM, 0.0009636922522680731);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.37047250559329e-06);
    AssertAlmostEqual(&test, rTM, 0.001278827520360043);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.433615019518011e-08);
    AssertAlmostEqual(&test, rTM, 0.001285133646351534);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.434252766398174e-10);
    AssertAlmostEqual(&test, rTM, 0.001285197338971255);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.537727680680204e-06);
    AssertAlmostEqual(&test, rTM, 6.537727680680204e-06);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.537727680680204e-06);
    AssertAlmostEqual(&test, rTM, 6.537727680680204e-06);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.537727680680203e-06);
    AssertAlmostEqual(&test, rTM, 6.537727680680204e-06);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.537727680680138e-06);
    AssertAlmostEqual(&test, rTM, 6.537727680680269e-06);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.537727680673666e-06);
    AssertAlmostEqual(&test, rTM, 6.537727680686741e-06);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.537727680026439e-06);
    AssertAlmostEqual(&test, rTM, 6.537727681333967e-06);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.537727615303782e-06);
    AssertAlmostEqual(&test, rTM, 6.537727746056625e-06);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.537721143044544e-06);
    AssertAlmostEqual(&test, rTM, 6.537734218315863e-06);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.537073981829487e-06);
    AssertAlmostEqual(&test, rTM, 6.538381379530921e-06);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.472998541632409e-06);
    AssertAlmostEqual(&test, rTM, 6.602456819727944e-06);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.268885211316644e-06);
    AssertAlmostEqual(&test, rTM, 9.806570149904047e-06);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.473081503850541e-08);
    AssertAlmostEqual(&test, rTM, 1.301072454577404e-05);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.537159440793144e-10);
    AssertAlmostEqual(&test, rTM, 1.307480164485757e-05);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.548351326289197e-08);
    AssertAlmostEqual(&test, rTM, 6.548351326289197e-08);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.548351326289197e-08);
    AssertAlmostEqual(&test, rTM, 6.548351326289197e-08);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.548351326289197e-08);
    AssertAlmostEqual(&test, rTM, 6.548351326289197e-08);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.548351326289197e-08);
    AssertAlmostEqual(&test, rTM, 6.548351326289199e-08);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.548351326289133e-08);
    AssertAlmostEqual(&test, rTM, 6.548351326289264e-08);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54835132628265e-08);
    AssertAlmostEqual(&test, rTM, 6.548351326295746e-08);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.548351325634363e-08);
    AssertAlmostEqual(&test, rTM, 6.548351326944033e-08);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.548351260805694e-08);
    AssertAlmostEqual(&test, rTM, 6.548351391772702e-08);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.548344777945278e-08);
    AssertAlmostEqual(&test, rTM, 6.548357874633118e-08);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.547696556719279e-08);
    AssertAlmostEqual(&test, rTM, 6.549006095859116e-08);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.483516173049966e-08);
    AssertAlmostEqual(&test, rTM, 6.61318647952843e-08);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.274175877549127e-08);
    AssertAlmostEqual(&test, rTM, 9.822526775029254e-08);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.483517005362487e-10);
    AssertAlmostEqual(&test, rTM, 1.303186748252472e-07);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549407946282071e-10);
    AssertAlmostEqual(&test, rTM, 6.549407946282071e-10);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549407946282071e-10);
    AssertAlmostEqual(&test, rTM, 6.549407946282071e-10);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549407946282071e-10);
    AssertAlmostEqual(&test, rTM, 6.549407946282071e-10);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549407946282071e-10);
    AssertAlmostEqual(&test, rTM, 6.549407946282071e-10);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549407946282071e-10);
    AssertAlmostEqual(&test, rTM, 6.549407946282072e-10);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549407946282006e-10);
    AssertAlmostEqual(&test, rTM, 6.549407946282137e-10);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549407946275521e-10);
    AssertAlmostEqual(&test, rTM, 6.549407946288621e-10);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549407945627131e-10);
    AssertAlmostEqual(&test, rTM, 6.549407946937012e-10);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549407880787992e-10);
    AssertAlmostEqual(&test, rTM, 6.54940801177615e-10);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549401396880682e-10);
    AssertAlmostEqual(&test, rTM, 6.549414495683459e-10);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.548753070975831e-10);
    AssertAlmostEqual(&test, rTM, 6.55006282158831e-10);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.484562323135655e-10);
    AssertAlmostEqual(&test, rTM, 6.614253569428488e-10);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.274703975285772e-10);
    AssertAlmostEqual(&test, rTM, 9.82411191727837e-10);

    userdata[0] = 0.1/CAPS_HBAR_EV; /* 0.1eV */
    userdata[1] = 0.05/CAPS_HBAR_EV; /* 0.05eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997204871061133);
    AssertAlmostEqual(&test, rTM, 0.9998602337850767);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9980153823145078);
    AssertAlmostEqual(&test, rTM, 0.9999803309762495);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9804261297568307);
    AssertAlmostEqual(&test, rTM, 0.9999980232733424);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8209009995312806);
    AssertAlmostEqual(&test, rTM, 0.9999998013638749);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1744276044896922);
    AssertAlmostEqual(&test, rTM, 0.9999999722069514);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002546188095318318);
    AssertAlmostEqual(&test, rTM, 0.9999999803629296);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559072951123736e-05);
    AssertAlmostEqual(&test, rTM, 0.999999980461675);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559202623337408e-07);
    AssertAlmostEqual(&test, rTM, 0.999999980462665);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.5592039201425e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999804626749);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559203933110558e-11);
    AssertAlmostEqual(&test, rTM, 0.999999980462675);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559203933240239e-13);
    AssertAlmostEqual(&test, rTM, 0.999999980462675);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559203933241536e-15);
    AssertAlmostEqual(&test, rTM, 0.999999980462675);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559203933241549e-17);
    AssertAlmostEqual(&test, rTM, 0.999999980462675);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993719822757097);
    AssertAlmostEqual(&test, rTM, 0.9993781983391921);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991163695685189);
    AssertAlmostEqual(&test, rTM, 0.9995580871191921);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9937375515111583);
    AssertAlmostEqual(&test, rTM, 0.9999378021266178);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9394105433616071);
    AssertAlmostEqual(&test, rTM, 0.9999937463070128);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5404553188437513);
    AssertAlmostEqual(&test, rTM, 0.9999993450827341);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02436035519029166);
    AssertAlmostEqual(&test, rTM, 0.9999997948703221);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002557893966430714);
    AssertAlmostEqual(&test, rTM, 0.9999998045267411);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559189934282854e-06);
    AssertAlmostEqual(&test, rTM, 0.9999998046257155);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559202902251516e-08);
    AssertAlmostEqual(&test, rTM, 0.9999998046267055);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559203031932032e-10);
    AssertAlmostEqual(&test, rTM, 0.9999998046267154);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559203033228837e-12);
    AssertAlmostEqual(&test, rTM, 0.9999998046267154);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559203033241805e-14);
    AssertAlmostEqual(&test, rTM, 0.9999998046267154);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559203033241935e-16);
    AssertAlmostEqual(&test, rTM, 0.9999998046267154);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9937684104566401);
    AssertAlmostEqual(&test, rTM, 0.9937684166687465);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9937681029650366);
    AssertAlmostEqual(&test, rTM, 0.9937687241449197);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9937374307648765);
    AssertAlmostEqual(&test, rTM, 0.9937992435560925);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9911986079115334);
    AssertAlmostEqual(&test, rTM, 0.995589556549874);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.939119644666793);
    AssertAlmostEqual(&test, rTM, 0.9993778857691972);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5404331211363113);
    AssertAlmostEqual(&test, rTM, 0.9999345126034156);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02435943472153494);
    AssertAlmostEqual(&test, rTM, 0.9999794866831608);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002557795046269746);
    AssertAlmostEqual(&test, rTM, 0.9999804522965331);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559090938949801e-06);
    AssertAlmostEqual(&test, rTM, 0.9999804621936853);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559103906166037e-08);
    AssertAlmostEqual(&test, rTM, 0.9999804622926821);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559104035839029e-10);
    AssertAlmostEqual(&test, rTM, 0.9999804622936721);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559104037135759e-12);
    AssertAlmostEqual(&test, rTM, 0.999980462293682);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559104037148727e-14);
    AssertAlmostEqual(&test, rTM, 0.9999804622936821);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9804233131361835);
    AssertAlmostEqual(&test, rTM, 0.9804233133300152);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9804233035415172);
    AssertAlmostEqual(&test, rTM, 0.9804233229246767);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9804223440993476);
    AssertAlmostEqual(&test, rTM, 0.9804242823193513);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9803266432624451);
    AssertAlmostEqual(&test, rTM, 0.9805195128643143);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9724275096610522);
    AssertAlmostEqual(&test, rTM, 0.986116717890011);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8200644197046066);
    AssertAlmostEqual(&test, rTM, 0.9980251551288688);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1743674541654138);
    AssertAlmostEqual(&test, rTM, 0.9997220612088143);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002545196186460466);
    AssertAlmostEqual(&test, rTM, 0.9998035914443765);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.558073518428875e-05);
    AssertAlmostEqual(&test, rTM, 0.9998045786085208);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.558203114698457e-07);
    AssertAlmostEqual(&test, rTM, 0.9998045885053632);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.558204410744037e-09);
    AssertAlmostEqual(&test, rTM, 0.9998045886043342);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.558204423704501e-11);
    AssertAlmostEqual(&test, rTM, 0.999804588605324);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.558204423834106e-13);
    AssertAlmostEqual(&test, rTM, 0.9998045886053338);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9392989363282283);
    AssertAlmostEqual(&test, rTM, 0.9392989363341083);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9392989360371629);
    AssertAlmostEqual(&test, rTM, 0.9392989366251737);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9392989069306317);
    AssertAlmostEqual(&test, rTM, 0.939298965731691);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9392959963548961);
    AssertAlmostEqual(&test, rTM, 0.93930187616951);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.939005708744943);
    AssertAlmostEqual(&test, rTM, 0.9395907981558361);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9152612745392662);
    AssertAlmostEqual(&test, rTM, 0.9566721394049894);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5382200971155761);
    AssertAlmostEqual(&test, rTM, 0.9934941879724927);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02426772910543652);
    AssertAlmostEqual(&test, rTM, 0.9979452003769135);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002547941508969059);
    AssertAlmostEqual(&test, rTM, 0.9980414760139504);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.549229933113639e-06);
    AssertAlmostEqual(&test, rTM, 0.9980424628534044);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.549242825574562e-08);
    AssertAlmostEqual(&test, rTM, 0.9980424727243284);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.549242954499994e-10);
    AssertAlmostEqual(&test, rTM, 0.9980424728230379);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.549242955789248e-12);
    AssertAlmostEqual(&test, rTM, 0.998042472824025);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8177825976395475);
    AssertAlmostEqual(&test, rTM, 0.8177825976397115);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8177825976314319);
    AssertAlmostEqual(&test, rTM, 0.8177825976478271);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8177825968198713);
    AssertAlmostEqual(&test, rTM, 0.8177825984593877);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8177825156638334);
    AssertAlmostEqual(&test, rTM, 0.8177826796153924);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.817774400305614);
    AssertAlmostEqual(&test, rTM, 0.8177907946418547);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8169653078376535);
    AssertAlmostEqual(&test, rTM, 0.818596602413426);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7527622255770283);
    AssertAlmostEqual(&test, rTM, 0.8670009502727115);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1685721770971581);
    AssertAlmostEqual(&test, rTM, 0.9721473723726332);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002450662492989409);
    AssertAlmostEqual(&test, rTM, 0.9800063983147079);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.462840777882707e-05);
    AssertAlmostEqual(&test, rTM, 0.9801022110484618);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.462963319152707e-07);
    AssertAlmostEqual(&test, rTM, 0.980103171672307);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.462964544641778e-09);
    AssertAlmostEqual(&test, rTM, 0.9801031812787963);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.462964556896676e-11);
    AssertAlmostEqual(&test, rTM, 0.9801031813748612);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4860568632231488);
    AssertAlmostEqual(&test, rTM, 0.4860568632231522);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4860568632229824);
    AssertAlmostEqual(&test, rTM, 0.4860568632233186);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4860568632063406);
    AssertAlmostEqual(&test, rTM, 0.4860568632399605);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4860568615421544);
    AssertAlmostEqual(&test, rTM, 0.4860568649041467);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.48605669512361);
    AssertAlmostEqual(&test, rTM, 0.486057031322655);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4860400540226439);
    AssertAlmostEqual(&test, rTM, 0.4860736720640308);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4843834366677116);
    AssertAlmostEqual(&test, rTM, 0.4877267330081176);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.367770329661313);
    AssertAlmostEqual(&test, rTM, 0.5888648948491695);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01758434176800727);
    AssertAlmostEqual(&test, rTM, 0.7795344095340413);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001839304935373611);
    AssertAlmostEqual(&test, rTM, 0.7862697078241864);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.840157116255926e-06);
    AssertAlmostEqual(&test, rTM, 0.7863392163114403);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.840165642669082e-08);
    AssertAlmostEqual(&test, rTM, 0.7863399116210108);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.840165727933674e-10);
    AssertAlmostEqual(&test, rTM, 0.786339918574129);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04732962144388722);
    AssertAlmostEqual(&test, rTM, 0.04732962144388723);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0473296214438868);
    AssertAlmostEqual(&test, rTM, 0.04732962144388766);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04732962144384417);
    AssertAlmostEqual(&test, rTM, 0.04732962144393028);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04732962143958203);
    AssertAlmostEqual(&test, rTM, 0.04732962144819242);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04732962101336825);
    AssertAlmostEqual(&test, rTM, 0.0473296218744062);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04732957839202814);
    AssertAlmostEqual(&test, rTM, 0.04732966449574613);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04732531664650584);
    AssertAlmostEqual(&test, rTM, 0.04733392623951051);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04690299179666509);
    AssertAlmostEqual(&test, rTM, 0.04775623382392746);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02479746872595462);
    AssertAlmostEqual(&test, rTM, 0.06981371070921477);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005157962766428424);
    AssertAlmostEqual(&test, rTM, 0.09393645122286899);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.214344860890464e-06);
    AssertAlmostEqual(&test, rTM, 0.09444250348060271);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.214914921202198e-08);
    AssertAlmostEqual(&test, rTM, 0.09444761963020155);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.214920622436173e-10);
    AssertAlmostEqual(&test, rTM, 0.09444767079732154);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006377948719834837);
    AssertAlmostEqual(&test, rTM, 0.0006377948719834837);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006377948719834836);
    AssertAlmostEqual(&test, rTM, 0.0006377948719834837);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006377948719834773);
    AssertAlmostEqual(&test, rTM, 0.00063779487198349);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006377948719828466);
    AssertAlmostEqual(&test, rTM, 0.0006377948719841207);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006377948719197855);
    AssertAlmostEqual(&test, rTM, 0.0006377948720471819);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006377948656136655);
    AssertAlmostEqual(&test, rTM, 0.0006377948783533019);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006377942350022939);
    AssertAlmostEqual(&test, rTM, 0.0006377955089646734);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006377311801619548);
    AssertAlmostEqual(&test, rTM, 0.0006378585638050073);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006314880416547107);
    AssertAlmostEqual(&test, rTM, 0.0006441017022615186);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003191008595508735);
    AssertAlmostEqual(&test, rTM, 0.0009564887548597071);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.322783564595777e-06);
    AssertAlmostEqual(&test, rTM, 0.001269266451752237);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.385452794902219e-08);
    AssertAlmostEqual(&test, rTM, 0.001275525370655795);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.386085761501295e-10);
    AssertAlmostEqual(&test, rTM, 0.001275588586472313);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.532721145291605e-06);
    AssertAlmostEqual(&test, rTM, 6.532721145291605e-06);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.532721145291605e-06);
    AssertAlmostEqual(&test, rTM, 6.532721145291605e-06);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.532721145291604e-06);
    AssertAlmostEqual(&test, rTM, 6.532721145291606e-06);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.53272114529154e-06);
    AssertAlmostEqual(&test, rTM, 6.53272114529167e-06);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.532721145285072e-06);
    AssertAlmostEqual(&test, rTM, 6.532721145298137e-06);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.532721144638341e-06);
    AssertAlmostEqual(&test, rTM, 6.532721145944868e-06);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.532721079965247e-06);
    AssertAlmostEqual(&test, rTM, 6.532721210617962e-06);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.532714612662344e-06);
    AssertAlmostEqual(&test, rTM, 6.532727677920865e-06);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.532067947031281e-06);
    AssertAlmostEqual(&test, rTM, 6.533374343551928e-06);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.468041574618169e-06);
    AssertAlmostEqual(&test, rTM, 6.597400715964986e-06);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.266381910903432e-06);
    AssertAlmostEqual(&test, rTM, 9.799060379540383e-06);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.468124409820832e-08);
    AssertAlmostEqual(&test, rTM, 1.30007610459384e-05);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.532153275156942e-10);
    AssertAlmostEqual(&test, rTM, 1.306478907469822e-05);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.547848697974119e-08);
    AssertAlmostEqual(&test, rTM, 6.547848697974119e-08);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.547848697974119e-08);
    AssertAlmostEqual(&test, rTM, 6.547848697974119e-08);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.547848697974119e-08);
    AssertAlmostEqual(&test, rTM, 6.547848697974119e-08);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.547848697974119e-08);
    AssertAlmostEqual(&test, rTM, 6.54784869797412e-08);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.547848697974054e-08);
    AssertAlmostEqual(&test, rTM, 6.547848697974185e-08);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.547848697967571e-08);
    AssertAlmostEqual(&test, rTM, 6.547848697980667e-08);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.547848697319334e-08);
    AssertAlmostEqual(&test, rTM, 6.547848698628904e-08);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.547848632495641e-08);
    AssertAlmostEqual(&test, rTM, 6.547848763452597e-08);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.547842150132826e-08);
    AssertAlmostEqual(&test, rTM, 6.547855245815412e-08);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.547193978661993e-08);
    AssertAlmostEqual(&test, rTM, 6.548503417286246e-08);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.483018521251567e-08);
    AssertAlmostEqual(&test, rTM, 6.61267887469667e-08);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.273924563358675e-08);
    AssertAlmostEqual(&test, rTM, 9.821772832589548e-08);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.483019353436323e-10);
    AssertAlmostEqual(&test, rTM, 1.303086720241382e-07);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549357663755275e-10);
    AssertAlmostEqual(&test, rTM, 6.549357663755275e-10);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549357663755275e-10);
    AssertAlmostEqual(&test, rTM, 6.549357663755275e-10);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549357663755275e-10);
    AssertAlmostEqual(&test, rTM, 6.549357663755275e-10);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549357663755275e-10);
    AssertAlmostEqual(&test, rTM, 6.549357663755275e-10);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549357663755274e-10);
    AssertAlmostEqual(&test, rTM, 6.549357663755276e-10);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54935766375521e-10);
    AssertAlmostEqual(&test, rTM, 6.54935766375534e-10);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549357663748726e-10);
    AssertAlmostEqual(&test, rTM, 6.549357663761824e-10);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549357663100339e-10);
    AssertAlmostEqual(&test, rTM, 6.549357664410211e-10);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549357598261699e-10);
    AssertAlmostEqual(&test, rTM, 6.549357729248851e-10);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549351114404169e-10);
    AssertAlmostEqual(&test, rTM, 6.549364213106381e-10);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.548702793476785e-10);
    AssertAlmostEqual(&test, rTM, 6.550012534033765e-10);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.484512538455657e-10);
    AssertAlmostEqual(&test, rTM, 6.614202789054893e-10);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.274678834022342e-10);
    AssertAlmostEqual(&test, rTM, 9.824036493488208e-10);

    userdata[0] = 0.1/CAPS_HBAR_EV; /* 0.1eV */
    userdata[1] = 0.1/CAPS_HBAR_EV; /* 0.1eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996047319640061);
    AssertAlmostEqual(&test, rTM, 0.9998023464466093);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.997194481309188);
    AssertAlmostEqual(&test, rTM, 0.9999721838999862);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9724314604174734);
    AssertAlmostEqual(&test, rTM, 0.999997204351012);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7568049430502729);
    AssertAlmostEqual(&test, rTM, 0.9999997177305816);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1029657820913208);
    AssertAlmostEqual(&test, rTM, 0.99999995195501);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001276337667570398);
    AssertAlmostEqual(&test, rTM, 0.9999999608254792);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279569245041915e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999609243515);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279601664144614e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999609253415);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279601988346011e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999609253514);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279601991588025e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999609253515);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279601991620446e-13);
    AssertAlmostEqual(&test, rTM, 0.9999999609253515);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.27960199162077e-15);
    AssertAlmostEqual(&test, rTM, 0.9999999609253515);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279601991620773e-17);
    AssertAlmostEqual(&test, rTM, 0.9999999609253515);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991119644512938);
    AssertAlmostEqual(&test, rTM, 0.9991207530153928);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9987505867536066);
    AssertAlmostEqual(&test, rTM, 0.9993750980646016);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9911550765974171);
    AssertAlmostEqual(&test, rTM, 0.999912039640264);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9154150080523017);
    AssertAlmostEqual(&test, rTM, 0.9999911516408773);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4242185814520232);
    AssertAlmostEqual(&test, rTM, 0.9999990334732441);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01247865589447036);
    AssertAlmostEqual(&test, rTM, 0.9999995993783761);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000127927439507894);
    AssertAlmostEqual(&test, rTM, 0.9999996091535965);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279598491868656e-06);
    AssertAlmostEqual(&test, rTM, 0.9999996092525837);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279601733873196e-08);
    AssertAlmostEqual(&test, rTM, 0.9999996092535737);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279601766293345e-10);
    AssertAlmostEqual(&test, rTM, 0.9999996092535836);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279601766617547e-12);
    AssertAlmostEqual(&test, rTM, 0.9999996092535837);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279601766620789e-14);
    AssertAlmostEqual(&test, rTM, 0.9999996092535837);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279601766620821e-16);
    AssertAlmostEqual(&test, rTM, 0.9999996092535837);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9911986891252023);
    AssertAlmostEqual(&test, rTM, 0.9911986978876017);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9911982553972627);
    AssertAlmostEqual(&test, rTM, 0.9911991315938329);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9911549914387835);
    AssertAlmostEqual(&test, rTM, 0.991242180597361);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9875758407078896);
    AssertAlmostEqual(&test, rTM, 0.9937684439032862);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9150151310039355);
    AssertAlmostEqual(&test, rTM, 0.9991198949066206);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4241982863740558);
    AssertAlmostEqual(&test, rTM, 0.9999033567318637);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0124784084377797);
    AssertAlmostEqual(&test, rTM, 0.9999599386519099);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001279249645567595);
    AssertAlmostEqual(&test, rTM, 0.9999609161160131);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279573742357029e-06);
    AssertAlmostEqual(&test, rTM, 0.9999609260141538);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279576984361571e-08);
    AssertAlmostEqual(&test, rTM, 0.9999609261131478);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.27957701678172e-10);
    AssertAlmostEqual(&test, rTM, 0.9999609261141378);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279577017105921e-12);
    AssertAlmostEqual(&test, rTM, 0.9999609261141477);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279577017109163e-14);
    AssertAlmostEqual(&test, rTM, 0.9999609261141478);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9724301644327139);
    AssertAlmostEqual(&test, rTM, 0.9724301647045587);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9724301509764021);
    AssertAlmostEqual(&test, rTM, 0.9724301781608639);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9724288053798036);
    AssertAlmostEqual(&test, rTM, 0.972431523691401);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9722945898271455);
    AssertAlmostEqual(&test, rTM, 0.9725650851117325);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9612354409672108);
    AssertAlmostEqual(&test, rTM, 0.9804242595326389);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.755740241385508);
    AssertAlmostEqual(&test, rTM, 0.997195251394973);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1029410539824988);
    AssertAlmostEqual(&test, rTM, 0.9995196894985152);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.00127608774168755);
    AssertAlmostEqual(&test, rTM, 0.9996083317115065);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279319318874477e-05);
    AssertAlmostEqual(&test, rTM, 0.9996093198547286);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279351737978371e-07);
    AssertAlmostEqual(&test, rTM, 0.9996093297487998);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279352062179781e-09);
    AssertAlmostEqual(&test, rTM, 0.9996093298477418);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279352065421796e-11);
    AssertAlmostEqual(&test, rTM, 0.9996093298487312);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279352065454216e-13);
    AssertAlmostEqual(&test, rTM, 0.9996093298487411);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9153401244030027);
    AssertAlmostEqual(&test, rTM, 0.9153401244110945);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9153401240024595);
    AssertAlmostEqual(&test, rTM, 0.9153401248116377);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9153400839481458);
    AssertAlmostEqual(&test, rTM, 0.9153401648659329);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9153360786259461);
    AssertAlmostEqual(&test, rTM, 0.915344170003363);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9149366326430387);
    AssertAlmostEqual(&test, rTM, 0.9157417864519123);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8824439617548144);
    AssertAlmostEqual(&test, rTM, 0.9393275245237456);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4221773770615926);
    AssertAlmostEqual(&test, rTM, 0.9904287359880045);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01245370989617476);
    AssertAlmostEqual(&test, rTM, 0.996002006110364);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001276779518682876);
    AssertAlmostEqual(&test, rTM, 0.9960991751269493);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.277103616663249e-06);
    AssertAlmostEqual(&test, rTM, 0.9961001592148206);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.277106858680112e-08);
    AssertAlmostEqual(&test, rTM, 0.9961001690569705);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.277106891100385e-10);
    AssertAlmostEqual(&test, rTM, 0.9961001691553922);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.277106891424587e-12);
    AssertAlmostEqual(&test, rTM, 0.9961001691563764);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7547710571430476);
    AssertAlmostEqual(&test, rTM, 0.7547710571432585);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7547710571326052);
    AssertAlmostEqual(&test, rTM, 0.754771057153701);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7547710560883619);
    AssertAlmostEqual(&test, rTM, 0.7547710581979443);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7547709516640665);
    AssertAlmostEqual(&test, rTM, 0.7547711626222007);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7547605095735995);
    AssertAlmostEqual(&test, rTM, 0.7547816043224577);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7537196740938393);
    AssertAlmostEqual(&test, rTM, 0.7558185767346892);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6726128163531534);
    AssertAlmostEqual(&test, rTM, 0.8185482727055381);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1005353155080313);
    AssertAlmostEqual(&test, rTM, 0.9533236799911833);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001251815614916913);
    AssertAlmostEqual(&test, rTM, 0.9615940097706075);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.255048331326727e-05);
    AssertAlmostEqual(&test, rTM, 0.961687261115361);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.255080762329502e-07);
    AssertAlmostEqual(&test, rTM, 0.9616881949356684);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.255081086649951e-09);
    AssertAlmostEqual(&test, rTM, 0.9616882042740025);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.255081089893157e-11);
    AssertAlmostEqual(&test, rTM, 0.9616882043673859);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3936136762641852);
    AssertAlmostEqual(&test, rTM, 0.3936136762641886);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3936136762640157);
    AssertAlmostEqual(&test, rTM, 0.3936136762643582);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3936136762470601);
    AssertAlmostEqual(&test, rTM, 0.3936136762813138);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3936136745515032);
    AssertAlmostEqual(&test, rTM, 0.3936136779768706);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3936135049958998);
    AssertAlmostEqual(&test, rTM, 0.3936138475324467);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3935965503084503);
    AssertAlmostEqual(&test, rTM, 0.3936308019467045);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3919097588691506);
    AssertAlmostEqual(&test, rTM, 0.3953148933304416);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2785683498097004);
    AssertAlmostEqual(&test, rTM, 0.4975229409696487);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01037975617409794);
    AssertAlmostEqual(&test, rTM, 0.6760255903920929);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001070126212079404);
    AssertAlmostEqual(&test, rTM, 0.6815651174078168);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.070458956169508e-06);
    AssertAlmostEqual(&test, rTM, 0.6816218420546331);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.070462284776776e-08);
    AssertAlmostEqual(&test, rTM, 0.6816224094378597);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.070462318062965e-10);
    AssertAlmostEqual(&test, rTM, 0.6816224151117056);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03993086986313606);
    AssertAlmostEqual(&test, rTM, 0.03993086986313607);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0399308698631357);
    AssertAlmostEqual(&test, rTM, 0.03993086986313643);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0399308698630992);
    AssertAlmostEqual(&test, rTM, 0.03993086986317293);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03993086985944963);
    AssertAlmostEqual(&test, rTM, 0.0399308698668225);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03993086949449238);
    AssertAlmostEqual(&test, rTM, 0.03993087023177976);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03993083299880099);
    AssertAlmostEqual(&test, rTM, 0.03993090672747104);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0399271837670649);
    AssertAlmostEqual(&test, rTM, 0.03993455595812039);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03956560366247852);
    AssertAlmostEqual(&test, rTM, 0.0402961253919838);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02077030683011267);
    AssertAlmostEqual(&test, rTM, 0.05906211159647558);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004285584522992943);
    AssertAlmostEqual(&test, rTM, 0.07930875654482061);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.331682034772542e-06);
    AssertAlmostEqual(&test, rTM, 0.0797303007980583);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.332148026412515e-08);
    AssertAlmostEqual(&test, rTM, 0.07973456189638721);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.332152686836036e-10);
    AssertAlmostEqual(&test, rTM, 0.07973460451198561);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006222864841845836);
    AssertAlmostEqual(&test, rTM, 0.0006222864841845836);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006222864841845836);
    AssertAlmostEqual(&test, rTM, 0.0006222864841845837);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006222864841845774);
    AssertAlmostEqual(&test, rTM, 0.0006222864841845899);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006222864841839621);
    AssertAlmostEqual(&test, rTM, 0.0006222864841852052);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006222864841224324);
    AssertAlmostEqual(&test, rTM, 0.0006222864842467348);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006222864779694588);
    AssertAlmostEqual(&test, rTM, 0.0006222864903997085);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006222858626727195);
    AssertAlmostEqual(&test, rTM, 0.0006222871056964478);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006222243391428709);
    AssertAlmostEqual(&test, rTM, 0.0006223486292262915);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006161328194671335);
    AssertAlmostEqual(&test, rTM, 0.0006284401488549047);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003113368924295547);
    AssertAlmostEqual(&test, rTM, 0.0009332359556022896);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.168851500186562e-06);
    AssertAlmostEqual(&test, rTM, 0.001238403644428095);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.229993110806915e-08);
    AssertAlmostEqual(&test, rTM, 0.001244510186585722);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.23061064807722e-10);
    AssertAlmostEqual(&test, rTM, 0.001244571863360235);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.516087932437252e-06);
    AssertAlmostEqual(&test, rTM, 6.516087932437252e-06);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.516087932437252e-06);
    AssertAlmostEqual(&test, rTM, 6.516087932437252e-06);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.516087932437251e-06);
    AssertAlmostEqual(&test, rTM, 6.516087932437253e-06);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.516087932437187e-06);
    AssertAlmostEqual(&test, rTM, 6.516087932437317e-06);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.516087932430736e-06);
    AssertAlmostEqual(&test, rTM, 6.516087932443768e-06);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.516087931785652e-06);
    AssertAlmostEqual(&test, rTM, 6.516087933088852e-06);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.516087867277222e-06);
    AssertAlmostEqual(&test, rTM, 6.516087997597282e-06);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.516081416440754e-06);
    AssertAlmostEqual(&test, rTM, 6.516094448433751e-06);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.5154363972885e-06);
    AssertAlmostEqual(&test, rTM, 6.516739467586005e-06);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.451573042784303e-06);
    AssertAlmostEqual(&test, rTM, 6.580602822090148e-06);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.258065195954181e-06);
    AssertAlmostEqual(&test, rTM, 9.77411066878199e-06);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.451655456702116e-08);
    AssertAlmostEqual(&test, rTM, 1.296765930976505e-05);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.515521291450756e-10);
    AssertAlmostEqual(&test, rTM, 1.303152431219213e-05);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546173827380935e-08);
    AssertAlmostEqual(&test, rTM, 6.546173827380935e-08);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546173827380935e-08);
    AssertAlmostEqual(&test, rTM, 6.546173827380935e-08);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546173827380935e-08);
    AssertAlmostEqual(&test, rTM, 6.546173827380935e-08);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546173827380935e-08);
    AssertAlmostEqual(&test, rTM, 6.546173827380937e-08);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54617382738087e-08);
    AssertAlmostEqual(&test, rTM, 6.546173827381001e-08);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546173827374389e-08);
    AssertAlmostEqual(&test, rTM, 6.546173827387481e-08);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546173826726318e-08);
    AssertAlmostEqual(&test, rTM, 6.546173828035553e-08);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546173761919206e-08);
    AssertAlmostEqual(&test, rTM, 6.546173892842664e-08);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546167281214511e-08);
    AssertAlmostEqual(&test, rTM, 6.546180373547359e-08);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.545519275539078e-08);
    AssertAlmostEqual(&test, rTM, 6.546828379222793e-08);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.481360233531244e-08);
    AssertAlmostEqual(&test, rTM, 6.610987421230626e-08);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.27308712795243e-08);
    AssertAlmostEqual(&test, rTM, 9.819260526809427e-08);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.481361065290326e-10);
    AssertAlmostEqual(&test, rTM, 1.302753404410891e-07);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54919006090861e-10);
    AssertAlmostEqual(&test, rTM, 6.54919006090861e-10);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54919006090861e-10);
    AssertAlmostEqual(&test, rTM, 6.54919006090861e-10);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54919006090861e-10);
    AssertAlmostEqual(&test, rTM, 6.54919006090861e-10);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54919006090861e-10);
    AssertAlmostEqual(&test, rTM, 6.54919006090861e-10);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549190060908609e-10);
    AssertAlmostEqual(&test, rTM, 6.54919006090861e-10);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549190060908544e-10);
    AssertAlmostEqual(&test, rTM, 6.549190060908676e-10);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549190060902061e-10);
    AssertAlmostEqual(&test, rTM, 6.54919006091516e-10);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549190060253691e-10);
    AssertAlmostEqual(&test, rTM, 6.549190061563529e-10);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549189995416711e-10);
    AssertAlmostEqual(&test, rTM, 6.54919012640051e-10);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549183511725107e-10);
    AssertAlmostEqual(&test, rTM, 6.549196610092113e-10);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.548535207388729e-10);
    AssertAlmostEqual(&test, rTM, 6.549844914428491e-10);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.484346595043113e-10);
    AssertAlmostEqual(&test, rTM, 6.614033526774107e-10);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.274595032598899e-10);
    AssertAlmostEqual(&test, rTM, 9.823785089218322e-10);

    userdata[0] = 0.1/CAPS_HBAR_EV; /* 0.1eV */
    userdata[1] = 0.5/CAPS_HBAR_EV; /* 0.5eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991163697393547);
    AssertAlmostEqual(&test, rTM, 0.9995580872046478);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.993737552718633);
    AssertAlmostEqual(&test, rTM, 0.9999378021386477);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9394105547146661);
    AssertAlmostEqual(&test, rTM, 0.9999937463082236);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5404553812127278);
    AssertAlmostEqual(&test, rTM, 0.9999993450828721);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02436036416562459);
    AssertAlmostEqual(&test, rTM, 0.9999997948703977);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000255789495541785);
    AssertAlmostEqual(&test, rTM, 0.9999998045268167);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559190924272328e-06);
    AssertAlmostEqual(&test, rTM, 0.9999998046257911);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559203892251024e-08);
    AssertAlmostEqual(&test, rTM, 0.9999998046267811);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.55920402193164e-10);
    AssertAlmostEqual(&test, rTM, 0.9999998046267909);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559204023228446e-12);
    AssertAlmostEqual(&test, rTM, 0.9999998046267911);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559204023241414e-14);
    AssertAlmostEqual(&test, rTM, 0.9999998046267911);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559204023241544e-16);
    AssertAlmostEqual(&test, rTM, 0.9999998046267911);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559204023241545e-18);
    AssertAlmostEqual(&test, rTM, 0.9999998046267911);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9980153823145078);
    AssertAlmostEqual(&test, rTM, 0.9980350126696997);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9972083850761646);
    AssertAlmostEqual(&test, rTM, 0.9986032163550015);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9803304472377647);
    AssertAlmostEqual(&test, rTM, 0.9998033177563155);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8208930063547265);
    AssertAlmostEqual(&test, rTM, 0.9999801375756497);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1744274831007835);
    AssertAlmostEqual(&test, rTM, 0.9999972207023463);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002546188070239096);
    AssertAlmostEqual(&test, rTM, 0.9999980362967686);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559072950870401e-05);
    AssertAlmostEqual(&test, rTM, 0.9999980461712803);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559202623334874e-07);
    AssertAlmostEqual(&test, rTM, 0.9999980462702774);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559203920142475e-09);
    AssertAlmostEqual(&test, rTM, 0.9999980462712674);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559203933110558e-11);
    AssertAlmostEqual(&test, rTM, 0.9999980462712773);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.55920393324024e-13);
    AssertAlmostEqual(&test, rTM, 0.9999980462712774);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559203933241536e-15);
    AssertAlmostEqual(&test, rTM, 0.9999980462712774);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559203933241549e-17);
    AssertAlmostEqual(&test, rTM, 0.9999980462712774);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9804270515317117);
    AssertAlmostEqual(&test, rTM, 0.9804270709111976);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.980426092271377);
    AssertAlmostEqual(&test, rTM, 0.980428030124046);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.980330409570928);
    AssertAlmostEqual(&test, rTM, 0.9805232426198707);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9724327666367343);
    AssertAlmostEqual(&test, rTM, 0.9861193837670026);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8200957734609057);
    AssertAlmostEqual(&test, rTM, 0.9980255402660578);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1744148707892813);
    AssertAlmostEqual(&test, rTM, 0.9997221414873364);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002546175762748544);
    AssertAlmostEqual(&test, rTM, 0.9998036669937104);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559063026589387e-05);
    AssertAlmostEqual(&test, rTM, 0.9998046541569874);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559192723130719e-07);
    AssertAlmostEqual(&test, rTM, 0.9998046640538308);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559194020179113e-09);
    AssertAlmostEqual(&test, rTM, 0.9998046641528019);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559194033149605e-11);
    AssertAlmostEqual(&test, rTM, 0.9998046641537915);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.55919403327931e-13);
    AssertAlmostEqual(&test, rTM, 0.9998046641538014);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559194033280607e-15);
    AssertAlmostEqual(&test, rTM, 0.9998046641538015);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9394123424403014);
    AssertAlmostEqual(&test, rTM, 0.9394123430272502);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9394123133863407);
    AssertAlmostEqual(&test, rTM, 0.9394123720811971);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9394094080675028);
    AssertAlmostEqual(&test, rTM, 0.9394152772623503);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.939119644666793);
    AssertAlmostEqual(&test, rTM, 0.9397036773361594);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9154174786430216);
    AssertAlmostEqual(&test, rTM, 0.9567538913712645);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5388437188402203);
    AssertAlmostEqual(&test, rTM, 0.9935077933473594);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02435713805220405);
    AssertAlmostEqual(&test, rTM, 0.997952736485924);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002557792515350227);
    AssertAlmostEqual(&test, rTM, 0.9980490042998739);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559090913614931e-06);
    AssertAlmostEqual(&test, rTM, 0.9980499911495077);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559103905912686e-08);
    AssertAlmostEqual(&test, rTM, 0.9980500010205434);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559104035836496e-10);
    AssertAlmostEqual(&test, rTM, 0.998050001119254);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559104037135734e-12);
    AssertAlmostEqual(&test, rTM, 0.9980500011202411);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559104037148727e-14);
    AssertAlmostEqual(&test, rTM, 0.998050001120251);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8208695376340974);
    AssertAlmostEqual(&test, rTM, 0.8208695376502483);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8208695368346315);
    AssertAlmostEqual(&test, rTM, 0.8208695384497142);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8208694568880648);
    AssertAlmostEqual(&test, rTM, 0.8208696183962482);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8208614624724764);
    AssertAlmostEqual(&test, rTM, 0.8208776124836671);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8200644197046066);
    AssertAlmostEqual(&test, rTM, 0.8216714060652931);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7567641186016318);
    AssertAlmostEqual(&test, rTM, 0.8693364316377994);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1731625997560477);
    AssertAlmostEqual(&test, rTM, 0.9729089171065232);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002544945516371545);
    AssertAlmostEqual(&test, rTM, 0.9807328423067638);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.558070986068188e-05);
    AssertAlmostEqual(&test, rTM, 0.9808287520877824);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.558203089372259e-07);
    AssertAlmostEqual(&test, rTM, 0.9808297137755392);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.558204410490775e-09);
    AssertAlmostEqual(&test, rTM, 0.980829723392677);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.558204423701968e-11);
    AssertAlmostEqual(&test, rTM, 0.9808297234888484);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.55820442383408e-13);
    AssertAlmostEqual(&test, rTM, 0.9808297234898101);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5398265885622043);
    AssertAlmostEqual(&test, rTM, 0.539826588562527);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.539826588546233);
    AssertAlmostEqual(&test, rTM, 0.5398265885784982);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.539826586949107);
    AssertAlmostEqual(&test, rTM, 0.5398265901756242);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5398264272365774);
    AssertAlmostEqual(&test, rTM, 0.5398267498881142);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5398104566570995);
    AssertAlmostEqual(&test, rTM, 0.5398427200711241);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5382200971155761);
    AssertAlmostEqual(&test, rTM, 0.5414291573008476);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4235499341315477);
    AssertAlmostEqual(&test, rTM, 0.6386032524999032);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02404102492207204);
    AssertAlmostEqual(&test, rTM, 0.828638567796903);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002547689416465182);
    AssertAlmostEqual(&test, rTM, 0.8359481556132771);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.549227409391395e-06);
    AssertAlmostEqual(&test, rTM, 0.8360241058273101);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.549242800337059e-08);
    AssertAlmostEqual(&test, rTM, 0.8360248656306845);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.549242954247618e-10);
    AssertAlmostEqual(&test, rTM, 0.8360248732287483);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.549242955786724e-12);
    AssertAlmostEqual(&test, rTM, 0.836024873304729);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.169768351520696);
    AssertAlmostEqual(&test, rTM, 0.1697683515206984);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1697683515205767);
    AssertAlmostEqual(&test, rTM, 0.1697683515208177);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1697683515086481);
    AssertAlmostEqual(&test, rTM, 0.1697683515327464);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1697683503157829);
    AssertAlmostEqual(&test, rTM, 0.1697683527256115);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1697682310293579);
    AssertAlmostEqual(&test, rTM, 0.1697684720120314);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.169756303258451);
    AssertAlmostEqual(&test, rTM, 0.1697803997321937);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1685721770971581);
    AssertAlmostEqual(&test, rTM, 0.1709640259154392);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.09979541861626359);
    AssertAlmostEqual(&test, rTM, 0.2380703813305414);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002426757452085648);
    AssertAlmostEqual(&test, rTM, 0.3278607801394779);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.462596993032555e-05);
    AssertAlmostEqual(&test, rTM, 0.3300030130251303);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.462960880822661e-07);
    AssertAlmostEqual(&test, rTM, 0.3300247375292281);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.46296452025843e-09);
    AssertAlmostEqual(&test, rTM, 0.3300249548049259);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.462964556652843e-11);
    AssertAlmostEqual(&test, rTM, 0.330024956977686);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01775404972875787);
    AssertAlmostEqual(&test, rTM, 0.01775404972875787);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0177540497287577);
    AssertAlmostEqual(&test, rTM, 0.01775404972875804);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01775404972874074);
    AssertAlmostEqual(&test, rTM, 0.017754049728775);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01775404972704441);
    AssertAlmostEqual(&test, rTM, 0.01775404973047133);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01775404955741153);
    AssertAlmostEqual(&test, rTM, 0.01775404990010421);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01775403259414012);
    AssertAlmostEqual(&test, rTM, 0.01775406686337562);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01775233643073258);
    AssertAlmostEqual(&test, rTM, 0.0177557630266789);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01758434176800727);
    AssertAlmostEqual(&test, rTM, 0.01792375666653081);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.009035315001121263);
    AssertAlmostEqual(&test, rTM, 0.02647008524563086);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001821282670736535);
    AssertAlmostEqual(&test, rTM, 0.0353150106524544);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.839974959587479e-06);
    AssertAlmostEqual(&test, rTM, 0.03549507295165379);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.840163820906985e-08);
    AssertAlmostEqual(&test, rTM, 0.03549689222985693);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.840165709716034e-10);
    AssertAlmostEqual(&test, rTM, 0.03549691042452383);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005209488681238681);
    AssertAlmostEqual(&test, rTM, 0.0005209488681238681);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000520948868123868);
    AssertAlmostEqual(&test, rTM, 0.0005209488681238681);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005209488681238629);
    AssertAlmostEqual(&test, rTM, 0.0005209488681238733);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005209488681233476);
    AssertAlmostEqual(&test, rTM, 0.0005209488681243884);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005209488680718273);
    AssertAlmostEqual(&test, rTM, 0.0005209488681759087);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005209488629198043);
    AssertAlmostEqual(&test, rTM, 0.0005209488733279317);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005209483477180126);
    AssertAlmostEqual(&test, rTM, 0.0005209493885297234);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005208968326844658);
    AssertAlmostEqual(&test, rTM, 0.0005210009035632675);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005157962766428425);
    AssertAlmostEqual(&test, rTM, 0.0005261014595772319);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002606101455867158);
    AssertAlmostEqual(&test, rTM, 0.0007812875200450982);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.163234483610806e-06);
    AssertAlmostEqual(&test, rTM, 0.001036734224583122);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.214398696301331e-08);
    AssertAlmostEqual(&test, rTM, 0.001041845309559198);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.214915459669925e-10);
    AssertAlmostEqual(&test, rTM, 0.001041896931998578);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.38601059269961e-06);
    AssertAlmostEqual(&test, rTM, 6.38601059269961e-06);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.38601059269961e-06);
    AssertAlmostEqual(&test, rTM, 6.38601059269961e-06);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.38601059269961e-06);
    AssertAlmostEqual(&test, rTM, 6.386010592699611e-06);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.386010592699547e-06);
    AssertAlmostEqual(&test, rTM, 6.386010592699674e-06);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.386010592693224e-06);
    AssertAlmostEqual(&test, rTM, 6.386010592705997e-06);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.386010592061018e-06);
    AssertAlmostEqual(&test, rTM, 6.386010593338203e-06);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.386010528840321e-06);
    AssertAlmostEqual(&test, rTM, 6.3860106565589e-06);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.386004206776965e-06);
    AssertAlmostEqual(&test, rTM, 6.386016978622256e-06);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.385372063648604e-06);
    AssertAlmostEqual(&test, rTM, 6.386649121750617e-06);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.322783564595777e-06);
    AssertAlmostEqual(&test, rTM, 6.449237620803392e-06);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.193025686948003e-06);
    AssertAlmostEqual(&test, rTM, 9.578995498321005e-06);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.322862720966166e-08);
    AssertAlmostEqual(&test, rTM, 1.270879255767896e-05);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.385453602227641e-10);
    AssertAlmostEqual(&test, rTM, 1.277138263951824e-05);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.532805645468042e-08);
    AssertAlmostEqual(&test, rTM, 6.532805645468042e-08);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.532805645468042e-08);
    AssertAlmostEqual(&test, rTM, 6.532805645468042e-08);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.532805645468042e-08);
    AssertAlmostEqual(&test, rTM, 6.532805645468042e-08);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.532805645468041e-08);
    AssertAlmostEqual(&test, rTM, 6.532805645468042e-08);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.532805645467976e-08);
    AssertAlmostEqual(&test, rTM, 6.532805645468107e-08);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.53280564546151e-08);
    AssertAlmostEqual(&test, rTM, 6.532805645474575e-08);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.532805644814762e-08);
    AssertAlmostEqual(&test, rTM, 6.532805646121323e-08);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.532805580139995e-08);
    AssertAlmostEqual(&test, rTM, 6.53280571079609e-08);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.532799112669783e-08);
    AssertAlmostEqual(&test, rTM, 6.532812178266301e-08);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.532152430310358e-08);
    AssertAlmostEqual(&test, rTM, 6.533458860625726e-08);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.468124409820833e-08);
    AssertAlmostEqual(&test, rTM, 6.59748688111525e-08);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.266403036121772e-08);
    AssertAlmostEqual(&test, rTM, 9.799208254814297e-08);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.468125238186251e-10);
    AssertAlmostEqual(&test, rTM, 1.300093003855417e-07);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.547849546885787e-10);
    AssertAlmostEqual(&test, rTM, 6.547849546885787e-10);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.547849546885787e-10);
    AssertAlmostEqual(&test, rTM, 6.547849546885787e-10);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.547849546885787e-10);
    AssertAlmostEqual(&test, rTM, 6.547849546885787e-10);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.547849546885787e-10);
    AssertAlmostEqual(&test, rTM, 6.547849546885787e-10);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.547849546885787e-10);
    AssertAlmostEqual(&test, rTM, 6.547849546885788e-10);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.547849546885722e-10);
    AssertAlmostEqual(&test, rTM, 6.547849546885854e-10);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54784954687924e-10);
    AssertAlmostEqual(&test, rTM, 6.547849546892336e-10);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.547849546231003e-10);
    AssertAlmostEqual(&test, rTM, 6.547849547540573e-10);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.547849481407293e-10);
    AssertAlmostEqual(&test, rTM, 6.547849612364283e-10);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.547842999042797e-10);
    AssertAlmostEqual(&test, rTM, 6.547856094728779e-10);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.547194827403905e-10);
    AssertAlmostEqual(&test, rTM, 6.548504266367671e-10);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.483019353436324e-10);
    AssertAlmostEqual(&test, rTM, 6.612679740335252e-10);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.27392477558661e-10);
    AssertAlmostEqual(&test, rTM, 9.821774318184965e-10);

    userdata[0] = 0.1/CAPS_HBAR_EV; /* 0.1eV */
    userdata[1] = 1/CAPS_HBAR_EV; /* 1eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9987505868743615);
    AssertAlmostEqual(&test, rTM, 0.9993750981250168);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9911550774490077);
    AssertAlmostEqual(&test, rTM, 0.9999120396487704);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9154150158712561);
    AssertAlmostEqual(&test, rTM, 0.9999911516417346);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4242186146239676);
    AssertAlmostEqual(&test, rTM, 0.9999990334733529);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01247865824859096);
    AssertAlmostEqual(&test, rTM, 0.9999995993784517);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001279274642452271);
    AssertAlmostEqual(&test, rTM, 0.9999996091536721);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.27959873936734e-06);
    AssertAlmostEqual(&test, rTM, 0.9999996092526593);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279601981373135e-08);
    AssertAlmostEqual(&test, rTM, 0.9999996092536493);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279602013793296e-10);
    AssertAlmostEqual(&test, rTM, 0.9999996092536592);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279602014117498e-12);
    AssertAlmostEqual(&test, rTM, 0.9999996092536593);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.27960201412074e-14);
    AssertAlmostEqual(&test, rTM, 0.9999996092536593);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279602014120772e-16);
    AssertAlmostEqual(&test, rTM, 0.9999996092536593);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279602014120773e-18);
    AssertAlmostEqual(&test, rTM, 0.9999996092536593);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.997194481309188);
    AssertAlmostEqual(&test, rTM, 0.9972222200880044);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960543454303076);
    AssertAlmostEqual(&test, rTM, 0.9980252209155606);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9722972576027546);
    AssertAlmostEqual(&test, rTM, 0.9997218471901919);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7567945716835978);
    AssertAlmostEqual(&test, rTM, 0.999971774877456);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.102965699187465);
    AssertAlmostEqual(&test, rTM, 0.9999951955225215);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.00127633765496687);
    AssertAlmostEqual(&test, rTM, 0.9999960825630874);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279569244915241e-05);
    AssertAlmostEqual(&test, rTM, 0.9999960924502671);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279601664143347e-07);
    AssertAlmostEqual(&test, rTM, 0.9999960925492652);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279601988345998e-09);
    AssertAlmostEqual(&test, rTM, 0.9999960925502552);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279601991588025e-11);
    AssertAlmostEqual(&test, rTM, 0.9999960925502651);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279601991620446e-13);
    AssertAlmostEqual(&test, rTM, 0.9999960925502652);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.27960199162077e-15);
    AssertAlmostEqual(&test, rTM, 0.9999960925502652);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279601991620773e-17);
    AssertAlmostEqual(&test, rTM, 0.9999960925502652);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9724327795988127);
    AssertAlmostEqual(&test, rTM, 0.9724328067807199);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.972431434128665);
    AssertAlmostEqual(&test, rTM, 0.9724341521848122);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9722972311878215);
    AssertAlmostEqual(&test, rTM, 0.9725677010530073);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9612391152465642);
    AssertAlmostEqual(&test, rTM, 0.980426133893757);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7557605746402125);
    AssertAlmostEqual(&test, rTM, 0.9971955273565227);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1029572475218357);
    AssertAlmostEqual(&test, rTM, 0.999519766625418);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001276333932230089);
    AssertAlmostEqual(&test, rTM, 0.9996084072306013);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279566757379413e-05);
    AssertAlmostEqual(&test, rTM, 0.9996093953736892);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279599189022817e-07);
    AssertAlmostEqual(&test, rTM, 0.9996094052677615);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279599513349627e-09);
    AssertAlmostEqual(&test, rTM, 0.9996094053667035);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279599516592897e-11);
    AssertAlmostEqual(&test, rTM, 0.9996094053676929);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279599516625329e-13);
    AssertAlmostEqual(&test, rTM, 0.9996094053677028);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279599516625654e-15);
    AssertAlmostEqual(&test, rTM, 0.9996094053677029);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9154182679836648);
    AssertAlmostEqual(&test, rTM, 0.9154182687921322);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.915418227964539);
    AssertAlmostEqual(&test, rTM, 0.9154183088112394);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9154142261610254);
    AssertAlmostEqual(&test, rTM, 0.9154223104301292);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9150151310039355);
    AssertAlmostEqual(&test, rTM, 0.915819577497098);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8825504004136472);
    AssertAlmostEqual(&test, rTM, 0.9393843384327727);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.422508815692245);
    AssertAlmostEqual(&test, rTM, 0.9904394150572405);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0124772036436392);
    AssertAlmostEqual(&test, rTM, 0.996009506360603);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001279248379435693);
    AssertAlmostEqual(&test, rTM, 0.9961066741387614);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279573729689282e-06);
    AssertAlmostEqual(&test, rTM, 0.9961076582374929);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279576984234893e-08);
    AssertAlmostEqual(&test, rTM, 0.9961076680797539);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279577016780453e-10);
    AssertAlmostEqual(&test, rTM, 0.9961076681781766);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279577017105909e-12);
    AssertAlmostEqual(&test, rTM, 0.9961076681791609);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279577017109163e-14);
    AssertAlmostEqual(&test, rTM, 0.9961076681791707);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7567845829259292);
    AssertAlmostEqual(&test, rTM, 0.7567845829468836);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7567845818886872);
    AssertAlmostEqual(&test, rTM, 0.7567845839841255);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7567844781645293);
    AssertAlmostEqual(&test, rTM, 0.7567846877082446);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7567741060847643);
    AssertAlmostEqual(&test, rTM, 0.7567950593992379);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.755740241385508);
    AssertAlmostEqual(&test, rTM, 0.7578250752552347);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6751275546991901);
    AssertAlmostEqual(&test, rTM, 0.8201210077178055);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1021189445744698);
    AssertAlmostEqual(&test, rTM, 0.954028804377525);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001275961743581429);
    AssertAlmostEqual(&test, rTM, 0.9622933970539029);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279318052382023e-05);
    AssertAlmostEqual(&test, rTM, 0.9623867472178201);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279351725312793e-07);
    AssertAlmostEqual(&test, rTM, 0.9623876820503336);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279352062053125e-09);
    AssertAlmostEqual(&test, rTM, 0.9623876913987922);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279352065420529e-11);
    AssertAlmostEqual(&test, rTM, 0.9623876914922769);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279352065454203e-13);
    AssertAlmostEqual(&test, rTM, 0.9623876914932117);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4238840386574584);
    AssertAlmostEqual(&test, rTM, 0.4238840386578014);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4238840386404792);
    AssertAlmostEqual(&test, rTM, 0.4238840386747806);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4238840369425579);
    AssertAlmostEqual(&test, rTM, 0.4238840403727019);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4238838671505174);
    AssertAlmostEqual(&test, rTM, 0.423884210164712);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4238668887838007);
    AssertAlmostEqual(&test, rTM, 0.4239011882275059);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4221773770615926);
    AssertAlmostEqual(&test, rTM, 0.4255876954088754);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3068221115102545);
    AssertAlmostEqual(&test, rTM, 0.5283123814249409);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01233461340918023);
    AssertAlmostEqual(&test, rTM, 0.7126260657185532);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001276653162416125);
    AssertAlmostEqual(&test, rTM, 0.7185820852521932);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.277102352335162e-06);
    AssertAlmostEqual(&test, rTM, 0.7186432060700054);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.277106846036755e-08);
    AssertAlmostEqual(&test, rTM, 0.7186438174392981);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.277106890973951e-10);
    AssertAlmostEqual(&test, rTM, 0.7186438235530072);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.277106891423323e-12);
    AssertAlmostEqual(&test, rTM, 0.7186438236141443);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1013555584664559);
    AssertAlmostEqual(&test, rTM, 0.1013555584664576);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.101355558466374);
    AssertAlmostEqual(&test, rTM, 0.1013555584665394);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1013555584581867);
    AssertAlmostEqual(&test, rTM, 0.1013555584747268);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1013555576394522);
    AssertAlmostEqual(&test, rTM, 0.1013555592934613);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1013554757660668);
    AssertAlmostEqual(&test, rTM, 0.1013556411668453);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1013472891023817);
    AssertAlmostEqual(&test, rTM, 0.101363827816526);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1005353155080313);
    AssertAlmostEqual(&test, rTM, 0.1021756636486851);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05593061778999867);
    AssertAlmostEqual(&test, rTM, 0.146361774046572);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001239575725063476);
    AssertAlmostEqual(&test, rTM, 0.1994598852723253);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.254924097083792e-05);
    AssertAlmostEqual(&test, rTM, 0.2006378071638336);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.255079519801102e-07);
    AssertAlmostEqual(&test, rTM, 0.2006497307431778);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.255081074224649e-09);
    AssertAlmostEqual(&test, rTM, 0.2006498499935861);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.255081089768904e-11);
    AssertAlmostEqual(&test, rTM, 0.2006498511860916);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01048140030973247);
    AssertAlmostEqual(&test, rTM, 0.01048140030973247);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01048140030973237);
    AssertAlmostEqual(&test, rTM, 0.01048140030973257);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0104814003097222);
    AssertAlmostEqual(&test, rTM, 0.01048140030974273);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01048140030870607);
    AssertAlmostEqual(&test, rTM, 0.01048140031075886);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01048140020709287);
    AssertAlmostEqual(&test, rTM, 0.01048140041237207);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01048139004578264);
    AssertAlmostEqual(&test, rTM, 0.0104814105736823);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01048037401425547);
    AssertAlmostEqual(&test, rTM, 0.01048242660518738);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01037975617409794);
    AssertAlmostEqual(&test, rTM, 0.01058304422876585);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.005295772450129484);
    AssertAlmostEqual(&test, rTM, 0.01566646446354114);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001059639078888816);
    AssertAlmostEqual(&test, rTM, 0.02085458031566135);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.070352991556171e-06);
    AssertAlmostEqual(&test, rTM, 0.02095942802158985);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.070461225020197e-08);
    AssertAlmostEqual(&test, rTM, 0.02096048720444461);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.070462307465389e-10);
    AssertAlmostEqual(&test, rTM, 0.02096049779735468);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004328403284718463);
    AssertAlmostEqual(&test, rTM, 0.0004328403284718463);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004328403284718463);
    AssertAlmostEqual(&test, rTM, 0.0004328403284718464);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000432840328471842);
    AssertAlmostEqual(&test, rTM, 0.0004328403284718507);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004328403284714139);
    AssertAlmostEqual(&test, rTM, 0.0004328403284722788);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004328403284285998);
    AssertAlmostEqual(&test, rTM, 0.0004328403285150929);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004328403241471885);
    AssertAlmostEqual(&test, rTM, 0.0004328403327965042);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004328398960064893);
    AssertAlmostEqual(&test, rTM, 0.0004328407609372033);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004327970862134224);
    AssertAlmostEqual(&test, rTM, 0.0004328835707302686);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004285584522992944);
    AssertAlmostEqual(&test, rTM, 0.0004371222046285265);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002165138497431305);
    AssertAlmostEqual(&test, rTM, 0.0006491667666891786);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.289223337474808e-06);
    AssertAlmostEqual(&test, rTM, 0.0008613912746187573);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.33171918667903e-08);
    AssertAlmostEqual(&test, rTM, 0.0008656371775983963);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.332148398009169e-10);
    AssertAlmostEqual(&test, rTM, 0.0008656800615432876);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.230539246487766e-06);
    AssertAlmostEqual(&test, rTM, 6.230539246487766e-06);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.230539246487766e-06);
    AssertAlmostEqual(&test, rTM, 6.230539246487766e-06);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.230539246487765e-06);
    AssertAlmostEqual(&test, rTM, 6.230539246487766e-06);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.230539246487703e-06);
    AssertAlmostEqual(&test, rTM, 6.230539246487828e-06);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.230539246481535e-06);
    AssertAlmostEqual(&test, rTM, 6.230539246493996e-06);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.230539245864719e-06);
    AssertAlmostEqual(&test, rTM, 6.230539247110812e-06);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.23053918418315e-06);
    AssertAlmostEqual(&test, rTM, 6.230539308792381e-06);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.230533016032388e-06);
    AssertAlmostEqual(&test, rTM, 6.230545476943142e-06);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.229916262624602e-06);
    AssertAlmostEqual(&test, rTM, 6.231162230350928e-06);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.168851500186562e-06);
    AssertAlmostEqual(&test, rTM, 6.292226992788922e-06);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.115289033083767e-06);
    AssertAlmostEqual(&test, rTM, 9.345789459770832e-06);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.168926849235252e-08);
    AssertAlmostEqual(&test, rTM, 1.239938922400898e-05);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.229993879300706e-10);
    AssertAlmostEqual(&test, rTM, 1.246045549310396e-05);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.51617200286112e-08);
    AssertAlmostEqual(&test, rTM, 6.51617200286112e-08);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.51617200286112e-08);
    AssertAlmostEqual(&test, rTM, 6.51617200286112e-08);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.51617200286112e-08);
    AssertAlmostEqual(&test, rTM, 6.51617200286112e-08);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.51617200286112e-08);
    AssertAlmostEqual(&test, rTM, 6.516172002861121e-08);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.516172002861055e-08);
    AssertAlmostEqual(&test, rTM, 6.516172002861186e-08);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.516172002854604e-08);
    AssertAlmostEqual(&test, rTM, 6.516172002867637e-08);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.516172002209503e-08);
    AssertAlmostEqual(&test, rTM, 6.516172003512737e-08);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.51617193769941e-08);
    AssertAlmostEqual(&test, rTM, 6.516172068022831e-08);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.516165486696482e-08);
    AssertAlmostEqual(&test, rTM, 6.516178519025758e-08);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.515520450900943e-08);
    AssertAlmostEqual(&test, rTM, 6.516823554821298e-08);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.451655456702118e-08);
    AssertAlmostEqual(&test, rTM, 6.580688549020123e-08);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.258086213733051e-08);
    AssertAlmostEqual(&test, rTM, 9.774257791989176e-08);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.451656280854587e-10);
    AssertAlmostEqual(&test, rTM, 1.296782744291364e-07);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546174675858375e-10);
    AssertAlmostEqual(&test, rTM, 6.546174675858375e-10);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546174675858375e-10);
    AssertAlmostEqual(&test, rTM, 6.546174675858375e-10);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546174675858375e-10);
    AssertAlmostEqual(&test, rTM, 6.546174675858375e-10);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546174675858375e-10);
    AssertAlmostEqual(&test, rTM, 6.546174675858375e-10);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546174675858374e-10);
    AssertAlmostEqual(&test, rTM, 6.546174675858376e-10);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546174675858309e-10);
    AssertAlmostEqual(&test, rTM, 6.54617467585844e-10);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546174675851829e-10);
    AssertAlmostEqual(&test, rTM, 6.546174675864921e-10);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546174675203757e-10);
    AssertAlmostEqual(&test, rTM, 6.546174676512992e-10);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546174610396629e-10);
    AssertAlmostEqual(&test, rTM, 6.546174741320121e-10);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546168129690253e-10);
    AssertAlmostEqual(&test, rTM, 6.546181222026496e-10);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.545520123846847e-10);
    AssertAlmostEqual(&test, rTM, 6.546829227869902e-10);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.481361065290327e-10);
    AssertAlmostEqual(&test, rTM, 6.610988286426422e-10);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.273087340071807e-10);
    AssertAlmostEqual(&test, rTM, 9.819262011644943e-10);

    userdata[0] = 1/CAPS_HBAR_EV; /* 1eV */
    userdata[1] = 1e-05/CAPS_HBAR_EV; /* 1e-05eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999996046152864);
    AssertAlmostEqual(&test, rTM, 0.9999998023076236);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999971902670827);
    AssertAlmostEqual(&test, rTM, 0.9999999721808235);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999720410662479);
    AssertAlmostEqual(&test, rTM, 0.9999999972043471);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997204596723029);
    AssertAlmostEqual(&test, rTM, 0.9999999997204209);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9972081128077699);
    AssertAlmostEqual(&test, rTM, 0.999999999972042);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.972430164567277);
    AssertAlmostEqual(&test, rTM, 0.9999999999972039);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7567845829363016);
    AssertAlmostEqual(&test, rTM, 0.9999999999997177);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1029494263746377);
    AssertAlmostEqual(&test, rTM, 0.9999999999999519);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001276089014522639);
    AssertAlmostEqual(&test, rTM, 0.9999999999999608);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279319331667342e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999999609);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279351738106306e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999999609);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.27935206218106e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999999999609);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279352065421808e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999999999609);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999991107029134);
    AssertAlmostEqual(&test, rTM, 0.999999119507831);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999987485857331);
    AssertAlmostEqual(&test, rTM, 0.9999993742926708);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999911070647214);
    AssertAlmostEqual(&test, rTM, 0.9999999119507482);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999115110843088);
    AssertAlmostEqual(&test, rTM, 0.9999999911516018);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991155069133915);
    AssertAlmostEqual(&test, rTM, 0.9999999991151163);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9911902236584822);
    AssertAlmostEqual(&test, rTM, 0.9999999999115107);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9153401244030027);
    AssertAlmostEqual(&test, rTM, 0.9999999999911425);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4238840386574584);
    AssertAlmostEqual(&test, rTM, 0.9999999999990323);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01245492462676588);
    AssertAlmostEqual(&test, rTM, 0.9999999999995987);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001276780795136403);
    AssertAlmostEqual(&test, rTM, 0.9999999999996084);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.277103629434252e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999996085);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.277106858807823e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999996085);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.277106891101662e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999999996085);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999990334764814);
    AssertAlmostEqual(&test, rTM, 0.9999903347744793);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999903342863996);
    AssertAlmostEqual(&test, rTM, 0.9999903352528696);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999902865639441);
    AssertAlmostEqual(&test, rTM, 0.9999903827361158);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999986331327512);
    AssertAlmostEqual(&test, rTM, 0.9999931656404017);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999028698851563);
    AssertAlmostEqual(&test, rTM, 0.9999990382694484);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9990338909903526);
    AssertAlmostEqual(&test, rTM, 0.999999903352055);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9903813140795321);
    AssertAlmostEqual(&test, rTM, 0.999999990334615);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.907905310445389);
    AssertAlmostEqual(&test, rTM, 0.9999999990323444);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3936136762470601);
    AssertAlmostEqual(&test, rTM, 0.9999999998926525);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0104814003097222);
    AssertAlmostEqual(&test, rTM, 0.9999999999523017);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000107023320179736);
    AssertAlmostEqual(&test, rTM, 0.9999999999532813);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.070460026626172e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999532911);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.070462295481399e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999532913);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999519561624858);
    AssertAlmostEqual(&test, rTM, 0.9999519561629662);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999519561387047);
    AssertAlmostEqual(&test, rTM, 0.9999519561867474);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999519537606519);
    AssertAlmostEqual(&test, rTM, 0.99995195856468);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999517165468885);
    AssertAlmostEqual(&test, rTM, 0.9999521945894526);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999320564298108);
    AssertAlmostEqual(&test, rTM, 0.9999660276378348);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995172703681532);
    AssertAlmostEqual(&test, rTM, 0.999995219355964);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.995206789534171);
    AssertAlmostEqual(&test, rTM, 0.9999995195728358);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9530952853808567);
    AssertAlmostEqual(&test, rTM, 0.9999999519411729);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6212976648977295);
    AssertAlmostEqual(&test, rTM, 0.9999999950588161);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03993086985944962);
    AssertAlmostEqual(&test, rTM, 0.9999999987498325);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004328403284714138);
    AssertAlmostEqual(&test, rTM, 0.9999999988448398);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.332115199222922e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999988458294);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.332152358560165e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999988458393);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995994585347385);
    AssertAlmostEqual(&test, rTM, 0.9995994585347786);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995994585327562);
    AssertAlmostEqual(&test, rTM, 0.9995994585367608);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999599458334528);
    AssertAlmostEqual(&test, rTM, 0.999599458734989);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995994385121977);
    AssertAlmostEqual(&test, rTM, 0.9995994785563188);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999597461211484);
    AssertAlmostEqual(&test, rTM, 0.9996014459496585);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994335958248992);
    AssertAlmostEqual(&test, rTM, 0.9997167577936958);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9959818986610083);
    AssertAlmostEqual(&test, rTM, 0.9999601373656802);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9607303575796227);
    AssertAlmostEqual(&test, rTM, 0.9999959931877275);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6716687229263597);
    AssertAlmostEqual(&test, rTM, 0.9999995914202754);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05557345687175928);
    AssertAlmostEqual(&test, rTM, 0.9999999103068666);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006222864841224322);
    AssertAlmostEqual(&test, rTM, 0.9999999196511929);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.230539246481534e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999197501308);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.230616110040299e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999197511208);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960902135376067);
    AssertAlmostEqual(&test, rTM, 0.9960902135376106);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960902135374136);
    AssertAlmostEqual(&test, rTM, 0.9960902135378038);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.996090213518098);
    AssertAlmostEqual(&test, rTM, 0.9960902135571194);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960902115865451);
    AssertAlmostEqual(&test, rTM, 0.9960902154886714);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960900184360915);
    AssertAlmostEqual(&test, rTM, 0.9960904086294098);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960707516207764);
    AssertAlmostEqual(&test, rTM, 0.996109579245716);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9944752111970168);
    AssertAlmostEqual(&test, rTM, 0.9972337743118063);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9613974606664578);
    AssertAlmostEqual(&test, rTM, 0.9996102009068103);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6775297823443511);
    AssertAlmostEqual(&test, rTM, 0.9999600839366958);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05784156596710271);
    AssertAlmostEqual(&test, rTM, 0.9999913846969479);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006507694494160635);
    AssertAlmostEqual(&test, rTM, 0.999992316849775);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.516087931785651e-06);
    AssertAlmostEqual(&test, rTM, 0.9999923267431539);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.516172002854602e-08);
    AssertAlmostEqual(&test, rTM, 0.9999923268421521);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.961671694318499);
    AssertAlmostEqual(&test, rTM, 0.9616716943184994);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616716943184804);
    AssertAlmostEqual(&test, rTM, 0.961671694318518);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616716943166203);
    AssertAlmostEqual(&test, rTM, 0.9616716943203781);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616716941306021);
    AssertAlmostEqual(&test, rTM, 0.9616716945063963);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616716755287918);
    AssertAlmostEqual(&test, rTM, 0.9616717131081975);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616698153960996);
    AssertAlmostEqual(&test, rTM, 0.9616735731505947);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9614842830471968);
    AssertAlmostEqual(&test, rTM, 0.9618582114092465);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9462324651838999);
    AssertAlmostEqual(&test, rTM, 0.9727396793627803);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.676844624946098);
    AssertAlmostEqual(&test, rTM, 0.9960459826289628);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05807352294817291);
    AssertAlmostEqual(&test, rTM, 0.9991427070922717);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006537611675067433);
    AssertAlmostEqual(&test, rTM, 0.9992357798975066);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546088915565393e-06);
    AssertAlmostEqual(&test, rTM, 0.9992367681099664);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546173826726316e-08);
    AssertAlmostEqual(&test, rTM, 0.9992367779985699);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6782005655647596);
    AssertAlmostEqual(&test, rTM, 0.6782005655647597);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6782005655647584);
    AssertAlmostEqual(&test, rTM, 0.6782005655647609);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6782005655646296);
    AssertAlmostEqual(&test, rTM, 0.6782005655648897);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.678200565551755);
    AssertAlmostEqual(&test, rTM, 0.6782005655777643);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.678200564264292);
    AssertAlmostEqual(&test, rTM, 0.6782005668652273);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6782004355180385);
    AssertAlmostEqual(&test, rTM, 0.6782006956114383);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.678187561349761);
    AssertAlmostEqual(&test, rTM, 0.6782135693550282);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.676904691657316);
    AssertAlmostEqual(&test, rTM, 0.6794922353700857);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5793707402578566);
    AssertAlmostEqual(&test, rTM, 0.7573768013257772);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05758987166609775);
    AssertAlmostEqual(&test, rTM, 0.9207444381466188);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006539972568719639);
    AssertAlmostEqual(&test, rTM, 0.9289803251465715);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549097738098405e-06);
    AssertAlmostEqual(&test, rTM, 0.9290689693506349);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549189146157432e-08);
    AssertAlmostEqual(&test, rTM, 0.9290698565025912);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810489014005663);
    AssertAlmostEqual(&test, rTM, 0.05810489014005663);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810489014005663);
    AssertAlmostEqual(&test, rTM, 0.05810489014005664);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810489014005612);
    AssertAlmostEqual(&test, rTM, 0.05810489014005715);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810489014000491);
    AssertAlmostEqual(&test, rTM, 0.05810489014010836);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0581048901348843);
    AssertAlmostEqual(&test, rTM, 0.05810489014522897);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810488962282331);
    AssertAlmostEqual(&test, rTM, 0.05810489065728996);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810483841676955);
    AssertAlmostEqual(&test, rTM, 0.05810494186334341);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05809971826867313);
    AssertAlmostEqual(&test, rTM, 0.05811006200832121);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05759223563547785);
    AssertAlmostEqual(&test, rTM, 0.0586175140013722);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03076359202774576);
    AssertAlmostEqual(&test, rTM, 0.08535929875011761);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006476248792219675);
    AssertAlmostEqual(&test, rTM, 0.1151797699380199);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.548751103976018e-06);
    AssertAlmostEqual(&test, rTM, 0.1158122946046893);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549484353388131e-08);
    AssertAlmostEqual(&test, rTM, 0.115818690899553);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540956705722818);
    AssertAlmostEqual(&test, rTM, 0.0006540956705722818);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540956705722818);
    AssertAlmostEqual(&test, rTM, 0.0006540956705722818);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540956705722818);
    AssertAlmostEqual(&test, rTM, 0.0006540956705722819);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540956705722753);
    AssertAlmostEqual(&test, rTM, 0.0006540956705722884);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540956705716285);
    AssertAlmostEqual(&test, rTM, 0.0006540956705729351);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540956705069577);
    AssertAlmostEqual(&test, rTM, 0.0006540956706376058);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540956640398764);
    AssertAlmostEqual(&test, rTM, 0.0006540956771046873);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540950173323865);
    AssertAlmostEqual(&test, rTM, 0.000654096323812177);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540303530407374);
    AssertAlmostEqual(&test, rTM, 0.0006541609881038206);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006476278586863367);
    AssertAlmostEqual(&test, rTM, 0.000660563482403502);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003272617908175133);
    AssertAlmostEqual(&test, rTM, 0.0009809294105855477);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.484591078989736e-06);
    AssertAlmostEqual(&test, rTM, 0.001301706201410211);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.548866186989677e-08);
    AssertAlmostEqual(&test, rTM, 0.00130812529289692);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549439157379002e-06);
    AssertAlmostEqual(&test, rTM, 6.549439157379002e-06);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549439157379002e-06);
    AssertAlmostEqual(&test, rTM, 6.549439157379002e-06);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549439157379002e-06);
    AssertAlmostEqual(&test, rTM, 6.549439157379002e-06);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549439157379002e-06);
    AssertAlmostEqual(&test, rTM, 6.549439157379003e-06);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549439157378937e-06);
    AssertAlmostEqual(&test, rTM, 6.549439157379068e-06);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549439157372453e-06);
    AssertAlmostEqual(&test, rTM, 6.549439157385552e-06);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549439156724067e-06);
    AssertAlmostEqual(&test, rTM, 6.549439158033938e-06);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54943909188547e-06);
    AssertAlmostEqual(&test, rTM, 6.549439222872536e-06);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549432608032184e-06);
    AssertAlmostEqual(&test, rTM, 6.549445706725821e-06);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.548784287528367e-06);
    AssertAlmostEqual(&test, rTM, 6.550094027229639e-06);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.484594066121339e-06);
    AssertAlmostEqual(&test, rTM, 6.61428424863661e-06);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.274741026301256e-06);
    AssertAlmostEqual(&test, rTM, 9.824137288316281e-06);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.484677325838898e-08);
    AssertAlmostEqual(&test, rTM, 1.303403154094881e-05);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549524392311171e-08);
    AssertAlmostEqual(&test, rTM, 6.549524392311171e-08);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549524392311171e-08);
    AssertAlmostEqual(&test, rTM, 6.549524392311171e-08);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549524392311171e-08);
    AssertAlmostEqual(&test, rTM, 6.549524392311171e-08);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549524392311171e-08);
    AssertAlmostEqual(&test, rTM, 6.549524392311171e-08);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54952439231117e-08);
    AssertAlmostEqual(&test, rTM, 6.549524392311171e-08);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549524392311105e-08);
    AssertAlmostEqual(&test, rTM, 6.549524392311236e-08);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549524392304621e-08);
    AssertAlmostEqual(&test, rTM, 6.54952439231772e-08);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549524391656219e-08);
    AssertAlmostEqual(&test, rTM, 6.549524392966124e-08);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549524326815935e-08);
    AssertAlmostEqual(&test, rTM, 6.549524457806406e-08);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549517842794185e-08);
    AssertAlmostEqual(&test, rTM, 6.549530941828156e-08);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54886950544641e-08);
    AssertAlmostEqual(&test, rTM, 6.550179279175931e-08);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.484677624559882e-08);
    AssertAlmostEqual(&test, rTM, 6.614371160062459e-08);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.274762410636937e-08);
    AssertAlmostEqual(&test, rTM, 9.824286373985391e-08);

    userdata[0] = 1/CAPS_HBAR_EV; /* 1eV */
    userdata[1] = 0.0001/CAPS_HBAR_EV; /* 0.0001eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999987497941957);
    AssertAlmostEqual(&test, rTM, 0.9999993748969025);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999911156523958);
    AssertAlmostEqual(&test, rTM, 0.9999999120357754);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999115965323369);
    AssertAlmostEqual(&test, rTM, 0.9999999911601465);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991163606714282);
    AssertAlmostEqual(&test, rTM, 0.9999999991159708);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.991198693462591);
    AssertAlmostEqual(&test, rTM, 0.9999999999115962);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9154182683838561);
    AssertAlmostEqual(&test, rTM, 0.9999999999911511);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4242154357919068);
    AssertAlmostEqual(&test, rTM, 0.9999999999990334);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01247842060860452);
    AssertAlmostEqual(&test, rTM, 0.9999999999995993);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001279249658356818);
    AssertAlmostEqual(&test, rTM, 0.9999999999996091);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279573742484986e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999996092);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.27957698436285e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999996092);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279577016781733e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999999996092);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279577017105921e-12);
    AssertAlmostEqual(&test, rTM, 0.9999999999996092);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999971902670827);
    AssertAlmostEqual(&test, rTM, 0.9999972180861818);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999960461598979);
    AssertAlmostEqual(&test, rTM, 0.9999980230779948);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999719030260823);
    AssertAlmostEqual(&test, rTM, 0.9999997218082699);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997204458373473);
    AssertAlmostEqual(&test, rTM, 0.9999999720434711);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9972081114277179);
    AssertAlmostEqual(&test, rTM, 0.999999997204206);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9724301644327139);
    AssertAlmostEqual(&test, rTM, 0.9999999997203934);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7567845829259292);
    AssertAlmostEqual(&test, rTM, 0.9999999999717702);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1029494263745548);
    AssertAlmostEqual(&test, rTM, 0.9999999999951947);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001276089014522627);
    AssertAlmostEqual(&test, rTM, 0.9999999999960818);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279319331667342e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999960917);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279351738106307e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999960918);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.27935206218106e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999999960918);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279352065421808e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999999960918);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999717734243243);
    AssertAlmostEqual(&test, rTM, 0.9999717734525504);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999717720271645);
    AssertAlmostEqual(&test, rTM, 0.9999717748496397);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999716326587051);
    AssertAlmostEqual(&test, rTM, 0.9999719135195262);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999960081847181);
    AssertAlmostEqual(&test, rTM, 0.9999800407244022);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997163627970265);
    AssertAlmostEqual(&test, rTM, 0.9999971913164259);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9971811442677116);
    AssertAlmostEqual(&test, rTM, 0.9999997177442718);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9721685958454004);
    AssertAlmostEqual(&test, rTM, 0.9999999717702435);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7547710560883619);
    AssertAlmostEqual(&test, rTM, 0.99999999714933);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1013555584581867);
    AssertAlmostEqual(&test, rTM, 0.9999999995117549);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001251940483429324);
    AssertAlmostEqual(&test, rTM, 0.9999999996006206);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.255049586343543e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999996016093);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.255080774880307e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999996016192);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.255081086775459e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999996016193);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999033518996627);
    AssertAlmostEqual(&test, rTM, 0.9999033519006292);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999033518518242);
    AssertAlmostEqual(&test, rTM, 0.9999033519484676);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999033470680952);
    AssertAlmostEqual(&test, rTM, 0.9999033567319551);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999028698851563);
    AssertAlmostEqual(&test, rTM, 0.9999038315232176);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998633216823868);
    AssertAlmostEqual(&test, rTM, 0.9999316585058337);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999029123321052);
    AssertAlmostEqual(&test, rTM, 0.999990382735004);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9903808402678071);
    AssertAlmostEqual(&test, rTM, 0.999999033509799);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9079052670590105);
    AssertAlmostEqual(&test, rTM, 0.9999999032344851);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3936136745515031);
    AssertAlmostEqual(&test, rTM, 0.9999999892652579);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01048140030870607);
    AssertAlmostEqual(&test, rTM, 0.9999999952301691);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001070233201796301);
    AssertAlmostEqual(&test, rTM, 0.9999999953281211);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.070460026626162e-06);
    AssertAlmostEqual(&test, rTM, 0.999999995329111);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.070462295481399e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999953291209);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995196654879659);
    AssertAlmostEqual(&test, rTM, 0.9995196654880139);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995196654855888);
    AssertAlmostEqual(&test, rTM, 0.999519665490391);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995196652478804);
    AssertAlmostEqual(&test, rTM, 0.9995196657280992);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995196414776343);
    AssertAlmostEqual(&test, rTM, 0.9995196894971456);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995172703681532);
    AssertAlmostEqual(&test, rTM, 0.9995220487269985);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993207720081969);
    AssertAlmostEqual(&test, rTM, 0.9996603283058727);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9951831810707509);
    AssertAlmostEqual(&test, rTM, 0.9999521944528841);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9530930194175289);
    AssertAlmostEqual(&test, rTM, 0.999995194366729);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6212975212264453);
    AssertAlmostEqual(&test, rTM, 0.9999995058819905);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03993086949449236);
    AssertAlmostEqual(&test, rTM, 0.9999998749832638);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004328403284285997);
    AssertAlmostEqual(&test, rTM, 0.9999998844839966);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.332115199218634e-06);
    AssertAlmostEqual(&test, rTM, 0.9999998845829533);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.332152358560123e-08);
    AssertAlmostEqual(&test, rTM, 0.9999998845839433);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960017997894169);
    AssertAlmostEqual(&test, rTM, 0.9960017997894209);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960017997892194);
    AssertAlmostEqual(&test, rTM, 0.9960017997896184);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.996001799769468);
    AssertAlmostEqual(&test, rTM, 0.9960017998093699);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960017977943237);
    AssertAlmostEqual(&test, rTM, 0.9960018017845131);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960016002848565);
    AssertAlmostEqual(&test, rTM, 0.9960019992840468);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9959818986610083);
    AssertAlmostEqual(&test, rTM, 0.9960216025466188);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.994350380540905);
    AssertAlmostEqual(&test, rTM, 0.9971711835179783);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.960540373076947);
    AssertAlmostEqual(&test, rTM, 0.9996013668068183);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6716556631259593);
    AssertAlmostEqual(&test, rTM, 0.9999591449603746);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05557340764718825);
    AssertAlmostEqual(&test, rTM, 0.9999910307629954);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006222864779694587);
    AssertAlmostEqual(&test, rTM, 0.9999919651831725);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.230539245864718e-06);
    AssertAlmostEqual(&test, rTM, 0.999991975076831);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.230616110034131e-08);
    AssertAlmostEqual(&test, rTM, 0.9999919751758292);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9615852857967334);
    AssertAlmostEqual(&test, rTM, 0.9615852857967337);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9615852857967148);
    AssertAlmostEqual(&test, rTM, 0.9615852857967524);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9615852857948505);
    AssertAlmostEqual(&test, rTM, 0.9615852857986167);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9615852856084215);
    AssertAlmostEqual(&test, rTM, 0.9615852859850457);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9615852669655287);
    AssertAlmostEqual(&test, rTM, 0.9615853046279293);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9615834027246973);
    AssertAlmostEqual(&test, rTM, 0.9615871687782745);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9613974606664578);
    AssertAlmostEqual(&test, rTM, 0.9617722148537505);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9461122521838218);
    AssertAlmostEqual(&test, rTM, 0.9726778516531526);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6762450372613529);
    AssertAlmostEqual(&test, rTM, 0.9960365773317024);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05783646632503714);
    AssertAlmostEqual(&test, rTM, 0.9991391725741638);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006507688059929377);
    AssertAlmostEqual(&test, rTM, 0.9992322685597081);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.516087867277221e-06);
    AssertAlmostEqual(&test, rTM, 0.9992332567699483);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.516172002209501e-08);
    AssertAlmostEqual(&test, rTM, 0.9992332666585);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6781406715081518);
    AssertAlmostEqual(&test, rTM, 0.6781406715081519);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6781406715081506);
    AssertAlmostEqual(&test, rTM, 0.6781406715081532);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6781406715080218);
    AssertAlmostEqual(&test, rTM, 0.6781406715082819);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6781406714951455);
    AssertAlmostEqual(&test, rTM, 0.6781406715211583);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6781406702075106);
    AssertAlmostEqual(&test, rTM, 0.6781406728087931);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6781405414440712);
    AssertAlmostEqual(&test, rTM, 0.67814080157219);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6781276655572938);
    AssertAlmostEqual(&test, rTM, 0.6781536770342679);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6768446249460981);
    AssertAlmostEqual(&test, rTM, 0.6794325138501163);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5792996766992881);
    AssertAlmostEqual(&test, rTM, 0.7573278352224876);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05756624267702896);
    AssertAlmostEqual(&test, rTM, 0.9207142778492156);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006536965361765717);
    AssertAlmostEqual(&test, rTM, 0.9289499751584115);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546082435028692e-06);
    AssertAlmostEqual(&test, rTM, 0.929038615098604);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546173761919204e-08);
    AssertAlmostEqual(&test, rTM, 0.9290395022076192);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810250758014587);
    AssertAlmostEqual(&test, rTM, 0.05810250758014587);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810250758014587);
    AssertAlmostEqual(&test, rTM, 0.05810250758014588);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810250758014536);
    AssertAlmostEqual(&test, rTM, 0.05810250758014639);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810250758009415);
    AssertAlmostEqual(&test, rTM, 0.0581025075801976);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810250757497373);
    AssertAlmostEqual(&test, rTM, 0.05810250758531802);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810250706293128);
    AssertAlmostEqual(&test, rTM, 0.05810250809736046);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810245585873238);
    AssertAlmostEqual(&test, rTM, 0.05810255930155905);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05809733589610715);
    AssertAlmostEqual(&test, rTM, 0.05810767926106602);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05758987166609776);
    AssertAlmostEqual(&test, rTM, 0.05861511285441796);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03076225953744343);
    AssertAlmostEqual(&test, rTM, 0.08535587635934319);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006475950860860071);
    AssertAlmostEqual(&test, rTM, 0.1151750815018342);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.548449450742528e-06);
    AssertAlmostEqual(&test, rTM, 0.1158075777667452);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54918266246751e-08);
    AssertAlmostEqual(&test, rTM, 0.1158139737740614);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540926613911465);
    AssertAlmostEqual(&test, rTM, 0.0006540926613911465);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540926613911465);
    AssertAlmostEqual(&test, rTM, 0.0006540926613911465);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540926613911464);
    AssertAlmostEqual(&test, rTM, 0.0006540926613911466);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.00065409266139114);
    AssertAlmostEqual(&test, rTM, 0.000654092661391153);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540926613904933);
    AssertAlmostEqual(&test, rTM, 0.0006540926613917997);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540926613258228);
    AssertAlmostEqual(&test, rTM, 0.0006540926614564702);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000654092654858771);
    AssertAlmostEqual(&test, rTM, 0.0006540926679235219);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540920081542526);
    AssertAlmostEqual(&test, rTM, 0.0006540933146280404);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540273441597037);
    AssertAlmostEqual(&test, rTM, 0.0006541579786225837);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006476248792219675);
    AssertAlmostEqual(&test, rTM, 0.0006605604435056012);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003272602842581754);
    AssertAlmostEqual(&test, rTM, 0.0009809248987845427);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.484561207825078e-06);
    AssertAlmostEqual(&test, rTM, 0.001301700212926677);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.548836019355474e-08);
    AssertAlmostEqual(&test, rTM, 0.001308119274844048);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549436140376868e-06);
    AssertAlmostEqual(&test, rTM, 6.549436140376868e-06);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549436140376868e-06);
    AssertAlmostEqual(&test, rTM, 6.549436140376868e-06);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549436140376868e-06);
    AssertAlmostEqual(&test, rTM, 6.549436140376868e-06);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549436140376867e-06);
    AssertAlmostEqual(&test, rTM, 6.549436140376868e-06);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549436140376801e-06);
    AssertAlmostEqual(&test, rTM, 6.549436140376933e-06);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549436140370317e-06);
    AssertAlmostEqual(&test, rTM, 6.549436140383417e-06);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549436139721932e-06);
    AssertAlmostEqual(&test, rTM, 6.549436141031802e-06);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549436074883364e-06);
    AssertAlmostEqual(&test, rTM, 6.54943620587037e-06);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549429591033065e-06);
    AssertAlmostEqual(&test, rTM, 6.549442689720669e-06);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.548781270827893e-06);
    AssertAlmostEqual(&test, rTM, 6.550091009925841e-06);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.484591078989737e-06);
    AssertAlmostEqual(&test, rTM, 6.614281201763942e-06);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.274739517780429e-06);
    AssertAlmostEqual(&test, rTM, 9.824132762832838e-06);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.484674338630589e-08);
    AssertAlmostEqual(&test, rTM, 1.303402553681662e-05);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54952409060298e-08);
    AssertAlmostEqual(&test, rTM, 6.54952409060298e-08);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54952409060298e-08);
    AssertAlmostEqual(&test, rTM, 6.54952409060298e-08);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54952409060298e-08);
    AssertAlmostEqual(&test, rTM, 6.54952409060298e-08);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54952409060298e-08);
    AssertAlmostEqual(&test, rTM, 6.54952409060298e-08);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549524090602979e-08);
    AssertAlmostEqual(&test, rTM, 6.54952409060298e-08);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549524090602914e-08);
    AssertAlmostEqual(&test, rTM, 6.549524090603045e-08);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54952409059643e-08);
    AssertAlmostEqual(&test, rTM, 6.549524090609529e-08);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549524089948028e-08);
    AssertAlmostEqual(&test, rTM, 6.549524091257932e-08);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549524025107748e-08);
    AssertAlmostEqual(&test, rTM, 6.549524156098211e-08);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549517541086296e-08);
    AssertAlmostEqual(&test, rTM, 6.549530640119663e-08);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.548869203768387e-08);
    AssertAlmostEqual(&test, rTM, 6.550178977437572e-08);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.4846773258389e-08);
    AssertAlmostEqual(&test, rTM, 6.614370855367059e-08);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.274762259782822e-08);
    AssertAlmostEqual(&test, rTM, 9.824285921423122e-08);

    userdata[0] = 1/CAPS_HBAR_EV; /* 1eV */
    userdata[1] = 0.001/CAPS_HBAR_EV; /* 0.001eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999960465422159);
    AssertAlmostEqual(&test, rTM, 0.9999980232691542);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999719057428962);
    AssertAlmostEqual(&test, rTM, 0.9999997218351698);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997204728652098);
    AssertAlmostEqual(&test, rTM, 0.9999999720461744);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9972083810135504);
    AssertAlmostEqual(&test, rTM, 0.9999999972044763);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.97243279305386);
    AssertAlmostEqual(&test, rTM, 0.9999999997204204);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7568048451692128);
    AssertAlmostEqual(&test, rTM, 0.999999999971773);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1029656209568222);
    AssertAlmostEqual(&test, rTM, 0.9999999999951955);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001276335205310102);
    AssertAlmostEqual(&test, rTM, 0.9999999999960826);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279566770174752e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999960925);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279599189150777e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999960926);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279599513350907e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999999960926);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279599516592909e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999999960926);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279599516625329e-13);
    AssertAlmostEqual(&test, rTM, 0.9999999999960926);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999911156523958);
    AssertAlmostEqual(&test, rTM, 0.9999912036158466);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999874980122924);
    AssertAlmostEqual(&test, rTM, 0.9999937489866085);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999111600758263);
    AssertAlmostEqual(&test, rTM, 0.9999991203581019);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999116316951742);
    AssertAlmostEqual(&test, rTM, 0.9999999116014596);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9911986891252023);
    AssertAlmostEqual(&test, rTM, 0.9999999911596226);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9154182679836648);
    AssertAlmostEqual(&test, rTM, 0.9999999991151073);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4242154357749282);
    AssertAlmostEqual(&test, rTM, 0.9999999999033461);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01247842060859247);
    AssertAlmostEqual(&test, rTM, 0.999999999959937);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001279249658356806);
    AssertAlmostEqual(&test, rTM, 0.9999999999609146);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279573742484986e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999609245);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.27957698436285e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999609246);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279577016781733e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999999609246);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279577017105922e-12);
    AssertAlmostEqual(&test, rTM, 0.9999999999609246);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999115154639867);
    AssertAlmostEqual(&test, rTM, 0.9999115155524673);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999115110843088);
    AssertAlmostEqual(&test, rTM, 0.9999115199319241);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999110742059516);
    AssertAlmostEqual(&test, rTM, 0.9999119546205965);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998748663249644);
    AssertAlmostEqual(&test, rTM, 0.9999374312049939);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991110978549883);
    AssertAlmostEqual(&test, rTM, 0.9999911951123446);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.99118978517347);
    AssertAlmostEqual(&test, rTM, 0.9999991151519049);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9153400839481458);
    AssertAlmostEqual(&test, rTM, 0.9999999114250736);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4238840369425579);
    AssertAlmostEqual(&test, rTM, 0.9999999903237414);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01245492462555115);
    AssertAlmostEqual(&test, rTM, 0.9999999959861464);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001276780795135126);
    AssertAlmostEqual(&test, rTM, 0.9999999960839011);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.27710362943424e-06);
    AssertAlmostEqual(&test, rTM, 0.999999996084891);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.277106858807823e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999960849009);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.277106891101662e-10);
    AssertAlmostEqual(&test, rTM, 0.999999996084901);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997177702344365);
    AssertAlmostEqual(&test, rTM, 0.9997177702372585);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997177700947526);
    AssertAlmostEqual(&test, rTM, 0.9997177703769423);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997177561267038);
    AssertAlmostEqual(&test, rTM, 0.999717784344286);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997163627970265);
    AssertAlmostEqual(&test, rTM, 0.999719170691784);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996008901724517);
    AssertAlmostEqual(&test, rTM, 0.9998004251691822);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9971672464252195);
    AssertAlmostEqual(&test, rTM, 0.9999719134918308);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9721672376683953);
    AssertAlmostEqual(&test, rTM, 0.9999971771680437);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7547709516640665);
    AssertAlmostEqual(&test, rTM, 0.9999997149331799);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1013555576394522);
    AssertAlmostEqual(&test, rTM, 0.9999999511754945);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001251940483305692);
    AssertAlmostEqual(&test, rTM, 0.9999999600620634);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.255049586342301e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999601609382);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.255080774880294e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999601619282);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.255081086775459e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999601619382);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9990339392687896);
    AssertAlmostEqual(&test, rTM, 0.9990339392688862);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.99903393926401);
    AssertAlmostEqual(&test, rTM, 0.9990339392736659);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9990339387860411);
    AssertAlmostEqual(&test, rTM, 0.9990339397516345);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9990338909903526);
    AssertAlmostEqual(&test, rTM, 0.9990339875449118);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999029123321052);
    AssertAlmostEqual(&test, rTM, 0.9990387313390288);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9986340572660607);
    AssertAlmostEqual(&test, rTM, 0.9993167951689124);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.990333578086697);
    AssertAlmostEqual(&test, rTM, 0.9999038304114183);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9079009285403404);
    AssertAlmostEqual(&test, rTM, 0.9999903239749219);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3936135049958998);
    AssertAlmostEqual(&test, rTM, 0.9999989265270348);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01048140020709287);
    AssertAlmostEqual(&test, rTM, 0.9999995230171358);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000107023320169037);
    AssertAlmostEqual(&test, rTM, 0.9999995328123256);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.070460026625102e-06);
    AssertAlmostEqual(&test, rTM, 0.9999995329113147);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.070462295481388e-08);
    AssertAlmostEqual(&test, rTM, 0.9999995329123047);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9952070286010392);
    AssertAlmostEqual(&test, rTM, 0.9952070286010439);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9952070286008026);
    AssertAlmostEqual(&test, rTM, 0.9952070286012806);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9952070285771343);
    AssertAlmostEqual(&test, rTM, 0.9952070286249489);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9952070262103134);
    AssertAlmostEqual(&test, rTM, 0.9952070309917685);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.995206789534171);
    AssertAlmostEqual(&test, rTM, 0.9952072676560172);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9951831810707509);
    AssertAlmostEqual(&test, rTM, 0.9952307583471078);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9932284561547626);
    AssertAlmostEqual(&test, rTM, 0.9966084670935594);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9528670140848164);
    AssertAlmostEqual(&test, rTM, 0.9995219122380034);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6212831546445051);
    AssertAlmostEqual(&test, rTM, 0.9999505920019873);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03993083299880097);
    AssertAlmostEqual(&test, rTM, 0.9999874984760788);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004328403241471884);
    AssertAlmostEqual(&test, rTM, 0.9999884485317057);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.332115198789758e-06);
    AssertAlmostEqual(&test, rTM, 0.9999884584272062);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.332152358555834e-08);
    AssertAlmostEqual(&test, rTM, 0.9999884585262041);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9607322815946346);
    AssertAlmostEqual(&test, rTM, 0.960732281594635);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9607322815946155);
    AssertAlmostEqual(&test, rTM, 0.9607322815946541);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9607322815927107);
    AssertAlmostEqual(&test, rTM, 0.9607322815965589);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9607322814022283);
    AssertAlmostEqual(&test, rTM, 0.9607322817870413);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9607322623539892);
    AssertAlmostEqual(&test, rTM, 0.9607323008352712);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9607303575796227);
    AssertAlmostEqual(&test, rTM, 0.9607342055172677);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.960540373076947);
    AssertAlmostEqual(&test, rTM, 0.9609232753844565);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9449257839727582);
    AssertAlmostEqual(&test, rTM, 0.9720674101900894);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.670354331861994);
    AssertAlmostEqual(&test, rTM, 0.9959435677173295);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05556848563178083);
    AssertAlmostEqual(&test, rTM, 0.9991038390080458);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006222858626727194);
    AssertAlmostEqual(&test, rTM, 0.9991971565403953);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.230539184183149e-06);
    AssertAlmostEqual(&test, rTM, 0.9991981447270015);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.230616109417299e-08);
    AssertAlmostEqual(&test, rTM, 0.9991981546150349);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6775428056060097);
    AssertAlmostEqual(&test, rTM, 0.6775428056060098);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6775428056060084);
    AssertAlmostEqual(&test, rTM, 0.677542805606011);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6775428056058794);
    AssertAlmostEqual(&test, rTM, 0.67754280560614);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.677542805592986);
    AssertAlmostEqual(&test, rTM, 0.6775428056190335);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6775428043036372);
    AssertAlmostEqual(&test, rTM, 0.6775428069083821);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6775426753688117);
    AssertAlmostEqual(&test, rTM, 0.6775429358431653);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6775297823443511);
    AssertAlmostEqual(&test, rTM, 0.6775558284428077);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6762450372613529);
    AssertAlmostEqual(&test, rTM, 0.6788363685652938);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5785904806533552);
    AssertAlmostEqual(&test, rTM, 0.756838950252106);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05733101837211198);
    AssertAlmostEqual(&test, rTM, 0.9204127924917331);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006507044701049257);
    AssertAlmostEqual(&test, rTM, 0.9286465843119703);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.516081416440752e-06);
    AssertAlmostEqual(&test, rTM, 0.9287351816323791);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.516171937699407e-08);
    AssertAlmostEqual(&test, rTM, 0.9287360683121875);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05807869275950604);
    AssertAlmostEqual(&test, rTM, 0.05807869275950604);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05807869275950604);
    AssertAlmostEqual(&test, rTM, 0.05807869275950604);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05807869275950552);
    AssertAlmostEqual(&test, rTM, 0.05807869275950656);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05807869275945433);
    AssertAlmostEqual(&test, rTM, 0.05807869275955774);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05807869275433577);
    AssertAlmostEqual(&test, rTM, 0.05807869276467631);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05807869224247873);
    AssertAlmostEqual(&test, rTM, 0.05807869327653335);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05807864105682106);
    AssertAlmostEqual(&test, rTM, 0.05807874446219071);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05807352294817292);
    AssertAlmostEqual(&test, rTM, 0.05808386256772412);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05756624267702896);
    AssertAlmostEqual(&test, rTM, 0.05859111223704998);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03074894098636187);
    AssertAlmostEqual(&test, rTM, 0.08532166756813653);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006472973054225107);
    AssertAlmostEqual(&test, rTM, 0.1151282181243579);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.545434446150153e-06);
    AssertAlmostEqual(&test, rTM, 0.1157604305106686);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546167281214509e-08);
    AssertAlmostEqual(&test, rTM, 0.1157668236439184);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540625711025421);
    AssertAlmostEqual(&test, rTM, 0.0006540625711025421);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540625711025421);
    AssertAlmostEqual(&test, rTM, 0.0006540625711025421);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540625711025421);
    AssertAlmostEqual(&test, rTM, 0.0006540625711025422);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540625711025356);
    AssertAlmostEqual(&test, rTM, 0.0006540625711025486);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540625711018888);
    AssertAlmostEqual(&test, rTM, 0.0006540625711031953);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540625710372214);
    AssertAlmostEqual(&test, rTM, 0.0006540625711678629);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540625645704668);
    AssertAlmostEqual(&test, rTM, 0.0006540625776346174);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540619178956598);
    AssertAlmostEqual(&test, rTM, 0.0006540632243094244);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000653997256871964);
    AssertAlmostEqual(&test, rTM, 0.0006541278853331146);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006475950860860072);
    AssertAlmostEqual(&test, rTM, 0.0006605300560643603);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003272452194276657);
    AssertAlmostEqual(&test, rTM, 0.0009808797830571196);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.484262511313917e-06);
    AssertAlmostEqual(&test, rTM, 0.001301640331121694);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54853435829926e-08);
    AssertAlmostEqual(&test, rTM, 0.001308059097360673);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549405970508388e-06);
    AssertAlmostEqual(&test, rTM, 6.549405970508388e-06);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549405970508388e-06);
    AssertAlmostEqual(&test, rTM, 6.549405970508388e-06);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549405970508388e-06);
    AssertAlmostEqual(&test, rTM, 6.549405970508388e-06);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549405970508387e-06);
    AssertAlmostEqual(&test, rTM, 6.549405970508389e-06);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549405970508323e-06);
    AssertAlmostEqual(&test, rTM, 6.549405970508453e-06);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549405970501839e-06);
    AssertAlmostEqual(&test, rTM, 6.549405970514937e-06);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549405969853456e-06);
    AssertAlmostEqual(&test, rTM, 6.54940597116332e-06);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549405905015187e-06);
    AssertAlmostEqual(&test, rTM, 6.54940603600159e-06);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549399421194756e-06);
    AssertAlmostEqual(&test, rTM, 6.549412519822021e-06);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54875110397602e-06);
    AssertAlmostEqual(&test, rTM, 6.550060837040756e-06);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.48456120782508e-06);
    AssertAlmostEqual(&test, rTM, 6.614250733191641e-06);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.274724432648594e-06);
    AssertAlmostEqual(&test, rTM, 9.824087508227718e-06);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.484644466698861e-08);
    AssertAlmostEqual(&test, rTM, 1.303396549579899e-05);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549521073522595e-08);
    AssertAlmostEqual(&test, rTM, 6.549521073522595e-08);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549521073522595e-08);
    AssertAlmostEqual(&test, rTM, 6.549521073522595e-08);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549521073522595e-08);
    AssertAlmostEqual(&test, rTM, 6.549521073522595e-08);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549521073522595e-08);
    AssertAlmostEqual(&test, rTM, 6.549521073522595e-08);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549521073522593e-08);
    AssertAlmostEqual(&test, rTM, 6.549521073522595e-08);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549521073522529e-08);
    AssertAlmostEqual(&test, rTM, 6.54952107352266e-08);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549521073516045e-08);
    AssertAlmostEqual(&test, rTM, 6.549521073529145e-08);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549521072867642e-08);
    AssertAlmostEqual(&test, rTM, 6.549521074177547e-08);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549521008027393e-08);
    AssertAlmostEqual(&test, rTM, 6.549521139017796e-08);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549514524008928e-08);
    AssertAlmostEqual(&test, rTM, 6.54952762303626e-08);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.548866186989679e-08);
    AssertAlmostEqual(&test, rTM, 6.550175960055509e-08);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.48467433863059e-08);
    AssertAlmostEqual(&test, rTM, 6.614367808414598e-08);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.274760751242432e-08);
    AssertAlmostEqual(&test, rTM, 9.824281395802743e-08);

    userdata[0] = 1/CAPS_HBAR_EV; /* 1eV */
    userdata[1] = 0.003/CAPS_HBAR_EV; /* 0.003eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999931524246206);
    AssertAlmostEqual(&test, rTM, 0.9999965762064491);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999513398513767);
    AssertAlmostEqual(&test, rTM, 0.999999518204744);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995158946559033);
    AssertAlmostEqual(&test, rTM, 0.9999999515825849);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9951697222398382);
    AssertAlmostEqual(&test, rTM, 0.9999999951580046);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9527382165356371);
    AssertAlmostEqual(&test, rTM, 0.9999999995156598);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6190377937695254);
    AssertAlmostEqual(&test, rTM, 0.9999999999501814);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03936164359489515);
    AssertAlmostEqual(&test, rTM, 0.9999999999873169);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004261702532566085);
    AssertAlmostEqual(&test, rTM, 0.9999999999882676);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.265300891810416e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999882775);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.265336913764603e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999882776);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.265337273987986e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999999882776);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.26533727759022e-12);
    AssertAlmostEqual(&test, rTM, 0.9999999999882776);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.265337277626242e-14);
    AssertAlmostEqual(&test, rTM, 0.9999999999882776);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999846120088098);
    AssertAlmostEqual(&test, rTM, 0.9999847643639976);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999783461622017);
    AssertAlmostEqual(&test, rTM, 0.9999891730224888);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998461307433739);
    AssertAlmostEqual(&test, rTM, 0.9999984764259496);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.998469921226174);
    AssertAlmostEqual(&test, rTM, 0.9999998468902089);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9848050271241149);
    AssertAlmostEqual(&test, rTM, 0.9999999846878177);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8581569842011495);
    AssertAlmostEqual(&test, rTM, 0.9999999984643452);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2438650140448199);
    AssertAlmostEqual(&test, rTM, 0.9999999998071618);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.004229309916679696);
    AssertAlmostEqual(&test, rTM, 0.9999999998817796);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.264948458823654e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999998827653);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.265308639231812e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999998827752);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.26531224141992e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999998827753);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.265312277441839e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999998827753);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.265312277802059e-13);
    AssertAlmostEqual(&test, rTM, 0.9999999998827753);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998468448881994);
    AssertAlmostEqual(&test, rTM, 0.9998468450413426);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998468373077971);
    AssertAlmostEqual(&test, rTM, 0.9998468526213621);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998460811533115);
    AssertAlmostEqual(&test, rTM, 0.9998476049861587);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997834129426901);
    AssertAlmostEqual(&test, rTM, 0.9998917006066482);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9984618773413868);
    AssertAlmostEqual(&test, rTM, 0.9999847594489846);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9847994205002514);
    AssertAlmostEqual(&test, rTM, 0.9999984683651937);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8581146926036657);
    AssertAlmostEqual(&test, rTM, 0.9999998463848183);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2437694757417722);
    AssertAlmostEqual(&test, rTM, 0.9999999807076662);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.004226607858669938);
    AssertAlmostEqual(&test, rTM, 0.9999999881703939);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.262200735122688e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999882689713);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.262560451572309e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999882699612);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.262564049120091e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999882699712);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.262564085095607e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999882699712);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995143456743457);
    AssertAlmostEqual(&test, rTM, 0.9995143456792011);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995143454340052);
    AssertAlmostEqual(&test, rTM, 0.9995143459195414);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995143214005623);
    AssertAlmostEqual(&test, rTM, 0.9995143699517712);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995119240369316);
    AssertAlmostEqual(&test, rTM, 0.9995167553043001);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993132501646003);
    AssertAlmostEqual(&test, rTM, 0.9996565660987529);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9951299510217613);
    AssertAlmostEqual(&test, rTM, 0.9999516648769446);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9525860043955582);
    AssertAlmostEqual(&test, rTM, 0.9999951410992614);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6180914855112766);
    AssertAlmostEqual(&test, rTM, 0.99999950010466);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03912616184861351);
    AssertAlmostEqual(&test, rTM, 0.9999998724039155);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004234154117060605);
    AssertAlmostEqual(&test, rTM, 0.9999998819126944);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.237706091754952e-06);
    AssertAlmostEqual(&test, rTM, 0.999999882011652);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.237741649124185e-08);
    AssertAlmostEqual(&test, rTM, 0.999999882012642);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.237742004701644e-10);
    AssertAlmostEqual(&test, rTM, 0.9999998820126519);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9984210070371003);
    AssertAlmostEqual(&test, rTM, 0.9984210070372581);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9984210070292905);
    AssertAlmostEqual(&test, rTM, 0.9984210070450679);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9984210062483067);
    AssertAlmostEqual(&test, rTM, 0.9984210078260513);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.998420928151886);
    AssertAlmostEqual(&test, rTM, 0.9984210859185346);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9984131379651795);
    AssertAlmostEqual(&test, rTM, 0.9984288371180069);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9977676974412567);
    AssertAlmostEqual(&test, rTM, 0.9988832247791696);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9842443799871644);
    AssertAlmostEqual(&test, rTM, 0.9998427676415059);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8539624803798709);
    AssertAlmostEqual(&test, rTM, 0.9999841492628979);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2346006010882609);
    AssertAlmostEqual(&test, rTM, 0.9999979860237631);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.003972791030287089);
    AssertAlmostEqual(&test, rTM, 0.9999987414604169);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.004225621246968e-05);
    AssertAlmostEqual(&test, rTM, 0.9999987513206744);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.004543110086846e-07);
    AssertAlmostEqual(&test, rTM, 0.9999987514196702);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.004546285293059e-09);
    AssertAlmostEqual(&test, rTM, 0.9999987514206602);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9937973434863487);
    AssertAlmostEqual(&test, rTM, 0.993797343486355);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9937973434860427);
    AssertAlmostEqual(&test, rTM, 0.993797343486661);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.993797343455435);
    AssertAlmostEqual(&test, rTM, 0.9937973435172687);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9937973403946725);
    AssertAlmostEqual(&test, rTM, 0.9937973465780297);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9937970343261191);
    AssertAlmostEqual(&test, rTM, 0.9937976526312238);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9937665040725735);
    AssertAlmostEqual(&test, rTM, 0.9938280307984378);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9912394152515813);
    AssertAlmostEqual(&test, rTM, 0.9956100506948776);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9393943011456484);
    AssertAlmostEqual(&test, rTM, 0.9993807848077313);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5419372090664226);
    AssertAlmostEqual(&test, rTM, 0.9999348445185204);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02457694870135704);
    AssertAlmostEqual(&test, rTM, 0.9999796684455321);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002581773178428764);
    AssertAlmostEqual(&test, rTM, 0.999980633841684);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.583093486201003e-06);
    AssertAlmostEqual(&test, rTM, 0.999980643738815);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.583106697803545e-08);
    AssertAlmostEqual(&test, rTM, 0.9999806438378119);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9589038392938306);
    AssertAlmostEqual(&test, rTM, 0.9589038392938311);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9589038392938107);
    AssertAlmostEqual(&test, rTM, 0.9589038392938509);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9589038392918191);
    AssertAlmostEqual(&test, rTM, 0.9589038392958426);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9589038390926609);
    AssertAlmostEqual(&test, rTM, 0.9589038394950008);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9589038191768372);
    AssertAlmostEqual(&test, rTM, 0.9589038594108148);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9589018276463681);
    AssertAlmostEqual(&test, rTM, 0.9589058508448943);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9587031909474285);
    AssertAlmostEqual(&test, rTM, 0.9591035331073804);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9423840556023856);
    AssertAlmostEqual(&test, rTM, 0.9707583375657196);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6578992009083225);
    AssertAlmostEqual(&test, rTM, 0.9957431832446838);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05111584211103599);
    AssertAlmostEqual(&test, rTM, 0.9990253875325809);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005671257703722872);
    AssertAlmostEqual(&test, rTM, 0.9991191386728677);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.677636962066612e-06);
    AssertAlmostEqual(&test, rTM, 0.999120126798837);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.677700845222079e-08);
    AssertAlmostEqual(&test, rTM, 0.999120136685718);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6762211553476816);
    AssertAlmostEqual(&test, rTM, 0.6762211553476817);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6762211553476803);
    AssertAlmostEqual(&test, rTM, 0.6762211553476829);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.676221155347551);
    AssertAlmostEqual(&test, rTM, 0.6762211553478122);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6762211553346197);
    AssertAlmostEqual(&test, rTM, 0.6762211553607436);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.676221154041493);
    AssertAlmostEqual(&test, rTM, 0.6762211566538703);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6762210247288634);
    AssertAlmostEqual(&test, rTM, 0.6762212859664574);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6762080939260635);
    AssertAlmostEqual(&test, rTM, 0.6762342163441855);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6749195915653309);
    AssertAlmostEqual(&test, rTM, 0.6775185112480654);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5770237841759281);
    AssertAlmostEqual(&test, rTM, 0.7557575521130564);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05681514024308319);
    AssertAlmostEqual(&test, rTM, 0.919743588974357);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006441525109201361);
    AssertAlmostEqual(&test, rTM, 0.9279730914300056);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.450387100549084e-06);
    AssertAlmostEqual(&test, rTM, 0.9280615941629476);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.450475870134428e-08);
    AssertAlmostEqual(&test, rTM, 0.9280624798902911);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05802584100262816);
    AssertAlmostEqual(&test, rTM, 0.05802584100262816);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05802584100262815);
    AssertAlmostEqual(&test, rTM, 0.05802584100262816);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05802584100262764);
    AssertAlmostEqual(&test, rTM, 0.05802584100262867);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0580258410025765);
    AssertAlmostEqual(&test, rTM, 0.05802584100267982);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05802584099746204);
    AssertAlmostEqual(&test, rTM, 0.05802584100779427);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05802584048601656);
    AssertAlmostEqual(&test, rTM, 0.05802584151923976);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05802578934151381);
    AssertAlmostEqual(&test, rTM, 0.05802589266374219);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05802067534803731);
    AssertAlmostEqual(&test, rTM, 0.05803100665411182);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05751380339978292);
    AssertAlmostEqual(&test, rTM, 0.05853784807777984);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03071938549486962);
    AssertAlmostEqual(&test, rTM, 0.08524574630240679);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006466365500800252);
    AssertAlmostEqual(&test, rTM, 0.115024213699702);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.538744365649558e-06);
    AssertAlmostEqual(&test, rTM, 0.1156557961480686);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.539476365059378e-08);
    AssertAlmostEqual(&test, rTM, 0.1156621829036611);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006539957137054118);
    AssertAlmostEqual(&test, rTM, 0.0006539957137054118);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006539957137054118);
    AssertAlmostEqual(&test, rTM, 0.0006539957137054118);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006539957137054117);
    AssertAlmostEqual(&test, rTM, 0.0006539957137054118);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006539957137054052);
    AssertAlmostEqual(&test, rTM, 0.0006539957137054183);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006539957137047586);
    AssertAlmostEqual(&test, rTM, 0.0006539957137060649);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006539957136400976);
    AssertAlmostEqual(&test, rTM, 0.0006539957137707259);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006539957071740033);
    AssertAlmostEqual(&test, rTM, 0.0006539957202368203);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000653995060565212);
    AssertAlmostEqual(&test, rTM, 0.0006539963668456115);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006539304061424348);
    AssertAlmostEqual(&test, rTM, 0.0006540610212683832);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000647528888930339);
    AssertAlmostEqual(&test, rTM, 0.0006604625384257845);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003272117469916994);
    AssertAlmostEqual(&test, rTM, 0.0009807795407416483);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.483598839798642e-06);
    AssertAlmostEqual(&test, rTM, 0.001301507280167153);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.547864099885068e-08);
    AssertAlmostEqual(&test, rTM, 0.001307925389440554);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549338927351346e-06);
    AssertAlmostEqual(&test, rTM, 6.549338927351346e-06);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549338927351346e-06);
    AssertAlmostEqual(&test, rTM, 6.549338927351346e-06);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549338927351346e-06);
    AssertAlmostEqual(&test, rTM, 6.549338927351346e-06);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549338927351346e-06);
    AssertAlmostEqual(&test, rTM, 6.549338927351347e-06);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549338927351281e-06);
    AssertAlmostEqual(&test, rTM, 6.549338927351412e-06);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549338927344797e-06);
    AssertAlmostEqual(&test, rTM, 6.549338927357896e-06);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549338926696421e-06);
    AssertAlmostEqual(&test, rTM, 6.549338928006272e-06);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549338861858816e-06);
    AssertAlmostEqual(&test, rTM, 6.549338992843877e-06);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549332378104756e-06);
    AssertAlmostEqual(&test, rTM, 6.549345476597938e-06);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.548684067522449e-06);
    AssertAlmostEqual(&test, rTM, 6.549993787180245e-06);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.484494828444455e-06);
    AssertAlmostEqual(&test, rTM, 6.614183026258183e-06);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.274690910630981e-06);
    AssertAlmostEqual(&test, rTM, 9.823986943931251e-06);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.484578085613673e-08);
    AssertAlmostEqual(&test, rTM, 1.303383207329577e-05);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549514368909469e-08);
    AssertAlmostEqual(&test, rTM, 6.549514368909469e-08);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549514368909469e-08);
    AssertAlmostEqual(&test, rTM, 6.549514368909469e-08);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549514368909469e-08);
    AssertAlmostEqual(&test, rTM, 6.549514368909469e-08);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549514368909469e-08);
    AssertAlmostEqual(&test, rTM, 6.549514368909469e-08);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549514368909469e-08);
    AssertAlmostEqual(&test, rTM, 6.54951436890947e-08);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549514368909404e-08);
    AssertAlmostEqual(&test, rTM, 6.549514368909535e-08);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549514368902919e-08);
    AssertAlmostEqual(&test, rTM, 6.549514368916019e-08);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549514368254518e-08);
    AssertAlmostEqual(&test, rTM, 6.54951436956442e-08);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549514303414335e-08);
    AssertAlmostEqual(&test, rTM, 6.549514434404604e-08);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549507819402507e-08);
    AssertAlmostEqual(&test, rTM, 6.549520918416431e-08);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.548859483046948e-08);
    AssertAlmostEqual(&test, rTM, 6.55016925477199e-08);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.484667700399756e-08);
    AssertAlmostEqual(&test, rTM, 6.614361037419183e-08);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.27475739893543e-08);
    AssertAlmostEqual(&test, rTM, 9.824271338883494e-08);

    userdata[0] = 1/CAPS_HBAR_EV; /* 1eV */
    userdata[1] = 0.035/CAPS_HBAR_EV; /* 0.035eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999766112778121);
    AssertAlmostEqual(&test, rTM, 0.9999883055705259);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998338037687757);
    AssertAlmostEqual(&test, rTM, 0.9999983543573531);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.998347432746417);
    AssertAlmostEqual(&test, rTM, 0.9999998346230511);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.983597670228356);
    AssertAlmostEqual(&test, rTM, 0.9999999834609254);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8477264587619738);
    AssertAlmostEqual(&test, rTM, 0.9999999983405033);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2215488747920721);
    AssertAlmostEqual(&test, rTM, 0.9999999997853936);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.003629514668030815);
    AssertAlmostEqual(&test, rTM, 0.9999999998622423);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.655738254590493e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999998632287);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.65600288441913e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999998632386);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.656005530959261e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999998632387);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.656005557424686e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999998632387);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.656005557689341e-13);
    AssertAlmostEqual(&test, rTM, 0.9999999998632387);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.656005557691987e-15);
    AssertAlmostEqual(&test, rTM, 0.9999999998632387);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999474411373106);
    AssertAlmostEqual(&test, rTM, 0.9999479615085493);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999260402179738);
    AssertAlmostEqual(&test, rTM, 0.9999630194251928);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999474535671203);
    AssertAlmostEqual(&test, rTM, 0.9999947960288139);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9947834583812883);
    AssertAlmostEqual(&test, rTM, 0.9999994770305219);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9490503129266974);
    AssertAlmostEqual(&test, rTM, 0.9999999476827518);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5961816916495049);
    AssertAlmostEqual(&test, rTM, 0.9999999945942035);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0341085511114126);
    AssertAlmostEqual(&test, rTM, 0.9999999985357974);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003653332889188452);
    AssertAlmostEqual(&test, rTM, 0.9999999986313869);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.655976988476332e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999986323765);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.656003453631208e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999986323864);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.656003718285175e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999986323865);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.656003720931715e-12);
    AssertAlmostEqual(&test, rTM, 0.9999999986323865);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.656003720958181e-14);
    AssertAlmostEqual(&test, rTM, 0.9999999986323865);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994771280641537);
    AssertAlmostEqual(&test, rTM, 0.9994771285868884);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994771021894278);
    AssertAlmostEqual(&test, rTM, 0.9994771544603084);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994745211559339);
    AssertAlmostEqual(&test, rTM, 0.999479722562971);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9992606278786517);
    AssertAlmostEqual(&test, rTM, 0.9996302455675199);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9947576258827608);
    AssertAlmostEqual(&test, rTM, 0.9999479598945437);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9490464858594956);
    AssertAlmostEqual(&test, rTM, 0.9999947684032061);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5961732073415467);
    AssertAlmostEqual(&test, rTM, 0.9999994594048877);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03410679030011441);
    AssertAlmostEqual(&test, rTM, 0.9999998535721821);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003653131154436465);
    AssertAlmostEqual(&test, rTM, 0.9999998631311486);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.655774962000996e-06);
    AssertAlmostEqual(&test, rTM, 0.9999998632301121);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.65580142423464e-08);
    AssertAlmostEqual(&test, rTM, 0.9999998632311021);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.655801688859395e-10);
    AssertAlmostEqual(&test, rTM, 0.999999863231112);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.655801691505643e-12);
    AssertAlmostEqual(&test, rTM, 0.9999998632311121);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9983470545677463);
    AssertAlmostEqual(&test, rTM, 0.9983470545842621);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9983470537502153);
    AssertAlmostEqual(&test, rTM, 0.9983470554017927);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.998346971999163);
    AssertAlmostEqual(&test, rTM, 0.9983471371487237);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.998338817261247);
    AssertAlmostEqual(&test, rTM, 0.9983552510779684);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9976631829393596);
    AssertAlmostEqual(&test, rTM, 0.9988309076820179);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9835119893169477);
    AssertAlmostEqual(&test, rTM, 0.9998353976540457);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.847680484351195);
    AssertAlmostEqual(&test, rTM, 0.9999834013444551);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2214699599505299);
    AssertAlmostEqual(&test, rTM, 0.9999978530983735);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.00362750457215682);
    AssertAlmostEqual(&test, rTM, 0.9999986216620297);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.653699078676354e-05);
    AssertAlmostEqual(&test, rTM, 0.9999986315257379);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.653963413719306e-07);
    AssertAlmostEqual(&test, rTM, 0.999998631624734);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.653966057311176e-09);
    AssertAlmostEqual(&test, rTM, 0.999998631625724);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.653966083747119e-11);
    AssertAlmostEqual(&test, rTM, 0.9999986316257339);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9947692194635982);
    AssertAlmostEqual(&test, rTM, 0.9947692194641199);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9947692194377736);
    AssertAlmostEqual(&test, rTM, 0.9947692194899443);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9947692168553276);
    AssertAlmostEqual(&test, rTM, 0.9947692220723892);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9947689586172077);
    AssertAlmostEqual(&test, rTM, 0.9947694802975372);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.994743199373224);
    AssertAlmostEqual(&test, rTM, 0.9947951110964168);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.992610589733697);
    AssertAlmostEqual(&test, rTM, 0.9962984314061427);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9486639769323799);
    AssertAlmostEqual(&test, rTM, 0.9994781098849984);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5953265798408695);
    AssertAlmostEqual(&test, rTM, 0.9999457860780719);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03393162342052037);
    AssertAlmostEqual(&test, rTM, 0.9999852816734582);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003633069571820349);
    AssertAlmostEqual(&test, rTM, 0.9999862377243133);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.635684449474569e-06);
    AssertAlmostEqual(&test, rTM, 0.9999862476204763);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.63571062201366e-08);
    AssertAlmostEqual(&test, rTM, 0.9999862477194739);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.63571088374143e-10);
    AssertAlmostEqual(&test, rTM, 0.9999862477204639);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9831499352263409);
    AssertAlmostEqual(&test, rTM, 0.9831499352263575);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9831499352255139);
    AssertAlmostEqual(&test, rTM, 0.9831499352271845);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9831499351428147);
    AssertAlmostEqual(&test, rTM, 0.9831499353098836);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9831499268729031);
    AssertAlmostEqual(&test, rTM, 0.983149943579791);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9831490999027764);
    AssertAlmostEqual(&test, rTM, 0.9831507705088655);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9830666120897826);
    AssertAlmostEqual(&test, rTM, 0.9832328518262502);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9762541272309363);
    AssertAlmostEqual(&test, rTM, 0.9880553022796094);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8431763385071422);
    AssertAlmostEqual(&test, rTM, 0.9983044562389719);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2139376334361329);
    AssertAlmostEqual(&test, rTM, 0.9997770471649048);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.003438935276602306);
    AssertAlmostEqual(&test, rTM, 0.9998546290897512);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.462474040624998e-05);
    AssertAlmostEqual(&test, rTM, 0.9998556154360283);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.462711463813895e-07);
    AssertAlmostEqual(&test, rTM, 0.9998556253335381);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.462713838251311e-09);
    AssertAlmostEqual(&test, rTM, 0.9998556254325167);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9368118494083756);
    AssertAlmostEqual(&test, rTM, 0.9368118494083763);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9368118494083454);
    AssertAlmostEqual(&test, rTM, 0.9368118494084064);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9368118494053196);
    AssertAlmostEqual(&test, rTM, 0.9368118494114323);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9368118491027427);
    AssertAlmostEqual(&test, rTM, 0.9368118497140092);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.93681181884506);
    AssertAlmostEqual(&test, rTM, 0.9368118799716776);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.93680879315744);
    AssertAlmostEqual(&test, rTM, 0.9368149055163181);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9365070268674252);
    AssertAlmostEqual(&test, rTM, 0.9371152560529851);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9118376389819564);
    AssertAlmostEqual(&test, rTM, 0.9548784534056387);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5247317404513516);
    AssertAlmostEqual(&test, rTM, 0.9931938644586396);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02242032906496349);
    AssertAlmostEqual(&test, rTM, 0.9977760729164711);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000234518402975671);
    AssertAlmostEqual(&test, rTM, 0.9978725082091365);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.34627570721531e-06);
    AssertAlmostEqual(&test, rTM, 0.9978734948182886);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.346286630400463e-08);
    AssertAlmostEqual(&test, rTM, 0.9978735046867089);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6562684940151965);
    AssertAlmostEqual(&test, rTM, 0.6562684940151965);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6562684940151952);
    AssertAlmostEqual(&test, rTM, 0.6562684940151978);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6562684940150603);
    AssertAlmostEqual(&test, rTM, 0.6562684940153327);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6562684940015767);
    AssertAlmostEqual(&test, rTM, 0.6562684940288163);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6562684926532183);
    AssertAlmostEqual(&test, rTM, 0.6562684953771747);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6562683578174264);
    AssertAlmostEqual(&test, rTM, 0.6562686302129238);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6562548747296851);
    AssertAlmostEqual(&test, rTM, 0.6562821128730894);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6549114549656537);
    AssertAlmostEqual(&test, rTM, 0.6576213006371687);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5535506144149996);
    AssertAlmostEqual(&test, rTM, 0.7393188744173058);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04966753757272636);
    AssertAlmostEqual(&test, rTM, 0.9091762508584349);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005547757133592389);
    AssertAlmostEqual(&test, rTM, 0.917328539653878);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.554405915574067e-06);
    AssertAlmostEqual(&test, rTM, 0.9174155519793238);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.554472500817845e-08);
    AssertAlmostEqual(&test, rTM, 0.9174164227124796);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05719314937207796);
    AssertAlmostEqual(&test, rTM, 0.05719314937207796);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05719314937207795);
    AssertAlmostEqual(&test, rTM, 0.05719314937207796);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05719314937207744);
    AssertAlmostEqual(&test, rTM, 0.05719314937207847);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05719314937202695);
    AssertAlmostEqual(&test, rTM, 0.05719314937212897);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05719314936697746);
    AssertAlmostEqual(&test, rTM, 0.05719314937717845);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05719314886202837);
    AssertAlmostEqual(&test, rTM, 0.05719314988212754);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05719309836716478);
    AssertAlmostEqual(&test, rTM, 0.05719320037699083);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05718804933251204);
    AssertAlmostEqual(&test, rTM, 0.05719824940865888);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05668762274410544);
    AssertAlmostEqual(&test, rTM, 0.05769864667357876);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03025411464288585);
    AssertAlmostEqual(&test, rTM, 0.08404915689634287);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000636244978548875);
    AssertAlmostEqual(&test, rTM, 0.1133853346799279);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.43353306585185e-06);
    AssertAlmostEqual(&test, rTM, 0.1140070047302436);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.434251946686052e-08);
    AssertAlmostEqual(&test, rTM, 0.1140132911320524);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006529278511848426);
    AssertAlmostEqual(&test, rTM, 0.0006529278511848426);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006529278511848426);
    AssertAlmostEqual(&test, rTM, 0.0006529278511848426);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006529278511848426);
    AssertAlmostEqual(&test, rTM, 0.0006529278511848427);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006529278511848361);
    AssertAlmostEqual(&test, rTM, 0.0006529278511848491);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006529278511841906);
    AssertAlmostEqual(&test, rTM, 0.0006529278511854948);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006529278511196351);
    AssertAlmostEqual(&test, rTM, 0.0006529278512500502);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000652927844664085);
    AssertAlmostEqual(&test, rTM, 0.0006529278577056004);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006529271991097159);
    AssertAlmostEqual(&test, rTM, 0.0006529285032599694);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006528626501186463);
    AssertAlmostEqual(&test, rTM, 0.0006529930522510334);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006464715719698363);
    AssertAlmostEqual(&test, rTM, 0.0006593841303454163);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003266771177532214);
    AssertAlmostEqual(&test, rTM, 0.0009791784456217823);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.472998541632408e-06);
    AssertAlmostEqual(&test, rTM, 0.001299382158106121);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.5371585946511e-08);
    AssertAlmostEqual(&test, rTM, 0.001305789774189861);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.548266423478705e-06);
    AssertAlmostEqual(&test, rTM, 6.548266423478705e-06);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.548266423478705e-06);
    AssertAlmostEqual(&test, rTM, 6.548266423478705e-06);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.548266423478705e-06);
    AssertAlmostEqual(&test, rTM, 6.548266423478705e-06);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.548266423478704e-06);
    AssertAlmostEqual(&test, rTM, 6.548266423478706e-06);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54826642347864e-06);
    AssertAlmostEqual(&test, rTM, 6.54826642347877e-06);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.548266423472157e-06);
    AssertAlmostEqual(&test, rTM, 6.548266423485254e-06);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.548266422823887e-06);
    AssertAlmostEqual(&test, rTM, 6.548266424133524e-06);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.5482663579969e-06);
    AssertAlmostEqual(&test, rTM, 6.548266488960512e-06);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.548259875304589e-06);
    AssertAlmostEqual(&test, rTM, 6.548272971652822e-06);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.547611670886661e-06);
    AssertAlmostEqual(&test, rTM, 6.548921176070749e-06);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.483432943146632e-06);
    AssertAlmostEqual(&test, rTM, 6.613099903810724e-06);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.274154651671027e-06);
    AssertAlmostEqual(&test, rTM, 9.822378195145992e-06);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.483516173049964e-08);
    AssertAlmostEqual(&test, rTM, 1.30316976846764e-05);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549407096966269e-08);
    AssertAlmostEqual(&test, rTM, 6.549407096966269e-08);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549407096966269e-08);
    AssertAlmostEqual(&test, rTM, 6.549407096966269e-08);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549407096966269e-08);
    AssertAlmostEqual(&test, rTM, 6.549407096966269e-08);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549407096966269e-08);
    AssertAlmostEqual(&test, rTM, 6.549407096966269e-08);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549407096966268e-08);
    AssertAlmostEqual(&test, rTM, 6.549407096966269e-08);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549407096966203e-08);
    AssertAlmostEqual(&test, rTM, 6.549407096966334e-08);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549407096959719e-08);
    AssertAlmostEqual(&test, rTM, 6.549407096972818e-08);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549407096311327e-08);
    AssertAlmostEqual(&test, rTM, 6.54940709762121e-08);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549407031472207e-08);
    AssertAlmostEqual(&test, rTM, 6.54940716246033e-08);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549400547566579e-08);
    AssertAlmostEqual(&test, rTM, 6.549413646365958e-08);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.548752221829866e-08);
    AssertAlmostEqual(&test, rTM, 6.55006197210267e-08);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.484561490554727e-08);
    AssertAlmostEqual(&test, rTM, 6.61425270337781e-08);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.274703762956804e-08);
    AssertAlmostEqual(&test, rTM, 9.824110430975719e-08);

    userdata[0] = 1/CAPS_HBAR_EV; /* 1eV */
    userdata[1] = 0.05/CAPS_HBAR_EV; /* 0.05eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999720451941631);
    AssertAlmostEqual(&test, rTM, 0.9999860224993956);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998013607341848);
    AssertAlmostEqual(&test, rTM, 0.9999980330811572);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9980251232210332);
    AssertAlmostEqual(&test, rTM, 0.9999998023367151);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9804270890153469);
    AssertAlmostEqual(&test, rTM, 0.9999999802317355);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8209010794654567);
    AssertAlmostEqual(&test, rTM, 0.9999999980136376);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1744276057035822);
    AssertAlmostEqual(&test, rTM, 0.9999999997220695);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.00254618809556911);
    AssertAlmostEqual(&test, rTM, 0.9999999998036293);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559072951126269e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999998046167);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559202623337432e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999998046266);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559203920142499e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999998046267);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559203933110558e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999998046267);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559203933240239e-13);
    AssertAlmostEqual(&test, rTM, 0.9999999998046267);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559203933241535e-15);
    AssertAlmostEqual(&test, rTM, 0.9999999998046267);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999371804712041);
    AssertAlmostEqual(&test, rTM, 0.9999378024273934);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999116017982032);
    AssertAlmostEqual(&test, rTM, 0.9999557999222566);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993719822757097);
    AssertAlmostEqual(&test, rTM, 0.9999937800683465);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9937682231217991);
    AssertAlmostEqual(&test, rTM, 0.9999993749310865);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9394134486278178);
    AssertAlmostEqual(&test, rTM, 0.999999937459778);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5404554784586308);
    AssertAlmostEqual(&test, rTM, 0.9999999934508216);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02436035541998875);
    AssertAlmostEqual(&test, rTM, 0.9999999979487029);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002557893966683816);
    AssertAlmostEqual(&test, rTM, 0.9999999980452671);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559189934285387e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999980462567);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.55920290225154e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999980462667);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559203031932032e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999980462668);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559203033228837e-12);
    AssertAlmostEqual(&test, rTM, 0.9999999980462668);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559203033241805e-14);
    AssertAlmostEqual(&test, rTM, 0.9999999980462668);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993750856388054);
    AssertAlmostEqual(&test, rTM, 0.9993750862635239);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993750547160096);
    AssertAlmostEqual(&test, rTM, 0.9993751171847591);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993719701325591);
    AssertAlmostEqual(&test, rTM, 0.999378186316196);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991163524851085);
    AssertAlmostEqual(&test, rTM, 0.9995580785737094);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9937374307648765);
    AssertAlmostEqual(&test, rTM, 0.9999378009236274);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9394094080675028);
    AssertAlmostEqual(&test, rTM, 0.9999937461859377);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5404490820487861);
    AssertAlmostEqual(&test, rTM, 0.9999993450689396);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02435945769041677);
    AssertAlmostEqual(&test, rTM, 0.9999997948627553);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002557795071578966);
    AssertAlmostEqual(&test, rTM, 0.9999998045191834);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559090939203149e-06);
    AssertAlmostEqual(&test, rTM, 0.9999998046181577);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.55910390616857e-08);
    AssertAlmostEqual(&test, rTM, 0.9999998046191477);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559104035839054e-10);
    AssertAlmostEqual(&test, rTM, 0.9999998046191576);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559104037135759e-12);
    AssertAlmostEqual(&test, rTM, 0.9999998046191577);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9980248364887976);
    AssertAlmostEqual(&test, rTM, 0.9980248365085297);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9980248355120585);
    AssertAlmostEqual(&test, rTM, 0.9980248374852684);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.998024737840588);
    AssertAlmostEqual(&test, rTM, 0.9980249351518165);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9980149950350995);
    AssertAlmostEqual(&test, rTM, 0.9980346292171944);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9972078405394594);
    AssertAlmostEqual(&test, rTM, 0.9986029437053805);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9803266432624451);
    AssertAlmostEqual(&test, rTM, 0.9998032793375264);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8208614624724764);
    AssertAlmostEqual(&test, rTM, 0.9999801336583284);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1743795900423754);
    AssertAlmostEqual(&test, rTM, 0.9999972198911196);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002545198693410729);
    AssertAlmostEqual(&test, rTM, 0.999998035533424);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.558073543752507e-05);
    AssertAlmostEqual(&test, rTM, 0.9999980454079455);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.558203114951718e-07);
    AssertAlmostEqual(&test, rTM, 0.9999980455069426);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.558204410746569e-09);
    AssertAlmostEqual(&test, rTM, 0.9999980455079326);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.558204423704526e-11);
    AssertAlmostEqual(&test, rTM, 0.9999980455079425);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9937564102694029);
    AssertAlmostEqual(&test, rTM, 0.9937564102700254);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.993756410238594);
    AssertAlmostEqual(&test, rTM, 0.9937564103008343);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9937564071576962);
    AssertAlmostEqual(&test, rTM, 0.9937564133817305);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9937560990756683);
    AssertAlmostEqual(&test, rTM, 0.9937567214482987);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.993725367981775);
    AssertAlmostEqual(&test, rTM, 0.9937872994616844);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9911816767135825);
    AssertAlmostEqual(&test, rTM, 0.9955810532876661);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.939005708744943);
    AssertAlmostEqual(&test, rTM, 0.9993766828974835);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5398104566570995);
    AssertAlmostEqual(&test, rTM, 0.9999343747780592);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02427001775376452);
    AssertAlmostEqual(&test, rTM, 0.9999794110188196);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002547944030146036);
    AssertAlmostEqual(&test, rTM, 0.9999803767214867);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.549229958350886e-06);
    AssertAlmostEqual(&test, rTM, 0.9999803866186476);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.549242825826937e-08);
    AssertAlmostEqual(&test, rTM, 0.9999803867176444);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.549242954502517e-10);
    AssertAlmostEqual(&test, rTM, 0.9999803867186344);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9800521764661692);
    AssertAlmostEqual(&test, rTM, 0.9800521764661889);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9800521764651917);
    AssertAlmostEqual(&test, rTM, 0.9800521764671664);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9800521763674447);
    AssertAlmostEqual(&test, rTM, 0.9800521765649133);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9800521665927509);
    AssertAlmostEqual(&test, rTM, 0.9800521863396023);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.980051189148295);
    AssertAlmostEqual(&test, rTM, 0.9800531637356903);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9799536927423428);
    AssertAlmostEqual(&test, rTM, 0.9801501812086754);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9719069902716757);
    AssertAlmostEqual(&test, rTM, 0.9858527196718201);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8169653078376535);
    AssertAlmostEqual(&test, rTM, 0.9979870005950631);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1697563032584509);
    AssertAlmostEqual(&test, rTM, 0.9997140464645735);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002450903921987279);
    AssertAlmostEqual(&test, rTM, 0.9997960365723074);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.462843215974957e-05);
    AssertAlmostEqual(&test, rTM, 0.9997970238195171);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.462963343536032e-07);
    AssertAlmostEqual(&test, rTM, 0.9997970337162568);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.462964544885611e-09);
    AssertAlmostEqual(&test, rTM, 0.9997970338152267);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9289494298690386);
    AssertAlmostEqual(&test, rTM, 0.9289494298690393);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9289494298690048);
    AssertAlmostEqual(&test, rTM, 0.9289494298690731);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9289494298656172);
    AssertAlmostEqual(&test, rTM, 0.9289494298724607);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9289494295268714);
    AssertAlmostEqual(&test, rTM, 0.9289494302112065);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.928949395652295);
    AssertAlmostEqual(&test, rTM, 0.9289494640857671);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.928946008285672);
    AssertAlmostEqual(&test, rTM, 0.9289528512937092);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9286081773572921);
    AssertAlmostEqual(&test, rTM, 0.9292891110018014);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.901040242421558);
    AssertAlmostEqual(&test, rTM, 0.949197853542339);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4843834366677115);
    AssertAlmostEqual(&test, rTM, 0.9922187438557879);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01775233643073257);
    AssertAlmostEqual(&test, rTM, 0.9971924050051806);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001839486959401635);
    AssertAlmostEqual(&test, rTM, 0.9972892205541997);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.840158938004748e-06);
    AssertAlmostEqual(&test, rTM, 0.9972902063491302);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.840165660886721e-08);
    AssertAlmostEqual(&test, rTM, 0.9972902162089079);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6476040398182511);
    AssertAlmostEqual(&test, rTM, 0.6476040398182512);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6476040398182498);
    AssertAlmostEqual(&test, rTM, 0.6476040398182525);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6476040398181127);
    AssertAlmostEqual(&test, rTM, 0.6476040398183897);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6476040398044);
    AssertAlmostEqual(&test, rTM, 0.6476040398321024);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6476040384331304);
    AssertAlmostEqual(&test, rTM, 0.6476040412033719);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6476039013062314);
    AssertAlmostEqual(&test, rTM, 0.6476041783302281);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6475901891213922);
    AssertAlmostEqual(&test, rTM, 0.6476178900871674);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6462239950852067);
    AssertAlmostEqual(&test, rTM, 0.6489798490272491);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.543462885597726);
    AssertAlmostEqual(&test, rTM, 0.7321125567668543);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04690299179666507);
    AssertAlmostEqual(&test, rTM, 0.904310718765582);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005208968326844656);
    AssertAlmostEqual(&test, rTM, 0.9124225207965349);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.214861075131473e-06);
    AssertAlmostEqual(&test, rTM, 0.9125088492465582);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.21492008396738e-08);
    AssertAlmostEqual(&test, rTM, 0.9125097131066762);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0568110235581803);
    AssertAlmostEqual(&test, rTM, 0.0568110235581803);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05681102355818029);
    AssertAlmostEqual(&test, rTM, 0.0568110235581803);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05681102355817979);
    AssertAlmostEqual(&test, rTM, 0.0568110235581808);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05681102355812959);
    AssertAlmostEqual(&test, rTM, 0.056811023558231);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05681102355310999);
    AssertAlmostEqual(&test, rTM, 0.0568110235632506);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05681102305114991);
    AssertAlmostEqual(&test, rTM, 0.05681102406521069);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05681097285518611);
    AssertAlmostEqual(&test, rTM, 0.05681107426117419);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05680595370816383);
    AssertAlmostEqual(&test, rTM, 0.05681609340526684);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05630849257406233);
    AssertAlmostEqual(&test, rTM, 0.05731352575722301);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0300408407178514);
    AssertAlmostEqual(&test, rTM, 0.0834997648564936);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006314880416547106);
    AssertAlmostEqual(&test, rTM, 0.1126330800742559);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.385372063648603e-06);
    AssertAlmostEqual(&test, rTM, 0.1132502091117913);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.386084954016014e-08);
    AssertAlmostEqual(&test, rTM, 0.1132564495413013);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006524284901631336);
    AssertAlmostEqual(&test, rTM, 0.0006524284901631336);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006524284901631336);
    AssertAlmostEqual(&test, rTM, 0.0006524284901631336);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006524284901631335);
    AssertAlmostEqual(&test, rTM, 0.0006524284901631338);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006524284901631271);
    AssertAlmostEqual(&test, rTM, 0.0006524284901631401);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000652428490162482);
    AssertAlmostEqual(&test, rTM, 0.0006524284901637852);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006524284900979759);
    AssertAlmostEqual(&test, rTM, 0.0006524284902282914);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006524284836473565);
    AssertAlmostEqual(&test, rTM, 0.0006524284966789107);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000652427838586065);
    AssertAlmostEqual(&test, rTM, 0.0006524291417402023);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006523633388978311);
    AssertAlmostEqual(&test, rTM, 0.0006524936414284306);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006459771423488475);
    AssertAlmostEqual(&test, rTM, 0.0006588798379231118);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003264271112406273);
    AssertAlmostEqual(&test, rTM, 0.0009784297304094864);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.468041574618168e-06);
    AssertAlmostEqual(&test, rTM, 0.001298388394280857);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.532152430310355e-08);
    AssertAlmostEqual(&test, rTM, 0.001304791103484163);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.5477638081967e-06);
    AssertAlmostEqual(&test, rTM, 6.5477638081967e-06);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.5477638081967e-06);
    AssertAlmostEqual(&test, rTM, 6.5477638081967e-06);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.5477638081967e-06);
    AssertAlmostEqual(&test, rTM, 6.5477638081967e-06);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.547763808196699e-06);
    AssertAlmostEqual(&test, rTM, 6.5477638081967e-06);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.547763808196634e-06);
    AssertAlmostEqual(&test, rTM, 6.547763808196765e-06);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.547763808190152e-06);
    AssertAlmostEqual(&test, rTM, 6.547763808203247e-06);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.547763807541932e-06);
    AssertAlmostEqual(&test, rTM, 6.547763808851467e-06);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54776374271992e-06);
    AssertAlmostEqual(&test, rTM, 6.547763873673479e-06);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.547757260525185e-06);
    AssertAlmostEqual(&test, rTM, 6.547770355868214e-06);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.547109105859842e-06);
    AssertAlmostEqual(&test, rTM, 6.548418510533557e-06);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.482935304124507e-06);
    AssertAlmostEqual(&test, rTM, 6.612592312268838e-06);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.273903340738884e-06);
    AssertAlmostEqual(&test, rTM, 9.821624275514156e-06);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.483018521251566e-08);
    AssertAlmostEqual(&test, rTM, 1.30306974306305e-05);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549356814452514e-08);
    AssertAlmostEqual(&test, rTM, 6.549356814452514e-08);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549356814452514e-08);
    AssertAlmostEqual(&test, rTM, 6.549356814452514e-08);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549356814452514e-08);
    AssertAlmostEqual(&test, rTM, 6.549356814452514e-08);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549356814452514e-08);
    AssertAlmostEqual(&test, rTM, 6.549356814452514e-08);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549356814452513e-08);
    AssertAlmostEqual(&test, rTM, 6.549356814452514e-08);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549356814452448e-08);
    AssertAlmostEqual(&test, rTM, 6.549356814452579e-08);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549356814445964e-08);
    AssertAlmostEqual(&test, rTM, 6.549356814459063e-08);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549356813797578e-08);
    AssertAlmostEqual(&test, rTM, 6.549356815107449e-08);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549356748958955e-08);
    AssertAlmostEqual(&test, rTM, 6.549356879946073e-08);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549350265103107e-08);
    AssertAlmostEqual(&test, rTM, 6.549363363801921e-08);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.548701944343858e-08);
    AssertAlmostEqual(&test, rTM, 6.550011684561169e-08);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.484511705887514e-08);
    AssertAlmostEqual(&test, rTM, 6.614201923017513e-08);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.274678621696633e-08);
    AssertAlmostEqual(&test, rTM, 9.82403500720838e-08);

    userdata[0] = 1/CAPS_HBAR_EV; /* 1eV */
    userdata[1] = 0.1/CAPS_HBAR_EV; /* 0.1eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999604661637282);
    AssertAlmostEqual(&test, rTM, 0.9999802328864928);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997190932167693);
    AssertAlmostEqual(&test, rTM, 0.9999972183578433);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9972082457212463);
    AssertAlmostEqual(&test, rTM, 0.9999997204617795);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9724328058863566);
    AssertAlmostEqual(&test, rTM, 0.9999999720420873);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7568050467672996);
    AssertAlmostEqual(&test, rTM, 0.999999997177304);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.10296578292036);
    AssertAlmostEqual(&test, rTM, 0.9999999995195501);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001276337667696434);
    AssertAlmostEqual(&test, rTM, 0.9999999996082548);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279569245043182e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999996092435);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279601664144626e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999996092535);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.27960198834601e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999996092535);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279601991588025e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999996092535);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279601991620445e-13);
    AssertAlmostEqual(&test, rTM, 0.9999999996092535);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.27960199162077e-15);
    AssertAlmostEqual(&test, rTM, 0.9999999996092535);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999111609349441);
    AssertAlmostEqual(&test, rTM, 0.9999120404909616);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998749883651594);
    AssertAlmostEqual(&test, rTM, 0.9999374922289079);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991119644512938);
    AssertAlmostEqual(&test, rTM, 0.9999912037000638);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.991198340141214);
    AssertAlmostEqual(&test, rTM, 0.9999991160149486);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9154190098206079);
    AssertAlmostEqual(&test, rTM, 0.9999999115116328);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4242187512395012);
    AssertAlmostEqual(&test, rTM, 0.999999990334722);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01247865601496385);
    AssertAlmostEqual(&test, rTM, 0.9999999959937822);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001279274395205555);
    AssertAlmostEqual(&test, rTM, 0.9999999960915344);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279598491869922e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999960925243);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279601733873209e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999960925342);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279601766293345e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999960925343);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279601766617546e-12);
    AssertAlmostEqual(&test, rTM, 0.9999999960925343);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279601766620789e-14);
    AssertAlmostEqual(&test, rTM, 0.9999999960925343);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991163606714282);
    AssertAlmostEqual(&test, rTM, 0.9991163615546761);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999116316951742);
    AssertAlmostEqual(&test, rTM, 0.9991164052721566);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991119558669819);
    AssertAlmostEqual(&test, rTM, 0.9991207445159992);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9987505746781753);
    AssertAlmostEqual(&test, rTM, 0.9993750920231088);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9911549914387835);
    AssertAlmostEqual(&test, rTM, 0.9999120387896268);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9154142261610254);
    AssertAlmostEqual(&test, rTM, 0.999991151555139);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4242152642895281);
    AssertAlmostEqual(&test, rTM, 0.9999990334623692);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01247842048689627);
    AssertAlmostEqual(&test, rTM, 0.9999995993708161);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001279249658228926);
    AssertAlmostEqual(&test, rTM, 0.9999996091460387);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279573742483706e-06);
    AssertAlmostEqual(&test, rTM, 0.9999996092450258);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279576984362837e-08);
    AssertAlmostEqual(&test, rTM, 0.9999996092460158);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279577016781733e-10);
    AssertAlmostEqual(&test, rTM, 0.9999996092460258);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279577017105921e-12);
    AssertAlmostEqual(&test, rTM, 0.9999996092460259);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9972081128077699);
    AssertAlmostEqual(&test, rTM, 0.9972081128356497);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9972081114277179);
    AssertAlmostEqual(&test, rTM, 0.997208114215701);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9972079734259837);
    AssertAlmostEqual(&test, rTM, 0.9972082522104861);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9971942076732973);
    AssertAlmostEqual(&test, rTM, 0.997221949153838);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960539608118741);
    AssertAlmostEqual(&test, rTM, 0.9980250282252416);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9722945898271455);
    AssertAlmostEqual(&test, rTM, 0.9997218200209527);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7567741060847643);
    AssertAlmostEqual(&test, rTM, 0.9999717720678586);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1029493426439036);
    AssertAlmostEqual(&test, rTM, 0.9999951947428343);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001276089001794276);
    AssertAlmostEqual(&test, rTM, 0.9999960817997531);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279319331539414e-05);
    AssertAlmostEqual(&test, rTM, 0.9999960916869353);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279351738105027e-07);
    AssertAlmostEqual(&test, rTM, 0.9999960917859334);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279352062181047e-09);
    AssertAlmostEqual(&test, rTM, 0.9999960917869234);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279352065421808e-11);
    AssertAlmostEqual(&test, rTM, 0.9999960917869334);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9911902237018976);
    AssertAlmostEqual(&test, rTM, 0.9911902237027747);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9911902236584822);
    AssertAlmostEqual(&test, rTM, 0.9911902237461901);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.991190219316938);
    AssertAlmostEqual(&test, rTM, 0.9911902280877322);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.99118978517347);
    AssertAlmostEqual(&test, rTM, 0.9911906622094711);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9911464797673536);
    AssertAlmostEqual(&test, rTM, 0.991233752456548);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9875639065141799);
    AssertAlmostEqual(&test, rTM, 0.9937624391954201);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9149366326430387);
    AssertAlmostEqual(&test, rTM, 0.9991190429177941);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4238668887838007);
    AssertAlmostEqual(&test, rTM, 0.9999032480337134);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01245491247828691);
    AssertAlmostEqual(&test, rTM, 0.9999598630564425);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001276780782371855);
    AssertAlmostEqual(&test, rTM, 0.999960840543927);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.277103629306542e-06);
    AssertAlmostEqual(&test, rTM, 0.9999608504420689);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.277106858806546e-08);
    AssertAlmostEqual(&test, rTM, 0.999960850541063);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.277106891101649e-10);
    AssertAlmostEqual(&test, rTM, 0.999960850542053);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9721686095646991);
    AssertAlmostEqual(&test, rTM, 0.9721686095647265);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9721686095633408);
    AssertAlmostEqual(&test, rTM, 0.9721686095660848);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9721686094275196);
    AssertAlmostEqual(&test, rTM, 0.972168609701906);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9721685958454004);
    AssertAlmostEqual(&test, rTM, 0.9721686232840185);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9721672376683953);
    AssertAlmostEqual(&test, rTM, 0.9721699813943628);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9720317673843616);
    AssertAlmostEqual(&test, rTM, 0.972304791610484);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9608698610186748);
    AssertAlmostEqual(&test, rTM, 0.9802377476940243);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7537196740938393);
    AssertAlmostEqual(&test, rTM, 0.9971677816664118);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1013472891023817);
    AssertAlmostEqual(&test, rTM, 0.9995119794246028);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001251939234622125);
    AssertAlmostEqual(&test, rTM, 0.9996007798601301);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.255049573793375e-05);
    AssertAlmostEqual(&test, rTM, 0.9996017680162866);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.255080774754799e-07);
    AssertAlmostEqual(&test, rTM, 0.9996017779102482);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.255081086774204e-09);
    AssertAlmostEqual(&test, rTM, 0.999601778009189);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9079053108836349);
    AssertAlmostEqual(&test, rTM, 0.9079053108836358);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9079053108835915);
    AssertAlmostEqual(&test, rTM, 0.9079053108836792);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9079053108792529);
    AssertAlmostEqual(&test, rTM, 0.9079053108880178);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.907905310445389);
    AssertAlmostEqual(&test, rTM, 0.9079053113218817);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9079052670590105);
    AssertAlmostEqual(&test, rTM, 0.9079053547082403);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9079009285403404);
    AssertAlmostEqual(&test, rTM, 0.9079096930284706);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9074682624586705);
    AssertAlmostEqual(&test, rTM, 0.9083403942244029);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.872335245154248);
    AssertAlmostEqual(&test, rTM, 0.9339146140361048);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3919097588691506);
    AssertAlmostEqual(&test, rTM, 0.9893899239093975);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01048037401425547);
    AssertAlmostEqual(&test, rTM, 0.9952525883422696);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001070232131794294);
    AssertAlmostEqual(&test, rTM, 0.9953498437160606);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.070460015921595e-06);
    AssertAlmostEqual(&test, rTM, 0.995350826714998);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.070462295374352e-08);
    AssertAlmostEqual(&test, rTM, 0.9953508365460542);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6212976663489552);
    AssertAlmostEqual(&test, rTM, 0.6212976663489552);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6212976663489538);
    AssertAlmostEqual(&test, rTM, 0.6212976663489567);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6212976663488101);
    AssertAlmostEqual(&test, rTM, 0.6212976663491003);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6212976663344429);
    AssertAlmostEqual(&test, rTM, 0.6212976663634675);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6212976648977295);
    AssertAlmostEqual(&test, rTM, 0.6212976678001808);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6212975212264453);
    AssertAlmostEqual(&test, rTM, 0.6212978114714225);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6212831546445051);
    AssertAlmostEqual(&test, rTM, 0.6213121776272253);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6198519326646841);
    AssertAlmostEqual(&test, rTM, 0.622739182323004);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5132335499853441);
    AssertAlmostEqual(&test, rTM, 0.709969234688272);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03956560366247851);
    AssertAlmostEqual(&test, rTM, 0.8884765392735432);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004327970862134223);
    AssertAlmostEqual(&test, rTM, 0.8964414842780565);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.332110867149633e-06);
    AssertAlmostEqual(&test, rTM, 0.89652559934862);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.332152315238647e-08);
    AssertAlmostEqual(&test, rTM, 0.8965264409853377);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05557345736897762);
    AssertAlmostEqual(&test, rTM, 0.05557345736897762);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05557345736897762);
    AssertAlmostEqual(&test, rTM, 0.05557345736897763);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05557345736897713);
    AssertAlmostEqual(&test, rTM, 0.05557345736897812);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0555734573689279);
    AssertAlmostEqual(&test, rTM, 0.05557345736902734);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05557345736400544);
    AssertAlmostEqual(&test, rTM, 0.0555734573739498);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05557345687175928);
    AssertAlmostEqual(&test, rTM, 0.05557345786619595);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05557340764718826);
    AssertAlmostEqual(&test, rTM, 0.05557350709076671);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05556848563178084);
    AssertAlmostEqual(&test, rTM, 0.05557842910341855);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05508066163348156);
    AssertAlmostEqual(&test, rTM, 0.05606622603057572);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02935116395116614);
    AssertAlmostEqual(&test, rTM, 0.08171931191298329);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006161328194671334);
    AssertAlmostEqual(&test, rTM, 0.1101960947869051);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.229916262624601e-06);
    AssertAlmostEqual(&test, rTM, 0.1107985510416759);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.230609879431258e-08);
    AssertAlmostEqual(&test, rTM, 0.1108046429321275);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006507694559152936);
    AssertAlmostEqual(&test, rTM, 0.0006507694559152936);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006507694559152936);
    AssertAlmostEqual(&test, rTM, 0.0006507694559152936);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006507694559152935);
    AssertAlmostEqual(&test, rTM, 0.0006507694559152936);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006507694559152871);
    AssertAlmostEqual(&test, rTM, 0.0006507694559153001);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006507694559146436);
    AssertAlmostEqual(&test, rTM, 0.0006507694559159435);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006507694558503013);
    AssertAlmostEqual(&test, rTM, 0.0006507694559802859);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006507694494160637);
    AssertAlmostEqual(&test, rTM, 0.0006507694624145236);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006507688059929377);
    AssertAlmostEqual(&test, rTM, 0.0006507701058376495);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006507044701049257);
    AssertAlmostEqual(&test, rTM, 0.000650834441725656);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006443344918340589);
    AssertAlmostEqual(&test, rTM, 0.0006572044199426332);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003255965128277765);
    AssertAlmostEqual(&test, rTM, 0.0009759422613814142);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.451573042784301e-06);
    AssertAlmostEqual(&test, rTM, 0.00129508679845996);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.51552045090094e-08);
    AssertAlmostEqual(&test, rTM, 0.001301473205533799);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546088981025428e-06);
    AssertAlmostEqual(&test, rTM, 6.546088981025428e-06);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546088981025428e-06);
    AssertAlmostEqual(&test, rTM, 6.546088981025428e-06);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546088981025428e-06);
    AssertAlmostEqual(&test, rTM, 6.546088981025428e-06);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546088981025427e-06);
    AssertAlmostEqual(&test, rTM, 6.546088981025428e-06);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546088981025361e-06);
    AssertAlmostEqual(&test, rTM, 6.546088981025493e-06);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546088981018881e-06);
    AssertAlmostEqual(&test, rTM, 6.546088981031973e-06);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546088980370827e-06);
    AssertAlmostEqual(&test, rTM, 6.546088981680027e-06);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546088915565395e-06);
    AssertAlmostEqual(&test, rTM, 6.546089046485459e-06);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546082435028694e-06);
    AssertAlmostEqual(&test, rTM, 6.54609552702216e-06);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.545434446150155e-06);
    AssertAlmostEqual(&test, rTM, 6.546743515900699e-06);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.481277058970522e-06);
    AssertAlmostEqual(&test, rTM, 6.610900903080278e-06);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.27306591618825e-06);
    AssertAlmostEqual(&test, rTM, 9.819112045722352e-06);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.481360233531243e-08);
    AssertAlmostEqual(&test, rTM, 1.302736435916558e-05);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549189211649316e-08);
    AssertAlmostEqual(&test, rTM, 6.549189211649316e-08);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549189211649316e-08);
    AssertAlmostEqual(&test, rTM, 6.549189211649316e-08);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549189211649316e-08);
    AssertAlmostEqual(&test, rTM, 6.549189211649316e-08);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549189211649316e-08);
    AssertAlmostEqual(&test, rTM, 6.549189211649316e-08);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549189211649316e-08);
    AssertAlmostEqual(&test, rTM, 6.549189211649318e-08);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549189211649251e-08);
    AssertAlmostEqual(&test, rTM, 6.549189211649382e-08);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549189211642768e-08);
    AssertAlmostEqual(&test, rTM, 6.549189211655866e-08);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549189210994397e-08);
    AssertAlmostEqual(&test, rTM, 6.549189212304236e-08);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549189146157433e-08);
    AssertAlmostEqual(&test, rTM, 6.5491892771412e-08);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549182662467512e-08);
    AssertAlmostEqual(&test, rTM, 6.549195760831121e-08);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.548534358299261e-08);
    AssertAlmostEqual(&test, rTM, 6.549844064999371e-08);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.484345762517581e-08);
    AssertAlmostEqual(&test, rTM, 6.614032660781051e-08);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.274594820284058e-08);
    AssertAlmostEqual(&test, rTM, 9.823783603014561e-08);

    userdata[0] = 1/CAPS_HBAR_EV; /* 1eV */
    userdata[1] = 0.5/CAPS_HBAR_EV; /* 0.5eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999116018153004);
    AssertAlmostEqual(&test, rTM, 0.9999557999308055);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993719823971423);
    AssertAlmostEqual(&test, rTM, 0.9999937800695495);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9937682243233786);
    AssertAlmostEqual(&test, rTM, 0.9999993749312074);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9394134599803505);
    AssertAlmostEqual(&test, rTM, 0.9999999374597901);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5404555408275976);
    AssertAlmostEqual(&test, rTM, 0.999999993450823);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02436036439532175);
    AssertAlmostEqual(&test, rTM, 0.9999999979487035);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002557894955670952);
    AssertAlmostEqual(&test, rTM, 0.9999999980452677);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559190924274862e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999980462575);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559203892251049e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999980462674);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.55920402193164e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999980462675);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559204023228446e-12);
    AssertAlmostEqual(&test, rTM, 0.9999999980462675);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559204023241414e-14);
    AssertAlmostEqual(&test, rTM, 0.9999999980462675);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559204023241544e-16);
    AssertAlmostEqual(&test, rTM, 0.9999999980462675);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998013607341848);
    AssertAlmostEqual(&test, rTM, 0.9998033272661691);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997204871061133);
    AssertAlmostEqual(&test, rTM, 0.9998602337850767);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9980153823145078);
    AssertAlmostEqual(&test, rTM, 0.9999803309762495);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9804261297568307);
    AssertAlmostEqual(&test, rTM, 0.9999980232733424);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8209009995312806);
    AssertAlmostEqual(&test, rTM, 0.9999998013638749);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1744276044896922);
    AssertAlmostEqual(&test, rTM, 0.9999999722069514);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002546188095318319);
    AssertAlmostEqual(&test, rTM, 0.9999999803629296);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559072951123736e-05);
    AssertAlmostEqual(&test, rTM, 0.999999980461675);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559202623337408e-07);
    AssertAlmostEqual(&test, rTM, 0.999999980462665);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559203920142499e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999804626749);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559203933110558e-11);
    AssertAlmostEqual(&test, rTM, 0.999999980462675);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559203933240239e-13);
    AssertAlmostEqual(&test, rTM, 0.999999980462675);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559203933241536e-15);
    AssertAlmostEqual(&test, rTM, 0.999999980462675);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9980252170576374);
    AssertAlmostEqual(&test, rTM, 0.9980252190304665);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9980251194050156);
    AssertAlmostEqual(&test, rTM, 0.9980253166781669);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9980153784796867);
    AssertAlmostEqual(&test, rTM, 0.9980350088727724);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9972083796841893);
    AssertAlmostEqual(&test, rTM, 0.9986032136552389);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.980330409570928);
    AssertAlmostEqual(&test, rTM, 0.9998033173758946);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8208926940026255);
    AssertAlmostEqual(&test, rTM, 0.9999801375368607);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1744270087790948);
    AssertAlmostEqual(&test, rTM, 0.9999972206943142);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002546178270658751);
    AssertAlmostEqual(&test, rTM, 0.9999980362892108);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559063051922814e-05);
    AssertAlmostEqual(&test, rTM, 0.9999980461637225);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559192723384079e-07);
    AssertAlmostEqual(&test, rTM, 0.9999980462627196);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559194020181646e-09);
    AssertAlmostEqual(&test, rTM, 0.9999980462637096);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.55919403314963e-11);
    AssertAlmostEqual(&test, rTM, 0.9999980462637196);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.55919403327931e-13);
    AssertAlmostEqual(&test, rTM, 0.9999980462637197);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9937684135316335);
    AssertAlmostEqual(&test, rTM, 0.9937684135937546);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9937684104566401);
    AssertAlmostEqual(&test, rTM, 0.9937684166687465);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9937681029650366);
    AssertAlmostEqual(&test, rTM, 0.9937687241449197);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9937374307648765);
    AssertAlmostEqual(&test, rTM, 0.9937992435560925);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9911986079115334);
    AssertAlmostEqual(&test, rTM, 0.995589556549874);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.939119644666793);
    AssertAlmostEqual(&test, rTM, 0.9993778857691972);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5404331211363113);
    AssertAlmostEqual(&test, rTM, 0.9999345126034156);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02435943472153494);
    AssertAlmostEqual(&test, rTM, 0.9999794866831608);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002557795046269746);
    AssertAlmostEqual(&test, rTM, 0.9999804522965331);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559090938949801e-06);
    AssertAlmostEqual(&test, rTM, 0.9999804621936853);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559103906166037e-08);
    AssertAlmostEqual(&test, rTM, 0.9999804622926821);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559104035839029e-10);
    AssertAlmostEqual(&test, rTM, 0.9999804622936721);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559104037135759e-12);
    AssertAlmostEqual(&test, rTM, 0.999980462293682);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9804233132321302);
    AssertAlmostEqual(&test, rTM, 0.9804233132340685);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9804233131361835);
    AssertAlmostEqual(&test, rTM, 0.9804233133300152);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9804233035415172);
    AssertAlmostEqual(&test, rTM, 0.9804233229246767);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9804223440993476);
    AssertAlmostEqual(&test, rTM, 0.9804242823193513);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9803266432624451);
    AssertAlmostEqual(&test, rTM, 0.9805195128643143);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9724275096610522);
    AssertAlmostEqual(&test, rTM, 0.986116717890011);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8200644197046066);
    AssertAlmostEqual(&test, rTM, 0.9980251551288688);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1743674541654138);
    AssertAlmostEqual(&test, rTM, 0.9997220612088143);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002545196186460466);
    AssertAlmostEqual(&test, rTM, 0.9998035914443765);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.558073518428875e-05);
    AssertAlmostEqual(&test, rTM, 0.9998045786085208);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.558203114698457e-07);
    AssertAlmostEqual(&test, rTM, 0.9998045885053632);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.558204410744037e-09);
    AssertAlmostEqual(&test, rTM, 0.9998045886043342);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.558204423704501e-11);
    AssertAlmostEqual(&test, rTM, 0.999804588605324);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9392989363311388);
    AssertAlmostEqual(&test, rTM, 0.9392989363311977);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9392989363282283);
    AssertAlmostEqual(&test, rTM, 0.9392989363341083);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9392989360371629);
    AssertAlmostEqual(&test, rTM, 0.9392989366251737);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9392989069306317);
    AssertAlmostEqual(&test, rTM, 0.939298965731691);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9392959963548961);
    AssertAlmostEqual(&test, rTM, 0.93930187616951);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.939005708744943);
    AssertAlmostEqual(&test, rTM, 0.9395907981558361);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9152612745392662);
    AssertAlmostEqual(&test, rTM, 0.9566721394049894);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5382200971155761);
    AssertAlmostEqual(&test, rTM, 0.9934941879724927);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02426772910543652);
    AssertAlmostEqual(&test, rTM, 0.9979452003769135);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002547941508969058);
    AssertAlmostEqual(&test, rTM, 0.9980414760139504);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.549229933113638e-06);
    AssertAlmostEqual(&test, rTM, 0.9980424628534044);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.549242825574561e-08);
    AssertAlmostEqual(&test, rTM, 0.9980424727243284);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.549242954499993e-10);
    AssertAlmostEqual(&test, rTM, 0.9980424728230379);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8177825976396287);
    AssertAlmostEqual(&test, rTM, 0.8177825976396303);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8177825976395475);
    AssertAlmostEqual(&test, rTM, 0.8177825976397115);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8177825976314319);
    AssertAlmostEqual(&test, rTM, 0.8177825976478271);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8177825968198713);
    AssertAlmostEqual(&test, rTM, 0.8177825984593877);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8177825156638334);
    AssertAlmostEqual(&test, rTM, 0.8177826796153924);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.817774400305614);
    AssertAlmostEqual(&test, rTM, 0.8177907946418547);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8169653078376535);
    AssertAlmostEqual(&test, rTM, 0.818596602413426);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7527622255770283);
    AssertAlmostEqual(&test, rTM, 0.8670009502727115);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1685721770971581);
    AssertAlmostEqual(&test, rTM, 0.9721473723726332);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002450662492989408);
    AssertAlmostEqual(&test, rTM, 0.9800063983147079);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.462840777882707e-05);
    AssertAlmostEqual(&test, rTM, 0.9801022110484618);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.462963319152707e-07);
    AssertAlmostEqual(&test, rTM, 0.980103171672307);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.462964544641778e-09);
    AssertAlmostEqual(&test, rTM, 0.9801031812787963);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4860568632231505);
    AssertAlmostEqual(&test, rTM, 0.4860568632231506);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4860568632231488);
    AssertAlmostEqual(&test, rTM, 0.4860568632231522);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4860568632229824);
    AssertAlmostEqual(&test, rTM, 0.4860568632233186);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4860568632063406);
    AssertAlmostEqual(&test, rTM, 0.4860568632399605);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4860568615421544);
    AssertAlmostEqual(&test, rTM, 0.4860568649041467);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.48605669512361);
    AssertAlmostEqual(&test, rTM, 0.486057031322655);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4860400540226439);
    AssertAlmostEqual(&test, rTM, 0.4860736720640308);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4843834366677116);
    AssertAlmostEqual(&test, rTM, 0.4877267330081176);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.367770329661313);
    AssertAlmostEqual(&test, rTM, 0.5888648948491695);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01758434176800726);
    AssertAlmostEqual(&test, rTM, 0.7795344095340413);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001839304935373611);
    AssertAlmostEqual(&test, rTM, 0.7862697078241864);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.840157116255926e-06);
    AssertAlmostEqual(&test, rTM, 0.7863392163114402);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.840165642669082e-08);
    AssertAlmostEqual(&test, rTM, 0.7863399116210108);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04732962144388721);
    AssertAlmostEqual(&test, rTM, 0.04732962144388721);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04732962144388721);
    AssertAlmostEqual(&test, rTM, 0.04732962144388722);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04732962144388678);
    AssertAlmostEqual(&test, rTM, 0.04732962144388764);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04732962144384417);
    AssertAlmostEqual(&test, rTM, 0.04732962144393026);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04732962143958203);
    AssertAlmostEqual(&test, rTM, 0.0473296214481924);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04732962101336823);
    AssertAlmostEqual(&test, rTM, 0.0473296218744062);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04732957839202814);
    AssertAlmostEqual(&test, rTM, 0.04732966449574612);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04732531664650583);
    AssertAlmostEqual(&test, rTM, 0.04733392623951051);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04690299179666507);
    AssertAlmostEqual(&test, rTM, 0.04775623382392745);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02479746872595461);
    AssertAlmostEqual(&test, rTM, 0.06981371070921476);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005157962766428424);
    AssertAlmostEqual(&test, rTM, 0.09393645122286898);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.214344860890464e-06);
    AssertAlmostEqual(&test, rTM, 0.09444250348060269);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.214914921202198e-08);
    AssertAlmostEqual(&test, rTM, 0.09444761963020154);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006377948719834836);
    AssertAlmostEqual(&test, rTM, 0.0006377948719834836);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006377948719834836);
    AssertAlmostEqual(&test, rTM, 0.0006377948719834836);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006377948719834835);
    AssertAlmostEqual(&test, rTM, 0.0006377948719834836);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006377948719834772);
    AssertAlmostEqual(&test, rTM, 0.0006377948719834899);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006377948719828465);
    AssertAlmostEqual(&test, rTM, 0.0006377948719841206);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006377948719197854);
    AssertAlmostEqual(&test, rTM, 0.0006377948720471818);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006377948656136654);
    AssertAlmostEqual(&test, rTM, 0.0006377948783533018);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006377942350022938);
    AssertAlmostEqual(&test, rTM, 0.0006377955089646733);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006377311801619547);
    AssertAlmostEqual(&test, rTM, 0.0006378585638050072);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006314880416547106);
    AssertAlmostEqual(&test, rTM, 0.0006441017022615184);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003191008595508734);
    AssertAlmostEqual(&test, rTM, 0.000956488754859707);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.322783564595777e-06);
    AssertAlmostEqual(&test, rTM, 0.001269266451752237);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.385452794902219e-08);
    AssertAlmostEqual(&test, rTM, 0.001275525370655795);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.532721145291606e-06);
    AssertAlmostEqual(&test, rTM, 6.532721145291606e-06);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.532721145291606e-06);
    AssertAlmostEqual(&test, rTM, 6.532721145291606e-06);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.532721145291606e-06);
    AssertAlmostEqual(&test, rTM, 6.532721145291606e-06);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.532721145291605e-06);
    AssertAlmostEqual(&test, rTM, 6.532721145291606e-06);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.53272114529154e-06);
    AssertAlmostEqual(&test, rTM, 6.532721145291671e-06);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.532721145285072e-06);
    AssertAlmostEqual(&test, rTM, 6.532721145298138e-06);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.532721144638342e-06);
    AssertAlmostEqual(&test, rTM, 6.532721145944869e-06);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.532721079965248e-06);
    AssertAlmostEqual(&test, rTM, 6.532721210617963e-06);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.532714612662345e-06);
    AssertAlmostEqual(&test, rTM, 6.532727677920866e-06);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.532067947031282e-06);
    AssertAlmostEqual(&test, rTM, 6.533374343551929e-06);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.46804157461817e-06);
    AssertAlmostEqual(&test, rTM, 6.597400715964986e-06);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.266381910903432e-06);
    AssertAlmostEqual(&test, rTM, 9.799060379540384e-06);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.468124409820832e-08);
    AssertAlmostEqual(&test, rTM, 1.30007610459384e-05);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.547848697974119e-08);
    AssertAlmostEqual(&test, rTM, 6.547848697974119e-08);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.547848697974119e-08);
    AssertAlmostEqual(&test, rTM, 6.547848697974119e-08);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.547848697974119e-08);
    AssertAlmostEqual(&test, rTM, 6.547848697974119e-08);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.547848697974119e-08);
    AssertAlmostEqual(&test, rTM, 6.547848697974119e-08);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.547848697974117e-08);
    AssertAlmostEqual(&test, rTM, 6.547848697974119e-08);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.547848697974053e-08);
    AssertAlmostEqual(&test, rTM, 6.547848697974184e-08);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54784869796757e-08);
    AssertAlmostEqual(&test, rTM, 6.547848697980666e-08);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.547848697319333e-08);
    AssertAlmostEqual(&test, rTM, 6.547848698628903e-08);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.547848632495641e-08);
    AssertAlmostEqual(&test, rTM, 6.547848763452597e-08);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.547842150132826e-08);
    AssertAlmostEqual(&test, rTM, 6.54785524581541e-08);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.547193978661992e-08);
    AssertAlmostEqual(&test, rTM, 6.548503417286244e-08);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.483018521251567e-08);
    AssertAlmostEqual(&test, rTM, 6.612678874696669e-08);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.273924563358675e-08);
    AssertAlmostEqual(&test, rTM, 9.821772832589547e-08);

    userdata[0] = 1/CAPS_HBAR_EV; /* 1eV */
    userdata[1] = 1/CAPS_HBAR_EV; /* 1eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998749883772485);
    AssertAlmostEqual(&test, rTM, 0.9999374922349529);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991119645371374);
    AssertAlmostEqual(&test, rTM, 0.9999912037009144);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9911983409886577);
    AssertAlmostEqual(&test, rTM, 0.9999991160150342);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9154190176392102);
    AssertAlmostEqual(&test, rTM, 0.9999999115116414);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4242187844114452);
    AssertAlmostEqual(&test, rTM, 0.9999999903347231);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01247865836908448);
    AssertAlmostEqual(&test, rTM, 0.999999995993783);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001279274642578887);
    AssertAlmostEqual(&test, rTM, 0.9999999960915352);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279598739368607e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999960925251);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279601981373147e-08);
    AssertAlmostEqual(&test, rTM, 0.999999996092535);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279602013793296e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999960925351);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279602014117498e-12);
    AssertAlmostEqual(&test, rTM, 0.9999999960925351);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.27960201412074e-14);
    AssertAlmostEqual(&test, rTM, 0.9999999960925351);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279602014120772e-16);
    AssertAlmostEqual(&test, rTM, 0.9999999960925351);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997190932167693);
    AssertAlmostEqual(&test, rTM, 0.9997218740852249);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996047319640061);
    AssertAlmostEqual(&test, rTM, 0.9998023464466093);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.997194481309188);
    AssertAlmostEqual(&test, rTM, 0.9999721838999862);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9724314604174734);
    AssertAlmostEqual(&test, rTM, 0.999997204351012);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7568049430502729);
    AssertAlmostEqual(&test, rTM, 0.9999997177305816);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1029657820913208);
    AssertAlmostEqual(&test, rTM, 0.99999995195501);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001276337667570398);
    AssertAlmostEqual(&test, rTM, 0.9999999608254792);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279569245041915e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999609243515);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279601664144614e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999609253415);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.27960198834601e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999609253514);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279601991588025e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999609253515);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279601991620446e-13);
    AssertAlmostEqual(&test, rTM, 0.9999999609253515);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.27960199162077e-15);
    AssertAlmostEqual(&test, rTM, 0.9999999609253515);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9972083810135504);
    AssertAlmostEqual(&test, rTM, 0.9972083838012645);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9972082430251229);
    AssertAlmostEqual(&test, rTM, 0.9972085217827436);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9971944785997903);
    AssertAlmostEqual(&test, rTM, 0.9972222174053579);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960543416220193);
    AssertAlmostEqual(&test, rTM, 0.9980252190076433);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9722972311878215);
    AssertAlmostEqual(&test, rTM, 0.9997218469211765);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.756794369041208);
    AssertAlmostEqual(&test, rTM, 0.999971774849637);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.102965537215741);
    AssertAlmostEqual(&test, rTM, 0.9999951955148018);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001276335192579302);
    AssertAlmostEqual(&test, rTM, 0.9999960825555295);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279566770046799e-05);
    AssertAlmostEqual(&test, rTM, 0.9999960924427094);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279599189149498e-07);
    AssertAlmostEqual(&test, rTM, 0.9999960925417075);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279599513350894e-09);
    AssertAlmostEqual(&test, rTM, 0.9999960925426975);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279599516592909e-11);
    AssertAlmostEqual(&test, rTM, 0.9999960925427074);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.27959951662533e-13);
    AssertAlmostEqual(&test, rTM, 0.9999960925427075);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.991198693462591);
    AssertAlmostEqual(&test, rTM, 0.9911986935502151);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9911986891252023);
    AssertAlmostEqual(&test, rTM, 0.9911986978876017);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9911982553972627);
    AssertAlmostEqual(&test, rTM, 0.9911991315938329);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9911549914387835);
    AssertAlmostEqual(&test, rTM, 0.991242180597361);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9875758407078896);
    AssertAlmostEqual(&test, rTM, 0.9937684439032862);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9150151310039355);
    AssertAlmostEqual(&test, rTM, 0.9991198949066206);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4241982863740558);
    AssertAlmostEqual(&test, rTM, 0.9999033567318637);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01247840843777971);
    AssertAlmostEqual(&test, rTM, 0.9999599386519099);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001279249645567595);
    AssertAlmostEqual(&test, rTM, 0.9999609161160131);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279573742357029e-06);
    AssertAlmostEqual(&test, rTM, 0.9999609260141538);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279576984361571e-08);
    AssertAlmostEqual(&test, rTM, 0.9999609261131478);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.27957701678172e-10);
    AssertAlmostEqual(&test, rTM, 0.9999609261141378);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279577017105921e-12);
    AssertAlmostEqual(&test, rTM, 0.9999609261141477);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.972430164567277);
    AssertAlmostEqual(&test, rTM, 0.9724301645699955);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9724301644327139);
    AssertAlmostEqual(&test, rTM, 0.9724301647045587);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9724301509764021);
    AssertAlmostEqual(&test, rTM, 0.9724301781608639);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9724288053798036);
    AssertAlmostEqual(&test, rTM, 0.972431523691401);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9722945898271455);
    AssertAlmostEqual(&test, rTM, 0.9725650851117325);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9612354409672108);
    AssertAlmostEqual(&test, rTM, 0.9804242595326389);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.755740241385508);
    AssertAlmostEqual(&test, rTM, 0.997195251394973);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1029410539824989);
    AssertAlmostEqual(&test, rTM, 0.9995196894985152);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.00127608774168755);
    AssertAlmostEqual(&test, rTM, 0.9996083317115065);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279319318874477e-05);
    AssertAlmostEqual(&test, rTM, 0.9996093198547286);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279351737978371e-07);
    AssertAlmostEqual(&test, rTM, 0.9996093297487998);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279352062179781e-09);
    AssertAlmostEqual(&test, rTM, 0.9996093298477418);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279352065421796e-11);
    AssertAlmostEqual(&test, rTM, 0.9996093298487312);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9153401244070082);
    AssertAlmostEqual(&test, rTM, 0.9153401244070891);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9153401244030027);
    AssertAlmostEqual(&test, rTM, 0.9153401244110945);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9153401240024595);
    AssertAlmostEqual(&test, rTM, 0.9153401248116377);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9153400839481458);
    AssertAlmostEqual(&test, rTM, 0.9153401648659329);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9153360786259461);
    AssertAlmostEqual(&test, rTM, 0.915344170003363);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9149366326430387);
    AssertAlmostEqual(&test, rTM, 0.9157417864519123);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8824439617548144);
    AssertAlmostEqual(&test, rTM, 0.9393275245237456);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4221773770615926);
    AssertAlmostEqual(&test, rTM, 0.9904287359880045);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01245370989617476);
    AssertAlmostEqual(&test, rTM, 0.996002006110364);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001276779518682876);
    AssertAlmostEqual(&test, rTM, 0.9960991751269493);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.277103616663249e-06);
    AssertAlmostEqual(&test, rTM, 0.9961001592148206);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.277106858680112e-08);
    AssertAlmostEqual(&test, rTM, 0.9961001690569705);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.277106891100384e-10);
    AssertAlmostEqual(&test, rTM, 0.9961001691553922);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7547710571431521);
    AssertAlmostEqual(&test, rTM, 0.7547710571431542);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7547710571430476);
    AssertAlmostEqual(&test, rTM, 0.7547710571432585);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7547710571326052);
    AssertAlmostEqual(&test, rTM, 0.754771057153701);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7547710560883619);
    AssertAlmostEqual(&test, rTM, 0.7547710581979443);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7547709516640665);
    AssertAlmostEqual(&test, rTM, 0.7547711626222007);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7547605095735995);
    AssertAlmostEqual(&test, rTM, 0.7547816043224577);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7537196740938393);
    AssertAlmostEqual(&test, rTM, 0.7558185767346892);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6726128163531534);
    AssertAlmostEqual(&test, rTM, 0.8185482727055381);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1005353155080313);
    AssertAlmostEqual(&test, rTM, 0.9533236799911833);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001251815614916913);
    AssertAlmostEqual(&test, rTM, 0.9615940097706075);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.255048331326727e-05);
    AssertAlmostEqual(&test, rTM, 0.961687261115361);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.255080762329502e-07);
    AssertAlmostEqual(&test, rTM, 0.9616881949356684);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.255081086649951e-09);
    AssertAlmostEqual(&test, rTM, 0.9616882042740025);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3936136762641869);
    AssertAlmostEqual(&test, rTM, 0.3936136762641869);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3936136762641852);
    AssertAlmostEqual(&test, rTM, 0.3936136762641886);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3936136762640157);
    AssertAlmostEqual(&test, rTM, 0.3936136762643582);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3936136762470601);
    AssertAlmostEqual(&test, rTM, 0.3936136762813138);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3936136745515032);
    AssertAlmostEqual(&test, rTM, 0.3936136779768706);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3936135049958998);
    AssertAlmostEqual(&test, rTM, 0.3936138475324467);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3935965503084503);
    AssertAlmostEqual(&test, rTM, 0.3936308019467045);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3919097588691506);
    AssertAlmostEqual(&test, rTM, 0.3953148933304416);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2785683498097004);
    AssertAlmostEqual(&test, rTM, 0.4975229409696487);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01037975617409794);
    AssertAlmostEqual(&test, rTM, 0.6760255903920929);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001070126212079404);
    AssertAlmostEqual(&test, rTM, 0.6815651174078168);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.070458956169508e-06);
    AssertAlmostEqual(&test, rTM, 0.6816218420546331);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.070462284776776e-08);
    AssertAlmostEqual(&test, rTM, 0.6816224094378597);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03993086986313606);
    AssertAlmostEqual(&test, rTM, 0.03993086986313606);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03993086986313606);
    AssertAlmostEqual(&test, rTM, 0.03993086986313606);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03993086986313569);
    AssertAlmostEqual(&test, rTM, 0.03993086986313642);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03993086986309919);
    AssertAlmostEqual(&test, rTM, 0.03993086986317292);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03993086985944962);
    AssertAlmostEqual(&test, rTM, 0.0399308698668225);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03993086949449237);
    AssertAlmostEqual(&test, rTM, 0.03993087023177975);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03993083299880098);
    AssertAlmostEqual(&test, rTM, 0.03993090672747103);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03992718376706489);
    AssertAlmostEqual(&test, rTM, 0.03993455595812039);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03956560366247851);
    AssertAlmostEqual(&test, rTM, 0.04029612539198379);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02077030683011267);
    AssertAlmostEqual(&test, rTM, 0.05906211159647558);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004285584522992943);
    AssertAlmostEqual(&test, rTM, 0.0793087565448206);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.331682034772542e-06);
    AssertAlmostEqual(&test, rTM, 0.07973030079805829);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.332148026412515e-08);
    AssertAlmostEqual(&test, rTM, 0.0797345618963872);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006222864841845835);
    AssertAlmostEqual(&test, rTM, 0.0006222864841845835);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006222864841845835);
    AssertAlmostEqual(&test, rTM, 0.0006222864841845835);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006222864841845835);
    AssertAlmostEqual(&test, rTM, 0.0006222864841845836);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006222864841845773);
    AssertAlmostEqual(&test, rTM, 0.0006222864841845898);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000622286484183962);
    AssertAlmostEqual(&test, rTM, 0.0006222864841852051);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006222864841224322);
    AssertAlmostEqual(&test, rTM, 0.0006222864842467347);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006222864779694587);
    AssertAlmostEqual(&test, rTM, 0.0006222864903997084);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006222858626727194);
    AssertAlmostEqual(&test, rTM, 0.0006222871056964477);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006222243391428708);
    AssertAlmostEqual(&test, rTM, 0.0006223486292262914);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006161328194671334);
    AssertAlmostEqual(&test, rTM, 0.0006284401488549046);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003113368924295546);
    AssertAlmostEqual(&test, rTM, 0.0009332359556022894);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.168851500186561e-06);
    AssertAlmostEqual(&test, rTM, 0.001238403644428095);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.229993110806915e-08);
    AssertAlmostEqual(&test, rTM, 0.001244510186585722);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.516087932437253e-06);
    AssertAlmostEqual(&test, rTM, 6.516087932437253e-06);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.516087932437253e-06);
    AssertAlmostEqual(&test, rTM, 6.516087932437253e-06);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.516087932437253e-06);
    AssertAlmostEqual(&test, rTM, 6.516087932437253e-06);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.516087932437252e-06);
    AssertAlmostEqual(&test, rTM, 6.516087932437254e-06);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.516087932437188e-06);
    AssertAlmostEqual(&test, rTM, 6.516087932437318e-06);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.516087932430737e-06);
    AssertAlmostEqual(&test, rTM, 6.516087932443769e-06);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.516087931785652e-06);
    AssertAlmostEqual(&test, rTM, 6.516087933088853e-06);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.516087867277223e-06);
    AssertAlmostEqual(&test, rTM, 6.516087997597282e-06);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.516081416440754e-06);
    AssertAlmostEqual(&test, rTM, 6.516094448433751e-06);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.5154363972885e-06);
    AssertAlmostEqual(&test, rTM, 6.516739467586005e-06);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.451573042784303e-06);
    AssertAlmostEqual(&test, rTM, 6.580602822090148e-06);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.258065195954181e-06);
    AssertAlmostEqual(&test, rTM, 9.774110668781991e-06);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.451655456702116e-08);
    AssertAlmostEqual(&test, rTM, 1.296765930976505e-05);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546173827380935e-08);
    AssertAlmostEqual(&test, rTM, 6.546173827380935e-08);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546173827380935e-08);
    AssertAlmostEqual(&test, rTM, 6.546173827380935e-08);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546173827380935e-08);
    AssertAlmostEqual(&test, rTM, 6.546173827380935e-08);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546173827380935e-08);
    AssertAlmostEqual(&test, rTM, 6.546173827380935e-08);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546173827380934e-08);
    AssertAlmostEqual(&test, rTM, 6.546173827380935e-08);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546173827380869e-08);
    AssertAlmostEqual(&test, rTM, 6.546173827381e-08);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546173827374388e-08);
    AssertAlmostEqual(&test, rTM, 6.546173827387481e-08);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546173826726318e-08);
    AssertAlmostEqual(&test, rTM, 6.546173828035551e-08);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546173761919206e-08);
    AssertAlmostEqual(&test, rTM, 6.546173892842664e-08);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546167281214511e-08);
    AssertAlmostEqual(&test, rTM, 6.546180373547359e-08);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.545519275539077e-08);
    AssertAlmostEqual(&test, rTM, 6.546828379222793e-08);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.481360233531244e-08);
    AssertAlmostEqual(&test, rTM, 6.610987421230626e-08);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.273087127952429e-08);
    AssertAlmostEqual(&test, rTM, 9.819260526809426e-08);

    userdata[0] = 2/CAPS_HBAR_EV; /* 2eV */
    userdata[1] = 1e-05/CAPS_HBAR_EV; /* 1e-05eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999998023076236);
    AssertAlmostEqual(&test, rTM, 0.9999999011538069);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999985951325545);
    AssertAlmostEqual(&test, rTM, 0.9999999860904116);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999860204354095);
    AssertAlmostEqual(&test, rTM, 0.9999999986021736);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998602200665953);
    AssertAlmostEqual(&test, rTM, 0.9999999998602105);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9986030803711577);
    AssertAlmostEqual(&test, rTM, 0.9999999999860211);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9861184008809533);
    AssertAlmostEqual(&test, rTM, 0.9999999999986021);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8696398969845291);
    AssertAlmostEqual(&test, rTM, 0.9999999999998599);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2715499119134004);
    AssertAlmostEqual(&test, rTM, 0.9999999999999829);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.005065693141032068);
    AssertAlmostEqual(&test, rTM, 0.9999999999999901);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.116884571469215e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999999902);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.11740302425141e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999999902);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.117408209442439e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999999999902);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.117408261294416e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999999999902);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999995553513578);
    AssertAlmostEqual(&test, rTM, 0.9999995597538186);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999993742926708);
    AssertAlmostEqual(&test, rTM, 0.9999996871462865);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999995553522475);
    AssertAlmostEqual(&test, rTM, 0.9999999559753732);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999557545633142);
    AssertAlmostEqual(&test, rTM, 0.9999999955758009);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995576556116);
    AssertAlmostEqual(&test, rTM, 0.9999999995575581);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9955853565601082);
    AssertAlmostEqual(&test, rTM, 0.9999999999557557);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9567237464188579);
    AssertAlmostEqual(&test, rTM, 0.9999999999955745);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6447384761316791);
    AssertAlmostEqual(&test, rTM, 0.9999999999995468);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04644887555600814);
    AssertAlmostEqual(&test, rTM, 0.9999999999998926);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005103215015237681);
    AssertAlmostEqual(&test, rTM, 0.999999999999902);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.108375374313599e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999999021);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.10842704379087e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999999021);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.108427560492242e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999999999021);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999951673707299);
    AssertAlmostEqual(&test, rTM, 0.9999951673755625);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999951671315215);
    AssertAlmostEqual(&test, rTM, 0.9999951676147588);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999951432701781);
    AssertAlmostEqual(&test, rTM, 0.9999951913564964);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999931656404017);
    AssertAlmostEqual(&test, rTM, 0.9999965828143623);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999514337632242);
    AssertAlmostEqual(&test, rTM, 0.9999995191346089);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995168287538533);
    AssertAlmostEqual(&test, rTM, 0.9999999516760306);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.995179022154014);
    AssertAlmostEqual(&test, rTM, 0.9999999951673498);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9528272283582092);
    AssertAlmostEqual(&test, rTM, 0.9999999995165951);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6196003293664851);
    AssertAlmostEqual(&test, rTM, 0.9999999999502829);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03950243876441308);
    AssertAlmostEqual(&test, rTM, 0.9999999999873623);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000427818634747753);
    AssertAlmostEqual(&test, rTM, 0.9999999999883128);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.281812605522871e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999883227);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.281848906912133e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999883228);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999975977792708);
    AssertAlmostEqual(&test, rTM, 0.9999759777929481);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999759777808171);
    AssertAlmostEqual(&test, rTM, 0.999975977804839);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999759765917622);
    AssertAlmostEqual(&test, rTM, 0.9999759789938339);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999975857982024);
    AssertAlmostEqual(&test, rTM, 0.9999760970090481);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999660276378397);
    AssertAlmostEqual(&test, rTM, 0.999983013674651);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997586060467982);
    AssertAlmostEqual(&test, rTM, 0.9999976096751764);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9976005142764058);
    AssertAlmostEqual(&test, rTM, 0.9999997597869088);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9762642999132772);
    AssertAlmostEqual(&test, rTM, 0.9999999759757838);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7869023986634399);
    AssertAlmostEqual(&test, rTM, 0.9999999975804839);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1308915697321562);
    AssertAlmostEqual(&test, rTM, 0.999999999624549);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001726881370082321);
    AssertAlmostEqual(&test, rTM, 0.9999999997104616);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.732801040014618e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999997114498);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.732860493003175e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999997114597);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997997092081643);
    AssertAlmostEqual(&test, rTM, 0.9997997092081844);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999799709207173);
    AssertAlmostEqual(&test, rTM, 0.9997997092091757);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997997091080391);
    AssertAlmostEqual(&test, rTM, 0.9997997093083096);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997996991948882);
    AssertAlmostEqual(&test, rTM, 0.99979971922096);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997987103459601);
    AssertAlmostEqual(&test, rTM, 0.9998007031142159);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997167577965367);
    AssertAlmostEqual(&test, rTM, 0.9998583688678694);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9979889261057222);
    AssertAlmostEqual(&test, rTM, 0.9999800685138994);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9801675506226789);
    AssertAlmostEqual(&test, rTM, 0.9999979968931744);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8187491211732252);
    AssertAlmostEqual(&test, rTM, 0.9999997986871058);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1711963064179989);
    AssertAlmostEqual(&test, rTM, 0.9999999716497449);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002479901030832306);
    AssertAlmostEqual(&test, rTM, 0.9999999798380295);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.492122536440082e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999799367815);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.492245512322762e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999799377715);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9980431912829425);
    AssertAlmostEqual(&test, rTM, 0.9980431912829445);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9980431912828458);
    AssertAlmostEqual(&test, rTM, 0.9980431912830412);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.998043191273169);
    AssertAlmostEqual(&test, rTM, 0.9980431912927179);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9980431903054976);
    AssertAlmostEqual(&test, rTM, 0.998043192260389);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9980430935407771);
    AssertAlmostEqual(&test, rTM, 0.9980432890202326);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9980334411838646);
    AssertAlmostEqual(&test, rTM, 0.998052893088633);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9972337769613432);
    AssertAlmostEqual(&test, rTM, 0.998615929993392);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9805078417404135);
    AssertAlmostEqual(&test, rTM, 0.999805109210141);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8223652994657434);
    AssertAlmostEqual(&test, rTM, 0.9999803202147095);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1766805958761063);
    AssertAlmostEqual(&test, rTM, 0.9999972583838757);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002592969648727112);
    AssertAlmostEqual(&test, rTM, 0.999998071725707);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.606333275793314e-05);
    AssertAlmostEqual(&test, rTM, 0.9999980815997513);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.606467782090464e-07);
    AssertAlmostEqual(&test, rTM, 0.9999980816987485);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9806476943346312);
    AssertAlmostEqual(&test, rTM, 0.9806476943346314);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9806476943346217);
    AssertAlmostEqual(&test, rTM, 0.9806476943346409);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9806476943336732);
    AssertAlmostEqual(&test, rTM, 0.9806476943355895);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9806476942388153);
    AssertAlmostEqual(&test, rTM, 0.9806476944304474);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9806476847530237);
    AssertAlmostEqual(&test, rTM, 0.9806477039162342);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9806467361980455);
    AssertAlmostEqual(&test, rTM, 0.9806486524242453);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9805521212640549);
    AssertAlmostEqual(&test, rTM, 0.9807428022954308);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9727422442598359);
    AssertAlmostEqual(&test, rTM, 0.986276310714109);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8219434828175465);
    AssertAlmostEqual(&test, rTM, 0.9980482061138605);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1772367918116102);
    AssertAlmostEqual(&test, rTM, 0.9997268440879171);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.00260484362667207);
    AssertAlmostEqual(&test, rTM, 0.9998080881338163);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.618332728875948e-05);
    AssertAlmostEqual(&test, rTM, 0.9998090752449957);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.618468502233696e-07);
    AssertAlmostEqual(&test, rTM, 0.999809085141899);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8227780335261234);
    AssertAlmostEqual(&test, rTM, 0.8227780335261234);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8227780335261227);
    AssertAlmostEqual(&test, rTM, 0.8227780335261242);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8227780335260434);
    AssertAlmostEqual(&test, rTM, 0.8227780335262034);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8227780335181238);
    AssertAlmostEqual(&test, rTM, 0.822778033534123);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8227780327261668);
    AssertAlmostEqual(&test, rTM, 0.8227780343260801);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8227779535304824);
    AssertAlmostEqual(&test, rTM, 0.8227781135217318);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.822770034200372);
    AssertAlmostEqual(&test, rTM, 0.8227860325259253);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8219804724794013);
    AssertAlmostEqual(&test, rTM, 0.8235723673545747);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7592417176017351);
    AssertAlmostEqual(&test, rTM, 0.8707786667559131);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1760761010344407);
    AssertAlmostEqual(&test, rTM, 0.9733728307327828);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002605780635445637);
    AssertAlmostEqual(&test, rTM, 0.9811741952508433);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619536163334424e-05);
    AssertAlmostEqual(&test, rTM, 0.9812701636633777);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619674629058463e-07);
    AssertAlmostEqual(&test, rTM, 0.9812711259977352);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1773119395635837);
    AssertAlmostEqual(&test, rTM, 0.1773119395635837);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1773119395635837);
    AssertAlmostEqual(&test, rTM, 0.1773119395635837);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1773119395635825);
    AssertAlmostEqual(&test, rTM, 0.177311939563585);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1773119395634598);
    AssertAlmostEqual(&test, rTM, 0.1773119395637076);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1773119395511934);
    AssertAlmostEqual(&test, rTM, 0.177311939575974);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1773119383245543);
    AssertAlmostEqual(&test, rTM, 0.1773119408026132);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1773118156607288);
    AssertAlmostEqual(&test, rTM, 0.177312063466433);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1772995501630086);
    AssertAlmostEqual(&test, rTM, 0.1773243289079584);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.176081783302795);
    AssertAlmostEqual(&test, rTM, 0.178541542007437);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1049401632528273);
    AssertAlmostEqual(&test, rTM, 0.247815523229231);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002580488552991852);
    AssertAlmostEqual(&test, rTM, 0.3415370408045468);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619397520580947e-05);
    AssertAlmostEqual(&test, rTM, 0.3437914166432224);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619792711857938e-07);
    AssertAlmostEqual(&test, rTM, 0.3438142834668759);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002606171226174258);
    AssertAlmostEqual(&test, rTM, 0.002606171226174258);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002606171226174258);
    AssertAlmostEqual(&test, rTM, 0.002606171226174258);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002606171226174257);
    AssertAlmostEqual(&test, rTM, 0.002606171226174258);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002606171226174232);
    AssertAlmostEqual(&test, rTM, 0.002606171226174284);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002606171226171665);
    AssertAlmostEqual(&test, rTM, 0.00260617122617685);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002606171225914995);
    AssertAlmostEqual(&test, rTM, 0.00260617122643352);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002606171200248035);
    AssertAlmostEqual(&test, rTM, 0.00260617125210048);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002606168633554557);
    AssertAlmostEqual(&test, rTM, 0.002606173818793959);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002605911989735292);
    AssertAlmostEqual(&test, rTM, 0.002606430462612873);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.00258050037898797);
    AssertAlmostEqual(&test, rTM, 0.002631842069925629);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001306483884224297);
    AssertAlmostEqual(&test, rTM, 0.003905849763501979);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.59373551734664e-05);
    AssertAlmostEqual(&test, rTM, 0.005186370395679349);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619545445492884e-07);
    AssertAlmostEqual(&test, rTM, 0.005212045102261372);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619672720314536e-05);
    AssertAlmostEqual(&test, rTM, 2.619672720314536e-05);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619672720314536e-05);
    AssertAlmostEqual(&test, rTM, 2.619672720314536e-05);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619672720314536e-05);
    AssertAlmostEqual(&test, rTM, 2.619672720314536e-05);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619672720314536e-05);
    AssertAlmostEqual(&test, rTM, 2.619672720314536e-05);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619672720314509e-05);
    AssertAlmostEqual(&test, rTM, 2.619672720314562e-05);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619672720311916e-05);
    AssertAlmostEqual(&test, rTM, 2.619672720317155e-05);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619672720052582e-05);
    AssertAlmostEqual(&test, rTM, 2.619672720576489e-05);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619672694119181e-05);
    AssertAlmostEqual(&test, rTM, 2.61967274650989e-05);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619670100781685e-05);
    AssertAlmostEqual(&test, rTM, 2.619675339847386e-05);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619410792958878e-05);
    AssertAlmostEqual(&test, rTM, 2.619934647670193e-05);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.593736712106311e-05);
    AssertAlmostEqual(&test, rTM, 2.645608728522407e-05);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.309870673807794e-05);
    AssertAlmostEqual(&test, rTM, 3.929474765922425e-05);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.593869921111155e-07);
    AssertAlmostEqual(&test, rTM, 5.213406737893213e-05);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619808727414567e-07);
    AssertAlmostEqual(&test, rTM, 2.619808727414567e-07);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619808727414567e-07);
    AssertAlmostEqual(&test, rTM, 2.619808727414567e-07);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619808727414567e-07);
    AssertAlmostEqual(&test, rTM, 2.619808727414567e-07);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619808727414567e-07);
    AssertAlmostEqual(&test, rTM, 2.619808727414567e-07);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619808727414567e-07);
    AssertAlmostEqual(&test, rTM, 2.619808727414568e-07);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619808727414541e-07);
    AssertAlmostEqual(&test, rTM, 2.619808727414594e-07);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619808727411947e-07);
    AssertAlmostEqual(&test, rTM, 2.619808727417187e-07);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619808727152586e-07);
    AssertAlmostEqual(&test, rTM, 2.619808727676548e-07);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619808701216494e-07);
    AssertAlmostEqual(&test, rTM, 2.61980875361264e-07);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619806107609832e-07);
    AssertAlmostEqual(&test, rTM, 2.619811347219302e-07);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619546772874534e-07);
    AssertAlmostEqual(&test, rTM, 2.620070681954601e-07);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.593870040599456e-07);
    AssertAlmostEqual(&test, rTM, 2.645747414229678e-07);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.309904706877194e-07);
    AssertAlmostEqual(&test, rTM, 3.92971274795185e-07);

    userdata[0] = 2/CAPS_HBAR_EV; /* 2eV */
    userdata[1] = 0.0001/CAPS_HBAR_EV; /* 0.0001eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999993748969025);
    AssertAlmostEqual(&test, rTM, 0.9999996874484024);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999955578163314);
    AssertAlmostEqual(&test, rTM, 0.9999999560178867);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999557972892178);
    AssertAlmostEqual(&test, rTM, 0.9999999955800732);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995580826794696);
    AssertAlmostEqual(&test, rTM, 0.9999999995579855);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9955896102626615);
    AssertAlmostEqual(&test, rTM, 0.9999999999557985);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9567646139533561);
    AssertAlmostEqual(&test, rTM, 0.9999999999955788);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6450075042343271);
    AssertAlmostEqual(&test, rTM, 0.9999999999995474);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04653072581701249);
    AssertAlmostEqual(&test, rTM, 0.9999999999998928);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005113075347582465);
    AssertAlmostEqual(&test, rTM, 0.9999999999999022);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.118255674952231e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999999023);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.118307544495301e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999999023);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.118308063197368e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999999999023);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.11830806838439e-12);
    AssertAlmostEqual(&test, rTM, 0.9999999999999023);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999985951325545);
    AssertAlmostEqual(&test, rTM, 0.9999986090421236);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999980230779948);
    AssertAlmostEqual(&test, rTM, 0.9999990115385089);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999859514143594);
    AssertAlmostEqual(&test, rTM, 0.9999998609041253);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998602131481503);
    AssertAlmostEqual(&test, rTM, 0.9999999860217356);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.998603079680166);
    AssertAlmostEqual(&test, rTM, 0.999999998602104);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9861184008127196);
    AssertAlmostEqual(&test, rTM, 0.9999999998602069);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8696398969785263);
    AssertAlmostEqual(&test, rTM, 0.999999999985987);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2715499119132464);
    AssertAlmostEqual(&test, rTM, 0.9999999999982945);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.005065693141032019);
    AssertAlmostEqual(&test, rTM, 0.999999999999013);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.116884571469215e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999990229);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.11740302425141e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999990229);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.117408209442439e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999999990229);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.117408261294416e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999999990229);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999858866125679);
    AssertAlmostEqual(&test, rTM, 0.9999858866266812);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999858859139782);
    AssertAlmostEqual(&test, rTM, 0.9999858873252357);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999858162287626);
    AssertAlmostEqual(&test, rTM, 0.9999859566611551);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999800407244032);
    AssertAlmostEqual(&test, rTM, 0.9999900203124042);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998581713404723);
    AssertAlmostEqual(&test, rTM, 0.9999985956572373);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9985895771370595);
    AssertAlmostEqual(&test, rTM, 0.9999998588722313);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9859857568263409);
    AssertAlmostEqual(&test, rTM, 0.9999999858861758);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.868473743357938);
    AssertAlmostEqual(&test, rTM, 0.9999999985851423);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2685770658616057);
    AssertAlmostEqual(&test, rTM, 0.9999999998272625);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.004970540937722919);
    AssertAlmostEqual(&test, rTM, 0.9999999998994098);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.019820349826457e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999003948);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.020319318978656e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999004048);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.020324309296353e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999999004049);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999951674782154);
    AssertAlmostEqual(&test, rTM, 0.9999516747826371);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999516747582335);
    AssertAlmostEqual(&test, rTM, 0.9999516748065576);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999516723662535);
    AssertAlmostEqual(&test, rTM, 0.9999516771984168);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999514337632242);
    AssertAlmostEqual(&test, rTM, 0.9999519146054923);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999316585058736);
    AssertAlmostEqual(&test, rTM, 0.9999658286690869);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995144437637906);
    AssertAlmostEqual(&test, rTM, 0.9999951913563574);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9951787840983941);
    AssertAlmostEqual(&test, rTM, 0.9999995167590144);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9528272055717519);
    AssertAlmostEqual(&test, rTM, 0.9999999516595341);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6196003279257667);
    AssertAlmostEqual(&test, rTM, 0.9999999950282836);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03950243876079956);
    AssertAlmostEqual(&test, rTM, 0.9999999987362305);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004278186347473299);
    AssertAlmostEqual(&test, rTM, 0.9999999988312807);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.281812605522829e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999988322702);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.281848906912133e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999988322802);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997598038951665);
    AssertAlmostEqual(&test, rTM, 0.9997598038951905);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997598038939777);
    AssertAlmostEqual(&test, rTM, 0.9997598038963793);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997598037750949);
    AssertAlmostEqual(&test, rTM, 0.9997598040152621);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997597918871161);
    AssertAlmostEqual(&test, rTM, 0.9997598159026407);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997586060467982);
    AssertAlmostEqual(&test, rTM, 0.9997609958002897);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996603283107723);
    AssertAlmostEqual(&test, rTM, 0.999830149729604);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9975886815566144);
    AssertAlmostEqual(&test, rTM, 0.9999760969919766);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9762631391379167);
    AssertAlmostEqual(&test, rTM, 0.9999975977001638);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7869023057596023);
    AssertAlmostEqual(&test, rTM, 0.9999997580485366);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1308915687362925);
    AssertAlmostEqual(&test, rTM, 0.999999962454902);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001726881369911949);
    AssertAlmostEqual(&test, rTM, 0.9999999710461586);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.732801040012902e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999711449858);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.732860493003158e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999711459758);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9979988966868225);
    AssertAlmostEqual(&test, rTM, 0.9979988966868245);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9979988966867236);
    AssertAlmostEqual(&test, rTM, 0.9979988966869235);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9979988966768281);
    AssertAlmostEqual(&test, rTM, 0.9979988966968191);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9979988956872743);
    AssertAlmostEqual(&test, rTM, 0.9979988976863724);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9979987967343723);
    AssertAlmostEqual(&test, rTM, 0.9979989966342876);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9979889261057222);
    AssertAlmostEqual(&test, rTM, 0.9980088178846507);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9971711863515546);
    AssertAlmostEqual(&test, rTM, 0.9985845907757429);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9800706170731229);
    AssertAlmostEqual(&test, rTM, 0.9998006932185921);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8187410436180317);
    AssertAlmostEqual(&test, rTM, 0.999979869917683);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.171196186481532);
    AssertAlmostEqual(&test, rTM, 0.9999971649819855);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002479901006402753);
    AssertAlmostEqual(&test, rTM, 0.9999979838069618);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.492122536193375e-05);
    AssertAlmostEqual(&test, rTM, 0.9999979936821354);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.492245512320295e-07);
    AssertAlmostEqual(&test, rTM, 0.9999979937811326);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9806036302413789);
    AssertAlmostEqual(&test, rTM, 0.9806036302413791);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9806036302413694);
    AssertAlmostEqual(&test, rTM, 0.9806036302413886);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9806036302404186);
    AssertAlmostEqual(&test, rTM, 0.9806036302423393);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9806036301453469);
    AssertAlmostEqual(&test, rTM, 0.980603630337411);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9806036206381724);
    AssertAlmostEqual(&test, rTM, 0.9806036398445809);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9806026699449588);
    AssertAlmostEqual(&test, rTM, 0.9806045904907238);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9805078417404135);
    AssertAlmostEqual(&test, rTM, 0.9806989526052683);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9726804341119326);
    AssertAlmostEqual(&test, rTM, 0.9862449706531441);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8215741493067015);
    AssertAlmostEqual(&test, rTM, 0.9980436803172281);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1766683581050774);
    AssertAlmostEqual(&test, rTM, 0.9997259085365144);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002592967094967784);
    AssertAlmostEqual(&test, rTM, 0.9998072092800865);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.60633324999196e-05);
    AssertAlmostEqual(&test, rTM, 0.9998081964018365);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.606467781832423e-07);
    AssertAlmostEqual(&test, rTM, 0.9998082062987278);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8227411899785215);
    AssertAlmostEqual(&test, rTM, 0.8227411899785215);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8227411899785207);
    AssertAlmostEqual(&test, rTM, 0.8227411899785224);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8227411899784416);
    AssertAlmostEqual(&test, rTM, 0.8227411899786016);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8227411899705206);
    AssertAlmostEqual(&test, rTM, 0.8227411899865226);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8227411891784183);
    AssertAlmostEqual(&test, rTM, 0.8227411907786248);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8227411099682156);
    AssertAlmostEqual(&test, rTM, 0.8227412699887949);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8227331891863217);
    AssertAlmostEqual(&test, rTM, 0.8227491904447282);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8219434828175465);
    AssertAlmostEqual(&test, rTM, 0.8235356694883373);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7591938627092589);
    AssertAlmostEqual(&test, rTM, 0.8707508364218698);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1760192991598461);
    AssertAlmostEqual(&test, rTM, 0.9733639245245836);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002604587112653849);
    AssertAlmostEqual(&test, rTM, 0.9811657308990751);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.618330136864877e-05);
    AssertAlmostEqual(&test, rTM, 0.9812616981896631);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.618468476310872e-07);
    AssertAlmostEqual(&test, rTM, 0.9812626605116185);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1773062321100179);
    AssertAlmostEqual(&test, rTM, 0.1773062321100179);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1773062321100179);
    AssertAlmostEqual(&test, rTM, 0.1773062321100179);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1773062321100167);
    AssertAlmostEqual(&test, rTM, 0.1773062321100191);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.177306232109894);
    AssertAlmostEqual(&test, rTM, 0.1773062321101418);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1773062320976279);
    AssertAlmostEqual(&test, rTM, 0.177306232122408);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1773062308710138);
    AssertAlmostEqual(&test, rTM, 0.1773062333490221);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1773061082096911);
    AssertAlmostEqual(&test, rTM, 0.1773063560103391);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1772938429622406);
    AssertAlmostEqual(&test, rTM, 0.177318621201599);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1760761010344408);
    AssertAlmostEqual(&test, rTM, 0.1785358094103056);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.104936247512777);
    AssertAlmostEqual(&test, rTM, 0.2478081777516742);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002580370298992065);
    AssertAlmostEqual(&test, rTM, 0.3415267345415893);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.61927686876871e-05);
    AssertAlmostEqual(&test, rTM, 0.3437810251908313);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619672035584532e-07);
    AssertAlmostEqual(&test, rTM, 0.3438038911465051);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002606159283146189);
    AssertAlmostEqual(&test, rTM, 0.002606159283146189);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002606159283146189);
    AssertAlmostEqual(&test, rTM, 0.002606159283146189);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002606159283146188);
    AssertAlmostEqual(&test, rTM, 0.002606159283146189);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002606159283146163);
    AssertAlmostEqual(&test, rTM, 0.002606159283146215);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002606159283143596);
    AssertAlmostEqual(&test, rTM, 0.002606159283148781);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002606159282886928);
    AssertAlmostEqual(&test, rTM, 0.00260615928340545);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002606159257220084);
    AssertAlmostEqual(&test, rTM, 0.002606159309072293);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002606156690538307);
    AssertAlmostEqual(&test, rTM, 0.00260616187575407);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002605900047889007);
    AssertAlmostEqual(&test, rTM, 0.002606418518403019);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002580488552991852);
    AssertAlmostEqual(&test, rTM, 0.002631830009865655);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001306477881554444);
    AssertAlmostEqual(&test, rTM, 0.003905831880236526);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.593723569810469e-05);
    AssertAlmostEqual(&test, rTM, 0.00518634662957562);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619533378448685e-07);
    AssertAlmostEqual(&test, rTM, 0.005212021217898545);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.61967151360852e-05);
    AssertAlmostEqual(&test, rTM, 2.61967151360852e-05);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.61967151360852e-05);
    AssertAlmostEqual(&test, rTM, 2.61967151360852e-05);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.61967151360852e-05);
    AssertAlmostEqual(&test, rTM, 2.61967151360852e-05);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.61967151360852e-05);
    AssertAlmostEqual(&test, rTM, 2.61967151360852e-05);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619671513608494e-05);
    AssertAlmostEqual(&test, rTM, 2.619671513608546e-05);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.6196715136059e-05);
    AssertAlmostEqual(&test, rTM, 2.61967151361114e-05);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619671513346566e-05);
    AssertAlmostEqual(&test, rTM, 2.619671513870474e-05);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619671487413178e-05);
    AssertAlmostEqual(&test, rTM, 2.619671539803862e-05);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619668894076876e-05);
    AssertAlmostEqual(&test, rTM, 2.619674133140164e-05);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619409586373509e-05);
    AssertAlmostEqual(&test, rTM, 2.619933440843531e-05);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.593735517346641e-05);
    AssertAlmostEqual(&test, rTM, 2.645607509870047e-05);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.309870070423175e-05);
    AssertAlmostEqual(&test, rTM, 3.929472955895014e-05);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.593868726228761e-07);
    AssertAlmostEqual(&test, rTM, 5.213404336430011e-05);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619808606731385e-07);
    AssertAlmostEqual(&test, rTM, 2.619808606731385e-07);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619808606731385e-07);
    AssertAlmostEqual(&test, rTM, 2.619808606731385e-07);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619808606731385e-07);
    AssertAlmostEqual(&test, rTM, 2.619808606731385e-07);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619808606731385e-07);
    AssertAlmostEqual(&test, rTM, 2.619808606731385e-07);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619808606731385e-07);
    AssertAlmostEqual(&test, rTM, 2.619808606731386e-07);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619808606731359e-07);
    AssertAlmostEqual(&test, rTM, 2.619808606731412e-07);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619808606728765e-07);
    AssertAlmostEqual(&test, rTM, 2.619808606734005e-07);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619808606469405e-07);
    AssertAlmostEqual(&test, rTM, 2.619808606993366e-07);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619808580533313e-07);
    AssertAlmostEqual(&test, rTM, 2.619808632929457e-07);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619805986926771e-07);
    AssertAlmostEqual(&test, rTM, 2.619811226536e-07);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619546652203419e-07);
    AssertAlmostEqual(&test, rTM, 2.620070561259351e-07);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.593869921111156e-07);
    AssertAlmostEqual(&test, rTM, 2.645747292351615e-07);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.309904646535572e-07);
    AssertAlmostEqual(&test, rTM, 3.929712566927109e-07);

    userdata[0] = 2/CAPS_HBAR_EV; /* 2eV */
    userdata[1] = 0.001/CAPS_HBAR_EV; /* 0.001eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999980232691542);
    AssertAlmostEqual(&test, rTM, 0.9999990116340887);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999859527727855);
    AssertAlmostEqual(&test, rTM, 0.9999998609175752);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998602266639709);
    AssertAlmostEqual(&test, rTM, 0.9999999860230873);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9986032146617303);
    AssertAlmostEqual(&test, rTM, 0.9999999986022392);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9861197337206954);
    AssertAlmostEqual(&test, rTM, 0.9999999998602205);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8696516234042718);
    AssertAlmostEqual(&test, rTM, 0.9999999999859883);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.271579999229273);
    AssertAlmostEqual(&test, rTM, 0.9999999999982947);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.005066663064416162);
    AssertAlmostEqual(&test, rTM, 0.9999999999990132);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.11787417356357e-05);
    AssertAlmostEqual(&test, rTM, 0.999999999999023);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.118392826909578e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999990231);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.11839801410663e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999999990231);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.118398065978667e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999999990231);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.118398066497387e-13);
    AssertAlmostEqual(&test, rTM, 0.9999999999990231);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999955578163314);
    AssertAlmostEqual(&test, rTM, 0.9999956017982512);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999937489866086);
    AssertAlmostEqual(&test, rTM, 0.9999968744884199);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999555790512918);
    AssertAlmostEqual(&test, rTM, 0.9999995601789545);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995580608099601);
    AssertAlmostEqual(&test, rTM, 0.9999999558007321);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9955896080843439);
    AssertAlmostEqual(&test, rTM, 0.9999999955798436);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9567646137440697);
    AssertAlmostEqual(&test, rTM, 0.9999999995578773);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.645007504220547);
    AssertAlmostEqual(&test, rTM, 0.9999999999547319);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04653072581697053);
    AssertAlmostEqual(&test, rTM, 0.9999999999892777);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005113075347582415);
    AssertAlmostEqual(&test, rTM, 0.9999999999902212);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.118255674952231e-06);
    AssertAlmostEqual(&test, rTM, 0.999999999990231);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.118307544495301e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999902311);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.118308063197369e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999999902311);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.11830806838439e-12);
    AssertAlmostEqual(&test, rTM, 0.9999999999902311);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999557567532501);
    AssertAlmostEqual(&test, rTM, 0.9999557567974923);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999557545633142);
    AssertAlmostEqual(&test, rTM, 0.9999557589873176);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999555361144463);
    AssertAlmostEqual(&test, rTM, 0.9999559763412463);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999374312050245);
    AssertAlmostEqual(&test, rTM, 0.9999687151131326);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995554501042099);
    AssertAlmostEqual(&test, rTM, 0.9999955975468015);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9955851363437966);
    AssertAlmostEqual(&test, rTM, 0.999999557579102);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9567237252614164);
    AssertAlmostEqual(&test, rTM, 0.9999999557449948);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6447384747391911);
    AssertAlmostEqual(&test, rTM, 0.9999999954686101);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04644887555177602);
    AssertAlmostEqual(&test, rTM, 0.9999999989258701);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005103215015232584);
    AssertAlmostEqual(&test, rTM, 0.9999999990202257);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.108375374313547e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999990212153);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.10842704379087e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999990212252);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.108427560492242e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999990212253);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998588751587566);
    AssertAlmostEqual(&test, rTM, 0.9998588751601677);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998588750889047);
    AssertAlmostEqual(&test, rTM, 0.9998588752300195);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998588681038945);
    AssertAlmostEqual(&test, rTM, 0.9998588822146771);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998581713404723);
    AssertAlmostEqual(&test, rTM, 0.9998595754860239);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999800425170176);
    AssertAlmostEqual(&test, rTM, 0.9999002076055785);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9985826183715875);
    AssertAlmostEqual(&test, rTM, 0.9999859566576931);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.985985068034458);
    AssertAlmostEqual(&test, rTM, 0.9999985886884258);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8684736828353876);
    AssertAlmostEqual(&test, rTM, 0.9999998585143093);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2685770643285574);
    AssertAlmostEqual(&test, rTM, 0.9999999827262551);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.004970540937235703);
    AssertAlmostEqual(&test, rTM, 0.9999999899409813);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.019820349821488e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999900394843);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.020319318978607e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999900404742);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.020324309296353e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999900404841);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995168529047427);
    AssertAlmostEqual(&test, rTM, 0.999516852904791);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995168529023517);
    AssertAlmostEqual(&test, rTM, 0.999516852907182);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995168526632517);
    AssertAlmostEqual(&test, rTM, 0.9995168531462818);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995168287538533);
    AssertAlmostEqual(&test, rTM, 0.9995168770544735);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995144437637906);
    AssertAlmostEqual(&test, rTM, 0.9995192500953977);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993167952087882);
    AssertAlmostEqual(&test, rTM, 0.9996583392283837);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9951550380336673);
    AssertAlmostEqual(&test, rTM, 0.9999519144665101);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9528249269857647);
    AssertAlmostEqual(&test, rTM, 0.9999951662043913);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6196001838539796);
    AssertAlmostEqual(&test, rTM, 0.9999995028287411);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03950243839944807);
    AssertAlmostEqual(&test, rTM, 0.999999873623064);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004278186347050121);
    AssertAlmostEqual(&test, rTM, 0.9999998831280805);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.28181260551859e-06);
    AssertAlmostEqual(&test, rTM, 0.9999998832270378);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.281848906912091e-08);
    AssertAlmostEqual(&test, rTM, 0.9999998832280278);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9976006340976004);
    AssertAlmostEqual(&test, rTM, 0.9976006340976027);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9976006340974817);
    AssertAlmostEqual(&test, rTM, 0.9976006340977214);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9976006340856192);
    AssertAlmostEqual(&test, rTM, 0.997600634109584);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9976006328993599);
    AssertAlmostEqual(&test, rTM, 0.9976006352958426);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9976005142764058);
    AssertAlmostEqual(&test, rTM, 0.997600753912821);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9975886815566144);
    AssertAlmostEqual(&test, rTM, 0.9976125274624605);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9966084719781622);
    AssertAlmostEqual(&test, rTM, 0.9983027945146902);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9761473572943842);
    AssertAlmostEqual(&test, rTM, 0.9997609787331104);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7868930156667507);
    AssertAlmostEqual(&test, rTM, 0.9999758063584969);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1308914691500094);
    AssertAlmostEqual(&test, rTM, 0.9999962455033022);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001726881352874768);
    AssertAlmostEqual(&test, rTM, 0.9999971046241369);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.732801039841361e-05);
    AssertAlmostEqual(&test, rTM, 0.9999971145068269);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.732860493001442e-07);
    AssertAlmostEqual(&test, rTM, 0.9999971146058247);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9801685322403855);
    AssertAlmostEqual(&test, rTM, 0.9801685322403857);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9801685322403757);
    AssertAlmostEqual(&test, rTM, 0.9801685322403954);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9801685322394039);
    AssertAlmostEqual(&test, rTM, 0.9801685322413672);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9801685321422213);
    AssertAlmostEqual(&test, rTM, 0.9801685323385498);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9801685224239607);
    AssertAlmostEqual(&test, rTM, 0.9801685420568056);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9801675506226789);
    AssertAlmostEqual(&test, rTM, 0.9801695138099931);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9800706170731229);
    AssertAlmostEqual(&test, rTM, 0.9802659711345462);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9720701703789999);
    AssertAlmostEqual(&test, rTM, 0.9859354894986606);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8179357174880256);
    AssertAlmostEqual(&test, rTM, 0.9979989661525028);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1711841937090562);
    AssertAlmostEqual(&test, rTM, 0.9997165731234522);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002479898563449884);
    AssertAlmostEqual(&test, rTM, 0.9997984208334615);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.492122511522591e-05);
    AssertAlmostEqual(&test, rTM, 0.9997994080552195);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.492245512073563e-07);
    AssertAlmostEqual(&test, rTM, 0.9997994179519918);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8223733148952053);
    AssertAlmostEqual(&test, rTM, 0.8223733148952053);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8223733148952045);
    AssertAlmostEqual(&test, rTM, 0.822373314895206);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8223733148951251);
    AssertAlmostEqual(&test, rTM, 0.8223733148952854);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8223733148871896);
    AssertAlmostEqual(&test, rTM, 0.822373314903221);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8223733140936382);
    AssertAlmostEqual(&test, rTM, 0.8223733156967723);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8223732347385213);
    AssertAlmostEqual(&test, rTM, 0.8223733950518566);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8223652994657434);
    AssertAlmostEqual(&test, rTM, 0.8223813299982377);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8215741493067015);
    AssertAlmostEqual(&test, rTM, 0.8231692485155631);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7587160951733705);
    AssertAlmostEqual(&test, rTM, 0.8704729304224688);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1754533534086559);
    AssertAlmostEqual(&test, rTM, 0.9732748909191801);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002592711744435603);
    AssertAlmostEqual(&test, rTM, 0.9810810954186517);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.606330669859119e-05);
    AssertAlmostEqual(&test, rTM, 0.9811770514853586);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.606467756028406e-07);
    AssertAlmostEqual(&test, rTM, 0.9811780136833073);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1772491784318949);
    AssertAlmostEqual(&test, rTM, 0.1772491784318949);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1772491784318949);
    AssertAlmostEqual(&test, rTM, 0.1772491784318949);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1772491784318937);
    AssertAlmostEqual(&test, rTM, 0.1772491784318962);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.177249178431771);
    AssertAlmostEqual(&test, rTM, 0.1772491784320188);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1772491784195074);
    AssertAlmostEqual(&test, rTM, 0.1772491784442825);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1772491771931435);
    AssertAlmostEqual(&test, rTM, 0.1772491796706463);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.177249054556844);
    AssertAlmostEqual(&test, rTM, 0.1772493023069402);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1772367918116102);
    AssertAlmostEqual(&test, rTM, 0.1772615649960256);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1760192991598462);
    AssertAlmostEqual(&test, rTM, 0.1784785043448846);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1048971063573536);
    AssertAlmostEqual(&test, rTM, 0.2477347475178352);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002579188354829645);
    AssertAlmostEqual(&test, rTM, 0.3414237061127189);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.61807096167134e-05);
    AssertAlmostEqual(&test, rTM, 0.3436771452066479);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.61846588403103e-07);
    AssertAlmostEqual(&test, rTM, 0.3437000024859972);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.00260603985888557);
    AssertAlmostEqual(&test, rTM, 0.00260603985888557);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.00260603985888557);
    AssertAlmostEqual(&test, rTM, 0.00260603985888557);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.00260603985888557);
    AssertAlmostEqual(&test, rTM, 0.00260603985888557);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002606039858885544);
    AssertAlmostEqual(&test, rTM, 0.002606039858885596);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002606039858882977);
    AssertAlmostEqual(&test, rTM, 0.002606039858888162);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.00260603985862632);
    AssertAlmostEqual(&test, rTM, 0.002606039859144819);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002606039832960647);
    AssertAlmostEqual(&test, rTM, 0.002606039884810492);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002606037266395872);
    AssertAlmostEqual(&test, rTM, 0.002606042451375267);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002605780635445637);
    AssertAlmostEqual(&test, rTM, 0.002606299082325152);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002580370298992065);
    AssertAlmostEqual(&test, rTM, 0.002631709415344675);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001306417857889516);
    AssertAlmostEqual(&test, rTM, 0.003905653056588418);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.593604100502218e-05);
    AssertAlmostEqual(&test, rTM, 0.005186108980517462);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619412714121023e-07);
    AssertAlmostEqual(&test, rTM, 0.005211782386309306);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619659446609506e-05);
    AssertAlmostEqual(&test, rTM, 2.619659446609506e-05);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619659446609506e-05);
    AssertAlmostEqual(&test, rTM, 2.619659446609506e-05);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619659446609506e-05);
    AssertAlmostEqual(&test, rTM, 2.619659446609506e-05);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619659446609506e-05);
    AssertAlmostEqual(&test, rTM, 2.619659446609506e-05);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.61965944660948e-05);
    AssertAlmostEqual(&test, rTM, 2.619659446609532e-05);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619659446606886e-05);
    AssertAlmostEqual(&test, rTM, 2.619659446612125e-05);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619659446347554e-05);
    AssertAlmostEqual(&test, rTM, 2.619659446871458e-05);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619659420414284e-05);
    AssertAlmostEqual(&test, rTM, 2.619659472804728e-05);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619656827089927e-05);
    AssertAlmostEqual(&test, rTM, 2.619662066129085e-05);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619397520580947e-05);
    AssertAlmostEqual(&test, rTM, 2.619921372638065e-05);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.593723569810469e-05);
    AssertAlmostEqual(&test, rTM, 2.64559532340819e-05);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.309864036607549e-05);
    AssertAlmostEqual(&test, rTM, 3.929454855712624e-05);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.593856777465368e-07);
    AssertAlmostEqual(&test, rTM, 5.213380321919665e-05);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.61980739990018e-07);
    AssertAlmostEqual(&test, rTM, 2.61980739990018e-07);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.61980739990018e-07);
    AssertAlmostEqual(&test, rTM, 2.61980739990018e-07);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.61980739990018e-07);
    AssertAlmostEqual(&test, rTM, 2.61980739990018e-07);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.61980739990018e-07);
    AssertAlmostEqual(&test, rTM, 2.61980739990018e-07);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.61980739990018e-07);
    AssertAlmostEqual(&test, rTM, 2.61980739990018e-07);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619807399900154e-07);
    AssertAlmostEqual(&test, rTM, 2.619807399900206e-07);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.61980739989756e-07);
    AssertAlmostEqual(&test, rTM, 2.6198073999028e-07);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619807399638199e-07);
    AssertAlmostEqual(&test, rTM, 2.61980740016216e-07);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.61980737370212e-07);
    AssertAlmostEqual(&test, rTM, 2.61980742609824e-07);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619804780096773e-07);
    AssertAlmostEqual(&test, rTM, 2.619810019703587e-07);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619545445492885e-07);
    AssertAlmostEqual(&test, rTM, 2.620069354307475e-07);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.593868726228762e-07);
    AssertAlmostEqual(&test, rTM, 2.645746073571598e-07);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.309904043119653e-07);
    AssertAlmostEqual(&test, rTM, 3.929710756680617e-07);

    userdata[0] = 2/CAPS_HBAR_EV; /* 2eV */
    userdata[1] = 0.003/CAPS_HBAR_EV; /* 0.003eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999965762064491);
    AssertAlmostEqual(&test, rTM, 0.9999982881017593);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999756696297031);
    AssertAlmostEqual(&test, rTM, 0.999999759102343);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999757918024337);
    AssertAlmostEqual(&test, rTM, 0.9999999757912927);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9975819358376032);
    AssertAlmostEqual(&test, rTM, 0.9999999975790077);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9760813684502505);
    AssertAlmostEqual(&test, rTM, 0.9999999997578831);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7854395383430788);
    AssertAlmostEqual(&test, rTM, 0.9999999999756134);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1293348795287405);
    AssertAlmostEqual(&test, rTM, 0.9999999999961987);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001700337832268005);
    AssertAlmostEqual(&test, rTM, 0.9999999999970595);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.706076695607021e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999970693);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.706134328871624e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999970693);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.70613490522885e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999999970693);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.706134910992425e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999999970693);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.70613491105006e-13);
    AssertAlmostEqual(&test, rTM, 0.9999999999970693);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999923059748058);
    AssertAlmostEqual(&test, rTM, 0.9999923821529829);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999989173022489);
    AssertAlmostEqual(&test, rTM, 0.9999945864965915);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999230624119337);
    AssertAlmostEqual(&test, rTM, 0.9999992382126863);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9992346676903012);
    AssertAlmostEqual(&test, rTM, 0.9999999234451183);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9923733756253484);
    AssertAlmostEqual(&test, rTM, 0.9999999923440771);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9263158402532162);
    AssertAlmostEqual(&test, rTM, 0.9999999992338522);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.473300372599891);
    AssertAlmostEqual(&test, rTM, 0.9999999999180239);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01650277953596499);
    AssertAlmostEqual(&test, rTM, 0.9999999999697103);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001705542986875956);
    AssertAlmostEqual(&test, rTM, 0.9999999999706838);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.706119089422685e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999706938);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.706124852905037e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999706938);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.706124910540106e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999999706938);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.706124911116457e-12);
    AssertAlmostEqual(&test, rTM, 0.9999999999706938);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999923419511758);
    AssertAlmostEqual(&test, rTM, 0.9999234195883354);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999234157212665);
    AssertAlmostEqual(&test, rTM, 0.9999234233786355);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999230376149945);
    AssertAlmostEqual(&test, rTM, 0.9999237995897727);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999891700606807);
    AssertAlmostEqual(&test, rTM, 0.9999458488371896);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999230642658432);
    AssertAlmostEqual(&test, rTM, 0.9999923796971171);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9923705507034862);
    AssertAlmostEqual(&test, rTM, 0.9999992341991444);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9262929646176294);
    AssertAlmostEqual(&test, rTM, 0.9999999233605341);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4731913133602599);
    AssertAlmostEqual(&test, rTM, 0.999999991799406);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01649249162881471);
    AssertAlmostEqual(&test, rTM, 0.999999996969142);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001704444459416051);
    AssertAlmostEqual(&test, rTM, 0.9999999970664929);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.705019819983538e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999970674828);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.705025576041352e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999970674927);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.705025633602176e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999970674928);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997571433457053);
    AssertAlmostEqual(&test, rTM, 0.9997571433481336);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997571432255059);
    AssertAlmostEqual(&test, rTM, 0.999757143468333);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997571312058651);
    AssertAlmostEqual(&test, rTM, 0.999757155487367);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999755932232111);
    AssertAlmostEqual(&test, rTM, 0.9997583484526517);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996565661038171);
    AssertAlmostEqual(&test, rTM, 0.9998282683047549);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9975620017840632);
    AssertAlmostEqual(&test, rTM, 0.9999758321993634);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9760033773921246);
    AssertAlmostEqual(&test, rTM, 0.9999975710838266);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7848260599342092);
    AssertAlmostEqual(&test, rTM, 0.9999997553294682);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1286888783442824);
    AssertAlmostEqual(&test, rTM, 0.9999999617900497);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001689374334861079);
    AssertAlmostEqual(&test, rTM, 0.9999999704033293);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.695039338687377e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999705021604);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.695096228646926e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999705031504);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.695096797570628e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999705031603);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9992101915583022);
    AssertAlmostEqual(&test, rTM, 0.9992101915583811);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9992101915543942);
    AssertAlmostEqual(&test, rTM, 0.9992101915622891);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9992101911635936);
    AssertAlmostEqual(&test, rTM, 0.9992101919530896);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9992101520845083);
    AssertAlmostEqual(&test, rTM, 0.999210231030203);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9992062539036711);
    AssertAlmostEqual(&test, rTM, 0.9992141096865801);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.99888322495337);
    AssertAlmostEqual(&test, rTM, 0.9994414564476849);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9920908510782408);
    AssertAlmostEqual(&test, rTM, 0.9999213825523554);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9240441180504274);
    AssertAlmostEqual(&test, rTM, 0.9999920930585597);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4626010073827688);
    AssertAlmostEqual(&test, rTM, 0.9999991504568161);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0155246910002618);
    AssertAlmostEqual(&test, rTM, 0.9999996780101269);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001601305567674604);
    AssertAlmostEqual(&test, rTM, 0.9999996877548913);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.601813395320114e-06);
    AssertAlmostEqual(&test, rTM, 0.9999996878538753);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.601818475629886e-08);
    AssertAlmostEqual(&test, rTM, 0.9999996878548653);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9968938439000545);
    AssertAlmostEqual(&test, rTM, 0.9968938439000576);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.996893843899901);
    AssertAlmostEqual(&test, rTM, 0.9968938439002111);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9968938438845494);
    AssertAlmostEqual(&test, rTM, 0.9968938439155627);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9968938423493942);
    AssertAlmostEqual(&test, rTM, 0.9968938454507171);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9968936888377199);
    AssertAlmostEqual(&test, rTM, 0.9968939989546638);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9968783759716122);
    AssertAlmostEqual(&test, rTM, 0.9969092353021511);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9956100612930959);
    AssertAlmostEqual(&test, rTM, 0.9978026137437754);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9692198552075983);
    AssertAlmostEqual(&test, rTM, 0.9996904556225564);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.733539786637521);
    AssertAlmostEqual(&test, rTM, 0.9999685180807726);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.08626630652147964);
    AssertAlmostEqual(&test, rTM, 0.9999942471637232);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001031113040617213);
    AssertAlmostEqual(&test, rTM, 0.9999951508998368);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.033221381139294e-05);
    AssertAlmostEqual(&test, rTM, 0.9999951607894547);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.033242518982888e-07);
    AssertAlmostEqual(&test, rTM, 0.999995160888453);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9792352244905254);
    AssertAlmostEqual(&test, rTM, 0.9792352244905256);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9792352244905153);
    AssertAlmostEqual(&test, rTM, 0.9792352244905358);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9792352244894982);
    AssertAlmostEqual(&test, rTM, 0.9792352244915529);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9792352243877909);
    AssertAlmostEqual(&test, rTM, 0.9792352245932602);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9792352142170653);
    AssertAlmostEqual(&test, rTM, 0.9792352347639808);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9792341971704617);
    AssertAlmostEqual(&test, rTM, 0.9792362517602992);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9791327508124084);
    AssertAlmostEqual(&test, rTM, 0.979337200200644);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9707615061085652);
    AssertAlmostEqual(&test, rTM, 0.9852714959794155);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8101826590820688);
    AssertAlmostEqual(&test, rTM, 0.9979028932009858);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1601675204710798);
    AssertAlmostEqual(&test, rTM, 0.9996959453426688);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002260820930491721);
    AssertAlmostEqual(&test, rTM, 0.9997788915373934);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.27097742321255e-05);
    AssertAlmostEqual(&test, rTM, 0.9997798789492103);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.27107956441832e-07);
    AssertAlmostEqual(&test, rTM, 0.9997798888457147);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8215594347182119);
    AssertAlmostEqual(&test, rTM, 0.8215594347182119);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8215594347182111);
    AssertAlmostEqual(&test, rTM, 0.8215594347182127);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8215594347181314);
    AssertAlmostEqual(&test, rTM, 0.8215594347182924);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8215594347101639);
    AssertAlmostEqual(&test, rTM, 0.8215594347262599);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8215594339134096);
    AssertAlmostEqual(&test, rTM, 0.8215594355230142);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.821559354238002);
    AssertAlmostEqual(&test, rTM, 0.8215595151983891);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8215513869373288);
    AssertAlmostEqual(&test, rTM, 0.8215674821717041);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8207570457153248);
    AssertAlmostEqual(&test, rTM, 0.8223585822364482);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7576594367734139);
    AssertAlmostEqual(&test, rTM, 0.8698579283201799);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1742090383000196);
    AssertAlmostEqual(&test, rTM, 0.9730772223064789);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.00256670585320287);
    AssertAlmostEqual(&test, rTM, 0.9808930688765577);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.580054987709343e-05);
    AssertAlmostEqual(&test, rTM, 0.980988999973133);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.580189349446984e-07);
    AssertAlmostEqual(&test, rTM, 0.9809899618956095);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1771225280990259);
    AssertAlmostEqual(&test, rTM, 0.1771225280990259);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1771225280990259);
    AssertAlmostEqual(&test, rTM, 0.1771225280990259);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1771225280990247);
    AssertAlmostEqual(&test, rTM, 0.1771225280990271);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1771225280989021);
    AssertAlmostEqual(&test, rTM, 0.1771225280991497);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.177122528086644);
    AssertAlmostEqual(&test, rTM, 0.1771225281114078);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1771225268608358);
    AssertAlmostEqual(&test, rTM, 0.1771225293372159);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.177122404280112);
    AssertAlmostEqual(&test, rTM, 0.1771226519179342);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1771101470922355);
    AssertAlmostEqual(&test, rTM, 0.1771349090497558);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1758932080741944);
    AssertAlmostEqual(&test, rTM, 0.1783512956882574);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1048102316261157);
    AssertAlmostEqual(&test, rTM, 0.2475717288099278);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002576565684964744);
    AssertAlmostEqual(&test, rTM, 0.3411949764564263);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.615395139535683e-05);
    AssertAlmostEqual(&test, rTM, 0.3434465254095287);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.615789519670295e-07);
    AssertAlmostEqual(&test, rTM, 0.3434693634307346);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002605774510821684);
    AssertAlmostEqual(&test, rTM, 0.002605774510821684);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002605774510821684);
    AssertAlmostEqual(&test, rTM, 0.002605774510821684);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002605774510821684);
    AssertAlmostEqual(&test, rTM, 0.002605774510821684);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002605774510821658);
    AssertAlmostEqual(&test, rTM, 0.00260577451082171);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002605774510819091);
    AssertAlmostEqual(&test, rTM, 0.002605774510824276);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002605774510562461);
    AssertAlmostEqual(&test, rTM, 0.002605774511080907);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002605774484899387);
    AssertAlmostEqual(&test, rTM, 0.00260577453674398);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002605771918594578);
    AssertAlmostEqual(&test, rTM, 0.002605777103048789);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002605515313638448);
    AssertAlmostEqual(&test, rTM, 0.002606033708004569);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002580107551125841);
    AssertAlmostEqual(&test, rTM, 0.002631441467084173);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001306284491711781);
    AssertAlmostEqual(&test, rTM, 0.003905255729322483);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.59333865254976e-05);
    AssertAlmostEqual(&test, rTM, 0.005185580949466081);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619144610966018e-07);
    AssertAlmostEqual(&test, rTM, 0.005211251727801028);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619632631454148e-05);
    AssertAlmostEqual(&test, rTM, 2.619632631454148e-05);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619632631454148e-05);
    AssertAlmostEqual(&test, rTM, 2.619632631454148e-05);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619632631454148e-05);
    AssertAlmostEqual(&test, rTM, 2.619632631454148e-05);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619632631454148e-05);
    AssertAlmostEqual(&test, rTM, 2.619632631454149e-05);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619632631454122e-05);
    AssertAlmostEqual(&test, rTM, 2.619632631454174e-05);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619632631451529e-05);
    AssertAlmostEqual(&test, rTM, 2.619632631456768e-05);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619632631192199e-05);
    AssertAlmostEqual(&test, rTM, 2.619632631716098e-05);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619632605259195e-05);
    AssertAlmostEqual(&test, rTM, 2.619632657649102e-05);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619630011961382e-05);
    AssertAlmostEqual(&test, rTM, 2.619635250946915e-05);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619370708106556e-05);
    AssertAlmostEqual(&test, rTM, 2.619894554801741e-05);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.593697020124155e-05);
    AssertAlmostEqual(&test, rTM, 2.645568242783789e-05);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.309850628327402e-05);
    AssertAlmostEqual(&test, rTM, 3.929414633682084e-05);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.593830225051955e-07);
    AssertAlmostEqual(&test, rTM, 5.213326957133192e-05);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619804718057038e-07);
    AssertAlmostEqual(&test, rTM, 2.619804718057038e-07);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619804718057038e-07);
    AssertAlmostEqual(&test, rTM, 2.619804718057038e-07);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619804718057038e-07);
    AssertAlmostEqual(&test, rTM, 2.619804718057038e-07);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619804718057038e-07);
    AssertAlmostEqual(&test, rTM, 2.619804718057038e-07);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619804718057037e-07);
    AssertAlmostEqual(&test, rTM, 2.619804718057038e-07);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619804718057011e-07);
    AssertAlmostEqual(&test, rTM, 2.619804718057064e-07);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619804718054418e-07);
    AssertAlmostEqual(&test, rTM, 2.619804718059658e-07);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619804717795057e-07);
    AssertAlmostEqual(&test, rTM, 2.619804718319018e-07);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619804691859004e-07);
    AssertAlmostEqual(&test, rTM, 2.61980474425507e-07);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619802098256312e-07);
    AssertAlmostEqual(&test, rTM, 2.619807337857763e-07);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619542763917899e-07);
    AssertAlmostEqual(&test, rTM, 2.620066672196176e-07);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.593866070938494e-07);
    AssertAlmostEqual(&test, rTM, 2.645743365175581e-07);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.309902702197379e-07);
    AssertAlmostEqual(&test, rTM, 3.929706733916606e-07);

    userdata[0] = 2/CAPS_HBAR_EV; /* 2eV */
    userdata[1] = 0.035/CAPS_HBAR_EV; /* 0.035eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999883055705261);
    AssertAlmostEqual(&test, rTM, 0.9999941527681679);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999168984313808);
    AssertAlmostEqual(&test, rTM, 0.9999991771783401);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991733746478962);
    AssertAlmostEqual(&test, rTM, 0.9999999173115434);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9917648568022099);
    AssertAlmostEqual(&test, rTM, 0.9999999917306748);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9206557922988455);
    AssertAlmostEqual(&test, rTM, 0.9999999991723676);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4470824367466289);
    AssertAlmostEqual(&test, rTM, 0.9999999999105179);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01421132233536675);
    AssertAlmostEqual(&test, rTM, 0.9999999999648239);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001461974655336527);
    AssertAlmostEqual(&test, rTM, 0.9999999999657997);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.462397945851919e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999658096);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.462402180304402e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999658097);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.462402222649081e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999999658097);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.462402223072528e-12);
    AssertAlmostEqual(&test, rTM, 0.9999999999658097);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.462402223076763e-14);
    AssertAlmostEqual(&test, rTM, 0.9999999999658097);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999737202233396);
    AssertAlmostEqual(&test, rTM, 0.999973980415763);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999630194251992);
    AssertAlmostEqual(&test, rTM, 0.9999815095416494);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997372333101673);
    AssertAlmostEqual(&test, rTM, 0.9999973980110879);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9973883165215156);
    AssertAlmostEqual(&test, rTM, 0.9999997385158972);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9741899568298128);
    AssertAlmostEqual(&test, rTM, 0.9999999738480796);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7704676531650937);
    AssertAlmostEqual(&test, rTM, 0.9999999973627732);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1146337596774499);
    AssertAlmostEqual(&test, rTM, 0.99999999956956);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001458139825995044);
    AssertAlmostEqual(&test, rTM, 0.9999999996570981);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.462358717584795e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999996580866);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.462401060659913e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999996580965);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.462401484106143e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999996580966);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.462401488340607e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999996580966);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.462401488382952e-13);
    AssertAlmostEqual(&test, rTM, 0.9999999996580966);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997385298465221);
    AssertAlmostEqual(&test, rTM, 0.9997385301079578);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997385169057751);
    AssertAlmostEqual(&test, rTM, 0.9997385430480515);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999737226050625);
    AssertAlmostEqual(&test, rTM, 0.9997398274344031);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996302455738402);
    AssertAlmostEqual(&test, rTM, 0.9998151056923875);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9973753663333752);
    AssertAlmostEqual(&test, rTM, 0.9999739796748045);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9741879921025666);
    AssertAlmostEqual(&test, rTM, 0.9999973848685421);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7704620343309263);
    AssertAlmostEqual(&test, rTM, 0.9999997362700765);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1146287270616071);
    AssertAlmostEqual(&test, rTM, 0.9999999569540624);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001458059484206474);
    AssertAlmostEqual(&test, rTM, 0.9999999657079204);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.462277910539698e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999658067745);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.462320248936739e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999658077645);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.462320672336185e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999658077744);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.462320676570182e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999658077745);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991731854020591);
    AssertAlmostEqual(&test, rTM, 0.9991731854103238);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991731849929553);
    AssertAlmostEqual(&test, rTM, 0.9991731858194275);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991731440835933);
    AssertAlmostEqual(&test, rTM, 0.9991732267267254);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991690633310638);
    AssertAlmostEqual(&test, rTM, 0.9991772870411201);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9988309078818705);
    AssertAlmostEqual(&test, rTM, 0.9994152829439542);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9917216585716404);
    AssertAlmostEqual(&test, rTM, 0.9999176975305127);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9206307633346141);
    AssertAlmostEqual(&test, rTM, 0.9999917218115921);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4469869440578126);
    AssertAlmostEqual(&test, rTM, 0.9999991048940162);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01420361657249157);
    AssertAlmostEqual(&test, rTM, 0.9999996480481238);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001461159342529743);
    AssertAlmostEqual(&test, rTM, 0.9999996578060971);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.461582161150003e-06);
    AssertAlmostEqual(&test, rTM, 0.9999996579050824);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.461586390880948e-08);
    AssertAlmostEqual(&test, rTM, 0.9999996579060724);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.461586433178412e-10);
    AssertAlmostEqual(&test, rTM, 0.9999996579060824);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9973811783763421);
    AssertAlmostEqual(&test, rTM, 0.9973811783766036);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9973811783633959);
    AssertAlmostEqual(&test, rTM, 0.9973811783895498);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9973811770687792);
    AssertAlmostEqual(&test, rTM, 0.9973811796841658);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9973810476103497);
    AssertAlmostEqual(&test, rTM, 0.9973813091360753);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9973681340516622);
    AssertAlmostEqual(&test, rTM, 0.9973941581340056);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9962984377574754);
    AssertAlmostEqual(&test, rTM, 0.9981475014153851);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9739916005439659);
    AssertAlmostEqual(&test, rTM, 0.9997390874680293);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7699011114160362);
    AssertAlmostEqual(&test, rTM, 0.9999735546898804);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1141277160427195);
    AssertAlmostEqual(&test, rTM, 0.9999956760282199);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001450069770420207);
    AssertAlmostEqual(&test, rTM, 0.9999965519092094);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.454242057086762e-05);
    AssertAlmostEqual(&test, rTM, 0.9999965617946591);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.454283931564161e-07);
    AssertAlmostEqual(&test, rTM, 0.9999965618936572);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.454284350324158e-09);
    AssertAlmostEqual(&test, rTM, 0.9999965618946471);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9915390988014963);
    AssertAlmostEqual(&test, rTM, 0.9915390988015047);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9915390988010793);
    AssertAlmostEqual(&test, rTM, 0.9915390988019217);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9915390987593757);
    AssertAlmostEqual(&test, rTM, 0.9915390988436252);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9915390945890237);
    AssertAlmostEqual(&test, rTM, 0.9915391030139752);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9915386775643354);
    AssertAlmostEqual(&test, rTM, 0.9915395200177839);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9914970797038686);
    AssertAlmostEqual(&test, rTM, 0.9915809111301189);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9880555165502281);
    AssertAlmostEqual(&test, rTM, 0.9940097632333953);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9181751611991894);
    AssertAlmostEqual(&test, rTM, 0.9991541274033727);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4377759929768021);
    AssertAlmostEqual(&test, rTM, 0.9999076902945501);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01347994135329563);
    AssertAlmostEqual(&test, rTM, 0.9999629159845331);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000138470197146789);
    AssertAlmostEqual(&test, rTM, 0.9999638924516292);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.385081707845064e-06);
    AssertAlmostEqual(&test, rTM, 0.9999639023497086);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.385085506523596e-08);
    AssertAlmostEqual(&test, rTM, 0.999963902448703);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9678862064201904);
    AssertAlmostEqual(&test, rTM, 0.9678862064201907);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9678862064201749);
    AssertAlmostEqual(&test, rTM, 0.9678862064202064);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9678862064186111);
    AssertAlmostEqual(&test, rTM, 0.9678862064217701);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.967886206262242);
    AssertAlmostEqual(&test, rTM, 0.9678862065781393);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9678861906253292);
    AssertAlmostEqual(&test, rTM, 0.9678862222150444);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9678846269744306);
    AssertAlmostEqual(&test, rTM, 0.9678877857895406);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9677286636030918);
    AssertAlmostEqual(&test, rTM, 0.9680429926323395);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9548901720441251);
    AssertAlmostEqual(&test, rTM, 0.9771818169322767);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.721374671872805);
    AssertAlmostEqual(&test, rTM, 0.9967148581637919);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0795121928214936);
    AssertAlmostEqual(&test, rTM, 0.9993755651234778);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0009367562640551267);
    AssertAlmostEqual(&test, rTM, 0.9994665287066589);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -9.384970711263439e-06);
    AssertAlmostEqual(&test, rTM, 0.9994675169786659);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -9.385145200387489e-08);
    AssertAlmostEqual(&test, rTM, 0.9994675268706661);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8091614297889236);
    AssertAlmostEqual(&test, rTM, 0.8091614297889237);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8091614297889228);
    AssertAlmostEqual(&test, rTM, 0.8091614297889245);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8091614297888383);
    AssertAlmostEqual(&test, rTM, 0.809161429789009);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8091614297803882);
    AssertAlmostEqual(&test, rTM, 0.8091614297974591);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8091614289353833);
    AssertAlmostEqual(&test, rTM, 0.8091614306424639);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8091613444349245);
    AssertAlmostEqual(&test, rTM, 0.8091615151428887);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8091528946471641);
    AssertAlmostEqual(&test, rTM, 0.8091699645892342);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8083104842051526);
    AssertAlmostEqual(&test, rTM, 0.8100089947517455);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7416223367182808);
    AssertAlmostEqual(&test, rTM, 0.860460506351575);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1565098097157335);
    AssertAlmostEqual(&test, rTM, 0.9699460687215898);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002211750874199258);
    AssertAlmostEqual(&test, rTM, 0.9778944218054035);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.221688326305031e-05);
    AssertAlmostEqual(&test, rTM, 0.9779899491727765);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.221788259875534e-07);
    AssertAlmostEqual(&test, rTM, 0.9779909067061385);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1751212293538841);
    AssertAlmostEqual(&test, rTM, 0.1751212293538841);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.175121229353884);
    AssertAlmostEqual(&test, rTM, 0.1751212293538841);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1751212293538828);
    AssertAlmostEqual(&test, rTM, 0.1751212293538853);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1751212293537611);
    AssertAlmostEqual(&test, rTM, 0.175121229354007);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1751212293415914);
    AssertAlmostEqual(&test, rTM, 0.1751212293661767);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.175121228124617);
    AssertAlmostEqual(&test, rTM, 0.1751212305831511);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1751211064272649);
    AssertAlmostEqual(&test, rTM, 0.1751213522804977);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1751089375731905);
    AssertAlmostEqual(&test, rTM, 0.1751335210799863);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1739007982010954);
    AssertAlmostEqual(&test, rTM, 0.1763411225700706);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1034397589541024);
    AssertAlmostEqual(&test, rTM, 0.2449930076305546);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002535316751268535);
    AssertAlmostEqual(&test, rTM, 0.3375765400263998);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.573313894938138e-05);
    AssertAlmostEqual(&test, rTM, 0.3397982546696445);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.57369978508461e-07);
    AssertAlmostEqual(&test, rTM, 0.3398207887385565);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002601536278751726);
    AssertAlmostEqual(&test, rTM, 0.002601536278751726);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002601536278751726);
    AssertAlmostEqual(&test, rTM, 0.002601536278751726);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002601536278751725);
    AssertAlmostEqual(&test, rTM, 0.002601536278751726);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0026015362787517);
    AssertAlmostEqual(&test, rTM, 0.002601536278751751);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002601536278749138);
    AssertAlmostEqual(&test, rTM, 0.002601536278754314);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002601536278492922);
    AssertAlmostEqual(&test, rTM, 0.002601536279010529);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002601536252871372);
    AssertAlmostEqual(&test, rTM, 0.00260153630463208);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002601533690718881);
    AssertAlmostEqual(&test, rTM, 0.002601538866784571);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002601277500953415);
    AssertAlmostEqual(&test, rTM, 0.002601795056549689);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002575910850693618);
    AssertAlmostEqual(&test, rTM, 0.002627161703393148);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001304154330044321);
    AssertAlmostEqual(&test, rTM, 0.00389890946964766);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.589098862881151e-05);
    AssertAlmostEqual(&test, rTM, 0.005177147052187375);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.61486241223439e-07);
    AssertAlmostEqual(&test, rTM, 0.00520277586423076);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619203663615635e-05);
    AssertAlmostEqual(&test, rTM, 2.619203663615635e-05);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619203663615635e-05);
    AssertAlmostEqual(&test, rTM, 2.619203663615635e-05);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619203663615635e-05);
    AssertAlmostEqual(&test, rTM, 2.619203663615635e-05);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619203663615635e-05);
    AssertAlmostEqual(&test, rTM, 2.619203663615635e-05);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619203663615609e-05);
    AssertAlmostEqual(&test, rTM, 2.619203663615661e-05);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619203663613016e-05);
    AssertAlmostEqual(&test, rTM, 2.619203663618254e-05);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619203663353728e-05);
    AssertAlmostEqual(&test, rTM, 2.619203663877542e-05);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.61920363742497e-05);
    AssertAlmostEqual(&test, rTM, 2.619203689806299e-05);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619201044551791e-05);
    AssertAlmostEqual(&test, rTM, 2.619206282679479e-05);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.618941783156044e-05);
    AssertAlmostEqual(&test, rTM, 2.619465544075226e-05);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.593272299051379e-05);
    AssertAlmostEqual(&test, rTM, 2.645135028179539e-05);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.309636133171573e-05);
    AssertAlmostEqual(&test, rTM, 3.928771193161327e-05);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.593405460356974e-07);
    AssertAlmostEqual(&test, rTM, 5.212473269104846e-05);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619761809313481e-07);
    AssertAlmostEqual(&test, rTM, 2.619761809313481e-07);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619761809313481e-07);
    AssertAlmostEqual(&test, rTM, 2.619761809313481e-07);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619761809313481e-07);
    AssertAlmostEqual(&test, rTM, 2.619761809313481e-07);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619761809313481e-07);
    AssertAlmostEqual(&test, rTM, 2.619761809313481e-07);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619761809313481e-07);
    AssertAlmostEqual(&test, rTM, 2.619761809313481e-07);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619761809313455e-07);
    AssertAlmostEqual(&test, rTM, 2.619761809313507e-07);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619761809310861e-07);
    AssertAlmostEqual(&test, rTM, 2.619761809316101e-07);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619761809051505e-07);
    AssertAlmostEqual(&test, rTM, 2.619761809575457e-07);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619761783115877e-07);
    AssertAlmostEqual(&test, rTM, 2.619761835511085e-07);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619759189555664e-07);
    AssertAlmostEqual(&test, rTM, 2.619764429071298e-07);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619499859464784e-07);
    AssertAlmostEqual(&test, rTM, 2.620023759162178e-07);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.593823587033542e-07);
    AssertAlmostEqual(&test, rTM, 2.64570003159342e-07);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.30988124781436e-07);
    AssertAlmostEqual(&test, rTM, 3.929642370812512e-07);

    userdata[0] = 2/CAPS_HBAR_EV; /* 2eV */
    userdata[1] = 0.05/CAPS_HBAR_EV; /* 0.05eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999860224993959);
    AssertAlmostEqual(&test, rTM, 0.9999930112252764);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999006754342853);
    AssertAlmostEqual(&test, rTM, 0.9999990165400986);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9990120734906555);
    AssertAlmostEqual(&test, rTM, 0.9999999011683889);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9901650631976573);
    AssertAlmostEqual(&test, rTM, 0.9999999901162298);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9059271715297338);
    AssertAlmostEqual(&test, rTM, 0.9999999990104285);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3859662659567496);
    AssertAlmostEqual(&test, rTM, 0.9999999998897533);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01003244547668153);
    AssertAlmostEqual(&test, rTM, 0.9999999999501668);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001023472042125561);
    AssertAlmostEqual(&test, rTM, 0.9999999999511466);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.023679477454056e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999511566);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.023681552338141e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999511567);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.023681573087035e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999999511567);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.023681573294524e-12);
    AssertAlmostEqual(&test, rTM, 0.9999999999511567);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.023681573296599e-14);
    AssertAlmostEqual(&test, rTM, 0.9999999999511567);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999968589742296);
    AssertAlmostEqual(&test, rTM, 0.9999689007301107);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999557999222674);
    AssertAlmostEqual(&test, rTM, 0.9999778997169197);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996859418177124);
    AssertAlmostEqual(&test, rTM, 0.99999689002945);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9968792381905199);
    AssertAlmostEqual(&test, rTM, 0.9999996874666391);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9692297364805258);
    AssertAlmostEqual(&test, rTM, 0.9999999687413345);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7325012168058611);
    AssertAlmostEqual(&test, rTM, 0.9999999968365789);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.08559392444112318);
    AssertAlmostEqual(&test, rTM, 0.9999999994201261);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001021590715212501);
    AssertAlmostEqual(&test, rTM, 0.9999999995105677);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.023660255368589e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999995115567);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.023681003712183e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999995115666);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.023681211200928e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999995115667);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.023681213275816e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999995115667);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.023681213296565e-13);
    AssertAlmostEqual(&test, rTM, 0.9999999995115667);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996874939855839);
    AssertAlmostEqual(&test, rTM, 0.9996874942980407);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999687478519352);
    AssertAlmostEqual(&test, rTM, 0.9996875097634919);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996859357442295);
    AssertAlmostEqual(&test, rTM, 0.9996890448077755);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995580785844999);
    AssertAlmostEqual(&test, rTM, 0.999779014872339);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.996863793637453);
    AssertAlmostEqual(&test, rTM, 0.9999689000910051);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9692276513126337);
    AssertAlmostEqual(&test, rTM, 0.9999968742325654);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7324967298060526);
    AssertAlmostEqual(&test, rTM, 0.999999683651835);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.08559113484309501);
    AssertAlmostEqual(&test, rTM, 0.9999999420106944);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001021551278195863);
    AssertAlmostEqual(&test, rTM, 0.9999999510548845);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.023620658551698e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999511537823);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.023641405291155e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999511547722);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.023641612763859e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999511547821);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.023641614838586e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999511547822);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9990119299826995);
    AssertAlmostEqual(&test, rTM, 0.9990119299925753);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9990119294938467);
    AssertAlmostEqual(&test, rTM, 0.9990119304814278);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9990118806097915);
    AssertAlmostEqual(&test, rTM, 0.999011979363017);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9990070043750633);
    AssertAlmostEqual(&test, rTM, 0.9990168311794325);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9986029440464589);
    AssertAlmostEqual(&test, rTM, 0.9993012277966636);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9901143383217037);
    AssertAlmostEqual(&test, rTM, 0.9999016383994039);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.905905231315724);
    AssertAlmostEqual(&test, rTM, 0.9999901028914104);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3858992987056385);
    AssertAlmostEqual(&test, rTM, 0.9999988972768209);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01002860496666138);
    AssertAlmostEqual(&test, rTM, 0.9999995014765628);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001023072401874764);
    AssertAlmostEqual(&test, rTM, 0.9999995112762797);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.02327967532734e-06);
    AssertAlmostEqual(&test, rTM, 0.9999995113752694);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.023281748592044e-08);
    AssertAlmostEqual(&test, rTM, 0.9999995113762594);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.023281769324745e-10);
    AssertAlmostEqual(&test, rTM, 0.9999995113762693);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9968733132347588);
    AssertAlmostEqual(&test, rTM, 0.996873313235071);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9968733132193059);
    AssertAlmostEqual(&test, rTM, 0.9968733132505239);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9968733116740198);
    AssertAlmostEqual(&test, rTM, 0.9968733147958092);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9968731571492778);
    AssertAlmostEqual(&test, rTM, 0.9968734693127727);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9968577432299596);
    AssertAlmostEqual(&test, rTM, 0.996888806210091);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9955810640974451);
    AssertAlmostEqual(&test, rTM, 0.9977880830579587);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9690192954727761);
    AssertAlmostEqual(&test, rTM, 0.999688406251657);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7320485839772267);
    AssertAlmostEqual(&test, rTM, 0.9999683047011457);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.08531309674234239);
    AssertAlmostEqual(&test, rTM, 0.9999941819286897);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001017622893703825);
    AssertAlmostEqual(&test, rTM, 0.9999950866177822);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.019676387102186e-05);
    AssertAlmostEqual(&test, rTM, 0.9999950965075342);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.019696974363473e-07);
    AssertAlmostEqual(&test, rTM, 0.9999950966065324);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.019697180241333e-09);
    AssertAlmostEqual(&test, rTM, 0.9999950966075224);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9899757198640633);
    AssertAlmostEqual(&test, rTM, 0.9899757198640733);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9899757198635696);
    AssertAlmostEqual(&test, rTM, 0.989975719864567);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9899757198141994);
    AssertAlmostEqual(&test, rTM, 0.9899757199139372);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9899757148771776);
    AssertAlmostEqual(&test, rTM, 0.9899757248509565);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9899752211874635);
    AssertAlmostEqual(&test, rTM, 0.9899762185159917);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9899259762500822);
    AssertAlmostEqual(&test, rTM, 0.9900252190847729);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.985853076046832);
    AssertAlmostEqual(&test, rTM, 0.9929012528102582);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9037447336912444);
    AssertAlmostEqual(&test, rTM, 0.9989967546886463);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3794003703279432);
    AssertAlmostEqual(&test, rTM, 0.9998872036199007);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.009662383486966011);
    AssertAlmostEqual(&test, rTM, 0.9999482604680183);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -9.849917425365605e-05);
    AssertAlmostEqual(&test, rTM, 0.9999492407305135);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -9.851838815322372e-07);
    AssertAlmostEqual(&test, rTM, 0.9999492506287748);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -9.851858033953784e-09);
    AssertAlmostEqual(&test, rTM, 0.9999492507277672);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9638141986077877);
    AssertAlmostEqual(&test, rTM, 0.9638141986077881);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9638141986077701);
    AssertAlmostEqual(&test, rTM, 0.9638141986078056);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9638141986060119);
    AssertAlmostEqual(&test, rTM, 0.9638141986095639);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9638141984301927);
    AssertAlmostEqual(&test, rTM, 0.963814198785383);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9638141808482767);
    AssertAlmostEqual(&test, rTM, 0.9638142163672905);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9638124227022616);
    AssertAlmostEqual(&test, rTM, 0.9638159744277673);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9636370616621383);
    AssertAlmostEqual(&test, rTM, 0.963990488479658);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9492146158950451);
    AssertAlmostEqual(&test, rTM, 0.9742721476077422);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6918813222287724);
    AssertAlmostEqual(&test, rTM, 0.9962782384739034);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.06442190879319917);
    AssertAlmostEqual(&test, rTM, 0.9992277256211911);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000734983960322071);
    AssertAlmostEqual(&test, rTM, 0.9993201762281116);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -7.360554484852106e-06);
    AssertAlmostEqual(&test, rTM, 0.9993211644846252);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -7.360661830856693e-08);
    AssertAlmostEqual(&test, rTM, 0.9993211743744732);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8037109418147742);
    AssertAlmostEqual(&test, rTM, 0.8037109418147742);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8037109418147733);
    AssertAlmostEqual(&test, rTM, 0.8037109418147751);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8037109418146867);
    AssertAlmostEqual(&test, rTM, 0.8037109418148617);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8037109418060278);
    AssertAlmostEqual(&test, rTM, 0.8037109418235205);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8037109409401348);
    AssertAlmostEqual(&test, rTM, 0.8037109426894136);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8037108543508621);
    AssertAlmostEqual(&test, rTM, 0.8037110292786516);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8037021956896995);
    AssertAlmostEqual(&test, rTM, 0.803719687592568);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8028389773158187);
    AssertAlmostEqual(&test, rTM, 0.8045794679758373);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7346074057590293);
    AssertAlmostEqual(&test, rTM, 0.8563116402272659);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1494220180121431);
    AssertAlmostEqual(&test, rTM, 0.9684965343141831);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.00207710401508237);
    AssertAlmostEqual(&test, rTM, 0.976495111276882);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.085879165483031e-05);
    AssertAlmostEqual(&test, rTM, 0.9765904474506221);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.085967380897846e-07);
    AssertAlmostEqual(&test, rTM, 0.9765914029385445);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1741990914141245);
    AssertAlmostEqual(&test, rTM, 0.1741990914141245);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1741990914141244);
    AssertAlmostEqual(&test, rTM, 0.1741990914141245);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1741990914141232);
    AssertAlmostEqual(&test, rTM, 0.1741990914141257);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1741990914140019);
    AssertAlmostEqual(&test, rTM, 0.174199091414247);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1741990914018732);
    AssertAlmostEqual(&test, rTM, 0.1741990914263757);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.174199090189002);
    AssertAlmostEqual(&test, rTM, 0.1741990926392469);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1741989689019673);
    AssertAlmostEqual(&test, rTM, 0.1741992139262762);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1741868410780349);
    AssertAlmostEqual(&test, rTM, 0.1742113416962936);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1729827888457045);
    AssertAlmostEqual(&test, rTM, 0.1754148626672974);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1028097431990545);
    AssertAlmostEqual(&test, rTM, 0.2438030775206939);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.00251643257606916);
    AssertAlmostEqual(&test, rTM, 0.3359066875019724);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.554050975626928e-05);
    AssertAlmostEqual(&test, rTM, 0.3381146766909831);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.554433002836992e-07);
    AssertAlmostEqual(&test, rTM, 0.3381370709383856);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002599554349820489);
    AssertAlmostEqual(&test, rTM, 0.002599554349820489);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002599554349820489);
    AssertAlmostEqual(&test, rTM, 0.002599554349820489);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002599554349820489);
    AssertAlmostEqual(&test, rTM, 0.00259955434982049);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002599554349820463);
    AssertAlmostEqual(&test, rTM, 0.002599554349820515);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002599554349817903);
    AssertAlmostEqual(&test, rTM, 0.002599554349823075);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002599554349561882);
    AssertAlmostEqual(&test, rTM, 0.002599554350079097);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.00259955432395975);
    AssertAlmostEqual(&test, rTM, 0.00259955437568123);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002599551763749035);
    AssertAlmostEqual(&test, rTM, 0.002599556935891944);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002599295768142038);
    AssertAlmostEqual(&test, rTM, 0.002599812931498593);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002573948343485791);
    AssertAlmostEqual(&test, rTM, 0.002625160352746278);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001303158206473866);
    AssertAlmostEqual(&test, rTM, 0.003895941755321523);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.587116230018697e-05);
    AssertAlmostEqual(&test, rTM, 0.005173203099477937);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.612859948068342e-07);
    AssertAlmostEqual(&test, rTM, 0.005198812287018369);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.61900263329895e-05);
    AssertAlmostEqual(&test, rTM, 2.61900263329895e-05);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.61900263329895e-05);
    AssertAlmostEqual(&test, rTM, 2.61900263329895e-05);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.61900263329895e-05);
    AssertAlmostEqual(&test, rTM, 2.61900263329895e-05);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619002633298949e-05);
    AssertAlmostEqual(&test, rTM, 2.61900263329895e-05);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619002633298924e-05);
    AssertAlmostEqual(&test, rTM, 2.619002633298976e-05);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619002633296331e-05);
    AssertAlmostEqual(&test, rTM, 2.619002633301569e-05);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619002633037063e-05);
    AssertAlmostEqual(&test, rTM, 2.619002633560836e-05);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619002607110295e-05);
    AssertAlmostEqual(&test, rTM, 2.619002659487604e-05);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619000014436115e-05);
    AssertAlmostEqual(&test, rTM, 2.619005252161784e-05);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.618740772938275e-05);
    AssertAlmostEqual(&test, rTM, 2.619264493659625e-05);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.593073258927419e-05);
    AssertAlmostEqual(&test, rTM, 2.644932007670129e-05);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.309535612747987e-05);
    AssertAlmostEqual(&test, rTM, 3.928469652951749e-05);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.593206399792482e-07);
    AssertAlmostEqual(&test, rTM, 5.212073199077932e-05);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619741696323786e-07);
    AssertAlmostEqual(&test, rTM, 2.619741696323786e-07);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619741696323786e-07);
    AssertAlmostEqual(&test, rTM, 2.619741696323786e-07);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619741696323786e-07);
    AssertAlmostEqual(&test, rTM, 2.619741696323786e-07);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619741696323786e-07);
    AssertAlmostEqual(&test, rTM, 2.619741696323786e-07);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619741696323786e-07);
    AssertAlmostEqual(&test, rTM, 2.619741696323786e-07);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.61974169632376e-07);
    AssertAlmostEqual(&test, rTM, 2.619741696323812e-07);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619741696321166e-07);
    AssertAlmostEqual(&test, rTM, 2.619741696326406e-07);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619741696061812e-07);
    AssertAlmostEqual(&test, rTM, 2.61974169658576e-07);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619741670126383e-07);
    AssertAlmostEqual(&test, rTM, 2.619741722521189e-07);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619739076586082e-07);
    AssertAlmostEqual(&test, rTM, 2.61974431606149e-07);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619479748486185e-07);
    AssertAlmostEqual(&test, rTM, 2.620003644161388e-07);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.593803673182152e-07);
    AssertAlmostEqual(&test, rTM, 2.64567971946542e-07);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.309871191314243e-07);
    AssertAlmostEqual(&test, rTM, 3.929612201333239e-07);

    userdata[0] = 2/CAPS_HBAR_EV; /* 2eV */
    userdata[1] = 0.1/CAPS_HBAR_EV; /* 0.1eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999802328864937);
    AssertAlmostEqual(&test, rTM, 0.9999901163944038);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999859536743075);
    AssertAlmostEqual(&test, rTM, 0.9999986091779646);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9986031469209071);
    AssertAlmostEqual(&test, rTM, 0.9999998602309824);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9861197402277287);
    AssertAlmostEqual(&test, rTM, 0.9999999860220676);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8696517400748421);
    AssertAlmostEqual(&test, rTM, 0.9999999985988308);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2715803001233822);
    AssertAlmostEqual(&test, rTM, 0.9999999998294714);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.005066672765520762);
    AssertAlmostEqual(&test, rTM, 0.9999999999013185);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.117884071517489e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999023034);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.118402726869774e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999023133);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.118407914086892e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999999023134);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.118407965959129e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999999023134);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.118407966477852e-13);
    AssertAlmostEqual(&test, rTM, 0.9999999999023134);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.118407966483039e-15);
    AssertAlmostEqual(&test, rTM, 0.9999999999023134);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999555794808699);
    AssertAlmostEqual(&test, rTM, 0.9999560192783182);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999374922289385);
    AssertAlmostEqual(&test, rTM, 0.9999687456260437);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995558835950091);
    AssertAlmostEqual(&test, rTM, 0.999995601840679);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9955894328180668);
    AssertAlmostEqual(&test, rTM, 0.9999995580106146);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9567650016993829);
    AssertAlmostEqual(&test, rTM, 0.9999999557881795);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6450101950651324);
    AssertAlmostEqual(&test, rTM, 0.9999999954732356);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04653154577532459);
    AssertAlmostEqual(&test, rTM, 0.9999999989277867);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005113174143329183);
    AssertAlmostEqual(&test, rTM, 0.9999999990221341);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.118354670971892e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999990231235);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.118406542521534e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999990231335);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.118407061243668e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999990231335);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.118407066430889e-12);
    AssertAlmostEqual(&test, rTM, 0.9999999990231335);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.118407066482762e-14);
    AssertAlmostEqual(&test, rTM, 0.9999999990231335);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995580826794696);
    AssertAlmostEqual(&test, rTM, 0.9995580831212888);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995580608099601);
    AssertAlmostEqual(&test, rTM, 0.9995581049896944);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995558793009457);
    AssertAlmostEqual(&test, rTM, 0.9995602755685893);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993750920536224);
    AssertAlmostEqual(&test, rTM, 0.9996874971901797);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.995567662049303);
    AssertAlmostEqual(&test, rTM, 0.9999560187466479);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9567625000064116);
    AssertAlmostEqual(&test, rTM, 0.9999955790037893);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6450073650419468);
    AssertAlmostEqual(&test, rTM, 0.999999547319313);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04653072539308254);
    AssertAlmostEqual(&test, rTM, 0.9999998927767866);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005113075347071681);
    AssertAlmostEqual(&test, rTM, 0.999999902211529);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.118255674947113e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999023104779);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.118307544495251e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999023114678);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.118308063197368e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999023114777);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.11830806838439e-12);
    AssertAlmostEqual(&test, rTM, 0.9999999023114778);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9986030803711577);
    AssertAlmostEqual(&test, rTM, 0.9986030803851172);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.998603079680166);
    AssertAlmostEqual(&test, rTM, 0.9986030810761086);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9986030105827224);
    AssertAlmostEqual(&test, rTM, 0.998603150170068);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9985961180487642);
    AssertAlmostEqual(&test, rTM, 0.9986100082029591);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9980250291891145);
    AssertAlmostEqual(&test, rTM, 0.9990120263075799);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9860496518561124);
    AssertAlmostEqual(&test, rTM, 0.999860910425646);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8696338336189254);
    AssertAlmostEqual(&test, rTM, 0.9999859877348259);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2715497563470077);
    AssertAlmostEqual(&test, rTM, 0.9999982944956872);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.005065693090885777);
    AssertAlmostEqual(&test, rTM, 0.9999990129945411);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.116884570957579e-05);
    AssertAlmostEqual(&test, rTM, 0.9999990228438748);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.117403024246292e-07);
    AssertAlmostEqual(&test, rTM, 0.9999990229428695);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.117408209442388e-09);
    AssertAlmostEqual(&test, rTM, 0.9999990229438595);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.117408261294416e-11);
    AssertAlmostEqual(&test, rTM, 0.9999990229438693);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9955853565819123);
    AssertAlmostEqual(&test, rTM, 0.9955853565823528);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9955853565601082);
    AssertAlmostEqual(&test, rTM, 0.9955853566041569);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9955853543796944);
    AssertAlmostEqual(&test, rTM, 0.9955853587845696);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9955851363437966);
    AssertAlmostEqual(&test, rTM, 0.995585576809506);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9955633872255579);
    AssertAlmostEqual(&test, rTM, 0.9956072173896401);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.993762469624638);
    AssertAlmostEqual(&test, rTM, 0.9968763486057748);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9565127006900001);
    AssertAlmostEqual(&test, rTM, 0.9995597440214625);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6447245503733997);
    AssertAlmostEqual(&test, rTM, 0.9999546895080598);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04644883323063739);
    AssertAlmostEqual(&test, rTM, 0.9999892588123707);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005103214964257591);
    AssertAlmostEqual(&test, rTM, 0.9999902023533799);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.108375373802766e-06);
    AssertAlmostEqual(&test, rTM, 0.9999902122481318);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.108427043785762e-08);
    AssertAlmostEqual(&test, rTM, 0.9999902123471298);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.108427560492191e-10);
    AssertAlmostEqual(&test, rTM, 0.9999902123481198);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9859857637840042);
    AssertAlmostEqual(&test, rTM, 0.9859857637840181);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9859857637833154);
    AssertAlmostEqual(&test, rTM, 0.9859857637847069);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9859857637144345);
    AssertAlmostEqual(&test, rTM, 0.9859857638535878);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9859857568263409);
    AssertAlmostEqual(&test, rTM, 0.9859857707416779);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.985985068034458);
    AssertAlmostEqual(&test, rTM, 0.9859864594992687);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9859163625934519);
    AssertAlmostEqual(&test, rTM, 0.9860548253816581);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9802387216219092);
    AssertAlmostEqual(&test, rTM, 0.9900698129487389);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8678641472443284);
    AssertAlmostEqual(&test, rTM, 0.9985931894313181);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2685615815029206);
    AssertAlmostEqual(&test, rTM, 0.9998272918299036);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.004970536016359937);
    AssertAlmostEqual(&test, rTM, 0.999899419880429);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.019820299633343e-05);
    AssertAlmostEqual(&test, rTM, 0.9999004047617686);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.020319318476625e-07);
    AssertAlmostEqual(&test, rTM, 0.9999004146597877);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.020324309291332e-09);
    AssertAlmostEqual(&test, rTM, 0.9999004147587729);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9528272285883753);
    AssertAlmostEqual(&test, rTM, 0.9528272285883758);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9528272285883524);
    AssertAlmostEqual(&test, rTM, 0.9528272285883985);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9528272285860738);
    AssertAlmostEqual(&test, rTM, 0.9528272285906771);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9528272283582092);
    AssertAlmostEqual(&test, rTM, 0.9528272288185418);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9528272055717519);
    AssertAlmostEqual(&test, rTM, 0.9528272516049882);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9528249269857647);
    AssertAlmostEqual(&test, rTM, 0.9528295300814069);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9525976628424716);
    AssertAlmostEqual(&test, rTM, 0.9530557092947501);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9339517184132079);
    AssertAlmostEqual(&test, rTM, 0.9664021425179821);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6181505770534457);
    AssertAlmostEqual(&test, rTM, 0.995066679293197);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03949878908709462);
    AssertAlmostEqual(&test, rTM, 0.9987377742627292);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004278182072954507);
    AssertAlmostEqual(&test, rTM, 0.9988326443978766);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.281812562705112e-06);
    AssertAlmostEqual(&test, rTM, 0.9988336322379856);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.281848906483949e-08);
    AssertAlmostEqual(&test, rTM, 0.9988336421206291);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7869023996018628);
    AssertAlmostEqual(&test, rTM, 0.7869023996018629);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7869023996018619);
    AssertAlmostEqual(&test, rTM, 0.7869023996018638);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.786902399601769);
    AssertAlmostEqual(&test, rTM, 0.7869023996019567);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7869023995924787);
    AssertAlmostEqual(&test, rTM, 0.7869023996112471);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.78690239866344);
    AssertAlmostEqual(&test, rTM, 0.7869024005402857);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7869023057596023);
    AssertAlmostEqual(&test, rTM, 0.786902493444087);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7868930156667507);
    AssertAlmostEqual(&test, rTM, 0.7869117831730393);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7859669008732498);
    AssertAlmostEqual(&test, rTM, 0.7878342951839098);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7131122135011656);
    AssertAlmostEqual(&test, rTM, 0.8434475090646398);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1298934502775395);
    AssertAlmostEqual(&test, rTM, 0.9637337121887914);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001726709294490991);
    AssertAlmostEqual(&test, rTM, 0.9718595374274999);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.732799307275378e-05);
    AssertAlmostEqual(&test, rTM, 0.9719542320427769);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.732860475674576e-07);
    AssertAlmostEqual(&test, rTM, 0.9719551807675296);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1711963076294792);
    AssertAlmostEqual(&test, rTM, 0.1711963076294792);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1711963076294792);
    AssertAlmostEqual(&test, rTM, 0.1711963076294793);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.171196307629478);
    AssertAlmostEqual(&test, rTM, 0.1711963076294805);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1711963076293581);
    AssertAlmostEqual(&test, rTM, 0.1711963076296004);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1711963076173645);
    AssertAlmostEqual(&test, rTM, 0.171196307641594);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1711963064179989);
    AssertAlmostEqual(&test, rTM, 0.1711963088409596);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.171196186481532);
    AssertAlmostEqual(&test, rTM, 0.1711964287774213);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1711841937090563);
    AssertAlmostEqual(&test, rTM, 0.1712084214981403);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1699935934651517);
    AssertAlmostEqual(&test, rTM, 0.1723985117779658);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1007645713607537);
    AssertAlmostEqual(&test, rTM, 0.2399206949593257);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002455467839240692);
    AssertAlmostEqual(&test, rTM, 0.3304578913825476);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.49187336152622e-05);
    AssertAlmostEqual(&test, rTM, 0.332621281159224);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.49224302008101e-07);
    AssertAlmostEqual(&test, rTM, 0.3326432211300602);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002592969674522687);
    AssertAlmostEqual(&test, rTM, 0.002592969674522687);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002592969674522687);
    AssertAlmostEqual(&test, rTM, 0.002592969674522687);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002592969674522686);
    AssertAlmostEqual(&test, rTM, 0.002592969674522687);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002592969674522661);
    AssertAlmostEqual(&test, rTM, 0.002592969674522713);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002592969674520107);
    AssertAlmostEqual(&test, rTM, 0.002592969674525266);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002592969674264731);
    AssertAlmostEqual(&test, rTM, 0.002592969674780642);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002592969648727112);
    AssertAlmostEqual(&test, rTM, 0.002592969700318261);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002592967094967785);
    AssertAlmostEqual(&test, rTM, 0.002592972254077589);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002592711744435603);
    AssertAlmostEqual(&test, rTM, 0.002593227604609426);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002567428195182713);
    AssertAlmostEqual(&test, rTM, 0.002618511150479502);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001299848756696137);
    AssertAlmostEqual(&test, rTM, 0.003886081920619885);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.5805293278841e-05);
    AssertAlmostEqual(&test, rTM, 0.005160099878924724);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.606207161512779e-07);
    AssertAlmostEqual(&test, rTM, 0.005185643867951991);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.618332755057905e-05);
    AssertAlmostEqual(&test, rTM, 2.618332755057905e-05);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.618332755057905e-05);
    AssertAlmostEqual(&test, rTM, 2.618332755057905e-05);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.618332755057905e-05);
    AssertAlmostEqual(&test, rTM, 2.618332755057905e-05);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.618332755057905e-05);
    AssertAlmostEqual(&test, rTM, 2.618332755057905e-05);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.618332755057879e-05);
    AssertAlmostEqual(&test, rTM, 2.618332755057931e-05);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.618332755055287e-05);
    AssertAlmostEqual(&test, rTM, 2.618332755060523e-05);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.618332754796085e-05);
    AssertAlmostEqual(&test, rTM, 2.618332755319724e-05);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.618332728875949e-05);
    AssertAlmostEqual(&test, rTM, 2.618332781239861e-05);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.618330136864878e-05);
    AssertAlmostEqual(&test, rTM, 2.618335373250932e-05);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.618070961671341e-05);
    AssertAlmostEqual(&test, rTM, 2.618594548444469e-05);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.592410012456383e-05);
    AssertAlmostEqual(&test, rTM, 2.644255497659075e-05);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.309200656085408e-05);
    AssertAlmostEqual(&test, rTM, 3.927464853132928e-05);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.592543085220321e-07);
    AssertAlmostEqual(&test, rTM, 5.210740075744265e-05);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619674655255196e-07);
    AssertAlmostEqual(&test, rTM, 2.619674655255196e-07);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619674655255196e-07);
    AssertAlmostEqual(&test, rTM, 2.619674655255196e-07);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619674655255196e-07);
    AssertAlmostEqual(&test, rTM, 2.619674655255196e-07);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619674655255196e-07);
    AssertAlmostEqual(&test, rTM, 2.619674655255196e-07);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619674655255195e-07);
    AssertAlmostEqual(&test, rTM, 2.619674655255196e-07);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619674655255169e-07);
    AssertAlmostEqual(&test, rTM, 2.619674655255222e-07);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619674655252576e-07);
    AssertAlmostEqual(&test, rTM, 2.619674655257815e-07);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619674654993228e-07);
    AssertAlmostEqual(&test, rTM, 2.619674655517163e-07);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619674629058463e-07);
    AssertAlmostEqual(&test, rTM, 2.619674681451928e-07);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619672035584532e-07);
    AssertAlmostEqual(&test, rTM, 2.619677274925859e-07);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619412714121024e-07);
    AssertAlmostEqual(&test, rTM, 2.619936596389368e-07);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.59373729588583e-07);
    AssertAlmostEqual(&test, rTM, 2.645612014624562e-07);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.309837670762385e-07);
    AssertAlmostEqual(&test, rTM, 3.929511639747916e-07);

    userdata[0] = 2/CAPS_HBAR_EV; /* 2eV */
    userdata[1] = 0.5/CAPS_HBAR_EV; /* 0.5eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999557999308163);
    AssertAlmostEqual(&test, rTM, 0.9999778997211943);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996859418784478);
    AssertAlmostEqual(&test, rTM, 0.9999968900300517);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9968792387931926);
    AssertAlmostEqual(&test, rTM, 0.9999996874666996);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9692297423390971);
    AssertAlmostEqual(&test, rTM, 0.9999999687413405);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7325012605567401);
    AssertAlmostEqual(&test, rTM, 0.9999999968365795);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.08559395233089066);
    AssertAlmostEqual(&test, rTM, 0.9999999994201263);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001021591109597034);
    AssertAlmostEqual(&test, rTM, 0.9999999995105679);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.023660651352219e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999995115569);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.023681399711864e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999995115668);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.02368160720077e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999995115669);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.023681609275659e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999995115669);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.023681609296408e-13);
    AssertAlmostEqual(&test, rTM, 0.9999999995115669);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.023681609296616e-15);
    AssertAlmostEqual(&test, rTM, 0.9999999995115669);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999006754342853);
    AssertAlmostEqual(&test, rTM, 0.9999016587974696);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999860233785418);
    AssertAlmostEqual(&test, rTM, 0.9999301144506286);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9990071982072949);
    AssertAlmostEqual(&test, rTM, 0.9999901654433323);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9901645787866761);
    AssertAlmostEqual(&test, rTM, 0.9999990116723825);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9059271272621051);
    AssertAlmostEqual(&test, rTM, 0.9999999010428952);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3859662642638777);
    AssertAlmostEqual(&test, rTM, 0.9999999889753315);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01003244547570805);
    AssertAlmostEqual(&test, rTM, 0.9999999950166719);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001023472042124548);
    AssertAlmostEqual(&test, rTM, 0.9999999951146687);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.023679477454046e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999951156586);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.023681552338141e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999951156686);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.023681573087035e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999951156687);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.023681573294524e-12);
    AssertAlmostEqual(&test, rTM, 0.9999999951156687);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.023681573296599e-14);
    AssertAlmostEqual(&test, rTM, 0.9999999951156687);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9990121204553712);
    AssertAlmostEqual(&test, rTM, 0.9990121214427615);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999012071580759);
    AssertAlmostEqual(&test, rTM, 0.9990121703149082);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9990071962879781);
    AssertAlmostEqual(&test, rTM, 0.9990170211940888);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9986032139961195);
    AssertAlmostEqual(&test, rTM, 0.9993013628659169);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9901162403461299);
    AssertAlmostEqual(&test, rTM, 0.9999016574183893);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9059225276392483);
    AssertAlmostEqual(&test, rTM, 0.9999901048097944);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3859654334943696);
    AssertAlmostEqual(&test, rTM, 0.9999988975319001);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0100324073400634);
    AssertAlmostEqual(&test, rTM, 0.9999995016655456);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001023468083659754);
    AssertAlmostEqual(&test, rTM, 0.9999995114652245);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.023675517484876e-06);
    AssertAlmostEqual(&test, rTM, 0.9999995115642142);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.023677592353921e-08);
    AssertAlmostEqual(&test, rTM, 0.9999995115652042);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.023677613102664e-10);
    AssertAlmostEqual(&test, rTM, 0.999999511565214);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.023677613310152e-12);
    AssertAlmostEqual(&test, rTM, 0.9999995115652142);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9968793336938236);
    AssertAlmostEqual(&test, rTM, 0.9968793337249815);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9968793321515083);
    AssertAlmostEqual(&test, rTM, 0.9968793352672961);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9968791779238392);
    AssertAlmostEqual(&test, rTM, 0.9968794894872016);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.996863793637453);
    AssertAlmostEqual(&test, rTM, 0.9968947968991971);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9955895672973253);
    AssertAlmostEqual(&test, rTM, 0.9977923440894507);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9690781043110219);
    AssertAlmostEqual(&test, rTM, 0.9996890072203478);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7324855332927952);
    AssertAlmostEqual(&test, rTM, 0.9999683672837735);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.08559106346947082);
    AssertAlmostEqual(&test, rTM, 0.9999942011009422);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001021551268103147);
    AssertAlmostEqual(&test, rTM, 0.9999951055121354);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.023620658450361e-05);
    AssertAlmostEqual(&test, rTM, 0.9999951154018484);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.023641405290142e-07);
    AssertAlmostEqual(&test, rTM, 0.9999951155008466);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.023641612763848e-09);
    AssertAlmostEqual(&test, rTM, 0.9999951155018366);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.023641614838586e-11);
    AssertAlmostEqual(&test, rTM, 0.9999951155018465);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.990163156483101);
    AssertAlmostEqual(&test, rTM, 0.9901631564840798);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9901631564346494);
    AssertAlmostEqual(&test, rTM, 0.9901631565325315);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9901631515894803);
    AssertAlmostEqual(&test, rTM, 0.9901631613776981);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9901626670848147);
    AssertAlmostEqual(&test, rTM, 0.9901636458581393);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9901143383217037);
    AssertAlmostEqual(&test, rTM, 0.9902117347534691);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9861170546426244);
    AssertAlmostEqual(&test, rTM, 0.9930341818092778);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.905463702112184);
    AssertAlmostEqual(&test, rTM, 0.9990156434320268);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3858823711486807);
    AssertAlmostEqual(&test, rTM, 0.9998897407535413);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01002859523550917);
    AssertAlmostEqual(&test, rTM, 0.9999501500931105);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000102307239174842);
    AssertAlmostEqual(&test, rTM, 0.9999511299922376);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.023279675226036e-06);
    AssertAlmostEqual(&test, rTM, 0.999951139890489);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.023281748591031e-08);
    AssertAlmostEqual(&test, rTM, 0.9999511399894816);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.023281769324735e-10);
    AssertAlmostEqual(&test, rTM, 0.9999511399904715);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9691706395910009);
    AssertAlmostEqual(&test, rTM, 0.9691706395910312);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9691706395894988);
    AssertAlmostEqual(&test, rTM, 0.9691706395925335);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9691706394392826);
    AssertAlmostEqual(&test, rTM, 0.9691706397427495);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9691706244176722);
    AssertAlmostEqual(&test, rTM, 0.9691706547643526);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9691691222953669);
    AssertAlmostEqual(&test, rTM, 0.9691721568131628);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9690192954727761);
    AssertAlmostEqual(&test, rTM, 0.9693212558960784);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9566825078980762);
    AssertAlmostEqual(&test, rTM, 0.9780988273237173);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7309312075661091);
    AssertAlmostEqual(&test, rTM, 0.9968513488918215);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.08530597917829214);
    AssertAlmostEqual(&test, rTM, 0.9994185098133236);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001017621888306481);
    AssertAlmostEqual(&test, rTM, 0.999508900419401);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.019676377007596e-05);
    AssertAlmostEqual(&test, rTM, 0.9995098886734509);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.019696974262523e-07);
    AssertAlmostEqual(&test, rTM, 0.9995098985660721);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.019697180240324e-09);
    AssertAlmostEqual(&test, rTM, 0.9995098986649993);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9041983941434546);
    AssertAlmostEqual(&test, rTM, 0.9041983941434555);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9041983941434095);
    AssertAlmostEqual(&test, rTM, 0.9041983941435006);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9041983941389059);
    AssertAlmostEqual(&test, rTM, 0.9041983941480041);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9041983936885463);
    AssertAlmostEqual(&test, rTM, 0.9041983945983638);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9041983486525889);
    AssertAlmostEqual(&test, rTM, 0.9041984396343007);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9041938451810371);
    AssertAlmostEqual(&test, rTM, 0.9042029429007502);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9037447336912444);
    AssertAlmostEqual(&test, rTM, 0.9046500235398094);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8673086081827739);
    AssertAlmostEqual(&test, rTM, 0.931210194145758);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.377719404789433);
    AssertAlmostEqual(&test, rTM, 0.9888545213931677);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.009661445311751055);
    AssertAlmostEqual(&test, rTM, 0.9948521724165508);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -9.849907675877927e-05);
    AssertAlmostEqual(&test, rTM, 0.9949494504112394);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -9.851838717789361e-07);
    AssertAlmostEqual(&test, rTM, 0.9949504328260381);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -9.851858032978451e-09);
    AssertAlmostEqual(&test, rTM, 0.9949504426511685);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6931332107554484);
    AssertAlmostEqual(&test, rTM, 0.6931332107554485);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6931332107554472);
    AssertAlmostEqual(&test, rTM, 0.6931332107554498);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6931332107553229);
    AssertAlmostEqual(&test, rTM, 0.6931332107555741);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.693133210742886);
    AssertAlmostEqual(&test, rTM, 0.6931332107680109);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6931332094992002);
    AssertAlmostEqual(&test, rTM, 0.6931332120116968);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6931330851306675);
    AssertAlmostEqual(&test, rTM, 0.6931333363801873);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6931206487111705);
    AssertAlmostEqual(&test, rTM, 0.6931457723786977);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6918813222287725);
    AssertAlmostEqual(&test, rTM, 0.6943809316555839);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5971812934244595);
    AssertAlmostEqual(&test, rTM, 0.7695273546189489);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.06386624287159276);
    AssertAlmostEqual(&test, rTM, 0.9280253783986664);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0007349113110456915);
    AssertAlmostEqual(&test, rTM, 0.9363015519636717);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -7.360547198017724e-06);
    AssertAlmostEqual(&test, rTM, 0.936391226554646);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -7.360661757986152e-08);
    AssertAlmostEqual(&test, rTM, 0.9363921240917109);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1505250682805916);
    AssertAlmostEqual(&test, rTM, 0.1505250682805916);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1505250682805916);
    AssertAlmostEqual(&test, rTM, 0.1505250682805916);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1505250682805905);
    AssertAlmostEqual(&test, rTM, 0.1505250682805927);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1505250682804805);
    AssertAlmostEqual(&test, rTM, 0.1505250682807028);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1505250682694778);
    AssertAlmostEqual(&test, rTM, 0.1505250682917054);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1505250671692097);
    AssertAlmostEqual(&test, rTM, 0.1505250693919735);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1505249571424869);
    AssertAlmostEqual(&test, rTM, 0.1505251794186925);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.150513955301258);
    AssertAlmostEqual(&test, rTM, 0.1505361812218843);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1494220180121431);
    AssertAlmostEqual(&test, rTM, 0.1516277438908344);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.08694953550070278);
    AssertAlmostEqual(&test, rTM, 0.2128795057881896);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.00205682786282979);
    AssertAlmostEqual(&test, rTM, 0.2925004095337845);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.085672692706659e-05);
    AssertAlmostEqual(&test, rTM, 0.2943610821340429);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.085965315793065e-07);
    AssertAlmostEqual(&test, rTM, 0.2943799410213885);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002541469315765225);
    AssertAlmostEqual(&test, rTM, 0.002541469315765225);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002541469315765225);
    AssertAlmostEqual(&test, rTM, 0.002541469315765225);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002541469315765225);
    AssertAlmostEqual(&test, rTM, 0.002541469315765226);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0025414693157652);
    AssertAlmostEqual(&test, rTM, 0.002541469315765251);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002541469315762697);
    AssertAlmostEqual(&test, rTM, 0.002541469315767754);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002541469315512367);
    AssertAlmostEqual(&test, rTM, 0.002541469316018084);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002541469290479386);
    AssertAlmostEqual(&test, rTM, 0.002541469341051064);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.00254146678718381);
    AssertAlmostEqual(&test, rTM, 0.002541471844346641);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002541216482527423);
    AssertAlmostEqual(&test, rTM, 0.002541722149002703);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002516432576069161);
    AssertAlmostEqual(&test, rTM, 0.00256650605227509);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001273966237742394);
    AssertAlmostEqual(&test, rTM, 0.003808964227721434);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.529017484773686e-05);
    AssertAlmostEqual(&test, rTM, 0.005057616276001552);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.554180139385241e-07);
    AssertAlmostEqual(&test, rTM, 0.005082650389289667);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.612986040334318e-05);
    AssertAlmostEqual(&test, rTM, 2.612986040334318e-05);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.612986040334318e-05);
    AssertAlmostEqual(&test, rTM, 2.612986040334318e-05);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.612986040334318e-05);
    AssertAlmostEqual(&test, rTM, 2.612986040334318e-05);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.612986040334318e-05);
    AssertAlmostEqual(&test, rTM, 2.612986040334319e-05);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.612986040334292e-05);
    AssertAlmostEqual(&test, rTM, 2.612986040334344e-05);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.612986040331705e-05);
    AssertAlmostEqual(&test, rTM, 2.612986040336931e-05);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.612986040073033e-05);
    AssertAlmostEqual(&test, rTM, 2.612986040595603e-05);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.612986014205824e-05);
    AssertAlmostEqual(&test, rTM, 2.612986066462813e-05);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.612983427487441e-05);
    AssertAlmostEqual(&test, rTM, 2.612988653181196e-05);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.612724781509837e-05);
    AssertAlmostEqual(&test, rTM, 2.613247299158799e-05);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.587116230018698e-05);
    AssertAlmostEqual(&test, rTM, 2.638855850649589e-05);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.306527158870397e-05);
    AssertAlmostEqual(&test, rTM, 3.919444920906253e-05);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.587248759849683e-07);
    AssertAlmostEqual(&test, rTM, 5.200099589572315e-05);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619138450206478e-07);
    AssertAlmostEqual(&test, rTM, 2.619138450206478e-07);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619138450206478e-07);
    AssertAlmostEqual(&test, rTM, 2.619138450206478e-07);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619138450206478e-07);
    AssertAlmostEqual(&test, rTM, 2.619138450206478e-07);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619138450206478e-07);
    AssertAlmostEqual(&test, rTM, 2.619138450206478e-07);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619138450206478e-07);
    AssertAlmostEqual(&test, rTM, 2.619138450206479e-07);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619138450206452e-07);
    AssertAlmostEqual(&test, rTM, 2.619138450206505e-07);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619138450203859e-07);
    AssertAlmostEqual(&test, rTM, 2.619138450209097e-07);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619138449944565e-07);
    AssertAlmostEqual(&test, rTM, 2.619138450468392e-07);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619138424015108e-07);
    AssertAlmostEqual(&test, rTM, 2.619138476397849e-07);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619135831072019e-07);
    AssertAlmostEqual(&test, rTM, 2.619141069340938e-07);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.618876562687394e-07);
    AssertAlmostEqual(&test, rTM, 2.619400337725563e-07);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.593206399792483e-07);
    AssertAlmostEqual(&test, rTM, 2.645070500620474e-07);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.309569568097572e-07);
    AssertAlmostEqual(&test, rTM, 3.928707332315294e-07);

    userdata[0] = 2/CAPS_HBAR_EV; /* 2eV */
    userdata[1] = 1/CAPS_HBAR_EV; /* 1eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999374922349834);
    AssertAlmostEqual(&test, rTM, 0.9999687456290662);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995558836379499);
    AssertAlmostEqual(&test, rTM, 0.9999956018411044);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9955894332436689);
    AssertAlmostEqual(&test, rTM, 0.9999995580106573);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9567650057882433);
    AssertAlmostEqual(&test, rTM, 0.9999999557881838);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6450102219875525);
    AssertAlmostEqual(&test, rTM, 0.999999995473236);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04653155397509635);
    AssertAlmostEqual(&test, rTM, 0.9999999989277869);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005113175131305981);
    AssertAlmostEqual(&test, rTM, 0.9999999990221343);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.118355660951427e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999990231238);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.118407532521136e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999990231336);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.11840805124347e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999990231337);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.118408056430694e-12);
    AssertAlmostEqual(&test, rTM, 0.9999999990231337);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.118408056482566e-14);
    AssertAlmostEqual(&test, rTM, 0.9999999990231337);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.118408056483085e-16);
    AssertAlmostEqual(&test, rTM, 0.9999999990231337);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999859536743075);
    AssertAlmostEqual(&test, rTM, 0.9998609273716784);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998023464475746);
    AssertAlmostEqual(&test, rTM, 0.9999011683396974);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9985962550591477);
    AssertAlmostEqual(&test, rTM, 0.9999860918633633);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9861190579743737);
    AssertAlmostEqual(&test, rTM, 0.9999986022769141);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8696516800508388);
    AssertAlmostEqual(&test, rTM, 0.9999998598831584);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2715802985832027);
    AssertAlmostEqual(&test, rTM, 0.9999999829471408);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.00506667276502422);
    AssertAlmostEqual(&test, rTM, 0.9999999901318443);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.117884071512423e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999902303376);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.118402726869724e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999902313276);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.118407914086893e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999902313375);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.11840796595913e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999902313376);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.118407966477853e-13);
    AssertAlmostEqual(&test, rTM, 0.9999999902313376);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.11840796648304e-15);
    AssertAlmostEqual(&test, rTM, 0.9999999902313376);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9986032146617303);
    AssertAlmostEqual(&test, rTM, 0.9986032160575381);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9986031455709588);
    AssertAlmostEqual(&test, rTM, 0.9986032851448257);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9985962537025436);
    AssertAlmostEqual(&test, rTM, 0.9986101425155005);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9980252199712367);
    AssertAlmostEqual(&test, rTM, 0.9990121217930434);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9860509913183307);
    AssertAlmostEqual(&test, rTM, 0.9998609238747027);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8696455605463668);
    AssertAlmostEqual(&test, rTM, 0.9999859890963253);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.271579843655905);
    AssertAlmostEqual(&test, rTM, 0.9999982947147188);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.005066663014260415);
    AssertAlmostEqual(&test, rTM, 0.9999990131834955);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.117874173051835e-05);
    AssertAlmostEqual(&test, rTM, 0.9999990230328193);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.11839282690446e-07);
    AssertAlmostEqual(&test, rTM, 0.9999990231318141);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.11839801410658e-09);
    AssertAlmostEqual(&test, rTM, 0.9999990231328041);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.118398065978667e-11);
    AssertAlmostEqual(&test, rTM, 0.999999023132814);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.118398066497388e-13);
    AssertAlmostEqual(&test, rTM, 0.9999990231328141);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9955896102626615);
    AssertAlmostEqual(&test, rTM, 0.9955896103066678);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9955896080843439);
    AssertAlmostEqual(&test, rTM, 0.9955896124849842);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9955893902580669);
    AssertAlmostEqual(&test, rTM, 0.9955898303003105);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.995567662049303);
    AssertAlmostEqual(&test, rTM, 0.9956114500748544);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9937684742446203);
    AssertAlmostEqual(&test, rTM, 0.996879360340813);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9565537628978847);
    AssertAlmostEqual(&test, rTM, 0.9995601692790437);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6449935854917217);
    AssertAlmostEqual(&test, rTM, 0.999954735300655);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04653068342401311);
    AssertAlmostEqual(&test, rTM, 0.9999892777883221);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005113075296503973);
    AssertAlmostEqual(&test, rTM, 0.9999902212475191);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.118255674440411e-06);
    AssertAlmostEqual(&test, rTM, 0.9999902311422614);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.118307544490184e-08);
    AssertAlmostEqual(&test, rTM, 0.9999902312412594);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.118308063197318e-10);
    AssertAlmostEqual(&test, rTM, 0.9999902312422494);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.11830806838439e-12);
    AssertAlmostEqual(&test, rTM, 0.9999902312422594);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9861184008809533);
    AssertAlmostEqual(&test, rTM, 0.9861184008823317);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9861184008127196);
    AssertAlmostEqual(&test, rTM, 0.9861184009505654);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9861183939893561);
    AssertAlmostEqual(&test, rTM, 0.9861184077739255);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9861177116702987);
    AssertAlmostEqual(&test, rTM, 0.9861190900590082);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9860496518561124);
    AssertAlmostEqual(&test, rTM, 0.9861868134599635);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.980425206064123);
    AssertAlmostEqual(&test, rTM, 0.990163992811063);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8690352690549171);
    AssertAlmostEqual(&test, rTM, 0.9986066532877612);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2715343562264554);
    AssertAlmostEqual(&test, rTM, 0.9998294778823705);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.005065688126407713);
    AssertAlmostEqual(&test, rTM, 0.9999013090499291);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.116884520305606e-05);
    AssertAlmostEqual(&test, rTM, 0.9999022938389314);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.11740302373967e-07);
    AssertAlmostEqual(&test, rTM, 0.9999023037369689);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.117408209437322e-09);
    AssertAlmostEqual(&test, rTM, 0.9999023038359544);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.117408261294365e-11);
    AssertAlmostEqual(&test, rTM, 0.9999023038369442);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9567237464209527);
    AssertAlmostEqual(&test, rTM, 0.956723746420995);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9567237464188579);
    AssertAlmostEqual(&test, rTM, 0.9567237464230899);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9567237462093783);
    AssertAlmostEqual(&test, rTM, 0.9567237466325695);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9567237252614164);
    AssertAlmostEqual(&test, rTM, 0.9567237675805212);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9567216305199323);
    AssertAlmostEqual(&test, rTM, 0.9567258622208559);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9565127006900001);
    AssertAlmostEqual(&test, rTM, 0.9569337904826641);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9393561831918095);
    AssertAlmostEqual(&test, rTM, 0.969196477336062);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6433509700719255);
    AssertAlmostEqual(&test, rTM, 0.995502389798563);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04644464340150492);
    AssertAlmostEqual(&test, rTM, 0.9989269806303482);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005103209917233663);
    AssertAlmostEqual(&test, rTM, 0.999021184273684);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.108375323230366e-06);
    AssertAlmostEqual(&test, rTM, 0.9990221723110801);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.108427043280028e-08);
    AssertAlmostEqual(&test, rTM, 0.9990221821965132);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.108427560487133e-10);
    AssertAlmostEqual(&test, rTM, 0.999022182295368);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8684737439692765);
    AssertAlmostEqual(&test, rTM, 0.8684737439692777);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8684737439692159);
    AssertAlmostEqual(&test, rTM, 0.8684737439693382);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8684737439631637);
    AssertAlmostEqual(&test, rTM, 0.8684737439753905);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.868473743357938);
    AssertAlmostEqual(&test, rTM, 0.8684737445806161);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8684736828353876);
    AssertAlmostEqual(&test, rTM, 0.8684738051031401);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8684676307536819);
    AssertAlmostEqual(&test, rTM, 0.8684798569207481);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8678641472443284);
    AssertAlmostEqual(&test, rTM, 0.8690807254916985);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8193328128249797);
    AssertAlmostEqual(&test, rTM, 0.9049468217882514);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2670380910638115);
    AssertAlmostEqual(&test, rTM, 0.9830142387588086);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.004970048849173563);
    AssertAlmostEqual(&test, rTM, 0.9900406765916709);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.019815330515122e-05);
    AssertAlmostEqual(&test, rTM, 0.9901377127447566);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.020319268775514e-07);
    AssertAlmostEqual(&test, rTM, 0.9901386880979336);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.020324308794321e-09);
    AssertAlmostEqual(&test, rTM, 0.9901386978519695);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6196003293810378);
    AssertAlmostEqual(&test, rTM, 0.6196003293810379);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6196003293810364);
    AssertAlmostEqual(&test, rTM, 0.6196003293810394);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6196003293808924);
    AssertAlmostEqual(&test, rTM, 0.6196003293811834);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6196003293664851);
    AssertAlmostEqual(&test, rTM, 0.6196003293955906);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6196003279257667);
    AssertAlmostEqual(&test, rTM, 0.6196003308363091);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6196001838539797);
    AssertAlmostEqual(&test, rTM, 0.6196004749080535);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6195857772244324);
    AssertAlmostEqual(&test, rTM, 0.6196148811117158);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6181505770534457);
    AssertAlmostEqual(&test, rTM, 0.6210458665228871);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5113039079540954);
    AssertAlmostEqual(&test, rTM, 0.7085264230968885);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03914078410775233);
    AssertAlmostEqual(&test, rTM, 0.8873988397116267);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000427775893744831);
    AssertAlmostEqual(&test, rTM, 0.8953531284551545);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.281808323751216e-06);
    AssertAlmostEqual(&test, rTM, 0.8954370936099267);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.281848864093648e-08);
    AssertAlmostEqual(&test, rTM, 0.895437933742355);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1308915697422154);
    AssertAlmostEqual(&test, rTM, 0.1308915697422154);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1308915697422154);
    AssertAlmostEqual(&test, rTM, 0.1308915697422154);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1308915697422144);
    AssertAlmostEqual(&test, rTM, 0.1308915697422164);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1308915697421148);
    AssertAlmostEqual(&test, rTM, 0.130891569742316);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1308915697321562);
    AssertAlmostEqual(&test, rTM, 0.1308915697522746);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1308915687362926);
    AssertAlmostEqual(&test, rTM, 0.1308915707481382);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1308914691500094);
    AssertAlmostEqual(&test, rTM, 0.1308916703344187);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1308815113002295);
    AssertAlmostEqual(&test, rTM, 0.1309016281572545);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1298934502775395);
    AssertAlmostEqual(&test, rTM, 0.1318894239318733);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.07425364491881319);
    AssertAlmostEqual(&test, rTM, 0.1866877915801575);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001709841903628483);
    AssertAlmostEqual(&test, rTM, 0.2557763759214176);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.732627783240805e-05);
    AssertAlmostEqual(&test, rTM, 0.2573574801221087);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.732858760145015e-07);
    AssertAlmostEqual(&test, rTM, 0.2573734969514291);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002479901031079069);
    AssertAlmostEqual(&test, rTM, 0.002479901031079069);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002479901031079069);
    AssertAlmostEqual(&test, rTM, 0.002479901031079069);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002479901031079069);
    AssertAlmostEqual(&test, rTM, 0.002479901031079069);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002479901031079044);
    AssertAlmostEqual(&test, rTM, 0.002479901031079094);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002479901031076601);
    AssertAlmostEqual(&test, rTM, 0.002479901031081537);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002479901030832306);
    AssertAlmostEqual(&test, rTM, 0.002479901031325832);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002479901006402753);
    AssertAlmostEqual(&test, rTM, 0.002479901055755385);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002479898563449885);
    AssertAlmostEqual(&test, rTM, 0.002479903498708253);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002479654292467036);
    AssertAlmostEqual(&test, rTM, 0.0024801477696908);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002455467839240692);
    AssertAlmostEqual(&test, rTM, 0.002504334219956521);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001243027371763735);
    AssertAlmostEqual(&test, rTM, 0.003716767102609116);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.467449273514125e-05);
    AssertAlmostEqual(&test, rTM, 0.004935097671235127);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.491996312815719e-07);
    AssertAlmostEqual(&test, rTM, 0.004959522366512323);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.606333276053934e-05);
    AssertAlmostEqual(&test, rTM, 2.606333276053934e-05);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.606333276053934e-05);
    AssertAlmostEqual(&test, rTM, 2.606333276053934e-05);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.606333276053934e-05);
    AssertAlmostEqual(&test, rTM, 2.606333276053934e-05);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.606333276053934e-05);
    AssertAlmostEqual(&test, rTM, 2.606333276053934e-05);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.606333276053908e-05);
    AssertAlmostEqual(&test, rTM, 2.60633327605396e-05);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.606333276051328e-05);
    AssertAlmostEqual(&test, rTM, 2.60633327605654e-05);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.606333275793314e-05);
    AssertAlmostEqual(&test, rTM, 2.606333276314554e-05);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.60633324999196e-05);
    AssertAlmostEqual(&test, rTM, 2.606333302115908e-05);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.60633066985912e-05);
    AssertAlmostEqual(&test, rTM, 2.606335882248748e-05);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.606072682369931e-05);
    AssertAlmostEqual(&test, rTM, 2.606593869737937e-05);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.5805293278841e-05);
    AssertAlmostEqual(&test, rTM, 2.632137224223421e-05);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.303200603114e-05);
    AssertAlmostEqual(&test, rTM, 3.909465948108677e-05);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.580661183708799e-07);
    AssertAlmostEqual(&test, rTM, 5.186859936799604e-05);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.618468502495544e-07);
    AssertAlmostEqual(&test, rTM, 2.618468502495544e-07);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.618468502495544e-07);
    AssertAlmostEqual(&test, rTM, 2.618468502495544e-07);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.618468502495544e-07);
    AssertAlmostEqual(&test, rTM, 2.618468502495544e-07);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.618468502495544e-07);
    AssertAlmostEqual(&test, rTM, 2.618468502495544e-07);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.618468502495543e-07);
    AssertAlmostEqual(&test, rTM, 2.618468502495544e-07);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.618468502495517e-07);
    AssertAlmostEqual(&test, rTM, 2.61846850249557e-07);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.618468502492925e-07);
    AssertAlmostEqual(&test, rTM, 2.618468502498162e-07);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.618468502233697e-07);
    AssertAlmostEqual(&test, rTM, 2.61846850275739e-07);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.618468476310872e-07);
    AssertAlmostEqual(&test, rTM, 2.618468528680215e-07);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.618465884031031e-07);
    AssertAlmostEqual(&test, rTM, 2.618471120960056e-07);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.618206681964461e-07);
    AssertAlmostEqual(&test, rTM, 2.618730323026626e-07);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.592543085220321e-07);
    AssertAlmostEqual(&test, rTM, 2.644393919770766e-07);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.309234594066659e-07);
    AssertAlmostEqual(&test, rTM, 3.927702410924338e-07);

    userdata[0] = 5/CAPS_HBAR_EV; /* 5eV */
    userdata[1] = 1e-05/CAPS_HBAR_EV; /* 1e-05eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999209230448);
    AssertAlmostEqual(&test, rTM, 0.9999999604615216);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999999438052785);
    AssertAlmostEqual(&test, rTM, 0.9999999944361646);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999944081507122);
    AssertAlmostEqual(&test, rTM, 0.9999999994408694);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999440856818135);
    AssertAlmostEqual(&test, rTM, 0.9999999999440842);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994409977694896);
    AssertAlmostEqual(&test, rTM, 0.9999999999944084);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9944240257099689);
    AssertAlmostEqual(&test, rTM, 0.9999999999994409);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9456255889129678);
    AssertAlmostEqual(&test, rTM, 0.999999999999944);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5757285262575358);
    AssertAlmostEqual(&test, rTM, 0.9999999999999942);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03008809315322166);
    AssertAlmostEqual(&test, rTM, 0.9999999999999983);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003196335870951688);
    AssertAlmostEqual(&test, rTM, 0.9999999999999984);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.198359704528605e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999999984);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.198379959043661e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999999984);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.198380161590431e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999999999984);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999998221405194);
    AssertAlmostEqual(&test, rTM, 0.9999998239015042);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999997497170213);
    AssertAlmostEqual(&test, rTM, 0.9999998748585028);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999982214066175);
    AssertAlmostEqual(&test, rTM, 0.999999982390149);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999823015903999);
    AssertAlmostEqual(&test, rTM, 0.9999999982303204);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998230387576598);
    AssertAlmostEqual(&test, rTM, 0.9999999998230232);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9982317972022032);
    AssertAlmostEqual(&test, rTM, 0.9999999999823023);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9824582297365542);
    AssertAlmostEqual(&test, rTM, 0.9999999999982302);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8379920520080226);
    AssertAlmostEqual(&test, rTM, 0.9999999999998224);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2028723947946715);
    AssertAlmostEqual(&test, rTM, 0.9999999999999764);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.003172540993990228);
    AssertAlmostEqual(&test, rTM, 0.9999999999999842);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.192563369589839e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999999843);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.192765189818767e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999999843);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.19276720818213e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999999999843);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999980669454894);
    AssertAlmostEqual(&test, rTM, 0.9999980669474224);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999980668498057);
    AssertAlmostEqual(&test, rTM, 0.9999980670431012);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999980573052407);
    AssertAlmostEqual(&test, rTM, 0.9999980765398238);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999972662505556);
    AssertAlmostEqual(&test, rTM, 0.9999986331243437);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999805732222392);
    AssertAlmostEqual(&test, rTM, 0.9999998076538159);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998067034782055);
    AssertAlmostEqual(&test, rTM, 0.9999999806704124);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9980688110716422);
    AssertAlmostEqual(&test, rTM, 0.9999999980669446);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9808553780568157);
    AssertAlmostEqual(&test, rTM, 0.9999999998066854);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8244771669809144);
    AssertAlmostEqual(&test, rTM, 0.9999999999805793);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1799615787867776);
    AssertAlmostEqual(&test, rTM, 0.9999999999973116);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002661927294539403);
    AssertAlmostEqual(&test, rTM, 0.9999999999981217);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.676012569383426e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999981315);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.676154363636963e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999981316);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999903910478342);
    AssertAlmostEqual(&test, rTM, 0.9999903910479302);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999903910430777);
    AssertAlmostEqual(&test, rTM, 0.9999903910526866);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999903905674489);
    AssertAlmostEqual(&test, rTM, 0.9999903915282914);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999903431228681);
    AssertAlmostEqual(&test, rTM, 0.9999904387350559);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999864109166383);
    AssertAlmostEqual(&test, rTM, 0.999993205435236);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999034354250971);
    AssertAlmostEqual(&test, rTM, 0.9999990438693906);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9990395137272818);
    AssertAlmostEqual(&test, rTM, 0.9999999039148149);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9904370524787373);
    AssertAlmostEqual(&test, rTM, 0.9999999903908957);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9084158197778941);
    AssertAlmostEqual(&test, rTM, 0.9999999990379917);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3956143581328226);
    AssertAlmostEqual(&test, rTM, 0.9999999998933951);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0106019527910377);
    AssertAlmostEqual(&test, rTM, 0.9999999999528442);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001082803652635784);
    AssertAlmostEqual(&test, rTM, 0.9999999999538236);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.083035837540706e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999538335);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999198788686707);
    AssertAlmostEqual(&test, rTM, 0.9999198788686787);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999198788682742);
    AssertAlmostEqual(&test, rTM, 0.9999198788690754);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999198788286158);
    AssertAlmostEqual(&test, rTM, 0.9999198789087337);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999198748628788);
    AssertAlmostEqual(&test, rTM, 0.9999198828742705);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999194792756448);
    AssertAlmostEqual(&test, rTM, 0.999920276478759);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998866934897044);
    AssertAlmostEqual(&test, rTM, 0.9999433451399201);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991950844767474);
    AssertAlmostEqual(&test, rTM, 0.9999920273612131);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9920192037186747);
    AssertAlmostEqual(&test, rTM, 0.9999991987905391);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9230213037590002);
    AssertAlmostEqual(&test, rTM, 0.9999999198114291);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4578448083527941);
    AssertAlmostEqual(&test, rTM, 0.9999999913684932);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01510939401496906);
    AssertAlmostEqual(&test, rTM, 0.9999999966915559);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001557169153160022);
    AssertAlmostEqual(&test, rTM, 0.9999999967890452);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.557649369058527e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999967900349);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9992168164358577);
    AssertAlmostEqual(&test, rTM, 0.9992168164358585);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9992168164358189);
    AssertAlmostEqual(&test, rTM, 0.9992168164358972);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9992168164319437);
    AssertAlmostEqual(&test, rTM, 0.9992168164397724);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9992168160444198);
    AssertAlmostEqual(&test, rTM, 0.9992168168272961);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9992167772929996);
    AssertAlmostEqual(&test, rTM, 0.9992168555767611);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9992129117970432);
    AssertAlmostEqual(&test, rTM, 0.999220701711835);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9988925908913699);
    AssertAlmostEqual(&test, rTM, 0.9994461420238927);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9921569573703314);
    AssertAlmostEqual(&test, rTM, 0.9999220422347378);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9246565277236747);
    AssertAlmostEqual(&test, rTM, 0.9999921595094428);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4654639969120216);
    AssertAlmostEqual(&test, rTM, 0.9999991585363855);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01578035112921925);
    AssertAlmostEqual(&test, rTM, 0.9999996832292734);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001628512672554727);
    AssertAlmostEqual(&test, rTM, 0.9999996929714815);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.629037905474195e-06);
    AssertAlmostEqual(&test, rTM, 0.9999996930704652);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9922135628908861);
    AssertAlmostEqual(&test, rTM, 0.9922135628908862);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9922135628908824);
    AssertAlmostEqual(&test, rTM, 0.99221356289089);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9922135628904983);
    AssertAlmostEqual(&test, rTM, 0.9922135628912739);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9922135628521062);
    AssertAlmostEqual(&test, rTM, 0.9922135629296662);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.992213559012885);
    AssertAlmostEqual(&test, rTM, 0.9922135667688855);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9922131751004404);
    AssertAlmostEqual(&test, rTM, 0.9922139506620953);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9921748800931141);
    AssertAlmostEqual(&test, rTM, 0.9922520552073317);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9890061276625164);
    AssertAlmostEqual(&test, rTM, 0.9944878300691093);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9244660208615183);
    AssertAlmostEqual(&test, rTM, 0.9992219013537522);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4662269823842481);
    AssertAlmostEqual(&test, rTM, 0.9999160806446602);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585072454348022);
    AssertAlmostEqual(&test, rTM, 0.9999684646365354);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636008218770335);
    AssertAlmostEqual(&test, rTM, 0.9999694387413369);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.636538314415101e-06);
    AssertAlmostEqual(&test, rTM, 0.9999694486392473);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9248428721227684);
    AssertAlmostEqual(&test, rTM, 0.9248428721227684);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9248428721227681);
    AssertAlmostEqual(&test, rTM, 0.9248428721227687);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9248428721227323);
    AssertAlmostEqual(&test, rTM, 0.9248428721228045);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9248428721191573);
    AssertAlmostEqual(&test, rTM, 0.9248428721263795);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9248428717616556);
    AssertAlmostEqual(&test, rTM, 0.9248428724838812);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9248428360115012);
    AssertAlmostEqual(&test, rTM, 0.9248429082340189);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9248392610925361);
    AssertAlmostEqual(&test, rTM, 0.9248464829862857);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9244827291610888);
    AssertAlmostEqual(&test, rTM, 0.9252013643123451);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8954163701332467);
    AssertAlmostEqual(&test, rTM, 0.9462245990000647);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4646327549130935);
    AssertAlmostEqual(&test, rTM, 0.9916929063497899);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585627719857116);
    AssertAlmostEqual(&test, rTM, 0.9968575338585544);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636759951873572);
    AssertAlmostEqual(&test, rTM, 0.9969544893771103);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637292139534504e-06);
    AssertAlmostEqual(&test, rTM, 0.9969554746961889);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4663299347532068);
    AssertAlmostEqual(&test, rTM, 0.4663299347532068);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4663299347532068);
    AssertAlmostEqual(&test, rTM, 0.4663299347532068);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4663299347532051);
    AssertAlmostEqual(&test, rTM, 0.4663299347532085);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4663299347530371);
    AssertAlmostEqual(&test, rTM, 0.4663299347533765);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4663299347362347);
    AssertAlmostEqual(&test, rTM, 0.4663299347701789);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4663299330560013);
    AssertAlmostEqual(&test, rTM, 0.4663299364504123);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4663297650327332);
    AssertAlmostEqual(&test, rTM, 0.4663301044736461);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4663129634872625);
    AssertAlmostEqual(&test, rTM, 0.4663469056758791);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4646405783465142);
    AssertAlmostEqual(&test, rTM, 0.4680158965664908);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3480130072308371);
    AssertAlmostEqual(&test, rTM, 0.57002437944144);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01570636158892745);
    AssertAlmostEqual(&test, rTM, 0.7595000149589196);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636673347792284);
    AssertAlmostEqual(&test, rTM, 0.7660003396996848);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637365940878162e-06);
    AssertAlmostEqual(&test, rTM, 0.7660672892183815);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0158585917841129);
    AssertAlmostEqual(&test, rTM, 0.0158585917841129);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0158585917841129);
    AssertAlmostEqual(&test, rTM, 0.0158585917841129);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0158585917841129);
    AssertAlmostEqual(&test, rTM, 0.0158585917841129);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585859178411275);
    AssertAlmostEqual(&test, rTM, 0.01585859178411305);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585859178409754);
    AssertAlmostEqual(&test, rTM, 0.01585859178412826);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585859178257655);
    AssertAlmostEqual(&test, rTM, 0.01585859178564925);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585859163047836);
    AssertAlmostEqual(&test, rTM, 0.01585859193774744);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585857642067368);
    AssertAlmostEqual(&test, rTM, 0.01585860714755211);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0158570555875633);
    AssertAlmostEqual(&test, rTM, 0.01586012798058763);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01570643170365166);
    AssertAlmostEqual(&test, rTM, 0.01601075113005483);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.008055533935280031);
    AssertAlmostEqual(&test, rTM, 0.02365971843848147);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001620643370200538);
    AssertAlmostEqual(&test, rTM, 0.03154730664529625);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637211400250179e-06);
    AssertAlmostEqual(&test, rTM, 0.03170757329754367);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636845253060745);
    AssertAlmostEqual(&test, rTM, 0.0001636845253060745);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636845253060745);
    AssertAlmostEqual(&test, rTM, 0.0001636845253060745);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636845253060745);
    AssertAlmostEqual(&test, rTM, 0.0001636845253060745);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636845253060744);
    AssertAlmostEqual(&test, rTM, 0.0001636845253060745);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636845253060728);
    AssertAlmostEqual(&test, rTM, 0.0001636845253060761);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636845253059108);
    AssertAlmostEqual(&test, rTM, 0.0001636845253062381);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636845252897113);
    AssertAlmostEqual(&test, rTM, 0.0001636845253224375);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000163684523669765);
    AssertAlmostEqual(&test, rTM, 0.0001636845269423839);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636843616752892);
    AssertAlmostEqual(&test, rTM, 0.0001636846889368597);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636681638468021);
    AssertAlmostEqual(&test, rTM, 0.0001637008867653467);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001620644116518827);
    AssertAlmostEqual(&test, rTM, 0.000165304638959407);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.185565951305205e-05);
    AssertAlmostEqual(&test, rTM, 0.0002455133889070457);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.621164285354883e-06);
    AssertAlmostEqual(&test, rTM, 0.000325747877728599);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637375950545986e-06);
    AssertAlmostEqual(&test, rTM, 1.637375950545986e-06);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637375950545986e-06);
    AssertAlmostEqual(&test, rTM, 1.637375950545986e-06);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637375950545986e-06);
    AssertAlmostEqual(&test, rTM, 1.637375950545986e-06);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637375950545986e-06);
    AssertAlmostEqual(&test, rTM, 1.637375950545986e-06);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637375950545986e-06);
    AssertAlmostEqual(&test, rTM, 1.637375950545986e-06);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.63737595054597e-06);
    AssertAlmostEqual(&test, rTM, 1.637375950546003e-06);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637375950544349e-06);
    AssertAlmostEqual(&test, rTM, 1.637375950547624e-06);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637375950382249e-06);
    AssertAlmostEqual(&test, rTM, 1.637375950709723e-06);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637375934172281e-06);
    AssertAlmostEqual(&test, rTM, 1.637375966919692e-06);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637374313177035e-06);
    AssertAlmostEqual(&test, rTM, 1.637377587914938e-06);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637212229859146e-06);
    AssertAlmostEqual(&test, rTM, 1.637539671232827e-06);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.621164360034664e-06);
    AssertAlmostEqual(&test, rTM, 1.653587541057308e-06);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.186893157735435e-07);
    AssertAlmostEqual(&test, rTM, 2.456062585316234e-06);

    userdata[0] = 5/CAPS_HBAR_EV; /* 5eV */
    userdata[1] = 0.0001/CAPS_HBAR_EV; /* 0.0001eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999997499587141);
    AssertAlmostEqual(&test, rTM, 0.9999998749793493);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999982231241646);
    AssertAlmostEqual(&test, rTM, 0.9999999824071545);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999823186812148);
    AssertAlmostEqual(&test, rTM, 0.9999999982320293);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998232096301439);
    AssertAlmostEqual(&test, rTM, 0.9999999998231942);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9982335032073762);
    AssertAlmostEqual(&test, rTM, 0.9999999999823194);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9824750196926575);
    AssertAlmostEqual(&test, rTM, 0.9999999999982319);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8381347223008508);
    AssertAlmostEqual(&test, rTM, 0.9999999999998225);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2031322693214762);
    AssertAlmostEqual(&test, rTM, 0.9999999999999764);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.003178638301479977);
    AssertAlmostEqual(&test, rTM, 0.9999999999999842);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.198737894471447e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999999843);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.198940496127948e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999999843);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.198942522306523e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999999999843);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.198942542568326e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999999999843);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999999438052785);
    AssertAlmostEqual(&test, rTM, 0.9999994436166172);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999992092307289);
    AssertAlmostEqual(&test, rTM, 0.9999996046152864);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.99999438054206);
    AssertAlmostEqual(&test, rTM, 0.9999999443616477);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999440829142033);
    AssertAlmostEqual(&test, rTM, 0.9999999944086942);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994409974928609);
    AssertAlmostEqual(&test, rTM, 0.9999999994408417);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9944240256824449);
    AssertAlmostEqual(&test, rTM, 0.999999999944084);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9456255889103514);
    AssertAlmostEqual(&test, rTM, 0.9999999999944063);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5757285262573824);
    AssertAlmostEqual(&test, rTM, 0.9999999999994194);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03008809315322139);
    AssertAlmostEqual(&test, rTM, 0.999999999999834);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003196335870951688);
    AssertAlmostEqual(&test, rTM, 0.9999999999998436);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.198359704528606e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999998437);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.198379959043661e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999998437);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.198380161590431e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999999998437);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999943546211244);
    AssertAlmostEqual(&test, rTM, 0.9999943546267698);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999943543416862);
    AssertAlmostEqual(&test, rTM, 0.9999943549061939);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999943264673633);
    AssertAlmostEqual(&test, rTM, 0.999994382640796);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999920162419559);
    AssertAlmostEqual(&test, rTM, 0.9999960081130104);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999432661221221);
    AssertAlmostEqual(&test, rTM, 0.9999994382626594);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994355919206317);
    AssertAlmostEqual(&test, rTM, 0.999999943548902);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9943705179403601);
    AssertAlmostEqual(&test, rTM, 0.9999999943545883);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.945117116717025);
    AssertAlmostEqual(&test, rTM, 0.999999999435236);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5727538834807152);
    AssertAlmostEqual(&test, rTM, 0.9999999999413401);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02955004094297478);
    AssertAlmostEqual(&test, rTM, 0.9999999999830943);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003135735232343341);
    AssertAlmostEqual(&test, rTM, 0.9999999999840548);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.137683034612467e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999840646);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.137702527911239e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999840647);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999806696326136);
    AssertAlmostEqual(&test, rTM, 0.9999806696328069);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999806696230451);
    AssertAlmostEqual(&test, rTM, 0.9999806696423753);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999806686662254);
    AssertAlmostEqual(&test, rTM, 0.9999806705991467);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999805732222392);
    AssertAlmostEqual(&test, rTM, 0.9999807655647236);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999726628418574);
    AssertAlmostEqual(&test, rTM, 0.9999863313275117);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998057492048008);
    AssertAlmostEqual(&test, rTM, 0.9999980765398149);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9980687155726481);
    AssertAlmostEqual(&test, rTM, 0.9999998067040518);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9808553686718199);
    AssertAlmostEqual(&test, rTM, 0.9999999806685529);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8244771661956625);
    AssertAlmostEqual(&test, rTM, 0.9999999980579365);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1799615787743959);
    AssertAlmostEqual(&test, rTM, 0.999999999731161);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002661927294536782);
    AssertAlmostEqual(&test, rTM, 0.9999999998121675);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.676012569383399e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999998131548);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.676154363636963e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999998131648);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999039146336852);
    AssertAlmostEqual(&test, rTM, 0.9999039146336949);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999039146332096);
    AssertAlmostEqual(&test, rTM, 0.9999039146341705);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999039145856496);
    AssertAlmostEqual(&test, rTM, 0.9999039146817303);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999039098297726);
    AssertAlmostEqual(&test, rTM, 0.9999039194373672);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999034354250971);
    AssertAlmostEqual(&test, rTM, 0.9999043914642899);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998641174760285);
    AssertAlmostEqual(&test, rTM, 0.9999320564297715);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9990347737923193);
    AssertAlmostEqual(&test, rTM, 0.9999904387339632);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9904365813993382);
    AssertAlmostEqual(&test, rTM, 0.999999039137586);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9084157766193073);
    AssertAlmostEqual(&test, rTM, 0.9999999037992306);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.395614356436705);
    AssertAlmostEqual(&test, rTM, 0.9999999893395013);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01060195279001013);
    AssertAlmostEqual(&test, rTM, 0.9999999952844179);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001082803652634713);
    AssertAlmostEqual(&test, rTM, 0.9999999953823577);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.083035837540695e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999953833476);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991990775190439);
    AssertAlmostEqual(&test, rTM, 0.9991990775190447);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991990775190043);
    AssertAlmostEqual(&test, rTM, 0.9991990775190843);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991990775150413);
    AssertAlmostEqual(&test, rTM, 0.9991990775230473);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991990771187436);
    AssertAlmostEqual(&test, rTM, 0.9991990779193448);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991990374899651);
    AssertAlmostEqual(&test, rTM, 0.9991991175461238);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991950844767474);
    AssertAlmostEqual(&test, rTM, 0.9992030507604673);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9988675125089027);
    AssertAlmostEqual(&test, rTM, 0.9994335958021791);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9919799586458241);
    AssertAlmostEqual(&test, rTM, 0.999920275845349);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9230176459475516);
    AssertAlmostEqual(&test, rTM, 0.9999919815722732);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4578446397884914);
    AssertAlmostEqual(&test, rTM, 0.9999991368501903);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01510939386983899);
    AssertAlmostEqual(&test, rTM, 0.9999996691556992);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000155716915300591);
    AssertAlmostEqual(&test, rTM, 0.9999996789046159);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.557649369056985e-06);
    AssertAlmostEqual(&test, rTM, 0.9999996790036003);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9921957284177017);
    AssertAlmostEqual(&test, rTM, 0.9921957284177018);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9921957284176979);
    AssertAlmostEqual(&test, rTM, 0.9921957284177056);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9921957284173131);
    AssertAlmostEqual(&test, rTM, 0.9921957284180905);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9921957283788332);
    AssertAlmostEqual(&test, rTM, 0.9921957284565702);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9921957245308533);
    AssertAlmostEqual(&test, rTM, 0.9921957323045483);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9921953397425468);
    AssertAlmostEqual(&test, rTM, 0.9921961170735762);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9921569573703314);
    AssertAlmostEqual(&test, rTM, 0.9922343085526245);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9889809877266904);
    AssertAlmostEqual(&test, rTM, 0.9944751900598111);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.924299165850729);
    AssertAlmostEqual(&test, rTM, 0.9992201101336295);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4654471894304451);
    AssertAlmostEqual(&test, rTM, 0.9999158620320534);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01578033599208512);
    AssertAlmostEqual(&test, rTM, 0.9999683239062355);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001628512656437702);
    AssertAlmostEqual(&test, rTM, 0.999969298081209);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.629037905312921e-06);
    AssertAlmostEqual(&test, rTM, 0.9999693079791249);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9248262401391451);
    AssertAlmostEqual(&test, rTM, 0.9248262401391451);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9248262401391447);
    AssertAlmostEqual(&test, rTM, 0.9248262401391455);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.924826240139109);
    AssertAlmostEqual(&test, rTM, 0.9248262401391812);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9248262401355332);
    AssertAlmostEqual(&test, rTM, 0.9248262401427569);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9248262397779557);
    AssertAlmostEqual(&test, rTM, 0.9248262405003344);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9248262040202241);
    AssertAlmostEqual(&test, rTM, 0.9248262762580495);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9248226283435526);
    AssertAlmostEqual(&test, rTM, 0.9248298517679904);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9244660208615183);
    AssertAlmostEqual(&test, rTM, 0.9251848083256504);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8953936147776036);
    AssertAlmostEqual(&test, rTM, 0.946212548166127);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4645545390535453);
    AssertAlmostEqual(&test, rTM, 0.9916907524400942);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01584920443948779);
    AssertAlmostEqual(&test, rTM, 0.9968561352274953);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636006599653682);
    AssertAlmostEqual(&test, rTM, 0.9969530912460389);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.636538298213424e-06);
    AssertAlmostEqual(&test, rTM, 0.996954076563121);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4663221166693163);
    AssertAlmostEqual(&test, rTM, 0.4663221166693163);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4663221166693163);
    AssertAlmostEqual(&test, rTM, 0.4663221166693163);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4663221166693146);
    AssertAlmostEqual(&test, rTM, 0.466322116669318);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4663221166691466);
    AssertAlmostEqual(&test, rTM, 0.466322116669486);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4663221166523442);
    AssertAlmostEqual(&test, rTM, 0.4663221166862884);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4663221149721053);
    AssertAlmostEqual(&test, rTM, 0.4663221183665273);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4663219469482969);
    AssertAlmostEqual(&test, rTM, 0.4663222863903014);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4663051453488002);
    AssertAlmostEqual(&test, rTM, 0.466339087646567);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4646327549130936);
    AssertAlmostEqual(&test, rTM, 0.4680080838990162);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3480052536108961);
    AssertAlmostEqual(&test, rTM, 0.5700168461024127);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01570566047612208);
    AssertAlmostEqual(&test, rTM, 0.7594918563136165);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636597981865275);
    AssertAlmostEqual(&test, rTM, 0.7659920855456303);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637290518622214e-06);
    AssertAlmostEqual(&test, rTM, 0.7660590340304708);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585852101168037);
    AssertAlmostEqual(&test, rTM, 0.01585852101168037);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585852101168037);
    AssertAlmostEqual(&test, rTM, 0.01585852101168037);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585852101168037);
    AssertAlmostEqual(&test, rTM, 0.01585852101168037);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585852101168022);
    AssertAlmostEqual(&test, rTM, 0.01585852101168053);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585852101166501);
    AssertAlmostEqual(&test, rTM, 0.01585852101169574);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585852101014403);
    AssertAlmostEqual(&test, rTM, 0.01585852101321671);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0158585208580465);
    AssertAlmostEqual(&test, rTM, 0.01585852116531425);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585850564830754);
    AssertAlmostEqual(&test, rTM, 0.01585853637505319);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585698482176891);
    AssertAlmostEqual(&test, rTM, 0.01586005720151697);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01570636158892745);
    AssertAlmostEqual(&test, rTM, 0.01601067969992361);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.008055497420183097);
    AssertAlmostEqual(&test, rTM, 0.02365961343428854);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001620635907055461);
    AssertAlmostEqual(&test, rTM, 0.03154716595130122);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637203858389042e-06);
    AssertAlmostEqual(&test, rTM, 0.03170743186694643);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636844499284159);
    AssertAlmostEqual(&test, rTM, 0.0001636844499284159);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636844499284159);
    AssertAlmostEqual(&test, rTM, 0.0001636844499284159);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636844499284159);
    AssertAlmostEqual(&test, rTM, 0.0001636844499284159);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636844499284159);
    AssertAlmostEqual(&test, rTM, 0.0001636844499284159);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636844499284142);
    AssertAlmostEqual(&test, rTM, 0.0001636844499284175);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636844499282522);
    AssertAlmostEqual(&test, rTM, 0.0001636844499285795);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636844499120528);
    AssertAlmostEqual(&test, rTM, 0.000163684449944779);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636844482921071);
    AssertAlmostEqual(&test, rTM, 0.0001636844515647246);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636842862977059);
    AssertAlmostEqual(&test, rTM, 0.0001636846135591258);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636680884766756);
    AssertAlmostEqual(&test, rTM, 0.0001637008113801561);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001620643370200538);
    AssertAlmostEqual(&test, rTM, 0.0001653045628359186);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.185562181188385e-05);
    AssertAlmostEqual(&test, rTM, 0.0002455132758528998);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.621163538557455e-06);
    AssertAlmostEqual(&test, rTM, 0.0003257477277200911);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637375875119413e-06);
    AssertAlmostEqual(&test, rTM, 1.637375875119413e-06);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637375875119413e-06);
    AssertAlmostEqual(&test, rTM, 1.637375875119413e-06);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637375875119413e-06);
    AssertAlmostEqual(&test, rTM, 1.637375875119413e-06);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637375875119413e-06);
    AssertAlmostEqual(&test, rTM, 1.637375875119413e-06);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637375875119413e-06);
    AssertAlmostEqual(&test, rTM, 1.637375875119413e-06);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637375875119396e-06);
    AssertAlmostEqual(&test, rTM, 1.637375875119429e-06);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637375875117775e-06);
    AssertAlmostEqual(&test, rTM, 1.63737587512105e-06);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637375874955676e-06);
    AssertAlmostEqual(&test, rTM, 1.63737587528315e-06);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637375858745708e-06);
    AssertAlmostEqual(&test, rTM, 1.637375891493118e-06);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637374237750537e-06);
    AssertAlmostEqual(&test, rTM, 1.637377512488288e-06);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637212154440114e-06);
    AssertAlmostEqual(&test, rTM, 1.637539595798711e-06);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.621164285354883e-06);
    AssertAlmostEqual(&test, rTM, 1.653587464883941e-06);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.186892780601332e-07);
    AssertAlmostEqual(&test, rTM, 2.456062472176497e-06);

    userdata[0] = 5/CAPS_HBAR_EV; /* 5eV */
    userdata[1] = 0.001/CAPS_HBAR_EV; /* 0.001eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999992093071928);
    AssertAlmostEqual(&test, rTM, 0.9999996046535182);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999994381085435);
    AssertAlmostEqual(&test, rTM, 0.9999999443670278);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999944088320985);
    AssertAlmostEqual(&test, rTM, 0.9999999944092349);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994410515308002);
    AssertAlmostEqual(&test, rTM, 0.9999999994408958);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9944245633470377);
    AssertAlmostEqual(&test, rTM, 0.9999999999440894);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9456306997487203);
    AssertAlmostEqual(&test, rTM, 0.9999999999944068);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5757585061074799);
    AssertAlmostEqual(&test, rTM, 0.9999999999994195);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03009357273221522);
    AssertAlmostEqual(&test, rTM, 0.999999999999834);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003196953708308317);
    AssertAlmostEqual(&test, rTM, 0.9999999999998436);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.19897832454129e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999998437);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.198998586892293e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999998437);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.198998789517423e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999999998437);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.198998791543675e-12);
    AssertAlmostEqual(&test, rTM, 0.9999999999998437);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999982231241646);
    AssertAlmostEqual(&test, rTM, 0.9999982407169792);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999974995899544);
    AssertAlmostEqual(&test, rTM, 0.9999987497941957);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999822313837234);
    AssertAlmostEqual(&test, rTM, 0.9999998240715586);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998232008800195);
    AssertAlmostEqual(&test, rTM, 0.999999982320293);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9982335023337336);
    AssertAlmostEqual(&test, rTM, 0.9999999982319411);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9824750196066757);
    AssertAlmostEqual(&test, rTM, 0.9999999998231872);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.838134722293544);
    AssertAlmostEqual(&test, rTM, 0.9999999999822504);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.203132269321343);
    AssertAlmostEqual(&test, rTM, 0.9999999999976401);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.003178638301479946);
    AssertAlmostEqual(&test, rTM, 0.999999999998427);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.198737894471448e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999984369);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.198940496127948e-07);
    AssertAlmostEqual(&test, rTM, 0.999999999998437);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.198942522306524e-09);
    AssertAlmostEqual(&test, rTM, 0.999999999998437);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.198942542568326e-11);
    AssertAlmostEqual(&test, rTM, 0.999999999998437);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999823024663975);
    AssertAlmostEqual(&test, rTM, 0.9999823024840948);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999823015903999);
    AssertAlmostEqual(&test, rTM, 0.9999823033600482);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999822142085272);
    AssertAlmostEqual(&test, rTM, 0.999982390303922);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999749720122082);
    AssertAlmostEqual(&test, rTM, 0.9999874859278026);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998221563198759);
    AssertAlmostEqual(&test, rTM, 0.9999982390164306);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9982317088813418);
    AssertAlmostEqual(&test, rTM, 0.999999823031981);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9824582210441497);
    AssertAlmostEqual(&test, rTM, 0.9999999823016348);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.837992051269457);
    AssertAlmostEqual(&test, rTM, 0.9999999982233165);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2028723947812287);
    AssertAlmostEqual(&test, rTM, 0.9999999997636833);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.003172540993987075);
    AssertAlmostEqual(&test, rTM, 0.9999999998423992);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.192563369589807e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999998433861);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.192765189818767e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999998433959);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.19276720818213e-09);
    AssertAlmostEqual(&test, rTM, 0.999999999843396);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999435476733368);
    AssertAlmostEqual(&test, rTM, 0.9999435476739014);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999435476453937);
    AssertAlmostEqual(&test, rTM, 0.9999435477018445);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999943544851153);
    AssertAlmostEqual(&test, rTM, 0.9999435504959441);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999432661221221);
    AssertAlmostEqual(&test, rTM, 0.9999438278279082);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999201652878368);
    AssertAlmostEqual(&test, rTM, 0.999960081847173);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994328060498198);
    AssertAlmostEqual(&test, rTM, 0.9999943826405744);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9943702400747598);
    AssertAlmostEqual(&test, rTM, 0.9999994354869367);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9451170903165422);
    AssertAlmostEqual(&test, rTM, 0.9999999435236243);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.572753881940361);
    AssertAlmostEqual(&test, rTM, 0.9999999941340163);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02955004094021726);
    AssertAlmostEqual(&test, rTM, 0.9999999983094324);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003135735232340239);
    AssertAlmostEqual(&test, rTM, 0.9999999984054778);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.137683034612436e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999984064675);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.137702527911239e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999984064774);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998067131413632);
    AssertAlmostEqual(&test, rTM, 0.9998067131413825);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998067131404065);
    AssertAlmostEqual(&test, rTM, 0.9998067131423392);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998067130447388);
    AssertAlmostEqual(&test, rTM, 0.9998067132380069);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998067034782055);
    AssertAlmostEqual(&test, rTM, 0.999806722804057);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998057492048008);
    AssertAlmostEqual(&test, rTM, 0.9998076722950333);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997266620463744);
    AssertAlmostEqual(&test, rTM, 0.9998633216820676);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.998059189472306);
    AssertAlmostEqual(&test, rTM, 0.9999807655558285);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9808544301961514);
    AssertAlmostEqual(&test, rTM, 0.9999980669528264);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8244770876704929);
    AssertAlmostEqual(&test, rTM, 0.9999998057937677);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1799615775362229);
    AssertAlmostEqual(&test, rTM, 0.9999999731161003);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002661927294274651);
    AssertAlmostEqual(&test, rTM, 0.9999999812167504);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.67601256938075e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999813154843);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.676154363636937e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999813164742);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9990395617249219);
    AssertAlmostEqual(&test, rTM, 0.9990395617249228);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9990395617248744);
    AssertAlmostEqual(&test, rTM, 0.9990395617249703);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9990395617201224);
    AssertAlmostEqual(&test, rTM, 0.9990395617297223);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9990395612449341);
    AssertAlmostEqual(&test, rTM, 0.9990395622049104);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9990395137272818);
    AssertAlmostEqual(&test, rTM, 0.9990396097201656);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9990347737923193);
    AssertAlmostEqual(&test, rTM, 0.9990443259186971);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9986420054453727);
    AssertAlmostEqual(&test, rTM, 0.9993207719690134);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9903895917580132);
    AssertAlmostEqual(&test, rTM, 0.9999043903717983);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9084114608791127);
    AssertAlmostEqual(&test, rTM, 0.9999903804461302);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3956141868250374);
    AssertAlmostEqual(&test, rTM, 0.9999989339513654);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.010601952687253);
    AssertAlmostEqual(&test, rTM, 0.9999995284419996);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001082803652527538);
    AssertAlmostEqual(&test, rTM, 0.9999995382359839);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.083035837539623e-06);
    AssertAlmostEqual(&test, rTM, 0.999999538334973);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9920196011300557);
    AssertAlmostEqual(&test, rTM, 0.9920196011300557);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9920196011300517);
    AssertAlmostEqual(&test, rTM, 0.9920196011300597);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9920196011296583);
    AssertAlmostEqual(&test, rTM, 0.9920196011304532);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9920196010903136);
    AssertAlmostEqual(&test, rTM, 0.9920196011697978);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9920195971558428);
    AssertAlmostEqual(&test, rTM, 0.9920196051042667);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9920192037186747);
    AssertAlmostEqual(&test, rTM, 0.9920199985217265);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9919799586458241);
    AssertAlmostEqual(&test, rTM, 0.9920590484455025);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.988732724234926);
    AssertAlmostEqual(&test, rTM, 0.9943503579369306);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.922652848888014);
    AssertAlmostEqual(&test, rTM, 0.9992024180738526);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4578277841512294);
    AssertAlmostEqual(&test, rTM, 0.9999136937591185);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01510937935684672);
    AssertAlmostEqual(&test, rTM, 0.9999669166383406);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001557169137594736);
    AssertAlmostEqual(&test, rTM, 0.9999678914821103);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.557649368902778e-06);
    AssertAlmostEqual(&test, rTM, 0.9999679013800765);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9246601471615791);
    AssertAlmostEqual(&test, rTM, 0.9246601471615791);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9246601471615786);
    AssertAlmostEqual(&test, rTM, 0.9246601471615794);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9246601471615429);
    AssertAlmostEqual(&test, rTM, 0.9246601471616153);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9246601471579595);
    AssertAlmostEqual(&test, rTM, 0.9246601471651986);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9246601467996255);
    AssertAlmostEqual(&test, rTM, 0.9246601475235326);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9246601109662327);
    AssertAlmostEqual(&test, rTM, 0.9246601833569087);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9246565277236747);
    AssertAlmostEqual(&test, rTM, 0.9246637664324145);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.924299165850729);
    AssertAlmostEqual(&test, rTM, 0.9250194741965938);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8951663813141414);
    AssertAlmostEqual(&test, rTM, 0.9460922002677722);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4637742225875329);
    AssertAlmostEqual(&test, rTM, 0.9916692318253089);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01577882242534768);
    AssertAlmostEqual(&test, rTM, 0.9968421491670965);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001628511044736804);
    AssertAlmostEqual(&test, rTM, 0.996939110151008);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.629037889185498e-06);
    AssertAlmostEqual(&test, rTM, 0.9969400954481199);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4662439542499263);
    AssertAlmostEqual(&test, rTM, 0.4662439542499263);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4662439542499263);
    AssertAlmostEqual(&test, rTM, 0.4662439542499264);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4662439542499247);
    AssertAlmostEqual(&test, rTM, 0.466243954249928);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4662439542497566);
    AssertAlmostEqual(&test, rTM, 0.4662439542500961);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4662439542329537);
    AssertAlmostEqual(&test, rTM, 0.466243954266899);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4662439525526608);
    AssertAlmostEqual(&test, rTM, 0.4662439559471918);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4662437845234542);
    AssertAlmostEqual(&test, rTM, 0.4662441239763641);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4662269823842481);
    AssertAlmostEqual(&test, rTM, 0.4662609257724066);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4645545390535454);
    AssertAlmostEqual(&test, rTM, 0.4679299755885942);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.347927739026083);
    AssertAlmostEqual(&test, rTM, 0.5699415275203592);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01569865279003062);
    AssertAlmostEqual(&test, rTM, 0.7594102795198305);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001635844704171002);
    AssertAlmostEqual(&test, rTM, 0.765909553787861);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.636536678047432e-06);
    AssertAlmostEqual(&test, rTM, 0.7659764919357339);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585781332210438);
    AssertAlmostEqual(&test, rTM, 0.01585781332210438);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585781332210438);
    AssertAlmostEqual(&test, rTM, 0.01585781332210438);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585781332210438);
    AssertAlmostEqual(&test, rTM, 0.01585781332210438);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585781332210423);
    AssertAlmostEqual(&test, rTM, 0.01585781332210454);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585781332208902);
    AssertAlmostEqual(&test, rTM, 0.01585781332211975);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585781332056811);
    AssertAlmostEqual(&test, rTM, 0.01585781332364065);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585781316847715);
    AssertAlmostEqual(&test, rTM, 0.01585781347573162);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0158577979593954);
    AssertAlmostEqual(&test, rTM, 0.01585782868481336);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585627719857116);
    AssertAlmostEqual(&test, rTM, 0.01585934944556275);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01570566047612208);
    AssertAlmostEqual(&test, rTM, 0.0160099654336733);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.008055132287421312);
    AssertAlmostEqual(&test, rTM, 0.02365856344362554);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001620561279385015);
    AssertAlmostEqual(&test, rTM, 0.03154575908036888);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637128443599102e-06);
    AssertAlmostEqual(&test, rTM, 0.03170601763036406);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636836961556483);
    AssertAlmostEqual(&test, rTM, 0.0001636836961556483);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636836961556483);
    AssertAlmostEqual(&test, rTM, 0.0001636836961556483);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636836961556483);
    AssertAlmostEqual(&test, rTM, 0.0001636836961556483);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636836961556483);
    AssertAlmostEqual(&test, rTM, 0.0001636836961556483);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636836961556466);
    AssertAlmostEqual(&test, rTM, 0.0001636836961556499);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636836961554847);
    AssertAlmostEqual(&test, rTM, 0.0001636836961558119);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636836961392853);
    AssertAlmostEqual(&test, rTM, 0.0001636836961720113);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636836945193471);
    AssertAlmostEqual(&test, rTM, 0.0001636836977919495);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636835325256916);
    AssertAlmostEqual(&test, rTM, 0.0001636838597856049);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636673347792284);
    AssertAlmostEqual(&test, rTM, 0.0001637000575320681);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001620635907055461);
    AssertAlmostEqual(&test, rTM, 0.0001653038016048912);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.185524480211189e-05);
    AssertAlmostEqual(&test, rTM, 0.0002455121453171669);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.621156070621013e-06);
    AssertAlmostEqual(&test, rTM, 0.0003257462276426112);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637375120854059e-06);
    AssertAlmostEqual(&test, rTM, 1.637375120854059e-06);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637375120854059e-06);
    AssertAlmostEqual(&test, rTM, 1.637375120854059e-06);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637375120854059e-06);
    AssertAlmostEqual(&test, rTM, 1.637375120854059e-06);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637375120854059e-06);
    AssertAlmostEqual(&test, rTM, 1.637375120854059e-06);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637375120854059e-06);
    AssertAlmostEqual(&test, rTM, 1.637375120854059e-06);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637375120854043e-06);
    AssertAlmostEqual(&test, rTM, 1.637375120854075e-06);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637375120852422e-06);
    AssertAlmostEqual(&test, rTM, 1.637375120855696e-06);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637375120690322e-06);
    AssertAlmostEqual(&test, rTM, 1.637375121017796e-06);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637375104480362e-06);
    AssertAlmostEqual(&test, rTM, 1.637375137227756e-06);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637373483485938e-06);
    AssertAlmostEqual(&test, rTM, 1.637376758222181e-06);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637211400250179e-06);
    AssertAlmostEqual(&test, rTM, 1.637538841457939e-06);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.621163538557455e-06);
    AssertAlmostEqual(&test, rTM, 1.653586703150662e-06);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.186889009262213e-07);
    AssertAlmostEqual(&test, rTM, 2.456061340779702e-06);

    userdata[0] = 5/CAPS_HBAR_EV; /* 5eV */
    userdata[1] = 0.003/CAPS_HBAR_EV; /* 0.003eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999998630481173);
    AssertAlmostEqual(&test, rTM, 0.999999315240352);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999902677808441);
    AssertAlmostEqual(&test, rTM, 0.9999999036409303);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999031601761861);
    AssertAlmostEqual(&test, rTM, 0.9999999903165171);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9990320715861704);
    AssertAlmostEqual(&test, rTM, 0.9999999990316036);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9903628089162362);
    AssertAlmostEqual(&test, rTM, 0.9999999999031592);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9077358367919737);
    AssertAlmostEqual(&test, rTM, 0.9999999999903046);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3929519797531666);
    AssertAlmostEqual(&test, rTM, 0.9999999999989241);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01044181648912084);
    AssertAlmostEqual(&test, rTM, 0.9999999999995212);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001066106966237186);
    AssertAlmostEqual(&test, rTM, 0.999999999999531);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.066332045274952e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999995312);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.066334296665274e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999995312);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.066334319179238e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999999995312);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.066334319404377e-12);
    AssertAlmostEqual(&test, rTM, 0.9999999999995312);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999969223828186);
    AssertAlmostEqual(&test, rTM, 0.9999969528542294);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999956691949287);
    AssertAlmostEqual(&test, rTM, 0.9999978345951198);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999692242544109);
    AssertAlmostEqual(&test, rTM, 0.9999996952850051);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996937967531097);
    AssertAlmostEqual(&test, rTM, 0.9999999693780485);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9969423356069831);
    AssertAlmostEqual(&test, rTM, 0.9999999969376496);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9698418264263591);
    AssertAlmostEqual(&test, rTM, 0.9999999996937293);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7370860267873317);
    AssertAlmostEqual(&test, rTM, 0.9999999999690196);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0885786807086813);
    AssertAlmostEqual(&test, rTM, 0.9999999999943996);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001064060002676446);
    AssertAlmostEqual(&test, rTM, 0.999999999995301);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.066305328946609e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999953109);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.066327842040375e-07);
    AssertAlmostEqual(&test, rTM, 0.999999999995311);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.066328067177313e-09);
    AssertAlmostEqual(&test, rTM, 0.999999999995311);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.066328069428683e-11);
    AssertAlmostEqual(&test, rTM, 0.999999999995311);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999693671009197);
    AssertAlmostEqual(&test, rTM, 0.999969367131552);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999693655846533);
    AssertAlmostEqual(&test, rTM, 0.9999693686477417);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999692143351772);
    AssertAlmostEqual(&test, rTM, 0.9999695191390943);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999566788351727);
    AssertAlmostEqual(&test, rTM, 0.9999783391829883);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999692185998546);
    AssertAlmostEqual(&test, rTM, 0.9999969518720644);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9969412004278209);
    AssertAlmostEqual(&test, rTM, 0.9999996936814736);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9698322402517912);
    AssertAlmostEqual(&test, rTM, 0.9999999693630698);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7370141149106259);
    AssertAlmostEqual(&test, rTM, 0.99999999690094);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.08853089163473826);
    AssertAlmostEqual(&test, rTM, 0.9999999994396519);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001063375872455079);
    AssertAlmostEqual(&test, rTM, 0.9999999995297999);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.065618310154058e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999995307889);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.065640794246652e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999995307988);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.065641019093567e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999995307989);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999028502596422);
    AssertAlmostEqual(&test, rTM, 0.9999028502606137);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999028502115553);
    AssertAlmostEqual(&test, rTM, 0.9999028503087004);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999028454029983);
    AssertAlmostEqual(&test, rTM, 0.9999028551170147);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999023657434212);
    AssertAlmostEqual(&test, rTM, 0.9999033323725034);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998626122847456);
    AssertAlmostEqual(&test, rTM, 0.9999313037827066);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9990240863210689);
    AssertAlmostEqual(&test, rTM, 0.9999903328155832);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9903311533324065);
    AssertAlmostEqual(&test, rTM, 0.9999990284929917);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9074504287561395);
    AssertAlmostEqual(&test, rTM, 0.9999999027310318);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3918405734536364);
    AssertAlmostEqual(&test, rTM, 0.9999999891989114);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01037564892870952);
    AssertAlmostEqual(&test, rTM, 0.9999999951815431);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001059211080793743);
    AssertAlmostEqual(&test, rTM, 0.9999999952795057);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.059433257272103e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999952804955);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.059435479625263e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999952805054);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996840017291846);
    AssertAlmostEqual(&test, rTM, 0.9996840017292162);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996840017276207);
    AssertAlmostEqual(&test, rTM, 0.9996840017307802);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996840015712263);
    AssertAlmostEqual(&test, rTM, 0.9996840018871745);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996839859321787);
    AssertAlmostEqual(&test, rTM, 0.9996840175254327);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996824259184952);
    AssertAlmostEqual(&test, rTM, 0.9996855697219221);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995531402102382);
    AssertAlmostEqual(&test, rTM, 0.999776545136292);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9968287950596638);
    AssertAlmostEqual(&test, rTM, 0.9999685524833145);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9688891346251927);
    AssertAlmostEqual(&test, rTM, 0.9999968392863785);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7299731263335696);
    AssertAlmostEqual(&test, rTM, 0.99999968003022);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.08400081504559004);
    AssertAlmostEqual(&test, rTM, 0.9999999408967759);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0009991370333871893);
    AssertAlmostEqual(&test, rTM, 0.9999999499568669);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.001116534353152e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999500557669);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.00113637888662e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999500567569);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9987563774324479);
    AssertAlmostEqual(&test, rTM, 0.9987563774324492);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9987563774323864);
    AssertAlmostEqual(&test, rTM, 0.9987563774325107);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9987563774262342);
    AssertAlmostEqual(&test, rTM, 0.9987563774386627);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9987563768110242);
    AssertAlmostEqual(&test, rTM, 0.9987563780538724);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9987563152915645);
    AssertAlmostEqual(&test, rTM, 0.9987564395702295);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9987501786661654);
    AssertAlmostEqual(&test, rTM, 0.9987625454736087);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9982417053096984);
    AssertAlmostEqual(&test, rTM, 0.9991204656945293);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9875719249791893);
    AssertAlmostEqual(&test, rTM, 0.9998761832045452);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8830568324921416);
    AssertAlmostEqual(&test, rTM, 0.9999875326736738);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3086543535397712);
    AssertAlmostEqual(&test, rTM, 0.999998534395252);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.006375684151969996);
    AssertAlmostEqual(&test, rTM, 0.9999992158029337);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.456933157008021e-05);
    AssertAlmostEqual(&test, rTM, 0.9999992256391718);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.457758737593224e-07);
    AssertAlmostEqual(&test, rTM, 0.9999992257381652);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9916416395619176);
    AssertAlmostEqual(&test, rTM, 0.9916416395619178);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9916416395619135);
    AssertAlmostEqual(&test, rTM, 0.9916416395619219);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9916416395615015);
    AssertAlmostEqual(&test, rTM, 0.9916416395623339);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9916416395203013);
    AssertAlmostEqual(&test, rTM, 0.9916416396035341);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9916416354002774);
    AssertAlmostEqual(&test, rTM, 0.9916416437235559);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9916412234082714);
    AssertAlmostEqual(&test, rTM, 0.9916420556949321);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.991600127542975);
    AssertAlmostEqual(&test, rTM, 0.9916829472859344);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9882000234101536);
    AssertAlmostEqual(&test, rTM, 0.9940824513654392);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.919129031037293);
    AssertAlmostEqual(&test, rTM, 0.9991644357672247);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.441966628973633);
    AssertAlmostEqual(&test, rTM, 0.9999089824658827);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01380504055335112);
    AssertAlmostEqual(&test, rTM, 0.9999637895771953);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001419022547698882);
    AssertAlmostEqual(&test, rTM, 0.9999647657205234);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.419421342964491e-06);
    AssertAlmostEqual(&test, rTM, 0.9999647756185813);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9242925171994463);
    AssertAlmostEqual(&test, rTM, 0.9242925171994463);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9242925171994458);
    AssertAlmostEqual(&test, rTM, 0.9242925171994466);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9242925171994099);
    AssertAlmostEqual(&test, rTM, 0.9242925171994826);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9242925171958098);
    AssertAlmostEqual(&test, rTM, 0.9242925172030827);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9242925168358016);
    AssertAlmostEqual(&test, rTM, 0.9242925175630908);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9242924808349953);
    AssertAlmostEqual(&test, rTM, 0.9242925535638805);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9242888808515646);
    AssertAlmostEqual(&test, rTM, 0.9242961533795478);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9239298497570086);
    AssertAlmostEqual(&test, rTM, 0.9246535233242495);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8946634858902018);
    AssertAlmostEqual(&test, rTM, 0.9458257969699015);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4620520744677666);
    AssertAlmostEqual(&test, rTM, 0.991621527526831);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01562463461513661);
    AssertAlmostEqual(&test, rTM, 0.9968110706581575);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001612097681582986);
    AssertAlmostEqual(&test, rTM, 0.9969080424548666);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.612613974516579e-06);
    AssertAlmostEqual(&test, rTM, 0.9969090277075787);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4660703797833893);
    AssertAlmostEqual(&test, rTM, 0.4660703797833893);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4660703797833893);
    AssertAlmostEqual(&test, rTM, 0.4660703797833893);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4660703797833876);
    AssertAlmostEqual(&test, rTM, 0.466070379783391);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4660703797832195);
    AssertAlmostEqual(&test, rTM, 0.466070379783559);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4660703797664154);
    AssertAlmostEqual(&test, rTM, 0.4660703798003631);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.466070378086003);
    AssertAlmostEqual(&test, rTM, 0.4660703814807756);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4660702100448361);
    AssertAlmostEqual(&test, rTM, 0.4660705495219081);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4660534067098477);
    AssertAlmostEqual(&test, rTM, 0.4660873525138829);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4643808461896428);
    AssertAlmostEqual(&test, rTM, 0.4677565210053519);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3477556249615366);
    AssertAlmostEqual(&test, rTM, 0.5697742492119368);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01568310252666682);
    AssertAlmostEqual(&test, rTM, 0.7592290606104354);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001634173233827965);
    AssertAlmostEqual(&test, rTM, 0.7657262135402962);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.63486395951518e-06);
    AssertAlmostEqual(&test, rTM, 0.7657931287274973);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585624090477064);
    AssertAlmostEqual(&test, rTM, 0.01585624090477064);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585624090477064);
    AssertAlmostEqual(&test, rTM, 0.01585624090477064);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585624090477064);
    AssertAlmostEqual(&test, rTM, 0.01585624090477064);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585624090477049);
    AssertAlmostEqual(&test, rTM, 0.0158562409047708);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585624090475528);
    AssertAlmostEqual(&test, rTM, 0.015856240904786);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585624090323452);
    AssertAlmostEqual(&test, rTM, 0.01585624090630677);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585624075115816);
    AssertAlmostEqual(&test, rTM, 0.01585624105838313);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585622554353666);
    AssertAlmostEqual(&test, rTM, 0.01585625626600462);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585470492872408);
    AssertAlmostEqual(&test, rTM, 0.01585777688074237);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01570410267179941);
    AssertAlmostEqual(&test, rTM, 0.0160083784035424);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.008054320999789009);
    AssertAlmostEqual(&test, rTM, 0.02365623046471135);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001620395464721763);
    AssertAlmostEqual(&test, rTM, 0.0315426331497279);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.636960880048904e-06);
    AssertAlmostEqual(&test, rTM, 0.03170287533403347);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636820211299085);
    AssertAlmostEqual(&test, rTM, 0.0001636820211299085);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636820211299085);
    AssertAlmostEqual(&test, rTM, 0.0001636820211299085);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636820211299085);
    AssertAlmostEqual(&test, rTM, 0.0001636820211299085);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636820211299085);
    AssertAlmostEqual(&test, rTM, 0.0001636820211299086);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636820211299069);
    AssertAlmostEqual(&test, rTM, 0.0001636820211299102);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636820211297449);
    AssertAlmostEqual(&test, rTM, 0.0001636820211300722);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636820211135457);
    AssertAlmostEqual(&test, rTM, 0.0001636820211462714);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636820194936241);
    AssertAlmostEqual(&test, rTM, 0.000163682022766193);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636818575016258);
    AssertAlmostEqual(&test, rTM, 0.0001636821847581913);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636656599208649);
    AssertAlmostEqual(&test, rTM, 0.0001636983823389521);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001620619322534714);
    AssertAlmostEqual(&test, rTM, 0.0001653021100054864);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.18544070150522e-05);
    AssertAlmostEqual(&test, rTM, 0.0002455096330528144);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.621139475453024e-06);
    AssertAlmostEqual(&test, rTM, 0.0003257428941865637);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637373444711316e-06);
    AssertAlmostEqual(&test, rTM, 1.637373444711316e-06);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637373444711316e-06);
    AssertAlmostEqual(&test, rTM, 1.637373444711316e-06);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637373444711316e-06);
    AssertAlmostEqual(&test, rTM, 1.637373444711316e-06);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637373444711316e-06);
    AssertAlmostEqual(&test, rTM, 1.637373444711316e-06);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637373444711316e-06);
    AssertAlmostEqual(&test, rTM, 1.637373444711316e-06);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.6373734447113e-06);
    AssertAlmostEqual(&test, rTM, 1.637373444711333e-06);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637373444709679e-06);
    AssertAlmostEqual(&test, rTM, 1.637373444712954e-06);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637373444547579e-06);
    AssertAlmostEqual(&test, rTM, 1.637373444875053e-06);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637373428337636e-06);
    AssertAlmostEqual(&test, rTM, 1.637373461084997e-06);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637371807344871e-06);
    AssertAlmostEqual(&test, rTM, 1.637375082077762e-06);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637209724275033e-06);
    AssertAlmostEqual(&test, rTM, 1.6375371651476e-06);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.621161879010077e-06);
    AssertAlmostEqual(&test, rTM, 1.653585010412555e-06);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.186880628521055e-07);
    AssertAlmostEqual(&test, rTM, 2.456058826568332e-06);

    userdata[0] = 5/CAPS_HBAR_EV; /* 5eV */
    userdata[1] = 0.035/CAPS_HBAR_EV; /* 0.035eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999953222117991);
    AssertAlmostEqual(&test, rTM, 0.9999976611031643);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999966758543803);
    AssertAlmostEqual(&test, rTM, 0.9999996708712551);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996692678179375);
    AssertAlmostEqual(&test, rTM, 0.9999999669246189);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9966977607849948);
    AssertAlmostEqual(&test, rTM, 0.9999999966922937);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9674654866702755);
    AssertAlmostEqual(&test, rTM, 0.9999999996691844);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7194410220711493);
    AssertAlmostEqual(&test, rTM, 0.9999999999664736);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.07774138866056006);
    AssertAlmostEqual(&test, rTM, 0.9999999999936073);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0009123344003766348);
    AssertAlmostEqual(&test, rTM, 0.9999999999945196);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -9.139846818339741e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999945295);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -9.140012223433336e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999945296);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -9.140013877522064e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999999945296);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -9.140013894062955e-12);
    AssertAlmostEqual(&test, rTM, 0.9999999999945296);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -9.140013894228364e-14);
    AssertAlmostEqual(&test, rTM, 0.9999999999945296);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999894880064593);
    AssertAlmostEqual(&test, rTM, 0.9999895920850616);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999852076059681);
    AssertAlmostEqual(&test, rTM, 0.9999926037756319);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998948850370915);
    AssertAlmostEqual(&test, rTM, 0.9999989592036301);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9989545067095854);
    AssertAlmostEqual(&test, rTM, 0.9999998954064258);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9895946768207958);
    AssertAlmostEqual(&test, rTM, 0.9999999895399827);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9007287055080542);
    AssertAlmostEqual(&test, rTM, 0.9999999989525825);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3666431524147103);
    AssertAlmostEqual(&test, rTM, 0.9999999998819598);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.008976652433484536);
    AssertAlmostEqual(&test, rTM, 0.9999999999443044);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -9.138338888674533e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999452854);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -9.139992594480288e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999452953);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -9.140009135316584e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999999452954);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -9.140009300725325e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999999452954);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -9.140009302379414e-13);
    AssertAlmostEqual(&test, rTM, 0.9999999999452954);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998954037332173);
    AssertAlmostEqual(&test, rTM, 0.999895403837808);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998953985561062);
    AssertAlmostEqual(&test, rTM, 0.9998954090146577);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998948821328166);
    AssertAlmostEqual(&test, rTM, 0.9998959228496157);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998520818193917);
    AssertAlmostEqual(&test, rTM, 0.9999260381744188);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9989493184761488);
    AssertAlmostEqual(&test, rTM, 0.9999895917960729);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9895938784449193);
    AssertAlmostEqual(&test, rTM, 0.9999989540216889);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9007260592360002);
    AssertAlmostEqual(&test, rTM, 0.999999895255408);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.366633760938424);
    AssertAlmostEqual(&test, rTM, 0.9999999881955816);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.008976165212052878);
    AssertAlmostEqual(&test, rTM, 0.9999999944301414);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -9.137833999687013e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999945282438);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -9.139487522761502e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999945292337);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -9.13950406176986e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999945292437);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -9.139504227160321e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999945292438);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996691920820235);
    AssertAlmostEqual(&test, rTM, 0.9996691920853311);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996691919183008);
    AssertAlmostEqual(&test, rTM, 0.9996691922490538);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996691755464314);
    AssertAlmostEqual(&test, rTM, 0.9996692086200968);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996675424329581);
    AssertAlmostEqual(&test, rTM, 0.9996708335501957);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995321990148407);
    AssertAlmostEqual(&test, rTM, 0.9997660721430993);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9966803951956515);
    AssertAlmostEqual(&test, rTM, 0.9999670784334787);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9674549584196194);
    AssertAlmostEqual(&test, rTM, 0.9999966910917794);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.719375395259339);
    AssertAlmostEqual(&test, rTM, 0.9999996646406958);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.07770427419748346);
    AssertAlmostEqual(&test, rTM, 0.9999999360420011);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000911826389064127);
    AssertAlmostEqual(&test, rTM, 0.9999999451650486);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -9.134748320485743e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999452639574);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -9.134913541102143e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999452649475);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -9.134915193346036e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999452649574);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9989516469597299);
    AssertAlmostEqual(&test, rTM, 0.9989516469598347);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9989516469545433);
    AssertAlmostEqual(&test, rTM, 0.9989516469650214);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9989516464358809);
    AssertAlmostEqual(&test, rTM, 0.9989516474836835);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9989515945709319);
    AssertAlmostEqual(&test, rTM, 0.9989516993460162);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9989464209897649);
    AssertAlmostEqual(&test, rTM, 0.9989568470214338);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9985177269487536);
    AssertAlmostEqual(&test, rTM, 0.9992585885270417);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9895140689196772);
    AssertAlmostEqual(&test, rTM, 0.9998956342765423);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9004618210897816);
    AssertAlmostEqual(&test, rTM, 0.9999894971366893);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3656974099626659);
    AssertAlmostEqual(&test, rTM, 0.9999988156003253);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.008927708739020799);
    AssertAlmostEqual(&test, rTM, 0.9999994399908418);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -9.087625291207704e-05);
    AssertAlmostEqual(&test, rTM, 0.9999994498015656);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -9.089260692999257e-07);
    AssertAlmostEqual(&test, rTM, 0.9999994499005564);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -9.089277050732855e-09);
    AssertAlmostEqual(&test, rTM, 0.9999994499015464);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9966070015609052);
    AssertAlmostEqual(&test, rTM, 0.9966070015609085);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9966070015607374);
    AssertAlmostEqual(&test, rTM, 0.9966070015610762);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9966070015439706);
    AssertAlmostEqual(&test, rTM, 0.996607001577843);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9966069998672911);
    AssertAlmostEqual(&test, rTM, 0.9966070032545218);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9966068322035332);
    AssertAlmostEqual(&test, rTM, 0.9966071709098421);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9965901076720459);
    AssertAlmostEqual(&test, rTM, 0.9966238118926221);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.995204952044845);
    AssertAlmostEqual(&test, rTM, 0.9975995915885619);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9664211671560008);
    AssertAlmostEqual(&test, rTM, 0.9996618186617163);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7129965481194808);
    AssertAlmostEqual(&test, rTM, 0.9999655274017648);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.07419803094579029);
    AssertAlmostEqual(&test, rTM, 0.9999932984242257);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0008641828943722643);
    AssertAlmostEqual(&test, rTM, 0.999994214225548);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.65663477812569e-06);
    AssertAlmostEqual(&test, rTM, 0.9999942241168213);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.656783156782126e-08);
    AssertAlmostEqual(&test, rTM, 0.9999942242158195);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9870280816349468);
    AssertAlmostEqual(&test, rTM, 0.9870280816349469);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9870280816349404);
    AssertAlmostEqual(&test, rTM, 0.9870280816349533);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9870280816343024);
    AssertAlmostEqual(&test, rTM, 0.9870280816355912);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9870280815705107);
    AssertAlmostEqual(&test, rTM, 0.9870280816993831);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9870280751913316);
    AssertAlmostEqual(&test, rTM, 0.9870280880785589);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9870274372895775);
    AssertAlmostEqual(&test, rTM, 0.9870287259485205);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9869638078556993);
    AssertAlmostEqual(&test, rTM, 0.9870920405767349);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9817044766966182);
    AssertAlmostEqual(&test, rTM, 0.9908098154650541);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8771071899314345);
    AssertAlmostEqual(&test, rTM, 0.9986989009010688);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2930918141990713);
    AssertAlmostEqual(&test, rTM, 0.9998440939761243);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.005797890663230083);
    AssertAlmostEqual(&test, rTM, 0.9999137721186272);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.865028761406876e-05);
    AssertAlmostEqual(&test, rTM, 0.9999147561940076);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.865709969937472e-07);
    AssertAlmostEqual(&test, rTM, 0.9999147660921553);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9186632651800419);
    AssertAlmostEqual(&test, rTM, 0.9186632651800419);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9186632651800415);
    AssertAlmostEqual(&test, rTM, 0.9186632651800423);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.918663265180003);
    AssertAlmostEqual(&test, rTM, 0.9186632651800808);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9186632651761475);
    AssertAlmostEqual(&test, rTM, 0.9186632651839364);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9186632647905986);
    AssertAlmostEqual(&test, rTM, 0.9186632655694853);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9186632262357146);
    AssertAlmostEqual(&test, rTM, 0.9186633041243513);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9186593708520437);
    AssertAlmostEqual(&test, rTM, 0.9186671593294957);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9182748744408945);
    AssertAlmostEqual(&test, rTM, 0.9190498880211048);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8869738426104465);
    AssertAlmostEqual(&test, rTM, 0.9417421540168329);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4365256670646963);
    AssertAlmostEqual(&test, rTM, 0.9908786318580772);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01351210392621213);
    AssertAlmostEqual(&test, rTM, 0.9963141131184352);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001388231387181427);
    AssertAlmostEqual(&test, rTM, 0.9964112225301432);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.388614422957234e-06);
    AssertAlmostEqual(&test, rTM, 0.9964122070691045);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4633154362625276);
    AssertAlmostEqual(&test, rTM, 0.4633154362625276);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4633154362625276);
    AssertAlmostEqual(&test, rTM, 0.4633154362625276);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4633154362625259);
    AssertAlmostEqual(&test, rTM, 0.4633154362625293);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4633154362623577);
    AssertAlmostEqual(&test, rTM, 0.4633154362626975);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4633154362455351);
    AssertAlmostEqual(&test, rTM, 0.4633154362795201);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4633154345632751);
    AssertAlmostEqual(&test, rTM, 0.4633154379617801);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.463315266337356);
    AssertAlmostEqual(&test, rTM, 0.4633156061876652);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4632984445309478);
    AssertAlmostEqual(&test, rTM, 0.4633324276534512);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4616240746686532);
    AssertAlmostEqual(&test, rTM, 0.465003429199369);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3450278815187395);
    AssertAlmostEqual(&test, rTM, 0.567115698987991);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0154384236218611);
    AssertAlmostEqual(&test, rTM, 0.7563412992942141);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001607886777126097);
    AssertAlmostEqual(&test, rTM, 0.7628046613619601);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.608558018739238e-06);
    AssertAlmostEqual(&test, rTM, 0.7628712111132888);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01583112458018305);
    AssertAlmostEqual(&test, rTM, 0.01583112458018305);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01583112458018305);
    AssertAlmostEqual(&test, rTM, 0.01583112458018305);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01583112458018305);
    AssertAlmostEqual(&test, rTM, 0.01583112458018305);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0158311245801829);
    AssertAlmostEqual(&test, rTM, 0.0158311245801832);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01583112458016771);
    AssertAlmostEqual(&test, rTM, 0.01583112458019839);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01583112457864928);
    AssertAlmostEqual(&test, rTM, 0.01583112458171682);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01583112442680618);
    AssertAlmostEqual(&test, rTM, 0.01583112473355992);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01583110924251067);
    AssertAlmostEqual(&test, rTM, 0.01583113991785541);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01582959096007846);
    AssertAlmostEqual(&test, rTM, 0.01583265820021315);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01567921977434143);
    AssertAlmostEqual(&test, rTM, 0.01598302865523641);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.008041362588562749);
    AssertAlmostEqual(&test, rTM, 0.02361896528646359);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001617747037329377);
    AssertAlmostEqual(&test, rTM, 0.03149270237934448);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.634284520550125e-06);
    AssertAlmostEqual(&test, rTM, 0.03165268316606041);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636552253796767);
    AssertAlmostEqual(&test, rTM, 0.0001636552253796767);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636552253796767);
    AssertAlmostEqual(&test, rTM, 0.0001636552253796767);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636552253796767);
    AssertAlmostEqual(&test, rTM, 0.0001636552253796767);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636552253796767);
    AssertAlmostEqual(&test, rTM, 0.0001636552253796767);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636552253796751);
    AssertAlmostEqual(&test, rTM, 0.0001636552253796783);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636552253795131);
    AssertAlmostEqual(&test, rTM, 0.0001636552253798403);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636552253633166);
    AssertAlmostEqual(&test, rTM, 0.0001636552253960369);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636552237436601);
    AssertAlmostEqual(&test, rTM, 0.0001636552270156934);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636550617781722);
    AssertAlmostEqual(&test, rTM, 0.0001636553889811812);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636388668481867);
    AssertAlmostEqual(&test, rTM, 0.0001636715839111667);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001620354016357701);
    AssertAlmostEqual(&test, rTM, 0.0001652750491227245);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.184100475404363e-05);
    AssertAlmostEqual(&test, rTM, 0.0002454694438144355);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.620873998964605e-06);
    AssertAlmostEqual(&test, rTM, 0.0003256895681668103);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637346626894133e-06);
    AssertAlmostEqual(&test, rTM, 1.637346626894133e-06);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637346626894133e-06);
    AssertAlmostEqual(&test, rTM, 1.637346626894133e-06);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637346626894133e-06);
    AssertAlmostEqual(&test, rTM, 1.637346626894133e-06);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637346626894133e-06);
    AssertAlmostEqual(&test, rTM, 1.637346626894133e-06);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637346626894133e-06);
    AssertAlmostEqual(&test, rTM, 1.637346626894133e-06);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637346626894116e-06);
    AssertAlmostEqual(&test, rTM, 1.637346626894149e-06);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637346626892495e-06);
    AssertAlmostEqual(&test, rTM, 1.63734662689577e-06);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637346626730399e-06);
    AssertAlmostEqual(&test, rTM, 1.637346627057867e-06);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.63734661052072e-06);
    AssertAlmostEqual(&test, rTM, 1.637346643267545e-06);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637344989554505e-06);
    AssertAlmostEqual(&test, rTM, 1.637348264233761e-06);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637182909139345e-06);
    AssertAlmostEqual(&test, rTM, 1.63751034464892e-06);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.621135326714114e-06);
    AssertAlmostEqual(&test, rTM, 1.65355792707415e-06);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.186746538996034e-07);
    AssertAlmostEqual(&test, rTM, 2.456018599886468e-06);

    userdata[0] = 5/CAPS_HBAR_EV; /* 5eV */
    userdata[1] = 0.05/CAPS_HBAR_EV; /* 0.05eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999944089763138);
    AssertAlmostEqual(&test, rTM, 0.9999972044842494);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999602689897934);
    AssertAlmostEqual(&test, rTM, 0.9999996066159238);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996047122011446);
    AssertAlmostEqual(&test, rTM, 0.9999999604673584);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960543434229129);
    AssertAlmostEqual(&test, rTM, 0.9999999960465324);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9612391514300914);
    AssertAlmostEqual(&test, rTM, 0.9999999996045766);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6751531272598968);
    AssertAlmostEqual(&test, rTM, 0.9999999999597003);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05690562672060558);
    AssertAlmostEqual(&test, rTM, 0.999999999991242);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006389835998701163);
    AssertAlmostEqual(&test, rTM, 0.999999999992175);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.397927965353697e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999921849);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.398009014413405e-08);
    AssertAlmostEqual(&test, rTM, 0.999999999992185);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.398009824916965e-10);
    AssertAlmostEqual(&test, rTM, 0.999999999992185);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.398009833022002e-12);
    AssertAlmostEqual(&test, rTM, 0.999999999992185);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.398009833103054e-14);
    AssertAlmostEqual(&test, rTM, 0.999999999992185);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999874357785234);
    AssertAlmostEqual(&test, rTM, 0.9999875601759821);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999823197344626);
    AssertAlmostEqual(&test, rTM, 0.9999911598281568);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998743648887632);
    AssertAlmostEqual(&test, rTM, 0.999998756010632);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9987505242015764);
    AssertAlmostEqual(&test, rTM, 0.9999998749867721);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9875759527295493);
    AssertAlmostEqual(&test, rTM, 0.9999999874978159);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8825514540787289);
    AssertAlmostEqual(&test, rTM, 0.9999999987473652);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3071397561456581);
    AssertAlmostEqual(&test, rTM, 0.9999999998525646);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.00631742505980486);
    AssertAlmostEqual(&test, rTM, 0.999999999920857);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.397189024010276e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999218406);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.397999396217727e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999218506);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.398007501235839e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999999218506);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.39800758228615e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999999218506);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.398007583096653e-13);
    AssertAlmostEqual(&test, rTM, 0.9999999999218506);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998749858726514);
    AssertAlmostEqual(&test, rTM, 0.9998749859976576);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998749796849983);
    AssertAlmostEqual(&test, rTM, 0.9998749921849983);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998743624589121);
    AssertAlmostEqual(&test, rTM, 0.9998756063175888);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998232079917215);
    AssertAlmostEqual(&test, rTM, 0.9999116000884158);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9987443347485403);
    AssertAlmostEqual(&test, rTM, 0.9999875599329692);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.987575102786905);
    AssertAlmostEqual(&test, rTM, 0.9999987498200664);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8825492696335979);
    AssertAlmostEqual(&test, rTM, 0.9999998747341602);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3071334568634237);
    AssertAlmostEqual(&test, rTM, 0.9999999852560996);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.006317183754196735);
    AssertAlmostEqual(&test, rTM, 0.9999999920853966);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.396941597092605e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999921837649);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.397751906618331e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999921847549);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.397760011009475e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999921847648);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.397760092053516e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999921847649);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996046547639008);
    AssertAlmostEqual(&test, rTM, 0.9996046547678534);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996046545682437);
    AssertAlmostEqual(&test, rTM, 0.9996046549635105);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996046350030179);
    AssertAlmostEqual(&test, rTM, 0.9996046745277487);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996026833487601);
    AssertAlmostEqual(&test, rTM, 0.9996066164030847);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994409431938411);
    AssertAlmostEqual(&test, rTM, 0.9997204325124687);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.996033932268315);
    AssertAlmostEqual(&test, rTM, 0.9999606545984051);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9612298299020831);
    AssertAlmostEqual(&test, rTM, 0.9999960451987929);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6751018496294654);
    AssertAlmostEqual(&test, rTM, 0.9999995969224365);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05688579387486727);
    AssertAlmostEqual(&test, rTM, 0.9999999123890302);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006387343602869818);
    AssertAlmostEqual(&test, rTM, 0.9999999217202349);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.395429255766654e-06);
    AssertAlmostEqual(&test, rTM, 0.999999921819171);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.395510241537369e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999218201611);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.395511051408024e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999218201709);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9987481497637996);
    AssertAlmostEqual(&test, rTM, 0.9987481497639247);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9987481497576067);
    AssertAlmostEqual(&test, rTM, 0.9987481497701174);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9987481491383291);
    AssertAlmostEqual(&test, rTM, 0.9987481503893947);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9987480872121187);
    AssertAlmostEqual(&test, rTM, 0.998748212312482);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9987419100130764);
    AssertAlmostEqual(&test, rTM, 0.9987543585866331);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9982300756473217);
    AssertAlmostEqual(&test, rTM, 0.9991146457241442);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9874901685347249);
    AssertAlmostEqual(&test, rTM, 0.9998753635523809);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.88233105036032);
    AssertAlmostEqual(&test, rTM, 0.9999874498186433);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3065049652330585);
    AssertAlmostEqual(&test, rTM, 0.9999985219606891);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.006293145935388488);
    AssertAlmostEqual(&test, rTM, 0.999999205516917);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.372295188316124e-05);
    AssertAlmostEqual(&test, rTM, 0.9999992153539803);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.373099266212686e-07);
    AssertAlmostEqual(&test, rTM, 0.9999992154529738);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.373107308272618e-09);
    AssertAlmostEqual(&test, rTM, 0.9999992154539638);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9959781504529441);
    AssertAlmostEqual(&test, rTM, 0.9959781504529481);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9959781504527454);
    AssertAlmostEqual(&test, rTM, 0.9959781504531469);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9959781504328774);
    AssertAlmostEqual(&test, rTM, 0.9959781504730149);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9959781484460738);
    AssertAlmostEqual(&test, rTM, 0.9959781524598175);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9959779497707026);
    AssertAlmostEqual(&test, rTM, 0.9959783511251967);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9959581318487825);
    AssertAlmostEqual(&test, rTM, 0.9959980701075651);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9943169910138882);
    AssertAlmostEqual(&test, rTM, 0.9971544411523519);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9603112330979782);
    AssertAlmostEqual(&test, rTM, 0.9995990036599511);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6700938301056443);
    AssertAlmostEqual(&test, rTM, 0.9999588933980421);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05498850575194266);
    AssertAlmostEqual(&test, rTM, 0.9999909347718501);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006149840240546782);
    AssertAlmostEqual(&test, rTM, 0.9999918697767141);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.157335565672549e-06);
    AssertAlmostEqual(&test, rTM, 0.9999918796704441);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.157410634270816e-08);
    AssertAlmostEqual(&test, rTM, 0.9999918797694424);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9853647536094037);
    AssertAlmostEqual(&test, rTM, 0.9853647536094039);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9853647536093966);
    AssertAlmostEqual(&test, rTM, 0.985364753609411);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9853647536086774);
    AssertAlmostEqual(&test, rTM, 0.9853647536101301);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.985364753536767);
    AssertAlmostEqual(&test, rTM, 0.9853647536820406);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9853647463457248);
    AssertAlmostEqual(&test, rTM, 0.9853647608730792);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9853640272597451);
    AssertAlmostEqual(&test, rTM, 0.9853654799232811);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9852923001642376);
    AssertAlmostEqual(&test, rTM, 0.9854368527507725);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9793657362545369);
    AssertAlmostEqual(&test, rTM, 0.9896288099339652);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8624005418112569);
    AssertAlmostEqual(&test, rTM, 0.9985301042924382);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2551833284189762);
    AssertAlmostEqual(&test, rTM, 0.9998168666407895);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.004558562807060166);
    AssertAlmostEqual(&test, rTM, 0.99989033067081);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.599991048427855e-05);
    AssertAlmostEqual(&test, rTM, 0.9998913159505847);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.600410088769772e-07);
    AssertAlmostEqual(&test, rTM, 0.9998913258485108);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9161709765580209);
    AssertAlmostEqual(&test, rTM, 0.9161709765580209);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9161709765580205);
    AssertAlmostEqual(&test, rTM, 0.9161709765580213);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9161709765579809);
    AssertAlmostEqual(&test, rTM, 0.916170976558061);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9161709765540128);
    AssertAlmostEqual(&test, rTM, 0.9161709765620289);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9161709761572127);
    AssertAlmostEqual(&test, rTM, 0.9161709769588292);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9161709364772044);
    AssertAlmostEqual(&test, rTM, 0.9161710166388191);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9161669685844319);
    AssertAlmostEqual(&test, rTM, 0.9161749843483752);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9157712544606512);
    AssertAlmostEqual(&test, rTM, 0.9165688843164358);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8835758543639037);
    AssertAlmostEqual(&test, rTM, 0.9399315052149816);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4257159219921694);
    AssertAlmostEqual(&test, rTM, 0.9905420312521959);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01270681100399399);
    AssertAlmostEqual(&test, rTM, 0.9960813531566147);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001303389035243446);
    AssertAlmostEqual(&test, rTM, 0.9961785086163738);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.303726757555248e-06);
    AssertAlmostEqual(&test, rTM, 0.9961794928190915);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4620382716057926);
    AssertAlmostEqual(&test, rTM, 0.4620382716057926);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4620382716057925);
    AssertAlmostEqual(&test, rTM, 0.4620382716057926);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4620382716057909);
    AssertAlmostEqual(&test, rTM, 0.4620382716057942);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4620382716056226);
    AssertAlmostEqual(&test, rTM, 0.4620382716059626);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4620382715887917);
    AssertAlmostEqual(&test, rTM, 0.4620382716227934);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4620382699057077);
    AssertAlmostEqual(&test, rTM, 0.4620382733058774);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4620381015973901);
    AssertAlmostEqual(&test, rTM, 0.4620384416141611);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4620212715528882);
    AssertAlmostEqual(&test, rTM, 0.4620552713191579);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.460346095331329);
    AssertAlmostEqual(&test, rTM, 0.4637270902996011);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.34376589530848);
    AssertAlmostEqual(&test, rTM, 0.5658809561332179);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01532634006817997);
    AssertAlmostEqual(&test, rTM, 0.7549952245577721);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001595853930688824);
    AssertAlmostEqual(&test, rTM, 0.7614428444528057);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.596516344673343e-06);
    AssertAlmostEqual(&test, rTM, 0.7615092241508762);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01581937868013318);
    AssertAlmostEqual(&test, rTM, 0.01581937868013318);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01581937868013318);
    AssertAlmostEqual(&test, rTM, 0.01581937868013318);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01581937868013318);
    AssertAlmostEqual(&test, rTM, 0.01581937868013318);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01581937868013303);
    AssertAlmostEqual(&test, rTM, 0.01581937868013334);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01581937868011786);
    AssertAlmostEqual(&test, rTM, 0.01581937868014851);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01581937867860051);
    AssertAlmostEqual(&test, rTM, 0.01581937868166585);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01581937852686651);
    AssertAlmostEqual(&test, rTM, 0.01581937883339986);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01581936335348046);
    AssertAlmostEqual(&test, rTM, 0.0158193940067859);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01581784616189099);
    AssertAlmostEqual(&test, rTM, 0.01582091119830105);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01566758304692755);
    AssertAlmostEqual(&test, rTM, 0.0159711735841423);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.008035302677105656);
    AssertAlmostEqual(&test, rTM, 0.02360153762504272);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001616508564900044);
    AssertAlmostEqual(&test, rTM, 0.03146935170652476);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.633032987316146e-06);
    AssertAlmostEqual(&test, rTM, 0.03162921025621034);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636426678916148);
    AssertAlmostEqual(&test, rTM, 0.0001636426678916148);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636426678916148);
    AssertAlmostEqual(&test, rTM, 0.0001636426678916148);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636426678916148);
    AssertAlmostEqual(&test, rTM, 0.0001636426678916148);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636426678916148);
    AssertAlmostEqual(&test, rTM, 0.0001636426678916149);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636426678916132);
    AssertAlmostEqual(&test, rTM, 0.0001636426678916165);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636426678914513);
    AssertAlmostEqual(&test, rTM, 0.0001636426678917785);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636426678752559);
    AssertAlmostEqual(&test, rTM, 0.0001636426679079738);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636426662557237);
    AssertAlmostEqual(&test, rTM, 0.000163642669527506);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636425043026596);
    AssertAlmostEqual(&test, rTM, 0.0001636428314805701);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636263106149264);
    AssertAlmostEqual(&test, rTM, 0.0001636590251683032);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001620229683987114);
    AssertAlmostEqual(&test, rTM, 0.0001652623673836597);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.183472395486691e-05);
    AssertAlmostEqual(&test, rTM, 0.0002454506096379927);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.620749586789339e-06);
    AssertAlmostEqual(&test, rTM, 0.0003256645776048399);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.63733405634473e-06);
    AssertAlmostEqual(&test, rTM, 1.63733405634473e-06);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.63733405634473e-06);
    AssertAlmostEqual(&test, rTM, 1.63733405634473e-06);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.63733405634473e-06);
    AssertAlmostEqual(&test, rTM, 1.63733405634473e-06);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.63733405634473e-06);
    AssertAlmostEqual(&test, rTM, 1.63733405634473e-06);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.63733405634473e-06);
    AssertAlmostEqual(&test, rTM, 1.63733405634473e-06);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637334056344714e-06);
    AssertAlmostEqual(&test, rTM, 1.637334056344747e-06);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637334056343093e-06);
    AssertAlmostEqual(&test, rTM, 1.637334056346368e-06);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637334056180997e-06);
    AssertAlmostEqual(&test, rTM, 1.637334056508463e-06);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637334039971444e-06);
    AssertAlmostEqual(&test, rTM, 1.637334072718017e-06);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637332419017673e-06);
    AssertAlmostEqual(&test, rTM, 1.637335693671788e-06);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637170339846864e-06);
    AssertAlmostEqual(&test, rTM, 1.637497772842597e-06);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.62112288062479e-06);
    AssertAlmostEqual(&test, rTM, 1.65354523206467e-06);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.186683686043198e-07);
    AssertAlmostEqual(&test, rTM, 2.455999744082946e-06);

    userdata[0] = 5/CAPS_HBAR_EV; /* 5eV */
    userdata[1] = 0.1/CAPS_HBAR_EV; /* 0.1eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999920931077083);
    AssertAlmostEqual(&test, rTM, 0.9999960465460392);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999438123294226);
    AssertAlmostEqual(&test, rTM, 0.9999994436709548);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994410244117307);
    AssertAlmostEqual(&test, rTM, 0.9999999440924021);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.994424565971825);
    AssertAlmostEqual(&test, rTM, 0.9999999944089417);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9456307505981341);
    AssertAlmostEqual(&test, rTM, 0.9999999994406776);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5757588059142211);
    AssertAlmostEqual(&test, rTM, 0.999999999941946);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03009362753806534);
    AssertAlmostEqual(&test, rTM, 0.9999999999834003);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003196959887888048);
    AssertAlmostEqual(&test, rTM, 0.9999999999843602);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.198984511949906e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999843701);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.199004774379291e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999843702);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.199004977005206e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999999843702);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.199004979031465e-12);
    AssertAlmostEqual(&test, rTM, 0.9999999999843702);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.199004979051728e-14);
    AssertAlmostEqual(&test, rTM, 0.9999999999843702);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999822315555592);
    AssertAlmostEqual(&test, rTM, 0.9999824074792042);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999749964226897);
    AssertAlmostEqual(&test, rTM, 0.9999874981331961);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998223297624431);
    AssertAlmostEqual(&test, rTM, 0.9999982407339861);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9982334320408995);
    AssertAlmostEqual(&test, rTM, 0.999999823204585);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9824751789915568);
    AssertAlmostEqual(&test, rTM, 0.9999999823188981);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8381361490903603);
    AssertAlmostEqual(&test, rTM, 0.9999999982250629);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2031348715602632);
    AssertAlmostEqual(&test, rTM, 0.9999999997640149);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0031786993929112);
    AssertAlmostEqual(&test, rTM, 0.9999999998427046);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.198799760334126e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999998436914);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.199002369827839e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999998437012);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.199004396084795e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999998437014);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.199004416347381e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999998437014);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.199004416550007e-13);
    AssertAlmostEqual(&test, rTM, 0.9999999998437014);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998232096301439);
    AssertAlmostEqual(&test, rTM, 0.9998232098069184);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998232008800195);
    AssertAlmostEqual(&test, rTM, 0.9998232185566011);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998223280443599);
    AssertAlmostEqual(&test, rTM, 0.999824087017893);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997499899412128);
    AssertAlmostEqual(&test, rTM, 0.9998749871560124);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9982247005313509);
    AssertAlmostEqual(&test, rTM, 0.9999824073022634);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9824741512126053);
    AssertAlmostEqual(&test, rTM, 0.999998231961774);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8381346484951977);
    AssertAlmostEqual(&test, rTM, 0.9999998225046625);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2031322679760764);
    AssertAlmostEqual(&test, rTM, 0.9999999764011581);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.003178638301164128);
    AssertAlmostEqual(&test, rTM, 0.999999984270153);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.198737894468249e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999843688352);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.198940496127917e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999843698252);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.198942522306523e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999843698351);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.198942542568326e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999843698352);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994409977694896);
    AssertAlmostEqual(&test, rTM, 0.999440997775078);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994409974928609);
    AssertAlmostEqual(&test, rTM, 0.9994409980517066);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994409698306856);
    AssertAlmostEqual(&test, rTM, 0.9994410257124858);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994382104973227);
    AssertAlmostEqual(&test, rTM, 0.9994437712222438);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9992095430127482);
    AssertAlmostEqual(&test, rTM, 0.9996046933572629);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9943962933315276);
    AssertAlmostEqual(&test, rTM, 0.9999443629787551);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9456229462423504);
    AssertAlmostEqual(&test, rTM, 0.9999944065252875);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5757283712402943);
    AssertAlmostEqual(&test, rTM, 0.9999994193998758);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03008809286991775);
    AssertAlmostEqual(&test, rTM, 0.9999998339717742);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003196335870632259);
    AssertAlmostEqual(&test, rTM, 0.9999998435709228);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.198359704525407e-06);
    AssertAlmostEqual(&test, rTM, 0.9999998436698908);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.198379959043629e-08);
    AssertAlmostEqual(&test, rTM, 0.9999998436708808);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.198380161590431e-10);
    AssertAlmostEqual(&test, rTM, 0.9999998436708907);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9982317972109481);
    AssertAlmostEqual(&test, rTM, 0.9982317972111248);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9982317972022032);
    AssertAlmostEqual(&test, rTM, 0.9982317972198697);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9982317963277176);
    AssertAlmostEqual(&test, rTM, 0.9982317980943548);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9982317088813418);
    AssertAlmostEqual(&test, rTM, 0.9982318855363228);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9982229860325127);
    AssertAlmostEqual(&test, rTM, 0.9982405647385202);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9975003000197139);
    AssertAlmostEqual(&test, rTM, 0.9987493674802912);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9823715170732175);
    AssertAlmostEqual(&test, rTM, 0.9998239101685278);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8379846658306589);
    AssertAlmostEqual(&test, rTM, 0.9999822342186713);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2028722603539166);
    AssertAlmostEqual(&test, rTM, 0.9999976368380731);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.003172540962465482);
    AssertAlmostEqual(&test, rTM, 0.9999984239945744);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.192563369270603e-05);
    AssertAlmostEqual(&test, rTM, 0.9999984338628288);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.192765189815574e-07);
    AssertAlmostEqual(&test, rTM, 0.9999984339618254);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.192767208182098e-09);
    AssertAlmostEqual(&test, rTM, 0.9999984339628154);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9943705207471512);
    AssertAlmostEqual(&test, rTM, 0.9943705207471567);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9943705207468733);
    AssertAlmostEqual(&test, rTM, 0.9943705207474346);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.994370520719086);
    AssertAlmostEqual(&test, rTM, 0.9943705207752219);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9943705179403601);
    AssertAlmostEqual(&test, rTM, 0.9943705235539464);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9943702400747598);
    AssertAlmostEqual(&test, rTM, 0.9943708014055945);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9943425230180266);
    AssertAlmostEqual(&test, rTM, 0.9943983803102521);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9920480169247347);
    AssertAlmostEqual(&test, rTM, 0.9960160567843067);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.944851146695737);
    AssertAlmostEqual(&test, rTM, 0.9994381988561888);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5727383249920092);
    AssertAlmostEqual(&test, rTM, 0.9999413450669437);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02955001308927253);
    AssertAlmostEqual(&test, rTM, 0.9999830946032282);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000313573520100568);
    AssertAlmostEqual(&test, rTM, 0.9999840550319525);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.137683034298701e-06);
    AssertAlmostEqual(&test, rTM, 0.9999840649285805);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.137702527908101e-08);
    AssertAlmostEqual(&test, rTM, 0.9999840650275778);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9808553781516135);
    AssertAlmostEqual(&test, rTM, 0.9808553781516137);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9808553781516042);
    AssertAlmostEqual(&test, rTM, 0.9808553781516232);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9808553781506657);
    AssertAlmostEqual(&test, rTM, 0.9808553781525616);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9808553780568157);
    AssertAlmostEqual(&test, rTM, 0.9808553782464116);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9808553686718199);
    AssertAlmostEqual(&test, rTM, 0.9808553876314028);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9808544301961514);
    AssertAlmostEqual(&test, rTM, 0.9808563260605933);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9807608205869989);
    AssertAlmostEqual(&test, rTM, 0.9809494754502798);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9730335848255232);
    AssertAlmostEqual(&test, rTM, 0.9864240176165878);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8236863541185836);
    AssertAlmostEqual(&test, rTM, 0.9980695308463223);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1799490728872989);
    AssertAlmostEqual(&test, rTM, 0.9997312291806322);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002661924646748859);
    AssertAlmostEqual(&test, rTM, 0.9998122026823415);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.676012542624733e-05);
    AssertAlmostEqual(&test, rTM, 0.9998131897425551);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.676154363369348e-07);
    AssertAlmostEqual(&test, rTM, 0.9998131996395135);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9084158202138395);
    AssertAlmostEqual(&test, rTM, 0.9084158202138395);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.908415820213839);
    AssertAlmostEqual(&test, rTM, 0.9084158202138399);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9084158202137959);
    AssertAlmostEqual(&test, rTM, 0.9084158202138831);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9084158202094801);
    AssertAlmostEqual(&test, rTM, 0.908415820218199);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9084158197778941);
    AssertAlmostEqual(&test, rTM, 0.9084158206497849);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9084157766193073);
    AssertAlmostEqual(&test, rTM, 0.9084158638083519);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9084114608791127);
    AssertAlmostEqual(&test, rTM, 0.9084201793510323);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9079810657884386);
    AssertAlmostEqual(&test, rTM, 0.9088486187197226);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8730282072422574);
    AssertAlmostEqual(&test, rTM, 0.934286767451738);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3939098523036104);
    AssertAlmostEqual(&test, rTM, 0.989462728379661);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01060091494183379);
    AssertAlmostEqual(&test, rTM, 0.9953063287574211);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001082802570067692);
    AssertAlmostEqual(&test, rTM, 0.9954035800333161);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.083035826710371e-06);
    AssertAlmostEqual(&test, rTM, 0.9954045631105491);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4578448100554646);
    AssertAlmostEqual(&test, rTM, 0.4578448100554646);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4578448100554646);
    AssertAlmostEqual(&test, rTM, 0.4578448100554646);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4578448100554629);
    AssertAlmostEqual(&test, rTM, 0.4578448100554663);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4578448100552943);
    AssertAlmostEqual(&test, rTM, 0.4578448100556349);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4578448100384379);
    AssertAlmostEqual(&test, rTM, 0.4578448100724913);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4578448083527941);
    AssertAlmostEqual(&test, rTM, 0.4578448117581351);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4578446397884914);
    AssertAlmostEqual(&test, rTM, 0.4578449803224042);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4578277841512294);
    AssertAlmostEqual(&test, rTM, 0.4578618356238654);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4561501056131735);
    AssertAlmostEqual(&test, rTM, 0.4595361936462414);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3396337341790006);
    AssertAlmostEqual(&test, rTM, 0.5618166329803777);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01496420695965761);
    AssertAlmostEqual(&test, rTM, 0.7505427726368086);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001557013500294668);
    AssertAlmostEqual(&test, rTM, 0.7569383646269029);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.557647811415583e-06);
    AssertAlmostEqual(&test, rTM, 0.7570041831386807);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01578035128211975);
    AssertAlmostEqual(&test, rTM, 0.01578035128211975);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01578035128211975);
    AssertAlmostEqual(&test, rTM, 0.01578035128211975);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01578035128211975);
    AssertAlmostEqual(&test, rTM, 0.01578035128211975);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01578035128211959);
    AssertAlmostEqual(&test, rTM, 0.0157803512821199);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01578035128210446);
    AssertAlmostEqual(&test, rTM, 0.01578035128213504);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01578035128059074);
    AssertAlmostEqual(&test, rTM, 0.01578035128364875);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01578035112921925);
    AssertAlmostEqual(&test, rTM, 0.01578035143502024);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01578033599208512);
    AssertAlmostEqual(&test, rTM, 0.01578036657215436);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01577882242534768);
    AssertAlmostEqual(&test, rTM, 0.01578188013881802);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01562891842739411);
    AssertAlmostEqual(&test, rTM, 0.0159317834129214);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.008015168774702205);
    AssertAlmostEqual(&test, rTM, 0.02354363073291289);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001612393983638353);
    AssertAlmostEqual(&test, rTM, 0.03139176560008818);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.628875018504672e-06);
    AssertAlmostEqual(&test, rTM, 0.03155121803748137);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636008235125066);
    AssertAlmostEqual(&test, rTM, 0.0001636008235125066);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636008235125066);
    AssertAlmostEqual(&test, rTM, 0.0001636008235125066);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636008235125066);
    AssertAlmostEqual(&test, rTM, 0.0001636008235125066);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636008235125066);
    AssertAlmostEqual(&test, rTM, 0.0001636008235125066);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000163600823512505);
    AssertAlmostEqual(&test, rTM, 0.0001636008235125082);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000163600823512343);
    AssertAlmostEqual(&test, rTM, 0.0001636008235126701);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636008234961518);
    AssertAlmostEqual(&test, rTM, 0.0001636008235288613);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636008218770336);
    AssertAlmostEqual(&test, rTM, 0.0001636008251479796);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636006599653683);
    AssertAlmostEqual(&test, rTM, 0.0001636009870596449);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001635844704171002);
    AssertAlmostEqual(&test, rTM, 0.0001636171766079129);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001619815380519809);
    AssertAlmostEqual(&test, rTM, 0.0001652201089721743);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.181379491824241e-05);
    AssertAlmostEqual(&test, rTM, 0.0002453878499180803);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.620335017439084e-06);
    AssertAlmostEqual(&test, rTM, 0.0003255813034225627);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637292155907372e-06);
    AssertAlmostEqual(&test, rTM, 1.637292155907372e-06);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637292155907372e-06);
    AssertAlmostEqual(&test, rTM, 1.637292155907372e-06);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637292155907372e-06);
    AssertAlmostEqual(&test, rTM, 1.637292155907372e-06);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637292155907372e-06);
    AssertAlmostEqual(&test, rTM, 1.637292155907372e-06);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637292155907372e-06);
    AssertAlmostEqual(&test, rTM, 1.637292155907372e-06);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637292155907355e-06);
    AssertAlmostEqual(&test, rTM, 1.637292155907388e-06);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637292155905734e-06);
    AssertAlmostEqual(&test, rTM, 1.637292155909009e-06);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637292155743643e-06);
    AssertAlmostEqual(&test, rTM, 1.6372921560711e-06);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637292139534504e-06);
    AssertAlmostEqual(&test, rTM, 1.63729217228024e-06);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637290518622215e-06);
    AssertAlmostEqual(&test, rTM, 1.637293793192529e-06);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637128443599102e-06);
    AssertAlmostEqual(&test, rTM, 1.637455868215641e-06);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.621081395040557e-06);
    AssertAlmostEqual(&test, rTM, 1.653502916774186e-06);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.186474183170363e-07);
    AssertAlmostEqual(&test, rTM, 2.455936893495513e-06);

    userdata[0] = 5/CAPS_HBAR_EV; /* 5eV */
    userdata[1] = 0.5/CAPS_HBAR_EV; /* 0.5eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999823197378822);
    AssertAlmostEqual(&test, rTM, 0.9999911598298666);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999874364913062);
    AssertAlmostEqual(&test, rTM, 0.9999987560108726);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9987505244430983);
    AssertAlmostEqual(&test, rTM, 0.9999998749867963);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9875759551175807);
    AssertAlmostEqual(&test, rTM, 0.9999999874978184);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8825514753783062);
    AssertAlmostEqual(&test, rTM, 0.9999999987473654);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3071398191238033);
    AssertAlmostEqual(&test, rTM, 0.9999999998525647);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.006317427472947864);
    AssertAlmostEqual(&test, rTM, 0.999999999920857);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.397191498376049e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999218407);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.398001871210417e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999218506);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.398009976234799e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999999218507);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.398010057285172e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999999218507);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.398010058095676e-13);
    AssertAlmostEqual(&test, rTM, 0.9999999999218507);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.39801005810378e-15);
    AssertAlmostEqual(&test, rTM, 0.9999999999218507);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999602689897934);
    AssertAlmostEqual(&test, rTM, 0.9999606623583946);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999440911698029);
    AssertAlmostEqual(&test, rTM, 0.9999720451941604);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996027609278868);
    AssertAlmostEqual(&test, rTM, 0.9999960661661261);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960541485040252);
    AssertAlmostEqual(&test, rTM, 0.9999996046728903);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9612391326226702);
    AssertAlmostEqual(&test, rTM, 0.9999999604576791);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6751531259637278);
    AssertAlmostEqual(&test, rTM, 0.9999999959700383);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05690562671557858);
    AssertAlmostEqual(&test, rTM, 0.9999999991241976);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006389835998694846);
    AssertAlmostEqual(&test, rTM, 0.9999999992175076);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.397927965353634e-06);
    AssertAlmostEqual(&test, rTM, 0.999999999218497);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.398009014413407e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999992185069);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.398009824916966e-10);
    AssertAlmostEqual(&test, rTM, 0.999999999218507);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.398009833022003e-12);
    AssertAlmostEqual(&test, rTM, 0.999999999218507);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.398009833103054e-14);
    AssertAlmostEqual(&test, rTM, 0.999999999218507);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996047309981767);
    AssertAlmostEqual(&test, rTM, 0.9996047313933673);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996047114367327);
    AssertAlmostEqual(&test, rTM, 0.9996047509538238);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996027601597024);
    AssertAlmostEqual(&test, rTM, 0.9996066924538218);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994410512643325);
    AssertAlmostEqual(&test, rTM, 0.9997204865628267);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960346976342261);
    AssertAlmostEqual(&test, rTM, 0.9999606622062164);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9612371784366253);
    AssertAlmostEqual(&test, rTM, 0.999996045963801);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6751524898739187);
    AssertAlmostEqual(&test, rTM, 0.9999995970033078);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05690542978509585);
    AssertAlmostEqual(&test, rTM, 0.9999999124194577);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006389811311349057);
    AssertAlmostEqual(&test, rTM, 0.9999999217504661);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.39790321607836e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999218494022);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.397984264517354e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999218503922);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.397985075014705e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999218504021);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.39798508311968e-12);
    AssertAlmostEqual(&test, rTM, 0.9999999218504022);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9987505624746454);
    AssertAlmostEqual(&test, rTM, 0.998750562487132);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9987505618565606);
    AssertAlmostEqual(&test, rTM, 0.9987505631052165);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9987505000496273);
    AssertAlmostEqual(&test, rTM, 0.9987506249090329);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9987443347485403);
    AssertAlmostEqual(&test, rTM, 0.998756759344719);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9982334859755667);
    AssertAlmostEqual(&test, rTM, 0.9991163523988229);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9875141425133815);
    AssertAlmostEqual(&test, rTM, 0.9998756039114124);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8825438186991502);
    AssertAlmostEqual(&test, rTM, 0.9999874741161364);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3071332956906329);
    AssertAlmostEqual(&test, rTM, 0.9999985256121298);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.006317183692441812);
    AssertAlmostEqual(&test, rTM, 0.9999992085402725);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.39694159645939e-05);
    AssertAlmostEqual(&test, rTM, 0.9999992183770954);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.397751906611997e-07);
    AssertAlmostEqual(&test, rTM, 0.9999992184760889);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.397760011009413e-09);
    AssertAlmostEqual(&test, rTM, 0.9999992184770788);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.397760092053516e-11);
    AssertAlmostEqual(&test, rTM, 0.9999992184770888);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960535761924916);
    AssertAlmostEqual(&test, rTM, 0.9960535761928855);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960535761729955);
    AssertAlmostEqual(&test, rTM, 0.9960535762123817);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960535742233784);
    AssertAlmostEqual(&test, rTM, 0.9960535781619977);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.996053379266567);
    AssertAlmostEqual(&test, rTM, 0.9960537731090034);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.996033932268315);
    AssertAlmostEqual(&test, rTM, 0.9960731230121647);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9944234826677719);
    AssertAlmostEqual(&test, rTM, 0.9972078378146594);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9610422118542363);
    AssertAlmostEqual(&test, rTM, 0.9996065403006116);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6750888869507597);
    AssertAlmostEqual(&test, rTM, 0.9999596951237841);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05688574362037901);
    AssertAlmostEqual(&test, rTM, 0.9999912389758019);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006387343539715846);
    AssertAlmostEqual(&test, rTM, 0.9999921720841154);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.395429255133516e-06);
    AssertAlmostEqual(&test, rTM, 0.9999921819776125);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.395510241531037e-08);
    AssertAlmostEqual(&test, rTM, 0.9999921820766107);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.395511051407961e-10);
    AssertAlmostEqual(&test, rTM, 0.9999921820776007);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9875518636081027);
    AssertAlmostEqual(&test, rTM, 0.987551863608115);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9875518636074903);
    AssertAlmostEqual(&test, rTM, 0.9875518636087273);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9875518635462579);
    AssertAlmostEqual(&test, rTM, 0.9875518636699596);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9875518574230238);
    AssertAlmostEqual(&test, rTM, 0.9875518697931908);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9875512451151104);
    AssertAlmostEqual(&test, rTM, 0.987552482070571);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9874901685347249);
    AssertAlmostEqual(&test, rTM, 0.987613256314511);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9824412869221097);
    AssertAlmostEqual(&test, rTM, 0.9911815906222422);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8817865725729889);
    AssertAlmostEqual(&test, rTM, 0.9987519436584166);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3064888595414605);
    AssertAlmostEqual(&test, rTM, 0.9998522178743084);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.006293139783104993);
    AssertAlmostEqual(&test, rTM, 0.9999205579020318);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.372295125238441e-05);
    AssertAlmostEqual(&test, rTM, 0.9999215414922896);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.373099265581749e-07);
    AssertAlmostEqual(&test, rTM, 0.9999215513904876);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.373107308266308e-09);
    AssertAlmostEqual(&test, rTM, 0.9999215514894758);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9605042326456098);
    AssertAlmostEqual(&test, rTM, 0.9605042326456101);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9605042326455906);
    AssertAlmostEqual(&test, rTM, 0.9605042326456293);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9605042326436749);
    AssertAlmostEqual(&test, rTM, 0.9605042326475449);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9605042324521095);
    AssertAlmostEqual(&test, rTM, 0.9605042328391105);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9605042132955667);
    AssertAlmostEqual(&test, rTM, 0.960504251995644);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9605022976911151);
    AssertAlmostEqual(&test, rTM, 0.9605061675072228);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9603112330979782);
    AssertAlmostEqual(&test, rTM, 0.9606963124872446);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9446086597190031);
    AssertAlmostEqual(&test, rTM, 0.9719041812097186);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.668788137961844);
    AssertAlmostEqual(&test, rTM, 0.9959186512945736);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05498362982248932);
    AssertAlmostEqual(&test, rTM, 0.9990942565458572);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006149834159694882);
    AssertAlmostEqual(&test, rTM, 0.9991876311398035);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.157335504715678e-06);
    AssertAlmostEqual(&test, rTM, 0.9991886193195738);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.157410633661233e-08);
    AssertAlmostEqual(&test, rTM, 0.9991886292074665);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8630332091391438);
    AssertAlmostEqual(&test, rTM, 0.8630332091391438);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8630332091391432);
    AssertAlmostEqual(&test, rTM, 0.8630332091391445);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8630332091390803);
    AssertAlmostEqual(&test, rTM, 0.8630332091392072);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8630332091327989);
    AssertAlmostEqual(&test, rTM, 0.8630332091454886);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8630332085046576);
    AssertAlmostEqual(&test, rTM, 0.8630332097736301);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8630331456905406);
    AssertAlmostEqual(&test, rTM, 0.8630332725877199);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8630268644597795);
    AssertAlmostEqual(&test, rTM, 0.863039553546224);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8624005418112569);
    AssertAlmostEqual(&test, rTM, 0.8636631804798289);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8121021330188377);
    AssertAlmostEqual(&test, rTM, 0.9009139215176678);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.253693736891787);
    AssertAlmostEqual(&test, rTM, 0.9820043170162391);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.00455811564952388);
    AssertAlmostEqual(&test, rTM, 0.9891503399043429);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.599986494860218e-05);
    AssertAlmostEqual(&test, rTM, 0.9892472859397984);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.600410043225755e-07);
    AssertAlmostEqual(&test, rTM, 0.9892482599839745);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4274220624179886);
    AssertAlmostEqual(&test, rTM, 0.4274220624179886);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4274220624179886);
    AssertAlmostEqual(&test, rTM, 0.4274220624179886);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4274220624179869);
    AssertAlmostEqual(&test, rTM, 0.4274220624179903);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4274220624178171);
    AssertAlmostEqual(&test, rTM, 0.4274220624181601);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4274220624008435);
    AssertAlmostEqual(&test, rTM, 0.4274220624351336);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4274220607034821);
    AssertAlmostEqual(&test, rTM, 0.4274220641324951);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4274218909674209);
    AssertAlmostEqual(&test, rTM, 0.4274222338685255);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4274049181942227);
    AssertAlmostEqual(&test, rTM, 0.4274392063343375);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4257159219921694);
    AssertAlmostEqual(&test, rTM, 0.4291251636726528);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3101858256185666);
    AssertAlmostEqual(&test, rTM, 0.5318529676426298);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01258535500302405);
    AssertAlmostEqual(&test, rTM, 0.7167311749057601);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001303260046256839);
    AssertAlmostEqual(&test, rTM, 0.7227344302955884);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.303725466870415e-06);
    AssertAlmostEqual(&test, rTM, 0.7227960526788144);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01547493193213813);
    AssertAlmostEqual(&test, rTM, 0.01547493193213813);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01547493193213813);
    AssertAlmostEqual(&test, rTM, 0.01547493193213813);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01547493193213813);
    AssertAlmostEqual(&test, rTM, 0.01547493193213813);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01547493193213798);
    AssertAlmostEqual(&test, rTM, 0.01547493193213828);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01547493193212312);
    AssertAlmostEqual(&test, rTM, 0.01547493193215313);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0154749319306378);
    AssertAlmostEqual(&test, rTM, 0.01547493193363846);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01547493178210529);
    AssertAlmostEqual(&test, rTM, 0.01547493208217096);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01547491692886906);
    AssertAlmostEqual(&test, rTM, 0.01547494693540719);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01547343174925686);
    AssertAlmostEqual(&test, rTM, 0.01547643211494973);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01532634006817997);
    AssertAlmostEqual(&test, rTM, 0.01562352311257692);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.007857658731725779);
    AssertAlmostEqual(&test, rTM, 0.0230904093265304);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001580216344992208);
    AssertAlmostEqual(&test, rTM, 0.03078458285505377);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.596358305863725e-06);
    AssertAlmostEqual(&test, rTM, 0.03094085913598546);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001632668372961619);
    AssertAlmostEqual(&test, rTM, 0.0001632668372961619);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001632668372961619);
    AssertAlmostEqual(&test, rTM, 0.0001632668372961619);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001632668372961619);
    AssertAlmostEqual(&test, rTM, 0.0001632668372961619);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001632668372961618);
    AssertAlmostEqual(&test, rTM, 0.0001632668372961619);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001632668372961602);
    AssertAlmostEqual(&test, rTM, 0.0001632668372961635);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001632668372959986);
    AssertAlmostEqual(&test, rTM, 0.0001632668372963251);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001632668372798405);
    AssertAlmostEqual(&test, rTM, 0.0001632668373124832);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001632668356640265);
    AssertAlmostEqual(&test, rTM, 0.0001632668389282972);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001632666740827912);
    AssertAlmostEqual(&test, rTM, 0.0001632670005095326);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001632505175742135);
    AssertAlmostEqual(&test, rTM, 0.0001632831570181102);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001616508564900045);
    AssertAlmostEqual(&test, rTM, 0.0001648828181014666);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.164674722207878e-05);
    AssertAlmostEqual(&test, rTM, 0.0002448869251949301);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.61702608207901e-06);
    AssertAlmostEqual(&test, rTM, 0.000324916639977704);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.636957029595371e-06);
    AssertAlmostEqual(&test, rTM, 1.636957029595371e-06);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.636957029595371e-06);
    AssertAlmostEqual(&test, rTM, 1.636957029595371e-06);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.636957029595371e-06);
    AssertAlmostEqual(&test, rTM, 1.636957029595371e-06);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.636957029595371e-06);
    AssertAlmostEqual(&test, rTM, 1.636957029595371e-06);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.63695702959537e-06);
    AssertAlmostEqual(&test, rTM, 1.636957029595371e-06);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.636957029595354e-06);
    AssertAlmostEqual(&test, rTM, 1.636957029595387e-06);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.636957029593734e-06);
    AssertAlmostEqual(&test, rTM, 1.636957029597007e-06);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.636957029431676e-06);
    AssertAlmostEqual(&test, rTM, 1.636957029759066e-06);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.636957013225854e-06);
    AssertAlmostEqual(&test, rTM, 1.636957045964887e-06);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.636955392645337e-06);
    AssertAlmostEqual(&test, rTM, 1.636958666545404e-06);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.636793350796162e-06);
    AssertAlmostEqual(&test, rTM, 1.637120708394579e-06);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.620749586789339e-06);
    AssertAlmostEqual(&test, rTM, 1.653164472401401e-06);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.184798546123919e-07);
    AssertAlmostEqual(&test, rTM, 2.455434204576156e-06);

    userdata[0] = 5/CAPS_HBAR_EV; /* 5eV */
    userdata[1] = 1/CAPS_HBAR_EV; /* 1eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999749964251078);
    AssertAlmostEqual(&test, rTM, 0.9999874981344051);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999822329779624);
    AssertAlmostEqual(&test, rTM, 0.9999982407341562);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9982334322115928);
    AssertAlmostEqual(&test, rTM, 0.9999998232046021);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9824751806713957);
    AssertAlmostEqual(&test, rTM, 0.9999999823188997);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8381361633657177);
    AssertAlmostEqual(&test, rTM, 0.999999998225063);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2031348975831368);
    AssertAlmostEqual(&test, rTM, 0.9999999997640149);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.003178700003837402);
    AssertAlmostEqual(&test, rTM, 0.9999999998427046);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.198800379004838e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999998436914);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.199002988576925e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999998437012);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.199005014834665e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999998437014);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.199005035097259e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999998437014);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.199005035299884e-13);
    AssertAlmostEqual(&test, rTM, 0.9999999998437014);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.199005035301911e-15);
    AssertAlmostEqual(&test, rTM, 0.9999999998437014);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999438123294226);
    AssertAlmostEqual(&test, rTM, 0.999944368627518);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999209338903963);
    AssertAlmostEqual(&test, rTM, 0.9999604661637206);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994382653477003);
    AssertAlmostEqual(&test, rTM, 0.9999944367232627);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9944242907664812);
    AssertAlmostEqual(&test, rTM, 0.9999994409219989);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9456307244374209);
    AssertAlmostEqual(&test, rTM, 0.9999999440677945);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5757588043796081);
    AssertAlmostEqual(&test, rTM, 0.9999999941946021);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03009362753526015);
    AssertAlmostEqual(&test, rTM, 0.9999999983400234);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003196959887884886);
    AssertAlmostEqual(&test, rTM, 0.9999999984360143);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.198984511949875e-06);
    AssertAlmostEqual(&test, rTM, 0.999999998437004);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.199004774379291e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999984370139);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.199004977005206e-10);
    AssertAlmostEqual(&test, rTM, 0.999999998437014);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.199004979031465e-12);
    AssertAlmostEqual(&test, rTM, 0.999999998437014);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.199004979051728e-14);
    AssertAlmostEqual(&test, rTM, 0.999999998437014);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994410515308002);
    AssertAlmostEqual(&test, rTM, 0.9994410520895918);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994410238712982);
    AssertAlmostEqual(&test, rTM, 0.9994410797476979);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999438264804601);
    AssertAlmostEqual(&test, rTM, 0.9994438249921255);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9992096194161966);
    AssertAlmostEqual(&test, rTM, 0.9996047315740981);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9943968336626637);
    AssertAlmostEqual(&test, rTM, 0.999944368358499);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.945628057321772);
    AssertAlmostEqual(&test, rTM, 0.9999944070665724);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5757583510962233);
    AssertAlmostEqual(&test, rTM, 0.9999994194600867);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0300935724488631);
    AssertAlmostEqual(&test, rTM, 0.9999998340020602);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003196953707988826);
    AssertAlmostEqual(&test, rTM, 0.999999843601154);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.198978324538091e-06);
    AssertAlmostEqual(&test, rTM, 0.999999843700122);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.198998586892261e-08);
    AssertAlmostEqual(&test, rTM, 0.9999998437011119);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.198998789517423e-10);
    AssertAlmostEqual(&test, rTM, 0.9999998437011219);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.198998791543675e-12);
    AssertAlmostEqual(&test, rTM, 0.999999843701122);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9982335032073762);
    AssertAlmostEqual(&test, rTM, 0.9982335032250256);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9982335023337336);
    AssertAlmostEqual(&test, rTM, 0.9982335040986678);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9982334149716534);
    AssertAlmostEqual(&test, rTM, 0.9982335914563444);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9982247005313509);
    AssertAlmostEqual(&test, rTM, 0.9982422622920147);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9975027109072885);
    AssertAlmostEqual(&test, rTM, 0.9987505744342192);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9823883892751012);
    AssertAlmostEqual(&test, rTM, 0.9998240802128198);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8381273419444754);
    AssertAlmostEqual(&test, rTM, 0.9999822515076285);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2031321347814583);
    AssertAlmostEqual(&test, rTM, 0.9999976401210532);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.00317863826989503);
    AssertAlmostEqual(&test, rTM, 0.9999984270177457);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.198737894151595e-05);
    AssertAlmostEqual(&test, rTM, 0.9999984368859393);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.19894049612475e-07);
    AssertAlmostEqual(&test, rTM, 0.9999984369849358);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.198942522306492e-09);
    AssertAlmostEqual(&test, rTM, 0.9999984369859258);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.198942542568326e-11);
    AssertAlmostEqual(&test, rTM, 0.9999984369859357);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9944240257099689);
    AssertAlmostEqual(&test, rTM, 0.9944240257105249);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9944240256824449);
    AssertAlmostEqual(&test, rTM, 0.9944240257380488);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9944240229300551);
    AssertAlmostEqual(&test, rTM, 0.9944240284904373);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9944237476979818);
    AssertAlmostEqual(&test, rTM, 0.9944243037086901);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9943962933315276);
    AssertAlmostEqual(&test, rTM, 0.9944516212250486);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9921235081797163);
    AssertAlmostEqual(&test, rTM, 0.9960539531162049);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9453620095254601);
    AssertAlmostEqual(&test, rTM, 0.9994435560925449);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5757130251512903);
    AssertAlmostEqual(&test, rTM, 0.9999419447706508);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03008806482285605);
    AssertAlmostEqual(&test, rTM, 0.9999833974432696);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003196335839008757);
    AssertAlmostEqual(&test, rTM, 0.9999843573344521);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.198359704208772e-06);
    AssertAlmostEqual(&test, rTM, 0.9999843672310238);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.198379959040463e-08);
    AssertAlmostEqual(&test, rTM, 0.9999843673300212);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.198380161590399e-10);
    AssertAlmostEqual(&test, rTM, 0.9999843673310111);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9824582297374148);
    AssertAlmostEqual(&test, rTM, 0.9824582297374322);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9824582297365542);
    AssertAlmostEqual(&test, rTM, 0.9824582297382928);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9824582296504908);
    AssertAlmostEqual(&test, rTM, 0.9824582298243563);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9824582210441497);
    AssertAlmostEqual(&test, rTM, 0.982458238430693);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9824573604319414);
    AssertAlmostEqual(&test, rTM, 0.9824590990002092);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9823715170732175);
    AssertAlmostEqual(&test, rTM, 0.9825445196268531);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9752829472388254);
    AssertAlmostEqual(&test, rTM, 0.987563664625507);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8372555879309177);
    AssertAlmostEqual(&test, rTM, 0.9982337648187396);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2028589516388503);
    AssertAlmostEqual(&test, rTM, 0.9997637363187298);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.003172537841518738);
    AssertAlmostEqual(&test, rTM, 0.9998424239663954);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.192563337666244e-05);
    AssertAlmostEqual(&test, rTM, 0.9998434105609204);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.19276518949949e-07);
    AssertAlmostEqual(&test, rTM, 0.999843420458276);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.192767208178937e-09);
    AssertAlmostEqual(&test, rTM, 0.9998434205572527);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9451171169836964);
    AssertAlmostEqual(&test, rTM, 0.9451171169836969);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.94511711698367);
    AssertAlmostEqual(&test, rTM, 0.9451171169837234);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.94511711698103);
    AssertAlmostEqual(&test, rTM, 0.9451171169863634);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.945117116717025);
    AssertAlmostEqual(&test, rTM, 0.9451171172503683);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9451170903165422);
    AssertAlmostEqual(&test, rTM, 0.9451171436508384);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9451144503380328);
    AssertAlmostEqual(&test, rTM, 0.9451197835034555);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.944851146695737);
    AssertAlmostEqual(&test, rTM, 0.9453818405809241);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.923285559501);
    AssertAlmostEqual(&test, rTM, 0.960862232121908);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5712042268043432);
    AssertAlmostEqual(&test, rTM, 0.9941825938347562);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02954725583011756);
    AssertAlmostEqual(&test, rTM, 0.9983122133079799);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003135732098577223);
    AssertAlmostEqual(&test, rTM, 0.9984080154386279);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.137683003235834e-06);
    AssertAlmostEqual(&test, rTM, 0.998409002762976);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.137702527597468e-08);
    AssertAlmostEqual(&test, rTM, 0.9984090126393309);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8244771669888463);
    AssertAlmostEqual(&test, rTM, 0.8244771669888463);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8244771669888454);
    AssertAlmostEqual(&test, rTM, 0.8244771669888471);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8244771669887669);
    AssertAlmostEqual(&test, rTM, 0.8244771669889256);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8244771669809144);
    AssertAlmostEqual(&test, rTM, 0.8244771669967781);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8244771661956625);
    AssertAlmostEqual(&test, rTM, 0.8244771677820301);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8244770876704929);
    AssertAlmostEqual(&test, rTM, 0.8244772463071672);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8244692353894005);
    AssertAlmostEqual(&test, rTM, 0.82448509826437);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8236863541185836);
    AssertAlmostEqual(&test, rTM, 0.8252647727098905);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7614497264569134);
    AssertAlmostEqual(&test, rTM, 0.872061619782097);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1787198156762563);
    AssertAlmostEqual(&test, rTM, 0.9737814495016179);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002661662541553877);
    AssertAlmostEqual(&test, rTM, 0.9815621629732851);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.676009893516749e-05);
    AssertAlmostEqual(&test, rTM, 0.9816581827007792);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.676154336875434e-07);
    AssertAlmostEqual(&test, rTM, 0.9816591456036605);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3956143581499551);
    AssertAlmostEqual(&test, rTM, 0.3956143581499551);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3956143581499551);
    AssertAlmostEqual(&test, rTM, 0.3956143581499551);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3956143581499534);
    AssertAlmostEqual(&test, rTM, 0.3956143581499568);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3956143581497838);
    AssertAlmostEqual(&test, rTM, 0.3956143581501264);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3956143581328226);
    AssertAlmostEqual(&test, rTM, 0.3956143581670876);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3956143564367051);
    AssertAlmostEqual(&test, rTM, 0.3956143598632051);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3956141868250374);
    AssertAlmostEqual(&test, rTM, 0.3956145294748452);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3955972265289487);
    AssertAlmostEqual(&test, rTM, 0.3956314894956575);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3939098523036104);
    AssertAlmostEqual(&test, rTM, 0.3973161430145709);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2804065578997342);
    AssertAlmostEqual(&test, rTM, 0.4995859671455226);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01049916413972056);
    AssertAlmostEqual(&test, rTM, 0.6785263534255487);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001082695406539534);
    AssertAlmostEqual(&test, rTM, 0.6840940520980594);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.083034754508297e-06);
    AssertAlmostEqual(&test, rTM, 0.6841510727810682);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01510939401643502);
    AssertAlmostEqual(&test, rTM, 0.01510939401643502);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01510939401643502);
    AssertAlmostEqual(&test, rTM, 0.01510939401643502);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01510939401643501);
    AssertAlmostEqual(&test, rTM, 0.01510939401643502);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01510939401643487);
    AssertAlmostEqual(&test, rTM, 0.01510939401643516);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01510939401642036);
    AssertAlmostEqual(&test, rTM, 0.01510939401644967);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01510939401496906);
    AssertAlmostEqual(&test, rTM, 0.01510939401790098);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01510939386983899);
    AssertAlmostEqual(&test, rTM, 0.01510939416303104);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01510937935684672);
    AssertAlmostEqual(&test, rTM, 0.0151094086760233);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01510792819843386);
    AssertAlmostEqual(&test, rTM, 0.01511085983437123);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01496420695965761);
    AssertAlmostEqual(&test, rTM, 0.01525458043607943);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.00766926851136475);
    AssertAlmostEqual(&test, rTM, 0.02254784674057397);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001541756390068016);
    AssertAlmostEqual(&test, rTM, 0.03005785521448644);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.557493620181729e-06);
    AssertAlmostEqual(&test, rTM, 0.03021033477380186);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001628512672717526);
    AssertAlmostEqual(&test, rTM, 0.0001628512672717526);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001628512672717526);
    AssertAlmostEqual(&test, rTM, 0.0001628512672717526);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001628512672717526);
    AssertAlmostEqual(&test, rTM, 0.0001628512672717526);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001628512672717525);
    AssertAlmostEqual(&test, rTM, 0.0001628512672717526);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001628512672717509);
    AssertAlmostEqual(&test, rTM, 0.0001628512672717542);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001628512672715898);
    AssertAlmostEqual(&test, rTM, 0.0001628512672719154);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001628512672554727);
    AssertAlmostEqual(&test, rTM, 0.0001628512672880324);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001628512656437702);
    AssertAlmostEqual(&test, rTM, 0.0001628512688997349);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001628511044736805);
    AssertAlmostEqual(&test, rTM, 0.0001628514300698247);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001628349890755584);
    AssertAlmostEqual(&test, rTM, 0.0001628675454679467);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001612393983638353);
    AssertAlmostEqual(&test, rTM, 0.0001644631361788236);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.14388944432772e-05);
    AssertAlmostEqual(&test, rTM, 0.0002442636379414798);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.61290886933221e-06);
    AssertAlmostEqual(&test, rTM, 0.0003240896172066211);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.636538314578754e-06);
    AssertAlmostEqual(&test, rTM, 1.636538314578754e-06);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.636538314578754e-06);
    AssertAlmostEqual(&test, rTM, 1.636538314578754e-06);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.636538314578754e-06);
    AssertAlmostEqual(&test, rTM, 1.636538314578754e-06);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.636538314578754e-06);
    AssertAlmostEqual(&test, rTM, 1.636538314578754e-06);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.636538314578754e-06);
    AssertAlmostEqual(&test, rTM, 1.636538314578754e-06);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.636538314578738e-06);
    AssertAlmostEqual(&test, rTM, 1.636538314578771e-06);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.636538314577118e-06);
    AssertAlmostEqual(&test, rTM, 1.636538314580391e-06);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.636538314415101e-06);
    AssertAlmostEqual(&test, rTM, 1.636538314742407e-06);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.636538298213425e-06);
    AssertAlmostEqual(&test, rTM, 1.636538330944084e-06);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.636536678047433e-06);
    AssertAlmostEqual(&test, rTM, 1.636539951110076e-06);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.636374677646587e-06);
    AssertAlmostEqual(&test, rTM, 1.636701951510922e-06);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.620335017439084e-06);
    AssertAlmostEqual(&test, rTM, 1.652741611718424e-06);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.182704964187524e-07);
    AssertAlmostEqual(&test, rTM, 2.454806132736565e-06);

    userdata[0] = 7/CAPS_HBAR_EV; /* 7eV */
    userdata[1] = 1e-05/CAPS_HBAR_EV; /* 1e-05eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999435164599);
    AssertAlmostEqual(&test, rTM, 0.9999999717582295);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999995986090999);
    AssertAlmostEqual(&test, rTM, 0.9999999960258319);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999960058187466);
    AssertAlmostEqual(&test, rTM, 0.999999999600621);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999600608822636);
    AssertAlmostEqual(&test, rTM, 0.9999999999600602);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996006807962329);
    AssertAlmostEqual(&test, rTM, 0.999999999996006);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.996013978476333);
    AssertAlmostEqual(&test, rTM, 0.9999999999996007);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9608497390661116);
    AssertAlmostEqual(&test, rTM, 0.99999999999996);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6724746730148516);
    AssertAlmostEqual(&test, rTM, 0.9999999999999959);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05587817679462234);
    AssertAlmostEqual(&test, rTM, 0.9999999999999991);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006260977783135407);
    AssertAlmostEqual(&test, rTM, 0.9999999999999992);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.268746525622218e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999999992);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.268824334764017e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999999992);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.268825112867628e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999999999992);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999998729575106);
    AssertAlmostEqual(&test, rTM, 0.999999874215357);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999998212264374);
    AssertAlmostEqual(&test, rTM, 0.9999999106132147);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999987295758326);
    AssertAlmostEqual(&test, rTM, 0.999999987421535);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999873582468941);
    AssertAlmostEqual(&test, rTM, 0.9999999987359431);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998735959168541);
    AssertAlmostEqual(&test, rTM, 0.999999999873588);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9987366786440542);
    AssertAlmostEqual(&test, rTM, 0.9999999999873588);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9874384465055921);
    AssertAlmostEqual(&test, rTM, 0.9999999999987359);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8813257321643185);
    AssertAlmostEqual(&test, rTM, 0.9999999999998733);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3035399087586863);
    AssertAlmostEqual(&test, rTM, 0.999999999999985);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.006180707270294993);
    AssertAlmostEqual(&test, rTM, 0.9999999999999919);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.257040683338143e-05);
    AssertAlmostEqual(&test, rTM, 0.999999999999992);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.257815935937114e-07);
    AssertAlmostEqual(&test, rTM, 0.999999999999992);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.257823689675808e-09);
    AssertAlmostEqual(&test, rTM, 0.999999999999992);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999986192463969);
    AssertAlmostEqual(&test, rTM, 0.9999986192477777);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999986191780513);
    AssertAlmostEqual(&test, rTM, 0.9999986193161197);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999986123605011);
    AssertAlmostEqual(&test, rTM, 0.9999986260994966);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999980473210629);
    AssertAlmostEqual(&test, rTM, 0.9999990236600548);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999861236916603);
    AssertAlmostEqual(&test, rTM, 0.9999998626098647);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998619272428333);
    AssertAlmostEqual(&test, rTM, 0.9999999861931518);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9986201983561445);
    AssertAlmostEqual(&test, rTM, 0.9999999986192465);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9862874562900567);
    AssertAlmostEqual(&test, rTM, 0.9999999998619213);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8711283630639564);
    AssertAlmostEqual(&test, rTM, 0.9999999999861596);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2754000676230438);
    AssertAlmostEqual(&test, rTM, 0.9999999999983221);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.005190950869361217);
    AssertAlmostEqual(&test, rTM, 0.9999999999990368);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.244715176127454e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999990467);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.245259857601505e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999990468);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999993136453317);
    AssertAlmostEqual(&test, rTM, 0.9999931364533856);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999931364499195);
    AssertAlmostEqual(&test, rTM, 0.999993136456783);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999931361101837);
    AssertAlmostEqual(&test, rTM, 0.9999931367965017);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999931022211042);
    AssertAlmostEqual(&test, rTM, 0.9999931705157115);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999902934930411);
    AssertAlmostEqual(&test, rTM, 0.9999951467347434);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999310243520865);
    AssertAlmostEqual(&test, rTM, 0.9999993170494719);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993138441888221);
    AssertAlmostEqual(&test, rTM, 0.9999999313677278);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9931599402701888);
    AssertAlmostEqual(&test, rTM, 0.9999999931363929);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9336793226951138);
    AssertAlmostEqual(&test, rTM, 0.9999999993132389);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5098939910946766);
    AssertAlmostEqual(&test, rTM, 0.999999999927435);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02037148442979654);
    AssertAlmostEqual(&test, rTM, 0.9999999999754661);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002121854099976511);
    AssertAlmostEqual(&test, rTM, 0.9999999999764357);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.122745827488033e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999764456);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999427699654088);
    AssertAlmostEqual(&test, rTM, 0.9999427699654144);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999427699651254);
    AssertAlmostEqual(&test, rTM, 0.9999427699656978);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999427699367974);
    AssertAlmostEqual(&test, rTM, 0.9999427699940258);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999427671040633);
    AssertAlmostEqual(&test, rTM, 0.9999427728266169);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999424845352682);
    AssertAlmostEqual(&test, rTM, 0.9999430539791003);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999190654682382);
    AssertAlmostEqual(&test, rTM, 0.9999595319152695);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994249941989882);
    AssertAlmostEqual(&test, rTM, 0.9999943052517449);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9942929021423781);
    AssertAlmostEqual(&test, rTM, 0.9999994277097116);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.944382605104151);
    AssertAlmostEqual(&test, rTM, 0.9999999427449302);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5684849666655896);
    AssertAlmostEqual(&test, rTM, 0.9999999940471176);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0287969944846596);
    AssertAlmostEqual(&test, rTM, 0.9999999982651475);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003051139531390466);
    AssertAlmostEqual(&test, rTM, 0.9999999983612682);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.052983632857945e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999983622578);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994405205510069);
    AssertAlmostEqual(&test, rTM, 0.9994405205510074);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994405205509792);
    AssertAlmostEqual(&test, rTM, 0.9994405205510352);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994405205482105);
    AssertAlmostEqual(&test, rTM, 0.9994405205538038);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994405202713458);
    AssertAlmostEqual(&test, rTM, 0.9994405208306684);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994404925855619);
    AssertAlmostEqual(&test, rTM, 0.9994405485150551);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994377308972137);
    AssertAlmostEqual(&test, rTM, 0.9994432963680072);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9992088682763342);
    AssertAlmostEqual(&test, rTM, 0.9996043558555426);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9943915215540367);
    AssertAlmostEqual(&test, rTM, 0.9999443154689834);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9455778103241843);
    AssertAlmostEqual(&test, rTM, 0.9999944017450692);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5754636890206407);
    AssertAlmostEqual(&test, rTM, 0.9999994188680886);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03003976507155433);
    AssertAlmostEqual(&test, rTM, 0.9999998337041853);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003190887369673852);
    AssertAlmostEqual(&test, rTM, 0.9999998433038172);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.192904308138178e-06);
    AssertAlmostEqual(&test, rTM, 0.9999998434027852);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9944320449544161);
    AssertAlmostEqual(&test, rTM, 0.9944320449544162);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9944320449544134);
    AssertAlmostEqual(&test, rTM, 0.9944320449544189);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9944320449541385);
    AssertAlmostEqual(&test, rTM, 0.9944320449546937);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.994432044926654);
    AssertAlmostEqual(&test, rTM, 0.9944320449821782);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9944320421782115);
    AssertAlmostEqual(&test, rTM, 0.9944320477306194);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9944317673408597);
    AssertAlmostEqual(&test, rTM, 0.9944323225541704);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9944043523472677);
    AssertAlmostEqual(&test, rTM, 0.9944596008928239);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9921348228420342);
    AssertAlmostEqual(&test, rTM, 0.9960596329100261);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9454385986458259);
    AssertAlmostEqual(&test, rTM, 0.9994443589944293);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5761603641992771);
    AssertAlmostEqual(&test, rTM, 0.9999420345520632);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03016994467673273);
    AssertAlmostEqual(&test, rTM, 0.999983442582872);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003205569439603197);
    AssertAlmostEqual(&test, rTM, 0.9999844023922508);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.207605017490472e-06);
    AssertAlmostEqual(&test, rTM, 0.999984412288814);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9457139721228105);
    AssertAlmostEqual(&test, rTM, 0.9457139721228105);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9457139721228103);
    AssertAlmostEqual(&test, rTM, 0.9457139721228108);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9457139721227842);
    AssertAlmostEqual(&test, rTM, 0.9457139721228369);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9457139721201719);
    AssertAlmostEqual(&test, rTM, 0.9457139721254492);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9457139718589533);
    AssertAlmostEqual(&test, rTM, 0.9457139723866677);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9457139457371021);
    AssertAlmostEqual(&test, rTM, 0.9457139985085065);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9457113336209668);
    AssertAlmostEqual(&test, rTM, 0.9457166104999972);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9454508084681037);
    AssertAlmostEqual(&test, rTM, 0.9459759014433139);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9241099257076918);
    AssertAlmostEqual(&test, rTM, 0.9612916012555283);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5747042420301537);
    AssertAlmostEqual(&test, rTM, 0.9942521404312826);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.030180214845328);
    AssertAlmostEqual(&test, rTM, 0.998347614645813);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003207041911416959);
    AssertAlmostEqual(&test, rTM, 0.9984433587333138);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.209082505437395e-06);
    AssertAlmostEqual(&test, rTM, 0.9984443461029614);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5762543390359623);
    AssertAlmostEqual(&test, rTM, 0.5762543390359623);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5762543390359622);
    AssertAlmostEqual(&test, rTM, 0.5762543390359623);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5762543390359608);
    AssertAlmostEqual(&test, rTM, 0.5762543390359639);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5762543390358074);
    AssertAlmostEqual(&test, rTM, 0.5762543390361172);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5762543390204709);
    AssertAlmostEqual(&test, rTM, 0.5762543390514538);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5762543374868133);
    AssertAlmostEqual(&test, rTM, 0.5762543405851113);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5762541841211294);
    AssertAlmostEqual(&test, rTM, 0.5762544939507538);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5762388481699124);
    AssertAlmostEqual(&test, rTM, 0.5762698294879626);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5747113919259472);
    AssertAlmostEqual(&test, rTM, 0.5777931892020504);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4628987510574569);
    AssertAlmostEqual(&test, rTM, 0.6710654419849555);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02990286176866069);
    AssertAlmostEqual(&test, rTM, 0.8574838669069209);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003206872274012624);
    AssertAlmostEqual(&test, rTM, 0.8651212438211539);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.209227155161505e-06);
    AssertAlmostEqual(&test, rTM, 0.8652010883186485);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03018449583479479);
    AssertAlmostEqual(&test, rTM, 0.03018449583479479);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03018449583479479);
    AssertAlmostEqual(&test, rTM, 0.03018449583479479);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03018449583479479);
    AssertAlmostEqual(&test, rTM, 0.0301844958347948);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03018449583479451);
    AssertAlmostEqual(&test, rTM, 0.03018449583479508);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03018449583476638);
    AssertAlmostEqual(&test, rTM, 0.03018449583482321);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03018449583195323);
    AssertAlmostEqual(&test, rTM, 0.03018449583763636);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03018449555063801);
    AssertAlmostEqual(&test, rTM, 0.03018449611895158);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03018446741914247);
    AssertAlmostEqual(&test, rTM, 0.03018452425044707);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03018165453460879);
    AssertAlmostEqual(&test, rTM, 0.030187337134493);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02990299151908645);
    AssertAlmostEqual(&test, rTM, 0.03046599536230055);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0155511321812039);
    AssertAlmostEqual(&test, rTM, 0.04480493199620068);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003175473151066468);
    AssertAlmostEqual(&test, rTM, 0.05999764111323699);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.208924257435028e-06);
    AssertAlmostEqual(&test, rTM, 0.06031084206834236);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003207208996746961);
    AssertAlmostEqual(&test, rTM, 0.0003207208996746961);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003207208996746961);
    AssertAlmostEqual(&test, rTM, 0.0003207208996746961);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003207208996746961);
    AssertAlmostEqual(&test, rTM, 0.0003207208996746961);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000320720899674696);
    AssertAlmostEqual(&test, rTM, 0.0003207208996746961);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003207208996746929);
    AssertAlmostEqual(&test, rTM, 0.0003207208996746993);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003207208996743756);
    AssertAlmostEqual(&test, rTM, 0.0003207208996750166);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003207208996426445);
    AssertAlmostEqual(&test, rTM, 0.0003207208997067476);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003207208964695437);
    AssertAlmostEqual(&test, rTM, 0.0003207209028798484);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003207205791597745);
    AssertAlmostEqual(&test, rTM, 0.0003207212201896176);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003206888513532893);
    AssertAlmostEqual(&test, rTM, 0.0003207529479961022);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003175474612940735);
    AssertAlmostEqual(&test, rTM, 0.0003238943380488588);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001604118849075143);
    AssertAlmostEqual(&test, rTM, 0.0004810298979574778);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.177472109007043e-06);
    AssertAlmostEqual(&test, rTM, 0.0006382642625613593);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.209246773987087e-06);
    AssertAlmostEqual(&test, rTM, 3.209246773987087e-06);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.209246773987087e-06);
    AssertAlmostEqual(&test, rTM, 3.209246773987087e-06);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.209246773987087e-06);
    AssertAlmostEqual(&test, rTM, 3.209246773987087e-06);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.209246773987087e-06);
    AssertAlmostEqual(&test, rTM, 3.209246773987087e-06);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.209246773987087e-06);
    AssertAlmostEqual(&test, rTM, 3.209246773987087e-06);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.209246773987055e-06);
    AssertAlmostEqual(&test, rTM, 3.209246773987119e-06);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.209246773983878e-06);
    AssertAlmostEqual(&test, rTM, 3.209246773990296e-06);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.209246773666164e-06);
    AssertAlmostEqual(&test, rTM, 3.20924677430801e-06);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.209246741894826e-06);
    AssertAlmostEqual(&test, rTM, 3.209246806079348e-06);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.20924356476412e-06);
    AssertAlmostEqual(&test, rTM, 3.209249983210053e-06);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.208925883458381e-06);
    AssertAlmostEqual(&test, rTM, 3.209567664515792e-06);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.177472255378503e-06);
    AssertAlmostEqual(&test, rTM, 3.241021292595665e-06);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.604628536630103e-06);
    AssertAlmostEqual(&test, rTM, 4.813865011327544e-06);

    userdata[0] = 7/CAPS_HBAR_EV; /* 7eV */
    userdata[1] = 0.0001/CAPS_HBAR_EV; /* 0.0001eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999998213990752);
    AssertAlmostEqual(&test, rTM, 0.9999999106995335);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999987308026526);
    AssertAlmostEqual(&test, rTM, 0.9999999874336817);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999873704546808);
    AssertAlmostEqual(&test, rTM, 0.9999999987371638);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998737179747974);
    AssertAlmostEqual(&test, rTM, 0.9999999998737101);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9987378978354394);
    AssertAlmostEqual(&test, rTM, 0.999999999987371);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9874505003261533);
    AssertAlmostEqual(&test, rTM, 0.9999999999987371);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8814331109949839);
    AssertAlmostEqual(&test, rTM, 0.9999999999998734);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3038533340531717);
    AssertAlmostEqual(&test, rTM, 0.999999999999985);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.006192514584687024);
    AssertAlmostEqual(&test, rTM, 0.9999999999999919);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.269141267267117e-05);
    AssertAlmostEqual(&test, rTM, 0.999999999999992);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.269919521449504e-07);
    AssertAlmostEqual(&test, rTM, 0.999999999999992);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.269927305211082e-09);
    AssertAlmostEqual(&test, rTM, 0.999999999999992);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.269927383048821e-11);
    AssertAlmostEqual(&test, rTM, 0.999999999999992);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999995986090999);
    AssertAlmostEqual(&test, rTM, 0.9999996025832665);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999994351647425);
    AssertAlmostEqual(&test, rTM, 0.9999997175823314);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999959860982491);
    AssertAlmostEqual(&test, rTM, 0.9999999602583195);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999600589053677);
    AssertAlmostEqual(&test, rTM, 0.9999999960062101);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996006805986094);
    AssertAlmostEqual(&test, rTM, 0.9999999996006013);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960139784566415);
    AssertAlmostEqual(&test, rTM, 0.9999999999600601);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9608497390642123);
    AssertAlmostEqual(&test, rTM, 0.9999999999960052);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6724746730147213);
    AssertAlmostEqual(&test, rTM, 0.9999999999995928);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05587817679462186);
    AssertAlmostEqual(&test, rTM, 0.9999999999999108);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006260977783135407);
    AssertAlmostEqual(&test, rTM, 0.9999999999999202);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.268746525622218e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999999203);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.268824334764017e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999999203);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.268825112867629e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999999999203);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999959675832654);
    AssertAlmostEqual(&test, rTM, 0.9999959675872978);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999959673836663);
    AssertAlmostEqual(&test, rTM, 0.9999959677868868);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999959474734035);
    AssertAlmostEqual(&test, rTM, 0.9999959875973486);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999942973091787);
    AssertAlmostEqual(&test, rTM, 0.9999971486505242);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999594754730631);
    AssertAlmostEqual(&test, rTM, 0.9999995987590103);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995968188556291);
    AssertAlmostEqual(&test, rTM, 0.9999999596777875);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.995975697164175);
    AssertAlmostEqual(&test, rTM, 0.9999999959675709);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9604805977360942);
    AssertAlmostEqual(&test, rTM, 0.9999999995966757);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6699454111397595);
    AssertAlmostEqual(&test, rTM, 0.9999999999588643);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05492843881642982);
    AssertAlmostEqual(&test, rTM, 0.9999999999909247);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006142344703023822);
    AssertAlmostEqual(&test, rTM, 0.9999999999918597);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.149821699325353e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999918697);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.149896584212362e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999918698);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999861925565947);
    AssertAlmostEqual(&test, rTM, 0.9999861925567327);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999861925497601);
    AssertAlmostEqual(&test, rTM, 0.9999861925635674);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999861918663135);
    AssertAlmostEqual(&test, rTM, 0.9999861932469793);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999861236916603);
    AssertAlmostEqual(&test, rTM, 0.999986261079908);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999804733822112);
    AssertAlmostEqual(&test, rTM, 0.9999902366434438);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998612455812291);
    AssertAlmostEqual(&test, rTM, 0.9999986260994934);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9986201301048757);
    AssertAlmostEqual(&test, rTM, 0.9999998619314933);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9862874495492089);
    AssertAlmostEqual(&test, rTM, 0.9999999861921393);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8711283624699773);
    AssertAlmostEqual(&test, rTM, 0.9999999986159596);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2754000676075538);
    AssertAlmostEqual(&test, rTM, 0.999999999832216);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.005190950869356131);
    AssertAlmostEqual(&test, rTM, 0.9999999999036812);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.244715176127403e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999046659);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.245259857601504e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999046758);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999313666533564);
    AssertAlmostEqual(&test, rTM, 0.9999313666533632);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999313666530166);
    AssertAlmostEqual(&test, rTM, 0.999931366653703);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999313666190442);
    AssertAlmostEqual(&test, rTM, 0.9999313666876752);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999931363221896);
    AssertAlmostEqual(&test, rTM, 0.999931370084652);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999310243520865);
    AssertAlmostEqual(&test, rTM, 0.9999317072559732);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999902939170072);
    AssertAlmostEqual(&test, rTM, 0.9999514684073497);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993104575888192);
    AssertAlmostEqual(&test, rTM, 0.9999931705153133);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9931596028579155);
    AssertAlmostEqual(&test, rTM, 0.9999993136734895);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.933679290992336);
    AssertAlmostEqual(&test, rTM, 0.9999999313239299);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5098939894561306);
    AssertAlmostEqual(&test, rTM, 0.9999999927435101);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02037148442786029);
    AssertAlmostEqual(&test, rTM, 0.9999999975466074);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002121854099974412);
    AssertAlmostEqual(&test, rTM, 0.9999999976435704);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.122745827488012e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999976445602);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994278470268118);
    AssertAlmostEqual(&test, rTM, 0.9994278470268123);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994278470267834);
    AssertAlmostEqual(&test, rTM, 0.9994278470268406);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999427847023952);
    AssertAlmostEqual(&test, rTM, 0.999427847029672);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994278467408175);
    AssertAlmostEqual(&test, rTM, 0.9994278473128064);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994278184280651);
    AssertAlmostEqual(&test, rTM, 0.99942787562413);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994249941989882);
    AssertAlmostEqual(&test, rTM, 0.9994306857046756);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991909494085555);
    AssertAlmostEqual(&test, rTM, 0.9995953928342426);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9942648054281843);
    AssertAlmostEqual(&test, rTM, 0.9999430537482601);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9443799308647517);
    AssertAlmostEqual(&test, rTM, 0.9999942747928737);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5684848118304358);
    AssertAlmostEqual(&test, rTM, 0.9999994047122536);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02879699421552925);
    AssertAlmostEqual(&test, rTM, 0.9999998265147836);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003051139531088587);
    AssertAlmostEqual(&test, rTM, 0.9999998361268416);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.052983632854922e-06);
    AssertAlmostEqual(&test, rTM, 0.9999998362258111);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9944192774815197);
    AssertAlmostEqual(&test, rTM, 0.9944192774815197);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9944192774815169);
    AssertAlmostEqual(&test, rTM, 0.9944192774815225);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9944192774812415);
    AssertAlmostEqual(&test, rTM, 0.9944192774817979);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9944192774536942);
    AssertAlmostEqual(&test, rTM, 0.9944192775093452);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9944192746989671);
    AssertAlmostEqual(&test, rTM, 0.994419280264071);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9944189992331791);
    AssertAlmostEqual(&test, rTM, 0.9944195557160267);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9943915215540367);
    AssertAlmostEqual(&test, rTM, 0.9944468964295223);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9921168087377008);
    AssertAlmostEqual(&test, rTM, 0.9960505900796383);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9453166634541539);
    AssertAlmostEqual(&test, rTM, 0.9994430806868929);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5754483378390928);
    AssertAlmostEqual(&test, rTM, 0.9999418915982793);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03003973706683298);
    AssertAlmostEqual(&test, rTM, 0.9999833706852507);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003190887338104221);
    AssertAlmostEqual(&test, rTM, 0.9999843306247158);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.192904307822083e-06);
    AssertAlmostEqual(&test, rTM, 0.9999843405212926);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9457018194661544);
    AssertAlmostEqual(&test, rTM, 0.9457018194661544);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9457018194661542);
    AssertAlmostEqual(&test, rTM, 0.9457018194661547);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9457018194661281);
    AssertAlmostEqual(&test, rTM, 0.9457018194661808);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9457018194635153);
    AssertAlmostEqual(&test, rTM, 0.9457018194687936);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9457018192022399);
    AssertAlmostEqual(&test, rTM, 0.9457018197300689);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9457017930747136);
    AssertAlmostEqual(&test, rTM, 0.9457018458575829);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9456991803910771);
    AssertAlmostEqual(&test, rTM, 0.9457044584165492);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9454385986458259);
    AssertAlmostEqual(&test, rTM, 0.9459638057004233);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9240931384446796);
    AssertAlmostEqual(&test, rTM, 0.9612828596721197);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5746327576786776);
    AssertAlmostEqual(&test, rTM, 0.9942507263092221);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03016713306384002);
    AssertAlmostEqual(&test, rTM, 0.9983468979789986);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003205566268126553);
    AssertAlmostEqual(&test, rTM, 0.9984426432683385);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.207604985735386e-06);
    AssertAlmostEqual(&test, rTM, 0.9984436306370723);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5762472029459507);
    AssertAlmostEqual(&test, rTM, 0.5762472029459507);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5762472029459506);
    AssertAlmostEqual(&test, rTM, 0.5762472029459507);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5762472029459491);
    AssertAlmostEqual(&test, rTM, 0.5762472029459522);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5762472029457957);
    AssertAlmostEqual(&test, rTM, 0.5762472029461055);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5762472029304589);
    AssertAlmostEqual(&test, rTM, 0.5762472029614423);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5762472013967878);
    AssertAlmostEqual(&test, rTM, 0.5762472044951135);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.576247048029726);
    AssertAlmostEqual(&test, rTM, 0.5762473578621339);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5762317119407364);
    AssertAlmostEqual(&test, rTM, 0.576262693537118);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5747042420301537);
    AssertAlmostEqual(&test, rTM, 0.5777860669455145);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4628909222836072);
    AssertAlmostEqual(&test, rTM, 0.6710591735412446);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02990156432638509);
    AssertAlmostEqual(&test, rTM, 0.8574785541178719);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003206724649553823);
    AssertAlmostEqual(&test, rTM, 0.8651158720861889);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.209079328469282e-06);
    AssertAlmostEqual(&test, rTM, 0.865195715859122);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03018436493669296);
    AssertAlmostEqual(&test, rTM, 0.03018436493669296);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03018436493669296);
    AssertAlmostEqual(&test, rTM, 0.03018436493669296);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03018436493669296);
    AssertAlmostEqual(&test, rTM, 0.03018436493669297);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03018436493669268);
    AssertAlmostEqual(&test, rTM, 0.03018436493669325);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03018436493666455);
    AssertAlmostEqual(&test, rTM, 0.03018436493672138);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03018436493385141);
    AssertAlmostEqual(&test, rTM, 0.03018436493953452);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03018436465253733);
    AssertAlmostEqual(&test, rTM, 0.03018436522084859);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03018433652115642);
    AssertAlmostEqual(&test, rTM, 0.03018439335222946);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03018152364808409);
    AssertAlmostEqual(&test, rTM, 0.03018720622481404);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0299028617686607);
    AssertAlmostEqual(&test, rTM, 0.03046586331658249);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.015551062738178);
    AssertAlmostEqual(&test, rTM, 0.04480473980767028);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003175458532397832);
    AssertAlmostEqual(&test, rTM, 0.0599973814781456);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.208909475480133e-06);
    AssertAlmostEqual(&test, rTM, 0.06031058100124806);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003207207520272697);
    AssertAlmostEqual(&test, rTM, 0.0003207207520272697);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003207207520272697);
    AssertAlmostEqual(&test, rTM, 0.0003207207520272697);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003207207520272697);
    AssertAlmostEqual(&test, rTM, 0.0003207207520272697);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003207207520272696);
    AssertAlmostEqual(&test, rTM, 0.0003207207520272697);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003207207520272664);
    AssertAlmostEqual(&test, rTM, 0.0003207207520272729);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003207207520269492);
    AssertAlmostEqual(&test, rTM, 0.0003207207520275902);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003207207519952182);
    AssertAlmostEqual(&test, rTM, 0.0003207207520593212);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003207207488221188);
    AssertAlmostEqual(&test, rTM, 0.0003207207552324206);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003207204315124956);
    AssertAlmostEqual(&test, rTM, 0.0003207210725420438);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003206887037206072);
    AssertAlmostEqual(&test, rTM, 0.0003207528003339315);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003175473151066469);
    AssertAlmostEqual(&test, rTM, 0.0003238941889414327);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001604118110364418);
    AssertAlmostEqual(&test, rTM, 0.0004810296765337202);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.177470645293195e-06);
    AssertAlmostEqual(&test, rTM, 0.0006382639687303096);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.209246626151932e-06);
    AssertAlmostEqual(&test, rTM, 3.209246626151932e-06);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.209246626151932e-06);
    AssertAlmostEqual(&test, rTM, 3.209246626151932e-06);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.209246626151932e-06);
    AssertAlmostEqual(&test, rTM, 3.209246626151932e-06);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.209246626151932e-06);
    AssertAlmostEqual(&test, rTM, 3.209246626151932e-06);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.209246626151932e-06);
    AssertAlmostEqual(&test, rTM, 3.209246626151932e-06);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.2092466261519e-06);
    AssertAlmostEqual(&test, rTM, 3.209246626151964e-06);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.209246626148723e-06);
    AssertAlmostEqual(&test, rTM, 3.209246626155141e-06);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.209246625831009e-06);
    AssertAlmostEqual(&test, rTM, 3.209246626472855e-06);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.209246594059672e-06);
    AssertAlmostEqual(&test, rTM, 3.209246658244192e-06);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.209243416929114e-06);
    AssertAlmostEqual(&test, rTM, 3.209249835374751e-06);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.208925735638009e-06);
    AssertAlmostEqual(&test, rTM, 3.209567516665856e-06);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.177472109007044e-06);
    AssertAlmostEqual(&test, rTM, 3.241021143296814e-06);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.604628462712051e-06);
    AssertAlmostEqual(&test, rTM, 4.813864789575287e-06);

    userdata[0] = 7/CAPS_HBAR_EV; /* 7eV */
    userdata[1] = 0.001/CAPS_HBAR_EV; /* 0.001eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999994352193596);
    AssertAlmostEqual(&test, rTM, 0.9999997176096399);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999959864863748);
    AssertAlmostEqual(&test, rTM, 0.9999999602621624);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999600627674163);
    AssertAlmostEqual(&test, rTM, 0.9999999960065964);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996007192033048);
    AssertAlmostEqual(&test, rTM, 0.9999999996006399);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960143631175249);
    AssertAlmostEqual(&test, rTM, 0.9999999999600638);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9608534491428379);
    AssertAlmostEqual(&test, rTM, 0.9999999999960056);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6725001417127692);
    AssertAlmostEqual(&test, rTM, 0.9999999999995928);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0558878405790488);
    AssertAlmostEqual(&test, rTM, 0.9999999999999108);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006262187260304824);
    AssertAlmostEqual(&test, rTM, 0.9999999999999202);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.269959005954378e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999999203);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.270036845198403e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999999203);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.270037623603044e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999999999203);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.270037631387092e-12);
    AssertAlmostEqual(&test, rTM, 0.9999999999999203);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999987308026526);
    AssertAlmostEqual(&test, rTM, 0.999998743368955);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999982139921866);
    AssertAlmostEqual(&test, rTM, 0.9999991069956946);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999873080990139);
    AssertAlmostEqual(&test, rTM, 0.9999998743368245);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998737117243929);
    AssertAlmostEqual(&test, rTM, 0.9999999873716379);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9987378972110935);
    AssertAlmostEqual(&test, rTM, 0.999999998737101);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9874505002644256);
    AssertAlmostEqual(&test, rTM, 0.9999999998737076);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8814331109894846);
    AssertAlmostEqual(&test, rTM, 0.9999999999873459);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3038533340530111);
    AssertAlmostEqual(&test, rTM, 0.9999999999985064);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.006192514584686964);
    AssertAlmostEqual(&test, rTM, 0.9999999999991926);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.269141267267117e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999992024);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.269919521449505e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999992025);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.269927305211083e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999999992025);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.269927383048821e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999999992025);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999873588726098);
    AssertAlmostEqual(&test, rTM, 0.9999873588852509);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999873582468941);
    AssertAlmostEqual(&test, rTM, 0.9999873595109351);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999872958309544);
    AssertAlmostEqual(&test, rTM, 0.9999874216140152);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999821228019438);
    AssertAlmostEqual(&test, rTM, 0.999991061361022);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998729655721982);
    AssertAlmostEqual(&test, rTM, 0.9999987421542793);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9987366155258042);
    AssertAlmostEqual(&test, rTM, 0.9999998735942932);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9874384402651386);
    AssertAlmostEqual(&test, rTM, 0.9999999873585529);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8813257316084326);
    AssertAlmostEqual(&test, rTM, 0.9999999987333573);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3035399087424703);
    AssertAlmostEqual(&test, rTM, 0.999999999850454);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.006180707270288888);
    AssertAlmostEqual(&test, rTM, 0.9999999999191062);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.257040683338081e-05);
    AssertAlmostEqual(&test, rTM, 0.99999999992009);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.257815935937114e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999200999);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.257823689675808e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999999201);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999596765843255);
    AssertAlmostEqual(&test, rTM, 0.9999596765847287);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999596765643658);
    AssertAlmostEqual(&test, rTM, 0.9999596766046884);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999596745684474);
    AssertAlmostEqual(&test, rTM, 0.9999596786005061);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999594754730631);
    AssertAlmostEqual(&test, rTM, 0.9999598766979534);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999429745552025);
    AssertAlmostEqual(&test, rTM, 0.9999714868710963);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995948286260667);
    AssertAlmostEqual(&test, rTM, 0.9999959875972679);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9959754983679581);
    AssertAlmostEqual(&test, rTM, 0.9999995967771376);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9604805785683285);
    AssertAlmostEqual(&test, rTM, 0.9999999596675972);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6699454098288941);
    AssertAlmostEqual(&test, rTM, 0.9999999958864324);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05492843881155819);
    AssertAlmostEqual(&test, rTM, 0.9999999990924712);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006142344703017748);
    AssertAlmostEqual(&test, rTM, 0.9999999991859789);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.149821699325292e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999991869682);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.14989658421236e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999991869782);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.99986193414547);
    AssertAlmostEqual(&test, rTM, 0.9998619341454837);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998619341447865);
    AssertAlmostEqual(&test, rTM, 0.9998619341461671);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998619340764486);
    AssertAlmostEqual(&test, rTM, 0.999861934214505);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998619272428333);
    AssertAlmostEqual(&test, rTM, 0.9998619410477754);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998612455812291);
    AssertAlmostEqual(&test, rTM, 0.9998626192929818);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998047509795216);
    AssertAlmostEqual(&test, rTM, 0.9999023707237904);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9986133219773584);
    AssertAlmostEqual(&test, rTM, 0.9999862610766662);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9862867754815203);
    AssertAlmostEqual(&test, rTM, 0.9999986192832203);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8711283030720915);
    AssertAlmostEqual(&test, rTM, 0.999999861596036);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2754000660585549);
    AssertAlmostEqual(&test, rTM, 0.9999999832215948);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.005190950868847535);
    AssertAlmostEqual(&test, rTM, 0.999999990368113);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.244715176122211e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999904665939);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.245259857601452e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999904675839);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993138784822666);
    AssertAlmostEqual(&test, rTM, 0.9993138784822673);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993138784822326);
    AssertAlmostEqual(&test, rTM, 0.9993138784823012);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993138784788376);
    AssertAlmostEqual(&test, rTM, 0.9993138784856964);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999313878139324);
    AssertAlmostEqual(&test, rTM, 0.9993138788252097);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993138441888221);
    AssertAlmostEqual(&test, rTM, 0.9993139127739985);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993104575888192);
    AssertAlmostEqual(&test, rTM, 0.9993172824100928);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9990298155649111);
    AssertAlmostEqual(&test, rTM, 0.9995147900395516);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9931259461310014);
    AssertAlmostEqual(&test, rTM, 0.9999317068578228);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9336761207993369);
    AssertAlmostEqual(&test, rTM, 0.9999931327566611);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5098938256015952);
    AssertAlmostEqual(&test, rTM, 0.9999992743516848);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0203714842342355);
    AssertAlmostEqual(&test, rTM, 0.9999997546607943);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002121854099764437);
    AssertAlmostEqual(&test, rTM, 0.999999764357097);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.122745827485911e-06);
    AssertAlmostEqual(&test, rTM, 0.9999997644560759);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9942931866593688);
    AssertAlmostEqual(&test, rTM, 0.9942931866593688);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9942931866593659);
    AssertAlmostEqual(&test, rTM, 0.9942931866593717);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9942931866590843);
    AssertAlmostEqual(&test, rTM, 0.9942931866596534);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9942931866309164);
    AssertAlmostEqual(&test, rTM, 0.9942931866878212);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9942931838141281);
    AssertAlmostEqual(&test, rTM, 0.9942931895046081);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9942929021423781);
    AssertAlmostEqual(&test, rTM, 0.994293471162216);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9942648054281843);
    AssertAlmostEqual(&test, rTM, 0.9943214278428761);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.991938907650199);
    AssertAlmostEqual(&test, rTM, 0.9959612817670797);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9441132106740268);
    AssertAlmostEqual(&test, rTM, 0.999430455032723);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5684693289443302);
    AssertAlmostEqual(&test, rTM, 0.9999404761852299);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02879696730251915);
    AssertAlmostEqual(&test, rTM, 0.9999826517689108);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003051139500900733);
    AssertAlmostEqual(&test, rTM, 0.9999836129499395);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.052983632552679e-06);
    AssertAlmostEqual(&test, rTM, 0.9999836228466454);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9455804551235049);
    AssertAlmostEqual(&test, rTM, 0.9455804551235049);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9455804551235045);
    AssertAlmostEqual(&test, rTM, 0.9455804551235051);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9455804551234783);
    AssertAlmostEqual(&test, rTM, 0.9455804551235313);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.94558045512086);
    AssertAlmostEqual(&test, rTM, 0.9455804551261496);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9455804548590179);
    AssertAlmostEqual(&test, rTM, 0.9455804553879917);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.94558042867482);
    AssertAlmostEqual(&test, rTM, 0.9455804815721772);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9455778103241844);
    AssertAlmostEqual(&test, rTM, 0.9455830997978888);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9453166634541539);
    AssertAlmostEqual(&test, rTM, 0.9458430096921961);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9239254949657026);
    AssertAlmostEqual(&test, rTM, 0.9611955585548506);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5739193708163429);
    AssertAlmostEqual(&test, rTM, 0.9942365995827745);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03003693685859715);
    AssertAlmostEqual(&test, rTM, 0.9983397314293954);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003190884181144257);
    AssertAlmostEqual(&test, rTM, 0.9984354886749883);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.192904276212532e-06);
    AssertAlmostEqual(&test, rTM, 0.9984364760345766);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.576175856595565);
    AssertAlmostEqual(&test, rTM, 0.576175856595565);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.576175856595565);
    AssertAlmostEqual(&test, rTM, 0.576175856595565);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5761758565955635);
    AssertAlmostEqual(&test, rTM, 0.5761758565955666);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5761758565954102);
    AssertAlmostEqual(&test, rTM, 0.57617585659572);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.576175856580072);
    AssertAlmostEqual(&test, rTM, 0.5761758566110581);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5761758550462631);
    AssertAlmostEqual(&test, rTM, 0.576175858144867);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5761757016654285);
    AssertAlmostEqual(&test, rTM, 0.5761760115256601);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5761603641992771);
    AssertAlmostEqual(&test, rTM, 0.5761913485778341);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5746327576786776);
    AssertAlmostEqual(&test, rTM, 0.5777148588732459);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4628126530764261);
    AssertAlmostEqual(&test, rTM, 0.6709964999861542);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02988859609883533);
    AssertAlmostEqual(&test, rTM, 0.8574254298933273);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000320524915215026);
    AssertAlmostEqual(&test, rTM, 0.8650621584052939);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.207601810229997e-06);
    AssertAlmostEqual(&test, rTM, 0.8651419949332563);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0301830560181707);
    AssertAlmostEqual(&test, rTM, 0.0301830560181707);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0301830560181707);
    AssertAlmostEqual(&test, rTM, 0.0301830560181707);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0301830560181707);
    AssertAlmostEqual(&test, rTM, 0.03018305601817071);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03018305601817042);
    AssertAlmostEqual(&test, rTM, 0.03018305601817099);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03018305601814229);
    AssertAlmostEqual(&test, rTM, 0.03018305601819912);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03018305601532927);
    AssertAlmostEqual(&test, rTM, 0.03018305602101215);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03018305573402665);
    AssertAlmostEqual(&test, rTM, 0.03018305630231476);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03018302760379192);
    AssertAlmostEqual(&test, rTM, 0.03018308443254944);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.030180214845328);
    AssertAlmostEqual(&test, rTM, 0.03018589719052567);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02990156432638509);
    AssertAlmostEqual(&test, rTM, 0.03046454292241195);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01555036834203616);
    AssertAlmostEqual(&test, rTM, 0.04480281801308732);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003175312353113997);
    AssertAlmostEqual(&test, rTM, 0.059994785250817);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.208761663421101e-06);
    AssertAlmostEqual(&test, rTM, 0.06030797045460841);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003207192755604824);
    AssertAlmostEqual(&test, rTM, 0.0003207192755604824);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003207192755604824);
    AssertAlmostEqual(&test, rTM, 0.0003207192755604824);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003207192755604824);
    AssertAlmostEqual(&test, rTM, 0.0003207192755604824);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003207192755604824);
    AssertAlmostEqual(&test, rTM, 0.0003207192755604824);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003207192755604792);
    AssertAlmostEqual(&test, rTM, 0.0003207192755604856);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003207192755601619);
    AssertAlmostEqual(&test, rTM, 0.0003207192755608029);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000320719275528431);
    AssertAlmostEqual(&test, rTM, 0.0003207192755925338);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003207192723553462);
    AssertAlmostEqual(&test, rTM, 0.0003207192787656186);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003207189550471829);
    AssertAlmostEqual(&test, rTM, 0.0003207195960737819);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003206872274012625);
    AssertAlmostEqual(&test, rTM, 0.0003207513237197016);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003175458532397833);
    AssertAlmostEqual(&test, rTM, 0.0003238926978747219);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001604110723294588);
    AssertAlmostEqual(&test, rTM, 0.0004810274623073563);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.177456008228888e-06);
    AssertAlmostEqual(&test, rTM, 0.0006382610304346927);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.209245147801134e-06);
    AssertAlmostEqual(&test, rTM, 3.209245147801134e-06);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.209245147801134e-06);
    AssertAlmostEqual(&test, rTM, 3.209245147801134e-06);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.209245147801134e-06);
    AssertAlmostEqual(&test, rTM, 3.209245147801134e-06);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.209245147801134e-06);
    AssertAlmostEqual(&test, rTM, 3.209245147801134e-06);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.209245147801134e-06);
    AssertAlmostEqual(&test, rTM, 3.209245147801134e-06);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.209245147801102e-06);
    AssertAlmostEqual(&test, rTM, 3.209245147801166e-06);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.209245147797925e-06);
    AssertAlmostEqual(&test, rTM, 3.209245147804343e-06);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.209245147480211e-06);
    AssertAlmostEqual(&test, rTM, 3.209245148122057e-06);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.209245115708889e-06);
    AssertAlmostEqual(&test, rTM, 3.209245179893379e-06);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.209241938579794e-06);
    AssertAlmostEqual(&test, rTM, 3.209248357022474e-06);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.208924257435029e-06);
    AssertAlmostEqual(&test, rTM, 3.209566038167239e-06);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.177470645293196e-06);
    AssertAlmostEqual(&test, rTM, 3.241019650309066e-06);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.604627723531908e-06);
    AssertAlmostEqual(&test, rTM, 4.813862572053834e-06);

    userdata[0] = 7/CAPS_HBAR_EV; /* 7eV */
    userdata[1] = 0.003/CAPS_HBAR_EV; /* 0.003eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999999021772075);
    AssertAlmostEqual(&test, rTM, 0.9999995108859179);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999930484052236);
    AssertAlmostEqual(&test, rTM, 0.9999999311720921);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999930827740289);
    AssertAlmostEqual(&test, rTM, 0.9999999930832265);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993085269080889);
    AssertAlmostEqual(&test, rTM, 0.9999999993082883);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.993106762489714);
    AssertAlmostEqual(&test, rTM, 0.9999999999308284);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9331797755923037);
    AssertAlmostEqual(&test, rTM, 0.9999999999930788);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5073189843809971);
    AssertAlmostEqual(&test, rTM, 0.9999999999992681);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02006965341316063);
    AssertAlmostEqual(&test, rTM, 0.999999999999751);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002089142089484071);
    AssertAlmostEqual(&test, rTM, 0.9999999999997606);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.09000652975506e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999997607);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.090015178673765e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999997607);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.090015265163404e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999999997607);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.090015266028301e-12);
    AssertAlmostEqual(&test, rTM, 0.9999999999997607);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999978017010468);
    AssertAlmostEqual(&test, rTM, 0.9999978234663592);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999969065658924);
    AssertAlmostEqual(&test, rTM, 0.99999845328175);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999780172279299);
    AssertAlmostEqual(&test, rTM, 0.9999997823464227);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997812738260133);
    AssertAlmostEqual(&test, rTM, 0.9999999781271776);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9978149983235305);
    AssertAlmostEqual(&test, rTM, 0.9999999978126082);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9783640096103201);
    AssertAlmostEqual(&test, rTM, 0.9999999997812478);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8038798909496417);
    AssertAlmostEqual(&test, rTM, 0.9999999999779956);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1507399335670981);
    AssertAlmostEqual(&test, rTM, 0.9999999999967584);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002081312172290816);
    AssertAlmostEqual(&test, rTM, 0.9999999999975977);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.08991565843706e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999976076);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.090002142502727e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999976077);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.090003007388566e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999999976077);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.09000301603743e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999999976077);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999781192620455);
    AssertAlmostEqual(&test, rTM, 0.999978119283926);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999781181789887);
    AssertAlmostEqual(&test, rTM, 0.9999781203669281);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999780101427006);
    AssertAlmostEqual(&test, rTM, 0.9999782278616899);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999690561193305);
    AssertAlmostEqual(&test, rTM, 0.9999845279399721);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997801231860912);
    AssertAlmostEqual(&test, rTM, 0.9999978227648246);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9978141867709116);
    AssertAlmostEqual(&test, rTM, 0.9999997812011686);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9783571017681187);
    AssertAlmostEqual(&test, rTM, 0.9999999781177353);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8038235528075957);
    AssertAlmostEqual(&test, rTM, 0.9999999977988472);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1506682438751776);
    AssertAlmostEqual(&test, rTM, 0.9999999996756784);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002079976724630351);
    AssertAlmostEqual(&test, rTM, 0.9999999997596137);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.088569156719186e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999997606016);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.08865552937825e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999997606116);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.088656393149937e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999997606116);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999306063651938);
    AssertAlmostEqual(&test, rTM, 0.9999306063658877);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999306063308452);
    AssertAlmostEqual(&test, rTM, 0.9999306064002363);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999306028960662);
    AssertAlmostEqual(&test, rTM, 0.9999306098348418);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999302602725477);
    AssertAlmostEqual(&test, rTM, 0.999930950741059);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999018639914645);
    AssertAlmostEqual(&test, rTM, 0.9999509307918092);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993028215620944);
    AssertAlmostEqual(&test, rTM, 0.9999930948591326);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9930840884766193);
    AssertAlmostEqual(&test, rTM, 0.9999993060703362);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9329700684603097);
    AssertAlmostEqual(&test, rTM, 0.9999999305622327);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5062422699547721);
    AssertAlmostEqual(&test, rTM, 0.9999999926545174);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01994488748191292);
    AssertAlmostEqual(&test, rTM, 0.9999999974940892);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002075631666354515);
    AssertAlmostEqual(&test, rTM, 0.9999999975910948);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.076484960457272e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999975920847);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.076493497827227e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999975920946);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997742767583011);
    AssertAlmostEqual(&test, rTM, 0.9997742767583236);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997742767571839);
    AssertAlmostEqual(&test, rTM, 0.9997742767594409);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997742766454636);
    AssertAlmostEqual(&test, rTM, 0.9997742768711612);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997742654737064);
    AssertAlmostEqual(&test, rTM, 0.9997742880423544);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999773151077333);
    AssertAlmostEqual(&test, rTM, 0.9997753968540092);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996807940547952);
    AssertAlmostEqual(&test, rTM, 0.9998403842877932);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9977338255731681);
    AssertAlmostEqual(&test, rTM, 0.9999775374007679);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9776773987835242);
    AssertAlmostEqual(&test, rTM, 0.9999977424844164);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7982988936995874);
    AssertAlmostEqual(&test, rTM, 0.9999997728178814);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1438349402554764);
    AssertAlmostEqual(&test, rTM, 0.9999999659571078);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001954564590114138);
    AssertAlmostEqual(&test, rTM, 0.9999999744189535);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.962150692534151e-05);
    AssertAlmostEqual(&test, rTM, 0.999999974517758);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.962226925442134e-07);
    AssertAlmostEqual(&test, rTM, 0.999999974518748);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991115402377667);
    AssertAlmostEqual(&test, rTM, 0.9991115402377676);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991115402377228);
    AssertAlmostEqual(&test, rTM, 0.9991115402378116);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991115402333268);
    AssertAlmostEqual(&test, rTM, 0.9991115402422075);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991115397937348);
    AssertAlmostEqual(&test, rTM, 0.9991115406817993);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991114958356329);
    AssertAlmostEqual(&test, rTM, 0.9991115846376835);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991071109687069);
    AssertAlmostEqual(&test, rTM, 0.9991159475446934);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9987437594344897);
    AssertAlmostEqual(&test, rTM, 0.9993716822636631);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9911069298263224);
    AssertAlmostEqual(&test, rTM, 0.9999115586974908);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9149730425082003);
    AssertAlmostEqual(&test, rTM, 0.9999911031644256);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4223480530824856);
    AssertAlmostEqual(&test, rTM, 0.9999990273179519);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01234660531469829);
    AssertAlmostEqual(&test, rTM, 0.9999995950922841);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001265402037928112);
    AssertAlmostEqual(&test, rTM, 0.9999996048688248);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.265719143217671e-06);
    AssertAlmostEqual(&test, rTM, 0.999999604967812);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9940225795219561);
    AssertAlmostEqual(&test, rTM, 0.9940225795219562);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9940225795219532);
    AssertAlmostEqual(&test, rTM, 0.9940225795219592);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9940225795216582);
    AssertAlmostEqual(&test, rTM, 0.9940225795222541);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9940225794921587);
    AssertAlmostEqual(&test, rTM, 0.9940225795517537);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9940225765422058);
    AssertAlmostEqual(&test, rTM, 0.9940225825017049);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9940222815543425);
    AssertAlmostEqual(&test, rTM, 0.9940228774747617);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.993992856579897);
    AssertAlmostEqual(&test, rTM, 0.9940521558355786);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9915571406709107);
    AssertAlmostEqual(&test, rTM, 0.9957696033208165);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9415351763223339);
    AssertAlmostEqual(&test, rTM, 0.9994033515653512);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5538114940539488);
    AssertAlmostEqual(&test, rTM, 0.9999374159264801);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0263726477063508);
    AssertAlmostEqual(&test, rTM, 0.9999810545181231);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002780526791530025);
    AssertAlmostEqual(&test, rTM, 0.9999820181208314);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.782058250313643e-06);
    AssertAlmostEqual(&test, rTM, 0.9999820280177841);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9453118045828798);
    AssertAlmostEqual(&test, rTM, 0.9453118045828798);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9453118045828794);
    AssertAlmostEqual(&test, rTM, 0.94531180458288);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9453118045828531);
    AssertAlmostEqual(&test, rTM, 0.9453118045829063);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9453118045802222);
    AssertAlmostEqual(&test, rTM, 0.9453118045855373);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.945311804317126);
    AssertAlmostEqual(&test, rTM, 0.9453118048486335);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9453117780075087);
    AssertAlmostEqual(&test, rTM, 0.9453118311582382);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9453091471152942);
    AssertAlmostEqual(&test, rTM, 0.9453144619249669);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9450467495747211);
    AssertAlmostEqual(&test, rTM, 0.9455756169279719);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9235544342543077);
    AssertAlmostEqual(&test, rTM, 0.9610022971657379);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5723434717613067);
    AssertAlmostEqual(&test, rTM, 0.9942053004442105);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02975160078158083);
    AssertAlmostEqual(&test, rTM, 0.9983238065294978);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003158733989028828);
    AssertAlmostEqual(&test, rTM, 0.9984195899458009);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.160713603814872e-06);
    AssertAlmostEqual(&test, rTM, 0.998420577285019);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5760174037846879);
    AssertAlmostEqual(&test, rTM, 0.5760174037846879);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5760174037846879);
    AssertAlmostEqual(&test, rTM, 0.576017403784688);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5760174037846864);
    AssertAlmostEqual(&test, rTM, 0.5760174037846895);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.576017403784533);
    AssertAlmostEqual(&test, rTM, 0.5760174037848429);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5760174037691919);
    AssertAlmostEqual(&test, rTM, 0.5760174038001841);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5760174022350771);
    AssertAlmostEqual(&test, rTM, 0.5760174053342987);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5760172488236733);
    AssertAlmostEqual(&test, rTM, 0.5760175587456612);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.57600190830083);
    AssertAlmostEqual(&test, rTM, 0.5760328988545889);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5744739985676323);
    AssertAlmostEqual(&test, rTM, 0.5775567129787175);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4626388420306072);
    AssertAlmostEqual(&test, rTM, 0.6708572962008319);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02985981808517949);
    AssertAlmostEqual(&test, rTM, 0.8573073999192264);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003201975125430759);
    AssertAlmostEqual(&test, rTM, 0.8649428185469444);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.20432330249934e-06);
    AssertAlmostEqual(&test, rTM, 0.8650226389791733);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03018014771710517);
    AssertAlmostEqual(&test, rTM, 0.03018014771710517);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03018014771710517);
    AssertAlmostEqual(&test, rTM, 0.03018014771710517);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03018014771710516);
    AssertAlmostEqual(&test, rTM, 0.03018014771710517);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03018014771710488);
    AssertAlmostEqual(&test, rTM, 0.03018014771710545);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03018014771707676);
    AssertAlmostEqual(&test, rTM, 0.03018014771713358);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03018014771426399);
    AssertAlmostEqual(&test, rTM, 0.03018014771994635);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03018014743298684);
    AssertAlmostEqual(&test, rTM, 0.0301801480012235);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03018011930529886);
    AssertAlmostEqual(&test, rTM, 0.03018017612891143);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03017730680148688);
    AssertAlmostEqual(&test, rTM, 0.03018298863223585);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02989868152474395);
    AssertAlmostEqual(&test, rTM, 0.03046160912325141);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01554882546155315);
    AssertAlmostEqual(&test, rTM, 0.04479854794892666);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.00031749875584407);
    AssertAlmostEqual(&test, rTM, 0.05998901666112082);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.208433240927256e-06);
    AssertAlmostEqual(&test, rTM, 0.06030217004889477);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003207159945718471);
    AssertAlmostEqual(&test, rTM, 0.0003207159945718471);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003207159945718471);
    AssertAlmostEqual(&test, rTM, 0.0003207159945718471);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003207159945718471);
    AssertAlmostEqual(&test, rTM, 0.0003207159945718471);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000320715994571847);
    AssertAlmostEqual(&test, rTM, 0.0003207159945718471);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003207159945718439);
    AssertAlmostEqual(&test, rTM, 0.0003207159945718503);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003207159945715265);
    AssertAlmostEqual(&test, rTM, 0.0003207159945721676);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000320715994539796);
    AssertAlmostEqual(&test, rTM, 0.0003207159946038981);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003207159913667437);
    AssertAlmostEqual(&test, rTM, 0.0003207159977769505);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003207156740618243);
    AssertAlmostEqual(&test, rTM, 0.0003207163150818698);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003206839467402727);
    AssertAlmostEqual(&test, rTM, 0.0003207480424034208);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003175426046949418);
    AssertAlmostEqual(&test, rTM, 0.0003238893844422928);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001604094307827437);
    AssertAlmostEqual(&test, rTM, 0.0004810225418773065);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.177423481902114e-06);
    AssertAlmostEqual(&test, rTM, 0.0006382545009857338);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.209241862582014e-06);
    AssertAlmostEqual(&test, rTM, 3.209241862582014e-06);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.209241862582014e-06);
    AssertAlmostEqual(&test, rTM, 3.209241862582014e-06);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.209241862582014e-06);
    AssertAlmostEqual(&test, rTM, 3.209241862582014e-06);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.209241862582014e-06);
    AssertAlmostEqual(&test, rTM, 3.209241862582014e-06);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.209241862582014e-06);
    AssertAlmostEqual(&test, rTM, 3.209241862582015e-06);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.209241862581982e-06);
    AssertAlmostEqual(&test, rTM, 3.209241862582046e-06);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.209241862578805e-06);
    AssertAlmostEqual(&test, rTM, 3.209241862585224e-06);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.209241862261092e-06);
    AssertAlmostEqual(&test, rTM, 3.209241862902936e-06);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.209241830489802e-06);
    AssertAlmostEqual(&test, rTM, 3.209241894674227e-06);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.20923865336396e-06);
    AssertAlmostEqual(&test, rTM, 3.209245071800069e-06);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.208920972544394e-06);
    AssertAlmostEqual(&test, rTM, 3.209562752619635e-06);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.177467392600585e-06);
    AssertAlmostEqual(&test, rTM, 3.241016332563438e-06);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.604626080911805e-06);
    AssertAlmostEqual(&test, rTM, 4.813857644235698e-06);

    userdata[0] = 7/CAPS_HBAR_EV; /* 7eV */
    userdata[1] = 0.035/CAPS_HBAR_EV; /* 0.035eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999966587204808);
    AssertAlmostEqual(&test, rTM, 0.9999983293588449);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999762559899598);
    AssertAlmostEqual(&test, rTM, 0.9999997649080282);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997637515633786);
    AssertAlmostEqual(&test, rTM, 0.9999999763747278);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.99764014286646);
    AssertAlmostEqual(&test, rTM, 0.9999999976373541);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9766510025023077);
    AssertAlmostEqual(&test, rTM, 0.999999999763719);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7900030784689658);
    AssertAlmostEqual(&test, rTM, 0.9999999999762093);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1342673743557406);
    AssertAlmostEqual(&test, rTM, 0.9999999999963433);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001785052791876975);
    AssertAlmostEqual(&test, rTM, 0.999999999997199);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.791378540802937e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999972089);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.791442081415968e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999972089);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.791442716850553e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999999972089);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.791442723204902e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999999972089);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.791442723268445e-13);
    AssertAlmostEqual(&test, rTM, 0.9999999999972089);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999924914219094);
    AssertAlmostEqual(&test, rTM, 0.9999925657639904);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999894339819347);
    AssertAlmostEqual(&test, rTM, 0.9999947169770121);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999249167561042);
    AssertAlmostEqual(&test, rTM, 0.9999992565739114);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9992531074752481);
    AssertAlmostEqual(&test, rTM, 0.999999925290308);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.992556512144126);
    AssertAlmostEqual(&test, rTM, 0.9999999925286092);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9280255086216577);
    AssertAlmostEqual(&test, rTM, 0.9999999992523446);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4815403304624257);
    AssertAlmostEqual(&test, rTM, 0.9999999999202436);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01729994297582477);
    AssertAlmostEqual(&test, rTM, 0.9999999999711068);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001790800257824747);
    AssertAlmostEqual(&test, rTM, 0.9999999999720796);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.791435404770773e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999720894);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.791441759084366e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999720895);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.791441822627787e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999999720895);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.791441823263221e-12);
    AssertAlmostEqual(&test, rTM, 0.9999999999720895);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999252872644375);
    AssertAlmostEqual(&test, rTM, 0.9999252873391474);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999252835663905);
    AssertAlmostEqual(&test, rTM, 0.9999252910370078);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999249146815599);
    AssertAlmostEqual(&test, rTM, 0.9999256580729197);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998943419238882);
    AssertAlmostEqual(&test, rTM, 0.9999471695663799);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9992494004834849);
    AssertAlmostEqual(&test, rTM, 0.9999925655580624);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9925559401649441);
    AssertAlmostEqual(&test, rTM, 0.9999992528775277);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9280235598414132);
    AssertAlmostEqual(&test, rTM, 0.9999999252324325);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4815310165311263);
    AssertAlmostEqual(&test, rTM, 0.9999999920241081);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01729901949853214);
    AssertAlmostEqual(&test, rTM, 0.9999999971105278);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001790701334291713);
    AssertAlmostEqual(&test, rTM, 0.999999997207798);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.791336411061325e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999972087878);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.791342764672683e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999972087977);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.791342828209081e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999972087978);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997636974611832);
    AssertAlmostEqual(&test, rTM, 0.999763697463546);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997636973442273);
    AssertAlmostEqual(&test, rTM, 0.9997636975805019);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997636856489293);
    AssertAlmostEqual(&test, rTM, 0.9997637092752094);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997625190287419);
    AssertAlmostEqual(&test, rTM, 0.999764870049024);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996658341028171);
    AssertAlmostEqual(&test, rTM, 0.9998329030895535);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9976277271067793);
    AssertAlmostEqual(&test, rTM, 0.9999764845003494);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9766434104031873);
    AssertAlmostEqual(&test, rTM, 0.999997636651365);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7899512649005515);
    AssertAlmostEqual(&test, rTM, 0.9999997620254629);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1342101986090577);
    AssertAlmostEqual(&test, rTM, 0.9999999634160596);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001784060560895073);
    AssertAlmostEqual(&test, rTM, 0.9999999719741356);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.790379270284776e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999720729572);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.790442740029702e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999720739471);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.790443374755558e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999720739571);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9992510641852234);
    AssertAlmostEqual(&test, rTM, 0.9992510641852982);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9992510641815174);
    AssertAlmostEqual(&test, rTM, 0.999251064189004);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9992510638109332);
    AssertAlmostEqual(&test, rTM, 0.9992510645595881);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9992510267534344);
    AssertAlmostEqual(&test, rTM, 0.9992511016152171);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9992473302276424);
    AssertAlmostEqual(&test, rTM, 0.9992547796258043);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9989410091474643);
    AssertAlmostEqual(&test, rTM, 0.9994703642796012);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9924987616831081);
    AssertAlmostEqual(&test, rTM, 0.9999254524403032);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9278289597371534);
    AssertAlmostEqual(&test, rTM, 0.9999925029841411);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4806019839141525);
    AssertAlmostEqual(&test, rTM, 0.9999991999403101);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01720716715653279);
    AssertAlmostEqual(&test, rTM, 0.9999997095095291);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001780863869447012);
    AssertAlmostEqual(&test, rTM, 0.999999719237471);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.781491986882579e-06);
    AssertAlmostEqual(&test, rTM, 0.9999997193364532);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.78149827085398e-08);
    AssertAlmostEqual(&test, rTM, 0.9999997193374431);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9975752526652576);
    AssertAlmostEqual(&test, rTM, 0.9975752526652599);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9975752526651377);
    AssertAlmostEqual(&test, rTM, 0.9975752526653798);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9975752526531497);
    AssertAlmostEqual(&test, rTM, 0.9975752526773678);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.997575251454357);
    AssertAlmostEqual(&test, rTM, 0.9975752538761599);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9975751315780899);
    AssertAlmostEqual(&test, rTM, 0.9975753737463884);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9975631738402247);
    AssertAlmostEqual(&test, rTM, 0.9975872716904615);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9965726131264874);
    AssertAlmostEqual(&test, rTM, 0.9982848344064078);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9758978094471048);
    AssertAlmostEqual(&test, rTM, 0.9997584471381666);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7849077862071491);
    AssertAlmostEqual(&test, rTM, 0.9999755464191775);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1287844638420024);
    AssertAlmostEqual(&test, rTM, 0.9999961819530758);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001690996299729325);
    AssertAlmostEqual(&test, rTM, 0.9999970431804645);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.696672216928217e-05);
    AssertAlmostEqual(&test, rTM, 0.9999970530635124);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.696729216715568e-07);
    AssertAlmostEqual(&test, rTM, 0.9999970531625102);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9907170452314058);
    AssertAlmostEqual(&test, rTM, 0.9907170452314059);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9907170452314012);
    AssertAlmostEqual(&test, rTM, 0.9907170452314105);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9907170452309438);
    AssertAlmostEqual(&test, rTM, 0.9907170452318678);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9907170451852075);
    AssertAlmostEqual(&test, rTM, 0.9907170452776042);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9907170406115734);
    AssertAlmostEqual(&test, rTM, 0.990717049851236);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9907165832597015);
    AssertAlmostEqual(&test, rTM, 0.9907175071802282);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9906709628914983);
    AssertAlmostEqual(&test, rTM, 0.990762900996138);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9868972521197542);
    AssertAlmostEqual(&test, rTM, 0.9934269528254304);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9105610605573158);
    AssertAlmostEqual(&test, rTM, 0.9990714271280055);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4058343568504773);
    AssertAlmostEqual(&test, rTM, 0.9998971065645902);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01123980257987386);
    AssertAlmostEqual(&test, rTM, 0.9999555228535968);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001149416214373434);
    AssertAlmostEqual(&test, rTM, 0.99995650154962);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.149677859322907e-06);
    AssertAlmostEqual(&test, rTM, 0.9999565114478248);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9411942023937467);
    AssertAlmostEqual(&test, rTM, 0.9411942023937467);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9411942023937464);
    AssertAlmostEqual(&test, rTM, 0.941194202393747);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9411942023937182);
    AssertAlmostEqual(&test, rTM, 0.9411942023937752);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9411942023908955);
    AssertAlmostEqual(&test, rTM, 0.9411942023965979);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9411942021086249);
    AssertAlmostEqual(&test, rTM, 0.9411942026788684);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9411941738815757);
    AssertAlmostEqual(&test, rTM, 0.9411942309059044);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9411913512515486);
    AssertAlmostEqual(&test, rTM, 0.9411970534019038);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.940909833490128);
    AssertAlmostEqual(&test, rTM, 0.9414772440478795);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.917872844403831);
    AssertAlmostEqual(&test, rTM, 0.9580379731950919);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5487417078792252);
    AssertAlmostEqual(&test, rTM, 0.9937205673552814);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02582664652637971);
    AssertAlmostEqual(&test, rTM, 0.9980691409999792);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002720208622222636);
    AssertAlmostEqual(&test, rTM, 0.9981652791298842);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.721677012639979e-06);
    AssertAlmostEqual(&test, rTM, 0.9981662661357285);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5734997428588701);
    AssertAlmostEqual(&test, rTM, 0.5734997428588701);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5734997428588701);
    AssertAlmostEqual(&test, rTM, 0.5734997428588701);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5734997428588685);
    AssertAlmostEqual(&test, rTM, 0.5734997428588716);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5734997428587146);
    AssertAlmostEqual(&test, rTM, 0.5734997428590255);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5734997428433252);
    AssertAlmostEqual(&test, rTM, 0.5734997428744149);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5734997413043875);
    AssertAlmostEqual(&test, rTM, 0.5734997444133526);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5734995874106787);
    AssertAlmostEqual(&test, rTM, 0.57349989830702);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5734841986612749);
    AssertAlmostEqual(&test, rTM, 0.5735152866435106);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5719515052834656);
    AssertAlmostEqual(&test, rTM, 0.5750438943740355);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4598802477735532);
    AssertAlmostEqual(&test, rTM, 0.6686431933387508);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0294067987106366);
    AssertAlmostEqual(&test, rTM, 0.8554233840362891);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003150485714647672);
    AssertAlmostEqual(&test, rTM, 0.8630378490453967);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.152763979656829e-06);
    AssertAlmostEqual(&test, rTM, 0.8631174127317257);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03013369107461131);
    AssertAlmostEqual(&test, rTM, 0.03013369107461131);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03013369107461131);
    AssertAlmostEqual(&test, rTM, 0.03013369107461131);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03013369107461131);
    AssertAlmostEqual(&test, rTM, 0.03013369107461131);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03013369107461103);
    AssertAlmostEqual(&test, rTM, 0.0301336910746116);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03013369107458294);
    AssertAlmostEqual(&test, rTM, 0.03013369107463968);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03013369107177424);
    AssertAlmostEqual(&test, rTM, 0.03013369107744839);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03013369079090395);
    AssertAlmostEqual(&test, rTM, 0.03013369135831868);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03013366270390132);
    AssertAlmostEqual(&test, rTM, 0.03013371944532125);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.030130854268266);
    AssertAlmostEqual(&test, rTM, 0.03013652788047118);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02985263224637144);
    AssertAlmostEqual(&test, rTM, 0.03041474513783958);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01552418095613198);
    AssertAlmostEqual(&test, rTM, 0.0447303375019283);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003169799865403767);
    AssertAlmostEqual(&test, rTM, 0.05989686986142789);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.203187609256298e-06);
    AssertAlmostEqual(&test, rTM, 0.06020951506811281);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000320663507881821);
    AssertAlmostEqual(&test, rTM, 0.000320663507881821);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000320663507881821);
    AssertAlmostEqual(&test, rTM, 0.000320663507881821);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000320663507881821);
    AssertAlmostEqual(&test, rTM, 0.000320663507881821);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000320663507881821);
    AssertAlmostEqual(&test, rTM, 0.0003206635078818211);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003206635078818178);
    AssertAlmostEqual(&test, rTM, 0.0003206635078818243);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003206635078815006);
    AssertAlmostEqual(&test, rTM, 0.0003206635078821415);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003206635078497753);
    AssertAlmostEqual(&test, rTM, 0.0003206635079138668);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003206635046772418);
    AssertAlmostEqual(&test, rTM, 0.0003206635110864003);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003206631874242176);
    AssertAlmostEqual(&test, rTM, 0.0003206638283394244);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003206314652916626);
    AssertAlmostEqual(&test, rTM, 0.0003206955504719788);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000317490637015412);
    AssertAlmostEqual(&test, rTM, 0.0003238363787417737);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001603831706037638);
    AssertAlmostEqual(&test, rTM, 0.0004809438286843242);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.17690315122369e-06);
    AssertAlmostEqual(&test, rTM, 0.0006381500479681084);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.209189299990819e-06);
    AssertAlmostEqual(&test, rTM, 3.209189299990819e-06);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.209189299990819e-06);
    AssertAlmostEqual(&test, rTM, 3.209189299990819e-06);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.209189299990819e-06);
    AssertAlmostEqual(&test, rTM, 3.209189299990819e-06);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.209189299990819e-06);
    AssertAlmostEqual(&test, rTM, 3.209189299990819e-06);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.209189299990819e-06);
    AssertAlmostEqual(&test, rTM, 3.20918929999082e-06);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.209189299990787e-06);
    AssertAlmostEqual(&test, rTM, 3.209189299990851e-06);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.20918929998761e-06);
    AssertAlmostEqual(&test, rTM, 3.209189299994029e-06);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.209189299669903e-06);
    AssertAlmostEqual(&test, rTM, 3.209189300311736e-06);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.209189267899133e-06);
    AssertAlmostEqual(&test, rTM, 3.209189332082506e-06);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.209186090825326e-06);
    AssertAlmostEqual(&test, rTM, 3.209192509156312e-06);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.208868415208865e-06);
    AssertAlmostEqual(&test, rTM, 3.209510184772774e-06);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.17741535042447e-06);
    AssertAlmostEqual(&test, rTM, 3.240963249557162e-06);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.604599799447523e-06);
    AssertAlmostEqual(&test, rTM, 4.813778800517591e-06);

    userdata[0] = 7/CAPS_HBAR_EV; /* 7eV */
    userdata[1] = 0.05/CAPS_HBAR_EV; /* 0.05eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999960064084629);
    AssertAlmostEqual(&test, rTM, 0.9999980032022379);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999716205459147);
    AssertAlmostEqual(&test, rTM, 0.9999997190113583);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997176356245168);
    AssertAlmostEqual(&test, rTM, 0.999999971762399);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.997180081690485);
    AssertAlmostEqual(&test, rTM, 0.9999999971760973);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9721568930987151);
    AssertAlmostEqual(&test, rTM, 0.9999999997175817);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7546809829139894);
    AssertAlmostEqual(&test, rTM, 0.9999999999714809);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1012849662798365);
    AssertAlmostEqual(&test, rTM, 0.9999999999951141);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001250874670911699);
    AssertAlmostEqual(&test, rTM, 0.9999999999960028);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.25397847745636e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999960127);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.254009612780278e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999960127);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.254009924143277e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999999960127);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.254009927256908e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999999960127);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.254009927288044e-13);
    AssertAlmostEqual(&test, rTM, 0.9999999999960127);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.99999102553998);
    AssertAlmostEqual(&test, rTM, 0.9999911143956249);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999873712070044);
    AssertAlmostEqual(&test, rTM, 0.9999936855835662);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999102590240845);
    AssertAlmostEqual(&test, rTM, 0.9999991114360086);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991073578679311);
    AssertAlmostEqual(&test, rTM, 0.9999999107048442);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9911098171148892);
    AssertAlmostEqual(&test, rTM, 0.999999991069954);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.914598624955658);
    AssertAlmostEqual(&test, rTM, 0.9999999991061141);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4207534688486005);
    AssertAlmostEqual(&test, rTM, 0.9999999999022032);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01223511313126213);
    AssertAlmostEqual(&test, rTM, 0.9999999999591401);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001253695076894579);
    AssertAlmostEqual(&test, rTM, 0.9999999999601179);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.254006341218825e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999601278);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.254009454837754e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999601279);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.254009485974041e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999999601279);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.254009486285404e-12);
    AssertAlmostEqual(&test, rTM, 0.9999999999601279);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999107025998889);
    AssertAlmostEqual(&test, rTM, 0.9999107026891823);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999106981799788);
    AssertAlmostEqual(&test, rTM, 0.9999107071088692);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999102572884143);
    AssertAlmostEqual(&test, rTM, 0.999911145790636);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998737168044366);
    AssertAlmostEqual(&test, rTM, 0.9999368564085988);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991029352461586);
    AssertAlmostEqual(&test, rTM, 0.9999911142228856);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.991109207834689);
    AssertAlmostEqual(&test, rTM, 0.9999991070227181);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9145970064353881);
    AssertAlmostEqual(&test, rTM, 0.9999999106097311);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4207468313362054);
    AssertAlmostEqual(&test, rTM, 0.9999999902201036);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01223465128758379);
    AssertAlmostEqual(&test, rTM, 0.9999999959138586);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001253646593127663);
    AssertAlmostEqual(&test, rTM, 0.9999999960116353);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.253957833376517e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999960126251);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.253960946754578e-08);
    AssertAlmostEqual(&test, rTM, 0.999999996012635);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.253960977888456e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999960126351);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997175945932787);
    AssertAlmostEqual(&test, rTM, 0.9997175945961024);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997175944535078);
    AssertAlmostEqual(&test, rTM, 0.9997175947358732);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997175804767674);
    AssertAlmostEqual(&test, rTM, 0.9997176087119081);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999716186280097);
    AssertAlmostEqual(&test, rTM, 0.9997189959220557);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996006418073974);
    AssertAlmostEqual(&test, rTM, 0.999800300961855);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9971654857599762);
    AssertAlmostEqual(&test, rTM, 0.9999718960103863);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9721501585865763);
    AssertAlmostEqual(&test, rTM, 0.9999971754107038);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7546396588229332);
    AssertAlmostEqual(&test, rTM, 0.9999997147522796);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1012526820704224);
    AssertAlmostEqual(&test, rTM, 0.9999999511248581);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001250387355857703);
    AssertAlmostEqual(&test, rTM, 0.9999999600124556);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.253488742406686e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999601113306);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.253519853416877e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999601123206);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.253520164536727e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999601123305);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999105661234252);
    AssertAlmostEqual(&test, rTM, 0.9991056612343414);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999105661229827);
    AssertAlmostEqual(&test, rTM, 0.9991056612387664);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991056607873275);
    AssertAlmostEqual(&test, rTM, 0.9991056616812658);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991056165384818);
    AssertAlmostEqual(&test, rTM, 0.9991057059278791);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991012026696269);
    AssertAlmostEqual(&test, rTM, 0.9991100976917027);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9987354483395132);
    AssertAlmostEqual(&test, rTM, 0.9993675240936389);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9910483220747833);
    AssertAlmostEqual(&test, rTM, 0.9999109732274721);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9144353152320025);
    AssertAlmostEqual(&test, rTM, 0.9999910441500819);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4200843615914316);
    AssertAlmostEqual(&test, rTM, 0.9999990198067192);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01218864236051742);
    AssertAlmostEqual(&test, rTM, 0.9999995898431538);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000124881708096057);
    AssertAlmostEqual(&test, rTM, 0.9999995996212739);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.24912592770485e-06);
    AssertAlmostEqual(&test, rTM, 0.9999995997202614);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.249129017136633e-08);
    AssertAlmostEqual(&test, rTM, 0.9999995997212514);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.997125595982564);
    AssertAlmostEqual(&test, rTM, 0.9971255959825669);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9971255959824219);
    AssertAlmostEqual(&test, rTM, 0.9971255959827089);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.997125595968214);
    AssertAlmostEqual(&test, rTM, 0.9971255959969167);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9971255945474323);
    AssertAlmostEqual(&test, rTM, 0.9971255974176978);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9971254524728148);
    AssertAlmostEqual(&test, rTM, 0.9971257394851617);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9971112804505998);
    AssertAlmostEqual(&test, rTM, 0.9971398406731234);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9959374015562354);
    AssertAlmostEqual(&test, rTM, 0.9979666313845169);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9714864080546833);
    AssertAlmostEqual(&test, rTM, 0.999713585816366);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7505988065859356);
    AssertAlmostEqual(&test, rTM, 0.9999709198495891);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.09815596223022195);
    AssertAlmostEqual(&test, rTM, 0.9999949551721333);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001203948393645868);
    AssertAlmostEqual(&test, rTM, 0.9999958470213599);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.206823503832651e-05);
    AssertAlmostEqual(&test, rTM, 0.99999585690926);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.206852341640252e-07);
    AssertAlmostEqual(&test, rTM, 0.9999958570082581);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9895242119397164);
    AssertAlmostEqual(&test, rTM, 0.9895242119397164);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9895242119397112);
    AssertAlmostEqual(&test, rTM, 0.9895242119397216);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9895242119391954);
    AssertAlmostEqual(&test, rTM, 0.9895242119402374);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9895242118876133);
    AssertAlmostEqual(&test, rTM, 0.9895242119918195);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9895242067294037);
    AssertAlmostEqual(&test, rTM, 0.9895242171500266);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9895236909214755);
    AssertAlmostEqual(&test, rTM, 0.9895247329321819);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9894722397784664);
    AssertAlmostEqual(&test, rTM, 0.9895759288754739);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9852172750008044);
    AssertAlmostEqual(&test, rTM, 0.9925810151301747);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8996163795673952);
    AssertAlmostEqual(&test, rTM, 0.9989512301382452);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3643214356495837);
    AssertAlmostEqual(&test, rTM, 0.9998809969098423);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.00885777292598648);
    AssertAlmostEqual(&test, rTM, 0.9999435600456048);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -9.015186289415017e-05);
    AssertAlmostEqual(&test, rTM, 0.9999445411056479);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -9.016795809650161e-07);
    AssertAlmostEqual(&test, rTM, 0.999944551003923);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9393687988630639);
    AssertAlmostEqual(&test, rTM, 0.9393687988630639);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9393687988630636);
    AssertAlmostEqual(&test, rTM, 0.9393687988630641);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9393687988630345);
    AssertAlmostEqual(&test, rTM, 0.9393687988630932);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.939368798860127);
    AssertAlmostEqual(&test, rTM, 0.9393687988660007);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9393687985693855);
    AssertAlmostEqual(&test, rTM, 0.9393687991567422);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9393687694952388);
    AssertAlmostEqual(&test, rTM, 0.9393688282308751);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9393658621578639);
    AssertAlmostEqual(&test, rTM, 0.9393717354304764);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9390758974718864);
    AssertAlmostEqual(&test, rTM, 0.9396603359075826);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9153575010784251);
    AssertAlmostEqual(&test, rTM, 0.9567225020125888);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5386041819506554);
    AssertAlmostEqual(&test, rTM, 0.9935025702907849);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02432275219297841);
    AssertAlmostEqual(&test, rTM, 0.9979498447069213);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002554003491178694);
    AssertAlmostEqual(&test, rTM, 0.9980461155305277);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.555298048512585e-06);
    AssertAlmostEqual(&test, rTM, 0.9980471023762562);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5723308329137512);
    AssertAlmostEqual(&test, rTM, 0.5723308329137512);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5723308329137512);
    AssertAlmostEqual(&test, rTM, 0.5723308329137512);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5723308329137496);
    AssertAlmostEqual(&test, rTM, 0.5723308329137528);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5723308329135955);
    AssertAlmostEqual(&test, rTM, 0.5723308329139069);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.572330832898184);
    AssertAlmostEqual(&test, rTM, 0.5723308329293184);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5723308313570289);
    AssertAlmostEqual(&test, rTM, 0.5723308344704735);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5723306772415819);
    AssertAlmostEqual(&test, rTM, 0.5723309885858793);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5723152663201764);
    AssertAlmostEqual(&test, rTM, 0.5723463990948479);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5707803738406274);
    AssertAlmostEqual(&test, rTM, 0.573877210662005);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4586014573750237);
    AssertAlmostEqual(&test, rTM, 0.6676137511325649);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02919914837406054);
    AssertAlmostEqual(&test, rTM, 0.8545431333230628);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003126915830969836);
    AssertAlmostEqual(&test, rTM, 0.8621477801529615);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.129162443725161e-06);
    AssertAlmostEqual(&test, rTM, 0.8622272239968459);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03011196376640242);
    AssertAlmostEqual(&test, rTM, 0.03011196376640242);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03011196376640242);
    AssertAlmostEqual(&test, rTM, 0.03011196376640242);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03011196376640242);
    AssertAlmostEqual(&test, rTM, 0.03011196376640242);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03011196376640213);
    AssertAlmostEqual(&test, rTM, 0.0301119637664027);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03011196376637407);
    AssertAlmostEqual(&test, rTM, 0.03011196376643077);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03011196376356727);
    AssertAlmostEqual(&test, rTM, 0.03011196376923757);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03011196348288728);
    AssertAlmostEqual(&test, rTM, 0.03011196404991755);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03011193541491548);
    AssertAlmostEqual(&test, rTM, 0.03011199211788931);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03010912888219407);
    AssertAlmostEqual(&test, rTM, 0.03011479865012634);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02983109548492395);
    AssertAlmostEqual(&test, rTM, 0.03039282729276525);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01551265572325654);
    AssertAlmostEqual(&test, rTM, 0.04469843534092201);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003167373965563595);
    AssertAlmostEqual(&test, rTM, 0.0598537734280989);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.200734619505885e-06);
    AssertAlmostEqual(&test, rTM, 0.06016618099060195);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003206389106592221);
    AssertAlmostEqual(&test, rTM, 0.0003206389106592221);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003206389106592221);
    AssertAlmostEqual(&test, rTM, 0.0003206389106592221);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003206389106592221);
    AssertAlmostEqual(&test, rTM, 0.0003206389106592221);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003206389106592221);
    AssertAlmostEqual(&test, rTM, 0.0003206389106592222);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003206389106592189);
    AssertAlmostEqual(&test, rTM, 0.0003206389106592253);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003206389106589017);
    AssertAlmostEqual(&test, rTM, 0.0003206389106595426);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003206389106271788);
    AssertAlmostEqual(&test, rTM, 0.0003206389106912654);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003206389074548886);
    AssertAlmostEqual(&test, rTM, 0.0003206389138635557);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003206385902261844);
    AssertAlmostEqual(&test, rTM, 0.0003206392310922599);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003206068705253873);
    AssertAlmostEqual(&test, rTM, 0.0003206709507930563);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003174662830205467);
    AssertAlmostEqual(&test, rTM, 0.0003238115382914427);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001603708641043871);
    AssertAlmostEqual(&test, rTM, 0.0004809069407422932);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.176659304877845e-06);
    AssertAlmostEqual(&test, rTM, 0.0006381010973841313);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.209164661868899e-06);
    AssertAlmostEqual(&test, rTM, 3.209164661868899e-06);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.209164661868899e-06);
    AssertAlmostEqual(&test, rTM, 3.209164661868899e-06);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.209164661868899e-06);
    AssertAlmostEqual(&test, rTM, 3.209164661868899e-06);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.209164661868899e-06);
    AssertAlmostEqual(&test, rTM, 3.209164661868899e-06);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.209164661868899e-06);
    AssertAlmostEqual(&test, rTM, 3.2091646618689e-06);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.209164661868867e-06);
    AssertAlmostEqual(&test, rTM, 3.209164661868931e-06);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.20916466186569e-06);
    AssertAlmostEqual(&test, rTM, 3.209164661872109e-06);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.209164661547985e-06);
    AssertAlmostEqual(&test, rTM, 3.209164662189814e-06);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.209164629777459e-06);
    AssertAlmostEqual(&test, rTM, 3.20916469396034e-06);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.209161452728044e-06);
    AssertAlmostEqual(&test, rTM, 3.209167871009755e-06);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.208843779550479e-06);
    AssertAlmostEqual(&test, rTM, 3.209485544187319e-06);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.177390956241251e-06);
    AssertAlmostEqual(&test, rTM, 3.240938367496541e-06);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.604587480307494e-06);
    AssertAlmostEqual(&test, rTM, 4.813741843413779e-06);

    userdata[0] = 7/CAPS_HBAR_EV; /* 7eV */
    userdata[1] = 0.1/CAPS_HBAR_EV; /* 0.1eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999943522134122);
    AssertAlmostEqual(&test, rTM, 0.9999971761027189);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999598656274289);
    AssertAlmostEqual(&test, rTM, 0.9999996026220791);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996006998294459);
    AssertAlmostEqual(&test, rTM, 0.9999999600660019);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960143649953739);
    AssertAlmostEqual(&test, rTM, 0.9999999960063946);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9608534860556024);
    AssertAlmostEqual(&test, rTM, 0.9999999996005604);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.672500396404499);
    AssertAlmostEqual(&test, rTM, 0.9999999999592756);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05588793723377655);
    AssertAlmostEqual(&test, rTM, 0.9999999999910815);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006262199357436258);
    AssertAlmostEqual(&test, rTM, 0.9999999999920156);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.269971133126295e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999920255);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.270048972671431e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999920256);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.270049751079082e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999999920256);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.27004975886316e-12);
    AssertAlmostEqual(&test, rTM, 0.9999999999920256);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.270049758941001e-14);
    AssertAlmostEqual(&test, rTM, 0.9999999999920256);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999873082217544);
    AssertAlmostEqual(&test, rTM, 0.9999874338821356);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999821402381266);
    AssertAlmostEqual(&test, rTM, 0.9999910700791914);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998730894660391);
    AssertAlmostEqual(&test, rTM, 0.9999987433811052);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9987378469765461);
    AssertAlmostEqual(&test, rTM, 0.9999998737175817);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9874506146895006);
    AssertAlmostEqual(&test, rTM, 0.9999999873708831);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8814341848202207);
    AssertAlmostEqual(&test, rTM, 0.9999999987345977);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3038564718911143);
    AssertAlmostEqual(&test, rTM, 0.9999999998506415);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.006192632885654564);
    AssertAlmostEqual(&test, rTM, 0.999999999919262);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.269262509466057e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999202458);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.270040793752317e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999202557);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.270048577815005e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999999202558);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.270048655655754e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999999202558);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.270048656434162e-13);
    AssertAlmostEqual(&test, rTM, 0.9999999999202558);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998737179747974);
    AssertAlmostEqual(&test, rTM, 0.9998737181010713);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998737117243929);
    AssertAlmostEqual(&test, rTM, 0.9998737243511603);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998730882387745);
    AssertAlmostEqual(&test, rTM, 0.9998743447119146);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998214150076049);
    AssertAlmostEqual(&test, rTM, 0.9999107035166935);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9987316070235153);
    AssertAlmostEqual(&test, rTM, 0.9999874337581299);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9874498768296875);
    AssertAlmostEqual(&test, rTM, 0.9999987371394001);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.881433055447621);
    AssertAlmostEqual(&test, rTM, 0.9999998734586085);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3038533324308553);
    AssertAlmostEqual(&test, rTM, 0.9999999850639596);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.006192514584075396);
    AssertAlmostEqual(&test, rTM, 0.9999999919260453);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.269141267260849e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999920244261);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.269919521449442e-07);
    AssertAlmostEqual(&test, rTM, 0.999999992025416);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.269927305211082e-09);
    AssertAlmostEqual(&test, rTM, 0.999999992025426);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.269927383048821e-11);
    AssertAlmostEqual(&test, rTM, 0.999999992025426);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996006807962329);
    AssertAlmostEqual(&test, rTM, 0.9996006808002252);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996006805986094);
    AssertAlmostEqual(&test, rTM, 0.9996006809978486);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996006608367554);
    AssertAlmostEqual(&test, rTM, 0.9996007007587051);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995986895686184);
    AssertAlmostEqual(&test, rTM, 0.9996026621496825);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994353240800636);
    AssertAlmostEqual(&test, rTM, 0.999717622165783);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9959941378456518);
    AssertAlmostEqual(&test, rTM, 0.9999602590299826);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9608478206866172);
    AssertAlmostEqual(&test, rTM, 0.9999960054219269);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6724745413223305);
    AssertAlmostEqual(&test, rTM, 0.999999592715206);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05587817629498322);
    AssertAlmostEqual(&test, rTM, 0.9999999107990274);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006260977782510094);
    AssertAlmostEqual(&test, rTM, 0.9999999201403069);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.26874652561595e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999202392443);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.268824334763955e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999202402343);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.268825112867628e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999202402442);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9987366786503037);
    AssertAlmostEqual(&test, rTM, 0.9987366786504299);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9987366786440542);
    AssertAlmostEqual(&test, rTM, 0.9987366786566795);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9987366780191056);
    AssertAlmostEqual(&test, rTM, 0.9987366792816278);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9987366155258042);
    AssertAlmostEqual(&test, rTM, 0.9987367417717775);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9987303817590673);
    AssertAlmostEqual(&test, rTM, 0.9987429443307864);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9982138614998655);
    AssertAlmostEqual(&test, rTM, 0.9991065314286577);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9873761929340112);
    AssertAlmostEqual(&test, rTM, 0.9998742207723746);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.881320172907447);
    AssertAlmostEqual(&test, rTM, 0.9999873342894312);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3035397465823658);
    AssertAlmostEqual(&test, rTM, 0.999998504542349);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.006180707209247251);
    AssertAlmostEqual(&test, rTM, 0.9999991910626478);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.257040682712516e-05);
    AssertAlmostEqual(&test, rTM, 0.9999992009008351);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.257815935930856e-07);
    AssertAlmostEqual(&test, rTM, 0.9999992009998286);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.257823689675746e-09);
    AssertAlmostEqual(&test, rTM, 0.9999992010008186);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.995975699172266);
    AssertAlmostEqual(&test, rTM, 0.99597569917227);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9959756991720672);
    AssertAlmostEqual(&test, rTM, 0.9959756991724689);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9959756991521871);
    AssertAlmostEqual(&test, rTM, 0.995975699192349);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.995975697164175);
    AssertAlmostEqual(&test, rTM, 0.9959757011803601);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9959754983679581);
    AssertAlmostEqual(&test, rTM, 0.9959758999665789);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.99595566839177);
    AssertAlmostEqual(&test, rTM, 0.9959956309432788);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9943135301701884);
    AssertAlmostEqual(&test, rTM, 0.9971527057803681);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9602874853248823);
    AssertAlmostEqual(&test, rTM, 0.9995987587132342);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6699321705627919);
    AssertAlmostEqual(&test, rTM, 0.9999588673135681);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05492838960815657);
    AssertAlmostEqual(&test, rTM, 0.9999909247903913);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006142344641675846);
    AssertAlmostEqual(&test, rTM, 0.9999918598553491);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.149821698710378e-06);
    AssertAlmostEqual(&test, rTM, 0.9999918697490866);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.14989658420621e-08);
    AssertAlmostEqual(&test, rTM, 0.9999918698480847);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.986287456358146);
    AssertAlmostEqual(&test, rTM, 0.9862874563581461);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9862874563581392);
    AssertAlmostEqual(&test, rTM, 0.9862874563581528);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9862874563574651);
    AssertAlmostEqual(&test, rTM, 0.9862874563588269);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9862874562900567);
    AssertAlmostEqual(&test, rTM, 0.9862874564262354);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9862874495492089);
    AssertAlmostEqual(&test, rTM, 0.9862874631670797);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9862867754815203);
    AssertAlmostEqual(&test, rTM, 0.9862881372011988);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9862195386941482);
    AssertAlmostEqual(&test, rTM, 0.986355041586252);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9806629090226712);
    AssertAlmostEqual(&test, rTM, 0.9902840262824193);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8705300893738237);
    AssertAlmostEqual(&test, rTM, 0.9986238088751226);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2753844221321598);
    AssertAlmostEqual(&test, rTM, 0.9998322436942667);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.005190945732029119);
    AssertAlmostEqual(&test, rTM, 0.9999036903585474);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.244715123685805e-05);
    AssertAlmostEqual(&test, rTM, 0.9999046750258408);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.245259857076979e-07);
    AssertAlmostEqual(&test, rTM, 0.9999046849239009);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.933679323015344);
    AssertAlmostEqual(&test, rTM, 0.933679323015344);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9336793230153436);
    AssertAlmostEqual(&test, rTM, 0.9336793230153442);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9336793230153119);
    AssertAlmostEqual(&test, rTM, 0.9336793230153759);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9336793230121416);
    AssertAlmostEqual(&test, rTM, 0.9336793230185462);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9336793226951138);
    AssertAlmostEqual(&test, rTM, 0.933679323335574);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.933679290992336);
    AssertAlmostEqual(&test, rTM, 0.9336793550383369);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9336761207993369);
    AssertAlmostEqual(&test, rTM, 0.9336825250820455);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9333599450230384);
    AssertAlmostEqual(&test, rTM, 0.9339972226166748);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9075310706228601);
    AssertAlmostEqual(&test, rTM, 0.9526170747607455);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5082461140926439);
    AssertAlmostEqual(&test, rTM, 0.9928101581476939);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02036952881161412);
    AssertAlmostEqual(&test, rTM, 0.9975525017322119);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002121851979024814);
    AssertAlmostEqual(&test, rTM, 0.9976491089506575);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.122745806260665e-06);
    AssertAlmostEqual(&test, rTM, 0.9976500952508874);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5684849682295817);
    AssertAlmostEqual(&test, rTM, 0.5684849682295817);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5684849682295817);
    AssertAlmostEqual(&test, rTM, 0.5684849682295817);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5684849682295802);
    AssertAlmostEqual(&test, rTM, 0.5684849682295833);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5684849682294253);
    AssertAlmostEqual(&test, rTM, 0.5684849682297382);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5684849682139418);
    AssertAlmostEqual(&test, rTM, 0.5684849682452217);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5684849666655896);
    AssertAlmostEqual(&test, rTM, 0.5684849697935738);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5684848118304358);
    AssertAlmostEqual(&test, rTM, 0.5684851246286865);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5684693289443302);
    AssertAlmostEqual(&test, rTM, 0.568500607103972);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5669272994750219);
    AssertAlmostEqual(&test, rTM, 0.5700385717272921);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4544029566399959);
    AssertAlmostEqual(&test, rTM, 0.6642201359782064);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02852769001440345);
    AssertAlmostEqual(&test, rTM, 0.8516221527276379);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003050834634043771);
    AssertAlmostEqual(&test, rTM, 0.8591940976658557);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.052980579896037e-06);
    AssertAlmostEqual(&test, rTM, 0.8592731443548191);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03003976535443057);
    AssertAlmostEqual(&test, rTM, 0.03003976535443057);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03003976535443057);
    AssertAlmostEqual(&test, rTM, 0.03003976535443057);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03003976535443057);
    AssertAlmostEqual(&test, rTM, 0.03003976535443058);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03003976535443029);
    AssertAlmostEqual(&test, rTM, 0.03003976535443086);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03003976535440229);
    AssertAlmostEqual(&test, rTM, 0.03003976535445886);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03003976535160181);
    AssertAlmostEqual(&test, rTM, 0.03003976535725934);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03003976507155433);
    AssertAlmostEqual(&test, rTM, 0.03003976563730681);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03003973706683298);
    AssertAlmostEqual(&test, rTM, 0.03003979364202812);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03003693685859715);
    AssertAlmostEqual(&test, rTM, 0.03004259384978291);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02975953036916676);
    AssertAlmostEqual(&test, rTM, 0.03031999561736803);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0154743615971133);
    AssertAlmostEqual(&test, rTM, 0.04459242283199704);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000315931438180776);
    AssertAlmostEqual(&test, rTM, 0.05971056547703449);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.192585051674921e-06);
    AssertAlmostEqual(&test, rTM, 0.06002218348740157);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003205569471638348);
    AssertAlmostEqual(&test, rTM, 0.0003205569471638348);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003205569471638348);
    AssertAlmostEqual(&test, rTM, 0.0003205569471638348);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003205569471638348);
    AssertAlmostEqual(&test, rTM, 0.0003205569471638348);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003205569471638347);
    AssertAlmostEqual(&test, rTM, 0.0003205569471638348);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003205569471638316);
    AssertAlmostEqual(&test, rTM, 0.000320556947163838);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003205569471635144);
    AssertAlmostEqual(&test, rTM, 0.0003205569471641551);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003205569471317996);
    AssertAlmostEqual(&test, rTM, 0.0003205569471958699);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003205569439603198);
    AssertAlmostEqual(&test, rTM, 0.0003205569503673497);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003205566268126554);
    AssertAlmostEqual(&test, rTM, 0.0003205572675150141);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003205249152150261);
    AssertAlmostEqual(&test, rTM, 0.0003205889791126427);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003173851300150163);
    AssertAlmostEqual(&test, rTM, 0.0003237287643062034);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001603298560762088);
    AssertAlmostEqual(&test, rTM, 0.0004807840217923228);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.175846754007742e-06);
    AssertAlmostEqual(&test, rTM, 0.0006379379829937766);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.209082537528014e-06);
    AssertAlmostEqual(&test, rTM, 3.209082537528014e-06);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.209082537528014e-06);
    AssertAlmostEqual(&test, rTM, 3.209082537528014e-06);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.209082537528014e-06);
    AssertAlmostEqual(&test, rTM, 3.209082537528014e-06);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.209082537528014e-06);
    AssertAlmostEqual(&test, rTM, 3.209082537528014e-06);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.209082537528014e-06);
    AssertAlmostEqual(&test, rTM, 3.209082537528015e-06);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.209082537527982e-06);
    AssertAlmostEqual(&test, rTM, 3.209082537528047e-06);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.209082537524805e-06);
    AssertAlmostEqual(&test, rTM, 3.209082537531223e-06);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.209082537207108e-06);
    AssertAlmostEqual(&test, rTM, 3.209082537848921e-06);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.209082505437395e-06);
    AssertAlmostEqual(&test, rTM, 3.209082569618634e-06);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.209079328469282e-06);
    AssertAlmostEqual(&test, rTM, 3.209085746586747e-06);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.208761663421102e-06);
    AssertAlmostEqual(&test, rTM, 3.209403411634927e-06);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.177309645002318e-06);
    AssertAlmostEqual(&test, rTM, 3.240855430053704e-06);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.604546417873504e-06);
    AssertAlmostEqual(&test, rTM, 4.813618657166001e-06);

    userdata[0] = 7/CAPS_HBAR_EV; /* 7eV */
    userdata[1] = 0.5/CAPS_HBAR_EV; /* 0.5eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999987371209447);
    AssertAlmostEqual(&test, rTM, 0.9999936855847875);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999102590414414);
    AssertAlmostEqual(&test, rTM, 0.9999991114361806);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991073580405084);
    AssertAlmostEqual(&test, rTM, 0.9999999107048615);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.991109818826746);
    AssertAlmostEqual(&test, rTM, 0.9999999910699556);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9145986407371415);
    AssertAlmostEqual(&test, rTM, 0.9999999991061144);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4207535352080262);
    AssertAlmostEqual(&test, rTM, 0.9999999999022032);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0122351177498632);
    AssertAlmostEqual(&test, rTM, 0.9999999999591401);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001253695561751174);
    AssertAlmostEqual(&test, rTM, 0.9999999999601179);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.2540068263162e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999601278);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.254009939937538e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999601279);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.254009971073849e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999999601279);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.254009971385212e-12);
    AssertAlmostEqual(&test, rTM, 0.9999999999601279);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.254009971388326e-14);
    AssertAlmostEqual(&test, rTM, 0.9999999999601279);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999716205459147);
    AssertAlmostEqual(&test, rTM, 0.9999719015266609);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999600648023187);
    AssertAlmostEqual(&test, rTM, 0.9999800322018009);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997162417000509);
    AssertAlmostEqual(&test, rTM, 0.9999971901171091);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9971799423052159);
    AssertAlmostEqual(&test, rTM, 0.9999997176237473);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9721568795109612);
    AssertAlmostEqual(&test, rTM, 0.9999999717581868);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7546809818694336);
    AssertAlmostEqual(&test, rTM, 0.999999997148089);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1012849662716537);
    AssertAlmostEqual(&test, rTM, 0.9999999995114076);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001250874670910464);
    AssertAlmostEqual(&test, rTM, 0.9999999996002803);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.253978477456348e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999996012691);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.254009612780278e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999996012789);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.254009924143277e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999996012791);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.254009927256908e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999996012791);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.254009927288045e-13);
    AssertAlmostEqual(&test, rTM, 0.9999999996012791);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997176490524853);
    AssertAlmostEqual(&test, rTM, 0.999717649334796);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997176350784467);
    AssertAlmostEqual(&test, rTM, 0.9997176633081292);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997162411512854);
    AssertAlmostEqual(&test, rTM, 0.9997190502501179);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996007190129403);
    AssertAlmostEqual(&test, rTM, 0.9998003395723374);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9971660330714538);
    AssertAlmostEqual(&test, rTM, 0.9999719014445828);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9721554676742908);
    AssertAlmostEqual(&test, rTM, 0.9999971759569819);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7546804692577551);
    AssertAlmostEqual(&test, rTM, 0.999999714808514);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1012846457139682);
    AssertAlmostEqual(&test, rTM, 0.9999999511406018);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001250869844024855);
    AssertAlmostEqual(&test, rTM, 0.9999999600278798);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.253973626717566e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999601267547);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.254004761801843e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999601277447);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.254005073162446e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999601277546);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.254005076276053e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999601277547);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991073852156074);
    AssertAlmostEqual(&test, rTM, 0.9991073852245295);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991073847739604);
    AssertAlmostEqual(&test, rTM, 0.9991073856661762);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991073406103735);
    AssertAlmostEqual(&test, rTM, 0.999107429827535);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991029352461586);
    AssertAlmostEqual(&test, rTM, 0.9991118131292726);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9987378855207824);
    AssertAlmostEqual(&test, rTM, 0.9993687434551117);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9910655081547483);
    AssertAlmostEqual(&test, rTM, 0.9999111449137139);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9145929676709312);
    AssertAlmostEqual(&test, rTM, 0.9999910614559923);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4207466615088865);
    AssertAlmostEqual(&test, rTM, 0.9999990220114232);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01223465116938871);
    AssertAlmostEqual(&test, rTM, 0.9999995913860208);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001253646593003583);
    AssertAlmostEqual(&test, rTM, 0.9999996011636808);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.253957833375275e-06);
    AssertAlmostEqual(&test, rTM, 0.9999996012626682);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.253960946754566e-08);
    AssertAlmostEqual(&test, rTM, 0.9999996012636583);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.253960977888456e-10);
    AssertAlmostEqual(&test, rTM, 0.9999996012636682);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9971795330487973);
    AssertAlmostEqual(&test, rTM, 0.9971795330490789);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9971795330348556);
    AssertAlmostEqual(&test, rTM, 0.9971795330630204);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9971795316406965);
    AssertAlmostEqual(&test, rTM, 0.9971795344571789);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9971793922282776);
    AssertAlmostEqual(&test, rTM, 0.9971796738625779);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9971654857599762);
    AssertAlmostEqual(&test, rTM, 0.9971935108201553);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960135899680947);
    AssertAlmostEqual(&test, rTM, 0.998004802594067);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9720146063870811);
    AssertAlmostEqual(&test, rTM, 0.9997189681833795);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7546292121776971);
    AssertAlmostEqual(&test, rTM, 0.9999714770712546);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1012526002631336);
    AssertAlmostEqual(&test, rTM, 0.9999951125080936);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001250387343509786);
    AssertAlmostEqual(&test, rTM, 0.9999960012613772);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.253488742282593e-05);
    AssertAlmostEqual(&test, rTM, 0.9999960111488153);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.253519853415636e-07);
    AssertAlmostEqual(&test, rTM, 0.9999960112478135);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.253520164536715e-09);
    AssertAlmostEqual(&test, rTM, 0.9999960112488034);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.99109254880339);
    AssertAlmostEqual(&test, rTM, 0.9910925488033989);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9910925488029511);
    AssertAlmostEqual(&test, rTM, 0.9910925488038378);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9910925487590564);
    AssertAlmostEqual(&test, rTM, 0.9910925488477325);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9910925443695944);
    AssertAlmostEqual(&test, rTM, 0.9910925532371924);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9910921054344589);
    AssertAlmostEqual(&test, rTM, 0.9910929921503611);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9910483220747833);
    AssertAlmostEqual(&test, rTM, 0.9911365579978063);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9874262828850836);
    AssertAlmostEqual(&test, rTM, 0.9936931910089498);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9140318279648333);
    AssertAlmostEqual(&test, rTM, 0.9991092168500899);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4200673791302406);
    AssertAlmostEqual(&test, rTM, 0.9999019914114855);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01218863058438555);
    AssertAlmostEqual(&test, rTM, 0.9999589859616952);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001248817068600369);
    AssertAlmostEqual(&test, rTM, 0.9999599637141315);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.249125927581187e-06);
    AssertAlmostEqual(&test, rTM, 0.9999599736122884);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.249129017135397e-08);
    AssertAlmostEqual(&test, rTM, 0.9999599737112823);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9716258790484852);
    AssertAlmostEqual(&test, rTM, 0.9716258790484855);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9716258790484714);
    AssertAlmostEqual(&test, rTM, 0.9716258790484994);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9716258790470871);
    AssertAlmostEqual(&test, rTM, 0.9716258790498836);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9716258789086565);
    AssertAlmostEqual(&test, rTM, 0.9716258791883142);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9716258650655977);
    AssertAlmostEqual(&test, rTM, 0.9716258930313662);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9716244807953313);
    AssertAlmostEqual(&test, rTM, 0.9716272772337297);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9714864080546833);
    AssertAlmostEqual(&test, rTM, 0.971764677606231);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9601114093512272);
    AssertAlmostEqual(&test, rTM, 0.9798506837198874);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7495436582799814);
    AssertAlmostEqual(&test, rTM, 0.9971107128613705);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.09814798259187618);
    AssertAlmostEqual(&test, rTM, 0.9994957546699471);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001203947204604687);
    AssertAlmostEqual(&test, rTM, 0.9995848726092366);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.206823491885387e-05);
    AssertAlmostEqual(&test, rTM, 0.9995858607897645);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.206852341520774e-07);
    AssertAlmostEqual(&test, rTM, 0.9995858706834948);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9000883652617843);
    AssertAlmostEqual(&test, rTM, 0.9000883652617843);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9000883652617838);
    AssertAlmostEqual(&test, rTM, 0.9000883652617847);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.900088365261737);
    AssertAlmostEqual(&test, rTM, 0.9000883652618316);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9000883652570514);
    AssertAlmostEqual(&test, rTM, 0.9000883652665171);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9000883647884942);
    AssertAlmostEqual(&test, rTM, 0.9000883657350743);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9000883179327881);
    AssertAlmostEqual(&test, rTM, 0.9000884125907592);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.900083632491937);
    AssertAlmostEqual(&test, rTM, 0.9000930978192403);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8996163795673952);
    AssertAlmostEqual(&test, rTM, 0.9005582479354758);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8617458757636728);
    AssertAlmostEqual(&test, rTM, 0.9282072564325992);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3626499776943681);
    AssertAlmostEqual(&test, rTM, 0.9882466653128078);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.008856911489829127);
    AssertAlmostEqual(&test, rTM, 0.9943871012790828);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -9.015177365998585e-05);
    AssertAlmostEqual(&test, rTM, 0.9944843909045757);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -9.016795720384045e-07);
    AssertAlmostEqual(&test, rTM, 0.9944853726395393);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5402100783225676);
    AssertAlmostEqual(&test, rTM, 0.5402100783225676);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5402100783225676);
    AssertAlmostEqual(&test, rTM, 0.5402100783225676);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.540210078322566);
    AssertAlmostEqual(&test, rTM, 0.5402100783225692);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5402100783224063);
    AssertAlmostEqual(&test, rTM, 0.5402100783227288);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.540210078306441);
    AssertAlmostEqual(&test, rTM, 0.5402100783386942);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5402100767099099);
    AssertAlmostEqual(&test, rTM, 0.5402100799352252);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.540209917056875);
    AssertAlmostEqual(&test, rTM, 0.5402102395882205);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5401939524262829);
    AssertAlmostEqual(&test, rTM, 0.5402262038221266);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5386041819506555);
    AssertAlmostEqual(&test, rTM, 0.5418120498218125);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4239577061477612);
    AssertAlmostEqual(&test, rTM, 0.6389499674348095);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02409555878482495);
    AssertAlmostEqual(&test, rTM, 0.8289604749513155);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002553750799210602);
    AssertAlmostEqual(&test, rTM, 0.8362737844478539);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.555295518782975e-06);
    AssertAlmostEqual(&test, rTM, 0.8363497776776232);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02947441786946061);
    AssertAlmostEqual(&test, rTM, 0.02947441786946061);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02947441786946061);
    AssertAlmostEqual(&test, rTM, 0.02947441786946061);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02947441786946061);
    AssertAlmostEqual(&test, rTM, 0.02947441786946062);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02947441786946034);
    AssertAlmostEqual(&test, rTM, 0.02947441786946089);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02947441786943283);
    AssertAlmostEqual(&test, rTM, 0.0294744178694884);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02947441786668194);
    AssertAlmostEqual(&test, rTM, 0.02947441787223928);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02947441759159381);
    AssertAlmostEqual(&test, rTM, 0.02947441814732741);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0294743900828065);
    AssertAlmostEqual(&test, rTM, 0.02947444565611468);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02947163946358614);
    AssertAlmostEqual(&test, rTM, 0.02947719627487964);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02919914837406054);
    AssertAlmostEqual(&test, rTM, 0.02974968289430194);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01517468460713139);
    AssertAlmostEqual(&test, rTM, 0.0437620968232035);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003096284838215408);
    AssertAlmostEqual(&test, rTM, 0.05858910887132284);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.1288526895572e-06);
    AssertAlmostEqual(&test, rTM, 0.05889455090148198);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003199027446635446);
    AssertAlmostEqual(&test, rTM, 0.0003199027446635446);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003199027446635446);
    AssertAlmostEqual(&test, rTM, 0.0003199027446635446);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003199027446635446);
    AssertAlmostEqual(&test, rTM, 0.0003199027446635446);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003199027446635446);
    AssertAlmostEqual(&test, rTM, 0.0003199027446635447);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003199027446635414);
    AssertAlmostEqual(&test, rTM, 0.0003199027446635478);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000319902744663225);
    AssertAlmostEqual(&test, rTM, 0.0003199027446638643);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003199027446315748);
    AssertAlmostEqual(&test, rTM, 0.0003199027446955145);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003199027414665633);
    AssertAlmostEqual(&test, rTM, 0.0003199027478605259);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003199024249657295);
    AssertAlmostEqual(&test, rTM, 0.0003199030643613597);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003198707780447036);
    AssertAlmostEqual(&test, rTM, 0.0003199347112823851);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003167373965563596);
    AssertAlmostEqual(&test, rTM, 0.0003230680927643192);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001600025453057511);
    AssertAlmostEqual(&test, rTM, 0.0004798029276627442);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.169361281013887e-06);
    AssertAlmostEqual(&test, rTM, 0.000636636063860772);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.208425694085768e-06);
    AssertAlmostEqual(&test, rTM, 3.208425694085768e-06);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.208425694085768e-06);
    AssertAlmostEqual(&test, rTM, 3.208425694085768e-06);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.208425694085768e-06);
    AssertAlmostEqual(&test, rTM, 3.208425694085768e-06);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.208425694085768e-06);
    AssertAlmostEqual(&test, rTM, 3.208425694085768e-06);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.208425694085768e-06);
    AssertAlmostEqual(&test, rTM, 3.208425694085769e-06);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.208425694085737e-06);
    AssertAlmostEqual(&test, rTM, 3.208425694085801e-06);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.20842569408256e-06);
    AssertAlmostEqual(&test, rTM, 3.208425694088977e-06);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.208425693764928e-06);
    AssertAlmostEqual(&test, rTM, 3.208425694406609e-06);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.208425662001718e-06);
    AssertAlmostEqual(&test, rTM, 3.208425726169819e-06);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.208422485683871e-06);
    AssertAlmostEqual(&test, rTM, 3.208428902487666e-06);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.20810488565579e-06);
    AssertAlmostEqual(&test, rTM, 3.208746502515748e-06);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.176659304877846e-06);
    AssertAlmostEqual(&test, rTM, 3.240192083293685e-06);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.60421799404473e-06);
    AssertAlmostEqual(&test, rTM, 4.812633394110294e-06);

    userdata[0] = 7/CAPS_HBAR_EV; /* 7eV */
    userdata[1] = 1/CAPS_HBAR_EV; /* 1eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999821402398538);
    AssertAlmostEqual(&test, rTM, 0.9999910700800549);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998730894783118);
    AssertAlmostEqual(&test, rTM, 0.9999987433812267);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9987378470985315);
    AssertAlmostEqual(&test, rTM, 0.9999998737175939);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9874506158954851);
    AssertAlmostEqual(&test, rTM, 0.9999999873708844);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8814341955640866);
    AssertAlmostEqual(&test, rTM, 0.9999999987345978);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3038565032700165);
    AssertAlmostEqual(&test, rTM, 0.9999999998506415);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.006192634068687126);
    AssertAlmostEqual(&test, rTM, 0.999999999919262);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.269263721911729e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999202458);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.270042006499038e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999202557);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.270049790564736e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999999202558);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.270049868405514e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999999202558);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.270049869183923e-13);
    AssertAlmostEqual(&test, rTM, 0.9999999999202558);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.270049869191707e-15);
    AssertAlmostEqual(&test, rTM, 0.9999999999202558);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999598656274289);
    AssertAlmostEqual(&test, rTM, 0.999960262989559);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999943523569494);
    AssertAlmostEqual(&test, rTM, 0.9999717613860317);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999598728753751);
    AssertAlmostEqual(&test, rTM, 0.999996026227819);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960141681054764);
    AssertAlmostEqual(&test, rTM, 0.9999996006593029);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9608534670649362);
    AssertAlmostEqual(&test, rTM, 0.9999999600560652);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6725003951008152);
    AssertAlmostEqual(&test, rTM, 0.9999999959275622);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05588793722882937);
    AssertAlmostEqual(&test, rTM, 0.999999999108147);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006262199357430068);
    AssertAlmostEqual(&test, rTM, 0.9999999992015588);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.269971133126234e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999992025481);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.270048972671431e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999992025581);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.270049751079083e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999992025581);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.27004975886316e-12);
    AssertAlmostEqual(&test, rTM, 0.9999999992025581);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.270049758941001e-14);
    AssertAlmostEqual(&test, rTM, 0.9999999992025581);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996007192033048);
    AssertAlmostEqual(&test, rTM, 0.9996007196025055);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996006994433609);
    AssertAlmostEqual(&test, rTM, 0.999600739361452);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995987283657606);
    AssertAlmostEqual(&test, rTM, 0.9996027005628472);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994353786662883);
    AssertAlmostEqual(&test, rTM, 0.9997176494666057);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9959945244173452);
    AssertAlmostEqual(&test, rTM, 0.9999602628726961);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9608515309432606);
    AssertAlmostEqual(&test, rTM, 0.9999960058083379);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.672500010027637);
    AssertAlmostEqual(&test, rTM, 0.9999995927560987);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05588784007933345);
    AssertAlmostEqual(&test, rTM, 0.9999999108145481);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006262187259679391);
    AssertAlmostEqual(&test, rTM, 0.999999920155731);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.269959005948109e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999202546684);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.270036845198341e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999202556584);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.270037623603044e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999202556683);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.270037631387092e-12);
    AssertAlmostEqual(&test, rTM, 0.9999999202556684);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9987378978354394);
    AssertAlmostEqual(&test, rTM, 0.9987378978480526);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9987378972110935);
    AssertAlmostEqual(&test, rTM, 0.9987378984723981);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9987378347780643);
    AssertAlmostEqual(&test, rTM, 0.9987379609022787);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9987316070235153);
    AssertAlmostEqual(&test, rTM, 0.9987441574791602);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9982155847943608);
    AssertAlmostEqual(&test, rTM, 0.9991073938465923);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9873883061079725);
    AssertAlmostEqual(&test, rTM, 0.9998743422317816);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8814275564085396);
    AssertAlmostEqual(&test, rTM, 0.9999873465689456);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3038531718214595);
    AssertAlmostEqual(&test, rTM, 0.9999985063981773);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.006192514523524105);
    AssertAlmostEqual(&test, rTM, 0.9999991926051714);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.269141266640281e-05);
    AssertAlmostEqual(&test, rTM, 0.9999992024432407);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.269919521443235e-07);
    AssertAlmostEqual(&test, rTM, 0.9999992025422343);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.26992730521102e-09);
    AssertAlmostEqual(&test, rTM, 0.9999992025432243);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.269927383048821e-11);
    AssertAlmostEqual(&test, rTM, 0.9999992025432342);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.996013978476333);
    AssertAlmostEqual(&test, rTM, 0.9960139784767308);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960139784566415);
    AssertAlmostEqual(&test, rTM, 0.9960139784964221);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960139764875016);
    AssertAlmostEqual(&test, rTM, 0.9960139804655611);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960137795784503);
    AssertAlmostEqual(&test, rTM, 0.9960141773647089);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9959941378456518);
    AssertAlmostEqual(&test, rTM, 0.9960337210340415);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9943675752575374);
    AssertAlmostEqual(&test, rTM, 0.9971798052799989);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9606583925954628);
    AssertAlmostEqual(&test, rTM, 0.9996025837291506);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6724615042286815);
    AssertAlmostEqual(&test, rTM, 0.9999592744409935);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05587812683075342);
    AssertAlmostEqual(&test, rTM, 0.999991079978222);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006260977720603982);
    AssertAlmostEqual(&test, rTM, 0.9999920140937908);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.268746524995352e-06);
    AssertAlmostEqual(&test, rTM, 0.9999920239874119);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.268824334757749e-08);
    AssertAlmostEqual(&test, rTM, 0.9999920240864101);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.268825112867566e-10);
    AssertAlmostEqual(&test, rTM, 0.9999920240874001);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.98743844650621);
    AssertAlmostEqual(&test, rTM, 0.9874384465062225);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9874384465055921);
    AssertAlmostEqual(&test, rTM, 0.9874384465068403);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9874384464438054);
    AssertAlmostEqual(&test, rTM, 0.987438446568627);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9874384402651386);
    AssertAlmostEqual(&test, rTM, 0.9874384527472908);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9874378224140901);
    AssertAlmostEqual(&test, rTM, 0.9874390705675333);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9873761929340112);
    AssertAlmostEqual(&test, rTM, 0.9875003950094176);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9822817279203979);
    AssertAlmostEqual(&test, rTM, 0.9911010933141677);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8807713536573997);
    AssertAlmostEqual(&test, rTM, 0.9987404624395838);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3035236920712894);
    AssertAlmostEqual(&test, rTM, 0.9998504765056824);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.006180701165526718);
    AssertAlmostEqual(&test, rTM, 0.9999191127038083);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.257040620775566e-05);
    AssertAlmostEqual(&test, rTM, 0.9999200964043473);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.257815935311333e-07);
    AssertAlmostEqual(&test, rTM, 0.9999201063025352);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.25782368966955e-09);
    AssertAlmostEqual(&test, rTM, 0.9999201064015233);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9604805979297079);
    AssertAlmostEqual(&test, rTM, 0.9604805979297082);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9604805979296887);
    AssertAlmostEqual(&test, rTM, 0.9604805979297274);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9604805979277719);
    AssertAlmostEqual(&test, rTM, 0.9604805979316442);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9604805977360942);
    AssertAlmostEqual(&test, rTM, 0.9604805981233219);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9604805785683285);
    AssertAlmostEqual(&test, rTM, 0.9604806172910784);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9604786618416163);
    AssertAlmostEqual(&test, rTM, 0.9604825339248656);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9602874853248823);
    AssertAlmostEqual(&test, rTM, 0.9606727903128297);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.944575795172266);
    AssertAlmostEqual(&test, rTM, 0.971887263663597);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6686260282241615);
    AssertAlmostEqual(&test, rTM, 0.9959160677591546);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05492351842194614);
    AssertAlmostEqual(&test, rTM, 0.9990932601419751);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006142338568226355);
    AssertAlmostEqual(&test, rTM, 0.9991866405989963);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.149821637827893e-06);
    AssertAlmostEqual(&test, rTM, 0.999187628778046);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.149896583597372e-08);
    AssertAlmostEqual(&test, rTM, 0.9991876386659241);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8711283630699561);
    AssertAlmostEqual(&test, rTM, 0.8711283630699561);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8711283630699556);
    AssertAlmostEqual(&test, rTM, 0.8711283630699567);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8711283630698962);
    AssertAlmostEqual(&test, rTM, 0.8711283630700161);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8711283630639564);
    AssertAlmostEqual(&test, rTM, 0.8711283630759559);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8711283624699773);
    AssertAlmostEqual(&test, rTM, 0.871128363669935);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8711283030720915);
    AssertAlmostEqual(&test, rTM, 0.8711284230677946);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8711223634531476);
    AssertAlmostEqual(&test, rTM, 0.8711343624267011);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8705300893738237);
    AssertAlmostEqual(&test, rTM, 0.8717240617628536);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8228682480904426);
    AssertAlmostEqual(&test, rTM, 0.9069113173480373);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2738449780112648);
    AssertAlmostEqual(&test, rTM, 0.9834946102224562);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.005190437186477054);
    AssertAlmostEqual(&test, rTM, 0.9904595408300279);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.244709931967634e-05);
    AssertAlmostEqual(&test, rTM, 0.9905566167474672);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.245259805148961e-07);
    AssertAlmostEqual(&test, rTM, 0.9905575927164654);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5098939911112277);
    AssertAlmostEqual(&test, rTM, 0.5098939911112277);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5098939911112276);
    AssertAlmostEqual(&test, rTM, 0.5098939911112277);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.509893991111226);
    AssertAlmostEqual(&test, rTM, 0.5098939911112292);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5098939911110622);
    AssertAlmostEqual(&test, rTM, 0.5098939911113931);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5098939910946767);
    AssertAlmostEqual(&test, rTM, 0.5098939911277786);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5098939894561306);
    AssertAlmostEqual(&test, rTM, 0.5098939927663246);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5098938256015954);
    AssertAlmostEqual(&test, rTM, 0.5098941566208222);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5098774408666846);
    AssertAlmostEqual(&test, rTM, 0.5099105409783093);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5082461140926439);
    AssertAlmostEqual(&test, rTM, 0.5115381344430641);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3921541265796911);
    AssertAlmostEqual(&test, rTM, 0.6111969823673365);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02017776443970952);
    AssertAlmostEqual(&test, rTM, 0.8022851835765152);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000212164202579115);
    AssertAlmostEqual(&test, rTM, 0.8092875604685328);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.122743704753341e-06);
    AssertAlmostEqual(&test, rTM, 0.8093600237218507);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02879699448737809);
    AssertAlmostEqual(&test, rTM, 0.02879699448737809);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02879699448737809);
    AssertAlmostEqual(&test, rTM, 0.02879699448737809);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02879699448737809);
    AssertAlmostEqual(&test, rTM, 0.0287969944873781);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02879699448737782);
    AssertAlmostEqual(&test, rTM, 0.02879699448737836);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02879699448735091);
    AssertAlmostEqual(&test, rTM, 0.02879699448740528);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0287969944846596);
    AssertAlmostEqual(&test, rTM, 0.02879699449009658);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02879699421552925);
    AssertAlmostEqual(&test, rTM, 0.02879699475922693);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02879696730251915);
    AssertAlmostEqual(&test, rTM, 0.02879702167223699);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02879427625573471);
    AssertAlmostEqual(&test, rTM, 0.02879971271859557);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02852769001440345);
    AssertAlmostEqual(&test, rTM, 0.02906629477995266);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0148160285768213);
    AssertAlmostEqual(&test, rTM, 0.04276670237948069);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003020948475711881);
    AssertAlmostEqual(&test, rTM, 0.05724516808727571);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.052678366885236e-06);
    AssertAlmostEqual(&test, rTM, 0.05754322519043861);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003190887369992738);
    AssertAlmostEqual(&test, rTM, 0.0003190887369992738);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003190887369992738);
    AssertAlmostEqual(&test, rTM, 0.0003190887369992738);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003190887369992738);
    AssertAlmostEqual(&test, rTM, 0.0003190887369992738);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003190887369992738);
    AssertAlmostEqual(&test, rTM, 0.0003190887369992738);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003190887369992706);
    AssertAlmostEqual(&test, rTM, 0.000319088736999277);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003190887369989549);
    AssertAlmostEqual(&test, rTM, 0.0003190887369995927);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003190887369673853);
    AssertAlmostEqual(&test, rTM, 0.0003190887370311623);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003190887338104222);
    AssertAlmostEqual(&test, rTM, 0.0003190887401881255);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003190884181144258);
    AssertAlmostEqual(&test, rTM, 0.0003190890558841218);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003190568516691017);
    AssertAlmostEqual(&test, rTM, 0.0003191206223294452);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003159314381807761);
    AssertAlmostEqual(&test, rTM, 0.0003222460358114098);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001595952813704878);
    AssertAlmostEqual(&test, rTM, 0.0004785821763939976);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.16129159407402e-06);
    AssertAlmostEqual(&test, rTM, 0.0006350161187078901);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.207605017811231e-06);
    AssertAlmostEqual(&test, rTM, 3.207605017811231e-06);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.207605017811231e-06);
    AssertAlmostEqual(&test, rTM, 3.207605017811231e-06);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.207605017811231e-06);
    AssertAlmostEqual(&test, rTM, 3.207605017811231e-06);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.207605017811231e-06);
    AssertAlmostEqual(&test, rTM, 3.207605017811231e-06);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.207605017811231e-06);
    AssertAlmostEqual(&test, rTM, 3.207605017811231e-06);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.207605017811199e-06);
    AssertAlmostEqual(&test, rTM, 3.207605017811263e-06);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.207605017808024e-06);
    AssertAlmostEqual(&test, rTM, 3.207605017814439e-06);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.207605017490473e-06);
    AssertAlmostEqual(&test, rTM, 3.20760501813199e-06);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.207604985735387e-06);
    AssertAlmostEqual(&test, rTM, 3.207605049887075e-06);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.207601810229998e-06);
    AssertAlmostEqual(&test, rTM, 3.207608225392464e-06);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.207284291439621e-06);
    AssertAlmostEqual(&test, rTM, 3.207925744182841e-06);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.175846754007743e-06);
    AssertAlmostEqual(&test, rTM, 3.239363281614713e-06);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.603807653274716e-06);
    AssertAlmostEqual(&test, rTM, 4.811402382331246e-06);

    userdata[0] = 8/CAPS_HBAR_EV; /* 8eV */
    userdata[1] = 1e-05/CAPS_HBAR_EV; /* 1e-05eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999505769023);
    AssertAlmostEqual(&test, rTM, 0.9999999752884509);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999996487829536);
    AssertAlmostEqual(&test, rTM, 0.9999999965226029);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999965050905308);
    AssertAlmostEqual(&test, rTM, 0.9999999996505434);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999650531847449);
    AssertAlmostEqual(&test, rTM, 0.9999999999650526);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999650586974613);
    AssertAlmostEqual(&test, rTM, 0.9999999999965052);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9965113604276313);
    AssertAlmostEqual(&test, rTM, 0.9999999999996505);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9656579173960909);
    AssertAlmostEqual(&test, rTM, 0.999999999999965);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7062968466566569);
    AssertAlmostEqual(&test, rTM, 0.9999999999999964);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.07070883262445961);
    AssertAlmostEqual(&test, rTM, 0.9999999999999993);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0008174472414142488);
    AssertAlmostEqual(&test, rTM, 0.9999999999999993);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.18771913977295e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999999993);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.187851878090544e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999999993);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.187853205500888e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999999999993);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999998888378209);
    AssertAlmostEqual(&test, rTM, 0.9999998899384365);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999999843573131);
    AssertAlmostEqual(&test, rTM, 0.9999999217865625);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999988883787653);
    AssertAlmostEqual(&test, rTM, 0.9999999889938431);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999889384572924);
    AssertAlmostEqual(&test, rTM, 0.9999999988939502);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998893955533922);
    AssertAlmostEqual(&test, rTM, 0.9999999998893896);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9988945064747262);
    AssertAlmostEqual(&test, rTM, 0.999999999988939);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9889999534149128);
    AssertAlmostEqual(&test, rTM, 0.9999999999988939);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8953378023802403);
    AssertAlmostEqual(&test, rTM, 0.9999999999998892);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3477377000649228);
    AssertAlmostEqual(&test, rTM, 0.9999999999999873);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.008042541614227051);
    AssertAlmostEqual(&test, rTM, 0.9999999999999938);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.172148261245755e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999999939);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.173470743997134e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999999939);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.173483971526634e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999999999939);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999998791840493);
    AssertAlmostEqual(&test, rTM, 0.9999987918417012);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999987917806906);
    AssertAlmostEqual(&test, rTM, 0.9999987919015004);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999987858153332);
    AssertAlmostEqual(&test, rTM, 0.9999987978369563);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999982914057215);
    AssertAlmostEqual(&test, rTM, 0.9999991457024958);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999878582196725);
    AssertAlmostEqual(&test, rTM, 0.9999998797836306);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998791852948354);
    AssertAlmostEqual(&test, rTM, 0.9999999879190078);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.99879256936831);
    AssertAlmostEqual(&test, rTM, 0.9999999987918408);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9879911656634824);
    AssertAlmostEqual(&test, rTM, 0.9999999998791819);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.886262049713745);
    AssertAlmostEqual(&test, rTM, 0.9999999999878963);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3183383955452694);
    AssertAlmostEqual(&test, rTM, 0.9999999999985885);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.006758665113517963);
    AssertAlmostEqual(&test, rTM, 0.9999999999992603);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.850020285761104e-05);
    AssertAlmostEqual(&test, rTM, 0.99999999999927);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.850949450643491e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999992701);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999939943940761);
    AssertAlmostEqual(&test, rTM, 0.9999939943941362);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999939943911034);
    AssertAlmostEqual(&test, rTM, 0.9999939943971089);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999939940938343);
    AssertAlmostEqual(&test, rTM, 0.999993994694363);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999939644408641);
    AssertAlmostEqual(&test, rTM, 0.9999940241986968);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999915068012585);
    AssertAlmostEqual(&test, rTM, 0.9999957533916124);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999396460478827);
    AssertAlmostEqual(&test, rTM, 0.9999994024182625);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993995879084194);
    AssertAlmostEqual(&test, rTM, 0.9999999399467624);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.994012379771038);
    AssertAlmostEqual(&test, rTM, 0.999999993994352);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9417200664859886);
    AssertAlmostEqual(&test, rTM, 0.999999999399167);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5532835009534702);
    AssertAlmostEqual(&test, rTM, 0.9999999999372946);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02628726675649031);
    AssertAlmostEqual(&test, rTM, 0.9999999999809925);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000277104137706705);
    AssertAlmostEqual(&test, rTM, 0.9999999999819562);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.772562375434895e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999819661);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999499235406105);
    AssertAlmostEqual(&test, rTM, 0.9999499235406155);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999499235403626);
    AssertAlmostEqual(&test, rTM, 0.9999499235408634);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999499235155754);
    AssertAlmostEqual(&test, rTM, 0.9999499235656506);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999499210369154);
    AssertAlmostEqual(&test, rTM, 0.9999499260441855);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999496737874464);
    AssertAlmostEqual(&test, rTM, 0.9999501720543641);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999291819264681);
    AssertAlmostEqual(&test, rTM, 0.9999645903363008);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994968518371701);
    AssertAlmostEqual(&test, rTM, 0.9999950170935507);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9950045027321116);
    AssertAlmostEqual(&test, rTM, 0.9999994992464601);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9511604561043878);
    AssertAlmostEqual(&test, rTM, 0.9999999499066176);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6091523852987852);
    AssertAlmostEqual(&test, rTM, 0.9999999948376352);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03698116467263799);
    AssertAlmostEqual(&test, rTM, 0.9999999986498095);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003984417791640054);
    AssertAlmostEqual(&test, rTM, 0.9999999987451117);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.987563005821559e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999987461013);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995104383589104);
    AssertAlmostEqual(&test, rTM, 0.999510438358911);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995104383588862);
    AssertAlmostEqual(&test, rTM, 0.9995104383589352);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995104383564635);
    AssertAlmostEqual(&test, rTM, 0.9995104383613579);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995104381141898);
    AssertAlmostEqual(&test, rTM, 0.9995104386036314);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999510413887434);
    AssertAlmostEqual(&test, rTM, 0.9995104628291646);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995079972406318);
    AssertAlmostEqual(&test, rTM, 0.9995128673683009);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993077254990734);
    AssertAlmostEqual(&test, rTM, 0.9996538028129192);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9950908560213525);
    AssertAlmostEqual(&test, rTM, 0.9999512759100454);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9522137819933532);
    AssertAlmostEqual(&test, rTM, 0.999995101974307);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6157484717967937);
    AssertAlmostEqual(&test, rTM, 0.9999994958550177);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03855013073654811);
    AssertAlmostEqual(&test, rTM, 0.9999998704915218);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004166875882312475);
    AssertAlmostEqual(&test, rTM, 0.9999998800060603);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.170315842035337e-06);
    AssertAlmostEqual(&test, rTM, 0.9999998801050186);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9951263388757988);
    AssertAlmostEqual(&test, rTM, 0.9951263388757988);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9951263388757964);
    AssertAlmostEqual(&test, rTM, 0.9951263388758013);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9951263388755557);
    AssertAlmostEqual(&test, rTM, 0.9951263388760418);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.99512633885149);
    AssertAlmostEqual(&test, rTM, 0.9951263389001076);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9951263364449215);
    AssertAlmostEqual(&test, rTM, 0.9951263413066749);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.995126095794114);
    AssertAlmostEqual(&test, rTM, 0.9951265819453896);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9951020908624287);
    AssertAlmostEqual(&test, rTM, 0.9951504671366468);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9931145727647417);
    AssertAlmostEqual(&test, rTM, 0.9965513294819913);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9520911045158806);
    AssertAlmostEqual(&test, rTM, 0.9995138411549803);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.616406299969415);
    AssertAlmostEqual(&test, rTM, 0.9999497115792888);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03871435630497976);
    AssertAlmostEqual(&test, rTM, 0.9999871044245715);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004186044959870366);
    AssertAlmostEqual(&test, rTM, 0.9999880556959486);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.189516693294659e-06);
    AssertAlmostEqual(&test, rTM, 0.9999880655915857);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9523337695861607);
    AssertAlmostEqual(&test, rTM, 0.9523337695861607);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9523337695861605);
    AssertAlmostEqual(&test, rTM, 0.9523337695861609);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9523337695861374);
    AssertAlmostEqual(&test, rTM, 0.9523337695861839);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9523337695838355);
    AssertAlmostEqual(&test, rTM, 0.9523337695884858);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9523337693536483);
    AssertAlmostEqual(&test, rTM, 0.9523337698186729);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9523337463349371);
    AssertAlmostEqual(&test, rTM, 0.9523337928373732);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9523314445241906);
    AssertAlmostEqual(&test, rTM, 0.9523360945374931);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9521018642675921);
    AssertAlmostEqual(&test, rTM, 0.9525645793873745);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9332679614474628);
    AssertAlmostEqual(&test, rTM, 0.9660480077228975);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6150312383927459);
    AssertAlmostEqual(&test, rTM, 0.9950109918530409);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03872731144872401);
    AssertAlmostEqual(&test, rTM, 0.9987125843697001);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004187967433925799);
    AssertAlmostEqual(&test, rTM, 0.9988075279131496);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.191446465888992e-06);
    AssertAlmostEqual(&test, rTM, 0.9988085157250105);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6164950257484946);
    AssertAlmostEqual(&test, rTM, 0.6164950257484946);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6164950257484945);
    AssertAlmostEqual(&test, rTM, 0.6164950257484946);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.616495025748493);
    AssertAlmostEqual(&test, rTM, 0.616495025748496);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6164950257483482);
    AssertAlmostEqual(&test, rTM, 0.6164950257486408);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6164950257338685);
    AssertAlmostEqual(&test, rTM, 0.6164950257631205);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6164950242858924);
    AssertAlmostEqual(&test, rTM, 0.6164950272110966);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6164948794883361);
    AssertAlmostEqual(&test, rTM, 0.6164951720086104);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6164804002867577);
    AssertAlmostEqual(&test, rTM, 0.6165096507848087);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6150379915147494);
    AssertAlmostEqual(&test, rTM, 0.6179478498378865);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5077801906022371);
    AssertAlmostEqual(&test, rTM, 0.705882239470921);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03837739792957569);
    AssertAlmostEqual(&test, rTM, 0.8854092766062834);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004187745953636915);
    AssertAlmostEqual(&test, rTM, 0.8933437125673986);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.191635395398481e-06);
    AssertAlmostEqual(&test, rTM, 0.8934274012160297);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03873271159330274);
    AssertAlmostEqual(&test, rTM, 0.03873271159330274);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03873271159330274);
    AssertAlmostEqual(&test, rTM, 0.03873271159330274);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03873271159330273);
    AssertAlmostEqual(&test, rTM, 0.03873271159330274);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03873271159330238);
    AssertAlmostEqual(&test, rTM, 0.03873271159330309);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03873271159326689);
    AssertAlmostEqual(&test, rTM, 0.03873271159333858);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03873271158971832);
    AssertAlmostEqual(&test, rTM, 0.03873271159688715);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03873271123486126);
    AssertAlmostEqual(&test, rTM, 0.03873271195174421);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03873267574918834);
    AssertAlmostEqual(&test, rTM, 0.03873274743741702);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03872912751071891);
    AssertAlmostEqual(&test, rTM, 0.03873629567488996);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03837756164967921);
    AssertAlmostEqual(&test, rTM, 0.03908785175168676);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02012344416709851);
    AssertAlmostEqual(&test, rTM, 0.05731515079555247);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004146750866075073);
    AssertAlmostEqual(&test, rTM, 0.07693717453158022);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.191239775432759e-06);
    AssertAlmostEqual(&test, rTM, 0.0773452157037158);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000418818558219646);
    AssertAlmostEqual(&test, rTM, 0.000418818558219646);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000418818558219646);
    AssertAlmostEqual(&test, rTM, 0.000418818558219646);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000418818558219646);
    AssertAlmostEqual(&test, rTM, 0.000418818558219646);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000418818558219646);
    AssertAlmostEqual(&test, rTM, 0.0004188185582196461);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004188185582196418);
    AssertAlmostEqual(&test, rTM, 0.0004188185582196502);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004188185582192276);
    AssertAlmostEqual(&test, rTM, 0.0004188185582200645);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004188185581777992);
    AssertAlmostEqual(&test, rTM, 0.0004188185582614928);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004188185540349672);
    AssertAlmostEqual(&test, rTM, 0.0004188185624043248);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000418818139752177);
    AssertAlmostEqual(&test, rTM, 0.000418818976687115);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004187767156116923);
    AssertAlmostEqual(&test, rTM, 0.0004188604008275982);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004146752774720061);
    AssertAlmostEqual(&test, rTM, 0.0004229618389529064);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000209496992781398);
    AssertAlmostEqual(&test, rTM, 0.0006281400869563901);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.150159578926753e-06);
    AssertAlmostEqual(&test, rTM, 0.0008334868128287877);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.191661019886301e-06);
    AssertAlmostEqual(&test, rTM, 4.191661019886301e-06);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.191661019886301e-06);
    AssertAlmostEqual(&test, rTM, 4.191661019886301e-06);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.191661019886301e-06);
    AssertAlmostEqual(&test, rTM, 4.191661019886301e-06);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.191661019886301e-06);
    AssertAlmostEqual(&test, rTM, 4.191661019886301e-06);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.191661019886301e-06);
    AssertAlmostEqual(&test, rTM, 4.191661019886302e-06);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.191661019886259e-06);
    AssertAlmostEqual(&test, rTM, 4.191661019886343e-06);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.19166101988211e-06);
    AssertAlmostEqual(&test, rTM, 4.191661019890493e-06);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.191661019467138e-06);
    AssertAlmostEqual(&test, rTM, 4.191661020305463e-06);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.191660977970043e-06);
    AssertAlmostEqual(&test, rTM, 4.19166106180256e-06);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.191656828264613e-06);
    AssertAlmostEqual(&test, rTM, 4.19166521150799e-06);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.191241899210019e-06);
    AssertAlmostEqual(&test, rTM, 4.192080140562584e-06);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.150159770105058e-06);
    AssertAlmostEqual(&test, rTM, 4.23316226966753e-06);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.095839294963409e-06);
    AssertAlmostEqual(&test, rTM, 6.287482744772369e-06);

    userdata[0] = 8/CAPS_HBAR_EV; /* 8eV */
    userdata[1] = 0.0001/CAPS_HBAR_EV; /* 0.0001eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999998437241889);
    AssertAlmostEqual(&test, rTM, 0.9999999218620914);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999988894522329);
    AssertAlmostEqual(&test, rTM, 0.9999999890044715);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999889491391226);
    AssertAlmostEqual(&test, rTM, 0.9999999988950183);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998895023557794);
    AssertAlmostEqual(&test, rTM, 0.9999999998894964);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9988955734357393);
    AssertAlmostEqual(&test, rTM, 0.9999999999889496);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9890105172281221);
    AssertAlmostEqual(&test, rTM, 0.999999999998895);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8954332964295875);
    AssertAlmostEqual(&test, rTM, 0.9999999999998893);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3480629244944954);
    AssertAlmostEqual(&test, rTM, 0.9999999999999873);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.008057848468796308);
    AssertAlmostEqual(&test, rTM, 0.9999999999999938);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.187951893674243e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999999939);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.189279496622643e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999999939);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.189292775369821e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999999999939);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.189292908157564e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999999999939);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999996487829536);
    AssertAlmostEqual(&test, rTM, 0.9999996522603495);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999995057691323);
    AssertAlmostEqual(&test, rTM, 0.9999997528845356);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999964878350869);
    AssertAlmostEqual(&test, rTM, 0.9999999652260295);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999650514549524);
    AssertAlmostEqual(&test, rTM, 0.9999999965054339);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996505868016837);
    AssertAlmostEqual(&test, rTM, 0.9999999996505261);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9965113604103927);
    AssertAlmostEqual(&test, rTM, 0.9999999999650525);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9656579173944206);
    AssertAlmostEqual(&test, rTM, 0.9999999999965047);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7062968466565366);
    AssertAlmostEqual(&test, rTM, 0.9999999999996453);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.07070883262445901);
    AssertAlmostEqual(&test, rTM, 0.9999999999999296);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0008174472414142488);
    AssertAlmostEqual(&test, rTM, 0.9999999999999388);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.187719139772952e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999999389);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.187851878090544e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999999389);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.187853205500889e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999999999389);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999964716344679);
    AssertAlmostEqual(&test, rTM, 0.9999964716379963);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999964714598186);
    AssertAlmostEqual(&test, rTM, 0.9999964718126367);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999964540383299);
    AssertAlmostEqual(&test, rTM, 0.9999964891467996);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999950101437528);
    AssertAlmostEqual(&test, rTM, 0.9999975050687641);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999645409491184);
    AssertAlmostEqual(&test, rTM, 0.9999996489141252);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996472076070424);
    AssertAlmostEqual(&test, rTM, 0.9999999647180642);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9964778474561219);
    AssertAlmostEqual(&test, rTM, 0.9999999964716263);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9653332793126481);
    AssertAlmostEqual(&test, rTM, 0.9999999996471081);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7039612865775773);
    AssertAlmostEqual(&test, rTM, 0.9999999999641714);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.06954173978741048);
    AssertAlmostEqual(&test, rTM, 0.9999999999928448);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0008019640558618221);
    AssertAlmostEqual(&test, rTM, 0.9999999999937653);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.032389935394966e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999937752);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.032517685098903e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999937753);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999879184765943);
    AssertAlmostEqual(&test, rTM, 0.9999879184767152);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999987918470614);
    AssertAlmostEqual(&test, rTM, 0.9999879184826954);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999879178725973);
    AssertAlmostEqual(&test, rTM, 0.999987919080682);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999878582196725);
    AssertAlmostEqual(&test, rTM, 0.9999879784345966);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999829141885829);
    AssertAlmostEqual(&test, rTM, 0.9999914570578003);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999878588830611);
    AssertAlmostEqual(&test, rTM, 0.9999987978369541);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.998792509638138);
    AssertAlmostEqual(&test, rTM, 0.9999998791900623);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9879911597550191);
    AssertAlmostEqual(&test, rTM, 0.9999999879181893);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8862620491846902);
    AssertAlmostEqual(&test, rTM, 0.999999998789638);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.318338395528974);
    AssertAlmostEqual(&test, rTM, 0.9999999998588514);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.006758665113511362);
    AssertAlmostEqual(&test, rTM, 0.9999999999260243);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.850020285761036e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999270075);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.850949450643491e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999270174);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.99993994556407);
    AssertAlmostEqual(&test, rTM, 0.9999399455640759);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999399455637727);
    AssertAlmostEqual(&test, rTM, 0.9999399455643733);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999399455340466);
    AssertAlmostEqual(&test, rTM, 0.9999399455940993);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999399425615164);
    AssertAlmostEqual(&test, rTM, 0.9999399485664794);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999396460478827);
    AssertAlmostEqual(&test, rTM, 0.9999402435939104);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999150712585861);
    AssertAlmostEqual(&test, rTM, 0.9999575347276243);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993966243784914);
    AssertAlmostEqual(&test, rTM, 0.9999940241984301);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9940120842814808);
    AssertAlmostEqual(&test, rTM, 0.9999993994651063);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9417200385033071);
    AssertAlmostEqual(&test, rTM, 0.9999999399167228);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5532834993781669);
    AssertAlmostEqual(&test, rTM, 0.9999999937294591);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02628726675402119);
    AssertAlmostEqual(&test, rTM, 0.9999999980992528);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002771041377064308);
    AssertAlmostEqual(&test, rTM, 0.9999999981956244);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.772562375434867e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999981966141);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994993482405703);
    AssertAlmostEqual(&test, rTM, 0.9994993482405709);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994993482405455);
    AssertAlmostEqual(&test, rTM, 0.9994993482405956);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999499348238068);
    AssertAlmostEqual(&test, rTM, 0.9994993482430732);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994993479903074);
    AssertAlmostEqual(&test, rTM, 0.9994993484908336);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994993232148764);
    AssertAlmostEqual(&test, rTM, 0.9994993732650141);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994968518371701);
    AssertAlmostEqual(&test, rTM, 0.9995018322609839);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9992920449206871);
    AssertAlmostEqual(&test, rTM, 0.9996459597770115);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9949799004451646);
    AssertAlmostEqual(&test, rTM, 0.999950171899718);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9511580991245502);
    AssertAlmostEqual(&test, rTM, 0.9999949909222738);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6091522388211683);
    AssertAlmostEqual(&test, rTM, 0.999999483763927);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03698116433263739);
    AssertAlmostEqual(&test, rTM, 0.9999998649809611);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003984417791245911);
    AssertAlmostEqual(&test, rTM, 0.9999998745111873);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.987563005817611e-06);
    AssertAlmostEqual(&test, rTM, 0.9999998746101475);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9951151595180494);
    AssertAlmostEqual(&test, rTM, 0.9951151595180495);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9951151595180471);
    AssertAlmostEqual(&test, rTM, 0.9951151595180519);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9951151595178058);
    AssertAlmostEqual(&test, rTM, 0.9951151595182931);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.995115159493685);
    AssertAlmostEqual(&test, rTM, 0.9951151595424139);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9951151570816098);
    AssertAlmostEqual(&test, rTM, 0.9951151619544879);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9951149158801482);
    AssertAlmostEqual(&test, rTM, 0.9951154031438293);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9950908560213525);
    AssertAlmostEqual(&test, rTM, 0.99513934298956);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9930987948110789);
    AssertAlmostEqual(&test, rTM, 0.9965434131022283);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9519836496904944);
    AssertAlmostEqual(&test, rTM, 0.999512722861652);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6157339752859776);
    AssertAlmostEqual(&test, rTM, 0.9999495894130828);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03855009540523108);
    AssertAlmostEqual(&test, rTM, 0.9999870493129821);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004166875841094768);
    AssertAlmostEqual(&test, rTM, 0.9999880007485193);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.170315841622479e-06);
    AssertAlmostEqual(&test, rTM, 0.9999880106441748);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9523230605930578);
    AssertAlmostEqual(&test, rTM, 0.9523230605930578);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9523230605930576);
    AssertAlmostEqual(&test, rTM, 0.952323060593058);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9523230605930345);
    AssertAlmostEqual(&test, rTM, 0.952323060593081);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9523230605907321);
    AssertAlmostEqual(&test, rTM, 0.9523230605953834);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9523230603604946);
    AssertAlmostEqual(&test, rTM, 0.952323060825621);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9523230373367444);
    AssertAlmostEqual(&test, rTM, 0.9523230838493602);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9523207350221203);
    AssertAlmostEqual(&test, rTM, 0.9523253860533347);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9520911045158806);
    AssertAlmostEqual(&test, rTM, 0.9525539209256917);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9332531243015504);
    AssertAlmostEqual(&test, rTM, 0.9660403216841718);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6149637202883008);
    AssertAlmostEqual(&test, rTM, 0.9950097820285945);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03871080961459723);
    AssertAlmostEqual(&test, rTM, 0.9987120346234196);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000418604081915809);
    AssertAlmostEqual(&test, rTM, 0.998806979735444);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.189516651818792e-06);
    AssertAlmostEqual(&test, rTM, 0.9988079675466841);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6164882883266041);
    AssertAlmostEqual(&test, rTM, 0.6164882883266041);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6164882883266041);
    AssertAlmostEqual(&test, rTM, 0.6164882883266041);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6164882883266026);
    AssertAlmostEqual(&test, rTM, 0.6164882883266055);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6164882883264579);
    AssertAlmostEqual(&test, rTM, 0.6164882883267503);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6164882883119779);
    AssertAlmostEqual(&test, rTM, 0.6164882883412303);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6164882868639862);
    AssertAlmostEqual(&test, rTM, 0.616488289789222);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.616488142064865);
    AssertAlmostEqual(&test, rTM, 0.6164884345883006);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6164736627068116);
    AssertAlmostEqual(&test, rTM, 0.616502913520975);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6150312383927459);
    AssertAlmostEqual(&test, rTM, 0.6179411281276397);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5077725546500068);
    AssertAlmostEqual(&test, rTM, 0.7058764961117056);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03837576080547855);
    AssertAlmostEqual(&test, rTM, 0.8854049347253674);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004187553213665774);
    AssertAlmostEqual(&test, rTM, 0.8933393271137245);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.191442316395925e-06);
    AssertAlmostEqual(&test, rTM, 0.8934230151592943);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03873254647561535);
    AssertAlmostEqual(&test, rTM, 0.03873254647561535);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03873254647561535);
    AssertAlmostEqual(&test, rTM, 0.03873254647561535);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03873254647561535);
    AssertAlmostEqual(&test, rTM, 0.03873254647561535);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03873254647561499);
    AssertAlmostEqual(&test, rTM, 0.03873254647561571);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03873254647557951);
    AssertAlmostEqual(&test, rTM, 0.03873254647565119);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03873254647203095);
    AssertAlmostEqual(&test, rTM, 0.03873254647919975);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03873254611717528);
    AssertAlmostEqual(&test, rTM, 0.03873254683405541);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0387325106316419);
    AssertAlmostEqual(&test, rTM, 0.0387325823195887);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03872896240712523);
    AssertAlmostEqual(&test, rTM, 0.03873613054310889);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03837739792957569);
    AssertAlmostEqual(&test, rTM, 0.03908768523653436);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02012335512482844);
    AssertAlmostEqual(&test, rTM, 0.05731490993618506);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004146731779721836);
    AssertAlmostEqual(&test, rTM, 0.07693684765507482);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.191220468465493e-06);
    AssertAlmostEqual(&test, rTM, 0.07734488696988465);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004188183654496978);
    AssertAlmostEqual(&test, rTM, 0.0004188183654496978);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004188183654496978);
    AssertAlmostEqual(&test, rTM, 0.0004188183654496978);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004188183654496978);
    AssertAlmostEqual(&test, rTM, 0.0004188183654496978);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004188183654496977);
    AssertAlmostEqual(&test, rTM, 0.0004188183654496978);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004188183654496936);
    AssertAlmostEqual(&test, rTM, 0.000418818365449702);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004188183654492793);
    AssertAlmostEqual(&test, rTM, 0.0004188183654501162);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000418818365407851);
    AssertAlmostEqual(&test, rTM, 0.0004188183654915446);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004188183612650209);
    AssertAlmostEqual(&test, rTM, 0.0004188183696343747);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004188179469824212);
    AssertAlmostEqual(&test, rTM, 0.0004188187839169744);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004187765228609869);
    AssertAlmostEqual(&test, rTM, 0.0004188602080384072);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004146750866075074);
    AssertAlmostEqual(&test, rTM, 0.0004229616442775086);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002094968963156756);
    AssertAlmostEqual(&test, rTM, 0.0006281397978822668);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.150157667144675e-06);
    AssertAlmostEqual(&test, rTM, 0.0008334864292008723);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.191660826796246e-06);
    AssertAlmostEqual(&test, rTM, 4.191660826796246e-06);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.191660826796246e-06);
    AssertAlmostEqual(&test, rTM, 4.191660826796246e-06);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.191660826796246e-06);
    AssertAlmostEqual(&test, rTM, 4.191660826796246e-06);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.191660826796246e-06);
    AssertAlmostEqual(&test, rTM, 4.191660826796246e-06);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.191660826796245e-06);
    AssertAlmostEqual(&test, rTM, 4.191660826796246e-06);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.191660826796203e-06);
    AssertAlmostEqual(&test, rTM, 4.191660826796287e-06);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.191660826792054e-06);
    AssertAlmostEqual(&test, rTM, 4.191660826800437e-06);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.191660826377083e-06);
    AssertAlmostEqual(&test, rTM, 4.191660827215408e-06);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.191660784879989e-06);
    AssertAlmostEqual(&test, rTM, 4.191660868712502e-06);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.19165663517475e-06);
    AssertAlmostEqual(&test, rTM, 4.191665018417741e-06);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.191241706139269e-06);
    AssertAlmostEqual(&test, rTM, 4.192079947453221e-06);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.150159578926753e-06);
    AssertAlmostEqual(&test, rTM, 4.233162074665723e-06);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.095839198417572e-06);
    AssertAlmostEqual(&test, rTM, 6.287482455138096e-06);

    userdata[0] = 8/CAPS_HBAR_EV; /* 8eV */
    userdata[1] = 0.001/CAPS_HBAR_EV; /* 0.001eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999995058169222);
    AssertAlmostEqual(&test, rTM, 0.9999997529084306);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999996488174697);
    AssertAlmostEqual(&test, rTM, 0.9999999652293919);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999650548342618);
    AssertAlmostEqual(&test, rTM, 0.9999999965057718);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996506205824788);
    AssertAlmostEqual(&test, rTM, 0.9999999996505599);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9965116971568927);
    AssertAlmostEqual(&test, rTM, 0.999999999965056);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.96566118010971);
    AssertAlmostEqual(&test, rTM, 0.999999999996505);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7063203584405167);
    AssertAlmostEqual(&test, rTM, 0.9999999999996453);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.07072070240807805);
    AssertAlmostEqual(&test, rTM, 0.9999999999999296);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0008176050930216019);
    AssertAlmostEqual(&test, rTM, 0.9999999999999388);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.189302775396652e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999999389);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.189435565066941e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999999389);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.189436892990828e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999999999389);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.18943690627007e-12);
    AssertAlmostEqual(&test, rTM, 0.9999999999999389);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999988894522329);
    AssertAlmostEqual(&test, rTM, 0.9999989004477493);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999984372429889);
    AssertAlmostEqual(&test, rTM, 0.9999992186211891);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999888945778279);
    AssertAlmostEqual(&test, rTM, 0.9999998900447206);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998894968865891);
    AssertAlmostEqual(&test, rTM, 0.999999988950183);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9988955728893504);
    AssertAlmostEqual(&test, rTM, 0.9999999988949635);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9890105171740247);
    AssertAlmostEqual(&test, rTM, 0.9999999998894946);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8954332964246969);
    AssertAlmostEqual(&test, rTM, 0.9999999999889327);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3480629244943287);
    AssertAlmostEqual(&test, rTM, 0.9999999999987375);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.008057848468796232);
    AssertAlmostEqual(&test, rTM, 0.9999999999993795);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.187951893674243e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999993894);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.189279496622644e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999993895);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.189292775369821e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999999993895);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.189292908157565e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999999993895);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999889390047946);
    AssertAlmostEqual(&test, rTM, 0.9999889390158555);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999889384572924);
    AssertAlmostEqual(&test, rTM, 0.99998893956333);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999888838432587);
    AssertAlmostEqual(&test, rTM, 0.9999889939036108);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999843574342228);
    AssertAlmostEqual(&test, rTM, 0.9999921786865248);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998888439930809);
    AssertAlmostEqual(&test, rTM, 0.9999988993849084);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.998894451237527);
    AssertAlmostEqual(&test, rTM, 0.9999998893950108);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9889999479458553);
    AssertAlmostEqual(&test, rTM, 0.9999999889387856);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8953378018858764);
    AssertAlmostEqual(&test, rTM, 0.9999999988922046);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3477377000480951);
    AssertAlmostEqual(&test, rTM, 0.9999999998736003);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.008042541614219139);
    AssertAlmostEqual(&test, rTM, 0.9999999999378346);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.172148261245674e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999388166);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.173470743997133e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999388265);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.173483971526635e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999999388266);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999647169223622);
    AssertAlmostEqual(&test, rTM, 0.999964716922715);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999647169048974);
    AssertAlmostEqual(&test, rTM, 0.9999647169401799);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.99996471515846);
    AssertAlmostEqual(&test, rTM, 0.9999647186865291);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999645409491184);
    AssertAlmostEqual(&test, rTM, 0.9999648920226671);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999501025579585);
    AssertAlmostEqual(&test, rTM, 0.9999750509677483);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996454660681654);
    AssertAlmostEqual(&test, rTM, 0.9999964891467455);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9964776734216467);
    AssertAlmostEqual(&test, rTM, 0.9999996471801545);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9653332624553135);
    AssertAlmostEqual(&test, rTM, 0.999999964710828);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7039612853667763);
    AssertAlmostEqual(&test, rTM, 0.9999999964171431);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.06954173978142113);
    AssertAlmostEqual(&test, rTM, 0.9999999992844845);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0008019640558610294);
    AssertAlmostEqual(&test, rTM, 0.9999999993765311);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.032389935394888e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999993775203);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.032517685098903e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999993775301);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998791913347468);
    AssertAlmostEqual(&test, rTM, 0.9998791913347588);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998791913341488);
    AssertAlmostEqual(&test, rTM, 0.9998791913353567);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998791912743521);
    AssertAlmostEqual(&test, rTM, 0.9998791913951535);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998791852948354);
    AssertAlmostEqual(&test, rTM, 0.9998791973743683);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999878588830611);
    AssertAlmostEqual(&test, rTM, 0.9998797908491415);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998291550220584);
    AssertAlmostEqual(&test, rTM, 0.9999145738620608);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9987865514953842);
    AssertAlmostEqual(&test, rTM, 0.999987978432425);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9879905689236315);
    AssertAlmostEqual(&test, rTM, 0.9999987918794604);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8862619962792181);
    AssertAlmostEqual(&test, rTM, 0.9999998789638693);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3183383938994298);
    AssertAlmostEqual(&test, rTM, 0.9999999858851357);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.006758665112851238);
    AssertAlmostEqual(&test, rTM, 0.9999999926024274);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.850020285754256e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999927007517);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.850949450643423e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999927017416);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993996179177584);
    AssertAlmostEqual(&test, rTM, 0.999399617917759);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993996179177287);
    AssertAlmostEqual(&test, rTM, 0.9993996179177888);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993996179147577);
    AssertAlmostEqual(&test, rTM, 0.9993996179207597);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993996176176579);
    AssertAlmostEqual(&test, rTM, 0.9993996182178594);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993995879084194);
    AssertAlmostEqual(&test, rTM, 0.9993996479255985);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993966243784914);
    AssertAlmostEqual(&test, rTM, 0.9994025966095588);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999151037117714);
    AssertAlmostEqual(&test, rTM, 0.9995754284092098);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9939826092639371);
    AssertAlmostEqual(&test, rTM, 0.9999402433271782);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.941717240309363);
    AssertAlmostEqual(&test, rTM, 0.9999939919877964);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5532833418479045);
    AssertAlmostEqual(&test, rTM, 0.9999993729464479);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.026287266507109);
    AssertAlmostEqual(&test, rTM, 0.9999998099253141);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002771041376790127);
    AssertAlmostEqual(&test, rTM, 0.9999998195624664);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.772562375432123e-06);
    AssertAlmostEqual(&test, rTM, 0.9999998196614387);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9950047518628845);
    AssertAlmostEqual(&test, rTM, 0.9950047518628845);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9950047518628821);
    AssertAlmostEqual(&test, rTM, 0.9950047518628871);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9950047518626354);
    AssertAlmostEqual(&test, rTM, 0.9950047518631336);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9950047518379709);
    AssertAlmostEqual(&test, rTM, 0.9950047518877982);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9950047493715148);
    AssertAlmostEqual(&test, rTM, 0.995004754354253);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9950045027321116);
    AssertAlmostEqual(&test, rTM, 0.9950050009812642);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9949799004451646);
    AssertAlmostEqual(&test, rTM, 0.9950294805630737);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9929429752467415);
    AssertAlmostEqual(&test, rTM, 0.996465229299716);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9509230170991086);
    AssertAlmostEqual(&test, rTM, 0.9995016777098609);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6091375916250725);
    AssertAlmostEqual(&test, rTM, 0.9999483804365273);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03698113033260862);
    AssertAlmostEqual(&test, rTM, 0.9999864982710645);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003984417751831596);
    AssertAlmostEqual(&test, rTM, 0.9999874512745676);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.987563005422845e-06);
    AssertAlmostEqual(&test, rTM, 0.9999874611703973);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9522161126468779);
    AssertAlmostEqual(&test, rTM, 0.9522161126468779);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9522161126468777);
    AssertAlmostEqual(&test, rTM, 0.9522161126468781);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9522161126468546);
    AssertAlmostEqual(&test, rTM, 0.9522161126469012);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9522161126445472);
    AssertAlmostEqual(&test, rTM, 0.9522161126492086);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9522161124138064);
    AssertAlmostEqual(&test, rTM, 0.9522161128799493);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9522160893397372);
    AssertAlmostEqual(&test, rTM, 0.9522161359540074);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9522137819933532);
    AssertAlmostEqual(&test, rTM, 0.9522184431895131);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9519836496904944);
    AssertAlmostEqual(&test, rTM, 0.9524474775903106);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9331049534595882);
    AssertAlmostEqual(&test, rTM, 0.9659635616995723);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6142898472707886);
    AssertAlmostEqual(&test, rTM, 0.9949976967797122);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03854656260103472);
    AssertAlmostEqual(&test, rTM, 0.9987065372708309);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004166871719328217);
    AssertAlmostEqual(&test, rTM, 0.998801497991491);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.170315800336697e-06);
    AssertAlmostEqual(&test, rTM, 0.998802485796514);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6164209271692208);
    AssertAlmostEqual(&test, rTM, 0.6164209271692208);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6164209271692208);
    AssertAlmostEqual(&test, rTM, 0.6164209271692209);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6164209271692194);
    AssertAlmostEqual(&test, rTM, 0.6164209271692224);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6164209271690746);
    AssertAlmostEqual(&test, rTM, 0.6164209271693671);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6164209271545931);
    AssertAlmostEqual(&test, rTM, 0.6164209271838487);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6164209257064449);
    AssertAlmostEqual(&test, rTM, 0.6164209286319968);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6164207808916806);
    AssertAlmostEqual(&test, rTM, 0.6164210734467186);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.616406299969415);
    AssertAlmostEqual(&test, rTM, 0.6164355539436166);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6149637202883008);
    AssertAlmostEqual(&test, rTM, 0.6178739240327421);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5076962121426665);
    AssertAlmostEqual(&test, rTM, 0.7058190721247102);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03835939725465428);
    AssertAlmostEqual(&test, rTM, 0.8853615183181492);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004185626789294676);
    AssertAlmostEqual(&test, rTM, 0.8932954749449918);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.189512504236207e-06);
    AssertAlmostEqual(&test, rTM, 0.893379156960371);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03873089537628324);
    AssertAlmostEqual(&test, rTM, 0.03873089537628324);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03873089537628324);
    AssertAlmostEqual(&test, rTM, 0.03873089537628324);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03873089537628323);
    AssertAlmostEqual(&test, rTM, 0.03873089537628324);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03873089537628287);
    AssertAlmostEqual(&test, rTM, 0.0387308953762836);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03873089537624739);
    AssertAlmostEqual(&test, rTM, 0.03873089537631907);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03873089537269898);
    AssertAlmostEqual(&test, rTM, 0.03873089537986749);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03873089501785727);
    AssertAlmostEqual(&test, rTM, 0.0387308957347092);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03873085953371922);
    AssertAlmostEqual(&test, rTM, 0.03873093121884715);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03872731144872401);
    AssertAlmostEqual(&test, rTM, 0.038734479302846);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03837576080547855);
    AssertAlmostEqual(&test, rTM, 0.03908602016315567);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02012246474548278);
    AssertAlmostEqual(&test, rTM, 0.05731250145393483);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004146540925852434);
    AssertAlmostEqual(&test, rTM, 0.07693357904277935);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.191027408575526e-06);
    AssertAlmostEqual(&test, rTM, 0.07734159978525744);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004188164377599755);
    AssertAlmostEqual(&test, rTM, 0.0004188164377599755);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004188164377599755);
    AssertAlmostEqual(&test, rTM, 0.0004188164377599755);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004188164377599755);
    AssertAlmostEqual(&test, rTM, 0.0004188164377599755);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004188164377599755);
    AssertAlmostEqual(&test, rTM, 0.0004188164377599755);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004188164377599713);
    AssertAlmostEqual(&test, rTM, 0.0004188164377599797);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000418816437759557);
    AssertAlmostEqual(&test, rTM, 0.000418816437760394);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004188164377181289);
    AssertAlmostEqual(&test, rTM, 0.0004188164378018221);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004188164335753178);
    AssertAlmostEqual(&test, rTM, 0.0004188164419446331);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004188160192946234);
    AssertAlmostEqual(&test, rTM, 0.0004188168562253276);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004187745953636916);
    AssertAlmostEqual(&test, rTM, 0.0004188582801562579);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004146731779721837);
    AssertAlmostEqual(&test, rTM, 0.000422959697533388);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002094959316633377);
    AssertAlmostEqual(&test, rTM, 0.0006281369071556666);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.150138549420779e-06);
    AssertAlmostEqual(&test, rTM, 0.0008334825929411403);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.191658895896668e-06);
    AssertAlmostEqual(&test, rTM, 4.191658895896668e-06);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.191658895896668e-06);
    AssertAlmostEqual(&test, rTM, 4.191658895896668e-06);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.191658895896668e-06);
    AssertAlmostEqual(&test, rTM, 4.191658895896668e-06);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.191658895896668e-06);
    AssertAlmostEqual(&test, rTM, 4.191658895896668e-06);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.191658895896668e-06);
    AssertAlmostEqual(&test, rTM, 4.191658895896669e-06);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.191658895896626e-06);
    AssertAlmostEqual(&test, rTM, 4.19165889589671e-06);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.191658895892477e-06);
    AssertAlmostEqual(&test, rTM, 4.19165889590086e-06);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.191658895477506e-06);
    AssertAlmostEqual(&test, rTM, 4.191658896315831e-06);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.191658853980431e-06);
    AssertAlmostEqual(&test, rTM, 4.191658937812906e-06);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.191654704277103e-06);
    AssertAlmostEqual(&test, rTM, 4.191663087516232e-06);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.19123977543276e-06);
    AssertAlmostEqual(&test, rTM, 4.192078016360577e-06);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.150157667144676e-06);
    AssertAlmostEqual(&test, rTM, 4.233160124648645e-06);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.09583823295969e-06);
    AssertAlmostEqual(&test, rTM, 6.287479558796823e-06);

    userdata[0] = 8/CAPS_HBAR_EV; /* 8eV */
    userdata[1] = 0.003/CAPS_HBAR_EV; /* 0.003eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999991440505133);
    AssertAlmostEqual(&test, rTM, 0.9999995720251651);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999993917351928);
    AssertAlmostEqual(&test, rTM, 0.9999999397755803);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999394740110744);
    AssertAlmostEqual(&test, rTM, 0.9999999939478231);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999394934886959);
    AssertAlmostEqual(&test, rTM, 0.9999999993947524);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9939658090548351);
    AssertAlmostEqual(&test, rTM, 0.999999999939475);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9412791224870696);
    AssertAlmostEqual(&test, rTM, 0.9999999999939447);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5508069489380506);
    AssertAlmostEqual(&test, rTM, 0.9999999999993676);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02590230334339481);
    AssertAlmostEqual(&test, rTM, 0.999999999999807);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002728326495095869);
    AssertAlmostEqual(&test, rTM, 0.9999999999998167);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.729800953993505e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999998168);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.729815708643145e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999998168);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.729815856190649e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999999998168);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.729815857666124e-12);
    AssertAlmostEqual(&test, rTM, 0.9999999999998168);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999980764881516);
    AssertAlmostEqual(&test, rTM, 0.9999980955328053);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999972932446325);
    AssertAlmostEqual(&test, rTM, 0.9999986466214004);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999980765048011);
    AssertAlmostEqual(&test, rTM, 0.9999998095531173);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998086119811453);
    AssertAlmostEqual(&test, rTM, 0.9999999808612804);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9980878621388187);
    AssertAlmostEqual(&test, rTM, 0.9999999980860325);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.981042610457204);
    AssertAlmostEqual(&test, rTM, 0.9999999998085944);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8260451689476445);
    AssertAlmostEqual(&test, rTM, 0.9999999999807729);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.182454526860731);
    AssertAlmostEqual(&test, rTM, 0.9999999999973508);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002714997181880776);
    AssertAlmostEqual(&test, rTM, 0.9999999999981584);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.729650831820567e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999981682);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.729798367435211e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999981684);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.729799842892032e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999999981684);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.72979985764661e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999999981684);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999980854328107);
    AssertAlmostEqual(&test, rTM, 0.9999808543472525);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999808533804297);
    AssertAlmostEqual(&test, rTM, 0.9999808552948819);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999807588484184);
    AssertAlmostEqual(&test, rTM, 0.999980949353055);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999729240520487);
    AssertAlmostEqual(&test, rTM, 0.9999864619343841);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998076051436092);
    AssertAlmostEqual(&test, rTM, 0.999998094918965);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9980871518359542);
    AssertAlmostEqual(&test, rTM, 0.9999998085510468);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9810365494591492);
    AssertAlmostEqual(&test, rTM, 0.9999999808532869);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8259944432887777);
    AssertAlmostEqual(&test, rTM, 0.9999999980766627);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1823732329203867);
    AssertAlmostEqual(&test, rTM, 0.9999999997349556);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002713257343257375);
    AssertAlmostEqual(&test, rTM, 0.999999999815721);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.727892180688722e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999998167083);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.728039526253216e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999998167182);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.728040999809342e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999998167183);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999392803061885);
    AssertAlmostEqual(&test, rTM, 0.9999392803067957);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999392802761331);
    AssertAlmostEqual(&test, rTM, 0.999939280336851);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999392772706754);
    AssertAlmostEqual(&test, rTM, 0.9999392833421569);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999389774724897);
    AssertAlmostEqual(&test, rTM, 0.9999395816376779);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999141304658264);
    AssertAlmostEqual(&test, rTM, 0.9999570643111567);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993899422756992);
    AssertAlmostEqual(&test, rTM, 0.9999939579992179);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9939459520755383);
    AssertAlmostEqual(&test, rTM, 0.9999993928123744);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.941094007548543);
    AssertAlmostEqual(&test, rTM, 0.9999999392505158);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5497708478078964);
    AssertAlmostEqual(&test, rTM, 0.999999993654156);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02574313515001623);
    AssertAlmostEqual(&test, rTM, 0.9999999980590217);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002710684725225048);
    AssertAlmostEqual(&test, rTM, 0.9999999981554477);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.712140173839213e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999981564375);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.712154738192062e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999981564474);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998024893767975);
    AssertAlmostEqual(&test, rTM, 0.9998024893768173);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998024893758199);
    AssertAlmostEqual(&test, rTM, 0.9998024893777948);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998024892780618);
    AssertAlmostEqual(&test, rTM, 0.9998024894755528);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998024795024985);
    AssertAlmostEqual(&test, rTM, 0.9998024992506227);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998015043780848);
    AssertAlmostEqual(&test, rTM, 0.9998034694881318);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997206892247581);
    AssertAlmostEqual(&test, rTM, 0.9998603348585221);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9980168161877754);
    AssertAlmostEqual(&test, rTM, 0.9999803452009834);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9804401459877949);
    AssertAlmostEqual(&test, rTM, 0.9999980247030715);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8210177947906649);
    AssertAlmostEqual(&test, rTM, 0.999999801508919);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1746050797298761);
    AssertAlmostEqual(&test, rTM, 0.9999999722369751);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002549856204191102);
    AssertAlmostEqual(&test, rTM, 0.999999980391179);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.562778281411465e-05);
    AssertAlmostEqual(&test, rTM, 0.999999980489924);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.562908329413812e-07);
    AssertAlmostEqual(&test, rTM, 0.999999980490914);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9992225545194947);
    AssertAlmostEqual(&test, rTM, 0.9992225545194955);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9992225545194562);
    AssertAlmostEqual(&test, rTM, 0.9992225545195339);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9992225545156094);
    AssertAlmostEqual(&test, rTM, 0.9992225545233807);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9992225541309235);
    AssertAlmostEqual(&test, rTM, 0.9992225549080663);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9992225156633096);
    AssertAlmostEqual(&test, rTM, 0.9992225933737394);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9992186784772724);
    AssertAlmostEqual(&test, rTM, 0.9992264113405782);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9989007031429894);
    AssertAlmostEqual(&test, rTM, 0.9994502003901523);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9922142180087355);
    AssertAlmostEqual(&test, rTM, 0.9999226136098643);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9251872925158802);
    AssertAlmostEqual(&test, rTM, 0.9999922170628952);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4679606814407968);
    AssertAlmostEqual(&test, rTM, 0.9999991655158151);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01600687186940138);
    AssertAlmostEqual(&test, rTM, 0.999999687714292);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001652641991285584);
    AssertAlmostEqual(&test, rTM, 0.9999996974542353);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.653182905960511e-06);
    AssertAlmostEqual(&test, rTM, 0.9999996975532187);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9947677968960336);
    AssertAlmostEqual(&test, rTM, 0.9947677968960337);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.994767796896031);
    AssertAlmostEqual(&test, rTM, 0.9947677968960362);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9947677968957727);
    AssertAlmostEqual(&test, rTM, 0.9947677968962946);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9947677968699412);
    AssertAlmostEqual(&test, rTM, 0.994767796922126);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9947677942867946);
    AssertAlmostEqual(&test, rTM, 0.9947677995052713);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9947675359786293);
    AssertAlmostEqual(&test, rTM, 0.9947680578004613);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.994741769747703);
    AssertAlmostEqual(&test, rTM, 0.9947936955516278);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9926085822920816);
    AssertAlmostEqual(&test, rTM, 0.9962974239453124);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9486503476927711);
    AssertAlmostEqual(&test, rTM, 0.9994779675183465);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5952442317345396);
    AssertAlmostEqual(&test, rTM, 0.9999457703442871);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03391433976987498);
    AssertAlmostEqual(&test, rTM, 0.9999852741554299);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003631090516970496);
    AssertAlmostEqual(&test, rTM, 0.9999862302235554);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.633702545834318e-06);
    AssertAlmostEqual(&test, rTM, 0.9999862401197203);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9519793677957745);
    AssertAlmostEqual(&test, rTM, 0.9519793677957745);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9519793677957743);
    AssertAlmostEqual(&test, rTM, 0.9519793677957749);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9519793677957511);
    AssertAlmostEqual(&test, rTM, 0.9519793677957979);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9519793677934326);
    AssertAlmostEqual(&test, rTM, 0.9519793677981165);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9519793675615782);
    AssertAlmostEqual(&test, rTM, 0.951979368029971);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9519793443761423);
    AssertAlmostEqual(&test, rTM, 0.9519793912153958);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9519770258933902);
    AssertAlmostEqual(&test, rTM, 0.9519817095867625);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9517457830077044);
    AssertAlmostEqual(&test, rTM, 0.952211849552458);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9327769809444089);
    AssertAlmostEqual(&test, rTM, 0.9657936325781766);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6128007981768862);
    AssertAlmostEqual(&test, rTM, 0.9949709245912041);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03818651990532123);
    AssertAlmostEqual(&test, rTM, 0.9986943216421665);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004124895942468623);
    AssertAlmostEqual(&test, rTM, 0.998789316553748);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.128271004022628e-06);
    AssertAlmostEqual(&test, rTM, 0.9987903043448932);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6162713206642108);
    AssertAlmostEqual(&test, rTM, 0.6162713206642108);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6162713206642108);
    AssertAlmostEqual(&test, rTM, 0.6162713206642108);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6162713206642092);
    AssertAlmostEqual(&test, rTM, 0.6162713206642122);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6162713206640644);
    AssertAlmostEqual(&test, rTM, 0.6162713206643571);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6162713206495795);
    AssertAlmostEqual(&test, rTM, 0.6162713206788419);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.616271319201084);
    AssertAlmostEqual(&test, rTM, 0.6162713221273375);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.616271174351592);
    AssertAlmostEqual(&test, rTM, 0.6162714669767869);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6162566899567939);
    AssertAlmostEqual(&test, rTM, 0.6162859509462432);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6148137653636843);
    AssertAlmostEqual(&test, rTM, 0.6177246662046054);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5075266727922461);
    AssertAlmostEqual(&test, rTM, 0.7056915257411053);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03832308379664138);
    AssertAlmostEqual(&test, rTM, 0.885265053045595);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004181352185570876);
    AssertAlmostEqual(&test, rTM, 0.8931980410932736);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.185230388500131e-06);
    AssertAlmostEqual(&test, rTM, 0.8932817097109733);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03872722677134553);
    AssertAlmostEqual(&test, rTM, 0.03872722677134553);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03872722677134553);
    AssertAlmostEqual(&test, rTM, 0.03872722677134553);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03872722677134553);
    AssertAlmostEqual(&test, rTM, 0.03872722677134554);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03872722677134518);
    AssertAlmostEqual(&test, rTM, 0.03872722677134589);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03872722677130969);
    AssertAlmostEqual(&test, rTM, 0.03872722677138137);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03872722676776159);
    AssertAlmostEqual(&test, rTM, 0.03872722677492949);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03872722641295089);
    AssertAlmostEqual(&test, rTM, 0.03872722712974019);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03872719093191319);
    AssertAlmostEqual(&test, rTM, 0.03872726261077779);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03872364315692649);
    AssertAlmostEqual(&test, rTM, 0.0387308103847684);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03837212325268911);
    AssertAlmostEqual(&test, rTM, 0.03908232050870992);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02012048640689442);
    AssertAlmostEqual(&test, rTM, 0.05730714999637359);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000414611686903454);
    AssertAlmostEqual(&test, rTM, 0.0769263164541482);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.190598450268889e-06);
    AssertAlmostEqual(&test, rTM, 0.07733429593080329);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004188121540685682);
    AssertAlmostEqual(&test, rTM, 0.0004188121540685682);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004188121540685682);
    AssertAlmostEqual(&test, rTM, 0.0004188121540685682);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004188121540685682);
    AssertAlmostEqual(&test, rTM, 0.0004188121540685682);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004188121540685682);
    AssertAlmostEqual(&test, rTM, 0.0004188121540685683);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004188121540685641);
    AssertAlmostEqual(&test, rTM, 0.0004188121540685725);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004188121540681498);
    AssertAlmostEqual(&test, rTM, 0.0004188121540689867);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004188121540267221);
    AssertAlmostEqual(&test, rTM, 0.0004188121541104144);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004188121498839534);
    AssertAlmostEqual(&test, rTM, 0.0004188121582531831);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004188117356074927);
    AssertAlmostEqual(&test, rTM, 0.0004188125725296438);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004187703120998937);
    AssertAlmostEqual(&test, rTM, 0.0004188539960372414);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004146689366232569);
    AssertAlmostEqual(&test, rTM, 0.0004229553714995007);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002094937880232813);
    AssertAlmostEqual(&test, rTM, 0.0006281304834140345);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.150096066220487e-06);
    AssertAlmostEqual(&test, rTM, 0.0008334740680459455);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.191654605015088e-06);
    AssertAlmostEqual(&test, rTM, 4.191654605015088e-06);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.191654605015088e-06);
    AssertAlmostEqual(&test, rTM, 4.191654605015088e-06);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.191654605015088e-06);
    AssertAlmostEqual(&test, rTM, 4.191654605015088e-06);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.191654605015088e-06);
    AssertAlmostEqual(&test, rTM, 4.191654605015088e-06);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.191654605015088e-06);
    AssertAlmostEqual(&test, rTM, 4.191654605015089e-06);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.191654605015046e-06);
    AssertAlmostEqual(&test, rTM, 4.19165460501513e-06);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.191654605010897e-06);
    AssertAlmostEqual(&test, rTM, 4.19165460501928e-06);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.191654604595926e-06);
    AssertAlmostEqual(&test, rTM, 4.19165460543425e-06);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.191654563098894e-06);
    AssertAlmostEqual(&test, rTM, 4.191654646931282e-06);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.191650413399814e-06);
    AssertAlmostEqual(&test, rTM, 4.191658796630362e-06);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.191235484980217e-06);
    AssertAlmostEqual(&test, rTM, 4.192073725049958e-06);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.150153418746367e-06);
    AssertAlmostEqual(&test, rTM, 4.233155791283795e-06);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.095836087500914e-06);
    AssertAlmostEqual(&test, rTM, 6.28747312249244e-06);

    userdata[0] = 8/CAPS_HBAR_EV; /* 8eV */
    userdata[1] = 0.035/CAPS_HBAR_EV; /* 0.035eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999970763798102);
    AssertAlmostEqual(&test, rTM, 0.9999985381888367);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999792239603829);
    AssertAlmostEqual(&test, rTM, 0.9999997942945217);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999793279565282);
    AssertAlmostEqual(&test, rTM, 0.9999999793278869);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9979348200752174);
    AssertAlmostEqual(&test, rTM, 0.9999999979326852);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9795394381812182);
    AssertAlmostEqual(&test, rTM, 0.9999999997932575);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8135360073646423);
    AssertAlmostEqual(&test, rTM, 0.9999999999792167);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1636627115022557);
    AssertAlmostEqual(&test, rTM, 0.9999999999970268);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002328957456138355);
    AssertAlmostEqual(&test, rTM, 0.9999999999978532);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.339734065970219e-05);
    AssertAlmostEqual(&test, rTM, 0.999999999997863);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.339842461949955e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999978632);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.339843545973153e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999999978632);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.339843556813392e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999999978632);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.339843556921794e-13);
    AssertAlmostEqual(&test, rTM, 0.9999999999978632);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999934299910875);
    AssertAlmostEqual(&test, rTM, 0.9999934950404691);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999907547280875);
    AssertAlmostEqual(&test, rTM, 0.9999953773533593);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999343018532785);
    AssertAlmostEqual(&test, rTM, 0.9999993495021424);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993464385213954);
    AssertAlmostEqual(&test, rTM, 0.9999999346290203);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.993483906105501);
    AssertAlmostEqual(&test, rTM, 0.9999999934625436);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.936727733764971);
    AssertAlmostEqual(&test, rTM, 0.9999999993459083);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5259087824308631);
    AssertAlmostEqual(&test, rTM, 0.9999999999312219);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02236358097093492);
    AssertAlmostEqual(&test, rTM, 0.9999999999776534);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002338748049035819);
    AssertAlmostEqual(&test, rTM, 0.999999999978621);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.339831431752718e-06);
    AssertAlmostEqual(&test, rTM, 0.999999999978631);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.339842271916166e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999786311);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.339842380318434e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999999786311);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.339842381402457e-12);
    AssertAlmostEqual(&test, rTM, 0.9999999999786311);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999346260511055);
    AssertAlmostEqual(&test, rTM, 0.9999346261164773);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999346228152841);
    AssertAlmostEqual(&test, rTM, 0.9999346293521353);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999343000380351);
    AssertAlmostEqual(&test, rTM, 0.9999349505115501);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999075485728569);
    AssertAlmostEqual(&test, rTM, 0.9999537732179461);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993431945998406);
    AssertAlmostEqual(&test, rTM, 0.9999934948603874);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9934834051552549);
    AssertAlmostEqual(&test, rTM, 0.9999993462688752);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9367260123111327);
    AssertAlmostEqual(&test, rTM, 0.9999999345890637);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5258997512767992);
    AssertAlmostEqual(&test, rTM, 0.9999999931219834);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02236239922759107);
    AssertAlmostEqual(&test, rTM, 0.9999999977652221);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002338618871106943);
    AssertAlmostEqual(&test, rTM, 0.9999999978619861);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.339702134130118e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999978629759);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.339712973095578e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999978629858);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.339713081485867e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999978629859);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997932322244626);
    AssertAlmostEqual(&test, rTM, 0.99979323222653);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997932321221232);
    AssertAlmostEqual(&test, rTM, 0.9997932323288695);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999793221888435);
    AssertAlmostEqual(&test, rTM, 0.9997932425620409);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997922010655375);
    AssertAlmostEqual(&test, rTM, 0.9997942582690601);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997075987320999);
    AssertAlmostEqual(&test, rTM, 0.9998537886763931);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9979239530663738);
    AssertAlmostEqual(&test, rTM, 0.9999794239108978);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9795327753354035);
    AssertAlmostEqual(&test, rTM, 0.9999979321034683);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.813489244285548);
    AssertAlmostEqual(&test, rTM, 0.9999997921085775);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1635970839079632);
    AssertAlmostEqual(&test, rTM, 0.9999999702550946);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002327664299586842);
    AssertAlmostEqual(&test, rTM, 0.9999999785193561);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.338428924933724e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999786181233);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.338537200017401e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999786191133);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.338538282831533e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999786191232);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993446504753766);
    AssertAlmostEqual(&test, rTM, 0.9993446504754421);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993446504721336);
    AssertAlmostEqual(&test, rTM, 0.9993446504786849);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999344650147842);
    AssertAlmostEqual(&test, rTM, 0.9993446508029764);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993446177194931);
    AssertAlmostEqual(&test, rTM, 0.9993446832296889);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993413829556806);
    AssertAlmostEqual(&test, rTM, 0.9993479017896616);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9990733216395746);
    AssertAlmostEqual(&test, rTM, 0.9995365534035341);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9934333269706305);
    AssertAlmostEqual(&test, rTM, 0.9999347706875396);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9365541100752857);
    AssertAlmostEqual(&test, rTM, 0.9999934411852941);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5249987936500071);
    AssertAlmostEqual(&test, rTM, 0.9999993101172581);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02224485259249196);
    AssertAlmostEqual(&test, rTM, 0.9999997753401753);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000232577274574535);
    AssertAlmostEqual(&test, rTM, 0.9999997850177468);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.326844138839079e-06);
    AssertAlmostEqual(&test, rTM, 0.9999997851167235);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.326854859001395e-08);
    AssertAlmostEqual(&test, rTM, 0.9999997851177135);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9978780241376932);
    AssertAlmostEqual(&test, rTM, 0.9978780241376953);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9978780241375883);
    AssertAlmostEqual(&test, rTM, 0.9978780241378002);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9978780241270957);
    AssertAlmostEqual(&test, rTM, 0.9978780241482929);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9978780230778335);
    AssertAlmostEqual(&test, rTM, 0.9978780251975545);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9978779181542454);
    AssertAlmostEqual(&test, rTM, 0.9978781301158556);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.997867451948193);
    AssertAlmostEqual(&test, rTM, 0.9978885439705487);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9970003929007151);
    AssertAlmostEqual(&test, rTM, 0.998499069209053);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9788784021109262);
    AssertAlmostEqual(&test, rTM, 0.9997886416670784);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8089353547645872);
    AssertAlmostEqual(&test, rTM, 0.99997863951983);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1573562911082929);
    AssertAlmostEqual(&test, rTM, 0.9999969011870947);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002206368409288445);
    AssertAlmostEqual(&test, rTM, 0.9999977338488518);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.21603865179814e-05);
    AssertAlmostEqual(&test, rTM, 0.9999977437267568);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.216135889576552e-07);
    AssertAlmostEqual(&test, rTM, 0.9999977438257542);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.991872678616183);
    AssertAlmostEqual(&test, rTM, 0.9918726786161831);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.991872678616179);
    AssertAlmostEqual(&test, rTM, 0.9918726786161871);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9918726786157783);
    AssertAlmostEqual(&test, rTM, 0.9918726786165878);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9918726785757123);
    AssertAlmostEqual(&test, rTM, 0.9918726786566539);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9918726745691041);
    AssertAlmostEqual(&test, rTM, 0.99187268266326);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9918722739183855);
    AssertAlmostEqual(&test, rTM, 0.9918730832939121);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9918323093139026);
    AssertAlmostEqual(&test, rTM, 0.9919128492008736);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9885256409087886);
    AssertAlmostEqual(&test, rTM, 0.9942462199799715);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9212815830969455);
    AssertAlmostEqual(&test, rTM, 0.9991876560547209);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4515837330893785);
    AssertAlmostEqual(&test, rTM, 0.9999118719134028);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01458149499595303);
    AssertAlmostEqual(&test, rTM, 0.9999657184466048);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001501172693655798);
    AssertAlmostEqual(&test, rTM, 0.9999666938164241);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.501619004191654e-06);
    AssertAlmostEqual(&test, rTM, 0.9999667037144285);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9483497019196718);
    AssertAlmostEqual(&test, rTM, 0.9483497019196718);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9483497019196716);
    AssertAlmostEqual(&test, rTM, 0.9483497019196721);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9483497019196466);
    AssertAlmostEqual(&test, rTM, 0.9483497019196969);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9483497019171577);
    AssertAlmostEqual(&test, rTM, 0.9483497019221858);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9483497016682665);
    AssertAlmostEqual(&test, rTM, 0.9483497021710771);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9483496767791481);
    AssertAlmostEqual(&test, rTM, 0.9483497270601836);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9483471879328627);
    AssertAlmostEqual(&test, rTM, 0.9483522157873666);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9480989556015887);
    AssertAlmostEqual(&test, rTM, 0.9485992687857955);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9277530096608957);
    AssertAlmostEqual(&test, rTM, 0.9631866726549251);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5904262657667206);
    AssertAlmostEqual(&test, rTM, 0.9945569824390841);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03322251281719428);
    AssertAlmostEqual(&test, rTM, 0.998498991640847);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003552334115134754);
    AssertAlmostEqual(&test, rTM, 0.998594453961665);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.554837521556787e-06);
    AssertAlmostEqual(&test, rTM, 0.9985954415209418);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6138934044951564);
    AssertAlmostEqual(&test, rTM, 0.6138934044951564);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6138934044951564);
    AssertAlmostEqual(&test, rTM, 0.6138934044951564);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6138934044951549);
    AssertAlmostEqual(&test, rTM, 0.6138934044951578);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6138934044950095);
    AssertAlmostEqual(&test, rTM, 0.6138934044953033);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6138934044804697);
    AssertAlmostEqual(&test, rTM, 0.6138934045098432);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6138934030264827);
    AssertAlmostEqual(&test, rTM, 0.6138934059638301);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.613893257627835);
    AssertAlmostEqual(&test, rTM, 0.6138935513624354);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6138787183212094);
    AssertAlmostEqual(&test, rTM, 0.6139080902441457);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6124303397541192);
    AssertAlmostEqual(&test, rTM, 0.6153522637343237);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5048345997788545);
    AssertAlmostEqual(&test, rTM, 0.7036623977013974);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03775129254608885);
    AssertAlmostEqual(&test, rTM, 0.8837245342097763);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000411412684414081);
    AssertAlmostEqual(&test, rTM, 0.8916419850759428);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.117887861583617e-06);
    AssertAlmostEqual(&test, rTM, 0.891725439844525);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03866862360836624);
    AssertAlmostEqual(&test, rTM, 0.03866862360836624);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03866862360836624);
    AssertAlmostEqual(&test, rTM, 0.03866862360836624);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03866862360836624);
    AssertAlmostEqual(&test, rTM, 0.03866862360836625);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03866862360836588);
    AssertAlmostEqual(&test, rTM, 0.0386686236083666);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03866862360833045);
    AssertAlmostEqual(&test, rTM, 0.03866862360840203);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0386686236047873);
    AssertAlmostEqual(&test, rTM, 0.03866862361194518);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03866862325047191);
    AssertAlmostEqual(&test, rTM, 0.03866862396626056);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03866858781896637);
    AssertAlmostEqual(&test, rTM, 0.03866865939776601);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03866504499677358);
    AssertAlmostEqual(&test, rTM, 0.03867220221896699);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03831401618808601);
    AssertAlmostEqual(&test, rTM, 0.03902322128946877);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02008888583177289);
    AssertAlmostEqual(&test, rTM, 0.05722166249441693);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004139343736579445);
    AssertAlmostEqual(&test, rTM, 0.07681030123642429);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.183747039879339e-06);
    AssertAlmostEqual(&test, rTM, 0.07721762158821067);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004187436269215054);
    AssertAlmostEqual(&test, rTM, 0.0004187436269215054);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004187436269215054);
    AssertAlmostEqual(&test, rTM, 0.0004187436269215054);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004187436269215054);
    AssertAlmostEqual(&test, rTM, 0.0004187436269215054);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004187436269215053);
    AssertAlmostEqual(&test, rTM, 0.0004187436269215054);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004187436269215012);
    AssertAlmostEqual(&test, rTM, 0.0004187436269215096);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000418743626921087);
    AssertAlmostEqual(&test, rTM, 0.0004187436269219238);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004187436268796661);
    AssertAlmostEqual(&test, rTM, 0.0004187436269633447);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004187436227375746);
    AssertAlmostEqual(&test, rTM, 0.0004187436311054362);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004187432085288422);
    AssertAlmostEqual(&test, rTM, 0.0004187440453141686);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004187017917933908);
    AssertAlmostEqual(&test, rTM, 0.0004187854620496186);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004146010868381997);
    AssertAlmostEqual(&test, rTM, 0.0004228861669904392);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002094594957475916);
    AssertAlmostEqual(&test, rTM, 0.0006280277214136051);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.149416453284462e-06);
    AssertAlmostEqual(&test, rTM, 0.000833337693435441);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.191585952104533e-06);
    AssertAlmostEqual(&test, rTM, 4.191585952104533e-06);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.191585952104533e-06);
    AssertAlmostEqual(&test, rTM, 4.191585952104533e-06);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.191585952104533e-06);
    AssertAlmostEqual(&test, rTM, 4.191585952104533e-06);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.191585952104533e-06);
    AssertAlmostEqual(&test, rTM, 4.191585952104533e-06);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.191585952104532e-06);
    AssertAlmostEqual(&test, rTM, 4.191585952104533e-06);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.191585952104491e-06);
    AssertAlmostEqual(&test, rTM, 4.191585952104574e-06);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.191585952100341e-06);
    AssertAlmostEqual(&test, rTM, 4.191585952108724e-06);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.191585951685378e-06);
    AssertAlmostEqual(&test, rTM, 4.191585952523688e-06);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.191585910189024e-06);
    AssertAlmostEqual(&test, rTM, 4.19158599402004e-06);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.191581760557911e-06);
    AssertAlmostEqual(&test, rTM, 4.191590143651154e-06);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.191166838934152e-06);
    AssertAlmostEqual(&test, rTM, 4.192005065274914e-06);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.150085445556315e-06);
    AssertAlmostEqual(&test, rTM, 4.233086458652735e-06);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.095801760757868e-06);
    AssertAlmostEqual(&test, rTM, 6.287370143414375e-06);

    userdata[0] = 8/CAPS_HBAR_EV; /* 8eV */
    userdata[1] = 0.05/CAPS_HBAR_EV; /* 0.05eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999965056065329);
    AssertAlmostEqual(&test, rTM, 0.99999825280174);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999751679336297);
    AssertAlmostEqual(&test, rTM, 0.9999997541349342);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997529268105834);
    AssertAlmostEqual(&test, rTM, 0.9999999752920992);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9975321359549939);
    AssertAlmostEqual(&test, rTM, 0.9999999975290857);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9755942485773634);
    AssertAlmostEqual(&test, rTM, 0.9999999997528898);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7815571050149172);
    AssertAlmostEqual(&test, rTM, 0.999999999975103);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1253116734237996);
    AssertAlmostEqual(&test, rTM, 0.9999999999960726);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001632547016043203);
    AssertAlmostEqual(&test, rTM, 0.9999999999969373);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637836865764531e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999969472);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637889980737741e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999969473);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637890511909221e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999999969473);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637890517220938e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999999969473);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637890517274055e-13);
    AssertAlmostEqual(&test, rTM, 0.9999999999969473);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999921473430778);
    AssertAlmostEqual(&test, rTM, 0.999992225091854);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999889497974068);
    AssertAlmostEqual(&test, rTM, 0.99999447488344);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999214762056303);
    AssertAlmostEqual(&test, rTM, 0.9999992225064646);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9992188945382197);
    AssertAlmostEqual(&test, rTM, 0.99999992186674);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9922167472142107);
    AssertAlmostEqual(&test, rTM, 0.9999999921862279);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9248559344663313);
    AssertAlmostEqual(&test, rTM, 0.9999999992180323);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4663835150106144);
    AssertAlmostEqual(&test, rTM, 0.9999999999161112);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01586337195925352);
    AssertAlmostEqual(&test, rTM, 0.9999999999684888);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001637353624179184);
    AssertAlmostEqual(&test, rTM, 0.9999999999694629);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637884575929889e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999694729);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637889887621172e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999694729);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637889940738302e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999999694729);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637889941269474e-12);
    AssertAlmostEqual(&test, rTM, 0.9999999999694729);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999218643388026);
    AssertAlmostEqual(&test, rTM, 0.9999218644169351);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999921860471338);
    AssertAlmostEqual(&test, rTM, 0.9999218682842044);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999214746869018);
    AssertAlmostEqual(&test, rTM, 0.9999222521350245);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998895013316975);
    AssertAlmostEqual(&test, rTM, 0.9999447491394778);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9992150243109975);
    AssertAlmostEqual(&test, rTM, 0.9999922249408867);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9922162134973479);
    AssertAlmostEqual(&test, rTM, 0.99999921864666);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.924854502044032);
    AssertAlmostEqual(&test, rTM, 0.9999999218017541);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4663769481425223);
    AssertAlmostEqual(&test, rTM, 0.9999999916109433);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01586277748842604);
    AssertAlmostEqual(&test, rTM, 0.9999999968487601);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001637290308160756);
    AssertAlmostEqual(&test, rTM, 0.9999999969461739);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637821218845382e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999969471638);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637826530125752e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999969471737);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637826583238773e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999969471738);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997528909069824);
    AssertAlmostEqual(&test, rTM, 0.9997528909094532);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997528907846785);
    AssertAlmostEqual(&test, rTM, 0.999752891031757);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997528785545989);
    AssertAlmostEqual(&test, rTM, 0.9997529032612192);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.99975165858933);
    AssertAlmostEqual(&test, rTM, 0.999754117112849);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996505528576785);
    AssertAlmostEqual(&test, rTM, 0.9998252611606745);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.997519359992156);
    AssertAlmostEqual(&test, rTM, 0.9999754089715835);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9755883349030944);
    AssertAlmostEqual(&test, rTM, 0.9999975285416762);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7815195725227557);
    AssertAlmostEqual(&test, rTM, 0.9999997509808277);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.125273628140964);
    AssertAlmostEqual(&test, rTM, 0.9999999607137396);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001631911494410158);
    AssertAlmostEqual(&test, rTM, 0.9999999693611661);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637197221641638e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999694600029);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637250295136811e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999694609929);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637250825893485e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999694610028);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9992174098178279);
    AssertAlmostEqual(&test, rTM, 0.9992174098179062);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9992174098139556);
    AssertAlmostEqual(&test, rTM, 0.9992174098217784);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9992174094267252);
    AssertAlmostEqual(&test, rTM, 0.9992174102090087);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9992173707046537);
    AssertAlmostEqual(&test, rTM, 0.9992174489291265);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999213508136252);
    AssertAlmostEqual(&test, rTM, 0.9992212921512973);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9988934297880003);
    AssertAlmostEqual(&test, rTM, 0.9994465617046598);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9921628786223574);
    AssertAlmostEqual(&test, rTM, 0.9999221013214605);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9247114004849395);
    AssertAlmostEqual(&test, rTM, 0.9999921654612179);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.465721451549481);
    AssertAlmostEqual(&test, rTM, 0.9999991592589361);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01580355462335352);
    AssertAlmostEqual(&test, rTM, 0.9999996836946022);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001630983340033209);
    AssertAlmostEqual(&test, rTM, 0.9999996934365784);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.631510168047936e-06);
    AssertAlmostEqual(&test, rTM, 0.999999693535562);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.631515438476583e-08);
    AssertAlmostEqual(&test, rTM, 0.9999996935365519);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9974844439546849);
    AssertAlmostEqual(&test, rTM, 0.9974844439546875);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9974844439545606);
    AssertAlmostEqual(&test, rTM, 0.9974844439548118);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9974844439421242);
    AssertAlmostEqual(&test, rTM, 0.9974844439672481);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9974844426984925);
    AssertAlmostEqual(&test, rTM, 0.9974844452108793);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.997484318338432);
    AssertAlmostEqual(&test, rTM, 0.9974845695646759);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9974719133419957);
    AssertAlmostEqual(&test, rTM, 0.9974969125364758);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9964443218081135);
    AssertAlmostEqual(&test, rTM, 0.9982205763224344);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9750054603261934);
    AssertAlmostEqual(&test, rTM, 0.9997493891240905);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7778480950042911);
    AssertAlmostEqual(&test, rTM, 0.9999746154028224);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1216194693176706);
    AssertAlmostEqual(&test, rTM, 0.999995949644546);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001571347371576465);
    AssertAlmostEqual(&test, rTM, 0.9999968180353944);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.576247624029114e-05);
    AssertAlmostEqual(&test, rTM, 0.9999968279196353);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.57629681954907e-07);
    AssertAlmostEqual(&test, rTM, 0.9999968280186332);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9908276503274392);
    AssertAlmostEqual(&test, rTM, 0.9908276503274394);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9908276503274347);
    AssertAlmostEqual(&test, rTM, 0.9908276503274439);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9908276503269828);
    AssertAlmostEqual(&test, rTM, 0.9908276503278958);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9908276502817889);
    AssertAlmostEqual(&test, rTM, 0.9908276503730897);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9908276457623955);
    AssertAlmostEqual(&test, rTM, 0.9908276548924808);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9908271938344636);
    AssertAlmostEqual(&test, rTM, 0.9908281067978019);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9907821144859621);
    AssertAlmostEqual(&test, rTM, 0.9908729622556853);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9870530701877342);
    AssertAlmostEqual(&test, rTM, 0.9935053767684057);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9115821137193393);
    AssertAlmostEqual(&test, rTM, 0.999082560493028);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4099658895559323);
    AssertAlmostEqual(&test, rTM, 0.9998985543729714);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0115075582966929);
    AssertAlmostEqual(&test, rTM, 0.9999565579591964);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001177428737987958);
    AssertAlmostEqual(&test, rTM, 0.9999575363890287);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.177703292335996e-06);
    AssertAlmostEqual(&test, rTM, 0.9999575462872209);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9467399569840084);
    AssertAlmostEqual(&test, rTM, 0.9467399569840084);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9467399569840081);
    AssertAlmostEqual(&test, rTM, 0.9467399569840086);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9467399569839825);
    AssertAlmostEqual(&test, rTM, 0.9467399569840342);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9467399569814182);
    AssertAlmostEqual(&test, rTM, 0.9467399569865985);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9467399567249938);
    AssertAlmostEqual(&test, rTM, 0.946739957243023);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9467399310825533);
    AssertAlmostEqual(&test, rTM, 0.9467399828854511);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9467373669061597);
    AssertAlmostEqual(&test, rTM, 0.9467425469393512);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9464816224189563);
    AssertAlmostEqual(&test, rTM, 0.946997078517182);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9255275184849716);
    AssertAlmostEqual(&test, rTM, 0.9620294775974314);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5807724254530943);
    AssertAlmostEqual(&test, rTM, 0.994371241004481);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03131479596292113);
    AssertAlmostEqual(&test, rTM, 0.9984074987832153);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003335319912292203);
    AssertAlmostEqual(&test, rTM, 0.9985031382984827);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.337526923556699e-06);
    AssertAlmostEqual(&test, rTM, 0.9985041257439862);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6127888534338737);
    AssertAlmostEqual(&test, rTM, 0.6127888534338737);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6127888534338737);
    AssertAlmostEqual(&test, rTM, 0.6127888534338737);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6127888534338722);
    AssertAlmostEqual(&test, rTM, 0.6127888534338751);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6127888534337266);
    AssertAlmostEqual(&test, rTM, 0.6127888534340208);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6127888534191613);
    AssertAlmostEqual(&test, rTM, 0.612788853448586);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6127888519626415);
    AssertAlmostEqual(&test, rTM, 0.6127888549051058);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6127887063107194);
    AssertAlmostEqual(&test, rTM, 0.6127890005569855);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6127741416783805);
    AssertAlmostEqual(&test, rTM, 0.6128035647646182);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6113232478207095);
    AssertAlmostEqual(&test, rTM, 0.6142502556311228);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5035858292449225);
    AssertAlmostEqual(&test, rTM, 0.7027186750492915);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03748910640391862);
    AssertAlmostEqual(&test, rTM, 0.8830043054556017);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004083353511804023);
    AssertAlmostEqual(&test, rTM, 0.8909144486455144);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.087061484232972e-06);
    AssertAlmostEqual(&test, rTM, 0.8909978035042806);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03864121447778311);
    AssertAlmostEqual(&test, rTM, 0.03864121447778311);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03864121447778311);
    AssertAlmostEqual(&test, rTM, 0.03864121447778311);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03864121447778311);
    AssertAlmostEqual(&test, rTM, 0.03864121447778312);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03864121447778276);
    AssertAlmostEqual(&test, rTM, 0.03864121447778347);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03864121447774735);
    AssertAlmostEqual(&test, rTM, 0.03864121447781888);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03864121447420651);
    AssertAlmostEqual(&test, rTM, 0.03864121448135972);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03864121412012284);
    AssertAlmostEqual(&test, rTM, 0.0386412148354434);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03864117871178802);
    AssertAlmostEqual(&test, rTM, 0.03864125024377812);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03863763820646987);
    AssertAlmostEqual(&test, rTM, 0.03864479074810646);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03828683912772271);
    AssertAlmostEqual(&test, rTM, 0.03899558010832368);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02007410722047219);
    AssertAlmostEqual(&test, rTM, 0.05718167803438905);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004136176442664303);
    AssertAlmostEqual(&test, rTM, 0.0767560394784189);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.180543147460871e-06);
    AssertAlmostEqual(&test, rTM, 0.07716305159474374);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004187115125403359);
    AssertAlmostEqual(&test, rTM, 0.0004187115125403359);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004187115125403359);
    AssertAlmostEqual(&test, rTM, 0.0004187115125403359);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004187115125403359);
    AssertAlmostEqual(&test, rTM, 0.0004187115125403359);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004187115125403359);
    AssertAlmostEqual(&test, rTM, 0.000418711512540336);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004187115125403317);
    AssertAlmostEqual(&test, rTM, 0.0004187115125403401);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004187115125399176);
    AssertAlmostEqual(&test, rTM, 0.0004187115125407543);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004187115124984998);
    AssertAlmostEqual(&test, rTM, 0.000418711512582172);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004187115083567257);
    AssertAlmostEqual(&test, rTM, 0.0004187115167239461);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004187110941797333);
    AssertAlmostEqual(&test, rTM, 0.0004187119309009385);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004186696806179639);
    AssertAlmostEqual(&test, rTM, 0.0004187533444627065);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004145692898942345);
    AssertAlmostEqual(&test, rTM, 0.0004228537351720688);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002094434251077197);
    AssertAlmostEqual(&test, rTM, 0.0006279795632995747);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.14909796133696e-06);
    AssertAlmostEqual(&test, rTM, 0.0008332737831981674);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.191553771826847e-06);
    AssertAlmostEqual(&test, rTM, 4.191553771826847e-06);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.191553771826847e-06);
    AssertAlmostEqual(&test, rTM, 4.191553771826847e-06);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.191553771826847e-06);
    AssertAlmostEqual(&test, rTM, 4.191553771826847e-06);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.191553771826847e-06);
    AssertAlmostEqual(&test, rTM, 4.191553771826847e-06);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.191553771826847e-06);
    AssertAlmostEqual(&test, rTM, 4.191553771826848e-06);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.191553771826806e-06);
    AssertAlmostEqual(&test, rTM, 4.19155377182689e-06);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.191553771822656e-06);
    AssertAlmostEqual(&test, rTM, 4.191553771831039e-06);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.191553771407696e-06);
    AssertAlmostEqual(&test, rTM, 4.191553772245999e-06);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.191553729911662e-06);
    AssertAlmostEqual(&test, rTM, 4.191553813742033e-06);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.191549580312405e-06);
    AssertAlmostEqual(&test, rTM, 4.19155796334129e-06);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.191134661874118e-06);
    AssertAlmostEqual(&test, rTM, 4.191972881779576e-06);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.150053583889951e-06);
    AssertAlmostEqual(&test, rTM, 4.233053959763729e-06);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.09578567048414e-06);
    AssertAlmostEqual(&test, rTM, 6.287321873132734e-06);

    userdata[0] = 8/CAPS_HBAR_EV; /* 8eV */
    userdata[1] = 0.1/CAPS_HBAR_EV; /* 0.1eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999950581849912);
    AssertAlmostEqual(&test, rTM, 0.9999975290894428);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999648823359095);
    AssertAlmostEqual(&test, rTM, 0.9999996522943105);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996506036295059);
    AssertAlmostEqual(&test, rTM, 0.9999999650577518);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9965116988008319);
    AssertAlmostEqual(&test, rTM, 0.9999999965055969);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9656612125715049);
    AssertAlmostEqual(&test, rTM, 0.9999999996505067);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7063205935620964);
    AssertAlmostEqual(&test, rTM, 0.9999999999645266);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.07072082112607955);
    AssertAlmostEqual(&test, rTM, 0.9999999999929653);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0008176066718455327);
    AssertAlmostEqual(&test, rTM, 0.9999999999938846);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.189318614846529e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999938944);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.189451405030495e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999938946);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.189452732959519e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999999938946);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.189452746238812e-12);
    AssertAlmostEqual(&test, rTM, 0.9999999999938946);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.189452746371605e-14);
    AssertAlmostEqual(&test, rTM, 0.9999999999938946);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999988894685226);
    AssertAlmostEqual(&test, rTM, 0.999989004638233);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999843726909169);
    AssertAlmostEqual(&test, rTM, 0.9999921863149315);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998889524019124);
    AssertAlmostEqual(&test, rTM, 0.9999989004583812);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9988955289271798);
    AssertAlmostEqual(&test, rTM, 0.9999998895028883);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9890106174546101);
    AssertAlmostEqual(&test, rTM, 0.9999999889495743);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8954342513951709);
    AssertAlmostEqual(&test, rTM, 0.9999999988932884);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3480661802175885);
    AssertAlmostEqual(&test, rTM, 0.9999999998737524);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0080580018315976);
    AssertAlmostEqual(&test, rTM, 0.9999999999379539);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.188110238677657e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999389358);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.189437892978178e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999389457);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.189451172239034e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999999389458);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.189451305031914e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999999389458);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.189451306359844e-13);
    AssertAlmostEqual(&test, rTM, 0.9999999999389458);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998895023557794);
    AssertAlmostEqual(&test, rTM, 0.9998895024662708);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998894968865891);
    AssertAlmostEqual(&test, rTM, 0.9998895079351851);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998889513280389);
    AssertAlmostEqual(&test, rTM, 0.999890050759393);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998437363873623);
    AssertAlmostEqual(&test, rTM, 0.9999218651410338);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9988900681038639);
    AssertAlmostEqual(&test, rTM, 0.9999890045302366);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9890099708042414);
    AssertAlmostEqual(&test, rTM, 0.9999988950020504);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8954332470306513);
    AssertAlmostEqual(&test, rTM, 0.9999998893278248);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.348062922811229);
    AssertAlmostEqual(&test, rTM, 0.9999999873750962);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.008057848468003408);
    AssertAlmostEqual(&test, rTM, 0.9999999937952726);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.187951893666058e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999938934669);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.189279496622562e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999938944568);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.189292775369819e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999938944667);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.189292908157564e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999938944668);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999650586974613);
    AssertAlmostEqual(&test, rTM, 0.9996505869781064);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996505868016837);
    AssertAlmostEqual(&test, rTM, 0.9996505871510355);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996505695091981);
    AssertAlmostEqual(&test, rTM, 0.9996506044426483);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996488445632378);
    AssertAlmostEqual(&test, rTM, 0.9996523207452309);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995058911272272);
    AssertAlmostEqual(&test, rTM, 0.9997529150343527);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9964939911766211);
    AssertAlmostEqual(&test, rTM, 0.9999652265809524);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9656562303352297);
    AssertAlmostEqual(&test, rTM, 0.9999965049065836);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7062967250825368);
    AssertAlmostEqual(&test, rTM, 0.9999996452310247);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0707088320107625);
    AssertAlmostEqual(&test, rTM, 0.9999999296410252);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0008174472413326377);
    AssertAlmostEqual(&test, rTM, 0.9999999388340176);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.187719139764764e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999389329359);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.187851878090462e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999389339259);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.187853205500888e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999389339358);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9988945064801954);
    AssertAlmostEqual(&test, rTM, 0.9988945064803059);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9988945064747262);
    AssertAlmostEqual(&test, rTM, 0.998894506485775);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9988945059278097);
    AssertAlmostEqual(&test, rTM, 0.9988945070326912);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.998894451237527);
    AssertAlmostEqual(&test, rTM, 0.9988945617202154);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9988889958272361);
    AssertAlmostEqual(&test, rTM, 0.9988999898151092);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9984369541776407);
    AssertAlmostEqual(&test, rTM, 0.999218171341367);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9889453949278496);
    AssertAlmostEqual(&test, rTM, 0.9998899428206922);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8953328583849003);
    AssertAlmostEqual(&test, rTM, 0.9999889226629182);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3477375317709997);
    AssertAlmostEqual(&test, rTM, 0.9999987360051401);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.008042541535084966);
    AssertAlmostEqual(&test, rTM, 0.9999993783465796);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.172148260428675e-05);
    AssertAlmostEqual(&test, rTM, 0.9999993881661532);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.173470743988962e-07);
    AssertAlmostEqual(&test, rTM, 0.9999993882651449);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.173483971526553e-09);
    AssertAlmostEqual(&test, rTM, 0.9999993882661349);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9964778492140882);
    AssertAlmostEqual(&test, rTM, 0.9964778492140918);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9964778492139142);
    AssertAlmostEqual(&test, rTM, 0.9964778492142659);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9964778491965104);
    AssertAlmostEqual(&test, rTM, 0.9964778492316697);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9964778474561219);
    AssertAlmostEqual(&test, rTM, 0.9964778509720572);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9964776734216467);
    AssertAlmostEqual(&test, rTM, 0.9964780249977754);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9964603134140049);
    AssertAlmostEqual(&test, rTM, 0.9964952982933691);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9950225651680721);
    AssertAlmostEqual(&test, rTM, 0.9975081741227251);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9651634419792172);
    AssertAlmostEqual(&test, rTM, 0.9996489216182557);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7039490566983184);
    AssertAlmostEqual(&test, rTM, 0.9999641739217517);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.06954167928900958);
    AssertAlmostEqual(&test, rTM, 0.9999928448930747);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0008019640478550421);
    AssertAlmostEqual(&test, rTM, 0.9999937653494575);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.03238993459174e-06);
    AssertAlmostEqual(&test, rTM, 0.9999937752413461);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.032517685090869e-08);
    AssertAlmostEqual(&test, rTM, 0.9999937753403444);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9879911657231638);
    AssertAlmostEqual(&test, rTM, 0.9879911657231639);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9879911657231579);
    AssertAlmostEqual(&test, rTM, 0.9879911657231698);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9879911657225671);
    AssertAlmostEqual(&test, rTM, 0.9879911657237607);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9879911656634824);
    AssertAlmostEqual(&test, rTM, 0.9879911657828453);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9879911597550191);
    AssertAlmostEqual(&test, rTM, 0.9879911716913058);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9879905689236315);
    AssertAlmostEqual(&test, rTM, 0.987991762493218);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9879316345211708);
    AssertAlmostEqual(&test, rTM, 0.9880504050330193);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9830593841118773);
    AssertAlmostEqual(&test, rTM, 0.9914933573483616);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.885729145339242);
    AssertAlmostEqual(&test, rTM, 0.9987963916348199);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3183219364498372);
    AssertAlmostEqual(&test, rTM, 0.9998588716344567);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.006758658445605283);
    AssertAlmostEqual(&test, rTM, 0.9999260297100118);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.850020217270285e-05);
    AssertAlmostEqual(&test, rTM, 0.9999270128429234);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.850949449958397e-07);
    AssertAlmostEqual(&test, rTM, 0.9999270227411547);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9417200667686421);
    AssertAlmostEqual(&test, rTM, 0.9417200667686421);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9417200667686417);
    AssertAlmostEqual(&test, rTM, 0.9417200667686423);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9417200667686138);
    AssertAlmostEqual(&test, rTM, 0.9417200667686704);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9417200667658155);
    AssertAlmostEqual(&test, rTM, 0.9417200667714686);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9417200664859886);
    AssertAlmostEqual(&test, rTM, 0.9417200670512955);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9417200385033071);
    AssertAlmostEqual(&test, rTM, 0.9417200950339637);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.941717240309363);
    AssertAlmostEqual(&test, rTM, 0.9417228930949642);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9414381593044748);
    AssertAlmostEqual(&test, rTM, 0.942000657716067);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9185978558060566);
    AssertAlmostEqual(&test, rTM, 0.9584167828968629);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5516988452482573);
    AssertAlmostEqual(&test, rTM, 0.9937830077910396);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02628477293073731);
    AssertAlmostEqual(&test, rTM, 0.998102776042081);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002771038607563777);
    AssertAlmostEqual(&test, rTM, 0.9981988733488979);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.772562347709425e-06);
    AssertAlmostEqual(&test, rTM, 0.9981998603994866);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6091523867783577);
    AssertAlmostEqual(&test, rTM, 0.6091523867783577);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6091523867783577);
    AssertAlmostEqual(&test, rTM, 0.6091523867783578);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6091523867783563);
    AssertAlmostEqual(&test, rTM, 0.6091523867783593);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6091523867782098);
    AssertAlmostEqual(&test, rTM, 0.6091523867785057);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.609152386763562);
    AssertAlmostEqual(&test, rTM, 0.6091523867931534);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6091523852987852);
    AssertAlmostEqual(&test, rTM, 0.6091523882579302);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6091522388211683);
    AssertAlmostEqual(&test, rTM, 0.6091525347355048);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6091375916250726);
    AssertAlmostEqual(&test, rTM, 0.6091671815076313);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6076784982693143);
    AssertAlmostEqual(&test, rTM, 0.6106220792205209);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4994822246281144);
    AssertAlmostEqual(&test, rTM, 0.6996063533692645);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03664089401680381);
    AssertAlmostEqual(&test, rTM, 0.8806121971524699);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003984019707026872);
    AssertAlmostEqual(&test, rTM, 0.8884978786953164);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.987559018294381e-06);
    AssertAlmostEqual(&test, rTM, 0.8885809020430502);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03855013109343044);
    AssertAlmostEqual(&test, rTM, 0.03855013109343044);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03855013109343044);
    AssertAlmostEqual(&test, rTM, 0.03855013109343044);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03855013109343043);
    AssertAlmostEqual(&test, rTM, 0.03855013109343044);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03855013109343008);
    AssertAlmostEqual(&test, rTM, 0.03855013109343079);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03855013109339474);
    AssertAlmostEqual(&test, rTM, 0.03855013109346613);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03855013108986161);
    AssertAlmostEqual(&test, rTM, 0.03855013109699926);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03855013073654812);
    AssertAlmostEqual(&test, rTM, 0.03855013145031275);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03855009540523108);
    AssertAlmostEqual(&test, rTM, 0.0385501667816297);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03854656260103473);
    AssertAlmostEqual(&test, rTM, 0.03855369958484288);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03819652712615564);
    AssertAlmostEqual(&test, rTM, 0.03890372540633064);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02002500190220241);
    AssertAlmostEqual(&test, rTM, 0.05704879945497759);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004125653713517706);
    AssertAlmostEqual(&test, rTM, 0.07657571934424616);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.169898855631889e-06);
    AssertAlmostEqual(&test, rTM, 0.07698170735487446);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004186045001695785);
    AssertAlmostEqual(&test, rTM, 0.0004186045001695785);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004186045001695785);
    AssertAlmostEqual(&test, rTM, 0.0004186045001695785);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004186045001695785);
    AssertAlmostEqual(&test, rTM, 0.0004186045001695785);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004186045001695785);
    AssertAlmostEqual(&test, rTM, 0.0004186045001695786);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004186045001695744);
    AssertAlmostEqual(&test, rTM, 0.0004186045001695827);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004186045001691603);
    AssertAlmostEqual(&test, rTM, 0.0004186045001699968);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004186045001277531);
    AssertAlmostEqual(&test, rTM, 0.000418604500211404);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004186044959870367);
    AssertAlmostEqual(&test, rTM, 0.0004186045043521204);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004186040819158091);
    AssertAlmostEqual(&test, rTM, 0.000418604918423348);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004185626789294677);
    AssertAlmostEqual(&test, rTM, 0.0004186463214096879);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004144633352962231);
    AssertAlmostEqual(&test, rTM, 0.0004227456650285765);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002093898741137254);
    AssertAlmostEqual(&test, rTM, 0.0006278190895801576);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.148036674532214e-06);
    AssertAlmostEqual(&test, rTM, 0.0008330608198537767);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.191446507803106e-06);
    AssertAlmostEqual(&test, rTM, 4.191446507803106e-06);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.191446507803106e-06);
    AssertAlmostEqual(&test, rTM, 4.191446507803106e-06);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.191446507803106e-06);
    AssertAlmostEqual(&test, rTM, 4.191446507803106e-06);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.191446507803106e-06);
    AssertAlmostEqual(&test, rTM, 4.191446507803106e-06);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.191446507803105e-06);
    AssertAlmostEqual(&test, rTM, 4.191446507803106e-06);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.191446507803064e-06);
    AssertAlmostEqual(&test, rTM, 4.191446507803148e-06);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.191446507798915e-06);
    AssertAlmostEqual(&test, rTM, 4.191446507807297e-06);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.191446507383965e-06);
    AssertAlmostEqual(&test, rTM, 4.191446508222247e-06);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.191446465888993e-06);
    AssertAlmostEqual(&test, rTM, 4.19144654971722e-06);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.191442316395926e-06);
    AssertAlmostEqual(&test, rTM, 4.191450699210287e-06);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.191027408575527e-06);
    AssertAlmostEqual(&test, rTM, 4.191865607030685e-06);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.149947381868618e-06);
    AssertAlmostEqual(&test, rTM, 4.23294563373758e-06);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.095732038022671e-06);
    AssertAlmostEqual(&test, rTM, 6.287160977546723e-06);

    userdata[0] = 8/CAPS_HBAR_EV; /* 8eV */
    userdata[1] = 0.5/CAPS_HBAR_EV; /* 0.5eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999889497995442);
    AssertAlmostEqual(&test, rTM, 0.9999944748845087);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999214762208177);
    AssertAlmostEqual(&test, rTM, 0.999999222506615);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9992188946892416);
    AssertAlmostEqual(&test, rTM, 0.9999999218667551);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9922167487137618);
    AssertAlmostEqual(&test, rTM, 0.9999999921862295);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9248559484332532);
    AssertAlmostEqual(&test, rTM, 0.9999999992180324);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4663835806636862);
    AssertAlmostEqual(&test, rTM, 0.9999999999161113);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01586337790417164);
    AssertAlmostEqual(&test, rTM, 0.9999999999684888);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001637354257364082);
    AssertAlmostEqual(&test, rTM, 0.999999999969463);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637885209525488e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999694729);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.63789052122088e-08);
    AssertAlmostEqual(&test, rTM, 0.999999999969473);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637890574338052e-10);
    AssertAlmostEqual(&test, rTM, 0.999999999969473);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637890574869223e-12);
    AssertAlmostEqual(&test, rTM, 0.999999999969473);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637890574874535e-14);
    AssertAlmostEqual(&test, rTM, 0.999999999969473);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999751679336297);
    AssertAlmostEqual(&test, rTM, 0.9999754137926506);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999650566148103);
    AssertAlmostEqual(&test, rTM, 0.9999825281547711);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997517070835102);
    AssertAlmostEqual(&test, rTM, 0.9999975413520443);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9975320139497952);
    AssertAlmostEqual(&test, rTM, 0.9999997529208322);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9755942366457618);
    AssertAlmostEqual(&test, rTM, 0.9999999752889907);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7815571040662058);
    AssertAlmostEqual(&test, rTM, 0.9999999975103003);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1253116734141567);
    AssertAlmostEqual(&test, rTM, 0.9999999996072605);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001632547016041592);
    AssertAlmostEqual(&test, rTM, 0.9999999996937309);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637836865764515e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999996947193);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637889980737742e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999996947292);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637890511909221e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999996947293);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637890517220938e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999996947293);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637890517274055e-13);
    AssertAlmostEqual(&test, rTM, 0.9999999996947293);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997529385604705);
    AssertAlmostEqual(&test, rTM, 0.9997529388075012);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997529263327551);
    AssertAlmostEqual(&test, rTM, 0.9997529510345993);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997517066033235);
    AssertAlmostEqual(&test, rTM, 0.9997541646515734);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996506204159016);
    AssertAlmostEqual(&test, rTM, 0.9998252949456898);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9975198390597468);
    AssertAlmostEqual(&test, rTM, 0.999975413726519);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9755929968916212);
    AssertAlmostEqual(&test, rTM, 0.9999975290196363);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7815566384898086);
    AssertAlmostEqual(&test, rTM, 0.9999997510297027);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1253112956584753);
    AssertAlmostEqual(&test, rTM, 0.9999999607259253);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001632540721162545);
    AssertAlmostEqual(&test, rTM, 0.9999999693729752);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637830530202978e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999694718119);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637883644766882e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999694728019);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637884175934267e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999694728118);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637884181245943e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999694728119);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9992189184701082);
    AssertAlmostEqual(&test, rTM, 0.999218918477916);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9992189180836241);
    AssertAlmostEqual(&test, rTM, 0.9992189188644);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9992188794361706);
    AssertAlmostEqual(&test, rTM, 0.9992189575099033);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9992150243109975);
    AssertAlmostEqual(&test, rTM, 0.9992227933260971);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9988955626587127);
    AssertAlmostEqual(&test, rTM, 0.9994476287302241);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9921779333734936);
    AssertAlmostEqual(&test, rTM, 0.999922251547548);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9248509276565474);
    AssertAlmostEqual(&test, rTM, 0.9999921805933207);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4663767801225055);
    AssertAlmostEqual(&test, rTM, 0.999999161095168);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01586277733628897);
    AssertAlmostEqual(&test, rTM, 0.9999996848760999);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001637290307998718);
    AssertAlmostEqual(&test, rTM, 0.9999996946174838);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637821218843761e-06);
    AssertAlmostEqual(&test, rTM, 0.9999996947164674);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637826530125736e-08);
    AssertAlmostEqual(&test, rTM, 0.9999996947174574);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637826583238773e-10);
    AssertAlmostEqual(&test, rTM, 0.9999996947174674);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9975316557239027);
    AssertAlmostEqual(&test, rTM, 0.9975316557241493);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9975316557116994);
    AssertAlmostEqual(&test, rTM, 0.9975316557363524);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9975316544913791);
    AssertAlmostEqual(&test, rTM, 0.9975316569566721);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9975315324624076);
    AssertAlmostEqual(&test, rTM, 0.997531778979497);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.997519359992156);
    AssertAlmostEqual(&test, rTM, 0.9975438905848595);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9965110203129965);
    AssertAlmostEqual(&test, rTM, 0.9982539845419627);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9754693034176656);
    AssertAlmostEqual(&test, rTM, 0.9997540985292178);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.781510084340643);
    AssertAlmostEqual(&test, rTM, 0.9999750996413461);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1252735317339602);
    AssertAlmostEqual(&test, rTM, 0.9999960713883138);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001631911478306879);
    AssertAlmostEqual(&test, rTM, 0.9999969361258828);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637197221479561e-05);
    AssertAlmostEqual(&test, rTM, 0.9999969460095199);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637250295135191e-07);
    AssertAlmostEqual(&test, rTM, 0.9999969461085177);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.637250825893469e-09);
    AssertAlmostEqual(&test, rTM, 0.9999969461095078);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9922016205142804);
    AssertAlmostEqual(&test, rTM, 0.9922016205142882);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9922016205138959);
    AssertAlmostEqual(&test, rTM, 0.9922016205146726);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.992201620475445);
    AssertAlmostEqual(&test, rTM, 0.9922016205531236);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9922016166303588);
    AssertAlmostEqual(&test, rTM, 0.9922016243982079);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.992201232131415);
    AssertAlmostEqual(&test, rTM, 0.9922020088778877);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9921628786223574);
    AssertAlmostEqual(&test, rTM, 0.9922401716361934);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9889892933580063);
    AssertAlmostEqual(&test, rTM, 0.9944793660333789);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9243542878145045);
    AssertAlmostEqual(&test, rTM, 0.9992207019165177);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4657046458232871);
    AssertAlmostEqual(&test, rTM, 0.9999159342756876);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01580353946466534);
    AssertAlmostEqual(&test, rTM, 0.9999683704362256);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000163098332389174);
    AssertAlmostEqual(&test, rTM, 0.9999693445880672);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.631510167886417e-06);
    AssertAlmostEqual(&test, rTM, 0.9999693544859812);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.631515438474968e-08);
    AssertAlmostEqual(&test, rTM, 0.9999693545849766);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9751279413943008);
    AssertAlmostEqual(&test, rTM, 0.9751279413943011);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9751279413942887);
    AssertAlmostEqual(&test, rTM, 0.9751279413943132);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.975127941393073);
    AssertAlmostEqual(&test, rTM, 0.9751279413955289);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9751279412715067);
    AssertAlmostEqual(&test, rTM, 0.9751279415170953);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9751279291148771);
    AssertAlmostEqual(&test, rTM, 0.9751279536737189);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9751267134830793);
    AssertAlmostEqual(&test, rTM, 0.9751291692456681);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9750054603261934);
    AssertAlmostEqual(&test, rTM, 0.9752498297883053);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9650085839583494);
    AssertAlmostEqual(&test, rTM, 0.9823471172549755);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.776888945110917);
    AssertAlmostEqual(&test, rTM, 0.9974773670622331);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1216100408557583);
    AssertAlmostEqual(&test, rTM, 0.9995951169532783);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001571345820825326);
    AssertAlmostEqual(&test, rTM, 0.9996819035881942);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.576247608424754e-05);
    AssertAlmostEqual(&test, rTM, 0.999682891545416);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.576296819393017e-07);
    AssertAlmostEqual(&test, rTM, 0.9996829014405499);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9120007169629308);
    AssertAlmostEqual(&test, rTM, 0.9120007169629308);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9120007169629304);
    AssertAlmostEqual(&test, rTM, 0.9120007169629312);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9120007169628889);
    AssertAlmostEqual(&test, rTM, 0.9120007169629728);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9120007169587333);
    AssertAlmostEqual(&test, rTM, 0.9120007169671283);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9120007165431852);
    AssertAlmostEqual(&test, rTM, 0.9120007173826765);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9120006749883716);
    AssertAlmostEqual(&test, rTM, 0.9120007589374709);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9119965196206757);
    AssertAlmostEqual(&test, rTM, 0.9120049141142063);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9115821137193393);
    AssertAlmostEqual(&test, rTM, 0.9124174291834973);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8778991056404812);
    AssertAlmostEqual(&test, rTM, 0.9368981122208864);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4082760220815509);
    AssertAlmostEqual(&test, rTM, 0.9899677850555355);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.011506445078887);
    AssertAlmostEqual(&test, rTM, 0.9956741981626037);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001177427572609135);
    AssertAlmostEqual(&test, rTM, 0.9957714133558109);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.177703280676761e-06);
    AssertAlmostEqual(&test, rTM, 0.9957723969682085);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5823034833654924);
    AssertAlmostEqual(&test, rTM, 0.5823034833654924);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5823034833654923);
    AssertAlmostEqual(&test, rTM, 0.5823034833654924);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5823034833654909);
    AssertAlmostEqual(&test, rTM, 0.5823034833654939);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5823034833653387);
    AssertAlmostEqual(&test, rTM, 0.5823034833656461);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5823034833501207);
    AssertAlmostEqual(&test, rTM, 0.582303483380864);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5823034818283275);
    AssertAlmostEqual(&test, rTM, 0.5823034849026573);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5823033296490644);
    AssertAlmostEqual(&test, rTM, 0.5823036370818787);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5822881123304808);
    AssertAlmostEqual(&test, rTM, 0.5823188539841878);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5807724254530943);
    AssertAlmostEqual(&test, rTM, 0.5838304218026974);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4695518529835704);
    AssertAlmostEqual(&test, rTM, 0.6763667372601502);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03102632006991839);
    AssertAlmostEqual(&test, rTM, 0.8619406738337319);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003334989968782325);
    AssertAlmostEqual(&test, rTM, 0.869627245737861);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.337523619430404e-06);
    AssertAlmostEqual(&test, rTM, 0.8697076989869241);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03783665790564538);
    AssertAlmostEqual(&test, rTM, 0.03783665790564538);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03783665790564538);
    AssertAlmostEqual(&test, rTM, 0.03783665790564538);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03783665790564537);
    AssertAlmostEqual(&test, rTM, 0.03783665790564538);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03783665790564503);
    AssertAlmostEqual(&test, rTM, 0.03783665790564573);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0378366579056103);
    AssertAlmostEqual(&test, rTM, 0.03783665790568046);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0378366579021376);
    AssertAlmostEqual(&test, rTM, 0.03783665790915316);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0378366575548672);
    AssertAlmostEqual(&test, rTM, 0.03783665825642355);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03783662282786011);
    AssertAlmostEqual(&test, rTM, 0.03783669298343055);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03783315044949962);
    AssertAlmostEqual(&test, rTM, 0.03784016536085885);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03748910640391862);
    AssertAlmostEqual(&test, rTM, 0.03818420025377381);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0196406453749844);
    AssertAlmostEqual(&test, rTM, 0.0560076140199071);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004043360915457161);
    AssertAlmostEqual(&test, rTM, 0.07516309622462042);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.08665690891063e-06);
    AssertAlmostEqual(&test, rTM, 0.07556107248161001);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004177503663665611);
    AssertAlmostEqual(&test, rTM, 0.0004177503663665611);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004177503663665611);
    AssertAlmostEqual(&test, rTM, 0.0004177503663665611);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004177503663665611);
    AssertAlmostEqual(&test, rTM, 0.0004177503663665611);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000417750366366561);
    AssertAlmostEqual(&test, rTM, 0.0004177503663665611);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004177503663665569);
    AssertAlmostEqual(&test, rTM, 0.0004177503663665653);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004177503663661437);
    AssertAlmostEqual(&test, rTM, 0.0004177503663669785);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004177503663248209);
    AssertAlmostEqual(&test, rTM, 0.0004177503664083012);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004177503621925463);
    AssertAlmostEqual(&test, rTM, 0.0004177503705405759);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004177499489654968);
    AssertAlmostEqual(&test, rTM, 0.0004177507837676254);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004177086303885364);
    AssertAlmostEqual(&test, rTM, 0.0004177921023445843);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004136176442664304);
    AssertAlmostEqual(&test, rTM, 0.0004218830884524219);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002089624499767549);
    AssertAlmostEqual(&test, rTM, 0.0006265382463348901);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.139565885570041e-06);
    AssertAlmostEqual(&test, rTM, 0.0008313610239152126);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.190588593208529e-06);
    AssertAlmostEqual(&test, rTM, 4.190588593208529e-06);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.190588593208529e-06);
    AssertAlmostEqual(&test, rTM, 4.190588593208529e-06);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.190588593208529e-06);
    AssertAlmostEqual(&test, rTM, 4.190588593208529e-06);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.190588593208529e-06);
    AssertAlmostEqual(&test, rTM, 4.190588593208529e-06);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.190588593208528e-06);
    AssertAlmostEqual(&test, rTM, 4.190588593208529e-06);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.190588593208487e-06);
    AssertAlmostEqual(&test, rTM, 4.190588593208571e-06);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.190588593204339e-06);
    AssertAlmostEqual(&test, rTM, 4.190588593212719e-06);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.190588592789474e-06);
    AssertAlmostEqual(&test, rTM, 4.190588593627584e-06);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.190588551302995e-06);
    AssertAlmostEqual(&test, rTM, 4.190588635114064e-06);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.190584402659248e-06);
    AssertAlmostEqual(&test, rTM, 4.19059278375781e-06);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.190169579762393e-06);
    AssertAlmostEqual(&test, rTM, 4.191007606654664e-06);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.149097961336961e-06);
    AssertAlmostEqual(&test, rTM, 4.232079225080083e-06);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.095303077129842e-06);
    AssertAlmostEqual(&test, rTM, 6.28587410925042e-06);

    userdata[0] = 8/CAPS_HBAR_EV; /* 8eV */
    userdata[1] = 1/CAPS_HBAR_EV; /* 1eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999843726924281);
    AssertAlmostEqual(&test, rTM, 0.9999921863156871);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998889524126512);
    AssertAlmostEqual(&test, rTM, 0.9999989004584875);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9988955290339339);
    AssertAlmostEqual(&test, rTM, 0.999999889502899);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9890106185115185);
    AssertAlmostEqual(&test, rTM, 0.9999999889495754);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.895434260949818);
    AssertAlmostEqual(&test, rTM, 0.9999999988932885);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3480662127753376);
    AssertAlmostEqual(&test, rTM, 0.9999999998737524);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.008058003365255174);
    AssertAlmostEqual(&test, rTM, 0.999999999937954);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.18811182215862e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999389358);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.189439476972678e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999389457);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.189452756238668e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999999389458);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.1894528890316e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999999389458);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.18945289035953e-13);
    AssertAlmostEqual(&test, rTM, 0.9999999999389458);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.189452890372809e-15);
    AssertAlmostEqual(&test, rTM, 0.9999999999389458);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999648823359095);
    AssertAlmostEqual(&test, rTM, 0.9999652300295091);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999505829488715);
    AssertAlmostEqual(&test, rTM, 0.9999752911691688);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996488788519491);
    AssertAlmostEqual(&test, rTM, 0.9999965229484942);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.996511526436066);
    AssertAlmostEqual(&test, rTM, 0.9999996505770447);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9656611958707481);
    AssertAlmostEqual(&test, rTM, 0.9999999650506894);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7063205923585858);
    AssertAlmostEqual(&test, rTM, 0.9999999964526646);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.07072082112000307);
    AssertAlmostEqual(&test, rTM, 0.9999999992965307);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0008176066718447247);
    AssertAlmostEqual(&test, rTM, 0.9999999993884594);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.18931861484645e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999993894486);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.189451405030496e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999993894585);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.18945273295952e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999993894586);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.189452746238813e-12);
    AssertAlmostEqual(&test, rTM, 0.9999999993894586);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.189452746371606e-14);
    AssertAlmostEqual(&test, rTM, 0.9999999993894586);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996506205824788);
    AssertAlmostEqual(&test, rTM, 0.9996506209317968);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996506032916647);
    AssertAlmostEqual(&test, rTM, 0.9996506382217382);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996488785124404);
    AssertAlmostEqual(&test, rTM, 0.9996523543584198);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995059388935464);
    AssertAlmostEqual(&test, rTM, 0.9997529389234158);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9964943295967599);
    AssertAlmostEqual(&test, rTM, 0.9999652299433387);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9656594932079008);
    AssertAlmostEqual(&test, rTM, 0.9999965052446461);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7063202368738777);
    AssertAlmostEqual(&test, rTM, 0.9999996452663455);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.07072070179429318);
    AssertAlmostEqual(&test, rTM, 0.9999999296529529);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0008176050929399752);
    AssertAlmostEqual(&test, rTM, 0.9999999388458267);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.189302775388463e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999389447449);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.189435565066859e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999389457349);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.189436892990828e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999389457449);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.18943690627007e-12);
    AssertAlmostEqual(&test, rTM, 0.999999938945745);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9988955734357393);
    AssertAlmostEqual(&test, rTM, 0.9988955734467775);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9988955728893504);
    AssertAlmostEqual(&test, rTM, 0.9988955739931662);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9988955182518224);
    AssertAlmostEqual(&test, rTM, 0.9988956286279381);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9988900681038639);
    AssertAlmostEqual(&test, rTM, 0.9989010514868192);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9984384623973019);
    AssertAlmostEqual(&test, rTM, 0.9992189260413044);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9889560108417311);
    AssertAlmostEqual(&test, rTM, 0.9998900490978673);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8954283566671999);
    AssertAlmostEqual(&test, rTM, 0.9999889333925691);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3480627561677846);
    AssertAlmostEqual(&test, rTM, 0.9999987375112673);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.008057848389506026);
    AssertAlmostEqual(&test, rTM, 0.9999993795276374);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.187951892855584e-05);
    AssertAlmostEqual(&test, rTM, 0.9999993893470579);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.189279496614454e-07);
    AssertAlmostEqual(&test, rTM, 0.9999993894460496);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.18929277536974e-09);
    AssertAlmostEqual(&test, rTM, 0.9999993894470396);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.189292908157564e-11);
    AssertAlmostEqual(&test, rTM, 0.9999993894470496);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9965113604276313);
    AssertAlmostEqual(&test, rTM, 0.9965113604279795);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9965113604103927);
    AssertAlmostEqual(&test, rTM, 0.9965113604452182);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9965113586865341);
    AssertAlmostEqual(&test, rTM, 0.996511362169076);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9965111863049918);
    AssertAlmostEqual(&test, rTM, 0.996511534541944);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9964939911766211);
    AssertAlmostEqual(&test, rTM, 0.996528643778941);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9950698882250355);
    AssertAlmostEqual(&test, rTM, 0.997531894586375);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.965489641414388);
    AssertAlmostEqual(&test, rTM, 0.9996522682056774);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7062846896579037);
    AssertAlmostEqual(&test, rTM, 0.999964525536589);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0707087712548003);
    AssertAlmostEqual(&test, rTM, 0.9999929641491525);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0008174472332531301);
    AssertAlmostEqual(&test, rTM, 0.9999938834387742);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.187719138954195e-06);
    AssertAlmostEqual(&test, rTM, 0.9999938933305097);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.187851878082357e-08);
    AssertAlmostEqual(&test, rTM, 0.9999938934295081);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.187853205500808e-10);
    AssertAlmostEqual(&test, rTM, 0.999993893430498);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9889999534154543);
    AssertAlmostEqual(&test, rTM, 0.9889999534154652);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9889999534149128);
    AssertAlmostEqual(&test, rTM, 0.9889999534160067);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9889999533607636);
    AssertAlmostEqual(&test, rTM, 0.9889999534701558);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9889999479458553);
    AssertAlmostEqual(&test, rTM, 0.9889999588850614);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9889994064687109);
    AssertAlmostEqual(&test, rTM, 0.989000500335165);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9889453949278496);
    AssertAlmostEqual(&test, rTM, 0.9890542441189851);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9844791802711983);
    AssertAlmostEqual(&test, rTM, 0.9922091235046524);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8948447585312416);
    AssertAlmostEqual(&test, rTM, 0.9988983264643128);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3477208715896486);
    AssertAlmostEqual(&test, rTM, 0.9998736170390795);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.008042533700026055);
    AssertAlmostEqual(&test, rTM, 0.9999378384540579);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.17214817953763e-05);
    AssertAlmostEqual(&test, rTM, 0.9999388203207605);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.173470743179788e-07);
    AssertAlmostEqual(&test, rTM, 0.999938830219035);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.173483971518461e-09);
    AssertAlmostEqual(&test, rTM, 0.9999388303180259);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9653332794829241);
    AssertAlmostEqual(&test, rTM, 0.9653332794829245);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9653332794829073);
    AssertAlmostEqual(&test, rTM, 0.9653332794829413);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9653332794812215);
    AssertAlmostEqual(&test, rTM, 0.9653332794846271);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9653332793126481);
    AssertAlmostEqual(&test, rTM, 0.9653332796532005);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9653332624553135);
    AssertAlmostEqual(&test, rTM, 0.965333296510527);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9653315767654769);
    AssertAlmostEqual(&test, rTM, 0.965334982118219);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9651634419792172);
    AssertAlmostEqual(&test, rTM, 0.9655023035188212);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9513307247196501);
    AssertAlmostEqual(&test, rTM, 0.9753580578494271);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7027424460471459);
    AssertAlmostEqual(&test, rTM, 0.9964418371030379);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.06953569046486716);
    AssertAlmostEqual(&test, rTM, 0.9992849714782581);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0008019632551838356);
    AssertAlmostEqual(&test, rTM, 0.9993769192229631);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.03238985507236e-06);
    AssertAlmostEqual(&test, rTM, 0.9993779074967307);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.032517684295651e-08);
    AssertAlmostEqual(&test, rTM, 0.9993779173874143);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8862620497190891);
    AssertAlmostEqual(&test, rTM, 0.8862620497190891);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8862620497190885);
    AssertAlmostEqual(&test, rTM, 0.8862620497190896);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8862620497190357);
    AssertAlmostEqual(&test, rTM, 0.8862620497191425);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.886262049713745);
    AssertAlmostEqual(&test, rTM, 0.886262049724433);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8862620491846902);
    AssertAlmostEqual(&test, rTM, 0.8862620502534879);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8862619962792181);
    AssertAlmostEqual(&test, rTM, 0.8862621031589365);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8862567058806763);
    AssertAlmostEqual(&test, rTM, 0.8862673933215778);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.885729145339242);
    AssertAlmostEqual(&test, rTM, 0.886792618085338);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.843114568813553);
    AssertAlmostEqual(&test, rTM, 0.9180703700445338);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3167018022745789);
    AssertAlmostEqual(&test, rTM, 0.9860850472163855);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.006757998387365897);
    AssertAlmostEqual(&test, rTM, 0.9926563973394995);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.850013436686057e-05);
    AssertAlmostEqual(&test, rTM, 0.9927536409305063);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.850949382134091e-07);
    AssertAlmostEqual(&test, rTM, 0.9927546201278866);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5532835009693824);
    AssertAlmostEqual(&test, rTM, 0.5532835009693824);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5532835009693824);
    AssertAlmostEqual(&test, rTM, 0.5532835009693824);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5532835009693807);
    AssertAlmostEqual(&test, rTM, 0.5532835009693839);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5532835009692232);
    AssertAlmostEqual(&test, rTM, 0.5532835009695415);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5532835009534702);
    AssertAlmostEqual(&test, rTM, 0.5532835009852946);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5532834993781669);
    AssertAlmostEqual(&test, rTM, 0.5532835025605978);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5532833418479046);
    AssertAlmostEqual(&test, rTM, 0.5532836600908198);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5532675894744929);
    AssertAlmostEqual(&test, rTM, 0.5532994120605279);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5516988452482573);
    AssertAlmostEqual(&test, rTM, 0.5548641621328059);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4379417666450547);
    AssertAlmostEqual(&test, rTM, 0.6507052589275192);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02604020614942395);
    AssertAlmostEqual(&test, rTM, 0.8397002159953479);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002770764454137185);
    AssertAlmostEqual(&test, rTM, 0.8471370252244682);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.772559602890667e-06);
    AssertAlmostEqual(&test, rTM, 0.8472144593635528);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03698116467607235);
    AssertAlmostEqual(&test, rTM, 0.03698116467607235);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03698116467607235);
    AssertAlmostEqual(&test, rTM, 0.03698116467607235);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03698116467607234);
    AssertAlmostEqual(&test, rTM, 0.03698116467607235);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.036981164676072);
    AssertAlmostEqual(&test, rTM, 0.03698116467607269);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.036981164676038);
    AssertAlmostEqual(&test, rTM, 0.03698116467610669);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.036981164672638);
    AssertAlmostEqual(&test, rTM, 0.0369811646795067);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03698116433263739);
    AssertAlmostEqual(&test, rTM, 0.0369811650195073);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03698113033260862);
    AssertAlmostEqual(&test, rTM, 0.03698119901953599);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03697773064585232);
    AssertAlmostEqual(&test, rTM, 0.03698459870541897);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03664089401680382);
    AssertAlmostEqual(&test, rTM, 0.03732142676016589);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01918046961576303);
    AssertAlmostEqual(&test, rTM, 0.05475842248587783);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000394499922399534);
    AssertAlmostEqual(&test, rTM, 0.07346895696998491);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.987164292572142e-06);
    AssertAlmostEqual(&test, rTM, 0.07385735071957966);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004166875882728816);
    AssertAlmostEqual(&test, rTM, 0.0004166875882728816);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004166875882728816);
    AssertAlmostEqual(&test, rTM, 0.0004166875882728816);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004166875882728816);
    AssertAlmostEqual(&test, rTM, 0.0004166875882728816);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004166875882728816);
    AssertAlmostEqual(&test, rTM, 0.0004166875882728817);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004166875882728775);
    AssertAlmostEqual(&test, rTM, 0.0004166875882728858);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004166875882724653);
    AssertAlmostEqual(&test, rTM, 0.000416687588273298);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004166875882312476);
    AssertAlmostEqual(&test, rTM, 0.0004166875883145157);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004166875841094769);
    AssertAlmostEqual(&test, rTM, 0.0004166875924362864);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004166871719328218);
    AssertAlmostEqual(&test, rTM, 0.0004166880046129415);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004166459583848215);
    AssertAlmostEqual(&test, rTM, 0.0004167292181609403);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004125653713517707);
    AssertAlmostEqual(&test, rTM, 0.0004208098051798314);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002084306174493895);
    AssertAlmostEqual(&test, rTM, 0.0006249445229520874);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.129025927153389e-06);
    AssertAlmostEqual(&test, rTM, 0.0008292460087743727);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.189516693713608e-06);
    AssertAlmostEqual(&test, rTM, 4.189516693713608e-06);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.189516693713608e-06);
    AssertAlmostEqual(&test, rTM, 4.189516693713608e-06);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.189516693713608e-06);
    AssertAlmostEqual(&test, rTM, 4.189516693713608e-06);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.189516693713608e-06);
    AssertAlmostEqual(&test, rTM, 4.189516693713608e-06);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.189516693713607e-06);
    AssertAlmostEqual(&test, rTM, 4.189516693713608e-06);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.189516693713566e-06);
    AssertAlmostEqual(&test, rTM, 4.18951669371365e-06);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.189516693709419e-06);
    AssertAlmostEqual(&test, rTM, 4.189516693717797e-06);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.18951669329466e-06);
    AssertAlmostEqual(&test, rTM, 4.189516694132556e-06);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.189516651818793e-06);
    AssertAlmostEqual(&test, rTM, 4.189516735608423e-06);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.189512504236208e-06);
    AssertAlmostEqual(&test, rTM, 4.189520883191008e-06);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.189097787444907e-06);
    AssertAlmostEqual(&test, rTM, 4.189935599982308e-06);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.148036674532215e-06);
    AssertAlmostEqual(&test, rTM, 4.230996712894987e-06);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.094767122891059e-06);
    AssertAlmostEqual(&test, rTM, 6.28426626449939e-06);

    userdata[0] = 9/CAPS_HBAR_EV; /* 9eV */
    userdata[1] = 1e-05/CAPS_HBAR_EV; /* 1e-05eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999560683575);
    AssertAlmostEqual(&test, rTM, 0.9999999780341785);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999996878070638);
    AssertAlmostEqual(&test, rTM, 0.9999999969089803);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999996893413202);
    AssertAlmostEqual(&test, rTM, 0.9999999996893719);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999689361039065);
    AssertAlmostEqual(&test, rTM, 0.9999999999689356);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999689404613879);
    AssertAlmostEqual(&test, rTM, 0.9999999999968936);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9968983849204527);
    AssertAlmostEqual(&test, rTM, 0.9999999999996894);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9694143873785761);
    AssertAlmostEqual(&test, rTM, 0.9999999999999689);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7338813151363522);
    AssertAlmostEqual(&test, rTM, 0.9999999999999969);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.08647925200922987);
    AssertAlmostEqual(&test, rTM, 0.9999999999999994);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001034132988559727);
    AssertAlmostEqual(&test, rTM, 0.9999999999999996);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.03625369624989e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999999996);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.036274958244989e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999999996);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.036275170870448e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999999999996);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999011891736);
    AssertAlmostEqual(&test, rTM, 0.9999999021674985);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999999860953893);
    AssertAlmostEqual(&test, rTM, 0.9999999304769441);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999990118921748);
    AssertAlmostEqual(&test, rTM, 0.9999999902167495);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999901675115509);
    AssertAlmostEqual(&test, rTM, 0.9999999990168447);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999016843321976);
    AssertAlmostEqual(&test, rTM, 0.9999999999016796);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9990172787020075);
    AssertAlmostEqual(&test, rTM, 0.999999999990168);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9902161705513534);
    AssertAlmostEqual(&test, rTM, 0.9999999999990168);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9063942684638722);
    AssertAlmostEqual(&test, rTM, 0.9999999999999015);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3877571092539779);
    AssertAlmostEqual(&test, rTM, 0.999999999999989);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01013592510126848);
    AssertAlmostEqual(&test, rTM, 0.9999999999999951);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001034242617305131);
    AssertAlmostEqual(&test, rTM, 0.9999999999999951);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.034454441861263e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999999951);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.03445656065456e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999999951);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999989260803661);
    AssertAlmostEqual(&test, rTM, 0.99999892608144);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999989260272085);
    AssertAlmostEqual(&test, rTM, 0.999998926134595);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999989207246678);
    AssertAlmostEqual(&test, rTM, 0.9999989314105564);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999984812493861);
    AssertAlmostEqual(&test, rTM, 0.9999992406244047);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999892072990954);
    AssertAlmostEqual(&test, rTM, 0.9999998931410042);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998926084301192);
    AssertAlmostEqual(&test, rTM, 0.9999999892613403);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.998926656286972);
    AssertAlmostEqual(&test, rTM, 0.9999999989260807);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9893183135662671);
    AssertAlmostEqual(&test, rTM, 0.9999999998926065);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8982198419910553);
    AssertAlmostEqual(&test, rTM, 0.9999999999892454);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3577051849898808);
    AssertAlmostEqual(&test, rTM, 0.9999999999987811);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.008523563432213306);
    AssertAlmostEqual(&test, rTM, 0.9999999999994135);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.669241468595024e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999994232);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.670729742703024e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999994234);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999946616818421);
    AssertAlmostEqual(&test, rTM, 0.9999946616818954);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999946616791996);
    AssertAlmostEqual(&test, rTM, 0.999994661684538);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999946614149603);
    AssertAlmostEqual(&test, rTM, 0.999994661948764);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999994635056747);
    AssertAlmostEqual(&test, rTM, 0.9999946881748559);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999924504864454);
    AssertAlmostEqual(&test, rTM, 0.9999962252360982);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999463518626752);
    AssertAlmostEqual(&test, rTM, 0.9999994688162157);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.99946628255519);
    AssertAlmostEqual(&test, rTM, 0.9999999466193447);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9946758948449722);
    AssertAlmostEqual(&test, rTM, 0.9999999946616512);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9480225526259445);
    AssertAlmostEqual(&test, rTM, 0.9999999994659766);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5899665375773725);
    AssertAlmostEqual(&test, rTM, 0.9999999999447478);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03282458722992256);
    AssertAlmostEqual(&test, rTM, 0.9999999999847839);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003506583195200283);
    AssertAlmostEqual(&test, rTM, 0.9999999999857411);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.509019087908426e-06);
    AssertAlmostEqual(&test, rTM, 0.999999999985751);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999554874678158);
    AssertAlmostEqual(&test, rTM, 0.9999554874678203);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999554874675955);
    AssertAlmostEqual(&test, rTM, 0.9999554874680406);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999554874455623);
    AssertAlmostEqual(&test, rTM, 0.9999554874900738);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999554852422966);
    AssertAlmostEqual(&test, rTM, 0.9999554896932282);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999552654637649);
    AssertAlmostEqual(&test, rTM, 0.9999557083701562);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999370503536316);
    AssertAlmostEqual(&test, rTM, 0.9999685246814601);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995527446836415);
    AssertAlmostEqual(&test, rTM, 0.9999955707486254);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9955583223806789);
    AssertAlmostEqual(&test, rTM, 0.9999995548860229);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.956466158859401);
    AssertAlmostEqual(&test, rTM, 0.9999999554754766);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6430455262442877);
    AssertAlmostEqual(&test, rTM, 0.9999999954397284);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04593772791115689);
    AssertAlmostEqual(&test, rTM, 0.9999999989138669);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005041712058701117);
    AssertAlmostEqual(&test, rTM, 0.9999999990082736);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.046748738294776e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999990092632);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995648222581652);
    AssertAlmostEqual(&test, rTM, 0.9995648222581657);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995648222581437);
    AssertAlmostEqual(&test, rTM, 0.9995648222581871);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.99956482225599);
    AssertAlmostEqual(&test, rTM, 0.9995648222603408);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995648220406239);
    AssertAlmostEqual(&test, rTM, 0.9995648224757068);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995648005045579);
    AssertAlmostEqual(&test, rTM, 0.9995648440106858);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995626522568781);
    AssertAlmostEqual(&test, rTM, 0.9995669814948245);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993846212130455);
    AssertAlmostEqual(&test, rTM, 0.9996922632482839);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9956351232631641);
    AssertAlmostEqual(&test, rTM, 0.9999566896075537);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.957407673967236);
    AssertAlmostEqual(&test, rTM, 0.9999956464719019);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6492692607535221);
    AssertAlmostEqual(&test, rTM, 0.9999995545386735);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04785064195546254);
    AssertAlmostEqual(&test, rTM, 0.9999998957474585);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005272535682814562);
    AssertAlmostEqual(&test, rTM, 0.9999999051690034);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.278044294228105e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999052679507);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9956666807866669);
    AssertAlmostEqual(&test, rTM, 0.9956666807866669);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9956666807866646);
    AssertAlmostEqual(&test, rTM, 0.995666680786669);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9956666807864506);
    AssertAlmostEqual(&test, rTM, 0.995666680786883);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9956666807650473);
    AssertAlmostEqual(&test, rTM, 0.9956666808082864);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9956666786247124);
    AssertAlmostEqual(&test, rTM, 0.9956666829486203);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.995666464596595);
    AssertAlmostEqual(&test, rTM, 0.9956668969659769);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.995645115250785);
    AssertAlmostEqual(&test, rTM, 0.9956881397600302);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9938772705044664);
    AssertAlmostEqual(&test, rTM, 0.9969339276576777);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9572980248238073);
    AssertAlmostEqual(&test, rTM, 0.9995678739015228);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6498894786994887);
    AssertAlmostEqual(&test, rTM, 0.9999555639558845);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04805070941789265);
    AssertAlmostEqual(&test, rTM, 0.9999896184649401);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005296785792078207);
    AssertAlmostEqual(&test, rTM, 0.9999905604047993);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.302345263679313e-06);
    AssertAlmostEqual(&test, rTM, 0.9999905702993629);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9575149173387626);
    AssertAlmostEqual(&test, rTM, 0.9575149173387626);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9575149173387624);
    AssertAlmostEqual(&test, rTM, 0.9575149173387628);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9575149173387418);
    AssertAlmostEqual(&test, rTM, 0.9575149173387834);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9575149173366844);
    AssertAlmostEqual(&test, rTM, 0.9575149173408407);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9575149171309475);
    AssertAlmostEqual(&test, rTM, 0.9575149175465776);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9575148965572658);
    AssertAlmostEqual(&test, rTM, 0.9575149381202493);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9575128392427809);
    AssertAlmostEqual(&test, rTM, 0.9575169953353081);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9573076419553441);
    AssertAlmostEqual(&test, rTM, 0.9577212081183061);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.940454680858773);
    AssertAlmostEqual(&test, rTM, 0.9697634164231774);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6485929360926143);
    AssertAlmostEqual(&test, rTM, 0.9955900156906092);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04806649071193154);
    AssertAlmostEqual(&test, rTM, 0.9989633078311042);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005299217842009055);
    AssertAlmostEqual(&test, rTM, 0.9990573546850445);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.304787621244761e-06);
    AssertAlmostEqual(&test, rTM, 0.9990583427565205);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6499731251633576);
    AssertAlmostEqual(&test, rTM, 0.6499731251633576);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6499731251633576);
    AssertAlmostEqual(&test, rTM, 0.6499731251633576);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6499731251633561);
    AssertAlmostEqual(&test, rTM, 0.6499731251633589);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6499731251632197);
    AssertAlmostEqual(&test, rTM, 0.6499731251634955);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.649973125149569);
    AssertAlmostEqual(&test, rTM, 0.6499731251771461);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6499731237844983);
    AssertAlmostEqual(&test, rTM, 0.6499731265422167);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6499729872774885);
    AssertAlmostEqual(&test, rTM, 0.6499732630491838);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6499593370778526);
    AssertAlmostEqual(&test, rTM, 0.6499869128209632);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6485993045143512);
    AssertAlmostEqual(&test, rTM, 0.6513427106864079);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5462147316604539);
    AssertAlmostEqual(&test, rTM, 0.734087123890512);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04764017800960588);
    AssertAlmostEqual(&test, rTM, 0.9056579991481412);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005298937655615305);
    AssertAlmostEqual(&test, rTM, 0.9137812741029402);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.305026734090323e-06);
    AssertAlmostEqual(&test, rTM, 0.9138677917566133);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0480730688366833);
    AssertAlmostEqual(&test, rTM, 0.0480730688366833);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0480730688366833);
    AssertAlmostEqual(&test, rTM, 0.0480730688366833);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0480730688366833);
    AssertAlmostEqual(&test, rTM, 0.0480730688366833);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04807306883668286);
    AssertAlmostEqual(&test, rTM, 0.04807306883668373);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04807306883663964);
    AssertAlmostEqual(&test, rTM, 0.04807306883672696);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.048073068832317);
    AssertAlmostEqual(&test, rTM, 0.0480730688410496);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04807306840005297);
    AssertAlmostEqual(&test, rTM, 0.04807306927331362);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04807302517369014);
    AssertAlmostEqual(&test, rTM, 0.04807311249967627);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04806870293085092);
    AssertAlmostEqual(&test, rTM, 0.04807743474067878);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04764037750795748);
    AssertAlmostEqual(&test, rTM, 0.04850574212381357);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02520524876462521);
    AssertAlmostEqual(&test, rTM, 0.07089060486692544);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005247076196914897);
    AssertAlmostEqual(&test, rTM, 0.09540454865585203);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.30452602980103e-06);
    AssertAlmostEqual(&test, rTM, 0.09591919862682911);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000529949381318528);
    AssertAlmostEqual(&test, rTM, 0.000529949381318528);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000529949381318528);
    AssertAlmostEqual(&test, rTM, 0.000529949381318528);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000529949381318528);
    AssertAlmostEqual(&test, rTM, 0.000529949381318528);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000529949381318528);
    AssertAlmostEqual(&test, rTM, 0.0005299493813185281);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005299493813185227);
    AssertAlmostEqual(&test, rTM, 0.0005299493813185333);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005299493813179987);
    AssertAlmostEqual(&test, rTM, 0.0005299493813190574);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005299493812655892);
    AssertAlmostEqual(&test, rTM, 0.0005299493813714669);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005299493760246482);
    AssertAlmostEqual(&test, rTM, 0.0005299493866124078);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005299488519310707);
    AssertAlmostEqual(&test, rTM, 0.0005299499107059854);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005298964478076595);
    AssertAlmostEqual(&test, rTM, 0.0005300023148293936);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005247078611480502);
    AssertAlmostEqual(&test, rTM, 0.0005351909014598867);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002651151324270754);
    AssertAlmostEqual(&test, rTM, 0.000794783555871671);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.252534136491971e-06);
    AssertAlmostEqual(&test, rTM, 0.001054645936703327);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.305059164938285e-06);
    AssertAlmostEqual(&test, rTM, 5.305059164938285e-06);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.305059164938285e-06);
    AssertAlmostEqual(&test, rTM, 5.305059164938285e-06);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.305059164938285e-06);
    AssertAlmostEqual(&test, rTM, 5.305059164938285e-06);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.305059164938285e-06);
    AssertAlmostEqual(&test, rTM, 5.305059164938285e-06);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.305059164938285e-06);
    AssertAlmostEqual(&test, rTM, 5.305059164938286e-06);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.305059164938232e-06);
    AssertAlmostEqual(&test, rTM, 5.305059164938339e-06);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.30505916493298e-06);
    AssertAlmostEqual(&test, rTM, 5.30505916494359e-06);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.305059164407785e-06);
    AssertAlmostEqual(&test, rTM, 5.305059165468786e-06);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.305059111888257e-06);
    AssertAlmostEqual(&test, rTM, 5.305059217988314e-06);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.305053859940712e-06);
    AssertAlmostEqual(&test, rTM, 5.305064469935859e-06);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.304528717694654e-06);
    AssertAlmostEqual(&test, rTM, 5.305589612181917e-06);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.252534378450947e-06);
    AssertAlmostEqual(&test, rTM, 5.357583951425594e-06);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.652543654314177e-06);
    AssertAlmostEqual(&test, rTM, 7.957574675487742e-06);

    userdata[0] = 9/CAPS_HBAR_EV; /* 9eV */
    userdata[1] = 0.0001/CAPS_HBAR_EV; /* 0.0001eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999998610881667);
    AssertAlmostEqual(&test, rTM, 0.999999930544081);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999990128463683);
    AssertAlmostEqual(&test, rTM, 0.9999999902261969);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999901770065227);
    AssertAlmostEqual(&test, rTM, 0.999999999017794);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999017792688192);
    AssertAlmostEqual(&test, rTM, 0.9999999999017746);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9990182272283383);
    AssertAlmostEqual(&test, rTM, 0.9999999999901774);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9902255721794759);
    AssertAlmostEqual(&test, rTM, 0.9999999999990178);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9064802272614015);
    AssertAlmostEqual(&test, rTM, 0.9999999999999016);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3880876753315237);
    AssertAlmostEqual(&test, rTM, 0.999999999999989);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01015513540222474);
    AssertAlmostEqual(&test, rTM, 0.9999999999999951);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001036242590730988);
    AssertAlmostEqual(&test, rTM, 0.9999999999999952);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.036455235376199e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999999952);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.036457362373571e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999999952);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.0364573836436e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999999999952);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999996878070638);
    AssertAlmostEqual(&test, rTM, 0.9999996908980825);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999995606836611);
    AssertAlmostEqual(&test, rTM, 0.9999997803418065);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999968780750237);
    AssertAlmostEqual(&test, rTM, 0.9999999690898039);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999689345663071);
    AssertAlmostEqual(&test, rTM, 0.999999996893719);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996894044601583);
    AssertAlmostEqual(&test, rTM, 0.9999999996893565);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9968983849051235);
    AssertAlmostEqual(&test, rTM, 0.9999999999689356);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9694143873770856);
    AssertAlmostEqual(&test, rTM, 0.9999999999968932);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7338813151362408);
    AssertAlmostEqual(&test, rTM, 0.9999999999996856);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.08647925200922915);
    AssertAlmostEqual(&test, rTM, 0.9999999999999426);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001034132988559727);
    AssertAlmostEqual(&test, rTM, 0.9999999999999517);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.03625369624989e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999999517);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.036274958244989e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999999517);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.036275170870448e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999999999517);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999968636744678);
    AssertAlmostEqual(&test, rTM, 0.9999968636776042);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999996863519224);
    AssertAlmostEqual(&test, rTM, 0.9999968638328401);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999968480334501);
    AssertAlmostEqual(&test, rTM, 0.999996879240991);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999955645709951);
    AssertAlmostEqual(&test, rTM, 0.9999977822830385);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999684807815685);
    AssertAlmostEqual(&test, rTM, 0.9999996879236608);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999686400614376);
    AssertAlmostEqual(&test, rTM, 0.9999999686382793);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9968685839775708);
    AssertAlmostEqual(&test, rTM, 0.9999999968636688);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9691246828697959);
    AssertAlmostEqual(&test, rTM, 0.9999999996863286);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.731716991659581);
    AssertAlmostEqual(&test, rTM, 0.9999999999682534);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.08509578713624782);
    AssertAlmostEqual(&test, rTM, 0.9999999999941668);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001014553906437717);
    AssertAlmostEqual(&test, rTM, 0.9999999999950717);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.016595013216385e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999950816);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.016615476138556e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999950817);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999892608608757);
    AssertAlmostEqual(&test, rTM, 0.9999892608609832);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999892608555599);
    AssertAlmostEqual(&test, rTM, 0.999989260866299);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999892603239888);
    AssertAlmostEqual(&test, rTM, 0.9999892613978433);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999892072990954);
    AssertAlmostEqual(&test, rTM, 0.9999893141569492);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999848125976575);
    AssertAlmostEqual(&test, rTM, 0.9999924062699963);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999892078232562);
    AssertAlmostEqual(&test, rTM, 0.999998931410555);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9989266031863558);
    AssertAlmostEqual(&test, rTM, 0.9999998926133922);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9893183083072247);
    AssertAlmostEqual(&test, rTM, 0.9999999892606539);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8982198415142573);
    AssertAlmostEqual(&test, rTM, 0.9999999989245333);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3577051849731279);
    AssertAlmostEqual(&test, rTM, 0.9999999998781054);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.008523563432205011);
    AssertAlmostEqual(&test, rTM, 0.9999999999413434);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.669241468594939e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999423248);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.670729742703024e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999423347);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999466181010671);
    AssertAlmostEqual(&test, rTM, 0.9999466181010724);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999466181008029);
    AssertAlmostEqual(&test, rTM, 0.9999466181013367);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999466180743796);
    AssertAlmostEqual(&test, rTM, 0.99994661812776);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999466154321128);
    AssertAlmostEqual(&test, rTM, 0.9999466207698934);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999463518626752);
    AssertAlmostEqual(&test, rTM, 0.9999468830182443);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999245074292018);
    AssertAlmostEqual(&test, rTM, 0.9999622530021696);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994636481301102);
    AssertAlmostEqual(&test, rTM, 0.9999946881746685);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.994675632012008);
    AssertAlmostEqual(&test, rTM, 0.9999994661916928);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9480225275836157);
    AssertAlmostEqual(&test, rTM, 0.9999999465976914);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5899665360711336);
    AssertAlmostEqual(&test, rTM, 0.9999999944747758);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03282458722687948);
    AssertAlmostEqual(&test, rTM, 0.9999999984783928);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003506583195196814);
    AssertAlmostEqual(&test, rTM, 0.9999999985741107);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.509019087908392e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999985751004);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995549638326831);
    AssertAlmostEqual(&test, rTM, 0.9995549638326835);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995549638326611);
    AssertAlmostEqual(&test, rTM, 0.9995549638327056);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995549638304586);
    AssertAlmostEqual(&test, rTM, 0.9995549638349081);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995549636102148);
    AssertAlmostEqual(&test, rTM, 0.9995549640551517);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995549415863839);
    AssertAlmostEqual(&test, rTM, 0.999554986077871);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995527446836415);
    AssertAlmostEqual(&test, rTM, 0.9995571719734001);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993706818362781);
    AssertAlmostEqual(&test, rTM, 0.9996852913895932);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9955364414645241);
    AssertAlmostEqual(&test, rTM, 0.9999557082615428);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9564640519406667);
    AssertAlmostEqual(&test, rTM, 0.9999955477779557);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6430453879386179);
    AssertAlmostEqual(&test, rTM, 0.9999995439731855);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04593772749632169);
    AssertAlmostEqual(&test, rTM, 0.9999998913867026);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005041712058202491);
    AssertAlmostEqual(&test, rTM, 0.9999999008273742);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.046748738289779e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999009263237);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9956567381715463);
    AssertAlmostEqual(&test, rTM, 0.9956567381715463);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9956567381715442);
    AssertAlmostEqual(&test, rTM, 0.9956567381715485);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9956567381713296);
    AssertAlmostEqual(&test, rTM, 0.995656738171763);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9956567381498773);
    AssertAlmostEqual(&test, rTM, 0.9956567381932153);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9956567360046422);
    AssertAlmostEqual(&test, rTM, 0.9956567403384494);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.99565652148652);
    AssertAlmostEqual(&test, rTM, 0.9956569548457864);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9956351232631641);
    AssertAlmostEqual(&test, rTM, 0.9956782462745104);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9938632348558779);
    AssertAlmostEqual(&test, rTM, 0.9969268881754005);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9572019803696196);
    AssertAlmostEqual(&test, rTM, 0.999566879994275);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6492555920896999);
    AssertAlmostEqual(&test, rTM, 0.9999554571635065);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04785059890991243);
    AssertAlmostEqual(&test, rTM, 0.9999895748494385);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005272535630671474);
    AssertAlmostEqual(&test, rTM, 0.9999905169893194);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.278044293705585e-06);
    AssertAlmostEqual(&test, rTM, 0.9999905268839067);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9575053458404751);
    AssertAlmostEqual(&test, rTM, 0.9575053458404751);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9575053458404749);
    AssertAlmostEqual(&test, rTM, 0.9575053458404753);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9575053458404543);
    AssertAlmostEqual(&test, rTM, 0.9575053458404958);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9575053458383965);
    AssertAlmostEqual(&test, rTM, 0.9575053458425536);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9575053456326144);
    AssertAlmostEqual(&test, rTM, 0.9575053460483358);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9575053250544027);
    AssertAlmostEqual(&test, rTM, 0.9575053666265375);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9575032672869324);
    AssertAlmostEqual(&test, rTM, 0.9575074242945607);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9572980248238073);
    AssertAlmostEqual(&test, rTM, 0.9577116820465352);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9404413890506448);
    AssertAlmostEqual(&test, rTM, 0.9697565585369773);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6485292637452624);
    AssertAlmostEqual(&test, rTM, 0.9955889572529862);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04804638898820885);
    AssertAlmostEqual(&test, rTM, 0.9989628725406803);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005296780553817641);
    AssertAlmostEqual(&test, rTM, 0.9990569213401401);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.302345211186652e-06);
    AssertAlmostEqual(&test, rTM, 0.9990579094112167);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6499667734957136);
    AssertAlmostEqual(&test, rTM, 0.6499667734957136);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6499667734957136);
    AssertAlmostEqual(&test, rTM, 0.6499667734957136);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6499667734957122);
    AssertAlmostEqual(&test, rTM, 0.649966773495715);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6499667734955757);
    AssertAlmostEqual(&test, rTM, 0.6499667734958515);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6499667734819249);
    AssertAlmostEqual(&test, rTM, 0.6499667735095024);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6499667721168375);
    AssertAlmostEqual(&test, rTM, 0.6499667748745896);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6499666356081591);
    AssertAlmostEqual(&test, rTM, 0.6499669113832253);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6499529852416744);
    AssertAlmostEqual(&test, rTM, 0.6499805613218532);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6485929360926143);
    AssertAlmostEqual(&test, rTM, 0.6513363757713398);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5462073473351403);
    AssertAlmostEqual(&test, rTM, 0.7340818341743891);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04763818311819098);
    AssertAlmostEqual(&test, rTM, 0.9056544040943728);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000529869382751257);
    AssertAlmostEqual(&test, rTM, 0.9137776486913335);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.304782369565986e-06);
    AssertAlmostEqual(&test, rTM, 0.9138641658399699);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04807286770093191);
    AssertAlmostEqual(&test, rTM, 0.04807286770093191);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04807286770093191);
    AssertAlmostEqual(&test, rTM, 0.04807286770093191);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0480728677009319);
    AssertAlmostEqual(&test, rTM, 0.04807286770093191);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04807286770093147);
    AssertAlmostEqual(&test, rTM, 0.04807286770093235);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04807286770088824);
    AssertAlmostEqual(&test, rTM, 0.04807286770097557);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04807286769656562);
    AssertAlmostEqual(&test, rTM, 0.04807286770529819);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04807286726430323);
    AssertAlmostEqual(&test, rTM, 0.04807286813756058);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04807282403810383);
    AssertAlmostEqual(&test, rTM, 0.0480729113637598);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04806850181160611);
    AssertAlmostEqual(&test, rTM, 0.04807723358842083);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04764017800960588);
    AssertAlmostEqual(&test, rTM, 0.04850553935087477);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02520513836473537);
    AssertAlmostEqual(&test, rTM, 0.07089031360480572);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005247052051381071);
    AssertAlmostEqual(&test, rTM, 0.09540415151507155);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.304501594529398e-06);
    AssertAlmostEqual(&test, rTM, 0.09591879915738344);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005299491374525163);
    AssertAlmostEqual(&test, rTM, 0.0005299491374525163);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005299491374525163);
    AssertAlmostEqual(&test, rTM, 0.0005299491374525163);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005299491374525163);
    AssertAlmostEqual(&test, rTM, 0.0005299491374525163);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005299491374525162);
    AssertAlmostEqual(&test, rTM, 0.0005299491374525163);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000529949137452511);
    AssertAlmostEqual(&test, rTM, 0.0005299491374525215);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005299491374519869);
    AssertAlmostEqual(&test, rTM, 0.0005299491374530456);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005299491373995775);
    AssertAlmostEqual(&test, rTM, 0.0005299491375054551);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005299491321586389);
    AssertAlmostEqual(&test, rTM, 0.0005299491427463936);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005299486080653023);
    AssertAlmostEqual(&test, rTM, 0.0005299496668397303);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005298962039659804);
    AssertAlmostEqual(&test, rTM, 0.0005300020709390492);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005247076196914898);
    AssertAlmostEqual(&test, rTM, 0.0005351906551844237);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002651150103648073);
    AssertAlmostEqual(&test, rTM, 0.0007947831902020182);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.252531716903449e-06);
    AssertAlmostEqual(&test, rTM, 0.001054645451391295);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.305058920559772e-06);
    AssertAlmostEqual(&test, rTM, 5.305058920559772e-06);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.305058920559772e-06);
    AssertAlmostEqual(&test, rTM, 5.305058920559772e-06);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.305058920559772e-06);
    AssertAlmostEqual(&test, rTM, 5.305058920559772e-06);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.305058920559772e-06);
    AssertAlmostEqual(&test, rTM, 5.305058920559772e-06);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.305058920559771e-06);
    AssertAlmostEqual(&test, rTM, 5.305058920559773e-06);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.305058920559719e-06);
    AssertAlmostEqual(&test, rTM, 5.305058920559826e-06);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.305058920554467e-06);
    AssertAlmostEqual(&test, rTM, 5.305058920565077e-06);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.305058920029272e-06);
    AssertAlmostEqual(&test, rTM, 5.305058921090272e-06);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.305058867509746e-06);
    AssertAlmostEqual(&test, rTM, 5.305058973609798e-06);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.305053615562444e-06);
    AssertAlmostEqual(&test, rTM, 5.305064225557101e-06);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.304528473340576e-06);
    AssertAlmostEqual(&test, rTM, 5.305589367778968e-06);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.252534136491972e-06);
    AssertAlmostEqual(&test, rTM, 5.357583704627543e-06);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.652543532123624e-06);
    AssertAlmostEqual(&test, rTM, 7.95757430892127e-06);

    userdata[0] = 9/CAPS_HBAR_EV; /* 9eV */
    userdata[1] = 0.001/CAPS_HBAR_EV; /* 0.001eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999999560726141);
    AssertAlmostEqual(&test, rTM, 0.9999997803630464);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999968783768994);
    AssertAlmostEqual(&test, rTM, 0.9999999690927929);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999689375701494);
    AssertAlmostEqual(&test, rTM, 0.9999999968940194);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996894344886977);
    AssertAlmostEqual(&test, rTM, 0.9999999996893866);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9968986843516898);
    AssertAlmostEqual(&test, rTM, 0.9999999999689386);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9694172989430873);
    AssertAlmostEqual(&test, rTM, 0.9999999999968935);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7339030985136735);
    AssertAlmostEqual(&test, rTM, 0.9999999999996857);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.08649331557673202);
    AssertAlmostEqual(&test, rTM, 0.9999999999999426);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001034332596319655);
    AssertAlmostEqual(&test, rTM, 0.9999999999999517);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.03645412338976e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999999517);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.0364753936105e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999999517);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.036475606318218e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999999999517);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.036475608445296e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999999999517);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999990128463683);
    AssertAlmostEqual(&test, rTM, 0.9999990226201618);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999986108825362);
    AssertAlmostEqual(&test, rTM, 0.9999993054410269);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999901285075343);
    AssertAlmostEqual(&test, rTM, 0.9999999022619732);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999901774407257);
    AssertAlmostEqual(&test, rTM, 0.9999999901779405);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9990182267425995);
    AssertAlmostEqual(&test, rTM, 0.9999999990177453);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9902255721313301);
    AssertAlmostEqual(&test, rTM, 0.9999999999017734);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9064802272569994);
    AssertAlmostEqual(&test, rTM, 0.9999999999901656);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3880876753313543);
    AssertAlmostEqual(&test, rTM, 0.9999999999989057);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01015513540222464);
    AssertAlmostEqual(&test, rTM, 0.9999999999995077);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001036242590730988);
    AssertAlmostEqual(&test, rTM, 0.9999999999995175);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.036455235376199e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999995176);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.036457362373571e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999995176);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.0364573836436e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999999995176);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.99999016799822);
    AssertAlmostEqual(&test, rTM, 0.9999901680080521);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999901675115509);
    AssertAlmostEqual(&test, rTM, 0.9999901684946966);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999901189656832);
    AssertAlmostEqual(&test, rTM, 0.9999902167972277);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999860954850034);
    AssertAlmostEqual(&test, rTM, 0.9999930477183345);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999011940503246);
    AssertAlmostEqual(&test, rTM, 0.9999990216754145);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9990172295962384);
    AssertAlmostEqual(&test, rTM, 0.9999999016844566);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9902161656839751);
    AssertAlmostEqual(&test, rTM, 0.9999999901678409);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9063942680188687);
    AssertAlmostEqual(&test, rTM, 0.9999999990156081);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3877571092368728);
    AssertAlmostEqual(&test, rTM, 0.9999999998904412);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01013592510125855);
    AssertAlmostEqual(&test, rTM, 0.9999999999506756);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000103424261730512);
    AssertAlmostEqual(&test, rTM, 0.9999999999516554);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.034454441861262e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999516653);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.03445656065456e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999516654);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999686372028446);
    AssertAlmostEqual(&test, rTM, 0.9999686372031582);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999686371873202);
    AssertAlmostEqual(&test, rTM, 0.9999686372186825);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999686356349253);
    AssertAlmostEqual(&test, rTM, 0.9999686387709991);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999684807815685);
    AssertAlmostEqual(&test, rTM, 0.9999687928481686);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999556465952313);
    AssertAlmostEqual(&test, rTM, 0.9999778230517044);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996848525189701);
    AssertAlmostEqual(&test, rTM, 0.999996879240953);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.996868429219548);
    AssertAlmostEqual(&test, rTM, 0.9999996863824558);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9691246678261555);
    AssertAlmostEqual(&test, rTM, 0.9999999686328712);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7317169905373182);
    AssertAlmostEqual(&test, rTM, 0.999999996825342);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.08509578712914467);
    AssertAlmostEqual(&test, rTM, 0.9999999994166816);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001014553906436715);
    AssertAlmostEqual(&test, rTM, 0.9999999995071731);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.016595013216375e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999995081621);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.016615476138555e-07);
    AssertAlmostEqual(&test, rTM, 0.999999999508172);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998926137990013);
    AssertAlmostEqual(&test, rTM, 0.9998926137990121);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998926137984698);
    AssertAlmostEqual(&test, rTM, 0.9998926137995436);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998926137453165);
    AssertAlmostEqual(&test, rTM, 0.9998926138526969);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998926084301192);
    AssertAlmostEqual(&test, rTM, 0.9998926191676258);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999892078232562);
    AssertAlmostEqual(&test, rTM, 0.9998931467078217);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998481363558722);
    AssertAlmostEqual(&test, rTM, 0.9999240652947869);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9989213063464693);
    AssertAlmostEqual(&test, rTM, 0.9999893141554239);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9893177824162693);
    AssertAlmostEqual(&test, rTM, 0.9999989261191154);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8982197938344678);
    AssertAlmostEqual(&test, rTM, 0.9999998924533844);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3577051832978403);
    AssertAlmostEqual(&test, rTM, 0.9999999878105347);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.008523563431375442);
    AssertAlmostEqual(&test, rTM, 0.999999994134335);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.669241468586359e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999942324828);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.670729742702939e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999942334727);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994663092319384);
    AssertAlmostEqual(&test, rTM, 0.9994663092319389);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994663092319119);
    AssertAlmostEqual(&test, rTM, 0.9994663092319653);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994663092292708);
    AssertAlmostEqual(&test, rTM, 0.9994663092346063);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994663089651645);
    AssertAlmostEqual(&test, rTM, 0.9994663094987126);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.99946628255519);
    AssertAlmostEqual(&test, rTM, 0.9994663359073542);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994636481301102);
    AssertAlmostEqual(&test, rTM, 0.9994689571342564);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9992453307189032);
    AssertAlmostEqual(&test, rTM, 0.9996225941284191);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9946494144386036);
    AssertAlmostEqual(&test, rTM, 0.9999468828309084);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9480200234167209);
    AssertAlmostEqual(&test, rTM, 0.9999946600477645);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.589966385447293);
    AssertAlmostEqual(&test, rTM, 0.9999994474780245);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03282458692257163);
    AssertAlmostEqual(&test, rTM, 0.9999998478393054);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003506583194849906);
    AssertAlmostEqual(&test, rTM, 0.9999998574110924);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.509019087904918e-06);
    AssertAlmostEqual(&test, rTM, 0.9999998575100573);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9955585439536564);
    AssertAlmostEqual(&test, rTM, 0.9955585439536564);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9955585439536542);
    AssertAlmostEqual(&test, rTM, 0.9955585439536586);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9955585439534348);
    AssertAlmostEqual(&test, rTM, 0.995558543953878);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9955585439314986);
    AssertAlmostEqual(&test, rTM, 0.9955585439758142);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9955585417378715);
    AssertAlmostEqual(&test, rTM, 0.9955585461694402);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9955583223806789);
    AssertAlmostEqual(&test, rTM, 0.9955587655156054);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9955364414645241);
    AssertAlmostEqual(&test, rTM, 0.9955805372388632);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9937246205742497);
    AssertAlmostEqual(&test, rTM, 0.9968573644610563);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9562539076941231);
    AssertAlmostEqual(&test, rTM, 0.9995570634173754);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6430315578838778);
    AssertAlmostEqual(&test, rTM, 0.9999544007220701);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0459376860128401);
    AssertAlmostEqual(&test, rTM, 0.9999891387828224);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005041712008339846);
    AssertAlmostEqual(&test, rTM, 0.9999900828347396);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.046748737790156e-06);
    AssertAlmostEqual(&test, rTM, 0.9999900927295512);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9574097570900861);
    AssertAlmostEqual(&test, rTM, 0.9574097570900861);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9574097570900859);
    AssertAlmostEqual(&test, rTM, 0.9574097570900862);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9574097570900653);
    AssertAlmostEqual(&test, rTM, 0.9574097570901069);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9574097570880029);
    AssertAlmostEqual(&test, rTM, 0.9574097570921692);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9574097568817683);
    AssertAlmostEqual(&test, rTM, 0.9574097572984038);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9574097362583194);
    AssertAlmostEqual(&test, rTM, 0.9574097779218429);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.957407673967236);
    AssertAlmostEqual(&test, rTM, 0.9574118401132706);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9572019803696196);
    AssertAlmostEqual(&test, rTM, 0.9576165469357169);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9403086493627626);
    AssertAlmostEqual(&test, rTM, 0.9696880689374456);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6478937241113032);
    AssertAlmostEqual(&test, rTM, 0.9955783846276597);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04784629474686531);
    AssertAlmostEqual(&test, rTM, 0.998958519749408);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005272530416367834);
    AssertAlmostEqual(&test, rTM, 0.9990525879117845);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.278044241453498e-06);
    AssertAlmostEqual(&test, rTM, 0.9990535759788548);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6499032686383583);
    AssertAlmostEqual(&test, rTM, 0.6499032686383583);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6499032686383583);
    AssertAlmostEqual(&test, rTM, 0.6499032686383583);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6499032686383569);
    AssertAlmostEqual(&test, rTM, 0.6499032686383597);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6499032686382205);
    AssertAlmostEqual(&test, rTM, 0.6499032686384962);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6499032686245678);
    AssertAlmostEqual(&test, rTM, 0.6499032686521488);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6499032672593138);
    AssertAlmostEqual(&test, rTM, 0.6499032700174029);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6499031307339546);
    AssertAlmostEqual(&test, rTM, 0.6499034065427193);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6498894786994888);
    AssertAlmostEqual(&test, rTM, 0.6499170581493268);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6485292637452624);
    AssertAlmostEqual(&test, rTM, 0.6512730383889461);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5461335197285009);
    AssertAlmostEqual(&test, rTM, 0.7340289456102935);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04761824340984949);
    AssertAlmostEqual(&test, rTM, 0.9056184552015066);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005296256780077724);
    AssertAlmostEqual(&test, rTM, 0.9137413961574277);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.302339961925809e-06);
    AssertAlmostEqual(&test, rTM, 0.9138279082559774);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04807085643619835);
    AssertAlmostEqual(&test, rTM, 0.04807085643619835);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04807085643619835);
    AssertAlmostEqual(&test, rTM, 0.04807085643619835);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04807085643619835);
    AssertAlmostEqual(&test, rTM, 0.04807085643619836);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04807085643619791);
    AssertAlmostEqual(&test, rTM, 0.04807085643619879);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04807085643615469);
    AssertAlmostEqual(&test, rTM, 0.04807085643624201);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04807085643183223);
    AssertAlmostEqual(&test, rTM, 0.04807085644056448);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04807085599958619);
    AssertAlmostEqual(&test, rTM, 0.04807085687281052);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.048070812775021);
    AssertAlmostEqual(&test, rTM, 0.04807090009737552);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04806649071193154);
    AssertAlmostEqual(&test, rTM, 0.0480752221586285);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04763818311819098);
    AssertAlmostEqual(&test, rTM, 0.04850351171494613);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0252040344190595);
    AssertAlmostEqual(&test, rTM, 0.07088740111540462);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005246810608264446);
    AssertAlmostEqual(&test, rTM, 0.09540018028910907);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.304257254194217e-06);
    AssertAlmostEqual(&test, rTM, 0.09591480464592045);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005299466988047427);
    AssertAlmostEqual(&test, rTM, 0.0005299466988047427);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005299466988047427);
    AssertAlmostEqual(&test, rTM, 0.0005299466988047427);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005299466988047427);
    AssertAlmostEqual(&test, rTM, 0.0005299466988047427);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005299466988047427);
    AssertAlmostEqual(&test, rTM, 0.0005299466988047428);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005299466988047374);
    AssertAlmostEqual(&test, rTM, 0.000529946698804748);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005299466988042133);
    AssertAlmostEqual(&test, rTM, 0.0005299466988052721);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005299466987518041);
    AssertAlmostEqual(&test, rTM, 0.0005299466988576812);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005299466935108897);
    AssertAlmostEqual(&test, rTM, 0.0005299467040985957);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005299461694199622);
    AssertAlmostEqual(&test, rTM, 0.0005299472281895232);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005298937655615308);
    AssertAlmostEqual(&test, rTM, 0.0005299996320479517);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005247052051381072);
    AssertAlmostEqual(&test, rTM, 0.0005351881924422594);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002651137897483075);
    AssertAlmostEqual(&test, rTM, 0.0007947795335239967);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.252507521140834e-06);
    AssertAlmostEqual(&test, rTM, 0.001054640598295539);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.305056476775878e-06);
    AssertAlmostEqual(&test, rTM, 5.305056476775878e-06);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.305056476775878e-06);
    AssertAlmostEqual(&test, rTM, 5.305056476775878e-06);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.305056476775878e-06);
    AssertAlmostEqual(&test, rTM, 5.305056476775878e-06);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.305056476775878e-06);
    AssertAlmostEqual(&test, rTM, 5.305056476775878e-06);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.305056476775878e-06);
    AssertAlmostEqual(&test, rTM, 5.305056476775879e-06);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.305056476775826e-06);
    AssertAlmostEqual(&test, rTM, 5.305056476775932e-06);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.305056476770573e-06);
    AssertAlmostEqual(&test, rTM, 5.305056476781183e-06);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.305056476245378e-06);
    AssertAlmostEqual(&test, rTM, 5.305056477306378e-06);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.305056423725877e-06);
    AssertAlmostEqual(&test, rTM, 5.30505652982588e-06);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.305051171780993e-06);
    AssertAlmostEqual(&test, rTM, 5.305061781770763e-06);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.304526029801031e-06);
    AssertAlmostEqual(&test, rTM, 5.305586923750727e-06);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.25253171690345e-06);
    AssertAlmostEqual(&test, rTM, 5.357581236648278e-06);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.652542310218713e-06);
    AssertAlmostEqual(&test, rTM, 7.957570643258394e-06);

    userdata[0] = 9/CAPS_HBAR_EV; /* 9eV */
    userdata[1] = 0.003/CAPS_HBAR_EV; /* 0.003eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999992391559757);
    AssertAlmostEqual(&test, rTM, 0.9999996195779155);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999945931998866);
    AssertAlmostEqual(&test, rTM, 0.9999999464671824);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999461989400409);
    AssertAlmostEqual(&test, rTM, 0.9999999946202872);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994621462589885);
    AssertAlmostEqual(&test, rTM, 0.999999999462002);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9946344708730185);
    AssertAlmostEqual(&test, rTM, 0.9999999999462);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9476279314102456);
    AssertAlmostEqual(&test, rTM, 0.9999999999946181);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5875978642776689);
    AssertAlmostEqual(&test, rTM, 0.9999999999994429);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03235004985670625);
    AssertAlmostEqual(&test, rTM, 0.9999999999998456);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003452537956011945);
    AssertAlmostEqual(&test, rTM, 0.9999999999998552);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.454899322095182e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999998552);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.454922956147686e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999998552);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.454923192490252e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999999998552);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.454923194853678e-12);
    AssertAlmostEqual(&test, rTM, 0.9999999999998552);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999982902115077);
    AssertAlmostEqual(&test, rTM, 0.9999983071400922);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999975939948671);
    AssertAlmostEqual(&test, rTM, 0.9999987969967099);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999829022466278);
    AssertAlmostEqual(&test, rTM, 0.9999998307138802);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998298755075329);
    AssertAlmostEqual(&test, rTM, 0.9999999829878048);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9983001411621621);
    AssertAlmostEqual(&test, rTM, 0.9999999982986957);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9831310603357747);
    AssertAlmostEqual(&test, rTM, 0.9999999998298634);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8437272969663203);
    AssertAlmostEqual(&test, rTM, 0.9999999999829255);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2136387602536146);
    AssertAlmostEqual(&test, rTM, 0.9999999999977665);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0034312344568131);
    AssertAlmostEqual(&test, rTM, 0.9999999999985428);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.454664238552903e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999985527);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.454900557753805e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999985528);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.454902921149906e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999999985528);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.454902944783888e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999999985528);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999829816068823);
    AssertAlmostEqual(&test, rTM, 0.9999829816239004);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999829807645007);
    AssertAlmostEqual(&test, rTM, 0.9999829824662395);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999828967358669);
    AssertAlmostEqual(&test, rTM, 0.999983066073682);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999759324545067);
    AssertAlmostEqual(&test, rTM, 0.9999879661548462);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998289805217495);
    AssertAlmostEqual(&test, rTM, 0.9999983065944579);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9982995096474669);
    AssertAlmostEqual(&test, rTM, 0.9999998298231673);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9831256612591359);
    AssertAlmostEqual(&test, rTM, 0.9999999829808631);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8436811982253846);
    AssertAlmostEqual(&test, rTM, 0.9999999982919968);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2135495532552839);
    AssertAlmostEqual(&test, rTM, 0.9999999997765397);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.003429038780814602);
    AssertAlmostEqual(&test, rTM, 0.9999999998541883);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.452438510242615e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999998551748);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.452674525028277e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999998551847);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.452676885379831e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999998551848);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999460267567601);
    AssertAlmostEqual(&test, rTM, 0.9999460267572999);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999460267300442);
    AssertAlmostEqual(&test, rTM, 0.9999460267840159);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999460240585082);
    AssertAlmostEqual(&test, rTM, 0.999946029455417);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999457575694294);
    AssertAlmostEqual(&test, rTM, 0.9999462946087757);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999236711610353);
    AssertAlmostEqual(&test, rTM, 0.9999618348522145);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994577080825822);
    AssertAlmostEqual(&test, rTM, 0.9999946293308868);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.994616808314157);
    AssertAlmostEqual(&test, rTM, 0.9999994602781699);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9474622571835808);
    AssertAlmostEqual(&test, rTM, 0.9999999460056771);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5866064804821879);
    AssertAlmostEqual(&test, rTM, 0.9999999944094308);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03215379477936359);
    AssertAlmostEqual(&test, rTM, 0.9999999984465813);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003430216538222817);
    AssertAlmostEqual(&test, rTM, 0.9999999985423662);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.432547461832081e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999985433559);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.432570791066745e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999985433659);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998244330749552);
    AssertAlmostEqual(&test, rTM, 0.9998244330749727);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998244330740862);
    AssertAlmostEqual(&test, rTM, 0.9998244330758417);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998244329871881);
    AssertAlmostEqual(&test, rTM, 0.9998244331627396);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998244242976078);
    AssertAlmostEqual(&test, rTM, 0.9998244418518812);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998235575012783);
    AssertAlmostEqual(&test, rTM, 0.9998253043041049);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997517199022041);
    AssertAlmostEqual(&test, rTM, 0.9998758522442911);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9982369755180639);
    AssertAlmostEqual(&test, rTM, 0.9999825290502342);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9825943726993231);
    AssertAlmostEqual(&test, rTM, 0.9999982441982849);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8391568333432935);
    AssertAlmostEqual(&test, rTM, 0.9999998237424322);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2050058335952501);
    AssertAlmostEqual(&test, rTM, 0.99999997663548);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.003222808670955041);
    AssertAlmostEqual(&test, rTM, 0.9999999844857437);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.243472104600304e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999845844214);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.243680412772783e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999845854114);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993089074904354);
    AssertAlmostEqual(&test, rTM, 0.9993089074904361);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993089074904012);
    AssertAlmostEqual(&test, rTM, 0.9993089074904703);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993089074869814);
    AssertAlmostEqual(&test, rTM, 0.99930890749389);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999308907145009);
    AssertAlmostEqual(&test, rTM, 0.9993089078358623);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993088729486187);
    AssertAlmostEqual(&test, rTM, 0.999308942030527);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993054618210242);
    AssertAlmostEqual(&test, rTM, 0.999312336071436);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9990227875268483);
    AssertAlmostEqual(&test, rTM, 0.9995112743078468);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9930762990414115);
    AssertAlmostEqual(&test, rTM, 0.9999312119099835);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.933212038741506);
    AssertAlmostEqual(&test, rTM, 0.9999930829268581);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5075012887044577);
    AssertAlmostEqual(&test, rTM, 0.9999992685325576);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02009088098292515);
    AssertAlmostEqual(&test, rTM, 0.9999997512313911);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002091441433130143);
    AssertAlmostEqual(&test, rTM, 0.9999997609304996);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.092307777783254e-06);
    AssertAlmostEqual(&test, rTM, 0.9999997610294786);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9953477971537275);
    AssertAlmostEqual(&test, rTM, 0.9953477971537276);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9953477971537252);
    AssertAlmostEqual(&test, rTM, 0.9953477971537298);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9953477971534954);
    AssertAlmostEqual(&test, rTM, 0.9953477971539596);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9953477971305207);
    AssertAlmostEqual(&test, rTM, 0.9953477971769343);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.99534779483305);
    AssertAlmostEqual(&test, rTM, 0.9953477994744039);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.99534756509175);
    AssertAlmostEqual(&test, rTM, 0.9953480292041569);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9953246483712984);
    AssertAlmostEqual(&test, rTM, 0.9953708315869146);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9934271424297529);
    AssertAlmostEqual(&test, rTM, 0.9967081441543246);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9542220208433122);
    AssertAlmostEqual(&test, rTM, 0.9995359908070622);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6298936466101799);
    AssertAlmostEqual(&test, rTM, 0.9999521223970265);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04219056680916572);
    AssertAlmostEqual(&test, rTM, 0.9999881702510452);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004594712972062421);
    AssertAlmostEqual(&test, rTM, 0.9999891180482);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.598895906878852e-06);
    AssertAlmostEqual(&test, rTM, 0.9999891279434443);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9571981531335489);
    AssertAlmostEqual(&test, rTM, 0.9571981531335489);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9571981531335487);
    AssertAlmostEqual(&test, rTM, 0.9571981531335492);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.957198153133528);
    AssertAlmostEqual(&test, rTM, 0.9571981531335698);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9571981531314556);
    AssertAlmostEqual(&test, rTM, 0.9571981531356423);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9571981529242198);
    AssertAlmostEqual(&test, rTM, 0.9571981533428781);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9571981322006464);
    AssertAlmostEqual(&test, rTM, 0.9571981740664414);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9571960598973979);
    AssertAlmostEqual(&test, rTM, 0.9572002462695732);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9569893677994442);
    AssertAlmostEqual(&test, rTM, 0.9574059470256642);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9400148247338356);
    AssertAlmostEqual(&test, rTM, 0.9695364464820946);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6464890590459139);
    AssertAlmostEqual(&test, rTM, 0.995554965793283);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04740756641532208);
    AssertAlmostEqual(&test, rTM, 0.9989488476069986);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005219428201418976);
    AssertAlmostEqual(&test, rTM, 0.9990429582056626);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.224831530711955e-06);
    AssertAlmostEqual(&test, rTM, 0.9990439462637515);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6497622236084672);
    AssertAlmostEqual(&test, rTM, 0.6497622236084672);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6497622236084672);
    AssertAlmostEqual(&test, rTM, 0.6497622236084672);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6497622236084659);
    AssertAlmostEqual(&test, rTM, 0.6497622236084687);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6497622236083294);
    AssertAlmostEqual(&test, rTM, 0.6497622236086052);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6497622235946731);
    AssertAlmostEqual(&test, rTM, 0.6497622236222614);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6497622222290487);
    AssertAlmostEqual(&test, rTM, 0.6497622249878859);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6497620856666539);
    AssertAlmostEqual(&test, rTM, 0.6497623615502379);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6497484299288544);
    AssertAlmostEqual(&test, rTM, 0.6497760168601756);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6483878468466403);
    AssertAlmostEqual(&test, rTM, 0.651132365195259);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5459695601473423);
    AssertAlmostEqual(&test, rTM, 0.7339114713876679);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04757399278880848);
    AssertAlmostEqual(&test, rTM, 0.9055385794777586);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005290849136973465);
    AssertAlmostEqual(&test, rTM, 0.9136608452687527);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.296920433309122e-06);
    AssertAlmostEqual(&test, rTM, 0.9137473461467146);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04806638756288564);
    AssertAlmostEqual(&test, rTM, 0.04806638756288564);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04806638756288564);
    AssertAlmostEqual(&test, rTM, 0.04806638756288564);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04806638756288564);
    AssertAlmostEqual(&test, rTM, 0.04806638756288565);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04806638756288521);
    AssertAlmostEqual(&test, rTM, 0.04806638756288608);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04806638756284198);
    AssertAlmostEqual(&test, rTM, 0.0480663875629293);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04806638755851989);
    AssertAlmostEqual(&test, rTM, 0.0480663875672514);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04806638712631015);
    AssertAlmostEqual(&test, rTM, 0.04806638799946113);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04806634390537612);
    AssertAlmostEqual(&test, rTM, 0.04806643122039498);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04806202220537206);
    AssertAlmostEqual(&test, rTM, 0.04807075291856304);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0476337506256096);
    AssertAlmostEqual(&test, rTM, 0.04849900646561993);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02520158155285049);
    AssertAlmostEqual(&test, rTM, 0.07088092977455081);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005246274147550295);
    AssertAlmostEqual(&test, rTM, 0.09539135652607138);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.303714356254747e-06);
    AssertAlmostEqual(&test, rTM, 0.09590592914482061);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005299412796678212);
    AssertAlmostEqual(&test, rTM, 0.0005299412796678212);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005299412796678212);
    AssertAlmostEqual(&test, rTM, 0.0005299412796678212);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005299412796678212);
    AssertAlmostEqual(&test, rTM, 0.0005299412796678212);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005299412796678212);
    AssertAlmostEqual(&test, rTM, 0.0005299412796678213);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005299412796678158);
    AssertAlmostEqual(&test, rTM, 0.0005299412796678265);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005299412796672917);
    AssertAlmostEqual(&test, rTM, 0.0005299412796683506);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005299412796148831);
    AssertAlmostEqual(&test, rTM, 0.0005299412797207592);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005299412743740222);
    AssertAlmostEqual(&test, rTM, 0.0005299412849616201);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005299407502884484);
    AssertAlmostEqual(&test, rTM, 0.000529941809047194);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005298883469653211);
    AssertAlmostEqual(&test, rTM, 0.0005299942123703183);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005246998395434839);
    AssertAlmostEqual(&test, rTM, 0.0005351827197630407);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002651110773074374);
    AssertAlmostEqual(&test, rTM, 0.0007947714076933034);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.252453753577551e-06);
    AssertAlmostEqual(&test, rTM, 0.001054629813798211);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.305051046153065e-06);
    AssertAlmostEqual(&test, rTM, 5.305051046153065e-06);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.305051046153065e-06);
    AssertAlmostEqual(&test, rTM, 5.305051046153065e-06);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.305051046153065e-06);
    AssertAlmostEqual(&test, rTM, 5.305051046153065e-06);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.305051046153065e-06);
    AssertAlmostEqual(&test, rTM, 5.305051046153065e-06);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.305051046153064e-06);
    AssertAlmostEqual(&test, rTM, 5.305051046153065e-06);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.305051046153011e-06);
    AssertAlmostEqual(&test, rTM, 5.305051046153117e-06);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.30505104614776e-06);
    AssertAlmostEqual(&test, rTM, 5.30505104615837e-06);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.305051045622565e-06);
    AssertAlmostEqual(&test, rTM, 5.305051046683564e-06);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.305050993103118e-06);
    AssertAlmostEqual(&test, rTM, 5.305051099203012e-06);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.30504574116361e-06);
    AssertAlmostEqual(&test, rTM, 5.305056351142519e-06);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.304520599721213e-06);
    AssertAlmostEqual(&test, rTM, 5.305581492584916e-06);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.252526340048049e-06);
    AssertAlmostEqual(&test, rTM, 5.357575752258051e-06);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.652539594878496e-06);
    AssertAlmostEqual(&test, rTM, 7.957562497352982e-06);

    userdata[0] = 9/CAPS_HBAR_EV; /* 9eV */
    userdata[1] = 0.035/CAPS_HBAR_EV; /* 0.035eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999974012260758);
    AssertAlmostEqual(&test, rTM, 0.9999987006121938);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999815323879132);
    AssertAlmostEqual(&test, rTM, 0.9999998171506839);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998162463919543);
    AssertAlmostEqual(&test, rTM, 0.9999999816247883);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9981640736657704);
    AssertAlmostEqual(&test, rTM, 0.999999998162387);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9817919348280644);
    AssertAlmostEqual(&test, rTM, 0.9999999998162309);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8323487721206164);
    AssertAlmostEqual(&test, rTM, 0.9999999999815464);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1929043073933913);
    AssertAlmostEqual(&test, rTM, 0.9999999999975044);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002943953926172628);
    AssertAlmostEqual(&test, rTM, 0.9999999999983016);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.961189121120322e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999983115);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.961362747795887e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999983116);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.961364484191172e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999999983116);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.961364501555138e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999999983116);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.961364501728777e-13);
    AssertAlmostEqual(&test, rTM, 0.9999999999983116);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999941599899461);
    AssertAlmostEqual(&test, rTM, 0.9999942178116608);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999917819763012);
    AssertAlmostEqual(&test, rTM, 0.9999958909797085);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999416014342033);
    AssertAlmostEqual(&test, rTM, 0.9999994217796613);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999419035362722);
    AssertAlmostEqual(&test, rTM, 0.9999999418924629);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9942058125368557);
    AssertAlmostEqual(&test, rTM, 0.9999999941889343);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9435534463955824);
    AssertAlmostEqual(&test, rTM, 0.9999999994186504);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5637050843130939);
    AssertAlmostEqual(&test, rTM, 0.9999999999394864);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02797965517909472);
    AssertAlmostEqual(&test, rTM, 0.9999999999821438);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002959610377229413);
    AssertAlmostEqual(&test, rTM, 0.9999999999831058);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.961345474764392e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999831157);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.961362838582938e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999831158);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.961363012222409e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999999831158);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.961363013958804e-12);
    AssertAlmostEqual(&test, rTM, 0.9999999999831158);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999418896121481);
    AssertAlmostEqual(&test, rTM, 0.9999418896702568);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999418867358415);
    AssertAlmostEqual(&test, rTM, 0.9999418925464181);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999415998206418);
    AssertAlmostEqual(&test, rTM, 0.999942178023522);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999178205315428);
    AssertAlmostEqual(&test, rTM, 0.9999589094215362);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994161516668741);
    AssertAlmostEqual(&test, rTM, 0.9999942176516521);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9942053669236705);
    AssertAlmostEqual(&test, rTM, 0.9999994189062972);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9435519048915033);
    AssertAlmostEqual(&test, rTM, 0.9999999418634581);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5636963911617985);
    AssertAlmostEqual(&test, rTM, 0.999999993948459);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02797819319293581);
    AssertAlmostEqual(&test, rTM, 0.9999999982142928);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002959446927014512);
    AssertAlmostEqual(&test, rTM, 0.9999999983104952);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.961181832867601e-06);
    AssertAlmostEqual(&test, rTM, 0.999999998311485);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.9611991947672e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999983114949);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.961199368387481e-10);
    AssertAlmostEqual(&test, rTM, 0.999999998311495);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998162043102592);
    AssertAlmostEqual(&test, rTM, 0.9998162043120969);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998162042192887);
    AssertAlmostEqual(&test, rTM, 0.9998162044030674);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999816195122468);
    AssertAlmostEqual(&test, rTM, 0.9998162134994288);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998152877034341);
    AssertAlmostEqual(&test, rTM, 0.9998171163708062);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997400835390667);
    AssertAlmostEqual(&test, rTM, 0.999870033323316);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9981544118763475);
    AssertAlmostEqual(&test, rTM, 0.9999817101241441);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9817859986105024);
    AssertAlmostEqual(&test, rTM, 0.9999981618901551);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8323061963054698);
    AssertAlmostEqual(&test, rTM, 0.99999981541285);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.19283148710176);
    AssertAlmostEqual(&test, rTM, 0.9999999750347829);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002942321300314044);
    AssertAlmostEqual(&test, rTM, 0.999999983006762);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.959537343045843e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999831054678);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.959710776073078e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999831064577);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.959712510531664e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999831064676);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994174458728482);
    AssertAlmostEqual(&test, rTM, 0.9994174458729064);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994174458699654);
    AssertAlmostEqual(&test, rTM, 0.9994174458757892);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994174455816851);
    AssertAlmostEqual(&test, rTM, 0.9994174461640692);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999417416754386);
    AssertAlmostEqual(&test, rTM, 0.9994174749899136);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994145411987656);
    AssertAlmostEqual(&test, rTM, 0.999420336140022);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999176243474536);
    AssertAlmostEqual(&test, rTM, 0.9995880368629796);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9941608204585314);
    AssertAlmostEqual(&test, rTM, 0.999942018243523);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9433979705817523);
    AssertAlmostEqual(&test, rTM, 0.9999941705969442);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5628290539205322);
    AssertAlmostEqual(&test, rTM, 0.9999993930461631);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02783276271270163);
    AssertAlmostEqual(&test, rTM, 0.9999998204947954);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002943192576017513);
    AssertAlmostEqual(&test, rTM, 0.9999998301164946);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.944908472920576e-06);
    AssertAlmostEqual(&test, rTM, 0.9999998302154652);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.94492564452019e-08);
    AssertAlmostEqual(&test, rTM, 0.9999998302164552);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9981135766246019);
    AssertAlmostEqual(&test, rTM, 0.9981135766246038);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9981135766245086);
    AssertAlmostEqual(&test, rTM, 0.9981135766246971);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9981135766151796);
    AssertAlmostEqual(&test, rTM, 0.9981135766340261);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9981135756822819);
    AssertAlmostEqual(&test, rTM, 0.9981135775669233);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9981134823948431);
    AssertAlmostEqual(&test, rTM, 0.9981136708496604);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.998104176897861);
    AssertAlmostEqual(&test, rTM, 0.9981229297901124);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9973332375457811);
    AssertAlmostEqual(&test, rTM, 0.9986657280386095);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9812029671204643);
    AssertAlmostEqual(&test, rTM, 0.9998121259216091);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.828158651177555);
    AssertAlmostEqual(&test, rTM, 0.9999810351206725);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1858933325891403);
    AssertAlmostEqual(&test, rTM, 0.9999974032404069);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002789173880503915);
    AssertAlmostEqual(&test, rTM, 0.9999982073716703);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.804640901299961e-05);
    AssertAlmostEqual(&test, rTM, 0.9999982172437549);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.804796655030472e-07);
    AssertAlmostEqual(&test, rTM, 0.9999982173427518);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9927724383767581);
    AssertAlmostEqual(&test, rTM, 0.9927724383767581);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9927724383767546);
    AssertAlmostEqual(&test, rTM, 0.9927724383767617);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9927724383763981);
    AssertAlmostEqual(&test, rTM, 0.9927724383771181);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9927724383407514);
    AssertAlmostEqual(&test, rTM, 0.9927724384127649);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.992772434776085);
    AssertAlmostEqual(&test, rTM, 0.9927724419774294);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9927720783184213);
    AssertAlmostEqual(&test, rTM, 0.9927727984172238);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9927365218568595);
    AssertAlmostEqual(&test, rTM, 0.9928081779372502);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9897940282975456);
    AssertAlmostEqual(&test, rTM, 0.9948838934846287);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.929708776987954);
    AssertAlmostEqual(&test, rTM, 0.9992780085544789);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.491454111563863);
    AssertAlmostEqual(&test, rTM, 0.9999228455143616);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01831512432739699);
    AssertAlmostEqual(&test, rTM, 0.9999727100742368);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001899770209873962);
    AssertAlmostEqual(&test, rTM, 0.9999736817212042);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.900485036099028e-06);
    AssertAlmostEqual(&test, rTM, 0.9999736916189138);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9539531861422705);
    AssertAlmostEqual(&test, rTM, 0.9539531861422705);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9539531861422703);
    AssertAlmostEqual(&test, rTM, 0.9539531861422708);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9539531861422481);
    AssertAlmostEqual(&test, rTM, 0.953953186142293);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9539531861400224);
    AssertAlmostEqual(&test, rTM, 0.9539531861445186);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9539531859174621);
    AssertAlmostEqual(&test, rTM, 0.9539531863670789);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9539531636614386);
    AssertAlmostEqual(&test, rTM, 0.9539532086230919);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9539509381173624);
    AssertAlmostEqual(&test, rTM, 0.9539554340600206);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9537289636582806);
    AssertAlmostEqual(&test, rTM, 0.9541763475622249);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9355124557746431);
    AssertAlmostEqual(&test, rTM, 0.967209977718347);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6253283719407891);
    AssertAlmostEqual(&test, rTM, 0.9951933095959544);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04134378640058592);
    AssertAlmostEqual(&test, rTM, 0.9987942141485766);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004495074905241446);
    AssertAlmostEqual(&test, rTM, 0.998888908163135);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.499082741703323e-06);
    AssertAlmostEqual(&test, rTM, 0.9988898960650453);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6475197908212054);
    AssertAlmostEqual(&test, rTM, 0.6475197908212054);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6475197908212054);
    AssertAlmostEqual(&test, rTM, 0.6475197908212055);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.647519790821204);
    AssertAlmostEqual(&test, rTM, 0.6475197908212068);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6475197908210669);
    AssertAlmostEqual(&test, rTM, 0.6475197908213439);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.647519790807352);
    AssertAlmostEqual(&test, rTM, 0.6475197908350588);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.647519789435863);
    AssertAlmostEqual(&test, rTM, 0.6475197922065479);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6475196522870109);
    AssertAlmostEqual(&test, rTM, 0.6475199293553572);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6475059379070023);
    AssertAlmostEqual(&test, rTM, 0.6475336433074649);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6461395256715455);
    AssertAlmostEqual(&test, rTM, 0.6488958204388483);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.543365113860622);
    AssertAlmostEqual(&test, rTM, 0.7320422792675797);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.046877028213052);
    AssertAlmostEqual(&test, rTM, 0.9042625712868833);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005205804520887136);
    AssertAlmostEqual(&test, rTM, 0.9123739598042784);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.211690423630435e-06);
    AssertAlmostEqual(&test, rTM, 0.9124602814951488);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04799499868378428);
    AssertAlmostEqual(&test, rTM, 0.04799499868378428);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04799499868378428);
    AssertAlmostEqual(&test, rTM, 0.04799499868378428);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04799499868378428);
    AssertAlmostEqual(&test, rTM, 0.04799499868378428);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04799499868378385);
    AssertAlmostEqual(&test, rTM, 0.04799499868378471);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04799499868374068);
    AssertAlmostEqual(&test, rTM, 0.04799499868382788);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04799499867942439);
    AssertAlmostEqual(&test, rTM, 0.04799499868814418);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04799499824779481);
    AssertAlmostEqual(&test, rTM, 0.04799499911977375);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04799495508487661);
    AssertAlmostEqual(&test, rTM, 0.04799504228269177);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04799063918598159);
    AssertAlmostEqual(&test, rTM, 0.04799935817975846);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04756294301005607);
    AssertAlmostEqual(&test, rTM, 0.04842703639823287);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02516240056380462);
    AssertAlmostEqual(&test, rTM, 0.07077754897857744);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005237705671092441);
    AssertAlmostEqual(&test, rTM, 0.09525039797649366);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.295043078557638e-06);
    AssertAlmostEqual(&test, rTM, 0.09576414418968789);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005298545885475202);
    AssertAlmostEqual(&test, rTM, 0.0005298545885475202);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005298545885475202);
    AssertAlmostEqual(&test, rTM, 0.0005298545885475202);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005298545885475202);
    AssertAlmostEqual(&test, rTM, 0.0005298545885475202);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005298545885475201);
    AssertAlmostEqual(&test, rTM, 0.0005298545885475202);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005298545885475149);
    AssertAlmostEqual(&test, rTM, 0.0005298545885475256);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005298545885469909);
    AssertAlmostEqual(&test, rTM, 0.0005298545885480496);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005298545884945909);
    AssertAlmostEqual(&test, rTM, 0.0005298545886004496);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005298545832545863);
    AssertAlmostEqual(&test, rTM, 0.0005298545938404541);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005298540592546549);
    AssertAlmostEqual(&test, rTM, 0.0005298551178403856);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005298016644949086);
    AssertAlmostEqual(&test, rTM, 0.0005299075126001288);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005246140049512102);
    AssertAlmostEqual(&test, rTM, 0.0005350951721147267);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002650676858007196);
    AssertAlmostEqual(&test, rTM, 0.000794641416995881);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.251593622247791e-06);
    AssertAlmostEqual(&test, rTM, 0.001054457291832109);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.304964157700106e-06);
    AssertAlmostEqual(&test, rTM, 5.304964157700106e-06);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.304964157700106e-06);
    AssertAlmostEqual(&test, rTM, 5.304964157700106e-06);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.304964157700106e-06);
    AssertAlmostEqual(&test, rTM, 5.304964157700106e-06);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.304964157700106e-06);
    AssertAlmostEqual(&test, rTM, 5.304964157700106e-06);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.304964157700106e-06);
    AssertAlmostEqual(&test, rTM, 5.304964157700107e-06);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.304964157700054e-06);
    AssertAlmostEqual(&test, rTM, 5.304964157700159e-06);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.304964157694801e-06);
    AssertAlmostEqual(&test, rTM, 5.304964157705411e-06);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.304964157169615e-06);
    AssertAlmostEqual(&test, rTM, 5.304964158230597e-06);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.304964104651028e-06);
    AssertAlmostEqual(&test, rTM, 5.304964210749184e-06);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.304958852797539e-06);
    AssertAlmostEqual(&test, rTM, 5.304969462602675e-06);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.304433719956047e-06);
    AssertAlmostEqual(&test, rTM, 5.305494595444166e-06);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.252440311858729e-06);
    AssertAlmostEqual(&test, rTM, 5.357488003541455e-06);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.652496150191072e-06);
    AssertAlmostEqual(&test, rTM, 7.957432165134494e-06);

    userdata[0] = 9/CAPS_HBAR_EV; /* 9eV */
    userdata[1] = 0.05/CAPS_HBAR_EV; /* 0.05eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999968938718706);
    AssertAlmostEqual(&test, rTM, 0.9999984469347293);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999977927021664);
    AssertAlmostEqual(&test, rTM, 0.999999781453272);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997803763722162);
    AssertAlmostEqual(&test, rTM, 0.9999999780374215);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9978060419206679);
    AssertAlmostEqual(&test, rTM, 0.9999999978036321);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9782762003161827);
    AssertAlmostEqual(&test, rTM, 0.99999999978035);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8031629383790235);
    AssertAlmostEqual(&test, rTM, 0.9999999999779042);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1498306850997279);
    AssertAlmostEqual(&test, rTM, 0.9999999999967378);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002064405181527475);
    AssertAlmostEqual(&test, rTM, 0.999999999997578);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.072869247515232e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999975879);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.072954326497459e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999975879);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.072955177331368e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999999975879);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.072955185839711e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999999975879);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.072955185924795e-13);
    AssertAlmostEqual(&test, rTM, 0.9999999999975879);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999930198574685);
    AssertAlmostEqual(&test, rTM, 0.9999930889675518);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999990177591665);
    AssertAlmostEqual(&test, rTM, 0.9999950887837724);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999302007671657);
    AssertAlmostEqual(&test, rTM, 0.9999993088946054);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993056538918804);
    AssertAlmostEqual(&test, rTM, 0.9999999305482142);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9930785491806664);
    AssertAlmostEqual(&test, rTM, 0.999999993054436);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9329148902996839);
    AssertAlmostEqual(&test, rTM, 0.9999999993050287);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5059591602636867);
    AssertAlmostEqual(&test, rTM, 0.9999999999264757);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0199122212081993);
    AssertAlmostEqual(&test, rTM, 0.9999999999748997);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002072095474020289);
    AssertAlmostEqual(&test, rTM, 0.9999999999758699);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.072945862690145e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999758797);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.072954370983169e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999758798);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.07295445606654e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999999758798);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.072954456917374e-12);
    AssertAlmostEqual(&test, rTM, 0.9999999999758798);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999305457774328);
    AssertAlmostEqual(&test, rTM, 0.9999305458468845);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999305423396566);
    AssertAlmostEqual(&test, rTM, 0.999930549284487);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999930199417173);
    AssertAlmostEqual(&test, rTM, 0.999930890488171);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999901778358513);
    AssertAlmostEqual(&test, rTM, 0.9999508879732313);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993022133904064);
    AssertAlmostEqual(&test, rTM, 0.999993088833468);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9930780743528436);
    AssertAlmostEqual(&test, rTM, 0.99999930546478);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9329136057349519);
    AssertAlmostEqual(&test, rTM, 0.9999999305015657);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5059527378399107);
    AssertAlmostEqual(&test, rTM, 0.9999999926474178);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01991148102885595);
    AssertAlmostEqual(&test, rTM, 0.9999999974898816);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002072015353619378);
    AssertAlmostEqual(&test, rTM, 0.9999999975868906);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.072865676519608e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999975878804);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.072874184154424e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999975878903);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.072874269231213e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999975878904);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997803444570279);
    AssertAlmostEqual(&test, rTM, 0.9997803444592243);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997803443483104);
    AssertAlmostEqual(&test, rTM, 0.9997803445679417);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997803334768299);
    AssertAlmostEqual(&test, rTM, 0.9997803554388733);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997792490334024);
    AssertAlmostEqual(&test, rTM, 0.9997814344476564);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996893742865374);
    AssertAlmostEqual(&test, rTM, 0.9998446750794164);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9977946823810605);
    AssertAlmostEqual(&test, rTM, 0.9999781412816791);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9782709291799957);
    AssertAlmostEqual(&test, rTM, 0.9999978031830478);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8031285995605125);
    AssertAlmostEqual(&test, rTM, 0.9999997789992447);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1497874131234588);
    AssertAlmostEqual(&test, rTM, 0.9999999673682964);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002063602238708105);
    AssertAlmostEqual(&test, rTM, 0.9999999757706282);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.072059712006663e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999758694219);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.072144724549646e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999758704119);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.072145574719111e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999758704218);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993043340257006);
    AssertAlmostEqual(&test, rTM, 0.9993043340257702);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993043340222583);
    AssertAlmostEqual(&test, rTM, 0.9993043340292126);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993043336780235);
    AssertAlmostEqual(&test, rTM, 0.9993043343734471);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993042992554095);
    AssertAlmostEqual(&test, rTM, 0.9993043687943242);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999300865561788);
    AssertAlmostEqual(&test, rTM, 0.9993077852883031);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9990163215294222);
    AssertAlmostEqual(&test, rTM, 0.9995080397224945);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9930306241765293);
    AssertAlmostEqual(&test, rTM, 0.9999307565407454);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9327852742583903);
    AssertAlmostEqual(&test, rTM, 0.9999930370805649);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5053115991418426);
    AssertAlmostEqual(&test, rTM, 0.9999992631684292);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01983774006533499);
    AssertAlmostEqual(&test, rTM, 0.9999997480544145);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002064034482453416);
    AssertAlmostEqual(&test, rTM, 0.9999997577560541);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.064878266726849e-06);
    AssertAlmostEqual(&test, rTM, 0.9999997578550334);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.064886708924674e-08);
    AssertAlmostEqual(&test, rTM, 0.9999997578560234);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9977636372715549);
    AssertAlmostEqual(&test, rTM, 0.9977636372715571);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9977636372714443);
    AssertAlmostEqual(&test, rTM, 0.9977636372716677);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9977636372603867);
    AssertAlmostEqual(&test, rTM, 0.9977636372827253);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9977636361546267);
    AssertAlmostEqual(&test, rTM, 0.9977636383884848);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.997763525581391);
    AssertAlmostEqual(&test, rTM, 0.9977637489561495);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9977524958219377);
    AssertAlmostEqual(&test, rTM, 0.9977747235516973);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9968387716506792);
    AssertAlmostEqual(&test, rTM, 0.9984181336860314);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9777513680119505);
    AssertAlmostEqual(&test, rTM, 0.999777235344922);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7997685533950543);
    AssertAlmostEqual(&test, rTM, 0.99997747287538);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1456259683301891);
    AssertAlmostEqual(&test, rTM, 0.9999966393726388);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001987080691467428);
    AssertAlmostEqual(&test, rTM, 0.9999974837621477);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.994921694353915e-05);
    AssertAlmostEqual(&test, rTM, 0.9999974936422417);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.995000495178947e-07);
    AssertAlmostEqual(&test, rTM, 0.9999974937412393);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9918426254093903);
    AssertAlmostEqual(&test, rTM, 0.9918426254093904);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9918426254093863);
    AssertAlmostEqual(&test, rTM, 0.9918426254093944);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9918426254089842);
    AssertAlmostEqual(&test, rTM, 0.9918426254097965);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9918426253687705);
    AssertAlmostEqual(&test, rTM, 0.9918426254500102);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9918426213474079);
    AssertAlmostEqual(&test, rTM, 0.9918426294713708);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9918422192212806);
    AssertAlmostEqual(&test, rTM, 0.9918430315773582);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9918021074489485);
    AssertAlmostEqual(&test, rTM, 0.9918829439265267);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9884832832961092);
    AssertAlmostEqual(&test, rTM, 0.9942249178501681);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9210013199944519);
    AssertAlmostEqual(&test, rTM, 0.9991846360580643);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4503188859345547);
    AssertAlmostEqual(&test, rTM, 0.9999114977664266);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01447688590857679);
    AssertAlmostEqual(&test, rTM, 0.9999654706337798);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001490090052469471);
    AssertAlmostEqual(&test, rTM, 0.9999664461078293);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.490529796806757e-06);
    AssertAlmostEqual(&test, rTM, 0.9999664560058411);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9525136017943386);
    AssertAlmostEqual(&test, rTM, 0.9525136017943386);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9525136017943384);
    AssertAlmostEqual(&test, rTM, 0.9525136017943389);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9525136017943154);
    AssertAlmostEqual(&test, rTM, 0.9525136017943618);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.952513601792022);
    AssertAlmostEqual(&test, rTM, 0.9525136017966552);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9525136015626812);
    AssertAlmostEqual(&test, rTM, 0.9525136020259961);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9525135786285956);
    AssertAlmostEqual(&test, rTM, 0.9525136249600706);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9525112852801925);
    AssertAlmostEqual(&test, rTM, 0.9525159181982327);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9522825489388339);
    AssertAlmostEqual(&test, rTM, 0.9527435629488531);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9335171268344672);
    AssertAlmostEqual(&test, rTM, 0.9661770724726541);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6161661703925715);
    AssertAlmostEqual(&test, rTM, 0.9950312997160818);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03900593641534938);
    AssertAlmostEqual(&test, rTM, 0.9987217965166901);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004220516717823637);
    AssertAlmostEqual(&test, rTM, 0.9988167135651762);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.224050023155652e-06);
    AssertAlmostEqual(&test, rTM, 0.9988177013874124);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.64647778941992);
    AssertAlmostEqual(&test, rTM, 0.64647778941992);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.64647778941992);
    AssertAlmostEqual(&test, rTM, 0.64647778941992);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6464777894199185);
    AssertAlmostEqual(&test, rTM, 0.6464777894199213);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6464777894197812);
    AssertAlmostEqual(&test, rTM, 0.6464777894200587);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6464777894060392);
    AssertAlmostEqual(&test, rTM, 0.6464777894338007);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6464777880318402);
    AssertAlmostEqual(&test, rTM, 0.6464777908079997);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6464776506119905);
    AssertAlmostEqual(&test, rTM, 0.6464779282278066);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6464639091338623);
    AssertAlmostEqual(&test, rTM, 0.6464916692780261);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.645094803384556);
    AssertAlmostEqual(&test, rTM, 0.6478565398597425);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5421563671148341);
    AssertAlmostEqual(&test, rTM, 0.731172747002656);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04655732305646409);
    AssertAlmostEqual(&test, rTM, 0.9036657363737759);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000516687396610384);
    AssertAlmostEqual(&test, rTM, 0.9117719793391371);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.172675959854364e-06);
    AssertAlmostEqual(&test, rTM, 0.9118582172574832);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04796160826174514);
    AssertAlmostEqual(&test, rTM, 0.04796160826174514);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04796160826174514);
    AssertAlmostEqual(&test, rTM, 0.04796160826174514);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04796160826174514);
    AssertAlmostEqual(&test, rTM, 0.04796160826174515);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04796160826174471);
    AssertAlmostEqual(&test, rTM, 0.04796160826174558);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04796160826170157);
    AssertAlmostEqual(&test, rTM, 0.04796160826178872);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04796160825738799);
    AssertAlmostEqual(&test, rTM, 0.0479616082661023);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04796160782602983);
    AssertAlmostEqual(&test, rTM, 0.04796160869746046);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04796156469025316);
    AssertAlmostEqual(&test, rTM, 0.04796165183323695);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04795725150528833);
    AssertAlmostEqual(&test, rTM, 0.04796596501637702);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04752982451977488);
    AssertAlmostEqual(&test, rTM, 0.04839337407957071);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02514407640958881);
    AssertAlmostEqual(&test, rTM, 0.07072919310016067);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005233698825244487);
    AssertAlmostEqual(&test, rTM, 0.09518446696176948);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.29098817023351e-06);
    AssertAlmostEqual(&test, rTM, 0.09569782670454942);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005298139618477481);
    AssertAlmostEqual(&test, rTM, 0.0005298139618477481);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005298139618477481);
    AssertAlmostEqual(&test, rTM, 0.0005298139618477481);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005298139618477481);
    AssertAlmostEqual(&test, rTM, 0.0005298139618477481);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005298139618477481);
    AssertAlmostEqual(&test, rTM, 0.0005298139618477482);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005298139618477428);
    AssertAlmostEqual(&test, rTM, 0.0005298139618477534);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005298139618472189);
    AssertAlmostEqual(&test, rTM, 0.0005298139618482774);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005298139617948229);
    AssertAlmostEqual(&test, rTM, 0.0005298139619006734);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005298139565552197);
    AssertAlmostEqual(&test, rTM, 0.0005298139671402766);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005298134325954234);
    AssertAlmostEqual(&test, rTM, 0.0005298144911000729);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005297610418487987);
    AssertAlmostEqual(&test, rTM, 0.0005298668818466947);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005245737796525928);
    AssertAlmostEqual(&test, rTM, 0.0005350541440138066);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002650473509211417);
    AssertAlmostEqual(&test, rTM, 0.0007945804984929979);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.251190532653778e-06);
    AssertAlmostEqual(&test, rTM, 0.001054376441589238);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.304923429717544e-06);
    AssertAlmostEqual(&test, rTM, 5.304923429717544e-06);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.304923429717544e-06);
    AssertAlmostEqual(&test, rTM, 5.304923429717544e-06);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.304923429717544e-06);
    AssertAlmostEqual(&test, rTM, 5.304923429717544e-06);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.304923429717544e-06);
    AssertAlmostEqual(&test, rTM, 5.304923429717544e-06);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.304923429717543e-06);
    AssertAlmostEqual(&test, rTM, 5.304923429717544e-06);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.30492342971749e-06);
    AssertAlmostEqual(&test, rTM, 5.304923429717597e-06);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.304923429712239e-06);
    AssertAlmostEqual(&test, rTM, 5.304923429722849e-06);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.304923429187057e-06);
    AssertAlmostEqual(&test, rTM, 5.30492343024803e-06);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.304923376668873e-06);
    AssertAlmostEqual(&test, rTM, 5.304923482766214e-06);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.304918124855703e-06);
    AssertAlmostEqual(&test, rTM, 5.304928734579384e-06);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.304392996045789e-06);
    AssertAlmostEqual(&test, rTM, 5.305453863389298e-06);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.252399987115047e-06);
    AssertAlmostEqual(&test, rTM, 5.357446872320011e-06);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.652475785983731e-06);
    AssertAlmostEqual(&test, rTM, 7.957371073376711e-06);

    userdata[0] = 9/CAPS_HBAR_EV; /* 9eV */
    userdata[1] = 0.1/CAPS_HBAR_EV; /* 0.1eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999956072743417);
    AssertAlmostEqual(&test, rTM, 0.9999978036347589);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999687842376839);
    AssertAlmostEqual(&test, rTM, 0.9999996909282701);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996894194188032);
    AssertAlmostEqual(&test, rTM, 0.9999999689402238);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9968986858135369);
    AssertAlmostEqual(&test, rTM, 0.9999999968938649);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9694173279111803);
    AssertAlmostEqual(&test, rTM, 0.9999999996893493);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7339033163504516);
    AssertAlmostEqual(&test, rTM, 0.9999999999685663);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.08649345623560858);
    AssertAlmostEqual(&test, rTM, 0.9999999999942625);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.00103433459278638);
    AssertAlmostEqual(&test, rTM, 0.999999999995166);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.036456128052693e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999951759);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.036477398355713e-07);
    AssertAlmostEqual(&test, rTM, 0.999999999995176);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.036477611064254e-09);
    AssertAlmostEqual(&test, rTM, 0.999999999995176);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.03647761319134e-11);
    AssertAlmostEqual(&test, rTM, 0.999999999995176);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.036477613212611e-13);
    AssertAlmostEqual(&test, rTM, 0.999999999995176);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999901286029994);
    AssertAlmostEqual(&test, rTM, 0.9999902263391258);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999861090465327);
    AssertAlmostEqual(&test, rTM, 0.9999930544991463);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999012904149202);
    AssertAlmostEqual(&test, rTM, 0.9999990226296128);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9990181876603149);
    AssertAlmostEqual(&test, rTM, 0.9999999017803477);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.990225661379425);
    AssertAlmostEqual(&test, rTM, 0.9999999901774309);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9064810868665631);
    AssertAlmostEqual(&test, rTM, 0.9999999990165706);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3880909843262133);
    AssertAlmostEqual(&test, rTM, 0.9999999998905688);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01015532787299693);
    AssertAlmostEqual(&test, rTM, 0.9999999999507698);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001036262629527356);
    AssertAlmostEqual(&test, rTM, 0.9999999999517497);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.036475282397503e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999517596);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.036477409477156e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999517597);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.036477430748008e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999999517597);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.036477430960717e-12);
    AssertAlmostEqual(&test, rTM, 0.9999999999517597);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999017792688192);
    AssertAlmostEqual(&test, rTM, 0.9999017793670351);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999901774407257);
    AssertAlmostEqual(&test, rTM, 0.9999017842283517);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999012894603541);
    AssertAlmostEqual(&test, rTM, 0.9999022667446684);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998610978050465);
    AssertAlmostEqual(&test, rTM, 0.9999305464905445);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9990133329974628);
    AssertAlmostEqual(&test, rTM, 0.9999902262434388);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9902250858710647);
    AssertAlmostEqual(&test, rTM, 0.9999990177826862);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9064801827953139);
    AssertAlmostEqual(&test, rTM, 0.9999999016561564);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3880876736207139);
    AssertAlmostEqual(&test, rTM, 0.9999999890567519);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01015513540122964);
    AssertAlmostEqual(&test, rTM, 0.9999999950768905);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001036242590729952);
    AssertAlmostEqual(&test, rTM, 0.9999999951748751);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.036455235376188e-06);
    AssertAlmostEqual(&test, rTM, 0.999999995175865);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.036457362373571e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999951758749);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.0364573836436e-10);
    AssertAlmostEqual(&test, rTM, 0.999999995175875);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999689404613879);
    AssertAlmostEqual(&test, rTM, 0.9996894046169845);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996894044601583);
    AssertAlmostEqual(&test, rTM, 0.9996894047707052);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996893890884629);
    AssertAlmostEqual(&test, rTM, 0.9996894201416245);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996878557434706);
    AssertAlmostEqual(&test, rTM, 0.9996909458030178);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995607800534729);
    AssertAlmostEqual(&test, rTM, 0.99978036590452);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.996882939569972);
    AssertAlmostEqual(&test, rTM, 0.9999690902442713);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9694128818869742);
    AssertAlmostEqual(&test, rTM, 0.9999968933491973);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7338812024991943);
    AssertAlmostEqual(&test, rTM, 0.999999685631793);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.08647925128210518);
    AssertAlmostEqual(&test, rTM, 0.9999999426150631);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001034132988456527);
    AssertAlmostEqual(&test, rTM, 0.9999999516503731);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.036253696248854e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999517492697);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.036274958244978e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999517502597);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.036275170870448e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999517502697);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9990172787068696);
    AssertAlmostEqual(&test, rTM, 0.9990172787069678);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9990172787020075);
    AssertAlmostEqual(&test, rTM, 0.9990172787118299);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9990172782157998);
    AssertAlmostEqual(&test, rTM, 0.9990172791980374);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9990172295962384);
    AssertAlmostEqual(&test, rTM, 0.9990173278151461);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9990123797449763);
    AssertAlmostEqual(&test, rTM, 0.999022153380084);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9986105051885493);
    AssertAlmostEqual(&test, rTM, 0.999305011005531);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9901676141747552);
    AssertAlmostEqual(&test, rTM, 0.9999021711088545);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9063898181062138);
    AssertAlmostEqual(&test, rTM, 0.9999901566230801);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3877569381855638);
    AssertAlmostEqual(&test, rTM, 0.9999989044128514);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01013592500194336);
    AssertAlmostEqual(&test, rTM, 0.9999995067560363);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001034242617201728);
    AssertAlmostEqual(&test, rTM, 0.9999995165546801);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.034454441860228e-06);
    AssertAlmostEqual(&test, rTM, 0.9999995166536697);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.03445656065455e-08);
    AssertAlmostEqual(&test, rTM, 0.9999995166546597);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9968685855408209);
    AssertAlmostEqual(&test, rTM, 0.996868585540824);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9968685855406662);
    AssertAlmostEqual(&test, rTM, 0.9968685855409788);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9968685855251899);
    AssertAlmostEqual(&test, rTM, 0.996868585556455);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9968685839775708);
    AssertAlmostEqual(&test, rTM, 0.9968685871040732);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.996868429219548);
    AssertAlmostEqual(&test, rTM, 0.9968687418543059);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9968529920305231);
    AssertAlmostEqual(&test, rTM, 0.9968841019054197);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9955743868101339);
    AssertAlmostEqual(&test, rTM, 0.9977847369952138);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9689731169667043);
    AssertAlmostEqual(&test, rTM, 0.9996879343264793);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7317056560605977);
    AssertAlmostEqual(&test, rTM, 0.9999682555507806);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.08509571538742057);
    AssertAlmostEqual(&test, rTM, 0.9999941668485589);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001014553896312754);
    AssertAlmostEqual(&test, rTM, 0.9999950717549798);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.016595013114728e-05);
    AssertAlmostEqual(&test, rTM, 0.9999950816447623);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.016615476137539e-07);
    AssertAlmostEqual(&test, rTM, 0.9999950817437605);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9893183136193887);
    AssertAlmostEqual(&test, rTM, 0.9893183136193888);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9893183136193834);
    AssertAlmostEqual(&test, rTM, 0.989318313619394);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9893183136188575);
    AssertAlmostEqual(&test, rTM, 0.98931831361992);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9893183135662671);
    AssertAlmostEqual(&test, rTM, 0.9893183136725103);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9893183083072247);
    AssertAlmostEqual(&test, rTM, 0.9893183189315502);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9893177824162693);
    AssertAlmostEqual(&test, rTM, 0.9893188447962343);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9892653255323096);
    AssertAlmostEqual(&test, rTM, 0.9893710415462555);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9849273747849693);
    AssertAlmostEqual(&test, rTM, 0.9924349646937709);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8977395577795415);
    AssertAlmostEqual(&test, rTM, 0.9989304583206781);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.357688263811198);
    AssertAlmostEqual(&test, rTM, 0.9998781210175898);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.008523555052732439);
    AssertAlmostEqual(&test, rTM, 0.9999413467626095);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.669241381917641e-05);
    AssertAlmostEqual(&test, rTM, 0.9999423281535497);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.670729741835953e-07);
    AssertAlmostEqual(&test, rTM, 0.9999423380518264);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9480225528788974);
    AssertAlmostEqual(&test, rTM, 0.9480225528788974);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9480225528788971);
    AssertAlmostEqual(&test, rTM, 0.9480225528788976);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.948022552878872);
    AssertAlmostEqual(&test, rTM, 0.9480225528789227);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9480225528763678);
    AssertAlmostEqual(&test, rTM, 0.9480225528814269);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9480225526259445);
    AssertAlmostEqual(&test, rTM, 0.9480225531318502);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9480225275836157);
    AssertAlmostEqual(&test, rTM, 0.948022578174167);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9480200234167209);
    AssertAlmostEqual(&test, rTM, 0.9480250822212688);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9477702632602898);
    AssertAlmostEqual(&test, rTM, 0.9482736562055492);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9273005915617143);
    AssertAlmostEqual(&test, rTM, 0.9629515462756937);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5884510705823693);
    AssertAlmostEqual(&test, rTM, 0.9945193439538809);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03282151370147145);
    AssertAlmostEqual(&test, rTM, 0.9984806405789011);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003506579691078988);
    AssertAlmostEqual(&test, rTM, 0.9985761402762813);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.509019052818482e-06);
    AssertAlmostEqual(&test, rTM, 0.9985771278129628);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6430455276413152);
    AssertAlmostEqual(&test, rTM, 0.6430455276413152);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6430455276413152);
    AssertAlmostEqual(&test, rTM, 0.6430455276413152);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6430455276413137);
    AssertAlmostEqual(&test, rTM, 0.6430455276413165);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6430455276411754);
    AssertAlmostEqual(&test, rTM, 0.6430455276414548);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6430455276273449);
    AssertAlmostEqual(&test, rTM, 0.6430455276552854);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6430455262442877);
    AssertAlmostEqual(&test, rTM, 0.6430455290383427);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6430453879386179);
    AssertAlmostEqual(&test, rTM, 0.6430456673439696);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6430315578838778);
    AssertAlmostEqual(&test, rTM, 0.6430594969708215);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6416536481701326);
    AssertAlmostEqual(&test, rTM, 0.6444331717652517);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5381814847093561);
    AssertAlmostEqual(&test, rTM, 0.7283042220244317);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04552249795949855);
    AssertAlmostEqual(&test, rTM, 0.9016822137582786);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005041208445931847);
    AssertAlmostEqual(&test, rTM, 0.9097711023370536);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.046743691602073e-06);
    AssertAlmostEqual(&test, rTM, 0.9098570620308043);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04785064239026648);
    AssertAlmostEqual(&test, rTM, 0.04785064239026648);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04785064239026648);
    AssertAlmostEqual(&test, rTM, 0.04785064239026648);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04785064239026648);
    AssertAlmostEqual(&test, rTM, 0.04785064239026648);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04785064239026605);
    AssertAlmostEqual(&test, rTM, 0.04785064239026691);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.047850642390223);
    AssertAlmostEqual(&test, rTM, 0.04785064239030996);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04785064238591844);
    AssertAlmostEqual(&test, rTM, 0.04785064239461452);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04785064195546255);
    AssertAlmostEqual(&test, rTM, 0.04785064282507041);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04785059890991243);
    AssertAlmostEqual(&test, rTM, 0.04785068587062034);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04784629474686531);
    AssertAlmostEqual(&test, rTM, 0.04785499003185455);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04741976262868643);
    AssertAlmostEqual(&test, rTM, 0.04828150434415813);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02508318830083367);
    AssertAlmostEqual(&test, rTM, 0.07056848355452852);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005220386835471997);
    AssertAlmostEqual(&test, rTM, 0.09496535459011782);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.277516548149532e-06);
    AssertAlmostEqual(&test, rTM, 0.0954774302602116);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005296785844989985);
    AssertAlmostEqual(&test, rTM, 0.0005296785844989985);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005296785844989985);
    AssertAlmostEqual(&test, rTM, 0.0005296785844989985);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005296785844989985);
    AssertAlmostEqual(&test, rTM, 0.0005296785844989985);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005296785844989984);
    AssertAlmostEqual(&test, rTM, 0.0005296785844989985);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005296785844989932);
    AssertAlmostEqual(&test, rTM, 0.0005296785844990037);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005296785844984693);
    AssertAlmostEqual(&test, rTM, 0.0005296785844995276);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005296785844460867);
    AssertAlmostEqual(&test, rTM, 0.0005296785845519102);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005296785792078208);
    AssertAlmostEqual(&test, rTM, 0.000529678589790176);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005296780553817642);
    AssertAlmostEqual(&test, rTM, 0.0005296791136162327);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005296256780077725);
    AssertAlmostEqual(&test, rTM, 0.0005297314909902214);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005244397398637079);
    AssertAlmostEqual(&test, rTM, 0.0005349174291052145);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002649795905168842);
    AssertAlmostEqual(&test, rTM, 0.000794377504256662);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.249847347462048e-06);
    AssertAlmostEqual(&test, rTM, 0.001054107030300379);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.304787674292075e-06);
    AssertAlmostEqual(&test, rTM, 5.304787674292075e-06);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.304787674292075e-06);
    AssertAlmostEqual(&test, rTM, 5.304787674292075e-06);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.304787674292075e-06);
    AssertAlmostEqual(&test, rTM, 5.304787674292075e-06);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.304787674292075e-06);
    AssertAlmostEqual(&test, rTM, 5.304787674292075e-06);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.304787674292075e-06);
    AssertAlmostEqual(&test, rTM, 5.304787674292076e-06);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.304787674292023e-06);
    AssertAlmostEqual(&test, rTM, 5.304787674292129e-06);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.304787674286771e-06);
    AssertAlmostEqual(&test, rTM, 5.30478767429738e-06);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.304787673761602e-06);
    AssertAlmostEqual(&test, rTM, 5.304787674822548e-06);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.304787621244762e-06);
    AssertAlmostEqual(&test, rTM, 5.304787727339389e-06);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.304782369565987e-06);
    AssertAlmostEqual(&test, rTM, 5.304792979018163e-06);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.304257254194218e-06);
    AssertAlmostEqual(&test, rTM, 5.305318094389933e-06);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.252265575774463e-06);
    AssertAlmostEqual(&test, rTM, 5.357309772809658e-06);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.652407907550832e-06);
    AssertAlmostEqual(&test, rTM, 7.95716744095868e-06);

    userdata[0] = 9/CAPS_HBAR_EV; /* 9eV */
    userdata[1] = 0.5/CAPS_HBAR_EV; /* 0.5eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999901775935648);
    AssertAlmostEqual(&test, rTM, 0.9999950887847223);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999302007806656);
    AssertAlmostEqual(&test, rTM, 0.9999993088947391);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993056540261338);
    AssertAlmostEqual(&test, rTM, 0.9999999305482277);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9930785505147606);
    AssertAlmostEqual(&test, rTM, 0.9999999930544373);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9329149028249103);
    AssertAlmostEqual(&test, rTM, 0.9999999993050289);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5059592244725981);
    AssertAlmostEqual(&test, rTM, 0.9999999999264758);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0199122286102518);
    AssertAlmostEqual(&test, rTM, 0.9999999999748997);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002072096275255568);
    AssertAlmostEqual(&test, rTM, 0.9999999999758699);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.07294666458318e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999758797);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.072955172882786e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999758798);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.072955257966223e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999999758798);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.072955258817057e-12);
    AssertAlmostEqual(&test, rTM, 0.9999999999758798);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.072955258825566e-14);
    AssertAlmostEqual(&test, rTM, 0.9999999999758798);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999977927021664);
    AssertAlmostEqual(&test, rTM, 0.9999781455636159);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999689391528652);
    AssertAlmostEqual(&test, rTM, 0.9999844694558327);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997792921405301);
    AssertAlmostEqual(&test, rTM, 0.9999978145348555);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9978059334418059);
    AssertAlmostEqual(&test, rTM, 0.9999997803741052);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9782761896809883);
    AssertAlmostEqual(&test, rTM, 0.9999999780350101);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8031629375110414);
    AssertAlmostEqual(&test, rTM, 0.9999999977904278);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1498306850887604);
    AssertAlmostEqual(&test, rTM, 0.9999999996737815);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.00206440518152544);
    AssertAlmostEqual(&test, rTM, 0.9999999997578005);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.072869247515211e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999997587885);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.072954326497459e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999997587984);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.072955177331368e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999997587985);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.072955185839712e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999997587985);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.072955185924795e-13);
    AssertAlmostEqual(&test, rTM, 0.9999999997587985);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997803868168471);
    AssertAlmostEqual(&test, rTM, 0.999780387036436);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997803759474683);
    AssertAlmostEqual(&test, rTM, 0.9997803979052661);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997792917136855);
    AssertAlmostEqual(&test, rTM, 0.9997814767054548);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996894343406233);
    AssertAlmostEqual(&test, rTM, 0.9998447051111241);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9977951083365109);
    AssertAlmostEqual(&test, rTM, 0.9999781455082979);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.978275084630073);
    AssertAlmostEqual(&test, rTM, 0.9999978036078809);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8031625115521968);
    AssertAlmostEqual(&test, rTM, 0.9999997790424874);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1498302554422173);
    AssertAlmostEqual(&test, rTM, 0.9999999673780554);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002064397228332364);
    AssertAlmostEqual(&test, rTM, 0.9999999757799589);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.072861229209672e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999758787524);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.072946307535735e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999758797424);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.072947158363082e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999758797523);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.07294716687136e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999758797524);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993056751665176);
    AssertAlmostEqual(&test, rTM, 0.9993056751734585);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993056748229463);
    AssertAlmostEqual(&test, rTM, 0.9993056755170296);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999305640466671);
    AssertAlmostEqual(&test, rTM, 0.9993057098715712);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993022133904064);
    AssertAlmostEqual(&test, rTM, 0.9993091197813171);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9990182176475825);
    AssertAlmostEqual(&test, rTM, 0.9995089882479333);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9930440178918557);
    AssertAlmostEqual(&test, rTM, 0.9999308900755635);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9329104003020755);
    AssertAlmostEqual(&test, rTM, 0.9999930505248814);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5059525735154916);
    AssertAlmostEqual(&test, rTM, 0.999999264742463);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01991148083942908);
    AssertAlmostEqual(&test, rTM, 0.9999997489882131);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002072015353414333);
    AssertAlmostEqual(&test, rTM, 0.9999997586891154);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.072865676517556e-06);
    AssertAlmostEqual(&test, rTM, 0.9999997587880947);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.072874184154403e-08);
    AssertAlmostEqual(&test, rTM, 0.9999997587890846);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.072874269231213e-10);
    AssertAlmostEqual(&test, rTM, 0.9999997587890945);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9978056149312949);
    AssertAlmostEqual(&test, rTM, 0.9978056149315142);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9978056149204447);
    AssertAlmostEqual(&test, rTM, 0.9978056149423644);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9978056138354174);
    AssertAlmostEqual(&test, rTM, 0.9978056160273912);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9978055053354123);
    AssertAlmostEqual(&test, rTM, 0.9978057245219294);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9977946823810605);
    AssertAlmostEqual(&test, rTM, 0.9978164933444104);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9968980824788138);
    AssertAlmostEqual(&test, rTM, 0.9984478356982515);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9781648300514814);
    AssertAlmostEqual(&test, rTM, 0.9997814213953097);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8031199187044147);
    AssertAlmostEqual(&test, rTM, 0.9999779012734425);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1497873034705478);
    AssertAlmostEqual(&test, rTM, 0.9999967368395414);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002063602218362587);
    AssertAlmostEqual(&test, rTM, 0.9999975770686212);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.072059711801538e-05);
    AssertAlmostEqual(&test, rTM, 0.9999975869479514);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.072144724547595e-07);
    AssertAlmostEqual(&test, rTM, 0.999997587046949);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.072145574719091e-09);
    AssertAlmostEqual(&test, rTM, 0.999997587047939);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9930650915135287);
    AssertAlmostEqual(&test, rTM, 0.9930650915135356);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9930650915131866);
    AssertAlmostEqual(&test, rTM, 0.9930650915138777);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9930650914789783);
    AssertAlmostEqual(&test, rTM, 0.9930650915480861);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9930650880581439);
    AssertAlmostEqual(&test, rTM, 0.9930650949689187);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9930647459833135);
    AssertAlmostEqual(&test, rTM, 0.9930654370265956);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9930306241765293);
    AssertAlmostEqual(&test, rTM, 0.9930993889810856);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9902066832564795);
    AssertAlmostEqual(&test, rTM, 0.9950912642887264);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9324650106422728);
    AssertAlmostEqual(&test, rTM, 0.9993073706760055);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5052951599534204);
    AssertAlmostEqual(&test, rTM, 0.9999263236662738);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01983772119003471);
    AssertAlmostEqual(&test, rTM, 0.9999748060585812);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002064034462027909);
    AssertAlmostEqual(&test, rTM, 0.999975776186227);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.064878266522427e-06);
    AssertAlmostEqual(&test, rTM, 0.9999757860838036);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.064886708922629e-08);
    AssertAlmostEqual(&test, rTM, 0.9999757861827997);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9778605477529373);
    AssertAlmostEqual(&test, rTM, 0.9778605477529375);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9778605477529264);
    AssertAlmostEqual(&test, rTM, 0.9778605477529483);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9778605477518427);
    AssertAlmostEqual(&test, rTM, 0.977860547754032);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9778605476434792);
    AssertAlmostEqual(&test, rTM, 0.9778605478623955);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9778605368071245);
    AssertAlmostEqual(&test, rTM, 0.9778605586987449);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9778594531993533);
    AssertAlmostEqual(&test, rTM, 0.977861642253016);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9777513680119505);
    AssertAlmostEqual(&test, rTM, 0.9779691976890909);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9688349162471851);
    AssertAlmostEqual(&test, rTM, 0.9842931446377798);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7988904430475959);
    AssertAlmostEqual(&test, rTM, 0.9977609801710087);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1456152174005671);
    AssertAlmostEqual(&test, rTM, 0.9996640422108446);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001987078732062001);
    AssertAlmostEqual(&test, rTM, 0.9997484387572892);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.994921674604978e-05);
    AssertAlmostEqual(&test, rTM, 0.9997494263976056);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.995000494981442e-07);
    AssertAlmostEqual(&test, rTM, 0.9997494362936855);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9213773309576296);
    AssertAlmostEqual(&test, rTM, 0.9213773309576296);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9213773309576292);
    AssertAlmostEqual(&test, rTM, 0.92137733095763);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9213773309575919);
    AssertAlmostEqual(&test, rTM, 0.9213773309576673);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9213773309538593);
    AssertAlmostEqual(&test, rTM, 0.9213773309613998);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9213773305806024);
    AssertAlmostEqual(&test, rTM, 0.9213773313346567);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9213772932549232);
    AssertAlmostEqual(&test, rTM, 0.9213773686603186);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.921373560788095);
    AssertAlmostEqual(&test, rTM, 0.9213811009537803);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9210013199944519);
    AssertAlmostEqual(&test, rTM, 0.9217516251171443);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8906787557067644);
    AssertAlmostEqual(&test, rTM, 0.9437120608030534);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4486372881889762);
    AssertAlmostEqual(&test, rTM, 0.9912397587953856);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01447549373689529);
    AssertAlmostEqual(&test, rTM, 0.9965586689746181);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001490088577721361);
    AssertAlmostEqual(&test, rTM, 0.9966557182819468);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.490529782050556e-06);
    AssertAlmostEqual(&test, rTM, 0.9966567031729606);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6176205757447017);
    AssertAlmostEqual(&test, rTM, 0.6176205757447017);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6176205757447017);
    AssertAlmostEqual(&test, rTM, 0.6176205757447017);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6176205757447003);
    AssertAlmostEqual(&test, rTM, 0.6176205757447032);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6176205757445558);
    AssertAlmostEqual(&test, rTM, 0.6176205757448477);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6176205757301022);
    AssertAlmostEqual(&test, rTM, 0.6176205757593013);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6176205742847463);
    AssertAlmostEqual(&test, rTM, 0.6176205772046572);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6176204297492109);
    AssertAlmostEqual(&test, rTM, 0.6176207217401499);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6176059767479498);
    AssertAlmostEqual(&test, rTM, 0.6176351743158416);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6161661703925715);
    AssertAlmostEqual(&test, rTM, 0.6190707690621569);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.509056413043442);
    AssertAlmostEqual(&test, rTM, 0.7068413318475272);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03865205235749649);
    AssertAlmostEqual(&test, rTM, 0.8861330939160197);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004220099280921284);
    AssertAlmostEqual(&test, rTM, 0.8940747788447488);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.224045841385639e-06);
    AssertAlmostEqual(&test, rTM, 0.8941585680496085);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04698110456569161);
    AssertAlmostEqual(&test, rTM, 0.04698110456569161);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04698110456569161);
    AssertAlmostEqual(&test, rTM, 0.04698110456569161);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0469811045656916);
    AssertAlmostEqual(&test, rTM, 0.04698110456569161);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04698110456569118);
    AssertAlmostEqual(&test, rTM, 0.04698110456569204);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04698110456564884);
    AssertAlmostEqual(&test, rTM, 0.04698110456573437);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04698110456141513);
    AssertAlmostEqual(&test, rTM, 0.04698110456996808);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04698110413804416);
    AssertAlmostEqual(&test, rTM, 0.04698110499333906);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04698106180098521);
    AssertAlmostEqual(&test, rTM, 0.04698114733039783);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04697682848124452);
    AssertAlmostEqual(&test, rTM, 0.04698538064841681);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04655732305646409);
    AssertAlmostEqual(&test, rTM, 0.04740486916352001);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0246065040104958);
    AssertAlmostEqual(&test, rTM, 0.0693086605683913);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005116280166582689);
    AssertAlmostEqual(&test, rTM, 0.09324811512376302);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.172163921435431e-06);
    AssertAlmostEqual(&test, rTM, 0.09375014352851932);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005285980512124576);
    AssertAlmostEqual(&test, rTM, 0.0005285980512124576);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005285980512124576);
    AssertAlmostEqual(&test, rTM, 0.0005285980512124576);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005285980512124576);
    AssertAlmostEqual(&test, rTM, 0.0005285980512124576);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005285980512124575);
    AssertAlmostEqual(&test, rTM, 0.0005285980512124576);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005285980512124523);
    AssertAlmostEqual(&test, rTM, 0.0005285980512124628);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005285980512119295);
    AssertAlmostEqual(&test, rTM, 0.0005285980512129856);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005285980511596536);
    AssertAlmostEqual(&test, rTM, 0.0005285980512652615);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005285980459320624);
    AssertAlmostEqual(&test, rTM, 0.0005285980564928526);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005285975231734704);
    AssertAlmostEqual(&test, rTM, 0.0005285985792514447);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005285452525352825);
    AssertAlmostEqual(&test, rTM, 0.0005286508498896298);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005233698825244488);
    AssertAlmostEqual(&test, rTM, 0.0005338262198715691);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002644387520086773);
    AssertAlmostEqual(&test, rTM, 0.0007927572766449506);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.239126552382915e-06);
    AssertAlmostEqual(&test, rTM, 0.001051956686301774);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.303701880968274e-06);
    AssertAlmostEqual(&test, rTM, 5.303701880968274e-06);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.303701880968274e-06);
    AssertAlmostEqual(&test, rTM, 5.303701880968274e-06);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.303701880968274e-06);
    AssertAlmostEqual(&test, rTM, 5.303701880968274e-06);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.303701880968274e-06);
    AssertAlmostEqual(&test, rTM, 5.303701880968274e-06);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.303701880968274e-06);
    AssertAlmostEqual(&test, rTM, 5.303701880968275e-06);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.303701880968221e-06);
    AssertAlmostEqual(&test, rTM, 5.303701880968328e-06);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.303701880962971e-06);
    AssertAlmostEqual(&test, rTM, 5.303701880973579e-06);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.30370188043791e-06);
    AssertAlmostEqual(&test, rTM, 5.303701881498639e-06);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.303701827931819e-06);
    AssertAlmostEqual(&test, rTM, 5.30370193400473e-06);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.303696577327955e-06);
    AssertAlmostEqual(&test, rTM, 5.303707184608594e-06);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.30317156943659e-06);
    AssertAlmostEqual(&test, rTM, 5.30423219249996e-06);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.25119053265378e-06);
    AssertAlmostEqual(&test, rTM, 5.356213229282741e-06);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.651865005129607e-06);
    AssertAlmostEqual(&test, rTM, 7.955538756732348e-06);

    userdata[0] = 9/CAPS_HBAR_EV; /* 9eV */
    userdata[1] = 1/CAPS_HBAR_EV; /* 1eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999861090478762);
    AssertAlmostEqual(&test, rTM, 0.999993054499818);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999012904244658);
    AssertAlmostEqual(&test, rTM, 0.9999990226297073);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9990181877552191);
    AssertAlmostEqual(&test, rTM, 0.9999999017803571);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9902256623200565);
    AssertAlmostEqual(&test, rTM, 0.9999999901774318);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9064810954671071);
    AssertAlmostEqual(&test, rTM, 0.9999999990165707);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3880910174166667);
    AssertAlmostEqual(&test, rTM, 0.9999999998905688);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01015532979774159);
    AssertAlmostEqual(&test, rTM, 0.9999999999507698);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001036262829919233);
    AssertAlmostEqual(&test, rTM, 0.9999999999517497);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.036475482871632e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999517596);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.036477609952109e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999517597);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.036477631222969e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999999517597);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.036477631435677e-12);
    AssertAlmostEqual(&test, rTM, 0.9999999999517597);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.036477631437804e-14);
    AssertAlmostEqual(&test, rTM, 0.9999999999517597);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999687842376839);
    AssertAlmostEqual(&test, rTM, 0.9999690932998613);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999560736117322);
    AssertAlmostEqual(&test, rTM, 0.9999780365646672);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996878862235147);
    AssertAlmostEqual(&test, rTM, 0.9999969092869632);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9968985325408621);
    AssertAlmostEqual(&test, rTM, 0.9999996894019109);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.969417313007843);
    AssertAlmostEqual(&test, rTM, 0.999999968934941);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7339033152354163);
    AssertAlmostEqual(&test, rTM, 0.9999999968566301);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.08649345622840908);
    AssertAlmostEqual(&test, rTM, 0.9999999994262463);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001034334592785358);
    AssertAlmostEqual(&test, rTM, 0.9999999995165979);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.036456128052683e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999995175869);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.036477398355713e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999995175968);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.036477611064255e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999995175969);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.03647761319134e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999995175969);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.036477613212611e-13);
    AssertAlmostEqual(&test, rTM, 0.9999999995175969);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996894344886977);
    AssertAlmostEqual(&test, rTM, 0.9996894347992147);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996894191184883);
    AssertAlmostEqual(&test, rTM, 0.9996894501686482);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996878859217174);
    AssertAlmostEqual(&test, rTM, 0.9996909756825624);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995608225147552);
    AssertAlmostEqual(&test, rTM, 0.9997803871398258);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9968832405053791);
    AssertAlmostEqual(&test, rTM, 0.9999690932330678);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9694157935939937);
    AssertAlmostEqual(&test, rTM, 0.9999968936496685);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7339029858839191);
    AssertAlmostEqual(&test, rTM, 0.999999685662907);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.08649331484951042);
    AssertAlmostEqual(&test, rTM, 0.9999999426245343);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001034332596216436);
    AssertAlmostEqual(&test, rTM, 0.9999999516597038);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.036454123388724e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999517586003);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.03647539361049e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999517595903);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.036475606318218e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999517596002);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.036475608445297e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999517596003);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9990182272283383);
    AssertAlmostEqual(&test, rTM, 0.9990182272381513);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9990182267425995);
    AssertAlmostEqual(&test, rTM, 0.9990182277238897);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999018178169943);
    AssertAlmostEqual(&test, rTM, 0.999018276294096);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9990133329974628);
    AssertAlmostEqual(&test, rTM, 0.9990230972036587);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9986118460612553);
    AssertAlmostEqual(&test, rTM, 0.9993056819081716);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9901770622298458);
    AssertAlmostEqual(&test, rTM, 0.9999022655777097);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9064757807693512);
    AssertAlmostEqual(&test, rTM, 0.9999901661514479);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3880875042504672);
    AssertAlmostEqual(&test, rTM, 0.9999989056764766);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01015513530271519);
    AssertAlmostEqual(&test, rTM, 0.9999995076892891);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001036242590627386);
    AssertAlmostEqual(&test, rTM, 0.999999517487741);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.036455235375162e-06);
    AssertAlmostEqual(&test, rTM, 0.9999995175867304);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.036457362373561e-08);
    AssertAlmostEqual(&test, rTM, 0.9999995175877205);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.0364573836436e-10);
    AssertAlmostEqual(&test, rTM, 0.9999995175877304);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9968983849204527);
    AssertAlmostEqual(&test, rTM, 0.9968983849207623);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9968983849051235);
    AssertAlmostEqual(&test, rTM, 0.9968983849360915);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.996898383372209);
    AssertAlmostEqual(&test, rTM, 0.9968983864690051);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9968982300846103);
    AssertAlmostEqual(&test, rTM, 0.9968985397488875);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.996882939569972);
    AssertAlmostEqual(&test, rTM, 0.9969137538562484);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9956164749941444);
    AssertAlmostEqual(&test, rTM, 0.9978058276629616);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9692642205702775);
    AssertAlmostEqual(&test, rTM, 0.9996909089007516);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7338700517913476);
    AssertAlmostEqual(&test, rTM, 0.9999685652628685);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0864791792968206);
    AssertAlmostEqual(&test, rTM, 0.9999942615371417);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001034132978239764);
    AssertAlmostEqual(&test, rTM, 0.9999951650604338);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.036253696146267e-05);
    AssertAlmostEqual(&test, rTM, 0.9999951749500219);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.036274958243953e-07);
    AssertAlmostEqual(&test, rTM, 0.9999951750490201);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.036275170870437e-09);
    AssertAlmostEqual(&test, rTM, 0.9999951750500101);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9902161705518352);
    AssertAlmostEqual(&test, rTM, 0.990216170551845);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9902161705513534);
    AssertAlmostEqual(&test, rTM, 0.9902161705523269);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9902161705031615);
    AssertAlmostEqual(&test, rTM, 0.9902161706005188);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9902161656839751);
    AssertAlmostEqual(&test, rTM, 0.9902161754197027);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.990215683777504);
    AssertAlmostEqual(&test, rTM, 0.9902166573020781);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9901676141747552);
    AssertAlmostEqual(&test, rTM, 0.9902644883105183);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.986191721414806);
    AssertAlmostEqual(&test, rTM, 0.9930717777293648);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9059504389129409);
    AssertAlmostEqual(&test, rTM, 0.9990209848122623);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3877400032917293);
    AssertAlmostEqual(&test, rTM, 0.9998904542139622);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0101359151687653);
    AssertAlmostEqual(&test, rTM, 0.999950677988882);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001034242606964844);
    AssertAlmostEqual(&test, rTM, 0.9999516577814842);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.034454441757817e-06);
    AssertAlmostEqual(&test, rTM, 0.9999516676797322);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.034456560653526e-08);
    AssertAlmostEqual(&test, rTM, 0.999951667778725);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9691246830217517);
    AssertAlmostEqual(&test, rTM, 0.969124683021752);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9691246830217367);
    AssertAlmostEqual(&test, rTM, 0.9691246830217671);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9691246830202324);
    AssertAlmostEqual(&test, rTM, 0.9691246830232715);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9691246828697959);
    AssertAlmostEqual(&test, rTM, 0.9691246831737079);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9691246678261555);
    AssertAlmostEqual(&test, rTM, 0.969124698217341);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9691231635009017);
    AssertAlmostEqual(&test, rTM, 0.9691262024689954);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9689731169667043);
    AssertAlmostEqual(&test, rTM, 0.9692755202313509);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9566183614490447);
    AssertAlmostEqual(&test, rTM, 0.9780660234844776);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7305871537259497);
    AssertAlmostEqual(&test, rTM, 0.9968464750665147);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0850886128496425);
    AssertAlmostEqual(&test, rTM, 0.9994170034674219);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001014552893941384);
    AssertAlmostEqual(&test, rTM, 0.9995074155854842);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.016595003050642e-05);
    AssertAlmostEqual(&test, rTM, 0.9995084038403985);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.016615476036894e-07);
    AssertAlmostEqual(&test, rTM, 0.9995084137329979);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8982198419958715);
    AssertAlmostEqual(&test, rTM, 0.8982198419958715);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.898219841995871);
    AssertAlmostEqual(&test, rTM, 0.8982198419958719);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8982198419958233);
    AssertAlmostEqual(&test, rTM, 0.8982198419959196);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8982198419910553);
    AssertAlmostEqual(&test, rTM, 0.8982198420006876);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8982198415142573);
    AssertAlmostEqual(&test, rTM, 0.8982198424774857);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8982197938344678);
    AssertAlmostEqual(&test, rTM, 0.8982198901572536);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8982150259878224);
    AssertAlmostEqual(&test, rTM, 0.8982246577882663);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8977395577795415);
    AssertAlmostEqual(&test, rTM, 0.8986979908847847);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8592205919783055);
    AssertAlmostEqual(&test, rTM, 0.9268404922787727);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3560220995249145);
    AssertAlmostEqual(&test, rTM, 0.9879652295310491);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.008522725565670681);
    AssertAlmostEqual(&test, rTM, 0.9941682627468168);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.669232800865208e-05);
    AssertAlmostEqual(&test, rTM, 0.9942655534139845);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.670729655995878e-07);
    AssertAlmostEqual(&test, rTM, 0.9942665348286518);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5899665375925871);
    AssertAlmostEqual(&test, rTM, 0.5899665375925871);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5899665375925871);
    AssertAlmostEqual(&test, rTM, 0.5899665375925871);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5899665375925855);
    AssertAlmostEqual(&test, rTM, 0.5899665375925887);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.589966537592435);
    AssertAlmostEqual(&test, rTM, 0.5899665375927392);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5899665375773726);
    AssertAlmostEqual(&test, rTM, 0.5899665376078016);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5899665360711336);
    AssertAlmostEqual(&test, rTM, 0.5899665391140406);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5899663854472931);
    AssertAlmostEqual(&test, rTM, 0.5899666897378393);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.589951323658972);
    AssertAlmostEqual(&test, rTM, 0.5899817511072918);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5884510705823695);
    AssertAlmostEqual(&test, rTM, 0.5914778593262985);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4780279459458908);
    AssertAlmostEqual(&test, rTM, 0.6830473663634742);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0325200603198008);
    AssertAlmostEqual(&test, rTM, 0.8674533022345161);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003506232817730295);
    AssertAlmostEqual(&test, rTM, 0.8751999490850341);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.509015578917474e-06);
    AssertAlmostEqual(&test, rTM, 0.8752811578475644);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04593772791534714);
    AssertAlmostEqual(&test, rTM, 0.04593772791534714);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04593772791534714);
    AssertAlmostEqual(&test, rTM, 0.04593772791534714);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04593772791534714);
    AssertAlmostEqual(&test, rTM, 0.04593772791534715);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04593772791534673);
    AssertAlmostEqual(&test, rTM, 0.04593772791534757);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04593772791530524);
    AssertAlmostEqual(&test, rTM, 0.04593772791538905);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04593772791115689);
    AssertAlmostEqual(&test, rTM, 0.0459377279195374);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0459377274963217);
    AssertAlmostEqual(&test, rTM, 0.0459377283343726);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0459376860128401);
    AssertAlmostEqual(&test, rTM, 0.04593776981785402);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04593353804380425);
    AssertAlmostEqual(&test, rTM, 0.04594191778527375);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04552249795949855);
    AssertAlmostEqual(&test, rTM, 0.04635294199751258);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02403555019478303);
    AssertAlmostEqual(&test, rTM, 0.0677958281649485);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000499184392905583);
    AssertAlmostEqual(&test, rTM, 0.09118697054051672);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.046244118976328e-06);
    AssertAlmostEqual(&test, rTM, 0.09167697782118625);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005272535683341262);
    AssertAlmostEqual(&test, rTM, 0.0005272535683341262);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005272535683341262);
    AssertAlmostEqual(&test, rTM, 0.0005272535683341262);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005272535683341262);
    AssertAlmostEqual(&test, rTM, 0.0005272535683341262);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005272535683341261);
    AssertAlmostEqual(&test, rTM, 0.0005272535683341262);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005272535683341209);
    AssertAlmostEqual(&test, rTM, 0.0005272535683341314);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005272535683335995);
    AssertAlmostEqual(&test, rTM, 0.0005272535683346529);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005272535682814564);
    AssertAlmostEqual(&test, rTM, 0.000527253568386796);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005272535630671475);
    AssertAlmostEqual(&test, rTM, 0.0005272535736011048);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005272530416367836);
    AssertAlmostEqual(&test, rTM, 0.0005272540950314687);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005272009038081618);
    AssertAlmostEqual(&test, rTM, 0.0005273062328600875);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005220386835471998);
    AssertAlmostEqual(&test, rTM, 0.0005324684530923751);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002637658006418801);
    AssertAlmostEqual(&test, rTM, 0.0007907412628163666);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.225786976108108e-06);
    AssertAlmostEqual(&test, rTM, 0.001049281062325314);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.302345264209543e-06);
    AssertAlmostEqual(&test, rTM, 5.302345264209543e-06);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.302345264209543e-06);
    AssertAlmostEqual(&test, rTM, 5.302345264209543e-06);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.302345264209543e-06);
    AssertAlmostEqual(&test, rTM, 5.302345264209543e-06);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.302345264209543e-06);
    AssertAlmostEqual(&test, rTM, 5.302345264209543e-06);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.302345264209542e-06);
    AssertAlmostEqual(&test, rTM, 5.302345264209543e-06);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.30234526420949e-06);
    AssertAlmostEqual(&test, rTM, 5.302345264209596e-06);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.302345264204241e-06);
    AssertAlmostEqual(&test, rTM, 5.302345264214846e-06);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.302345263679314e-06);
    AssertAlmostEqual(&test, rTM, 5.302345264739772e-06);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.302345211186653e-06);
    AssertAlmostEqual(&test, rTM, 5.302345317232433e-06);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.30233996192581e-06);
    AssertAlmostEqual(&test, rTM, 5.302350566493275e-06);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.301815088323092e-06);
    AssertAlmostEqual(&test, rTM, 5.302875440095995e-06);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.24984734746205e-06);
    AssertAlmostEqual(&test, rTM, 5.354843180957007e-06);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.651186689556056e-06);
    AssertAlmostEqual(&test, rTM, 7.953503838788494e-06);

    userdata[0] = 10/CAPS_HBAR_EV; /* 10eV */
    userdata[1] = 1e-05/CAPS_HBAR_EV; /* 1e-05eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999604615216);
    AssertAlmostEqual(&test, rTM, 0.9999999802307606);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999999719026353);
    AssertAlmostEqual(&test, rTM, 0.9999999972180823);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999972040714475);
    AssertAlmostEqual(&test, rTM, 0.9999999997204347);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999720424500917);
    AssertAlmostEqual(&test, rTM, 0.9999999999720421);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997204598106559);
    AssertAlmostEqual(&test, rTM, 0.9999999999972042);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9972081128215704);
    AssertAlmostEqual(&test, rTM, 0.9999999999997204);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9724301645686226);
    AssertAlmostEqual(&test, rTM, 0.999999999999972);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7567845829364053);
    AssertAlmostEqual(&test, rTM, 0.9999999999999972);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1029494263746385);
    AssertAlmostEqual(&test, rTM, 0.9999999999999996);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001276089014522639);
    AssertAlmostEqual(&test, rTM, 0.9999999999999996);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279319331667342e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999999996);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279351738106306e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999999996);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.27935206218106e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999999999996);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999110702558);
    AssertAlmostEqual(&test, rTM, 0.9999999119507482);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999998748585028);
    AssertAlmostEqual(&test, rTM, 0.9999999374292494);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999991107029134);
    AssertAlmostEqual(&test, rTM, 0.9999999911950744);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999911507560453);
    AssertAlmostEqual(&test, rTM, 0.9999999991151601);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999115154639867);
    AssertAlmostEqual(&test, rTM, 0.9999999999115117);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991155073510215);
    AssertAlmostEqual(&test, rTM, 0.9999999999911512);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9911902237018976);
    AssertAlmostEqual(&test, rTM, 0.9999999999991152);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9153401244070082);
    AssertAlmostEqual(&test, rTM, 0.9999999999999114);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4238840386576281);
    AssertAlmostEqual(&test, rTM, 0.9999999999999903);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.012454924626766);
    AssertAlmostEqual(&test, rTM, 0.999999999999996);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001276780795136403);
    AssertAlmostEqual(&test, rTM, 0.9999999999999961);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.277103629434252e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999999961);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.277106858807823e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999999961);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999990334722776);
    AssertAlmostEqual(&test, rTM, 0.9999990334732441);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999990334244357);
    AssertAlmostEqual(&test, rTM, 0.9999990335210835);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999990286521486);
    AssertAlmostEqual(&test, rTM, 0.9999990382694495);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999986331243437);
    AssertAlmostEqual(&test, rTM, 0.9999993165619383);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999902865639441);
    AssertAlmostEqual(&test, rTM, 0.9999999038269033);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999033470680952);
    AssertAlmostEqual(&test, rTM, 0.9999999903352061);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9990339387860411);
    AssertAlmostEqual(&test, rTM, 0.9999999990334727);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9903813188177689);
    AssertAlmostEqual(&test, rTM, 0.9999999999033461);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9079053108792529);
    AssertAlmostEqual(&test, rTM, 0.9999999999903234);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3936136762640156);
    AssertAlmostEqual(&test, rTM, 0.9999999999989265);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01048140030973236);
    AssertAlmostEqual(&test, rTM, 0.999999999999523);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000107023320179737);
    AssertAlmostEqual(&test, rTM, 0.9999999999995328);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.070460026626173e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999995329);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999951955123755);
    AssertAlmostEqual(&test, rTM, 0.9999951955124236);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999951955099973);
    AssertAlmostEqual(&test, rTM, 0.9999951955148018);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999951952721817);
    AssertAlmostEqual(&test, rTM, 0.9999951957526053);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999995171549777);
    AssertAlmostEqual(&test, rTM, 0.9999952193561006);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999932054352361);
    AssertAlmostEqual(&test, rTM, 0.9999966027118472);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999517165468885);
    AssertAlmostEqual(&test, rTM, 0.9999995219345814);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995196414776343);
    AssertAlmostEqual(&test, rTM, 0.9999999519574104);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9952070262103134);
    AssertAlmostEqual(&test, rTM, 0.9999999951954894);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.953095308041084);
    AssertAlmostEqual(&test, rTM, 0.9999999995194114);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6212976663344429);
    AssertAlmostEqual(&test, rTM, 0.9999999999505882);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03993086986309919);
    AssertAlmostEqual(&test, rTM, 0.9999999999874983);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004328403284718419);
    AssertAlmostEqual(&test, rTM, 0.9999999999884484);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.332115199222966e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999884583);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999599386318707);
    AssertAlmostEqual(&test, rTM, 0.9999599386318747);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999599386316724);
    AssertAlmostEqual(&test, rTM, 0.999959938632073);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999599386118425);
    AssertAlmostEqual(&test, rTM, 0.999959938651903);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999599366288945);
    AssertAlmostEqual(&test, rTM, 0.9999599406347508);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999597388273332);
    AssertAlmostEqual(&test, rTM, 0.9999601374448599);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999433451399429);
    AssertAlmostEqual(&test, rTM, 0.9999716721687327);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999597461211484);
    AssertAlmostEqual(&test, rTM, 0.9999960136728987);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960016002848565);
    AssertAlmostEqual(&test, rTM, 0.9999995993976001);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9607322623539892);
    AssertAlmostEqual(&test, rTM, 0.9999999599298137);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6716688535290366);
    AssertAlmostEqual(&test, rTM, 0.9999999959141999);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05557345736400543);
    AssertAlmostEqual(&test, rTM, 0.9999999991030686);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000622286484183962);
    AssertAlmostEqual(&test, rTM, 0.9999999991965118);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.230539246487702e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999991975013);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996083315083162);
    AssertAlmostEqual(&test, rTM, 0.9996083315083165);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996083315082968);
    AssertAlmostEqual(&test, rTM, 0.9996083315083359);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996083315063584);
    AssertAlmostEqual(&test, rTM, 0.9996083315102743);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996083313125205);
    AssertAlmostEqual(&test, rTM, 0.9996083317041121);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996083119292173);
    AssertAlmostEqual(&test, rTM, 0.999608351086437);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996063784219263);
    AssertAlmostEqual(&test, rTM, 0.9996102749056974);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994461420451362);
    AssertAlmostEqual(&test, rTM, 0.9997230326618041);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960707516207764);
    AssertAlmostEqual(&test, rTM, 0.9999610205797514);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9615834027246973);
    AssertAlmostEqual(&test, rTM, 0.9999960820000685);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6775426753688116);
    AssertAlmostEqual(&test, rTM, 0.9999996008109355);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05784161696808011);
    AssertAlmostEqual(&test, rTM, 0.9999999138462661);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006507694558503012);
    AssertAlmostEqual(&test, rTM, 0.9999999231679138);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.516087932430736e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999232668486);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960991657865778);
    AssertAlmostEqual(&test, rTM, 0.9960991657865778);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960991657865758);
    AssertAlmostEqual(&test, rTM, 0.9960991657865796);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.996099165786383);
    AssertAlmostEqual(&test, rTM, 0.9960991657867724);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960991657671117);
    AssertAlmostEqual(&test, rTM, 0.9960991658060437);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960991638399727);
    AssertAlmostEqual(&test, rTM, 0.9960991677331819);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960989711309085);
    AssertAlmostEqual(&test, rTM, 0.996099360432553);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960797483438886);
    AssertAlmostEqual(&test, rTM, 0.9961184872395348);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9944878510614401);
    AssertAlmostEqual(&test, rTM, 0.9972401117910541);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9614842830471968);
    AssertAlmostEqual(&test, rTM, 0.999611095342902);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6781276655572938);
    AssertAlmostEqual(&test, rTM, 0.9999601788813732);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05807864105682105);
    AssertAlmostEqual(&test, rTM, 0.999991420100616);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006537618138845855);
    AssertAlmostEqual(&test, rTM, 0.9999923520164502);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546088980370825e-06);
    AssertAlmostEqual(&test, rTM, 0.9999923619097998);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616803465331276);
    AssertAlmostEqual(&test, rTM, 0.9616803465331276);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616803465331275);
    AssertAlmostEqual(&test, rTM, 0.9616803465331278);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616803465331089);
    AssertAlmostEqual(&test, rTM, 0.9616803465331464);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616803465312491);
    AssertAlmostEqual(&test, rTM, 0.9616803465350062);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616803463452721);
    AssertAlmostEqual(&test, rTM, 0.9616803467209832);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616803277475757);
    AssertAlmostEqual(&test, rTM, 0.9616803653186705);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616784680262591);
    AssertAlmostEqual(&test, rTM, 0.9616822249497111);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.961492976704328);
    AssertAlmostEqual(&test, rTM, 0.961866822370922);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9462445025436315);
    AssertAlmostEqual(&test, rTM, 0.9727458701683818);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.676904691657316);
    AssertAlmostEqual(&test, rTM, 0.9960469242294955);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05809733589610714);
    AssertAlmostEqual(&test, rTM, 0.9991430605561675);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540619178956597);
    AssertAlmostEqual(&test, rTM, 0.9992361310326453);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549104221620179e-06);
    AssertAlmostEqual(&test, rTM, 0.9992371192453255);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6782065560479311);
    AssertAlmostEqual(&test, rTM, 0.6782065560479311);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6782065560479311);
    AssertAlmostEqual(&test, rTM, 0.6782065560479311);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6782065560479298);
    AssertAlmostEqual(&test, rTM, 0.6782065560479323);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.678206556047801);
    AssertAlmostEqual(&test, rTM, 0.6782065560480611);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6782065560349266);
    AssertAlmostEqual(&test, rTM, 0.6782065560609356);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6782065547474808);
    AssertAlmostEqual(&test, rTM, 0.6782065573483814);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6782064260029464);
    AssertAlmostEqual(&test, rTM, 0.6782066860928733);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6781935520065663);
    AssertAlmostEqual(&test, rTM, 0.6782195596645669);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6769106994107257);
    AssertAlmostEqual(&test, rTM, 0.6794982085948307);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5793778480571923);
    AssertAlmostEqual(&test, rTM, 0.7573816987141847);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05759223563547784);
    AssertAlmostEqual(&test, rTM, 0.9207474542940628);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540273441597036);
    AssertAlmostEqual(&test, rTM, 0.9289833602544622);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549399421194755e-06);
    AssertAlmostEqual(&test, rTM, 0.9290720048849316);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810512840683112);
    AssertAlmostEqual(&test, rTM, 0.05810512840683112);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810512840683112);
    AssertAlmostEqual(&test, rTM, 0.05810512840683112);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810512840683111);
    AssertAlmostEqual(&test, rTM, 0.05810512840683112);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0581051284068306);
    AssertAlmostEqual(&test, rTM, 0.05810512840683163);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810512840677939);
    AssertAlmostEqual(&test, rTM, 0.05810512840688284);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810512840165876);
    AssertAlmostEqual(&test, rTM, 0.05810512841200347);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810512788959591);
    AssertAlmostEqual(&test, rTM, 0.05810512892406632);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810507668335666);
    AssertAlmostEqual(&test, rTM, 0.05810518013030525);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05809995651671238);
    AssertAlmostEqual(&test, rTM, 0.05811030029383087);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05759247204312549);
    AssertAlmostEqual(&test, rTM, 0.05861775412692476);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.030763725283131);
    AssertAlmostEqual(&test, rTM, 0.08535964100431834);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006476278586863366);
    AssertAlmostEqual(&test, rTM, 0.1151802388026323);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.548781270827892e-06);
    AssertAlmostEqual(&test, rTM, 0.1158127663096166);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540959714919183);
    AssertAlmostEqual(&test, rTM, 0.0006540959714919183);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540959714919183);
    AssertAlmostEqual(&test, rTM, 0.0006540959714919183);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540959714919183);
    AssertAlmostEqual(&test, rTM, 0.0006540959714919183);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540959714919182);
    AssertAlmostEqual(&test, rTM, 0.0006540959714919184);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540959714919118);
    AssertAlmostEqual(&test, rTM, 0.0006540959714919248);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540959714912651);
    AssertAlmostEqual(&test, rTM, 0.0006540959714925715);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540959714265943);
    AssertAlmostEqual(&test, rTM, 0.0006540959715572424);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540959649595099);
    AssertAlmostEqual(&test, rTM, 0.0006540959780243267);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000654095318251723);
    AssertAlmostEqual(&test, rTM, 0.0006540966247321136);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540306539303635);
    AssertAlmostEqual(&test, rTM, 0.0006541612890534675);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006476281566342815);
    AssertAlmostEqual(&test, rTM, 0.00066056378629483);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.00032726194147421);
    AssertAlmostEqual(&test, rTM, 0.0009809298617679311);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.484594066121338e-06);
    AssertAlmostEqual(&test, rTM, 0.001301706800261595);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549439459079369e-06);
    AssertAlmostEqual(&test, rTM, 6.549439459079369e-06);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549439459079369e-06);
    AssertAlmostEqual(&test, rTM, 6.549439459079369e-06);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549439459079369e-06);
    AssertAlmostEqual(&test, rTM, 6.549439459079369e-06);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549439459079369e-06);
    AssertAlmostEqual(&test, rTM, 6.549439459079369e-06);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549439459079368e-06);
    AssertAlmostEqual(&test, rTM, 6.54943945907937e-06);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549439459079304e-06);
    AssertAlmostEqual(&test, rTM, 6.549439459079434e-06);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54943945907282e-06);
    AssertAlmostEqual(&test, rTM, 6.549439459085918e-06);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549439458424434e-06);
    AssertAlmostEqual(&test, rTM, 6.549439459734304e-06);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549439393585833e-06);
    AssertAlmostEqual(&test, rTM, 6.549439524572905e-06);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549432909732249e-06);
    AssertAlmostEqual(&test, rTM, 6.549446008426489e-06);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.548784589198566e-06);
    AssertAlmostEqual(&test, rTM, 6.550094328960171e-06);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.484594364834651e-06);
    AssertAlmostEqual(&test, rTM, 6.614284553324032e-06);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.274741177153415e-06);
    AssertAlmostEqual(&test, rTM, 9.824137740864854e-06);

    userdata[0] = 10/CAPS_HBAR_EV; /* 10eV */
    userdata[1] = 0.0001/CAPS_HBAR_EV; /* 0.0001eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999998749793493);
    AssertAlmostEqual(&test, rTM, 0.9999999374896726);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999991115616876);
    AssertAlmostEqual(&test, rTM, 0.9999999912035772);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999911593015284);
    AssertAlmostEqual(&test, rTM, 0.9999999991160147);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999116009077859);
    AssertAlmostEqual(&test, rTM, 0.999999999911597);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999116361108636);
    AssertAlmostEqual(&test, rTM, 0.9999999999911597);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9911986935059649);
    AssertAlmostEqual(&test, rTM, 0.9999999999991159);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.915418268387858);
    AssertAlmostEqual(&test, rTM, 0.9999999999999115);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4242154357920767);
    AssertAlmostEqual(&test, rTM, 0.9999999999999903);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01247842060860464);
    AssertAlmostEqual(&test, rTM, 0.999999999999996);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001279249658356818);
    AssertAlmostEqual(&test, rTM, 0.9999999999999961);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279573742484986e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999999961);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.27957698436285e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999999961);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279577016781733e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999999999961);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999999719026353);
    AssertAlmostEqual(&test, rTM, 0.9999997218082699);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999996046152864);
    AssertAlmostEqual(&test, rTM, 0.9999998023076236);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999971902670827);
    AssertAlmostEqual(&test, rTM, 0.9999999721808235);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999720410662479);
    AssertAlmostEqual(&test, rTM, 0.9999999972043471);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997204596723029);
    AssertAlmostEqual(&test, rTM, 0.9999999997204209);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9972081128077699);
    AssertAlmostEqual(&test, rTM, 0.999999999972042);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.972430164567277);
    AssertAlmostEqual(&test, rTM, 0.9999999999972039);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7567845829363016);
    AssertAlmostEqual(&test, rTM, 0.9999999999997177);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1029494263746377);
    AssertAlmostEqual(&test, rTM, 0.9999999999999519);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001276089014522639);
    AssertAlmostEqual(&test, rTM, 0.9999999999999608);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279319331667343e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999999609);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279351738106307e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999999609);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.27935206218106e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999999999609);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999971773065784);
    AssertAlmostEqual(&test, rTM, 0.9999971773094011);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999971771668589);
    AssertAlmostEqual(&test, rTM, 0.9999971774491135);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999997163229658);
    AssertAlmostEqual(&test, rTM, 0.9999971913164536);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999960081130104);
    AssertAlmostEqual(&test, rTM, 0.9999980040545133);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999716326587051);
    AssertAlmostEqual(&test, rTM, 0.9999997191312904);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997177561267038);
    AssertAlmostEqual(&test, rTM, 0.9999999717744514);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9971812835936562);
    AssertAlmostEqual(&test, rTM, 0.9999999971773026);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9721686094275196);
    AssertAlmostEqual(&test, rTM, 0.9999999997177023);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7547710571326052);
    AssertAlmostEqual(&test, rTM, 0.9999999999714932);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.101355558466374);
    AssertAlmostEqual(&test, rTM, 0.9999999999951176);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.00125194048343056);
    AssertAlmostEqual(&test, rTM, 0.9999999999960062);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.255049586343555e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999960161);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.255080774880307e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999960162);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999903347695983);
    AssertAlmostEqual(&test, rTM, 0.999990334769695);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999990334764814);
    AssertAlmostEqual(&test, rTM, 0.9999903347744793);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999903342863996);
    AssertAlmostEqual(&test, rTM, 0.9999903352528696);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999902865639441);
    AssertAlmostEqual(&test, rTM, 0.9999903827361158);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999986331327512);
    AssertAlmostEqual(&test, rTM, 0.9999931656404017);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999028698851563);
    AssertAlmostEqual(&test, rTM, 0.9999990382694484);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9990338909903526);
    AssertAlmostEqual(&test, rTM, 0.999999903352055);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9903813140795321);
    AssertAlmostEqual(&test, rTM, 0.999999990334615);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.907905310445389);
    AssertAlmostEqual(&test, rTM, 0.9999999990323444);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3936136762470601);
    AssertAlmostEqual(&test, rTM, 0.9999999998926525);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0104814003097222);
    AssertAlmostEqual(&test, rTM, 0.9999999999523017);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000107023320179736);
    AssertAlmostEqual(&test, rTM, 0.9999999999532813);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.070460026626172e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999532911);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999519561627236);
    AssertAlmostEqual(&test, rTM, 0.9999519561627284);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999519561624858);
    AssertAlmostEqual(&test, rTM, 0.9999519561629662);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999519561387047);
    AssertAlmostEqual(&test, rTM, 0.9999519561867474);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999519537606519);
    AssertAlmostEqual(&test, rTM, 0.99995195856468);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999517165468885);
    AssertAlmostEqual(&test, rTM, 0.9999521945894526);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999320564298108);
    AssertAlmostEqual(&test, rTM, 0.9999660276378348);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995172703681532);
    AssertAlmostEqual(&test, rTM, 0.999995219355964);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.995206789534171);
    AssertAlmostEqual(&test, rTM, 0.9999995195728358);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9530952853808567);
    AssertAlmostEqual(&test, rTM, 0.9999999519411729);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6212976648977295);
    AssertAlmostEqual(&test, rTM, 0.9999999950588161);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03993086985944962);
    AssertAlmostEqual(&test, rTM, 0.9999999987498325);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004328403284714138);
    AssertAlmostEqual(&test, rTM, 0.9999999988448398);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.332115199222923e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999988458294);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995994585347583);
    AssertAlmostEqual(&test, rTM, 0.9995994585347587);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995994585347385);
    AssertAlmostEqual(&test, rTM, 0.9995994585347786);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995994585327562);
    AssertAlmostEqual(&test, rTM, 0.9995994585367608);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999599458334528);
    AssertAlmostEqual(&test, rTM, 0.999599458734989);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995994385121977);
    AssertAlmostEqual(&test, rTM, 0.9995994785563188);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999597461211484);
    AssertAlmostEqual(&test, rTM, 0.9996014459496585);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994335958248992);
    AssertAlmostEqual(&test, rTM, 0.9997167577936958);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9959818986610083);
    AssertAlmostEqual(&test, rTM, 0.9999601373656802);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9607303575796227);
    AssertAlmostEqual(&test, rTM, 0.9999959931877275);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6716687229263597);
    AssertAlmostEqual(&test, rTM, 0.9999995914202754);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05557345687175928);
    AssertAlmostEqual(&test, rTM, 0.9999999103068666);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006222864841224322);
    AssertAlmostEqual(&test, rTM, 0.9999999196511929);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.230539246481534e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999197501308);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960902135376086);
    AssertAlmostEqual(&test, rTM, 0.9960902135376087);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960902135376067);
    AssertAlmostEqual(&test, rTM, 0.9960902135376106);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960902135374136);
    AssertAlmostEqual(&test, rTM, 0.9960902135378038);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.996090213518098);
    AssertAlmostEqual(&test, rTM, 0.9960902135571194);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960902115865451);
    AssertAlmostEqual(&test, rTM, 0.9960902154886714);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960900184360915);
    AssertAlmostEqual(&test, rTM, 0.9960904086294098);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960707516207764);
    AssertAlmostEqual(&test, rTM, 0.996109579245716);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9944752111970168);
    AssertAlmostEqual(&test, rTM, 0.9972337743118063);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9613974606664578);
    AssertAlmostEqual(&test, rTM, 0.9996102009068103);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6775297823443511);
    AssertAlmostEqual(&test, rTM, 0.9999600839366958);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05784156596710271);
    AssertAlmostEqual(&test, rTM, 0.9999913846969479);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006507694494160635);
    AssertAlmostEqual(&test, rTM, 0.999992316849775);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.516087931785651e-06);
    AssertAlmostEqual(&test, rTM, 0.9999923267431539);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616716943184992);
    AssertAlmostEqual(&test, rTM, 0.9616716943184992);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.961671694318499);
    AssertAlmostEqual(&test, rTM, 0.9616716943184994);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616716943184804);
    AssertAlmostEqual(&test, rTM, 0.961671694318518);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616716943166203);
    AssertAlmostEqual(&test, rTM, 0.9616716943203781);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616716941306021);
    AssertAlmostEqual(&test, rTM, 0.9616716945063963);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616716755287918);
    AssertAlmostEqual(&test, rTM, 0.9616717131081975);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616698153960996);
    AssertAlmostEqual(&test, rTM, 0.9616735731505947);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9614842830471968);
    AssertAlmostEqual(&test, rTM, 0.9618582114092465);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9462324651838999);
    AssertAlmostEqual(&test, rTM, 0.9727396793627803);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.676844624946098);
    AssertAlmostEqual(&test, rTM, 0.9960459826289628);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05807352294817291);
    AssertAlmostEqual(&test, rTM, 0.9991427070922717);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006537611675067433);
    AssertAlmostEqual(&test, rTM, 0.9992357798975066);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546088915565393e-06);
    AssertAlmostEqual(&test, rTM, 0.9992367681099664);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6782005655647596);
    AssertAlmostEqual(&test, rTM, 0.6782005655647596);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6782005655647596);
    AssertAlmostEqual(&test, rTM, 0.6782005655647596);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6782005655647584);
    AssertAlmostEqual(&test, rTM, 0.6782005655647609);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6782005655646296);
    AssertAlmostEqual(&test, rTM, 0.6782005655648897);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.678200565551755);
    AssertAlmostEqual(&test, rTM, 0.6782005655777643);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.678200564264292);
    AssertAlmostEqual(&test, rTM, 0.6782005668652273);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6782004355180385);
    AssertAlmostEqual(&test, rTM, 0.6782006956114383);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.678187561349761);
    AssertAlmostEqual(&test, rTM, 0.6782135693550282);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.676904691657316);
    AssertAlmostEqual(&test, rTM, 0.6794922353700857);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5793707402578565);
    AssertAlmostEqual(&test, rTM, 0.7573768013257771);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05758987166609775);
    AssertAlmostEqual(&test, rTM, 0.9207444381466187);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006539972568719639);
    AssertAlmostEqual(&test, rTM, 0.9289803251465715);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549097738098406e-06);
    AssertAlmostEqual(&test, rTM, 0.9290689693506349);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810489014005663);
    AssertAlmostEqual(&test, rTM, 0.05810489014005663);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810489014005663);
    AssertAlmostEqual(&test, rTM, 0.05810489014005663);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810489014005663);
    AssertAlmostEqual(&test, rTM, 0.05810489014005664);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810489014005611);
    AssertAlmostEqual(&test, rTM, 0.05810489014005715);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810489014000491);
    AssertAlmostEqual(&test, rTM, 0.05810489014010835);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0581048901348843);
    AssertAlmostEqual(&test, rTM, 0.05810489014522897);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810488962282331);
    AssertAlmostEqual(&test, rTM, 0.05810489065728996);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810483841676955);
    AssertAlmostEqual(&test, rTM, 0.0581049418633434);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05809971826867312);
    AssertAlmostEqual(&test, rTM, 0.05811006200832121);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05759223563547784);
    AssertAlmostEqual(&test, rTM, 0.0586175140013722);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03076359202774576);
    AssertAlmostEqual(&test, rTM, 0.08535929875011761);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006476248792219675);
    AssertAlmostEqual(&test, rTM, 0.1151797699380199);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.548751103976019e-06);
    AssertAlmostEqual(&test, rTM, 0.1158122946046893);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000654095670572282);
    AssertAlmostEqual(&test, rTM, 0.000654095670572282);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000654095670572282);
    AssertAlmostEqual(&test, rTM, 0.000654095670572282);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000654095670572282);
    AssertAlmostEqual(&test, rTM, 0.000654095670572282);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540956705722819);
    AssertAlmostEqual(&test, rTM, 0.000654095670572282);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540956705722754);
    AssertAlmostEqual(&test, rTM, 0.0006540956705722885);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540956705716288);
    AssertAlmostEqual(&test, rTM, 0.0006540956705729352);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540956705069579);
    AssertAlmostEqual(&test, rTM, 0.000654095670637606);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540956640398765);
    AssertAlmostEqual(&test, rTM, 0.0006540956771046874);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540950173323868);
    AssertAlmostEqual(&test, rTM, 0.0006540963238121772);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540303530407375);
    AssertAlmostEqual(&test, rTM, 0.0006541609881038209);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006476278586863368);
    AssertAlmostEqual(&test, rTM, 0.0006605634824035021);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003272617908175133);
    AssertAlmostEqual(&test, rTM, 0.0009809294105855479);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.484591078989737e-06);
    AssertAlmostEqual(&test, rTM, 0.001301706201410212);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549439157379002e-06);
    AssertAlmostEqual(&test, rTM, 6.549439157379002e-06);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549439157379002e-06);
    AssertAlmostEqual(&test, rTM, 6.549439157379002e-06);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549439157379002e-06);
    AssertAlmostEqual(&test, rTM, 6.549439157379002e-06);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549439157379002e-06);
    AssertAlmostEqual(&test, rTM, 6.549439157379002e-06);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549439157379002e-06);
    AssertAlmostEqual(&test, rTM, 6.549439157379003e-06);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549439157378937e-06);
    AssertAlmostEqual(&test, rTM, 6.549439157379068e-06);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549439157372453e-06);
    AssertAlmostEqual(&test, rTM, 6.549439157385552e-06);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549439156724067e-06);
    AssertAlmostEqual(&test, rTM, 6.549439158033938e-06);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54943909188547e-06);
    AssertAlmostEqual(&test, rTM, 6.549439222872536e-06);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549432608032184e-06);
    AssertAlmostEqual(&test, rTM, 6.549445706725821e-06);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.548784287528367e-06);
    AssertAlmostEqual(&test, rTM, 6.550094027229639e-06);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.484594066121339e-06);
    AssertAlmostEqual(&test, rTM, 6.61428424863661e-06);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.274741026301256e-06);
    AssertAlmostEqual(&test, rTM, 9.824137288316281e-06);

    userdata[0] = 10/CAPS_HBAR_EV; /* 10eV */
    userdata[1] = 0.001/CAPS_HBAR_EV; /* 0.001eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999996046535182);
    AssertAlmostEqual(&test, rTM, 0.9999998023267396);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999997190538771);
    AssertAlmostEqual(&test, rTM, 0.9999999721835136);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999720437697144);
    AssertAlmostEqual(&test, rTM, 0.9999999972046174);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999720486698828);
    AssertAlmostEqual(&test, rTM, 0.999999999720448);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9972083823934692);
    AssertAlmostEqual(&test, rTM, 0.9999999999720447);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9724327931884105);
    AssertAlmostEqual(&test, rTM, 0.9999999999972042);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7568048451795845);
    AssertAlmostEqual(&test, rTM, 0.9999999999997178);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1029656209569051);
    AssertAlmostEqual(&test, rTM, 0.9999999999999519);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001276335205310115);
    AssertAlmostEqual(&test, rTM, 0.9999999999999608);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279566770174752e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999999609);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279599189150777e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999999609);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279599513350907e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999999999609);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279599516592909e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999999999609);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999991115616876);
    AssertAlmostEqual(&test, rTM, 0.9999991203581027);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999987497941957);
    AssertAlmostEqual(&test, rTM, 0.9999993748969025);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999911156523958);
    AssertAlmostEqual(&test, rTM, 0.9999999120357754);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999115965323369);
    AssertAlmostEqual(&test, rTM, 0.9999999911601465);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991163606714282);
    AssertAlmostEqual(&test, rTM, 0.9999999991159708);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.991198693462591);
    AssertAlmostEqual(&test, rTM, 0.9999999999115962);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9154182683838561);
    AssertAlmostEqual(&test, rTM, 0.9999999999911511);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4242154357919069);
    AssertAlmostEqual(&test, rTM, 0.9999999999990334);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01247842060860452);
    AssertAlmostEqual(&test, rTM, 0.9999999999995993);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001279249658356818);
    AssertAlmostEqual(&test, rTM, 0.9999999999996091);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279573742484986e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999996092);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.27957698436285e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999996092);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279577016781733e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999999996092);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999991151194048);
    AssertAlmostEqual(&test, rTM, 0.9999911512028967);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999911507560453);
    AssertAlmostEqual(&test, rTM, 0.9999911516408773);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999911070647214);
    AssertAlmostEqual(&test, rTM, 0.9999911951131979);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999874859278028);
    AssertAlmostEqual(&test, rTM, 0.999993742944326);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999110742059516);
    AssertAlmostEqual(&test, rTM, 0.9999991195078303);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991154631514827);
    AssertAlmostEqual(&test, rTM, 0.9999999115160125);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.991190219316938);
    AssertAlmostEqual(&test, rTM, 0.9999999911510772);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9153401240024595);
    AssertAlmostEqual(&test, rTM, 0.9999999991142503);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4238840386404791);
    AssertAlmostEqual(&test, rTM, 0.9999999999032374);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01245492462675385);
    AssertAlmostEqual(&test, rTM, 0.9999999999598614);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000127678079513639);
    AssertAlmostEqual(&test, rTM, 0.999999999960839);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.277103629434252e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999608489);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.277106858807823e-08);
    AssertAlmostEqual(&test, rTM, 0.999999999960849);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999717734382962);
    AssertAlmostEqual(&test, rTM, 0.9999717734385785);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999717734243243);
    AssertAlmostEqual(&test, rTM, 0.9999717734525504);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999717720271645);
    AssertAlmostEqual(&test, rTM, 0.9999717748496397);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999716326587051);
    AssertAlmostEqual(&test, rTM, 0.9999719135195262);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999960081847181);
    AssertAlmostEqual(&test, rTM, 0.9999800407244022);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997163627970265);
    AssertAlmostEqual(&test, rTM, 0.9999971913164259);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9971811442677116);
    AssertAlmostEqual(&test, rTM, 0.9999997177442718);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9721685958454004);
    AssertAlmostEqual(&test, rTM, 0.9999999717702435);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7547710560883619);
    AssertAlmostEqual(&test, rTM, 0.99999999714933);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1013555584581867);
    AssertAlmostEqual(&test, rTM, 0.9999999995117549);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001251940483429324);
    AssertAlmostEqual(&test, rTM, 0.9999999996006206);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.255049586343543e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999996016093);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.255080774880307e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999996016192);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999033519001411);
    AssertAlmostEqual(&test, rTM, 0.9999033519001508);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999033518996627);
    AssertAlmostEqual(&test, rTM, 0.9999033519006292);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999033518518242);
    AssertAlmostEqual(&test, rTM, 0.9999033519484676);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999033470680952);
    AssertAlmostEqual(&test, rTM, 0.9999033567319551);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999028698851563);
    AssertAlmostEqual(&test, rTM, 0.9999038315232176);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998633216823868);
    AssertAlmostEqual(&test, rTM, 0.9999316585058337);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999029123321052);
    AssertAlmostEqual(&test, rTM, 0.999990382735004);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9903808402678071);
    AssertAlmostEqual(&test, rTM, 0.999999033509799);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9079052670590105);
    AssertAlmostEqual(&test, rTM, 0.9999999032344851);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3936136745515031);
    AssertAlmostEqual(&test, rTM, 0.9999999892652579);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01048140030870607);
    AssertAlmostEqual(&test, rTM, 0.9999999952301691);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001070233201796301);
    AssertAlmostEqual(&test, rTM, 0.9999999953281211);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.070460026626162e-06);
    AssertAlmostEqual(&test, rTM, 0.999999995329111);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995196654879897);
    AssertAlmostEqual(&test, rTM, 0.9995196654879901);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995196654879659);
    AssertAlmostEqual(&test, rTM, 0.9995196654880139);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995196654855888);
    AssertAlmostEqual(&test, rTM, 0.999519665490391);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995196652478804);
    AssertAlmostEqual(&test, rTM, 0.9995196657280992);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995196414776343);
    AssertAlmostEqual(&test, rTM, 0.9995196894971456);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995172703681532);
    AssertAlmostEqual(&test, rTM, 0.9995220487269985);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993207720081969);
    AssertAlmostEqual(&test, rTM, 0.9996603283058727);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9951831810707509);
    AssertAlmostEqual(&test, rTM, 0.9999521944528841);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9530930194175289);
    AssertAlmostEqual(&test, rTM, 0.999995194366729);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6212975212264453);
    AssertAlmostEqual(&test, rTM, 0.9999995058819905);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03993086949449236);
    AssertAlmostEqual(&test, rTM, 0.9999998749832638);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004328403284285997);
    AssertAlmostEqual(&test, rTM, 0.9999998844839966);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.332115199218634e-06);
    AssertAlmostEqual(&test, rTM, 0.9999998845829533);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960017997894189);
    AssertAlmostEqual(&test, rTM, 0.9960017997894189);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960017997894169);
    AssertAlmostEqual(&test, rTM, 0.9960017997894209);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960017997892194);
    AssertAlmostEqual(&test, rTM, 0.9960017997896184);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.996001799769468);
    AssertAlmostEqual(&test, rTM, 0.9960017998093699);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960017977943237);
    AssertAlmostEqual(&test, rTM, 0.9960018017845131);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960016002848565);
    AssertAlmostEqual(&test, rTM, 0.9960019992840468);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9959818986610083);
    AssertAlmostEqual(&test, rTM, 0.9960216025466188);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.994350380540905);
    AssertAlmostEqual(&test, rTM, 0.9971711835179783);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.960540373076947);
    AssertAlmostEqual(&test, rTM, 0.9996013668068183);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6716556631259593);
    AssertAlmostEqual(&test, rTM, 0.9999591449603746);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05557340764718825);
    AssertAlmostEqual(&test, rTM, 0.9999910307629954);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006222864779694587);
    AssertAlmostEqual(&test, rTM, 0.9999919651831725);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.230539245864719e-06);
    AssertAlmostEqual(&test, rTM, 0.999991975076831);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9615852857967336);
    AssertAlmostEqual(&test, rTM, 0.9615852857967336);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9615852857967334);
    AssertAlmostEqual(&test, rTM, 0.9615852857967337);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9615852857967148);
    AssertAlmostEqual(&test, rTM, 0.9615852857967524);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9615852857948505);
    AssertAlmostEqual(&test, rTM, 0.9615852857986167);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9615852856084215);
    AssertAlmostEqual(&test, rTM, 0.9615852859850457);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9615852669655287);
    AssertAlmostEqual(&test, rTM, 0.9615853046279293);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9615834027246973);
    AssertAlmostEqual(&test, rTM, 0.9615871687782745);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9613974606664578);
    AssertAlmostEqual(&test, rTM, 0.9617722148537505);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9461122521838218);
    AssertAlmostEqual(&test, rTM, 0.9726778516531526);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6762450372613528);
    AssertAlmostEqual(&test, rTM, 0.9960365773317024);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05783646632503714);
    AssertAlmostEqual(&test, rTM, 0.9991391725741638);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006507688059929377);
    AssertAlmostEqual(&test, rTM, 0.9992322685597081);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.516087867277221e-06);
    AssertAlmostEqual(&test, rTM, 0.9992332567699483);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6781406715081518);
    AssertAlmostEqual(&test, rTM, 0.6781406715081518);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6781406715081518);
    AssertAlmostEqual(&test, rTM, 0.6781406715081518);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6781406715081505);
    AssertAlmostEqual(&test, rTM, 0.6781406715081532);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6781406715080218);
    AssertAlmostEqual(&test, rTM, 0.6781406715082819);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6781406714951455);
    AssertAlmostEqual(&test, rTM, 0.6781406715211583);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6781406702075106);
    AssertAlmostEqual(&test, rTM, 0.6781406728087931);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6781405414440712);
    AssertAlmostEqual(&test, rTM, 0.67814080157219);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6781276655572938);
    AssertAlmostEqual(&test, rTM, 0.6781536770342678);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.676844624946098);
    AssertAlmostEqual(&test, rTM, 0.6794325138501163);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5792996766992881);
    AssertAlmostEqual(&test, rTM, 0.7573278352224876);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05756624267702896);
    AssertAlmostEqual(&test, rTM, 0.9207142778492156);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006536965361765717);
    AssertAlmostEqual(&test, rTM, 0.9289499751584115);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546082435028693e-06);
    AssertAlmostEqual(&test, rTM, 0.929038615098604);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810250758014587);
    AssertAlmostEqual(&test, rTM, 0.05810250758014587);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810250758014587);
    AssertAlmostEqual(&test, rTM, 0.05810250758014587);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810250758014587);
    AssertAlmostEqual(&test, rTM, 0.05810250758014587);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810250758014535);
    AssertAlmostEqual(&test, rTM, 0.05810250758014639);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810250758009415);
    AssertAlmostEqual(&test, rTM, 0.0581025075801976);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810250757497373);
    AssertAlmostEqual(&test, rTM, 0.05810250758531802);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810250706293128);
    AssertAlmostEqual(&test, rTM, 0.05810250809736046);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810245585873238);
    AssertAlmostEqual(&test, rTM, 0.05810255930155905);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05809733589610714);
    AssertAlmostEqual(&test, rTM, 0.05810767926106602);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05758987166609776);
    AssertAlmostEqual(&test, rTM, 0.05861511285441796);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03076225953744343);
    AssertAlmostEqual(&test, rTM, 0.08535587635934319);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006475950860860071);
    AssertAlmostEqual(&test, rTM, 0.1151750815018342);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.548449450742529e-06);
    AssertAlmostEqual(&test, rTM, 0.1158075777667452);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540926613911466);
    AssertAlmostEqual(&test, rTM, 0.0006540926613911466);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540926613911466);
    AssertAlmostEqual(&test, rTM, 0.0006540926613911466);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540926613911466);
    AssertAlmostEqual(&test, rTM, 0.0006540926613911466);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540926613911466);
    AssertAlmostEqual(&test, rTM, 0.0006540926613911467);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540926613911401);
    AssertAlmostEqual(&test, rTM, 0.0006540926613911532);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540926613904934);
    AssertAlmostEqual(&test, rTM, 0.0006540926613917998);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540926613258229);
    AssertAlmostEqual(&test, rTM, 0.0006540926614564704);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540926548587713);
    AssertAlmostEqual(&test, rTM, 0.000654092667923522);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540920081542528);
    AssertAlmostEqual(&test, rTM, 0.0006540933146280405);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540273441597038);
    AssertAlmostEqual(&test, rTM, 0.0006541579786225838);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006476248792219677);
    AssertAlmostEqual(&test, rTM, 0.0006605604435056013);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003272602842581755);
    AssertAlmostEqual(&test, rTM, 0.0009809248987845429);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.484561207825078e-06);
    AssertAlmostEqual(&test, rTM, 0.001301700212926678);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549436140376868e-06);
    AssertAlmostEqual(&test, rTM, 6.549436140376868e-06);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549436140376868e-06);
    AssertAlmostEqual(&test, rTM, 6.549436140376868e-06);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549436140376868e-06);
    AssertAlmostEqual(&test, rTM, 6.549436140376868e-06);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549436140376868e-06);
    AssertAlmostEqual(&test, rTM, 6.549436140376868e-06);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549436140376867e-06);
    AssertAlmostEqual(&test, rTM, 6.549436140376868e-06);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549436140376801e-06);
    AssertAlmostEqual(&test, rTM, 6.549436140376933e-06);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549436140370317e-06);
    AssertAlmostEqual(&test, rTM, 6.549436140383417e-06);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549436139721932e-06);
    AssertAlmostEqual(&test, rTM, 6.549436141031802e-06);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549436074883364e-06);
    AssertAlmostEqual(&test, rTM, 6.54943620587037e-06);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549429591033065e-06);
    AssertAlmostEqual(&test, rTM, 6.549442689720669e-06);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.548781270827893e-06);
    AssertAlmostEqual(&test, rTM, 6.550091009925841e-06);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.484591078989737e-06);
    AssertAlmostEqual(&test, rTM, 6.614281201763942e-06);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.274739517780429e-06);
    AssertAlmostEqual(&test, rTM, 9.824132762832838e-06);

    userdata[0] = 10/CAPS_HBAR_EV; /* 10eV */
    userdata[1] = 0.003/CAPS_HBAR_EV; /* 0.003eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999999315240352);
    AssertAlmostEqual(&test, rTM, 0.9999996576201174);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999951338785824);
    AssertAlmostEqual(&test, rTM, 0.999999951820464);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999515789157781);
    AssertAlmostEqual(&test, rTM, 0.9999999951582585);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995159186115137);
    AssertAlmostEqual(&test, rTM, 0.9999999995158019);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9951697246250354);
    AssertAlmostEqual(&test, rTM, 0.9999999999515801);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9527382167639208);
    AssertAlmostEqual(&test, rTM, 0.9999999999951567);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6190377937839457);
    AssertAlmostEqual(&test, rTM, 0.9999999999995018);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03936164359493117);
    AssertAlmostEqual(&test, rTM, 0.9999999999998732);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004261702532566128);
    AssertAlmostEqual(&test, rTM, 0.9999999999998826);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.265300891810416e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999998828);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.265336913764603e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999998828);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.265337273987986e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999999998828);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.26533727759022e-12);
    AssertAlmostEqual(&test, rTM, 0.9999999999998828);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999984611902253);
    AssertAlmostEqual(&test, rTM, 0.9999984764259541);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999978345951198);
    AssertAlmostEqual(&test, rTM, 0.9999989172969738);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999846120088098);
    AssertAlmostEqual(&test, rTM, 0.9999998476424909);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998468866542579);
    AssertAlmostEqual(&test, rTM, 0.9999999846890243);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.998469996901394);
    AssertAlmostEqual(&test, rTM, 0.9999999984688261);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9848050345880388);
    AssertAlmostEqual(&test, rTM, 0.9999999998468782);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8581569848496756);
    AssertAlmostEqual(&test, rTM, 0.9999999999846435);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2438650140594961);
    AssertAlmostEqual(&test, rTM, 0.9999999999980717);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.004229309916683848);
    AssertAlmostEqual(&test, rTM, 0.9999999999988178);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.264948458823696e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999988276);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.265308639231812e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999988277);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.26531224141992e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999999988277);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.265312277441839e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999999988277);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999846834331607);
    AssertAlmostEqual(&test, rTM, 0.9999846834484771);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999846826750161);
    AssertAlmostEqual(&test, rTM, 0.9999846842065836);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999846070491166);
    AssertAlmostEqual(&test, rTM, 0.9999847594534096);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999783391829896);
    AssertAlmostEqual(&test, rTM, 0.999989169532845);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998460811533115);
    AssertAlmostEqual(&test, rTM, 0.9999984759348841);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9984694284414071);
    AssertAlmostEqual(&test, rTM, 0.9999998468408597);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9848001671105663);
    AssertAlmostEqual(&test, rTM, 0.9999999846828821);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8581147574738499);
    AssertAlmostEqual(&test, rTM, 0.9999999984638474);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2437694772091057);
    AssertAlmostEqual(&test, rTM, 0.9999999998070767);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.00422660785908485);
    AssertAlmostEqual(&test, rTM, 0.999999999881704);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.262200735126907e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999998826897);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.262560451572351e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999998826996);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.262564049120091e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999998826997);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999514239499905);
    AssertAlmostEqual(&test, rTM, 0.9999514239504762);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999514239259458);
    AssertAlmostEqual(&test, rTM, 0.9999514239745207);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999514215215505);
    AssertAlmostEqual(&test, rTM, 0.9999514263787946);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999511816800818);
    AssertAlmostEqual(&test, rTM, 0.9999516650181024);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999313037827471);
    AssertAlmostEqual(&test, rTM, 0.9999656513014469);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995119240369316);
    AssertAlmostEqual(&test, rTM, 0.9999951663965332);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9951538197425138);
    AssertAlmostEqual(&test, rTM, 0.9999995142506759);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.952588294227574);
    AssertAlmostEqual(&test, rTM, 0.9999999514084692);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6180916299368012);
    AssertAlmostEqual(&test, rTM, 0.9999999950010428);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03912616220679284);
    AssertAlmostEqual(&test, rTM, 0.999999998724039);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004234154117479432);
    AssertAlmostEqual(&test, rTM, 0.9999999988191268);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.237706091759148e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999988201164);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.237741649124227e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999988201262);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998419883802633);
    AssertAlmostEqual(&test, rTM, 0.999841988380279);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998419883794811);
    AssertAlmostEqual(&test, rTM, 0.9998419883810611);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998419883012716);
    AssertAlmostEqual(&test, rTM, 0.9998419884592706);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998419804805119);
    AssertAlmostEqual(&test, rTM, 0.9998419962796354);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998412003500827);
    AssertAlmostEqual(&test, rTM, 0.9998427725002321);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997765451376868);
    AssertAlmostEqual(&test, rTM, 0.9998882663262878);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9984131379651795);
    AssertAlmostEqual(&test, rTM, 0.999984276132615);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9843211766384765);
    AssertAlmostEqual(&test, rTM, 0.9999984197898859);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8539691393424228);
    AssertAlmostEqual(&test, rTM, 0.9999998414834901);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2346007450760938);
    AssertAlmostEqual(&test, rTM, 0.999999979860199);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.003972791069306453);
    AssertAlmostEqual(&test, rTM, 0.9999999874145885);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.004225621643354e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999875131913);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.00454311009081e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999875141813);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993779952411924);
    AssertAlmostEqual(&test, rTM, 0.999377995241193);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993779952411617);
    AssertAlmostEqual(&test, rTM, 0.9993779952412238);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993779952380837);
    AssertAlmostEqual(&test, rTM, 0.9993779952443018);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993779949302871);
    AssertAlmostEqual(&test, rTM, 0.9993779955520982);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993779641514078);
    AssertAlmostEqual(&test, rTM, 0.9993780263294243);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993748939237559);
    AssertAlmostEqual(&test, rTM, 0.9993810811769321);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991204657796154);
    AssertAlmostEqual(&test, rTM, 0.9995601361284234);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9937665040725735);
    AssertAlmostEqual(&test, rTM, 0.9999380905756214);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9396828005895488);
    AssertAlmostEqual(&test, rTM, 0.9999937753377878);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.541953146454444);
    AssertAlmostEqual(&test, rTM, 0.9999993483885213);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02457697186525093);
    AssertAlmostEqual(&test, rTM, 0.9999997966804516);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002581773203975124);
    AssertAlmostEqual(&test, rTM, 0.9999998063347048);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.583093486456728e-06);
    AssertAlmostEqual(&test, rTM, 0.9999998064336789);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9958120411189247);
    AssertAlmostEqual(&test, rTM, 0.9958120411189249);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9958120411189227);
    AssertAlmostEqual(&test, rTM, 0.9958120411189268);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9958120411187158);
    AssertAlmostEqual(&test, rTM, 0.9958120411191338);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9958120410980289);
    AssertAlmostEqual(&test, rTM, 0.9958120411398207);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9958120390293398);
    AssertAlmostEqual(&test, rTM, 0.9958120432085087);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9958118321656215);
    AssertAlmostEqual(&test, rTM, 0.9958122500618251);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9957911974624619);
    AssertAlmostEqual(&test, rTM, 0.995832781764885);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9940824773433514);
    AssertAlmostEqual(&test, rTM, 0.997036842024432);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9587031909474285);
    AssertAlmostEqual(&test, rTM, 0.999582403372718);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6592346369026726);
    AssertAlmostEqual(&test, rTM, 0.9999571215985529);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05112041035000849);
    AssertAlmostEqual(&test, rTM, 0.9999902448313408);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005671263311903239);
    AssertAlmostEqual(&test, rTM, 0.9999911837028006);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.67763701827458e-06);
    AssertAlmostEqual(&test, rTM, 0.9999911935969991);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9613940008985947);
    AssertAlmostEqual(&test, rTM, 0.9613940008985947);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9613940008985945);
    AssertAlmostEqual(&test, rTM, 0.9613940008985949);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9613940008985759);
    AssertAlmostEqual(&test, rTM, 0.9613940008986137);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9613940008967025);
    AssertAlmostEqual(&test, rTM, 0.9613940009004871);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9613940007093642);
    AssertAlmostEqual(&test, rTM, 0.9613940010878254);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9613939819755399);
    AssertAlmostEqual(&test, rTM, 0.9613940198216405);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9613921086418024);
    AssertAlmostEqual(&test, rTM, 0.9613958930644688);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9612052597385256);
    AssertAlmostEqual(&test, rTM, 0.9615818417974447);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9458461496737238);
    AssertAlmostEqual(&test, rTM, 0.9725409757981006);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6749195915653309);
    AssertAlmostEqual(&test, rTM, 0.9960157458290312);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05731656314819244);
    AssertAlmostEqual(&test, rTM, 0.9991313188667088);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006442161998431739);
    AssertAlmostEqual(&test, rTM, 0.9992244656752716);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.450393486349867e-06);
    AssertAlmostEqual(&test, rTM, 0.9992254538804825);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6780076436899776);
    AssertAlmostEqual(&test, rTM, 0.6780076436899776);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6780076436899776);
    AssertAlmostEqual(&test, rTM, 0.6780076436899776);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6780076436899762);
    AssertAlmostEqual(&test, rTM, 0.6780076436899788);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6780076436898475);
    AssertAlmostEqual(&test, rTM, 0.6780076436901077);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6780076436769673);
    AssertAlmostEqual(&test, rTM, 0.6780076437029878);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6780076423889508);
    AssertAlmostEqual(&test, rTM, 0.6780076449910043);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6780075135873513);
    AssertAlmostEqual(&test, rTM, 0.6780077737925613);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6779946338847714);
    AssertAlmostEqual(&test, rTM, 0.678020653070415);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6767112137617135);
    AssertAlmostEqual(&test, rTM, 0.6792998691369346);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5791418515671607);
    AssertAlmostEqual(&test, rTM, 0.757219072269589);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05751380339978292);
    AssertAlmostEqual(&test, rTM, 0.9206472626263694);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006530292570876386);
    AssertAlmostEqual(&test, rTM, 0.928882537839769);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.539391692228123e-06);
    AssertAlmostEqual(&test, rTM, 0.9289711683059249);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05809721370442032);
    AssertAlmostEqual(&test, rTM, 0.05809721370442032);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05809721370442032);
    AssertAlmostEqual(&test, rTM, 0.05809721370442032);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05809721370442032);
    AssertAlmostEqual(&test, rTM, 0.05809721370442032);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0580972137044198);
    AssertAlmostEqual(&test, rTM, 0.05809721370442084);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0580972137043686);
    AssertAlmostEqual(&test, rTM, 0.05809721370447204);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05809721369924859);
    AssertAlmostEqual(&test, rTM, 0.05809721370959205);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05809721318724736);
    AssertAlmostEqual(&test, rTM, 0.05809721422159328);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05809716198716988);
    AssertAlmostEqual(&test, rTM, 0.05809726542167044);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.058092042436655);
    AssertAlmostEqual(&test, rTM, 0.05810238496906785);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0575846190978614);
    AssertAlmostEqual(&test, rTM, 0.05860977767895065);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03075929886150442);
    AssertAlmostEqual(&test, rTM, 0.08534827203083621);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000647528888930339);
    AssertAlmostEqual(&test, rTM, 0.1151646641211738);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.547779209708295e-06);
    AssertAlmostEqual(&test, rTM, 0.1157970972801166);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540859744210845);
    AssertAlmostEqual(&test, rTM, 0.0006540859744210845);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540859744210845);
    AssertAlmostEqual(&test, rTM, 0.0006540859744210845);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540859744210845);
    AssertAlmostEqual(&test, rTM, 0.0006540859744210845);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540859744210844);
    AssertAlmostEqual(&test, rTM, 0.0006540859744210846);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000654085974421078);
    AssertAlmostEqual(&test, rTM, 0.000654085974421091);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540859744204313);
    AssertAlmostEqual(&test, rTM, 0.0006540859744217377);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540859743557614);
    AssertAlmostEqual(&test, rTM, 0.0006540859744864076);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540859678887759);
    AssertAlmostEqual(&test, rTM, 0.0006540859809533933);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.00065408532119086);
    AssertAlmostEqual(&test, rTM, 0.000654086627651309);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540206578565244);
    AssertAlmostEqual(&test, rTM, 0.0006541512909856391);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006476182582881862);
    AssertAlmostEqual(&test, rTM, 0.0006605536904992602);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003272569363981968);
    AssertAlmostEqual(&test, rTM, 0.0009809148727086812);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.484494828444453e-06);
    AssertAlmostEqual(&test, rTM, 0.001301686905382761);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549429435937629e-06);
    AssertAlmostEqual(&test, rTM, 6.549429435937629e-06);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549429435937629e-06);
    AssertAlmostEqual(&test, rTM, 6.549429435937629e-06);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549429435937629e-06);
    AssertAlmostEqual(&test, rTM, 6.549429435937629e-06);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549429435937629e-06);
    AssertAlmostEqual(&test, rTM, 6.549429435937629e-06);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549429435937628e-06);
    AssertAlmostEqual(&test, rTM, 6.54942943593763e-06);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549429435937563e-06);
    AssertAlmostEqual(&test, rTM, 6.549429435937694e-06);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549429435931079e-06);
    AssertAlmostEqual(&test, rTM, 6.549429435944178e-06);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549429435282694e-06);
    AssertAlmostEqual(&test, rTM, 6.549429436592563e-06);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549429370444193e-06);
    AssertAlmostEqual(&test, rTM, 6.549429501431065e-06);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549422886600532e-06);
    AssertAlmostEqual(&test, rTM, 6.549435985274726e-06);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.548774567059014e-06);
    AssertAlmostEqual(&test, rTM, 6.550084304816243e-06);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.484584440929364e-06);
    AssertAlmostEqual(&test, rTM, 6.614274430945839e-06);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.274736165516899e-06);
    AssertAlmostEqual(&test, rTM, 9.82412270621789e-06);

    userdata[0] = 10/CAPS_HBAR_EV; /* 10eV */
    userdata[1] = 0.035/CAPS_HBAR_EV; /* 0.035eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999976611031643);
    AssertAlmostEqual(&test, rTM, 0.9999988305508983);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999833791337743);
    AssertAlmostEqual(&test, rTM, 0.999999835435614);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998346202331698);
    AssertAlmostEqual(&test, rTM, 0.9999999834623094);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9983475144747018);
    AssertAlmostEqual(&test, rTM, 0.9999999983461485);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.983597678280366);
    AssertAlmostEqual(&test, rTM, 0.9999999998346092);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.84772645945361);
    AssertAlmostEqual(&test, rTM, 0.9999999999834051);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2215488748060495);
    AssertAlmostEqual(&test, rTM, 0.9999999999978539);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.003629514668034383);
    AssertAlmostEqual(&test, rTM, 0.9999999999986224);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.655738254590529e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999986323);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.656002884419129e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999986324);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.656005530959261e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999999986324);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.656005557424686e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999999986324);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.656005557689341e-13);
    AssertAlmostEqual(&test, rTM, 0.9999999999986324);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999947439894168);
    AssertAlmostEqual(&test, rTM, 0.9999947960289901);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999926037756319);
    AssertAlmostEqual(&test, rTM, 0.9999963018809779);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999474411373106);
    AssertAlmostEqual(&test, rTM, 0.9999994796016801);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994771166334199);
    AssertAlmostEqual(&test, rTM, 0.9999999477032169);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9947837159054874);
    AssertAlmostEqual(&test, rTM, 0.999999994770045);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9490503374875016);
    AssertAlmostEqual(&test, rTM, 0.9999999994768273);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5961816931427033);
    AssertAlmostEqual(&test, rTM, 0.999999999945942);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03410855111456659);
    AssertAlmostEqual(&test, rTM, 0.9999999999853579);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003653332889192066);
    AssertAlmostEqual(&test, rTM, 0.9999999999863138);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.655976988476367e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999863237);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.656003453631209e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999863238);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.656003718285175e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999999863238);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.656003720931716e-12);
    AssertAlmostEqual(&test, rTM, 0.9999999999863238);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999477004989719);
    AssertAlmostEqual(&test, rTM, 0.9999477005512699);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999476979102809);
    AssertAlmostEqual(&test, rTM, 0.9999477031398302);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999474396850968);
    AssertAlmostEqual(&test, rTM, 0.9999479600707132);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999260381744695);
    AssertAlmostEqual(&test, rTM, 0.9999630184034028);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994745211559339);
    AssertAlmostEqual(&test, rTM, 0.9999947958850236);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9947833146201699);
    AssertAlmostEqual(&test, rTM, 0.9999994770160717);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9490489419395279);
    AssertAlmostEqual(&test, rTM, 0.9999999476813052);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5961733566630992);
    AssertAlmostEqual(&test, rTM, 0.9999999945940445);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0341067906154985);
    AssertAlmostEqual(&test, rTM, 0.9999999985357216);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000365313115479786);
    AssertAlmostEqual(&test, rTM, 0.9999999986313113);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.655774962004615e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999986323009);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.655801424234677e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999986323108);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.655801688859395e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999986323109);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998345823589481);
    AssertAlmostEqual(&test, rTM, 0.9998345823606021);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998345822770731);
    AssertAlmostEqual(&test, rTM, 0.999834582442477);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998345740897839);
    AssertAlmostEqual(&test, rTM, 0.9998345906293528);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998337573976034);
    AssertAlmostEqual(&test, rTM, 0.9998354032284921);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997660721446997);
    AssertAlmostEqual(&test, rTM, 0.9998830292308694);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.998338817261247);
    AssertAlmostEqual(&test, rTM, 0.999983539097984);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9835923258137302);
    AssertAlmostEqual(&test, rTM, 0.9999983457142599);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8476874021069397);
    AssertAlmostEqual(&test, rTM, 0.999999834003808);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.221470099697519);
    AssertAlmostEqual(&test, rTM, 0.99999997853094);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.003627504607809513);
    AssertAlmostEqual(&test, rTM, 0.9999999862166016);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.653699079038043e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999863152388);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.653963413722923e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999863162288);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.653966057311212e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999863162387);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994756860092722);
    AssertAlmostEqual(&test, rTM, 0.9994756860093246);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994756860066775);
    AssertAlmostEqual(&test, rTM, 0.9994756860119193);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994756857472102);
    AssertAlmostEqual(&test, rTM, 0.9994756862713864);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994756598011288);
    AssertAlmostEqual(&test, rTM, 0.9994757122161583);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994730716498562);
    AssertAlmostEqual(&test, rTM, 0.9994782874009587);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999258588578004);
    AssertAlmostEqual(&test, rTM, 0.9996292255394111);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.994743199373224);
    AssertAlmostEqual(&test, rTM, 0.999947816309548);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9489095816001489);
    AssertAlmostEqual(&test, rTM, 0.9999947539584478);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5953415290773398);
    AssertAlmostEqual(&test, rTM, 0.9999994578174315);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03393165480795696);
    AssertAlmostEqual(&test, rTM, 0.9999998528146511);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003633069607761612);
    AssertAlmostEqual(&test, rTM, 0.9999998623753688);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.635684449834499e-06);
    AssertAlmostEqual(&test, rTM, 0.9999998624743324);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.63571062201726e-08);
    AssertAlmostEqual(&test, rTM, 0.9999998624753224);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.998302058666691);
    AssertAlmostEqual(&test, rTM, 0.9983020586666926);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.998302058666607);
    AssertAlmostEqual(&test, rTM, 0.9983020586667767);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9983020586582093);
    AssertAlmostEqual(&test, rTM, 0.9983020586751743);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9983020578184427);
    AssertAlmostEqual(&test, rTM, 0.9983020595149404);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9983019738438856);
    AssertAlmostEqual(&test, rTM, 0.9983021434852644);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9982935973103945);
    AssertAlmostEqual(&test, rTM, 0.9983104781020411);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9975995933195099);
    AssertAlmostEqual(&test, rTM, 0.9987990751167285);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9830666120897826);
    AssertAlmostEqual(&test, rTM, 0.999830913158299);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8438815743462461);
    AssertAlmostEqual(&test, rTM, 0.9999829459220625);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2139513475818033);
    AssertAlmostEqual(&test, rTM, 0.999997770002095);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.003438938657812397);
    AssertAlmostEqual(&test, rTM, 0.9999985460823611);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.462474074901117e-05);
    AssertAlmostEqual(&test, rTM, 0.9999985559479536);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.462711464156703e-07);
    AssertAlmostEqual(&test, rTM, 0.9999985560469499);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9934928348898796);
    AssertAlmostEqual(&test, rTM, 0.9934928348898797);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9934928348898764);
    AssertAlmostEqual(&test, rTM, 0.9934928348898829);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9934928348895554);
    AssertAlmostEqual(&test, rTM, 0.993492834890204);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9934928348574501);
    AssertAlmostEqual(&test, rTM, 0.9934928349223093);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9934928316469183);
    AssertAlmostEqual(&test, rTM, 0.9934928381328395);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9934925106018195);
    AssertAlmostEqual(&test, rTM, 0.9934931591618323);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9934604864665758);
    AssertAlmostEqual(&test, rTM, 0.9935250238178943);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9908099129278788);
    AssertAlmostEqual(&test, rTM, 0.995394325980086);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9365070268674252);
    AssertAlmostEqual(&test, rTM, 0.999350264505308);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5263417692333279);
    AssertAlmostEqual(&test, rTM, 0.9999313317341534);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0224224513199536);
    AssertAlmostEqual(&test, rTM, 0.9999777126409526);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002345186350400153);
    AssertAlmostEqual(&test, rTM, 0.999978680188463);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.346275730443331e-06);
    AssertAlmostEqual(&test, rTM, 0.9999786900858016);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.95846008730442);
    AssertAlmostEqual(&test, rTM, 0.95846008730442);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9584600873044198);
    AssertAlmostEqual(&test, rTM, 0.9584600873044202);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9584600873043997);
    AssertAlmostEqual(&test, rTM, 0.9584600873044403);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9584600873023871);
    AssertAlmostEqual(&test, rTM, 0.9584600873064529);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9584600871011258);
    AssertAlmostEqual(&test, rTM, 0.9584600875077142);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9584600669750101);
    AssertAlmostEqual(&test, rTM, 0.9584601076338202);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9584580544158956);
    AssertAlmostEqual(&test, rTM, 0.9584621200955733);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.958257320541029);
    AssertAlmostEqual(&test, rTM, 0.9586618899119052);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9417675032250852);
    AssertAlmostEqual(&test, rTM, 0.9704405155976047);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6549114549656537);
    AssertAlmostEqual(&test, rTM, 0.995694337820656);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05011226226656904);
    AssertAlmostEqual(&test, rTM, 0.9990057875244605);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005548305751881012);
    AssertAlmostEqual(&test, rTM, 0.9990996361110903);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.554411414374782e-06);
    AssertAlmostEqual(&test, rTM, 0.9991006242204094);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6758922252968663);
    AssertAlmostEqual(&test, rTM, 0.6758922252968663);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6758922252968663);
    AssertAlmostEqual(&test, rTM, 0.6758922252968663);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.675892225296865);
    AssertAlmostEqual(&test, rTM, 0.6758922252968677);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6758922252967355);
    AssertAlmostEqual(&test, rTM, 0.675892225296997);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6758922252837949);
    AssertAlmostEqual(&test, rTM, 0.6758922253099376);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6758922239897301);
    AssertAlmostEqual(&test, rTM, 0.6758922266040024);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6758920945833015);
    AssertAlmostEqual(&test, rTM, 0.6758923560103887);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6758791544011049);
    AssertAlmostEqual(&test, rTM, 0.675905295767452);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6745897192177971);
    AssertAlmostEqual(&test, rTM, 0.677190522889594);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5766340948144547);
    AssertAlmostEqual(&test, rTM, 0.7554882735175928);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05668762274410544);
    AssertAlmostEqual(&test, rTM, 0.919576452328737);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006425350855655094);
    AssertAlmostEqual(&test, rTM, 0.9278048708226371);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.434169976792412e-06);
    AssertAlmostEqual(&test, rTM, 0.9278933499352481);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05801264314049161);
    AssertAlmostEqual(&test, rTM, 0.05801264314049161);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05801264314049161);
    AssertAlmostEqual(&test, rTM, 0.05801264314049161);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05801264314049161);
    AssertAlmostEqual(&test, rTM, 0.05801264314049162);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05801264314049109);
    AssertAlmostEqual(&test, rTM, 0.05801264314049213);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05801264314043996);
    AssertAlmostEqual(&test, rTM, 0.05801264314054327);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05801264313532654);
    AssertAlmostEqual(&test, rTM, 0.05801264314565669);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05801264262398383);
    AssertAlmostEqual(&test, rTM, 0.05801264365699939);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05801259148975954);
    AssertAlmostEqual(&test, rTM, 0.05801269479122338);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05800747852404772);
    AssertAlmostEqual(&test, rTM, 0.05801780775383029);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05750070855437182);
    AssertAlmostEqual(&test, rTM, 0.05852454721818712);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03071200550585674);
    AssertAlmostEqual(&test, rTM, 0.08522678713275871);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006464715719698363);
    AssertAlmostEqual(&test, rTM, 0.1149982419480056);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.537073981829486e-06);
    AssertAlmostEqual(&test, rTM, 0.115629667106258);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006539790014917236);
    AssertAlmostEqual(&test, rTM, 0.0006539790014917236);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006539790014917236);
    AssertAlmostEqual(&test, rTM, 0.0006539790014917236);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006539790014917236);
    AssertAlmostEqual(&test, rTM, 0.0006539790014917236);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006539790014917235);
    AssertAlmostEqual(&test, rTM, 0.0006539790014917237);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006539790014917171);
    AssertAlmostEqual(&test, rTM, 0.0006539790014917301);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006539790014910705);
    AssertAlmostEqual(&test, rTM, 0.0006539790014923767);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006539790014264111);
    AssertAlmostEqual(&test, rTM, 0.000653979001557036);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006539789949604818);
    AssertAlmostEqual(&test, rTM, 0.0006539790080229654);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006539783483681924);
    AssertAlmostEqual(&test, rTM, 0.0006539796546152548);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006539136955954342);
    AssertAlmostEqual(&test, rTM, 0.0006540443073880073);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000647512341755954);
    AssertAlmostEqual(&test, rTM, 0.0006604456611727973);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003272033799526007);
    AssertAlmostEqual(&test, rTM, 0.0009807544833640735);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.48343294314663e-06);
    AssertAlmostEqual(&test, rTM, 0.001301474021678469);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549322166776551e-06);
    AssertAlmostEqual(&test, rTM, 6.549322166776551e-06);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549322166776551e-06);
    AssertAlmostEqual(&test, rTM, 6.549322166776551e-06);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549322166776551e-06);
    AssertAlmostEqual(&test, rTM, 6.549322166776551e-06);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549322166776551e-06);
    AssertAlmostEqual(&test, rTM, 6.549322166776551e-06);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549322166776551e-06);
    AssertAlmostEqual(&test, rTM, 6.549322166776552e-06);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549322166776486e-06);
    AssertAlmostEqual(&test, rTM, 6.549322166776617e-06);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549322166770002e-06);
    AssertAlmostEqual(&test, rTM, 6.5493221667831e-06);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549322166121627e-06);
    AssertAlmostEqual(&test, rTM, 6.549322167431475e-06);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549322101284188e-06);
    AssertAlmostEqual(&test, rTM, 6.549322232268914e-06);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54931561754672e-06);
    AssertAlmostEqual(&test, rTM, 6.549328716006382e-06);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.548667308623498e-06);
    AssertAlmostEqual(&test, rTM, 6.549977024929603e-06);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.48447823381164e-06);
    AssertAlmostEqual(&test, rTM, 6.614166099741407e-06);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.274682530233813e-06);
    AssertAlmostEqual(&test, rTM, 9.823961803178829e-06);

    userdata[0] = 10/CAPS_HBAR_EV; /* 10eV */
    userdata[1] = 0.05/CAPS_HBAR_EV; /* 0.05eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999972044842494);
    AssertAlmostEqual(&test, rTM, 0.9999986022411478);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999801342975726);
    AssertAlmostEqual(&test, rTM, 0.9999998033079426);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.99980233656419);
    AssertAlmostEqual(&test, rTM, 0.9999999802336793);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9980252208734665);
    AssertAlmostEqual(&test, rTM, 0.9999999980232691);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9804270986081766);
    AssertAlmostEqual(&test, rTM, 0.9999999998023172);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8209010802647986);
    AssertAlmostEqual(&test, rTM, 0.9999999999801363);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1744276057157211);
    AssertAlmostEqual(&test, rTM, 0.9999999999972207);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002546188095571619);
    AssertAlmostEqual(&test, rTM, 0.9999999999980362);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559072951126295e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999980461);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559202623337432e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999980462);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559203920142499e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999999980462);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559203933110558e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999999980462);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559203933240239e-13);
    AssertAlmostEqual(&test, rTM, 0.9999999999980462);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999937178695292);
    AssertAlmostEqual(&test, rTM, 0.9999937800686473);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999911598281569);
    AssertAlmostEqual(&test, rTM, 0.9999955799043098);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999371804712041);
    AssertAlmostEqual(&test, rTM, 0.9999993780051235);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993750667995375);
    AssertAlmostEqual(&test, rTM, 0.9999999374933933);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9937685306074926);
    AssertAlmostEqual(&test, rTM, 0.9999999937489995);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9394134776812523);
    AssertAlmostEqual(&test, rTM, 0.9999999993745975);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5404554800547803);
    AssertAlmostEqual(&test, rTM, 0.9999999999345082);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02436035542228572);
    AssertAlmostEqual(&test, rTM, 0.9999999999794871);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002557893966686347);
    AssertAlmostEqual(&test, rTM, 0.9999999999804526);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559189934285412e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999804625);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559202902251541e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999804626);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559203031932032e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999999804626);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559203033228837e-12);
    AssertAlmostEqual(&test, rTM, 0.9999999999804626);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999374909826065);
    AssertAlmostEqual(&test, rTM, 0.9999374910451135);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999374878885866);
    AssertAlmostEqual(&test, rTM, 0.9999374941389773);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999371792562022);
    AssertAlmostEqual(&test, rTM, 0.9999378012244204);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999116000885022);
    AssertAlmostEqual(&test, rTM, 0.9999557990673683);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993719701325591);
    AssertAlmostEqual(&test, rTM, 0.9999937799480424);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9937681029650366);
    AssertAlmostEqual(&test, rTM, 0.9999993749189964);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9394123133863407);
    AssertAlmostEqual(&test, rTM, 0.9999999374585672);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5404492416646361);
    AssertAlmostEqual(&test, rTM, 0.9999999934506837);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0243594579201058);
    AssertAlmostEqual(&test, rTM, 0.9999999979486272);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002557795071832058);
    AssertAlmostEqual(&test, rTM, 0.9999999980451915);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559090939205683e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999980461812);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559103906168596e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999980461911);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559104035839055e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999980461912);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998023078398897);
    AssertAlmostEqual(&test, rTM, 0.9998023078418663);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998023077420417);
    AssertAlmostEqual(&test, rTM, 0.9998023079397143);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998022979574943);
    AssertAlmostEqual(&test, rTM, 0.9998023177237676);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998013219369135);
    AssertAlmostEqual(&test, rTM, 0.9998032888529536);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997204325152004);
    AssertAlmostEqual(&test, rTM, 0.999860206485804);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9980149950350995);
    AssertAlmostEqual(&test, rTM, 0.9999803271342422);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9804223440993476);
    AssertAlmostEqual(&test, rTM, 0.999998022887182);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8208694568880648);
    AssertAlmostEqual(&test, rTM, 0.9999998013246989);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1743797114099435);
    AssertAlmostEqual(&test, rTM, 0.9999999721988391);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002545198718480256);
    AssertAlmostEqual(&test, rTM, 0.9999999803552961);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.558073544005743e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999804540416);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.558203114954251e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999804550316);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.558204410746595e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999804550415);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993738788373722);
    AssertAlmostEqual(&test, rTM, 0.9993738788374347);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993738788342738);
    AssertAlmostEqual(&test, rTM, 0.9993738788405331);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993738785244409);
    AssertAlmostEqual(&test, rTM, 0.9993738791503657);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993738475419319);
    AssertAlmostEqual(&test, rTM, 0.9993739101313113);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993707570020295);
    AssertAlmostEqual(&test, rTM, 0.9993769851893802);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991146458109309);
    AssertAlmostEqual(&test, rTM, 0.9995572248588559);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.993725367981775);
    AssertAlmostEqual(&test, rTM, 0.9999376807418694);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9392959963548961);
    AssertAlmostEqual(&test, rTM, 0.9999937340901998);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5398264272365774);
    AssertAlmostEqual(&test, rTM, 0.9999993436905067);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02427004064242905);
    AssertAlmostEqual(&test, rTM, 0.9999997941060814);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002547944055357831);
    AssertAlmostEqual(&test, rTM, 0.9999998037634036);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.549229958603258e-06);
    AssertAlmostEqual(&test, rTM, 0.9999998038623781);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.54924282582946e-08);
    AssertAlmostEqual(&test, rTM, 0.9999998038633681);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9979870482205141);
    AssertAlmostEqual(&test, rTM, 0.9979870482205161);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9979870482204145);
    AssertAlmostEqual(&test, rTM, 0.9979870482206156);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9979870482104605);
    AssertAlmostEqual(&test, rTM, 0.9979870482305697);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9979870472150534);
    AssertAlmostEqual(&test, rTM, 0.9979870492259761);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9979869476768461);
    AssertAlmostEqual(&test, rTM, 0.9979871487591673);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.997977018663828);
    AssertAlmostEqual(&test, rTM, 0.9979970281024166);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9971544440365619);
    AssertAlmostEqual(&test, rTM, 0.9985762077049744);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9799536927423428);
    AssertAlmostEqual(&test, rTM, 0.9997995119397154);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.817774400305614);
    AssertAlmostEqual(&test, rTM, 0.9999797494138307);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1697682310293579);
    AssertAlmostEqual(&test, rTM, 0.9999971397021812);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002450906336517484);
    AssertAlmostEqual(&test, rTM, 0.9999979599547867);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.462843240355904e-05);
    AssertAlmostEqual(&test, rTM, 0.9999979698302499);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.462963343779865e-07);
    AssertAlmostEqual(&test, rTM, 0.9999979699292472);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9926553555627029);
    AssertAlmostEqual(&test, rTM, 0.992655355562703);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9926553555626993);
    AssertAlmostEqual(&test, rTM, 0.9926553555627067);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9926553555623371);
    AssertAlmostEqual(&test, rTM, 0.9926553555630688);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9926553555261151);
    AssertAlmostEqual(&test, rTM, 0.9926553555992909);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9926553519039173);
    AssertAlmostEqual(&test, rTM, 0.9926553592214868);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9926549896932609);
    AssertAlmostEqual(&test, rTM, 0.9926557214139875);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9926188593844166);
    AssertAlmostEqual(&test, rTM, 0.9926916719468588);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9896289500854522);
    AssertAlmostEqual(&test, rTM, 0.9948009248105845);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9286081773572921);
    AssertAlmostEqual(&test, rTM, 0.9992662580646426);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4860400540226439);
    AssertAlmostEqual(&test, rTM, 0.9999214418319045);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01775403259414011);
    AssertAlmostEqual(&test, rTM, 0.9999718470680882);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001839488779823855);
    AssertAlmostEqual(&test, rTM, 0.999972819274806);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.840158956222254e-06);
    AssertAlmostEqual(&test, rTM, 0.9999728291725631);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9571581711352075);
    AssertAlmostEqual(&test, rTM, 0.9571581711352075);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9571581711352073);
    AssertAlmostEqual(&test, rTM, 0.9571581711352077);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9571581711351866);
    AssertAlmostEqual(&test, rTM, 0.9571581711352285);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9571581711331123);
    AssertAlmostEqual(&test, rTM, 0.9571581711373027);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9571581709256874);
    AssertAlmostEqual(&test, rTM, 0.9571581713447277);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9571581501831984);
    AssertAlmostEqual(&test, rTM, 0.9571581920872066);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9571560759884438);
    AssertAlmostEqual(&test, rTM, 0.9571602661817574);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9569491952531626);
    AssertAlmostEqual(&test, rTM, 0.9573661547126846);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9399593104596057);
    AssertAlmostEqual(&test, rTM, 0.9695077966435803);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6462239950852067);
    AssertAlmostEqual(&test, rTM, 0.9955505386483062);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04732531664650582);
    AssertAlmostEqual(&test, rTM, 0.9989470144453345);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005209483477180125);
    AssertAlmostEqual(&test, rTM, 0.999041132996711);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.21486623779004e-06);
    AssertAlmostEqual(&test, rTM, 0.9990421210530857);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6749089561704219);
    AssertAlmostEqual(&test, rTM, 0.6749089561704219);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6749089561704219);
    AssertAlmostEqual(&test, rTM, 0.6749089561704219);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6749089561704206);
    AssertAlmostEqual(&test, rTM, 0.6749089561704232);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6749089561702909);
    AssertAlmostEqual(&test, rTM, 0.6749089561705529);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6749089561573223);
    AssertAlmostEqual(&test, rTM, 0.6749089561835215);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.674908954860459);
    AssertAlmostEqual(&test, rTM, 0.6749089574803848);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6749088251741799);
    AssertAlmostEqual(&test, rTM, 0.6749090871666213);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6748958570084913);
    AssertAlmostEqual(&test, rTM, 0.6749220549069971);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6736036387750582);
    AssertAlmostEqual(&test, rTM, 0.6762100633130772);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5754697389583573);
    AssertAlmostEqual(&test, rTM, 0.7546829817756419);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05630849257406233);
    AssertAlmostEqual(&test, rTM, 0.9190754354120528);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006377311801619547);
    AssertAlmostEqual(&test, rTM, 0.9273005747410497);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.386004206776964e-06);
    AssertAlmostEqual(&test, rTM, 0.9273889830563279);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05797308567284012);
    AssertAlmostEqual(&test, rTM, 0.05797308567284012);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05797308567284012);
    AssertAlmostEqual(&test, rTM, 0.05797308567284012);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05797308567284012);
    AssertAlmostEqual(&test, rTM, 0.05797308567284012);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0579730856728396);
    AssertAlmostEqual(&test, rTM, 0.05797308567284064);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0579730856727885);
    AssertAlmostEqual(&test, rTM, 0.05797308567289174);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05797308566767816);
    AssertAlmostEqual(&test, rTM, 0.05797308567800209);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05797308515664356);
    AssertAlmostEqual(&test, rTM, 0.05797308618903668);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05797303405322998);
    AssertAlmostEqual(&test, rTM, 0.05797313729244995);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05796792416834832);
    AssertAlmostEqual(&test, rTM, 0.05797824717423258);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05746145988965209);
    AssertAlmostEqual(&test, rTM, 0.05848468100531434);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03068988681905722);
    AssertAlmostEqual(&test, rTM, 0.08516996028550131);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006459771423488475);
    AssertAlmostEqual(&test, rTM, 0.1149203970164661);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.53206794703128e-06);
    AssertAlmostEqual(&test, rTM, 0.1155513507699542);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000653928869975037);
    AssertAlmostEqual(&test, rTM, 0.000653928869975037);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000653928869975037);
    AssertAlmostEqual(&test, rTM, 0.000653928869975037);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000653928869975037);
    AssertAlmostEqual(&test, rTM, 0.000653928869975037);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000653928869975037);
    AssertAlmostEqual(&test, rTM, 0.0006539288699750371);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006539288699750305);
    AssertAlmostEqual(&test, rTM, 0.0006539288699750435);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000653928869974384);
    AssertAlmostEqual(&test, rTM, 0.0006539288699756901);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006539288699097296);
    AssertAlmostEqual(&test, rTM, 0.0006539288700403445);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006539288634442952);
    AssertAlmostEqual(&test, rTM, 0.0006539288765057788);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006539282169015063);
    AssertAlmostEqual(&test, rTM, 0.0006539295230485677);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006538635690783001);
    AssertAlmostEqual(&test, rTM, 0.0006539941708717684);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006474627053066371);
    AssertAlmostEqual(&test, rTM, 0.0006603950345887537);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003271782814025222);
    AssertAlmostEqual(&test, rTM, 0.0009806793189128815);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.482935304124505e-06);
    AssertAlmostEqual(&test, rTM, 0.001301374256410213);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549271885566869e-06);
    AssertAlmostEqual(&test, rTM, 6.549271885566869e-06);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549271885566869e-06);
    AssertAlmostEqual(&test, rTM, 6.549271885566869e-06);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549271885566869e-06);
    AssertAlmostEqual(&test, rTM, 6.549271885566869e-06);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549271885566869e-06);
    AssertAlmostEqual(&test, rTM, 6.549271885566869e-06);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549271885566868e-06);
    AssertAlmostEqual(&test, rTM, 6.54927188556687e-06);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549271885566804e-06);
    AssertAlmostEqual(&test, rTM, 6.549271885566934e-06);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54927188556032e-06);
    AssertAlmostEqual(&test, rTM, 6.549271885573418e-06);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549271884911951e-06);
    AssertAlmostEqual(&test, rTM, 6.549271886221787e-06);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549271820075009e-06);
    AssertAlmostEqual(&test, rTM, 6.54927195105873e-06);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549265336387317e-06);
    AssertAlmostEqual(&test, rTM, 6.54927843474642e-06);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.548617032441304e-06);
    AssertAlmostEqual(&test, rTM, 6.549926738692434e-06);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.484428450422805e-06);
    AssertAlmostEqual(&test, rTM, 6.614115320710878e-06);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.274657389299664e-06);
    AssertAlmostEqual(&test, rTM, 9.823886381693616e-06);

    userdata[0] = 10/CAPS_HBAR_EV; /* 10eV */
    userdata[1] = 0.1/CAPS_HBAR_EV; /* 0.1eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999960465460392);
    AssertAlmostEqual(&test, rTM, 0.9999980232710659);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999719057700657);
    AssertAlmostEqual(&test, rTM, 0.9999997218354388);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997204731355016);
    AssertAlmostEqual(&test, rTM, 0.9999999720462015);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9972083837095407);
    AssertAlmostEqual(&test, rTM, 0.9999999972044791);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9724328193413913);
    AssertAlmostEqual(&test, rTM, 0.9999999997204208);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7568050478044702);
    AssertAlmostEqual(&test, rTM, 0.999999999971773);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1029657829286504);
    AssertAlmostEqual(&test, rTM, 0.9999999999951955);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001276337667697694);
    AssertAlmostEqual(&test, rTM, 0.9999999999960826);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279569245043194e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999960925);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279601664144626e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999960926);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.27960198834601e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999999960926);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279601991588025e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999999960926);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279601991620445e-13);
    AssertAlmostEqual(&test, rTM, 0.9999999999960926);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999911157383145);
    AssertAlmostEqual(&test, rTM, 0.9999912037009145);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999874981331963);
    AssertAlmostEqual(&test, rTM, 0.9999937490470608);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999111609349441);
    AssertAlmostEqual(&test, rTM, 0.9999991203666088);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999116325493916);
    AssertAlmostEqual(&test, rTM, 0.9999999116023145);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9911987738649962);
    AssertAlmostEqual(&test, rTM, 0.9999999911597081);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9154190498393816);
    AssertAlmostEqual(&test, rTM, 0.9999999991151158);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4242187529373768);
    AssertAlmostEqual(&test, rTM, 0.9999999999033472);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01247865601616879);
    AssertAlmostEqual(&test, rTM, 0.9999999999599378);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001279274395206822);
    AssertAlmostEqual(&test, rTM, 0.9999999999609154);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279598491869935e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999609253);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279601733873209e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999609254);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279601766293345e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999999609254);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279601766617547e-12);
    AssertAlmostEqual(&test, rTM, 0.9999999999609254);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999116009077859);
    AssertAlmostEqual(&test, rTM, 0.9999116009961809);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999115965323369);
    AssertAlmostEqual(&test, rTM, 0.999911605371409);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999111600758263);
    AssertAlmostEqual(&test, rTM, 0.999912039640349);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998749871562567);
    AssertAlmostEqual(&test, rTM, 0.9999374916244187);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991119558669819);
    AssertAlmostEqual(&test, rTM, 0.9999912036149958);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9911982553972627);
    AssertAlmostEqual(&test, rTM, 0.9999991160063996);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.915418227964539);
    AssertAlmostEqual(&test, rTM, 0.9999999115107754);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4242154340770521);
    AssertAlmostEqual(&test, rTM, 0.9999999903346132);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01247842060738756);
    AssertAlmostEqual(&test, rTM, 0.9999999959937066);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001279249658355539);
    AssertAlmostEqual(&test, rTM, 0.9999999960914588);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279573742484973e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999960924487);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.27957698436285e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999960924586);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279577016781733e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999960924587);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997204598106559);
    AssertAlmostEqual(&test, rTM, 0.9997204598134509);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997204596723029);
    AssertAlmostEqual(&test, rTM, 0.9997204599518039);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997204458373473);
    AssertAlmostEqual(&test, rTM, 0.9997204737860611);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997190657838733);
    AssertAlmostEqual(&test, rTM, 0.9997218469238661);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999604693364986);
    AssertAlmostEqual(&test, rTM, 0.9998023271432831);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9971942076732973);
    AssertAlmostEqual(&test, rTM, 0.9999721811831623);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9724288053798036);
    AssertAlmostEqual(&test, rTM, 0.9999972040779022);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7567844781645293);
    AssertAlmostEqual(&test, rTM, 0.9999997177024833);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1029494255373305);
    AssertAlmostEqual(&test, rTM, 0.999999951947213);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001276089014395356);
    AssertAlmostEqual(&test, rTM, 0.9999999608178457);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279319331666063e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999609167182);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279351738106294e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999609177082);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.27935206218106e-09);
    AssertAlmostEqual(&test, rTM, 0.999999960917718);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991155073553979);
    AssertAlmostEqual(&test, rTM, 0.9991155073554863);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991155073510215);
    AssertAlmostEqual(&test, rTM, 0.9991155073598625);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991155069133915);
    AssertAlmostEqual(&test, rTM, 0.9991155077974924);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991154631514827);
    AssertAlmostEqual(&test, rTM, 0.9991155515571933);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991110978549883);
    AssertAlmostEqual(&test, rTM, 0.9991198949916958);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9987493677249552);
    AssertAlmostEqual(&test, rTM, 0.999374488168786);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9911464797673536);
    AssertAlmostEqual(&test, rTM, 0.9999119537674048);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9153360786259461);
    AssertAlmostEqual(&test, rTM, 0.9999911429854678);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4238838671505174);
    AssertAlmostEqual(&test, rTM, 0.9999990323751941);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01245492450528109);
    AssertAlmostEqual(&test, rTM, 0.9999995986148017);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001276780795008757);
    AssertAlmostEqual(&test, rTM, 0.9999996083902594);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.277103629432975e-06);
    AssertAlmostEqual(&test, rTM, 0.9999996084892465);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.27710685880781e-08);
    AssertAlmostEqual(&test, rTM, 0.9999996084902365);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9971812850010228);
    AssertAlmostEqual(&test, rTM, 0.9971812850010257);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9971812850008834);
    AssertAlmostEqual(&test, rTM, 0.997181285001165);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9971812849869506);
    AssertAlmostEqual(&test, rTM, 0.997181285015098);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9971812835936562);
    AssertAlmostEqual(&test, rTM, 0.9971812864083915);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9971811442677116);
    AssertAlmostEqual(&test, rTM, 0.9971814257273205);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9971672464252195);
    AssertAlmostEqual(&test, rTM, 0.9971952541020823);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960160647039784);
    AssertAlmostEqual(&test, rTM, 0.9980060424386694);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9720317673843616);
    AssertAlmostEqual(&test, rTM, 0.9997191430048321);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7547605095735995);
    AssertAlmostEqual(&test, rTM, 0.9999714951598181);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1013554757660668);
    AssertAlmostEqual(&test, rTM, 0.9999951175716815);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001251940470942476);
    AssertAlmostEqual(&test, rTM, 0.9999960062221125);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.255049586218054e-05);
    AssertAlmostEqual(&test, rTM, 0.9999960161095351);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.255080774879052e-07);
    AssertAlmostEqual(&test, rTM, 0.9999960162085333);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9903813188656299);
    AssertAlmostEqual(&test, rTM, 0.99038131886563);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9903813188656252);
    AssertAlmostEqual(&test, rTM, 0.9903813188656347);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9903813188651513);
    AssertAlmostEqual(&test, rTM, 0.9903813188661086);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9903813188177689);
    AssertAlmostEqual(&test, rTM, 0.9903813189134909);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9903813140795321);
    AssertAlmostEqual(&test, rTM, 0.9903813236517254);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9903808402678071);
    AssertAlmostEqual(&test, rTM, 0.9903817974397554);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.990333578086697);
    AssertAlmostEqual(&test, rTM, 0.9904288249949897);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9864243324534478);
    AssertAlmostEqual(&test, rTM, 0.9931888919097651);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9074682624586705);
    AssertAlmostEqual(&test, rTM, 0.9990376211884398);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3935965503084503);
    AssertAlmostEqual(&test, rTM, 0.9998926651956794);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01048139004578263);
    AssertAlmostEqual(&test, rTM, 0.9999523039434599);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001070233191097329);
    AssertAlmostEqual(&test, rTM, 0.9999532833930372);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.070460026519127e-06);
    AssertAlmostEqual(&test, rTM, 0.9999532932912735);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9530953082699752);
    AssertAlmostEqual(&test, rTM, 0.9530953082699752);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.953095308269975);
    AssertAlmostEqual(&test, rTM, 0.9530953082699755);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9530953082699523);
    AssertAlmostEqual(&test, rTM, 0.9530953082699981);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9530953082676863);
    AssertAlmostEqual(&test, rTM, 0.9530953082722641);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.953095308041084);
    AssertAlmostEqual(&test, rTM, 0.9530953084988665);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9530952853808567);
    AssertAlmostEqual(&test, rTM, 0.9530953311590827);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9530930194175289);
    AssertAlmostEqual(&test, rTM, 0.9530975970134177);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9528670140848164);
    AssertAlmostEqual(&test, rTM, 0.9533225231154185);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9343232438085881);
    AssertAlmostEqual(&test, rTM, 0.9665945077003363);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6198519326646841);
    AssertAlmostEqual(&test, rTM, 0.9950968834115199);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03992718376706488);
    AssertAlmostEqual(&test, rTM, 0.9987513428028746);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004328398960064892);
    AssertAlmostEqual(&test, rTM, 0.9988461721128812);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.33211515590219e-06);
    AssertAlmostEqual(&test, rTM, 0.9988471599680422);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.671668854848256);
    AssertAlmostEqual(&test, rTM, 0.671668854848256);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.671668854848256);
    AssertAlmostEqual(&test, rTM, 0.671668854848256);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6716688548482547);
    AssertAlmostEqual(&test, rTM, 0.6716688548482573);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6716688548481241);
    AssertAlmostEqual(&test, rTM, 0.6716688548483879);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6716688548350638);
    AssertAlmostEqual(&test, rTM, 0.6716688548614482);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6716688535290366);
    AssertAlmostEqual(&test, rTM, 0.6716688561674754);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6716687229263597);
    AssertAlmostEqual(&test, rTM, 0.6716689867701098);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6716556631259593);
    AssertAlmostEqual(&test, rTM, 0.6716820461446487);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.670354331861994);
    AssertAlmostEqual(&test, rTM, 0.6729791621875731);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.571638658760516);
    AssertAlmostEqual(&test, rTM, 0.7520257533964058);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05508066163348156);
    AssertAlmostEqual(&test, rTM, 0.9174096156137859);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006222243391428708);
    AssertAlmostEqual(&test, rTM, 0.925623539957793);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.230533016032387e-06);
    AssertAlmostEqual(&test, rTM, 0.925711712971059);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05784161748324197);
    AssertAlmostEqual(&test, rTM, 0.05784161748324197);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05784161748324197);
    AssertAlmostEqual(&test, rTM, 0.05784161748324197);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05784161748324197);
    AssertAlmostEqual(&test, rTM, 0.05784161748324197);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05784161748324145);
    AssertAlmostEqual(&test, rTM, 0.05784161748324249);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05784161748319045);
    AssertAlmostEqual(&test, rTM, 0.05784161748329349);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05784161747809035);
    AssertAlmostEqual(&test, rTM, 0.05784161748839359);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05784161696808012);
    AssertAlmostEqual(&test, rTM, 0.05784161799840382);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05784156596710271);
    AssertAlmostEqual(&test, rTM, 0.05784166899938091);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05783646632503714);
    AssertAlmostEqual(&test, rTM, 0.05784676863836691);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05733101837211198);
    AssertAlmostEqual(&test, rTM, 0.05835218633497768);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0306163876245729);
    AssertAlmostEqual(&test, rTM, 0.08498108458560802);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006443344918340588);
    AssertAlmostEqual(&test, rTM, 0.1146616733485741);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.515436397288499e-06);
    AssertAlmostEqual(&test, rTM, 0.1152910607793668);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006537618204136613);
    AssertAlmostEqual(&test, rTM, 0.0006537618204136613);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006537618204136613);
    AssertAlmostEqual(&test, rTM, 0.0006537618204136613);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006537618204136613);
    AssertAlmostEqual(&test, rTM, 0.0006537618204136613);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006537618204136613);
    AssertAlmostEqual(&test, rTM, 0.0006537618204136614);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006537618204136548);
    AssertAlmostEqual(&test, rTM, 0.0006537618204136679);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006537618204130084);
    AssertAlmostEqual(&test, rTM, 0.0006537618204143142);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006537618203483705);
    AssertAlmostEqual(&test, rTM, 0.000653761820478952);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006537618138845857);
    AssertAlmostEqual(&test, rTM, 0.0006537618269427369);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006537611675067435);
    AssertAlmostEqual(&test, rTM, 0.0006537624733205791);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006536965361765718);
    AssertAlmostEqual(&test, rTM, 0.0006538271046507452);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006472973054225109);
    AssertAlmostEqual(&test, rTM, 0.0006602263353501704);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003270946473704986);
    AssertAlmostEqual(&test, rTM, 0.0009804288539290908);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.48127705897052e-06);
    AssertAlmostEqual(&test, rTM, 0.001301041815952654);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549104287110365e-06);
    AssertAlmostEqual(&test, rTM, 6.549104287110365e-06);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549104287110365e-06);
    AssertAlmostEqual(&test, rTM, 6.549104287110365e-06);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549104287110365e-06);
    AssertAlmostEqual(&test, rTM, 6.549104287110365e-06);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549104287110365e-06);
    AssertAlmostEqual(&test, rTM, 6.549104287110365e-06);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549104287110364e-06);
    AssertAlmostEqual(&test, rTM, 6.549104287110366e-06);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549104287110299e-06);
    AssertAlmostEqual(&test, rTM, 6.54910428711043e-06);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549104287103815e-06);
    AssertAlmostEqual(&test, rTM, 6.549104287116914e-06);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549104286455463e-06);
    AssertAlmostEqual(&test, rTM, 6.549104287765267e-06);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54910422162018e-06);
    AssertAlmostEqual(&test, rTM, 6.549104352600549e-06);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549097738098407e-06);
    AssertAlmostEqual(&test, rTM, 6.549110836122322e-06);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54844945074253e-06);
    AssertAlmostEqual(&test, rTM, 6.5497591234782e-06);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.484262511313919e-06);
    AssertAlmostEqual(&test, rTM, 6.613946062906755e-06);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.274573588973776e-06);
    AssertAlmostEqual(&test, rTM, 9.823634985106507e-06);

    userdata[0] = 10/CAPS_HBAR_EV; /* 10eV */
    userdata[1] = 0.5/CAPS_HBAR_EV; /* 0.5eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999911598298667);
    AssertAlmostEqual(&test, rTM, 0.9999955799051647);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999371804833542);
    AssertAlmostEqual(&test, rTM, 0.9999993780052437);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993750669203739);
    AssertAlmostEqual(&test, rTM, 0.9999999374934053);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9937685318090129);
    AssertAlmostEqual(&test, rTM, 0.9999999937490007);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9394134890337797);
    AssertAlmostEqual(&test, rTM, 0.9999999993745976);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.540455542423747);
    AssertAlmostEqual(&test, rTM, 0.9999999999345083);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02436036439761873);
    AssertAlmostEqual(&test, rTM, 0.9999999999794871);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002557894955673484);
    AssertAlmostEqual(&test, rTM, 0.9999999999804526);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559190924274887e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999804626);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559203892251049e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999804626);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.55920402193164e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999999804626);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559204023228446e-12);
    AssertAlmostEqual(&test, rTM, 0.9999999999804626);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559204023241414e-14);
    AssertAlmostEqual(&test, rTM, 0.9999999999804626);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999801342975726);
    AssertAlmostEqual(&test, rTM, 0.9999803309857613);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999720451941631);
    AssertAlmostEqual(&test, rTM, 0.9999860224993956);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998013607341848);
    AssertAlmostEqual(&test, rTM, 0.9999980330811572);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9980251232210332);
    AssertAlmostEqual(&test, rTM, 0.9999998023367151);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9804270890153469);
    AssertAlmostEqual(&test, rTM, 0.9999999802317355);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8209010794654567);
    AssertAlmostEqual(&test, rTM, 0.9999999980136376);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1744276057035822);
    AssertAlmostEqual(&test, rTM, 0.9999999997220695);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002546188095569111);
    AssertAlmostEqual(&test, rTM, 0.9999999998036293);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.55907295112627e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999998046167);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559202623337432e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999998046266);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.5592039201425e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999998046267);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559203933110558e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999998046267);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559203933240239e-13);
    AssertAlmostEqual(&test, rTM, 0.9999999998046267);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998023459645644);
    AssertAlmostEqual(&test, rTM, 0.9998023461621987);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998023361819086);
    AssertAlmostEqual(&test, rTM, 0.9998023559443606);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998013603500163);
    AssertAlmostEqual(&test, rTM, 0.9998033268858034);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997204865655569);
    AssertAlmostEqual(&test, rTM, 0.9998602335147607);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9980153784796867);
    AssertAlmostEqual(&test, rTM, 0.9999803309382062);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.980426092271377);
    AssertAlmostEqual(&test, rTM, 0.9999980232695187);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8209006871914492);
    AssertAlmostEqual(&test, rTM, 0.999999801363487);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1744271301677923);
    AssertAlmostEqual(&test, rTM, 0.9999999722068711);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002546178295737877);
    AssertAlmostEqual(&test, rTM, 0.999999980362854);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559063052176148e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999804615994);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559192723386612e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999804625894);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559194020181671e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999804625993);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.55919403314963e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999804625994);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993750859480411);
    AssertAlmostEqual(&test, rTM, 0.9993750859542883);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993750856388054);
    AssertAlmostEqual(&test, rTM, 0.9993750862635239);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993750547160096);
    AssertAlmostEqual(&test, rTM, 0.9993751171847591);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993719701325591);
    AssertAlmostEqual(&test, rTM, 0.999378186316196);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991163524851085);
    AssertAlmostEqual(&test, rTM, 0.9995580785737094);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9937374307648765);
    AssertAlmostEqual(&test, rTM, 0.9999378009236274);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9394094080675028);
    AssertAlmostEqual(&test, rTM, 0.9999937461859377);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5404490820487861);
    AssertAlmostEqual(&test, rTM, 0.9999993450689396);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02435945769041677);
    AssertAlmostEqual(&test, rTM, 0.9999997948627553);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002557795071578966);
    AssertAlmostEqual(&test, rTM, 0.9999998045191834);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.55909093920315e-06);
    AssertAlmostEqual(&test, rTM, 0.9999998046181577);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559103906168571e-08);
    AssertAlmostEqual(&test, rTM, 0.9999998046191477);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559104035839055e-10);
    AssertAlmostEqual(&test, rTM, 0.9999998046191576);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.998024836498565);
    AssertAlmostEqual(&test, rTM, 0.9980248364987623);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9980248364887976);
    AssertAlmostEqual(&test, rTM, 0.9980248365085297);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9980248355120585);
    AssertAlmostEqual(&test, rTM, 0.9980248374852684);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.998024737840588);
    AssertAlmostEqual(&test, rTM, 0.9980249351518165);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9980149950350995);
    AssertAlmostEqual(&test, rTM, 0.9980346292171944);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9972078405394594);
    AssertAlmostEqual(&test, rTM, 0.9986029437053805);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9803266432624451);
    AssertAlmostEqual(&test, rTM, 0.9998032793375264);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8208614624724764);
    AssertAlmostEqual(&test, rTM, 0.9999801336583284);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1743795900423754);
    AssertAlmostEqual(&test, rTM, 0.9999972198911196);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002545198693410729);
    AssertAlmostEqual(&test, rTM, 0.999998035533424);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.558073543752507e-05);
    AssertAlmostEqual(&test, rTM, 0.9999980454079455);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.558203114951718e-07);
    AssertAlmostEqual(&test, rTM, 0.9999980455069426);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.55820441074657e-09);
    AssertAlmostEqual(&test, rTM, 0.9999980455079326);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9937564102697111);
    AssertAlmostEqual(&test, rTM, 0.9937564102697173);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.993756410269403);
    AssertAlmostEqual(&test, rTM, 0.9937564102700254);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.993756410238594);
    AssertAlmostEqual(&test, rTM, 0.9937564103008343);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9937564071576962);
    AssertAlmostEqual(&test, rTM, 0.9937564133817305);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9937560990756683);
    AssertAlmostEqual(&test, rTM, 0.9937567214482987);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.993725367981775);
    AssertAlmostEqual(&test, rTM, 0.9937872994616844);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9911816767135825);
    AssertAlmostEqual(&test, rTM, 0.9955810532876661);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.939005708744943);
    AssertAlmostEqual(&test, rTM, 0.9993766828974835);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5398104566570995);
    AssertAlmostEqual(&test, rTM, 0.9999343747780592);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02427001775376451);
    AssertAlmostEqual(&test, rTM, 0.9999794110188196);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002547944030146036);
    AssertAlmostEqual(&test, rTM, 0.9999803767214867);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.549229958350886e-06);
    AssertAlmostEqual(&test, rTM, 0.9999803866186476);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.549242825826936e-08);
    AssertAlmostEqual(&test, rTM, 0.9999803867176444);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9800521764661789);
    AssertAlmostEqual(&test, rTM, 0.9800521764661791);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9800521764661692);
    AssertAlmostEqual(&test, rTM, 0.9800521764661889);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9800521764651917);
    AssertAlmostEqual(&test, rTM, 0.9800521764671664);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9800521763674447);
    AssertAlmostEqual(&test, rTM, 0.9800521765649133);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9800521665927509);
    AssertAlmostEqual(&test, rTM, 0.9800521863396023);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.980051189148295);
    AssertAlmostEqual(&test, rTM, 0.9800531637356903);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9799536927423428);
    AssertAlmostEqual(&test, rTM, 0.9801501812086754);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9719069902716757);
    AssertAlmostEqual(&test, rTM, 0.9858527196718201);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8169653078376535);
    AssertAlmostEqual(&test, rTM, 0.9979870005950631);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1697563032584509);
    AssertAlmostEqual(&test, rTM, 0.9997140464645735);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002450903921987279);
    AssertAlmostEqual(&test, rTM, 0.9997960365723074);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.462843215974957e-05);
    AssertAlmostEqual(&test, rTM, 0.9997970238195171);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.462963343536032e-07);
    AssertAlmostEqual(&test, rTM, 0.9997970337162568);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9289494298690389);
    AssertAlmostEqual(&test, rTM, 0.9289494298690389);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9289494298690386);
    AssertAlmostEqual(&test, rTM, 0.9289494298690393);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9289494298690048);
    AssertAlmostEqual(&test, rTM, 0.9289494298690731);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9289494298656172);
    AssertAlmostEqual(&test, rTM, 0.9289494298724607);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9289494295268714);
    AssertAlmostEqual(&test, rTM, 0.9289494302112065);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.928949395652295);
    AssertAlmostEqual(&test, rTM, 0.9289494640857671);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.928946008285672);
    AssertAlmostEqual(&test, rTM, 0.9289528512937093);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9286081773572921);
    AssertAlmostEqual(&test, rTM, 0.9292891110018014);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.901040242421558);
    AssertAlmostEqual(&test, rTM, 0.949197853542339);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4843834366677115);
    AssertAlmostEqual(&test, rTM, 0.9922187438557879);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01775233643073257);
    AssertAlmostEqual(&test, rTM, 0.9971924050051806);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001839486959401635);
    AssertAlmostEqual(&test, rTM, 0.9972892205541997);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.840158938004748e-06);
    AssertAlmostEqual(&test, rTM, 0.9972902063491302);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6476040398182511);
    AssertAlmostEqual(&test, rTM, 0.6476040398182511);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6476040398182511);
    AssertAlmostEqual(&test, rTM, 0.6476040398182511);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6476040398182498);
    AssertAlmostEqual(&test, rTM, 0.6476040398182525);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6476040398181127);
    AssertAlmostEqual(&test, rTM, 0.6476040398183897);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6476040398044);
    AssertAlmostEqual(&test, rTM, 0.6476040398321024);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6476040384331304);
    AssertAlmostEqual(&test, rTM, 0.6476040412033718);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6476039013062314);
    AssertAlmostEqual(&test, rTM, 0.6476041783302281);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6475901891213922);
    AssertAlmostEqual(&test, rTM, 0.6476178900871673);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6462239950852067);
    AssertAlmostEqual(&test, rTM, 0.6489798490272491);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.543462885597726);
    AssertAlmostEqual(&test, rTM, 0.7321125567668543);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04690299179666507);
    AssertAlmostEqual(&test, rTM, 0.904310718765582);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005208968326844656);
    AssertAlmostEqual(&test, rTM, 0.9124225207965349);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.214861075131473e-06);
    AssertAlmostEqual(&test, rTM, 0.9125088492465582);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05681102355818029);
    AssertAlmostEqual(&test, rTM, 0.05681102355818029);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05681102355818029);
    AssertAlmostEqual(&test, rTM, 0.05681102355818029);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05681102355818029);
    AssertAlmostEqual(&test, rTM, 0.0568110235581803);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05681102355817978);
    AssertAlmostEqual(&test, rTM, 0.0568110235581808);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05681102355812959);
    AssertAlmostEqual(&test, rTM, 0.056811023558231);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05681102355310999);
    AssertAlmostEqual(&test, rTM, 0.05681102356325059);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0568110230511499);
    AssertAlmostEqual(&test, rTM, 0.05681102406521069);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0568109728551861);
    AssertAlmostEqual(&test, rTM, 0.05681107426117418);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05680595370816383);
    AssertAlmostEqual(&test, rTM, 0.05681609340526684);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05630849257406233);
    AssertAlmostEqual(&test, rTM, 0.057313525757223);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0300408407178514);
    AssertAlmostEqual(&test, rTM, 0.0834997648564936);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006314880416547106);
    AssertAlmostEqual(&test, rTM, 0.1126330800742559);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.385372063648603e-06);
    AssertAlmostEqual(&test, rTM, 0.1132502091117913);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006524284901631338);
    AssertAlmostEqual(&test, rTM, 0.0006524284901631338);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006524284901631338);
    AssertAlmostEqual(&test, rTM, 0.0006524284901631338);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006524284901631338);
    AssertAlmostEqual(&test, rTM, 0.0006524284901631338);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006524284901631338);
    AssertAlmostEqual(&test, rTM, 0.0006524284901631339);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006524284901631272);
    AssertAlmostEqual(&test, rTM, 0.0006524284901631403);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006524284901624821);
    AssertAlmostEqual(&test, rTM, 0.0006524284901637854);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000652428490097976);
    AssertAlmostEqual(&test, rTM, 0.0006524284902282916);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006524284836473567);
    AssertAlmostEqual(&test, rTM, 0.0006524284966789109);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006524278385860652);
    AssertAlmostEqual(&test, rTM, 0.0006524291417402024);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006523633388978312);
    AssertAlmostEqual(&test, rTM, 0.0006524936414284307);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006459771423488476);
    AssertAlmostEqual(&test, rTM, 0.0006588798379231119);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003264271112406273);
    AssertAlmostEqual(&test, rTM, 0.0009784297304094866);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.468041574618168e-06);
    AssertAlmostEqual(&test, rTM, 0.001298388394280858);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.5477638081967e-06);
    AssertAlmostEqual(&test, rTM, 6.5477638081967e-06);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.5477638081967e-06);
    AssertAlmostEqual(&test, rTM, 6.5477638081967e-06);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.5477638081967e-06);
    AssertAlmostEqual(&test, rTM, 6.5477638081967e-06);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.5477638081967e-06);
    AssertAlmostEqual(&test, rTM, 6.5477638081967e-06);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.547763808196699e-06);
    AssertAlmostEqual(&test, rTM, 6.5477638081967e-06);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.547763808196634e-06);
    AssertAlmostEqual(&test, rTM, 6.547763808196765e-06);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.547763808190152e-06);
    AssertAlmostEqual(&test, rTM, 6.547763808203247e-06);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.547763807541932e-06);
    AssertAlmostEqual(&test, rTM, 6.547763808851467e-06);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54776374271992e-06);
    AssertAlmostEqual(&test, rTM, 6.547763873673479e-06);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.547757260525185e-06);
    AssertAlmostEqual(&test, rTM, 6.547770355868214e-06);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.547109105859842e-06);
    AssertAlmostEqual(&test, rTM, 6.548418510533557e-06);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.482935304124507e-06);
    AssertAlmostEqual(&test, rTM, 6.612592312268838e-06);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.273903340738884e-06);
    AssertAlmostEqual(&test, rTM, 9.821624275514156e-06);

    userdata[0] = 10/CAPS_HBAR_EV; /* 10eV */
    userdata[1] = 1/CAPS_HBAR_EV; /* 1eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999874981344054);
    AssertAlmostEqual(&test, rTM, 0.9999937490476654);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999111609435354);
    AssertAlmostEqual(&test, rTM, 0.9999991203666938);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991163255793382);
    AssertAlmostEqual(&test, rTM, 0.999999911602323);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9911987747123984);
    AssertAlmostEqual(&test, rTM, 0.9999999911597089);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9154190576579804);
    AssertAlmostEqual(&test, rTM, 0.9999999991151159);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4242187861093208);
    AssertAlmostEqual(&test, rTM, 0.9999999999033472);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01247865837028941);
    AssertAlmostEqual(&test, rTM, 0.9999999999599378);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001279274642580153);
    AssertAlmostEqual(&test, rTM, 0.9999999999609154);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279598739368619e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999609253);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279601981373147e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999609254);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279602013793296e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999999609254);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279602014117498e-12);
    AssertAlmostEqual(&test, rTM, 0.9999999999609254);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.27960201412074e-14);
    AssertAlmostEqual(&test, rTM, 0.9999999999609254);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999719057700657);
    AssertAlmostEqual(&test, rTM, 0.9999721839268894);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999604661637282);
    AssertAlmostEqual(&test, rTM, 0.9999802328864928);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997190932167693);
    AssertAlmostEqual(&test, rTM, 0.9999972183578433);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9972082457212463);
    AssertAlmostEqual(&test, rTM, 0.9999997204617795);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9724328058863566);
    AssertAlmostEqual(&test, rTM, 0.9999999720420873);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7568050467672996);
    AssertAlmostEqual(&test, rTM, 0.999999997177304);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1029657829203601);
    AssertAlmostEqual(&test, rTM, 0.9999999995195501);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001276337667696434);
    AssertAlmostEqual(&test, rTM, 0.9999999996082548);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279569245043182e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999996092435);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279601664144626e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999996092535);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279601988346011e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999996092535);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279601991588025e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999996092535);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279601991620446e-13);
    AssertAlmostEqual(&test, rTM, 0.9999999996092535);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999720486698828);
    AssertAlmostEqual(&test, rTM, 0.999720486978302);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997204728652098);
    AssertAlmostEqual(&test, rTM, 0.9997205008112218);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997190929451434);
    AssertAlmostEqual(&test, rTM, 0.9997218738162876);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996047315818192);
    AssertAlmostEqual(&test, rTM, 0.9998023462554779);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9971944785997903);
    AssertAlmostEqual(&test, rTM, 0.9999721838730856);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.972431434128665);
    AssertAlmostEqual(&test, rTM, 0.9999972043483079);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7568047404149441);
    AssertAlmostEqual(&test, rTM, 0.9999997177303034);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1029656201194936);
    AssertAlmostEqual(&test, rTM, 0.9999999519549327);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001276335205182807);
    AssertAlmostEqual(&test, rTM, 0.9999999608254035);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279566770173473e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999609242759);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279599189150764e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999609252659);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279599513350907e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999609252758);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279599516592909e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999609252759);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999116361108636);
    AssertAlmostEqual(&test, rTM, 0.9991163611174685);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991163606714282);
    AssertAlmostEqual(&test, rTM, 0.9991163615546761);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999116316951742);
    AssertAlmostEqual(&test, rTM, 0.9991164052721566);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991119558669819);
    AssertAlmostEqual(&test, rTM, 0.9991207445159992);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9987505746781753);
    AssertAlmostEqual(&test, rTM, 0.9993750920231088);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9911549914387835);
    AssertAlmostEqual(&test, rTM, 0.9999120387896268);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9154142261610254);
    AssertAlmostEqual(&test, rTM, 0.999991151555139);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4242152642895281);
    AssertAlmostEqual(&test, rTM, 0.9999990334623692);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01247842048689627);
    AssertAlmostEqual(&test, rTM, 0.9999995993708161);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001279249658228926);
    AssertAlmostEqual(&test, rTM, 0.9999996091460387);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279573742483706e-06);
    AssertAlmostEqual(&test, rTM, 0.9999996092450258);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279576984362837e-08);
    AssertAlmostEqual(&test, rTM, 0.9999996092460158);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279577016781733e-10);
    AssertAlmostEqual(&test, rTM, 0.9999996092460258);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9972081128215704);
    AssertAlmostEqual(&test, rTM, 0.9972081128218492);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9972081128077699);
    AssertAlmostEqual(&test, rTM, 0.9972081128356497);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9972081114277179);
    AssertAlmostEqual(&test, rTM, 0.997208114215701);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9972079734259837);
    AssertAlmostEqual(&test, rTM, 0.9972082522104861);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9971942076732973);
    AssertAlmostEqual(&test, rTM, 0.997221949153838);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960539608118741);
    AssertAlmostEqual(&test, rTM, 0.9980250282252416);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9722945898271455);
    AssertAlmostEqual(&test, rTM, 0.9997218200209527);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7567741060847643);
    AssertAlmostEqual(&test, rTM, 0.9999717720678586);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1029493426439036);
    AssertAlmostEqual(&test, rTM, 0.9999951947428343);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001276089001794276);
    AssertAlmostEqual(&test, rTM, 0.9999960817997531);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279319331539414e-05);
    AssertAlmostEqual(&test, rTM, 0.9999960916869353);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279351738105027e-07);
    AssertAlmostEqual(&test, rTM, 0.9999960917859334);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279352062181047e-09);
    AssertAlmostEqual(&test, rTM, 0.9999960917869234);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9911902237023318);
    AssertAlmostEqual(&test, rTM, 0.9911902237023406);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9911902237018976);
    AssertAlmostEqual(&test, rTM, 0.9911902237027747);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9911902236584822);
    AssertAlmostEqual(&test, rTM, 0.9911902237461901);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.991190219316938);
    AssertAlmostEqual(&test, rTM, 0.9911902280877322);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.99118978517347);
    AssertAlmostEqual(&test, rTM, 0.9911906622094711);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9911464797673536);
    AssertAlmostEqual(&test, rTM, 0.991233752456548);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9875639065141799);
    AssertAlmostEqual(&test, rTM, 0.9937624391954201);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9149366326430387);
    AssertAlmostEqual(&test, rTM, 0.9991190429177941);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4238668887838006);
    AssertAlmostEqual(&test, rTM, 0.9999032480337134);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01245491247828691);
    AssertAlmostEqual(&test, rTM, 0.9999598630564425);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001276780782371855);
    AssertAlmostEqual(&test, rTM, 0.999960840543927);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.277103629306542e-06);
    AssertAlmostEqual(&test, rTM, 0.9999608504420689);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.277106858806546e-08);
    AssertAlmostEqual(&test, rTM, 0.999960850541063);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9721686095647126);
    AssertAlmostEqual(&test, rTM, 0.972168609564713);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9721686095646991);
    AssertAlmostEqual(&test, rTM, 0.9721686095647265);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9721686095633408);
    AssertAlmostEqual(&test, rTM, 0.9721686095660848);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9721686094275196);
    AssertAlmostEqual(&test, rTM, 0.972168609701906);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9721685958454004);
    AssertAlmostEqual(&test, rTM, 0.9721686232840185);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9721672376683953);
    AssertAlmostEqual(&test, rTM, 0.9721699813943628);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9720317673843616);
    AssertAlmostEqual(&test, rTM, 0.972304791610484);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9608698610186748);
    AssertAlmostEqual(&test, rTM, 0.9802377476940243);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7537196740938393);
    AssertAlmostEqual(&test, rTM, 0.9971677816664118);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1013472891023817);
    AssertAlmostEqual(&test, rTM, 0.9995119794246028);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001251939234622125);
    AssertAlmostEqual(&test, rTM, 0.9996007798601301);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.255049573793375e-05);
    AssertAlmostEqual(&test, rTM, 0.9996017680162866);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.255080774754799e-07);
    AssertAlmostEqual(&test, rTM, 0.9996017779102482);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9079053108836354);
    AssertAlmostEqual(&test, rTM, 0.9079053108836354);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9079053108836349);
    AssertAlmostEqual(&test, rTM, 0.9079053108836358);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9079053108835915);
    AssertAlmostEqual(&test, rTM, 0.9079053108836792);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9079053108792529);
    AssertAlmostEqual(&test, rTM, 0.9079053108880178);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.907905310445389);
    AssertAlmostEqual(&test, rTM, 0.9079053113218817);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9079052670590105);
    AssertAlmostEqual(&test, rTM, 0.9079053547082403);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9079009285403404);
    AssertAlmostEqual(&test, rTM, 0.9079096930284706);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9074682624586705);
    AssertAlmostEqual(&test, rTM, 0.9083403942244029);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.872335245154248);
    AssertAlmostEqual(&test, rTM, 0.9339146140361049);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3919097588691505);
    AssertAlmostEqual(&test, rTM, 0.9893899239093975);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01048037401425547);
    AssertAlmostEqual(&test, rTM, 0.9952525883422696);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001070232131794294);
    AssertAlmostEqual(&test, rTM, 0.9953498437160606);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.070460015921595e-06);
    AssertAlmostEqual(&test, rTM, 0.995350826714998);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6212976663489552);
    AssertAlmostEqual(&test, rTM, 0.6212976663489552);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6212976663489552);
    AssertAlmostEqual(&test, rTM, 0.6212976663489552);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6212976663489538);
    AssertAlmostEqual(&test, rTM, 0.6212976663489567);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6212976663488101);
    AssertAlmostEqual(&test, rTM, 0.6212976663491003);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6212976663344429);
    AssertAlmostEqual(&test, rTM, 0.6212976663634675);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6212976648977295);
    AssertAlmostEqual(&test, rTM, 0.6212976678001808);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6212975212264453);
    AssertAlmostEqual(&test, rTM, 0.6212978114714225);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6212831546445051);
    AssertAlmostEqual(&test, rTM, 0.6213121776272253);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6198519326646841);
    AssertAlmostEqual(&test, rTM, 0.622739182323004);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5132335499853441);
    AssertAlmostEqual(&test, rTM, 0.7099692346882719);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03956560366247851);
    AssertAlmostEqual(&test, rTM, 0.8884765392735432);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004327970862134224);
    AssertAlmostEqual(&test, rTM, 0.8964414842780564);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.332110867149634e-06);
    AssertAlmostEqual(&test, rTM, 0.89652559934862);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05557345736897762);
    AssertAlmostEqual(&test, rTM, 0.05557345736897762);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05557345736897762);
    AssertAlmostEqual(&test, rTM, 0.05557345736897762);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05557345736897761);
    AssertAlmostEqual(&test, rTM, 0.05557345736897763);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05557345736897712);
    AssertAlmostEqual(&test, rTM, 0.05557345736897811);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05557345736892789);
    AssertAlmostEqual(&test, rTM, 0.05557345736902734);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05557345736400544);
    AssertAlmostEqual(&test, rTM, 0.0555734573739498);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05557345687175928);
    AssertAlmostEqual(&test, rTM, 0.05557345786619595);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05557340764718826);
    AssertAlmostEqual(&test, rTM, 0.0555735070907667);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05556848563178083);
    AssertAlmostEqual(&test, rTM, 0.05557842910341854);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05508066163348156);
    AssertAlmostEqual(&test, rTM, 0.05606622603057571);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02935116395116614);
    AssertAlmostEqual(&test, rTM, 0.08171931191298329);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006161328194671334);
    AssertAlmostEqual(&test, rTM, 0.110196094786905);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.229916262624601e-06);
    AssertAlmostEqual(&test, rTM, 0.1107985510416759);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006507694559152937);
    AssertAlmostEqual(&test, rTM, 0.0006507694559152937);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006507694559152937);
    AssertAlmostEqual(&test, rTM, 0.0006507694559152937);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006507694559152937);
    AssertAlmostEqual(&test, rTM, 0.0006507694559152937);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006507694559152937);
    AssertAlmostEqual(&test, rTM, 0.0006507694559152938);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006507694559152872);
    AssertAlmostEqual(&test, rTM, 0.0006507694559153002);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006507694559146439);
    AssertAlmostEqual(&test, rTM, 0.0006507694559159437);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006507694558503015);
    AssertAlmostEqual(&test, rTM, 0.000650769455980286);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006507694494160638);
    AssertAlmostEqual(&test, rTM, 0.0006507694624145237);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006507688059929378);
    AssertAlmostEqual(&test, rTM, 0.0006507701058376497);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006507044701049259);
    AssertAlmostEqual(&test, rTM, 0.0006508344417256561);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000644334491834059);
    AssertAlmostEqual(&test, rTM, 0.0006572044199426333);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003255965128277766);
    AssertAlmostEqual(&test, rTM, 0.0009759422613814145);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.451573042784302e-06);
    AssertAlmostEqual(&test, rTM, 0.001295086798459961);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546088981025428e-06);
    AssertAlmostEqual(&test, rTM, 6.546088981025428e-06);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546088981025428e-06);
    AssertAlmostEqual(&test, rTM, 6.546088981025428e-06);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546088981025428e-06);
    AssertAlmostEqual(&test, rTM, 6.546088981025428e-06);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546088981025428e-06);
    AssertAlmostEqual(&test, rTM, 6.546088981025428e-06);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546088981025427e-06);
    AssertAlmostEqual(&test, rTM, 6.546088981025428e-06);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546088981025361e-06);
    AssertAlmostEqual(&test, rTM, 6.546088981025493e-06);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546088981018881e-06);
    AssertAlmostEqual(&test, rTM, 6.546088981031973e-06);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546088980370827e-06);
    AssertAlmostEqual(&test, rTM, 6.546088981680027e-06);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546088915565395e-06);
    AssertAlmostEqual(&test, rTM, 6.546089046485459e-06);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546082435028694e-06);
    AssertAlmostEqual(&test, rTM, 6.54609552702216e-06);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.545434446150155e-06);
    AssertAlmostEqual(&test, rTM, 6.546743515900699e-06);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.481277058970522e-06);
    AssertAlmostEqual(&test, rTM, 6.610900903080278e-06);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.27306591618825e-06);
    AssertAlmostEqual(&test, rTM, 9.819112045722352e-06);

    userdata[0] = 20/CAPS_HBAR_EV; /* 20eV */
    userdata[1] = 1e-05/CAPS_HBAR_EV; /* 1e-05eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999802307606);
    AssertAlmostEqual(&test, rTM, 0.9999999901153802);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999998595131666);
    AssertAlmostEqual(&test, rTM, 0.9999999986090412);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999986020347466);
    AssertAlmostEqual(&test, rTM, 0.9999999998602174);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999986021127341);
    AssertAlmostEqual(&test, rTM, 0.9999999999860211);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998602201357814);
    AssertAlmostEqual(&test, rTM, 0.9999999999986021);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9986030803780677);
    AssertAlmostEqual(&test, rTM, 0.9999999999998602);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9861184008816356);
    AssertAlmostEqual(&test, rTM, 0.999999999999986);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8696398969845892);
    AssertAlmostEqual(&test, rTM, 0.9999999999999986);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2715499119134019);
    AssertAlmostEqual(&test, rTM, 0.9999999999999998);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.005065693141032068);
    AssertAlmostEqual(&test, rTM, 0.9999999999999999);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.116884571469215e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999999999);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.11740302425141e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999999999);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.117408209442439e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999999999999);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999555351269);
    AssertAlmostEqual(&test, rTM, 0.9999999559753732);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999374292494);
    AssertAlmostEqual(&test, rTM, 0.9999999687146243);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999995553513578);
    AssertAlmostEqual(&test, rTM, 0.9999999955975373);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999955753682339);
    AssertAlmostEqual(&test, rTM, 0.9999999995575801);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999557567532501);
    AssertAlmostEqual(&test, rTM, 0.9999999999557558);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995576558305119);
    AssertAlmostEqual(&test, rTM, 0.9999999999955755);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9955853565819123);
    AssertAlmostEqual(&test, rTM, 0.9999999999995576);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9567237464209527);
    AssertAlmostEqual(&test, rTM, 0.9999999999999557);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.644738476131817);
    AssertAlmostEqual(&test, rTM, 0.9999999999999954);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04644887555600855);
    AssertAlmostEqual(&test, rTM, 0.9999999999999989);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005103215015237681);
    AssertAlmostEqual(&test, rTM, 0.999999999999999);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.108375374313599e-06);
    AssertAlmostEqual(&test, rTM, 0.999999999999999);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.10842704379087e-08);
    AssertAlmostEqual(&test, rTM, 0.999999999999999);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999995167360221);
    AssertAlmostEqual(&test, rTM, 0.9999995167365053);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999995167121011);
    AssertAlmostEqual(&test, rTM, 0.9999995167604251);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999995143259564);
    AssertAlmostEqual(&test, rTM, 0.999999519134609);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999993165619383);
    AssertAlmostEqual(&test, rTM, 0.9999996582809108);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999951432701781);
    AssertAlmostEqual(&test, rTM, 0.9999999519134505);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999516723662535);
    AssertAlmostEqual(&test, rTM, 0.9999999951676031);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995168526632517);
    AssertAlmostEqual(&test, rTM, 0.9999999995167363);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.99517902453463);
    AssertAlmostEqual(&test, rTM, 0.9999999999516734);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9528272285860738);
    AssertAlmostEqual(&test, rTM, 0.999999999995166);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6196003293808923);
    AssertAlmostEqual(&test, rTM, 0.9999999999995028);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03950243876444921);
    AssertAlmostEqual(&test, rTM, 0.9999999999998737);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004278186347477572);
    AssertAlmostEqual(&test, rTM, 0.9999999999998831);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.281812605522872e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999998832);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999975977533023);
    AssertAlmostEqual(&test, rTM, 0.9999975977533264);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999975977521133);
    AssertAlmostEqual(&test, rTM, 0.9999975977545155);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999975976332052);
    AssertAlmostEqual(&test, rTM, 0.9999975978734176);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999975857719743);
    AssertAlmostEqual(&test, rTM, 0.9999976096751935);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999966027118472);
    AssertAlmostEqual(&test, rTM, 0.9999983013544809);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999975857982024);
    AssertAlmostEqual(&test, rTM, 0.9999997609672622);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997597918871161);
    AssertAlmostEqual(&test, rTM, 0.9999999759787055);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9976006328993599);
    AssertAlmostEqual(&test, rTM, 0.9999999975977499);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.976264311521328);
    AssertAlmostEqual(&test, rTM, 0.9999999997597577);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7869023995924787);
    AssertAlmostEqual(&test, rTM, 0.9999999999758048);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1308915697421148);
    AssertAlmostEqual(&test, rTM, 0.9999999999962454);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001726881370084025);
    AssertAlmostEqual(&test, rTM, 0.9999999999971046);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.732801040014634e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999971145);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999799691153162);
    AssertAlmostEqual(&test, rTM, 0.9999799691153182);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999979969115217);
    AssertAlmostEqual(&test, rTM, 0.9999799691154173);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999799691053018);
    AssertAlmostEqual(&test, rTM, 0.9999799691253325);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999799681138081);
    AssertAlmostEqual(&test, rTM, 0.9999799701167763);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999798692110413);
    AssertAlmostEqual(&test, rTM, 0.9999800685237971);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999716721687356);
    AssertAlmostEqual(&test, rTM, 0.9999858359840574);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997987103459601);
    AssertAlmostEqual(&test, rTM, 0.9999980068344927);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9979987967343723);
    AssertAlmostEqual(&test, rTM, 0.9999997996990814);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9801685224239607);
    AssertAlmostEqual(&test, rTM, 0.9999999799679202);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8187492019512188);
    AssertAlmostEqual(&test, rTM, 0.9999999979868699);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1711963076173644);
    AssertAlmostEqual(&test, rTM, 0.9999999997164974);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002479901031076601);
    AssertAlmostEqual(&test, rTM, 0.9999999997983803);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.49212253644255e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999997993678);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998041465739368);
    AssertAlmostEqual(&test, rTM, 0.999804146573937);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998041465739271);
    AssertAlmostEqual(&test, rTM, 0.9998041465739468);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998041465729578);
    AssertAlmostEqual(&test, rTM, 0.9998041465749161);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998041464760199);
    AssertAlmostEqual(&test, rTM, 0.999804146671854);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998041367824695);
    AssertAlmostEqual(&test, rTM, 0.9998041563649149);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998031698389539);
    AssertAlmostEqual(&test, rTM, 0.9998051184625171);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997230326644602);
    AssertAlmostEqual(&test, rTM, 0.9998615067413748);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9980334411838646);
    AssertAlmostEqual(&test, rTM, 0.9999805101277094);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9806026699449588);
    AssertAlmostEqual(&test, rTM, 0.9999980412798462);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8223732347385213);
    AssertAlmostEqual(&test, rTM, 0.9999998031903943);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1766807182626544);
    AssertAlmostEqual(&test, rTM, 0.9999999725837686);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002592969674264731);
    AssertAlmostEqual(&test, rTM, 0.9999999807172204);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.606333276051327e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999808159611);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.998047676179873);
    AssertAlmostEqual(&test, rTM, 0.998047676179873);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9980476761798721);
    AssertAlmostEqual(&test, rTM, 0.998047676179874);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9980476761797755);
    AssertAlmostEqual(&test, rTM, 0.9980476761799706);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9980476761701209);
    AssertAlmostEqual(&test, rTM, 0.9980476761896251);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9980476752046652);
    AssertAlmostEqual(&test, rTM, 0.9980476771550804);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9980475786615071);
    AssertAlmostEqual(&test, rTM, 0.9980477736933731);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9980379484054926);
    AssertAlmostEqual(&test, rTM, 0.9980573557712248);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9972401144224141);
    AssertAlmostEqual(&test, rTM, 0.9986191031152601);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9805521212640549);
    AssertAlmostEqual(&test, rTM, 0.9998055563247271);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8227331891863217);
    AssertAlmostEqual(&test, rTM, 0.9999803657907732);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.177249054556844);
    AssertAlmostEqual(&test, rTM, 0.9999972677440833);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002604846192067409);
    AssertAlmostEqual(&test, rTM, 0.9999980805175881);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.618332754796085e-05);
    AssertAlmostEqual(&test, rTM, 0.9999980903915138);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9806521064276267);
    AssertAlmostEqual(&test, rTM, 0.9806521064276267);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9806521064276266);
    AssertAlmostEqual(&test, rTM, 0.9806521064276268);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9806521064276171);
    AssertAlmostEqual(&test, rTM, 0.9806521064276362);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9806521064266688);
    AssertAlmostEqual(&test, rTM, 0.9806521064285846);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9806521063318322);
    AssertAlmostEqual(&test, rTM, 0.9806521065234212);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9806520968481818);
    AssertAlmostEqual(&test, rTM, 0.9806521160070669);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9806511485073085);
    AssertAlmostEqual(&test, rTM, 0.9806530643009835);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9805565549284285);
    AssertAlmostEqual(&test, rTM, 0.9807471929199181);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9727484333113972);
    AssertAlmostEqual(&test, rTM, 0.9862794487391778);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8219804724794012);
    AssertAlmostEqual(&test, rTM, 0.9980486592512621);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1772938429622406);
    AssertAlmostEqual(&test, rTM, 0.9997269376639191);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002606037266395872);
    AssertAlmostEqual(&test, rTM, 0.9998081760192802);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619538756539337e-05);
    AssertAlmostEqual(&test, rTM, 0.9998091631293967);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8227817184427215);
    AssertAlmostEqual(&test, rTM, 0.8227817184427215);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8227817184427215);
    AssertAlmostEqual(&test, rTM, 0.8227817184427216);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8227817184427207);
    AssertAlmostEqual(&test, rTM, 0.8227817184427224);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8227817184426416);
    AssertAlmostEqual(&test, rTM, 0.8227817184428016);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8227817184347221);
    AssertAlmostEqual(&test, rTM, 0.822781718450721);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8227817176427796);
    AssertAlmostEqual(&test, rTM, 0.8227817192426635);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8227816384485473);
    AssertAlmostEqual(&test, rTM, 0.8227817984368632);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8227737192636423);
    AssertAlmostEqual(&test, rTM, 0.8227897172958557);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8219841720101468);
    AssertAlmostEqual(&test, rTM, 0.8235760377003263);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7592465038744053);
    AssertAlmostEqual(&test, rTM, 0.8707814501876804);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.176081783302795);
    AssertAlmostEqual(&test, rTM, 0.9733737213821586);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002605900047889007);
    AssertAlmostEqual(&test, rTM, 0.9811750416940582);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619656827089927e-05);
    AssertAlmostEqual(&test, rTM, 0.9812710102187828);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1773125103298058);
    AssertAlmostEqual(&test, rTM, 0.1773125103298058);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1773125103298058);
    AssertAlmostEqual(&test, rTM, 0.1773125103298058);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1773125103298058);
    AssertAlmostEqual(&test, rTM, 0.1773125103298058);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1773125103298046);
    AssertAlmostEqual(&test, rTM, 0.177312510329807);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1773125103296819);
    AssertAlmostEqual(&test, rTM, 0.1773125103299297);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1773125103174155);
    AssertAlmostEqual(&test, rTM, 0.1773125103421961);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1773125090907738);
    AssertAlmostEqual(&test, rTM, 0.1773125115688377);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1773123864266981);
    AssertAlmostEqual(&test, rTM, 0.1773126342329079);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1773001209039504);
    AssertAlmostEqual(&test, rTM, 0.1773248996994602);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1760823515504473);
    AssertAlmostEqual(&test, rTM, 0.1785421152880639);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1049405548430843);
    AssertAlmostEqual(&test, rTM, 0.247816257801537);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002580500378987969);
    AssertAlmostEqual(&test, rTM, 0.3415380714650547);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619409586373508e-05);
    AssertAlmostEqual(&test, rTM, 0.3437924558230128);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002606172420483085);
    AssertAlmostEqual(&test, rTM, 0.002606172420483085);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002606172420483085);
    AssertAlmostEqual(&test, rTM, 0.002606172420483085);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002606172420483085);
    AssertAlmostEqual(&test, rTM, 0.002606172420483086);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002606172420483085);
    AssertAlmostEqual(&test, rTM, 0.002606172420483086);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.00260617242048306);
    AssertAlmostEqual(&test, rTM, 0.002606172420483111);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002606172420480493);
    AssertAlmostEqual(&test, rTM, 0.002606172420485678);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002606172420223823);
    AssertAlmostEqual(&test, rTM, 0.002606172420742348);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002606172394556851);
    AssertAlmostEqual(&test, rTM, 0.00260617244640932);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002606169827862203);
    AssertAlmostEqual(&test, rTM, 0.002606175013103969);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002605913183925941);
    AssertAlmostEqual(&test, rTM, 0.00260643165703988);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002580501561593544);
    AssertAlmostEqual(&test, rTM, 0.002631843275937706);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001306484484494316);
    AssertAlmostEqual(&test, rTM, 0.003905851551837532);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.593736712106311e-05);
    AssertAlmostEqual(&test, rTM, 0.005186372772301702);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619672840985198e-05);
    AssertAlmostEqual(&test, rTM, 2.619672840985198e-05);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619672840985198e-05);
    AssertAlmostEqual(&test, rTM, 2.619672840985198e-05);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619672840985198e-05);
    AssertAlmostEqual(&test, rTM, 2.619672840985198e-05);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619672840985198e-05);
    AssertAlmostEqual(&test, rTM, 2.619672840985198e-05);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619672840985198e-05);
    AssertAlmostEqual(&test, rTM, 2.619672840985198e-05);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619672840985172e-05);
    AssertAlmostEqual(&test, rTM, 2.619672840985225e-05);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619672840982579e-05);
    AssertAlmostEqual(&test, rTM, 2.619672840987818e-05);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619672840723245e-05);
    AssertAlmostEqual(&test, rTM, 2.619672841247152e-05);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619672814789843e-05);
    AssertAlmostEqual(&test, rTM, 2.619672867180554e-05);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619670221452227e-05);
    AssertAlmostEqual(&test, rTM, 2.61967546051817e-05);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619410913617476e-05);
    AssertAlmostEqual(&test, rTM, 2.61993476835292e-05);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.593736831582339e-05);
    AssertAlmostEqual(&test, rTM, 2.645608850387705e-05);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.309870734146287e-05);
    AssertAlmostEqual(&test, rTM, 3.929474946925257e-05);

    userdata[0] = 20/CAPS_HBAR_EV; /* 20eV */
    userdata[1] = 0.0001/CAPS_HBAR_EV; /* 0.0001eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999374896726);
    AssertAlmostEqual(&test, rTM, 0.9999999687448359);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999995557807452);
    AssertAlmostEqual(&test, rTM, 0.9999999956017885);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999955796409944);
    AssertAlmostEqual(&test, rTM, 0.9999999995580073);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999557994770391);
    AssertAlmostEqual(&test, rTM, 0.9999999999557986);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995580828981702);
    AssertAlmostEqual(&test, rTM, 0.9999999999955799);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9955896102844446);
    AssertAlmostEqual(&test, rTM, 0.999999999999558);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.956764613955449);
    AssertAlmostEqual(&test, rTM, 0.9999999999999558);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6450075042344648);
    AssertAlmostEqual(&test, rTM, 0.9999999999999954);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04653072581701291);
    AssertAlmostEqual(&test, rTM, 0.9999999999999989);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005113075347582465);
    AssertAlmostEqual(&test, rTM, 0.999999999999999);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.118255674952231e-06);
    AssertAlmostEqual(&test, rTM, 0.999999999999999);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.118307544495301e-08);
    AssertAlmostEqual(&test, rTM, 0.999999999999999);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.118308063197368e-10);
    AssertAlmostEqual(&test, rTM, 0.999999999999999);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999998595131666);
    AssertAlmostEqual(&test, rTM, 0.9999998609041253);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999998023076236);
    AssertAlmostEqual(&test, rTM, 0.9999999011538069);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999985951325545);
    AssertAlmostEqual(&test, rTM, 0.9999999860904116);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999860204354095);
    AssertAlmostEqual(&test, rTM, 0.9999999986021736);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998602200665953);
    AssertAlmostEqual(&test, rTM, 0.9999999998602105);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9986030803711577);
    AssertAlmostEqual(&test, rTM, 0.9999999999860211);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9861184008809533);
    AssertAlmostEqual(&test, rTM, 0.9999999999986021);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8696398969845293);
    AssertAlmostEqual(&test, rTM, 0.9999999999998599);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2715499119134004);
    AssertAlmostEqual(&test, rTM, 0.9999999999999829);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.005065693141032068);
    AssertAlmostEqual(&test, rTM, 0.9999999999999901);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.116884571469215e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999999902);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.11740302425141e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999999902);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.117408209442439e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999999999902);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999985886522933);
    AssertAlmostEqual(&test, rTM, 0.9999985886537046);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999985885824334);
    AssertAlmostEqual(&test, rTM, 0.999998588723561);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999998581613823);
    AssertAlmostEqual(&test, rTM, 0.9999985956572407);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999980040545133);
    AssertAlmostEqual(&test, rTM, 0.9999990020267586);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999858162287626);
    AssertAlmostEqual(&test, rTM, 0.9999998595656353);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998588681038945);
    AssertAlmostEqual(&test, rTM, 0.9999999858872257);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9985896468984744);
    AssertAlmostEqual(&test, rTM, 0.9999999985886524);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9859857637144345);
    AssertAlmostEqual(&test, rTM, 0.9999999998588617);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8684737439631637);
    AssertAlmostEqual(&test, rTM, 0.9999999999858514);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2685770658769361);
    AssertAlmostEqual(&test, rTM, 0.9999999999982726);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.004970540937727791);
    AssertAlmostEqual(&test, rTM, 0.9999999999989941);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.019820349826506e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999990039);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.020319318978657e-07);
    AssertAlmostEqual(&test, rTM, 0.999999999999004);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999995167373122);
    AssertAlmostEqual(&test, rTM, 0.9999951673731703);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999951673707299);
    AssertAlmostEqual(&test, rTM, 0.9999951673755625);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999951671315215);
    AssertAlmostEqual(&test, rTM, 0.9999951676147588);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999951432701781);
    AssertAlmostEqual(&test, rTM, 0.9999951913564964);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999931656404017);
    AssertAlmostEqual(&test, rTM, 0.9999965828143623);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999514337632242);
    AssertAlmostEqual(&test, rTM, 0.9999995191346089);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995168287538533);
    AssertAlmostEqual(&test, rTM, 0.9999999516760306);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.995179022154014);
    AssertAlmostEqual(&test, rTM, 0.9999999951673498);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9528272283582092);
    AssertAlmostEqual(&test, rTM, 0.9999999995165951);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6196003293664851);
    AssertAlmostEqual(&test, rTM, 0.9999999999502829);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03950243876441308);
    AssertAlmostEqual(&test, rTM, 0.9999999999873623);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004278186347477531);
    AssertAlmostEqual(&test, rTM, 0.9999999999883128);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.281812605522872e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999883227);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999759777928269);
    AssertAlmostEqual(&test, rTM, 0.9999759777928292);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999975977792708);
    AssertAlmostEqual(&test, rTM, 0.9999759777929481);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999759777808171);
    AssertAlmostEqual(&test, rTM, 0.999975977804839);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999759765917622);
    AssertAlmostEqual(&test, rTM, 0.9999759789938339);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999975857982024);
    AssertAlmostEqual(&test, rTM, 0.9999760970090481);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999660276378397);
    AssertAlmostEqual(&test, rTM, 0.999983013674651);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997586060467982);
    AssertAlmostEqual(&test, rTM, 0.9999976096751764);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9976005142764058);
    AssertAlmostEqual(&test, rTM, 0.9999997597869088);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9762642999132772);
    AssertAlmostEqual(&test, rTM, 0.9999999759757838);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7869023986634399);
    AssertAlmostEqual(&test, rTM, 0.9999999975804839);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1308915697321562);
    AssertAlmostEqual(&test, rTM, 0.999999999624549);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001726881370082321);
    AssertAlmostEqual(&test, rTM, 0.9999999997104616);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.732801040014618e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999997114498);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997997092081743);
    AssertAlmostEqual(&test, rTM, 0.9997997092081745);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997997092081643);
    AssertAlmostEqual(&test, rTM, 0.9997997092081844);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999799709207173);
    AssertAlmostEqual(&test, rTM, 0.9997997092091757);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997997091080391);
    AssertAlmostEqual(&test, rTM, 0.9997997093083096);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997996991948882);
    AssertAlmostEqual(&test, rTM, 0.99979971922096);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997987103459601);
    AssertAlmostEqual(&test, rTM, 0.9998007031142159);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997167577965367);
    AssertAlmostEqual(&test, rTM, 0.9998583688678694);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9979889261057222);
    AssertAlmostEqual(&test, rTM, 0.9999800685138994);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9801675506226789);
    AssertAlmostEqual(&test, rTM, 0.9999979968931744);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8187491211732252);
    AssertAlmostEqual(&test, rTM, 0.9999997986871058);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1711963064179989);
    AssertAlmostEqual(&test, rTM, 0.9999999716497449);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002479901030832306);
    AssertAlmostEqual(&test, rTM, 0.9999999798380295);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.492122536440082e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999799367815);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9980431912829435);
    AssertAlmostEqual(&test, rTM, 0.9980431912829435);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9980431912829425);
    AssertAlmostEqual(&test, rTM, 0.9980431912829445);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9980431912828458);
    AssertAlmostEqual(&test, rTM, 0.9980431912830412);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.998043191273169);
    AssertAlmostEqual(&test, rTM, 0.9980431912927179);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9980431903054976);
    AssertAlmostEqual(&test, rTM, 0.998043192260389);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9980430935407771);
    AssertAlmostEqual(&test, rTM, 0.9980432890202326);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9980334411838646);
    AssertAlmostEqual(&test, rTM, 0.998052893088633);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9972337769613432);
    AssertAlmostEqual(&test, rTM, 0.998615929993392);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9805078417404135);
    AssertAlmostEqual(&test, rTM, 0.999805109210141);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8223652994657434);
    AssertAlmostEqual(&test, rTM, 0.9999803202147095);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1766805958761063);
    AssertAlmostEqual(&test, rTM, 0.9999972583838757);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002592969648727112);
    AssertAlmostEqual(&test, rTM, 0.999998071725707);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.606333275793314e-05);
    AssertAlmostEqual(&test, rTM, 0.9999980815997513);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9806476943346313);
    AssertAlmostEqual(&test, rTM, 0.9806476943346313);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9806476943346312);
    AssertAlmostEqual(&test, rTM, 0.9806476943346314);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9806476943346217);
    AssertAlmostEqual(&test, rTM, 0.9806476943346409);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9806476943336732);
    AssertAlmostEqual(&test, rTM, 0.9806476943355895);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9806476942388153);
    AssertAlmostEqual(&test, rTM, 0.9806476944304474);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9806476847530237);
    AssertAlmostEqual(&test, rTM, 0.9806477039162342);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9806467361980455);
    AssertAlmostEqual(&test, rTM, 0.9806486524242453);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9805521212640549);
    AssertAlmostEqual(&test, rTM, 0.9807428022954308);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9727422442598359);
    AssertAlmostEqual(&test, rTM, 0.986276310714109);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8219434828175465);
    AssertAlmostEqual(&test, rTM, 0.9980482061138605);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1772367918116102);
    AssertAlmostEqual(&test, rTM, 0.9997268440879171);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.00260484362667207);
    AssertAlmostEqual(&test, rTM, 0.9998080881338163);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.618332728875948e-05);
    AssertAlmostEqual(&test, rTM, 0.9998090752449957);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8227780335261234);
    AssertAlmostEqual(&test, rTM, 0.8227780335261234);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8227780335261234);
    AssertAlmostEqual(&test, rTM, 0.8227780335261234);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8227780335261227);
    AssertAlmostEqual(&test, rTM, 0.8227780335261242);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8227780335260434);
    AssertAlmostEqual(&test, rTM, 0.8227780335262034);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8227780335181238);
    AssertAlmostEqual(&test, rTM, 0.8227780335341229);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8227780327261668);
    AssertAlmostEqual(&test, rTM, 0.8227780343260801);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8227779535304824);
    AssertAlmostEqual(&test, rTM, 0.8227781135217318);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.822770034200372);
    AssertAlmostEqual(&test, rTM, 0.8227860325259253);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8219804724794012);
    AssertAlmostEqual(&test, rTM, 0.8235723673545747);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.759241717601735);
    AssertAlmostEqual(&test, rTM, 0.8707786667559131);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1760761010344407);
    AssertAlmostEqual(&test, rTM, 0.9733728307327828);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002605780635445637);
    AssertAlmostEqual(&test, rTM, 0.9811741952508433);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619536163334424e-05);
    AssertAlmostEqual(&test, rTM, 0.9812701636633777);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1773119395635837);
    AssertAlmostEqual(&test, rTM, 0.1773119395635837);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1773119395635837);
    AssertAlmostEqual(&test, rTM, 0.1773119395635837);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1773119395635837);
    AssertAlmostEqual(&test, rTM, 0.1773119395635837);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1773119395635825);
    AssertAlmostEqual(&test, rTM, 0.177311939563585);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1773119395634598);
    AssertAlmostEqual(&test, rTM, 0.1773119395637076);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1773119395511934);
    AssertAlmostEqual(&test, rTM, 0.177311939575974);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1773119383245543);
    AssertAlmostEqual(&test, rTM, 0.1773119408026131);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1773118156607288);
    AssertAlmostEqual(&test, rTM, 0.177312063466433);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1772995501630086);
    AssertAlmostEqual(&test, rTM, 0.1773243289079584);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.176081783302795);
    AssertAlmostEqual(&test, rTM, 0.178541542007437);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1049401632528273);
    AssertAlmostEqual(&test, rTM, 0.247815523229231);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002580488552991852);
    AssertAlmostEqual(&test, rTM, 0.3415370408045468);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619397520580947e-05);
    AssertAlmostEqual(&test, rTM, 0.3437914166432224);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002606171226174258);
    AssertAlmostEqual(&test, rTM, 0.002606171226174258);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002606171226174258);
    AssertAlmostEqual(&test, rTM, 0.002606171226174258);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002606171226174258);
    AssertAlmostEqual(&test, rTM, 0.002606171226174258);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002606171226174258);
    AssertAlmostEqual(&test, rTM, 0.002606171226174259);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002606171226174232);
    AssertAlmostEqual(&test, rTM, 0.002606171226174284);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002606171226171666);
    AssertAlmostEqual(&test, rTM, 0.002606171226176851);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002606171225914996);
    AssertAlmostEqual(&test, rTM, 0.00260617122643352);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002606171200248036);
    AssertAlmostEqual(&test, rTM, 0.002606171252100481);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002606168633554557);
    AssertAlmostEqual(&test, rTM, 0.002606173818793959);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002605911989735293);
    AssertAlmostEqual(&test, rTM, 0.002606430462612873);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.00258050037898797);
    AssertAlmostEqual(&test, rTM, 0.00263184206992563);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001306483884224297);
    AssertAlmostEqual(&test, rTM, 0.00390584976350198);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.59373551734664e-05);
    AssertAlmostEqual(&test, rTM, 0.00518637039567935);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619672720314536e-05);
    AssertAlmostEqual(&test, rTM, 2.619672720314536e-05);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619672720314536e-05);
    AssertAlmostEqual(&test, rTM, 2.619672720314536e-05);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619672720314536e-05);
    AssertAlmostEqual(&test, rTM, 2.619672720314536e-05);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619672720314536e-05);
    AssertAlmostEqual(&test, rTM, 2.619672720314536e-05);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619672720314536e-05);
    AssertAlmostEqual(&test, rTM, 2.619672720314536e-05);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619672720314509e-05);
    AssertAlmostEqual(&test, rTM, 2.619672720314562e-05);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619672720311916e-05);
    AssertAlmostEqual(&test, rTM, 2.619672720317155e-05);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619672720052582e-05);
    AssertAlmostEqual(&test, rTM, 2.619672720576489e-05);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619672694119181e-05);
    AssertAlmostEqual(&test, rTM, 2.61967274650989e-05);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619670100781685e-05);
    AssertAlmostEqual(&test, rTM, 2.619675339847386e-05);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619410792958878e-05);
    AssertAlmostEqual(&test, rTM, 2.619934647670193e-05);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.593736712106311e-05);
    AssertAlmostEqual(&test, rTM, 2.645608728522407e-05);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.309870673807794e-05);
    AssertAlmostEqual(&test, rTM, 3.929474765922425e-05);

    userdata[0] = 20/CAPS_HBAR_EV; /* 20eV */
    userdata[1] = 0.001/CAPS_HBAR_EV; /* 0.001eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999998023267396);
    AssertAlmostEqual(&test, rTM, 0.9999999011633649);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999985952683988);
    AssertAlmostEqual(&test, rTM, 0.9999999860917567);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999860217871617);
    AssertAlmostEqual(&test, rTM, 0.9999999986023087);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998602335817469);
    AssertAlmostEqual(&test, rTM, 0.9999999998602239);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9986032153526553);
    AssertAlmostEqual(&test, rTM, 0.9999999999860224);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9861197337889225);
    AssertAlmostEqual(&test, rTM, 0.9999999999986022);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8696516234102742);
    AssertAlmostEqual(&test, rTM, 0.9999999999998599);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.271579999229427);
    AssertAlmostEqual(&test, rTM, 0.9999999999999829);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.005066663064416211);
    AssertAlmostEqual(&test, rTM, 0.9999999999999901);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.117874173563569e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999999902);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.118392826909578e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999999902);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.11839801410663e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999999999902);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.118398065978667e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999999999902);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999995557807452);
    AssertAlmostEqual(&test, rTM, 0.9999995601789546);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999993748969025);
    AssertAlmostEqual(&test, rTM, 0.9999996874484024);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999955578163314);
    AssertAlmostEqual(&test, rTM, 0.9999999560178867);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999557972892178);
    AssertAlmostEqual(&test, rTM, 0.9999999955800732);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995580826794696);
    AssertAlmostEqual(&test, rTM, 0.9999999995579855);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9955896102626615);
    AssertAlmostEqual(&test, rTM, 0.9999999999557985);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9567646139533561);
    AssertAlmostEqual(&test, rTM, 0.9999999999955788);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6450075042343271);
    AssertAlmostEqual(&test, rTM, 0.9999999999995474);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04653072581701249);
    AssertAlmostEqual(&test, rTM, 0.9999999999998928);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005113075347582465);
    AssertAlmostEqual(&test, rTM, 0.9999999999999022);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.118255674952232e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999999023);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.118307544495301e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999999023);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.118308063197369e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999999999023);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999955755872363);
    AssertAlmostEqual(&test, rTM, 0.9999955755916606);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999955753682339);
    AssertAlmostEqual(&test, rTM, 0.9999955758106519);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999995553522475);
    AssertAlmostEqual(&test, rTM, 0.9999955975469081);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999937429443261);
    AssertAlmostEqual(&test, rTM, 0.9999968714672691);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999555361144463);
    AssertAlmostEqual(&test, rTM, 0.9999995597538185);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995576337209606);
    AssertAlmostEqual(&test, rTM, 0.9999999557580086);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9955853543796944);
    AssertAlmostEqual(&test, rTM, 0.9999999955755711);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9567237462093783);
    AssertAlmostEqual(&test, rTM, 0.9999999995574497);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6447384761178921);
    AssertAlmostEqual(&test, rTM, 0.9999999999546861);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04644887555596623);
    AssertAlmostEqual(&test, rTM, 0.9999999999892587);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005103215015237631);
    AssertAlmostEqual(&test, rTM, 0.9999999999902023);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.108375374313598e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999902122);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.10842704379087e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999902123);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999985886619554);
    AssertAlmostEqual(&test, rTM, 0.9999858866196951);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999858866125679);
    AssertAlmostEqual(&test, rTM, 0.9999858866266812);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999858859139782);
    AssertAlmostEqual(&test, rTM, 0.9999858873252357);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999858162287626);
    AssertAlmostEqual(&test, rTM, 0.9999859566611551);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999800407244032);
    AssertAlmostEqual(&test, rTM, 0.9999900203124042);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998581713404723);
    AssertAlmostEqual(&test, rTM, 0.9999985956572373);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9985895771370595);
    AssertAlmostEqual(&test, rTM, 0.9999998588722313);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9859857568263409);
    AssertAlmostEqual(&test, rTM, 0.9999999858861758);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.868473743357938);
    AssertAlmostEqual(&test, rTM, 0.9999999985851423);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2685770658616057);
    AssertAlmostEqual(&test, rTM, 0.9999999998272625);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.004970540937722919);
    AssertAlmostEqual(&test, rTM, 0.9999999998994098);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.019820349826457e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999003948);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.020319318978657e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999004048);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999516747823931);
    AssertAlmostEqual(&test, rTM, 0.999951674782398);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999951674782154);
    AssertAlmostEqual(&test, rTM, 0.9999516747826371);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999516747582335);
    AssertAlmostEqual(&test, rTM, 0.9999516748065576);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999516723662535);
    AssertAlmostEqual(&test, rTM, 0.9999516771984168);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999514337632242);
    AssertAlmostEqual(&test, rTM, 0.9999519146054923);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999316585058736);
    AssertAlmostEqual(&test, rTM, 0.9999658286690869);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995144437637906);
    AssertAlmostEqual(&test, rTM, 0.9999951913563574);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9951787840983941);
    AssertAlmostEqual(&test, rTM, 0.9999995167590144);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9528272055717519);
    AssertAlmostEqual(&test, rTM, 0.9999999516595341);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6196003279257667);
    AssertAlmostEqual(&test, rTM, 0.9999999950282836);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03950243876079956);
    AssertAlmostEqual(&test, rTM, 0.9999999987362305);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004278186347473299);
    AssertAlmostEqual(&test, rTM, 0.9999999988312807);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.28181260552283e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999988322702);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997598038951784);
    AssertAlmostEqual(&test, rTM, 0.9997598038951786);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997598038951665);
    AssertAlmostEqual(&test, rTM, 0.9997598038951905);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997598038939777);
    AssertAlmostEqual(&test, rTM, 0.9997598038963793);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997598037750949);
    AssertAlmostEqual(&test, rTM, 0.9997598040152621);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997597918871161);
    AssertAlmostEqual(&test, rTM, 0.9997598159026407);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997586060467982);
    AssertAlmostEqual(&test, rTM, 0.9997609958002897);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996603283107723);
    AssertAlmostEqual(&test, rTM, 0.999830149729604);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9975886815566144);
    AssertAlmostEqual(&test, rTM, 0.9999760969919766);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9762631391379167);
    AssertAlmostEqual(&test, rTM, 0.9999975977001638);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7869023057596023);
    AssertAlmostEqual(&test, rTM, 0.9999997580485366);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1308915687362925);
    AssertAlmostEqual(&test, rTM, 0.999999962454902);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001726881369911949);
    AssertAlmostEqual(&test, rTM, 0.9999999710461586);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.732801040012902e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999711449858);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9979988966868235);
    AssertAlmostEqual(&test, rTM, 0.9979988966868235);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9979988966868225);
    AssertAlmostEqual(&test, rTM, 0.9979988966868245);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9979988966867236);
    AssertAlmostEqual(&test, rTM, 0.9979988966869235);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9979988966768281);
    AssertAlmostEqual(&test, rTM, 0.9979988966968191);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9979988956872743);
    AssertAlmostEqual(&test, rTM, 0.9979988976863724);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9979987967343723);
    AssertAlmostEqual(&test, rTM, 0.9979989966342876);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9979889261057222);
    AssertAlmostEqual(&test, rTM, 0.9980088178846507);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9971711863515546);
    AssertAlmostEqual(&test, rTM, 0.9985845907757429);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9800706170731229);
    AssertAlmostEqual(&test, rTM, 0.9998006932185921);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8187410436180317);
    AssertAlmostEqual(&test, rTM, 0.999979869917683);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.171196186481532);
    AssertAlmostEqual(&test, rTM, 0.9999971649819855);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002479901006402753);
    AssertAlmostEqual(&test, rTM, 0.9999979838069618);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.492122536193375e-05);
    AssertAlmostEqual(&test, rTM, 0.9999979936821354);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.980603630241379);
    AssertAlmostEqual(&test, rTM, 0.980603630241379);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9806036302413789);
    AssertAlmostEqual(&test, rTM, 0.9806036302413791);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9806036302413694);
    AssertAlmostEqual(&test, rTM, 0.9806036302413886);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9806036302404186);
    AssertAlmostEqual(&test, rTM, 0.9806036302423393);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9806036301453469);
    AssertAlmostEqual(&test, rTM, 0.980603630337411);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9806036206381724);
    AssertAlmostEqual(&test, rTM, 0.9806036398445809);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9806026699449588);
    AssertAlmostEqual(&test, rTM, 0.9806045904907238);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9805078417404135);
    AssertAlmostEqual(&test, rTM, 0.9806989526052684);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9726804341119326);
    AssertAlmostEqual(&test, rTM, 0.9862449706531441);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8215741493067015);
    AssertAlmostEqual(&test, rTM, 0.9980436803172281);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1766683581050774);
    AssertAlmostEqual(&test, rTM, 0.9997259085365144);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002592967094967784);
    AssertAlmostEqual(&test, rTM, 0.9998072092800865);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.60633324999196e-05);
    AssertAlmostEqual(&test, rTM, 0.9998081964018365);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8227411899785215);
    AssertAlmostEqual(&test, rTM, 0.8227411899785215);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8227411899785215);
    AssertAlmostEqual(&test, rTM, 0.8227411899785215);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8227411899785207);
    AssertAlmostEqual(&test, rTM, 0.8227411899785223);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8227411899784416);
    AssertAlmostEqual(&test, rTM, 0.8227411899786016);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8227411899705205);
    AssertAlmostEqual(&test, rTM, 0.8227411899865226);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8227411891784182);
    AssertAlmostEqual(&test, rTM, 0.8227411907786248);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8227411099682156);
    AssertAlmostEqual(&test, rTM, 0.8227412699887949);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8227331891863217);
    AssertAlmostEqual(&test, rTM, 0.8227491904447282);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8219434828175465);
    AssertAlmostEqual(&test, rTM, 0.8235356694883373);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7591938627092588);
    AssertAlmostEqual(&test, rTM, 0.8707508364218697);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1760192991598461);
    AssertAlmostEqual(&test, rTM, 0.9733639245245836);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002604587112653849);
    AssertAlmostEqual(&test, rTM, 0.9811657308990751);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.618330136864877e-05);
    AssertAlmostEqual(&test, rTM, 0.9812616981896631);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1773062321100179);
    AssertAlmostEqual(&test, rTM, 0.1773062321100179);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1773062321100179);
    AssertAlmostEqual(&test, rTM, 0.1773062321100179);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1773062321100179);
    AssertAlmostEqual(&test, rTM, 0.1773062321100179);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1773062321100167);
    AssertAlmostEqual(&test, rTM, 0.1773062321100191);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.177306232109894);
    AssertAlmostEqual(&test, rTM, 0.1773062321101418);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1773062320976279);
    AssertAlmostEqual(&test, rTM, 0.177306232122408);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1773062308710137);
    AssertAlmostEqual(&test, rTM, 0.177306233349022);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1773061082096911);
    AssertAlmostEqual(&test, rTM, 0.1773063560103391);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1772938429622406);
    AssertAlmostEqual(&test, rTM, 0.177318621201599);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1760761010344407);
    AssertAlmostEqual(&test, rTM, 0.1785358094103056);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.104936247512777);
    AssertAlmostEqual(&test, rTM, 0.2478081777516741);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002580370298992065);
    AssertAlmostEqual(&test, rTM, 0.3415267345415893);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.61927686876871e-05);
    AssertAlmostEqual(&test, rTM, 0.3437810251908313);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002606159283146189);
    AssertAlmostEqual(&test, rTM, 0.002606159283146189);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002606159283146189);
    AssertAlmostEqual(&test, rTM, 0.002606159283146189);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002606159283146189);
    AssertAlmostEqual(&test, rTM, 0.002606159283146189);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002606159283146189);
    AssertAlmostEqual(&test, rTM, 0.002606159283146189);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002606159283146163);
    AssertAlmostEqual(&test, rTM, 0.002606159283146215);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002606159283143596);
    AssertAlmostEqual(&test, rTM, 0.002606159283148782);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002606159282886928);
    AssertAlmostEqual(&test, rTM, 0.00260615928340545);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002606159257220085);
    AssertAlmostEqual(&test, rTM, 0.002606159309072294);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002606156690538307);
    AssertAlmostEqual(&test, rTM, 0.002606161875754071);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002605900047889008);
    AssertAlmostEqual(&test, rTM, 0.00260641851840302);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002580488552991853);
    AssertAlmostEqual(&test, rTM, 0.002631830009865656);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001306477881554444);
    AssertAlmostEqual(&test, rTM, 0.003905831880236527);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.593723569810469e-05);
    AssertAlmostEqual(&test, rTM, 0.005186346629575621);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.61967151360852e-05);
    AssertAlmostEqual(&test, rTM, 2.61967151360852e-05);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.61967151360852e-05);
    AssertAlmostEqual(&test, rTM, 2.61967151360852e-05);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.61967151360852e-05);
    AssertAlmostEqual(&test, rTM, 2.61967151360852e-05);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.61967151360852e-05);
    AssertAlmostEqual(&test, rTM, 2.61967151360852e-05);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.61967151360852e-05);
    AssertAlmostEqual(&test, rTM, 2.61967151360852e-05);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619671513608494e-05);
    AssertAlmostEqual(&test, rTM, 2.619671513608546e-05);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.6196715136059e-05);
    AssertAlmostEqual(&test, rTM, 2.61967151361114e-05);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619671513346566e-05);
    AssertAlmostEqual(&test, rTM, 2.619671513870474e-05);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619671487413178e-05);
    AssertAlmostEqual(&test, rTM, 2.619671539803862e-05);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619668894076876e-05);
    AssertAlmostEqual(&test, rTM, 2.619674133140164e-05);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619409586373509e-05);
    AssertAlmostEqual(&test, rTM, 2.619933440843531e-05);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.593735517346641e-05);
    AssertAlmostEqual(&test, rTM, 2.645607509870047e-05);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.309870070423175e-05);
    AssertAlmostEqual(&test, rTM, 3.929472955895014e-05);

    userdata[0] = 20/CAPS_HBAR_EV; /* 20eV */
    userdata[1] = 0.003/CAPS_HBAR_EV; /* 0.003eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999996576201174);
    AssertAlmostEqual(&test, rTM, 0.999999828810044);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999975669363314);
    AssertAlmostEqual(&test, rTM, 0.9999999759102317);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999975789164805);
    AssertAlmostEqual(&test, rTM, 0.9999999975791293);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997579300050428);
    AssertAlmostEqual(&test, rTM, 0.999999999757901);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9975819370330952);
    AssertAlmostEqual(&test, rTM, 0.99999999997579);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9760813685672146);
    AssertAlmostEqual(&test, rTM, 0.9999999999975788);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7854395383524232);
    AssertAlmostEqual(&test, rTM, 0.9999999999997561);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1293348795288392);
    AssertAlmostEqual(&test, rTM, 0.999999999999962);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001700337832268022);
    AssertAlmostEqual(&test, rTM, 0.9999999999999706);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.706076695607021e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999999707);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.706134328871624e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999999707);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.70613490522885e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999999999707);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.706134910992425e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999999999707);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999992305948167);
    AssertAlmostEqual(&test, rTM, 0.9999992382126869);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999989172969738);
    AssertAlmostEqual(&test, rTM, 0.9999994586483404);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999923059748058);
    AssertAlmostEqual(&test, rTM, 0.9999999238212426);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999234403963864);
    AssertAlmostEqual(&test, rTM, 0.9999999923445121);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9992347055568994);
    AssertAlmostEqual(&test, rTM, 0.9999999992344133);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9923733793860736);
    AssertAlmostEqual(&test, rTM, 0.9999999999234407);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9263158406040011);
    AssertAlmostEqual(&test, rTM, 0.9999999999923386);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4733003726166422);
    AssertAlmostEqual(&test, rTM, 0.9999999999991802);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01650277953598079);
    AssertAlmostEqual(&test, rTM, 0.9999999999996971);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001705542986875972);
    AssertAlmostEqual(&test, rTM, 0.9999999999997068);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.706119089422685e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999997069);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.706124852905037e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999997069);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.706124910540106e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999999997069);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999923416872555);
    AssertAlmostEqual(&test, rTM, 0.9999923416949137);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999923413081802);
    AssertAlmostEqual(&test, rTM, 0.9999923420739698);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999923034949402);
    AssertAlmostEqual(&test, rTM, 0.9999923796976702);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999891695328451);
    AssertAlmostEqual(&test, rTM, 0.9999945847517601);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999230376149945);
    AssertAlmostEqual(&test, rTM, 0.9999992379671534);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9992344211091166);
    AssertAlmostEqual(&test, rTM, 0.9999999234204437);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9923709268868132);
    AssertAlmostEqual(&test, rTM, 0.9999999923416095);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.926292999706537);
    AssertAlmostEqual(&test, rTM, 0.9999999992336049);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4731913150354564);
    AssertAlmostEqual(&test, rTM, 0.999999999917994);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01649249163039448);
    AssertAlmostEqual(&test, rTM, 0.9999999999696915);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001704444459417738);
    AssertAlmostEqual(&test, rTM, 0.9999999999706649);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.705019819983555e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999706748);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.705025576041353e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999706749);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999757116800322);
    AssertAlmostEqual(&test, rTM, 0.9999757116802751);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999757116680096);
    AssertAlmostEqual(&test, rTM, 0.9999757116922976);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999757104657827);
    AssertAlmostEqual(&test, rTM, 0.9999757128944637);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999755905421283);
    AssertAlmostEqual(&test, rTM, 0.9999758322170086);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999965651301452);
    AssertAlmostEqual(&test, rTM, 0.999982825503243);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999755932232111);
    AssertAlmostEqual(&test, rTM, 0.9999975831953991);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9975739652663174);
    AssertAlmostEqual(&test, rTM, 0.9999997571258457);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9760045507122973);
    AssertAlmostEqual(&test, rTM, 0.9999999757096066);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7848261536045466);
    AssertAlmostEqual(&test, rTM, 0.9999999975532932);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1286888793277843);
    AssertAlmostEqual(&test, rTM, 0.9999999996179005);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001689374335027763);
    AssertAlmostEqual(&test, rTM, 0.9999999997040333);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.695039338689055e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999997050216);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.695096228646943e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999997050315);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999209910688643);
    AssertAlmostEqual(&test, rTM, 0.9999209910688722);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999209910684733);
    AssertAlmostEqual(&test, rTM, 0.9999209910692634);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999209910293654);
    AssertAlmostEqual(&test, rTM, 0.9999209911083712);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999209871186766);
    AssertAlmostEqual(&test, rTM, 0.9999209950188626);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999205970225623);
    AssertAlmostEqual(&test, rTM, 0.9999213831597515);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998882663264621);
    AssertAlmostEqual(&test, rTM, 0.9999441316025486);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9992062539036711);
    AssertAlmostEqual(&test, rTM, 0.9999921380372245);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9921295556739647);
    AssertAlmostEqual(&test, rTM, 0.9999992099131251);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9240477291750158);
    AssertAlmostEqual(&test, rTM, 0.9999999209263561);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.462601175655024);
    AssertAlmostEqual(&test, rTM, 0.9999999915045596);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01552469114925708);
    AssertAlmostEqual(&test, rTM, 0.9999999967801002);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001601305567833082);
    AssertAlmostEqual(&test, rTM, 0.9999999968775479);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.6018133953217e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999968785378);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996889492405474);
    AssertAlmostEqual(&test, rTM, 0.9996889492405477);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996889492405321);
    AssertAlmostEqual(&test, rTM, 0.9996889492405632);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996889492389925);
    AssertAlmostEqual(&test, rTM, 0.9996889492421026);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996889490850465);
    AssertAlmostEqual(&test, rTM, 0.9996889493960487);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996889336908177);
    AssertAlmostEqual(&test, rTM, 0.9996889647895003);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996873980980856);
    AssertAlmostEqual(&test, rTM, 0.9996904926873733);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995601361390638);
    AssertAlmostEqual(&test, rTM, 0.9997800438765236);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9968783759716122);
    AssertAlmostEqual(&test, rTM, 0.9999690449199273);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9693687276650655);
    AssertAlmostEqual(&test, rTM, 0.9999968887926241);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7335509482850978);
    AssertAlmostEqual(&test, rTM, 0.9999996851599323);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.08626637836037729);
    AssertAlmostEqual(&test, rTM, 0.9999999424713273);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001031113050804202);
    AssertAlmostEqual(&test, rTM, 0.9999999515087659);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.03322138124158e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999516076628);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9979038224291531);
    AssertAlmostEqual(&test, rTM, 0.9979038224291532);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9979038224291521);
    AssertAlmostEqual(&test, rTM, 0.9979038224291542);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9979038224290484);
    AssertAlmostEqual(&test, rTM, 0.9979038224292578);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9979038224186833);
    AssertAlmostEqual(&test, rTM, 0.9979038224396231);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9979038213821643);
    AssertAlmostEqual(&test, rTM, 0.9979038234761415);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9979037177328617);
    AssertAlmostEqual(&test, rTM, 0.9979039271202211);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9978933786370724);
    AssertAlmostEqual(&test, rTM, 0.9979142144991143);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9970368452814024);
    AssertAlmostEqual(&test, rTM, 0.9985173226604065);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9791327508124084);
    AssertAlmostEqual(&test, rTM, 0.999791214005188);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8110179041112712);
    AssertAlmostEqual(&test, rTM, 0.9999789023306872);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1601789985742587);
    AssertAlmostEqual(&test, rTM, 0.9999969585926729);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002260823158606843);
    AssertAlmostEqual(&test, rTM, 0.9999977884323498);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.270977445694205e-05);
    AssertAlmostEqual(&test, rTM, 0.999997798309711);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9805060772124128);
    AssertAlmostEqual(&test, rTM, 0.9805060772124128);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9805060772124127);
    AssertAlmostEqual(&test, rTM, 0.9805060772124129);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9805060772124031);
    AssertAlmostEqual(&test, rTM, 0.9805060772124224);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9805060772114477);
    AssertAlmostEqual(&test, rTM, 0.9805060772133779);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9805060771159025);
    AssertAlmostEqual(&test, rTM, 0.980506077308923);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9805060675613922);
    AssertAlmostEqual(&test, rTM, 0.9805060868634287);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9805051121347135);
    AssertAlmostEqual(&test, rTM, 0.980507042242807);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9804098118080421);
    AssertAlmostEqual(&test, rTM, 0.9806018742058936);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9725435974213491);
    AssertAlmostEqual(&test, rTM, 0.9861755857081566);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8207570457153248);
    AssertAlmostEqual(&test, rTM, 0.9980336590200465);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1754185453823089);
    AssertAlmostEqual(&test, rTM, 0.9997238308761726);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002566958655621212);
    AssertAlmostEqual(&test, rTM, 0.9998052562777137);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.580057541831956e-05);
    AssertAlmostEqual(&test, rTM, 0.9998062434225695);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8226593519731404);
    AssertAlmostEqual(&test, rTM, 0.8226593519731404);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8226593519731404);
    AssertAlmostEqual(&test, rTM, 0.8226593519731404);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8226593519731397);
    AssertAlmostEqual(&test, rTM, 0.8226593519731412);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8226593519730604);
    AssertAlmostEqual(&test, rTM, 0.8226593519732205);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8226593519651362);
    AssertAlmostEqual(&test, rTM, 0.8226593519811447);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8226593511727114);
    AssertAlmostEqual(&test, rTM, 0.8226593527735695);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8226592719302632);
    AssertAlmostEqual(&test, rTM, 0.822659432015985);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8226513479239415);
    AssertAlmostEqual(&test, rTM, 0.8226673556962489);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8218613202908848);
    AssertAlmostEqual(&test, rTM, 0.8234541550430385);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7590875694612528);
    AssertAlmostEqual(&test, rTM, 0.8706890171467501);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1758932080741944);
    AssertAlmostEqual(&test, rTM, 0.973344134808112);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002601938750241676);
    AssertAlmostEqual(&test, rTM, 0.9811469217517041);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.615654049850823e-05);
    AssertAlmostEqual(&test, rTM, 0.981242886548789);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1772935502379631);
    AssertAlmostEqual(&test, rTM, 0.1772935502379631);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1772935502379631);
    AssertAlmostEqual(&test, rTM, 0.1772935502379631);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1772935502379631);
    AssertAlmostEqual(&test, rTM, 0.1772935502379632);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1772935502379619);
    AssertAlmostEqual(&test, rTM, 0.1772935502379644);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1772935502378392);
    AssertAlmostEqual(&test, rTM, 0.177293550238087);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1772935502255737);
    AssertAlmostEqual(&test, rTM, 0.1772935502503526);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1772935489990152);
    AssertAlmostEqual(&test, rTM, 0.1772935514769111);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.177293426343254);
    AssertAlmostEqual(&test, rTM, 0.1772936741326667);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.177281161651927);
    AssertAlmostEqual(&test, rTM, 0.1773059387678124);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1760634751263598);
    AssertAlmostEqual(&test, rTM, 0.1785230716668089);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1049275469260145);
    AssertAlmostEqual(&test, rTM, 0.2477918560661568);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.00258010755112584);
    AssertAlmostEqual(&test, rTM, 0.341503833961848);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.61900879341957e-05);
    AssertAlmostEqual(&test, rTM, 0.3437579353233124);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002606132743475707);
    AssertAlmostEqual(&test, rTM, 0.002606132743475707);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002606132743475707);
    AssertAlmostEqual(&test, rTM, 0.002606132743475707);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002606132743475707);
    AssertAlmostEqual(&test, rTM, 0.002606132743475707);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002606132743475706);
    AssertAlmostEqual(&test, rTM, 0.002606132743475707);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.00260613274347568);
    AssertAlmostEqual(&test, rTM, 0.002606132743475732);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002606132743473114);
    AssertAlmostEqual(&test, rTM, 0.002606132743478299);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002606132743216448);
    AssertAlmostEqual(&test, rTM, 0.002606132743734965);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002606132717549865);
    AssertAlmostEqual(&test, rTM, 0.002606132769401548);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002606130150894088);
    AssertAlmostEqual(&test, rTM, 0.002606135336057324);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002605873510844674);
    AssertAlmostEqual(&test, rTM, 0.002606391976106389);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002580462273388554);
    AssertAlmostEqual(&test, rTM, 0.002631803210128094);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001306464542485585);
    AssertAlmostEqual(&test, rTM, 0.003905792140232929);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.593697020124155e-05);
    AssertAlmostEqual(&test, rTM, 0.005186293816791593);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619668832043576e-05);
    AssertAlmostEqual(&test, rTM, 2.619668832043576e-05);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619668832043576e-05);
    AssertAlmostEqual(&test, rTM, 2.619668832043576e-05);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619668832043576e-05);
    AssertAlmostEqual(&test, rTM, 2.619668832043576e-05);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619668832043576e-05);
    AssertAlmostEqual(&test, rTM, 2.619668832043576e-05);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619668832043576e-05);
    AssertAlmostEqual(&test, rTM, 2.619668832043577e-05);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.61966883204355e-05);
    AssertAlmostEqual(&test, rTM, 2.619668832043603e-05);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619668832040957e-05);
    AssertAlmostEqual(&test, rTM, 2.619668832046196e-05);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619668831781623e-05);
    AssertAlmostEqual(&test, rTM, 2.61966883230553e-05);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619668805848261e-05);
    AssertAlmostEqual(&test, rTM, 2.619668858238892e-05);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619666212514614e-05);
    AssertAlmostEqual(&test, rTM, 2.619671451572539e-05);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619406905076666e-05);
    AssertAlmostEqual(&test, rTM, 2.619930759010486e-05);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.59373286232909e-05);
    AssertAlmostEqual(&test, rTM, 2.64560480175771e-05);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.309868729570454e-05);
    AssertAlmostEqual(&test, rTM, 3.92946893361785e-05);

    userdata[0] = 20/CAPS_HBAR_EV; /* 20eV */
    userdata[1] = 0.035/CAPS_HBAR_EV; /* 0.035eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999988305508983);
    AssertAlmostEqual(&test, rTM, 0.9999994152752782);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999916895323552);
    AssertAlmostEqual(&test, rTM, 0.9999999177178036);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999173066974231);
    AssertAlmostEqual(&test, rTM, 0.9999999917311547);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991734155458556);
    AssertAlmostEqual(&test, rTM, 0.9999999991730745);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9917648608617485);
    AssertAlmostEqual(&test, rTM, 0.9999999999173067);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9206557926753743);
    AssertAlmostEqual(&test, rTM, 0.9999999999917237);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4470824367635407);
    AssertAlmostEqual(&test, rTM, 0.9999999999991052);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01421132233538043);
    AssertAlmostEqual(&test, rTM, 0.9999999999996483);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001461974655336541);
    AssertAlmostEqual(&test, rTM, 0.9999999999996581);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.462397945851919e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999996581);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.462402180304402e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999996581);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.462402222649081e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999999996581);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.462402223072528e-12);
    AssertAlmostEqual(&test, rTM, 0.9999999999996581);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999973719912552);
    AssertAlmostEqual(&test, rTM, 0.9999973980111099);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999963018809779);
    AssertAlmostEqual(&test, rTM, 0.9999981509387794);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999737202233396);
    AssertAlmostEqual(&test, rTM, 0.9999997398008063);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997385241296602);
    AssertAlmostEqual(&test, rTM, 0.9999999738516088);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9973884456211036);
    AssertAlmostEqual(&test, rTM, 0.9999999973850292);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.974189969438745);
    AssertAlmostEqual(&test, rTM, 0.9999999997384806);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7704676541539781);
    AssertAlmostEqual(&test, rTM, 0.9999999999736278);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1146337596864643);
    AssertAlmostEqual(&test, rTM, 0.9999999999956956);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001458139825996483);
    AssertAlmostEqual(&test, rTM, 0.999999999996571);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.46235871758481e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999965808);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.462401060659913e-07);
    AssertAlmostEqual(&test, rTM, 0.999999999996581);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.462401484106143e-09);
    AssertAlmostEqual(&test, rTM, 0.999999999996581);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.462401488340607e-11);
    AssertAlmostEqual(&test, rTM, 0.999999999996581);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.99997384990757);
    AssertAlmostEqual(&test, rTM, 0.9999738499337197);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999738486131907);
    AssertAlmostEqual(&test, rTM, 0.9999738512280337);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999737194972137);
    AssertAlmostEqual(&test, rTM, 0.9999739796968263);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999630184034092);
    AssertAlmostEqual(&test, rTM, 0.999981509030745);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999737226050625);
    AssertAlmostEqual(&test, rTM, 0.9999973979391925);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9973882444525485);
    AssertAlmostEqual(&test, rTM, 0.9999997385086722);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9741892529973668);
    AssertAlmostEqual(&test, rTM, 0.9999999738473568);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7704621332213075);
    AssertAlmostEqual(&test, rTM, 0.9999999973626991);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1146287279630202);
    AssertAlmostEqual(&test, rTM, 0.9999999995695406);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001458059484350401);
    AssertAlmostEqual(&test, rTM, 0.9999999996570792);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.462277910541145e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999996580677);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.462320248936753e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999996580776);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.462320672336186e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999996580777);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999172877587459);
    AssertAlmostEqual(&test, rTM, 0.999917287759573);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999917287717805);
    AssertAlmostEqual(&test, rTM, 0.9999172878005138);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999172836238218);
    AssertAlmostEqual(&test, rTM, 0.9999172918942903);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999168752438673);
    AssertAlmostEqual(&test, rTM, 0.9999176982273855);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998830292310694);
    AssertAlmostEqual(&test, rTM, 0.9999415129051146);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991690633310638);
    AssertAlmostEqual(&test, rTM, 0.9999917695172122);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9917621623337682);
    AssertAlmostEqual(&test, rTM, 0.9999991728780067);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9206345294812706);
    AssertAlmostEqual(&test, rTM, 0.9999999172136721);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4469871131799956);
    AssertAlmostEqual(&test, rTM, 0.9999999910489309);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01420361670916881);
    AssertAlmostEqual(&test, rTM, 0.99999999648048);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001461159342674355);
    AssertAlmostEqual(&test, rTM, 0.9999999965780598);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.46158216115145e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999965790497);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.461586390880963e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999965790596);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997378086302262);
    AssertAlmostEqual(&test, rTM, 0.9997378086302524);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997378086289285);
    AssertAlmostEqual(&test, rTM, 0.99973780863155);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997378084991608);
    AssertAlmostEqual(&test, rTM, 0.9997378087613177);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997377955227174);
    AssertAlmostEqual(&test, rTM, 0.999737821737106);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997365011068082);
    AssertAlmostEqual(&test, rTM, 0.9997391096663776);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996292255457837);
    AssertAlmostEqual(&test, rTM, 0.9998145955839);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9973681340516622);
    AssertAlmostEqual(&test, rTM, 0.9999739078809843);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9741177059853777);
    AssertAlmostEqual(&test, rTM, 0.9999973776517074);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7699110198713996);
    AssertAlmostEqual(&test, rTM, 0.9999997355301179);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.114127805881194);
    AssertAlmostEqual(&test, rTM, 0.9999999567601082);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001450069784734324);
    AssertAlmostEqual(&test, rTM, 0.9999999655189745);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.454242057230728e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999656178296);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.454283931565601e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999656188195);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991506685748586);
    AssertAlmostEqual(&test, rTM, 0.9991506685748595);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991506685748165);
    AssertAlmostEqual(&test, rTM, 0.9991506685749014);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991506685706141);
    AssertAlmostEqual(&test, rTM, 0.9991506685791038);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991506681503738);
    AssertAlmostEqual(&test, rTM, 0.9991506689993439);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991506261273916);
    AssertAlmostEqual(&test, rTM, 0.999150711020206);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991464342902843);
    AssertAlmostEqual(&test, rTM, 0.999154881863292);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.998799075333358);
    AssertAlmostEqual(&test, rTM, 0.999399357226651);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9914970797038686);
    AssertAlmostEqual(&test, rTM, 0.9999154552711187);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9185601050504058);
    AssertAlmostEqual(&test, rTM, 0.9999914958739839);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4377929395801611);
    AssertAlmostEqual(&test, rTM, 0.9999990768055608);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01347995434343899);
    AssertAlmostEqual(&test, rTM, 0.9999996291464016);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001384701985172644);
    AssertAlmostEqual(&test, rTM, 0.9999996389116105);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.385081707982187e-06);
    AssertAlmostEqual(&test, rTM, 0.9999996390105965);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9967411029205809);
    AssertAlmostEqual(&test, rTM, 0.9967411029205809);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9967411029205793);
    AssertAlmostEqual(&test, rTM, 0.9967411029205826);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9967411029204183);
    AssertAlmostEqual(&test, rTM, 0.9967411029207436);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9967411029043131);
    AssertAlmostEqual(&test, rTM, 0.9967411029368488);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9967411012937922);
    AssertAlmostEqual(&test, rTM, 0.9967411045473689);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9967409402457507);
    AssertAlmostEqual(&test, rTM, 0.9967412655873047);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9967248756293868);
    AssertAlmostEqual(&test, rTM, 0.9967572499408293);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9953943382200426);
    AssertAlmostEqual(&test, rTM, 0.9976945084042341);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9677286636030918);
    AssertAlmostEqual(&test, rTM, 0.9996752078696198);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7225229878518407);
    AssertAlmostEqual(&test, rTM, 0.9999669281411786);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.07951890483588472);
    AssertAlmostEqual(&test, rTM, 0.9999937519889077);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0009367571897079688);
    AssertAlmostEqual(&test, rTM, 0.9999946624707504);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -9.384970804172904e-06);
    AssertAlmostEqual(&test, rTM, 0.9999946723613047);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9790085800781508);
    AssertAlmostEqual(&test, rTM, 0.9790085800781508);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9790085800781507);
    AssertAlmostEqual(&test, rTM, 0.9790085800781509);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9790085800781404);
    AssertAlmostEqual(&test, rTM, 0.9790085800781612);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9790085800771123);
    AssertAlmostEqual(&test, rTM, 0.9790085800791892);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.979008579974307);
    AssertAlmostEqual(&test, rTM, 0.9790085801819947);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9790085696937719);
    AssertAlmostEqual(&test, rTM, 0.9790085904625246);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9790075416665078);
    AssertAlmostEqual(&test, rTM, 0.9790096184389726);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.978905000090997);
    AssertAlmostEqual(&test, rTM, 0.9791116568386761);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9704437890344888);
    AssertAlmostEqual(&test, rTM, 0.9851102228734168);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8083104842051526);
    AssertAlmostEqual(&test, rTM, 0.9978795295931796);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1576369581881303);
    AssertAlmostEqual(&test, rTM, 0.9996908108758694);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002211968870775495);
    AssertAlmostEqual(&test, rTM, 0.9997740093385);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.221690525678723e-05);
    AssertAlmostEqual(&test, rTM, 0.9997749967919151);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8213567380884209);
    AssertAlmostEqual(&test, rTM, 0.8213567380884209);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8213567380884209);
    AssertAlmostEqual(&test, rTM, 0.8213567380884209);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8213567380884201);
    AssertAlmostEqual(&test, rTM, 0.8213567380884217);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8213567380883403);
    AssertAlmostEqual(&test, rTM, 0.8213567380885015);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8213567380803648);
    AssertAlmostEqual(&test, rTM, 0.821356738096477);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8213567372828136);
    AssertAlmostEqual(&test, rTM, 0.8213567388940283);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.821356657527705);
    AssertAlmostEqual(&test, rTM, 0.821356818649104);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8213486822572417);
    AssertAlmostEqual(&test, rTM, 0.8213647935919705);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8205535469778014);
    AssertAlmostEqual(&test, rTM, 0.8221566853516573);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7573963504278112);
    AssertAlmostEqual(&test, rTM, 0.8697047262011323);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1739007982010954);
    AssertAlmostEqual(&test, rTM, 0.9730278444058923);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002560285692357618);
    AssertAlmostEqual(&test, rTM, 0.9808460735094848);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.573568639646582e-05);
    AssertAlmostEqual(&test, rTM, 0.9809419983575953);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1770908947061397);
    AssertAlmostEqual(&test, rTM, 0.1770908947061397);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1770908947061397);
    AssertAlmostEqual(&test, rTM, 0.1770908947061397);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1770908947061397);
    AssertAlmostEqual(&test, rTM, 0.1770908947061397);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1770908947061385);
    AssertAlmostEqual(&test, rTM, 0.1770908947061409);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1770908947060159);
    AssertAlmostEqual(&test, rTM, 0.1770908947062635);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1770908946937592);
    AssertAlmostEqual(&test, rTM, 0.1770908947185202);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.17709089346809);
    AssertAlmostEqual(&test, rTM, 0.1770908959441895);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1770907709012533);
    AssertAlmostEqual(&test, rTM, 0.1770910185110205);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1770785151020429);
    AssertAlmostEqual(&test, rTM, 0.1771032742541994);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1758617144249957);
    AssertAlmostEqual(&test, rTM, 0.1783195227822264);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.104788535672224);
    AssertAlmostEqual(&test, rTM, 0.2475310084866471);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002575910850693618);
    AssertAlmostEqual(&test, rTM, 0.3411378419204991);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.61472703842321e-05);
    AssertAlmostEqual(&test, rTM, 0.3433889188128332);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002605708182248633);
    AssertAlmostEqual(&test, rTM, 0.002605708182248633);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002605708182248633);
    AssertAlmostEqual(&test, rTM, 0.002605708182248633);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002605708182248633);
    AssertAlmostEqual(&test, rTM, 0.002605708182248633);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002605708182248633);
    AssertAlmostEqual(&test, rTM, 0.002605708182248634);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002605708182248607);
    AssertAlmostEqual(&test, rTM, 0.002605708182248659);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002605708182246041);
    AssertAlmostEqual(&test, rTM, 0.002605708182251225);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002605708181989417);
    AssertAlmostEqual(&test, rTM, 0.00260570818250785);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002605708156326993);
    AssertAlmostEqual(&test, rTM, 0.002605708208170274);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002605705590087168);
    AssertAlmostEqual(&test, rTM, 0.002605710774410099);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002605448991628741);
    AssertAlmostEqual(&test, rTM, 0.002605967372868176);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0025800418725199);
    AssertAlmostEqual(&test, rTM, 0.002631374488544274);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001306251154421852);
    AssertAlmostEqual(&test, rTM, 0.003905156410137167);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.593272299051378e-05);
    AssertAlmostEqual(&test, rTM, 0.005185448958503506);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619625927751085e-05);
    AssertAlmostEqual(&test, rTM, 2.619625927751085e-05);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619625927751085e-05);
    AssertAlmostEqual(&test, rTM, 2.619625927751085e-05);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619625927751085e-05);
    AssertAlmostEqual(&test, rTM, 2.619625927751085e-05);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619625927751085e-05);
    AssertAlmostEqual(&test, rTM, 2.619625927751085e-05);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619625927751084e-05);
    AssertAlmostEqual(&test, rTM, 2.619625927751085e-05);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619625927751059e-05);
    AssertAlmostEqual(&test, rTM, 2.619625927751111e-05);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619625927748465e-05);
    AssertAlmostEqual(&test, rTM, 2.619625927753704e-05);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619625927489136e-05);
    AssertAlmostEqual(&test, rTM, 2.619625928013034e-05);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619625901556198e-05);
    AssertAlmostEqual(&test, rTM, 2.619625953945971e-05);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619623308265021e-05);
    AssertAlmostEqual(&test, rTM, 2.619628547237148e-05);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619364005073726e-05);
    AssertAlmostEqual(&test, rTM, 2.619887850428444e-05);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.593690382787504e-05);
    AssertAlmostEqual(&test, rTM, 2.645561472714313e-05);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.309847276300256e-05);
    AssertAlmostEqual(&test, rTM, 3.929404578303109e-05);

    userdata[0] = 20/CAPS_HBAR_EV; /* 20eV */
    userdata[1] = 0.05/CAPS_HBAR_EV; /* 0.05eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999986022411478);
    AssertAlmostEqual(&test, rTM, 0.9999993011203298);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999900670994549);
    AssertAlmostEqual(&test, rTM, 0.9999999016539665);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999011633976373);
    AssertAlmostEqual(&test, rTM, 0.9999999901168396);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9990121223651731);
    AssertAlmostEqual(&test, rTM, 0.9999999990116349);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9901650680418893);
    AssertAlmostEqual(&test, rTM, 0.9999999999011623);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9059271719724101);
    AssertAlmostEqual(&test, rTM, 0.9999999999901042);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3859662659736783);
    AssertAlmostEqual(&test, rTM, 0.9999999999988975);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01003244547669127);
    AssertAlmostEqual(&test, rTM, 0.9999999999995016);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001023472042125571);
    AssertAlmostEqual(&test, rTM, 0.9999999999995115);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.023679477454056e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999995116);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.023681552338141e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999995116);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.023681573087035e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999999995116);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.023681573294524e-12);
    AssertAlmostEqual(&test, rTM, 0.9999999999995116);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999968589298314);
    AssertAlmostEqual(&test, rTM, 0.9999968900294877);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999955799043098);
    AssertAlmostEqual(&test, rTM, 0.9999977899497128);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999968589742296);
    AssertAlmostEqual(&test, rTM, 0.9999996890025135);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996874845630048);
    AssertAlmostEqual(&test, rTM, 0.9999999687466973);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9968793924152153);
    AssertAlmostEqual(&test, rTM, 0.9999999968745112);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9692297514737982);
    AssertAlmostEqual(&test, rTM, 0.9999999996874132);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7325012179255357);
    AssertAlmostEqual(&test, rTM, 0.9999999999683657);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.08559392444826075);
    AssertAlmostEqual(&test, rTM, 0.9999999999942013);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.00102159071521351);
    AssertAlmostEqual(&test, rTM, 0.9999999999951057);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.023660255368599e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999951156);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.023681003712183e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999951157);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.023681211200928e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999999951157);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.023681213275816e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999999951157);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999968745002862);
    AssertAlmostEqual(&test, rTM, 0.9999687450341165);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999687434558037);
    AssertAlmostEqual(&test, rTM, 0.9999687465810967);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999685891347759);
    AssertAlmostEqual(&test, rTM, 0.9999689001286055);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999557990673791);
    AssertAlmostEqual(&test, rTM, 0.9999778992894661);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996859357442295);
    AssertAlmostEqual(&test, rTM, 0.9999968899692979);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9968791779238392);
    AssertAlmostEqual(&test, rTM, 0.9999996874605942);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9692291506293019);
    AssertAlmostEqual(&test, rTM, 0.9999999687407297);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.732496841774915);
    AssertAlmostEqual(&test, rTM, 0.9999999968365163);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.08559113555683186);
    AssertAlmostEqual(&test, rTM, 0.9999999994201069);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.00102155127829679);
    AssertAlmostEqual(&test, rTM, 0.9999999995105489);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.023620658552711e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999995115378);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.023641405291165e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999995115477);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.023641612763859e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999995115478);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999011490340673);
    AssertAlmostEqual(&test, rTM, 0.9999011490350558);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999011489851386);
    AssertAlmostEqual(&test, rTM, 0.9999011490839845);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999011440923812);
    AssertAlmostEqual(&test, rTM, 0.9999011539764949);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999006560337224);
    AssertAlmostEqual(&test, rTM, 0.9999016395889726);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998602064861455);
    AssertAlmostEqual(&test, rTM, 0.9999301008000383);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9990070043750633);
    AssertAlmostEqual(&test, rTM, 0.9999901635223118);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9901626670848147);
    AssertAlmostEqual(&test, rTM, 0.9999990114793232);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9059096587339374);
    AssertAlmostEqual(&test, rTM, 0.9999999010235183);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3858994679900203);
    AssertAlmostEqual(&test, rTM, 0.9999999889727551);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01002860506397299);
    AssertAlmostEqual(&test, rTM, 0.9999999950147632);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001023072401976028);
    AssertAlmostEqual(&test, rTM, 0.9999999951127604);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.023279675328353e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999951137504);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.023281748592055e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999951137603);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996868903960375);
    AssertAlmostEqual(&test, rTM, 0.9996868903960688);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996868903944879);
    AssertAlmostEqual(&test, rTM, 0.9996868903976185);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999686890239523);
    AssertAlmostEqual(&test, rTM, 0.9996868905525834);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996868747434158);
    AssertAlmostEqual(&test, rTM, 0.9996869060479083);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996853289881977);
    AssertAlmostEqual(&test, rTM, 0.9996884440573589);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995572248697091);
    AssertAlmostEqual(&test, rTM, 0.9997785879204868);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9968577432299596);
    AssertAlmostEqual(&test, rTM, 0.9999688399989105);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9691691222953669);
    AssertAlmostEqual(&test, rTM, 0.9999968681913233);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7320597949162307);
    AssertAlmostEqual(&test, rTM, 0.9999996830259558);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.08531316792402484);
    AssertAlmostEqual(&test, rTM, 0.9999999418189698);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001017622903757809);
    AssertAlmostEqual(&test, rTM, 0.9999999508659391);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.019676387203132e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999509648373);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.019696974364482e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999509658273);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9989930169752784);
    AssertAlmostEqual(&test, rTM, 0.9989930169752794);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9989930169752286);
    AssertAlmostEqual(&test, rTM, 0.9989930169753292);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9989930169702465);
    AssertAlmostEqual(&test, rTM, 0.9989930169803113);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9989930164720411);
    AssertAlmostEqual(&test, rTM, 0.9989930174785164);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9989929666527501);
    AssertAlmostEqual(&test, rTM, 0.9989930672952942);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9989879971275174);
    AssertAlmostEqual(&test, rTM, 0.9989980119355214);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9985762080660168);
    AssertAlmostEqual(&test, rTM, 0.9992878503641958);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9899259762500822);
    AssertAlmostEqual(&test, rTM, 0.9998997547223755);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9041938451810371);
    AssertAlmostEqual(&test, rTM, 0.9999899128774503);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3794172682493753);
    AssertAlmostEqual(&test, rTM, 0.9999988719003429);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.009662392869638372);
    AssertAlmostEqual(&test, rTM, 0.9999994825784206);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -9.84991752286058e-05);
    AssertAlmostEqual(&test, rTM, 0.999999492381799);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -9.8518388162977e-07);
    AssertAlmostEqual(&test, rTM, 0.999999492480789);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9963209036931271);
    AssertAlmostEqual(&test, rTM, 0.9963209036931271);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9963209036931252);
    AssertAlmostEqual(&test, rTM, 0.9963209036931289);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9963209036929435);
    AssertAlmostEqual(&test, rTM, 0.9963209036933107);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9963209036747654);
    AssertAlmostEqual(&test, rTM, 0.9963209037114886);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9963209018569695);
    AssertAlmostEqual(&test, rTM, 0.9963209055292837);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9963207200819362);
    AssertAlmostEqual(&test, rTM, 0.9963210872951719);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9963025879576949);
    AssertAlmostEqual(&test, rTM, 0.9963391288649505);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9948009424224246);
    AssertAlmostEqual(&test, rTM, 0.9973970792098426);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9636370616621383);
    AssertAlmostEqual(&test, rTM, 0.9996332465533809);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6931206487111704);
    AssertAlmostEqual(&test, rTM, 0.9999625230964929);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.06442751448917725);
    AssertAlmostEqual(&test, rTM, 0.9999922716181358);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0007349846868873702);
    AssertAlmostEqual(&test, rTM, 0.9999931971871672);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -7.360554557720522e-06);
    AssertAlmostEqual(&test, rTM, 0.9999932070797171);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9783433242721802);
    AssertAlmostEqual(&test, rTM, 0.9783433242721803);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9783433242721802);
    AssertAlmostEqual(&test, rTM, 0.9783433242721803);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9783433242721695);
    AssertAlmostEqual(&test, rTM, 0.978343324272191);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9783433242711093);
    AssertAlmostEqual(&test, rTM, 0.9783433242732512);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9783433241650822);
    AssertAlmostEqual(&test, rTM, 0.9783433243792783);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9783433135623816);
    AssertAlmostEqual(&test, rTM, 0.9783433349819737);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9783422533194017);
    AssertAlmostEqual(&test, rTM, 0.9783443951725809);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9782364985372742);
    AssertAlmostEqual(&test, rTM, 0.9784496313671375);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9695113912829944);
    AssertAlmostEqual(&test, rTM, 0.9846367821025395);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8028389773158187);
    AssertAlmostEqual(&test, rTM, 0.9978108752378325);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.150513955301258);
    AssertAlmostEqual(&test, rTM, 0.9996754546270067);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002077308795618303);
    AssertAlmostEqual(&test, rTM, 0.9997593630397995);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.085881230417238e-05);
    AssertAlmostEqual(&test, rTM, 0.9997603506061148);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8207504856011518);
    AssertAlmostEqual(&test, rTM, 0.8207504856011518);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8207504856011518);
    AssertAlmostEqual(&test, rTM, 0.8207504856011518);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8207504856011509);
    AssertAlmostEqual(&test, rTM, 0.8207504856011526);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.820750485601071);
    AssertAlmostEqual(&test, rTM, 0.8207504856012325);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8207504855930716);
    AssertAlmostEqual(&test, rTM, 0.8207504856092319);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8207504847931382);
    AssertAlmostEqual(&test, rTM, 0.8207504864091655);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8207504047998103);
    AssertAlmostEqual(&test, rTM, 0.8207505664024604);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8207424057082962);
    AssertAlmostEqual(&test, rTM, 0.8207585651656656);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.819944897064619);
    AssertAlmostEqual(&test, rTM, 0.8215528232410118);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7566096527586049);
    AssertAlmostEqual(&test, rTM, 0.8692464227309472);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1729827888457045);
    AssertAlmostEqual(&test, rTM, 0.9728798038881558);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002541216482527423);
    AssertAlmostEqual(&test, rTM, 0.9807051144418035);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.554303813503839e-05);
    AssertAlmostEqual(&test, rTM, 0.9808010205306675);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1769960644777591);
    AssertAlmostEqual(&test, rTM, 0.1769960644777591);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1769960644777591);
    AssertAlmostEqual(&test, rTM, 0.1769960644777591);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1769960644777591);
    AssertAlmostEqual(&test, rTM, 0.1769960644777591);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1769960644777579);
    AssertAlmostEqual(&test, rTM, 0.1769960644777604);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1769960644776354);
    AssertAlmostEqual(&test, rTM, 0.1769960644778829);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1769960644653829);
    AssertAlmostEqual(&test, rTM, 0.1769960644901354);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1769960632401301);
    AssertAlmostEqual(&test, rTM, 0.1769960657153882);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1769959407149388);
    AssertAlmostEqual(&test, rTM, 0.1769961882405739);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1769836890801121);
    AssertAlmostEqual(&test, rTM, 0.1770084398194391);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1757673032642683);
    AssertAlmostEqual(&test, rTM, 0.1782242741770488);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.104723502267669);
    AssertAlmostEqual(&test, rTM, 0.247408929851255);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002573948343485791);
    AssertAlmostEqual(&test, rTM, 0.3409665530664037);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.612724781509837e-05);
    AssertAlmostEqual(&test, rTM, 0.3432162149133114);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002605509216788364);
    AssertAlmostEqual(&test, rTM, 0.002605509216788364);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002605509216788364);
    AssertAlmostEqual(&test, rTM, 0.002605509216788364);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002605509216788364);
    AssertAlmostEqual(&test, rTM, 0.002605509216788364);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002605509216788364);
    AssertAlmostEqual(&test, rTM, 0.002605509216788365);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002605509216788338);
    AssertAlmostEqual(&test, rTM, 0.00260550921678839);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002605509216785772);
    AssertAlmostEqual(&test, rTM, 0.002605509216790956);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002605509216529168);
    AssertAlmostEqual(&test, rTM, 0.002605509217047561);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002605509190868693);
    AssertAlmostEqual(&test, rTM, 0.002605509242708036);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002605506624823799);
    AssertAlmostEqual(&test, rTM, 0.00260551180875293);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002605250045856506);
    AssertAlmostEqual(&test, rTM, 0.002605768387719872);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002579844856763466);
    AssertAlmostEqual(&test, rTM, 0.002631173573380954);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.00130615115276079);
    AssertAlmostEqual(&test, rTM, 0.003904858482889847);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.593073258927418e-05);
    AssertAlmostEqual(&test, rTM, 0.005185053025928217);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619605816847751e-05);
    AssertAlmostEqual(&test, rTM, 2.619605816847751e-05);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619605816847751e-05);
    AssertAlmostEqual(&test, rTM, 2.619605816847751e-05);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619605816847751e-05);
    AssertAlmostEqual(&test, rTM, 2.619605816847751e-05);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619605816847751e-05);
    AssertAlmostEqual(&test, rTM, 2.619605816847751e-05);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619605816847751e-05);
    AssertAlmostEqual(&test, rTM, 2.619605816847752e-05);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619605816847725e-05);
    AssertAlmostEqual(&test, rTM, 2.619605816847778e-05);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619605816845132e-05);
    AssertAlmostEqual(&test, rTM, 2.619605816850371e-05);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619605816585805e-05);
    AssertAlmostEqual(&test, rTM, 2.619605817109698e-05);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619605790653066e-05);
    AssertAlmostEqual(&test, rTM, 2.619605843042437e-05);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619603197381797e-05);
    AssertAlmostEqual(&test, rTM, 2.619608436313706e-05);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619343896181071e-05);
    AssertAlmostEqual(&test, rTM, 2.619867737514432e-05);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.593670470981368e-05);
    AssertAlmostEqual(&test, rTM, 2.645541162713782e-05);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.309837220321756e-05);
    AssertAlmostEqual(&test, rTM, 3.929374412474964e-05);

    userdata[0] = 20/CAPS_HBAR_EV; /* 20eV */
    userdata[1] = 0.1/CAPS_HBAR_EV; /* 0.1eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999980232710659);
    AssertAlmostEqual(&test, rTM, 0.9999990116350445);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999859527863704);
    AssertAlmostEqual(&test, rTM, 0.9999998609177098);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998602267991357);
    AssertAlmostEqual(&test, rTM, 0.9999999860231007);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9986032160116119);
    AssertAlmostEqual(&test, rTM, 0.9999999986022405);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9861197470504351);
    AssertAlmostEqual(&test, rTM, 0.9999999998602206);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8696517406750823);
    AssertAlmostEqual(&test, rTM, 0.9999999999859883);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.271580300138784);
    AssertAlmostEqual(&test, rTM, 0.9999999999982947);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.005066672765525728);
    AssertAlmostEqual(&test, rTM, 0.9999999999990132);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.117884071517539e-05);
    AssertAlmostEqual(&test, rTM, 0.999999999999023);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.118402726869774e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999990231);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.118407914086892e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999999990231);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.118407965959129e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999999990231);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.118407966477852e-13);
    AssertAlmostEqual(&test, rTM, 0.9999999999990231);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999995557859291);
    AssertAlmostEqual(&test, rTM, 0.9999956018407854);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999993749047061);
    AssertAlmostEqual(&test, rTM, 0.9999968745186462);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999555794808699);
    AssertAlmostEqual(&test, rTM, 0.9999995601832079);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995580650829359);
    AssertAlmostEqual(&test, rTM, 0.9999999558011595);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9955896506422466);
    AssertAlmostEqual(&test, rTM, 0.9999999955798864);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9567650226278264);
    AssertAlmostEqual(&test, rTM, 0.9999999995578815);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6450101964431318);
    AssertAlmostEqual(&test, rTM, 0.9999999999547323);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04653154577952157);
    AssertAlmostEqual(&test, rTM, 0.9999999999892779);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000511317414333424);
    AssertAlmostEqual(&test, rTM, 0.9999999999902214);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.118354670971942e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999902313);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.118406542521534e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999902314);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.118407061243668e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999999902314);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.118407066430889e-12);
    AssertAlmostEqual(&test, rTM, 0.9999999999902314);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999557994770391);
    AssertAlmostEqual(&test, rTM, 0.9999557995212385);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999557972892178);
    AssertAlmostEqual(&test, rTM, 0.9999558017089493);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999555790512918);
    AssertAlmostEqual(&test, rTM, 0.9999560188529932);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999374916244492);
    AssertAlmostEqual(&test, rTM, 0.9999687453237897);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995558793009457);
    AssertAlmostEqual(&test, rTM, 0.9999956017981448);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9955893902580669);
    AssertAlmostEqual(&test, rTM, 0.9999995580063401);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.956764592815433);
    AssertAlmostEqual(&test, rTM, 0.9999999557877517);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6450075028425406);
    AssertAlmostEqual(&test, rTM, 0.9999999954731897);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04653072581277361);
    AssertAlmostEqual(&test, rTM, 0.9999999989277678);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005113075347577357);
    AssertAlmostEqual(&test, rTM, 0.9999999990221152);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.11825567495218e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999990231047);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.118307544495301e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999990231145);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.118308063197368e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999990231146);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998602201357814);
    AssertAlmostEqual(&test, rTM, 0.9998602201371791);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998602200665953);
    AssertAlmostEqual(&test, rTM, 0.9998602202063652);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998602131481503);
    AssertAlmostEqual(&test, rTM, 0.9998602271244609);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998595230246998);
    AssertAlmostEqual(&test, rTM, 0.9998609137891098);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998023271442487);
    AssertAlmostEqual(&test, rTM, 0.9999011586870804);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9985961180487642);
    AssertAlmostEqual(&test, rTM, 0.9999860905049355);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9861177116702987);
    AssertAlmostEqual(&test, rTM, 0.999998602140389);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.869639836349216);
    AssertAlmostEqual(&test, rTM, 0.9999998598694063);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2715499103577371);
    AssertAlmostEqual(&test, rTM, 0.9999999829449285);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.005065693140530606);
    AssertAlmostEqual(&test, rTM, 0.9999999901299358);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.116884571464099e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999902284293);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.117403024251359e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999902294192);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.117408209442439e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999902294291);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995576558327011);
    AssertAlmostEqual(&test, rTM, 0.9995576558327453);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995576558305119);
    AssertAlmostEqual(&test, rTM, 0.9995576558349344);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995576556116);
    AssertAlmostEqual(&test, rTM, 0.9995576560538462);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995576337209606);
    AssertAlmostEqual(&test, rTM, 0.9995576779433807);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995554501042099);
    AssertAlmostEqual(&test, rTM, 0.9995598506194561);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993744881993882);
    AssertAlmostEqual(&test, rTM, 0.9996871951686123);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9955633872255579);
    AssertAlmostEqual(&test, rTM, 0.9999559762345922);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9567216305199323);
    AssertAlmostEqual(&test, rTM, 0.9999955747283238);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.644738336869138);
    AssertAlmostEqual(&test, rTM, 0.9999995468613403);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04644887513275446);
    AssertAlmostEqual(&test, rTM, 0.9999998925870232);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005103215014727881);
    AssertAlmostEqual(&test, rTM, 0.9999999020225839);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.10837537430849e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999021215329);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.108427043790819e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999021225229);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9985896476031521);
    AssertAlmostEqual(&test, rTM, 0.9985896476031535);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9985896476030823);
    AssertAlmostEqual(&test, rTM, 0.9985896476032232);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.998589647596106);
    AssertAlmostEqual(&test, rTM, 0.9985896476101996);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9985896468984744);
    AssertAlmostEqual(&test, rTM, 0.9985896483078308);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9985895771370595);
    AssertAlmostEqual(&test, rTM, 0.998589718065728);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9985826183715875);
    AssertAlmostEqual(&test, rTM, 0.9985966419990742);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9980060434306174);
    AssertAlmostEqual(&test, rTM, 0.9990025239881238);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9859163625934519);
    AssertAlmostEqual(&test, rTM, 0.9998595720245306);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8684676307536819);
    AssertAlmostEqual(&test, rTM, 0.9999858522338089);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2685769110238236);
    AssertAlmostEqual(&test, rTM, 0.9999982726284102);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.004970540888514112);
    AssertAlmostEqual(&test, rTM, 0.999998994099128);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.019820349324575e-05);
    AssertAlmostEqual(&test, rTM, 0.9999990039494128);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.020319318973637e-07);
    AssertAlmostEqual(&test, rTM, 0.9999990040484076);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9951790245586766);
    AssertAlmostEqual(&test, rTM, 0.9951790245586767);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9951790245586742);
    AssertAlmostEqual(&test, rTM, 0.995179024558679);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9951790245584361);
    AssertAlmostEqual(&test, rTM, 0.995179024558917);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.99517902453463);
    AssertAlmostEqual(&test, rTM, 0.9951790245827232);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.995179022154014);
    AssertAlmostEqual(&test, rTM, 0.995179026963338);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9951787840983941);
    AssertAlmostEqual(&test, rTM, 0.9951792650069951);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9951550380336673);
    AssertAlmostEqual(&test, rTM, 0.9952028926162926);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9931889315394654);
    AssertAlmostEqual(&test, rTM, 0.9965886371637602);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9525976628424716);
    AssertAlmostEqual(&test, rTM, 0.9995191111947698);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6195857772244324);
    AssertAlmostEqual(&test, rTM, 0.9999502867098981);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03950240226433224);
    AssertAlmostEqual(&test, rTM, 0.9999873624594172);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.00042781863047323);
    AssertAlmostEqual(&test, rTM, 0.9999883129432231);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.281812605094694e-06);
    AssertAlmostEqual(&test, rTM, 0.9999883228387718);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9762643116385811);
    AssertAlmostEqual(&test, rTM, 0.9762643116385811);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.976264311638581);
    AssertAlmostEqual(&test, rTM, 0.9762643116385812);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9762643116385694);
    AssertAlmostEqual(&test, rTM, 0.9762643116385928);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9762643116374086);
    AssertAlmostEqual(&test, rTM, 0.9762643116397536);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.976264311521328);
    AssertAlmostEqual(&test, rTM, 0.9762643117558342);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9762642999132772);
    AssertAlmostEqual(&test, rTM, 0.9762643233638792);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9762631391379167);
    AssertAlmostEqual(&test, rTM, 0.9762654840820244);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9761473572943842);
    AssertAlmostEqual(&test, rTM, 0.9763806993859088);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9665992401395206);
    AssertAlmostEqual(&test, rTM, 0.9831565856306385);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7859669008732498);
    AssertAlmostEqual(&test, rTM, 0.997595561701797);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1308815113002295);
    AssertAlmostEqual(&test, rTM, 0.9996246812940749);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001726879649158343);
    AssertAlmostEqual(&test, rTM, 0.9997105452415975);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.732801022687225e-05);
    AssertAlmostEqual(&test, rTM, 0.9997115330858252);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8187492027671583);
    AssertAlmostEqual(&test, rTM, 0.8187492027671583);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8187492027671583);
    AssertAlmostEqual(&test, rTM, 0.8187492027671583);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8187492027671576);
    AssertAlmostEqual(&test, rTM, 0.8187492027671591);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8187492027670767);
    AssertAlmostEqual(&test, rTM, 0.8187492027672399);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.818749202758999);
    AssertAlmostEqual(&test, rTM, 0.8187492027753177);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8187492019512188);
    AssertAlmostEqual(&test, rTM, 0.8187492035830979);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8187491211732252);
    AssertAlmostEqual(&test, rTM, 0.8187492843610584);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8187410436180317);
    AssertAlmostEqual(&test, rTM, 0.8187573615856109);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8179357174880256);
    AssertAlmostEqual(&test, rTM, 0.8195594140654194);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.754014587956471);
    AssertAlmostEqual(&test, rTM, 0.8677326141581142);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1699935934651517);
    AssertAlmostEqual(&test, rTM, 0.9723873262611978);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002479654292467035);
    AssertAlmostEqual(&test, rTM, 0.9802355435429854);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.49212004444674e-05);
    AssertAlmostEqual(&test, rTM, 0.9803313869579451);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.176680719498883);
    AssertAlmostEqual(&test, rTM, 0.176680719498883);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.176680719498883);
    AssertAlmostEqual(&test, rTM, 0.176680719498883);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.176680719498883);
    AssertAlmostEqual(&test, rTM, 0.176680719498883);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1766807194988818);
    AssertAlmostEqual(&test, rTM, 0.1766807194988843);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1766807194987594);
    AssertAlmostEqual(&test, rTM, 0.1766807194990067);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1766807194865207);
    AssertAlmostEqual(&test, rTM, 0.1766807195112453);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1766807182626544);
    AssertAlmostEqual(&test, rTM, 0.1766807207351117);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1766805958761063);
    AssertAlmostEqual(&test, rTM, 0.1766808431216541);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1766683581050774);
    AssertAlmostEqual(&test, rTM, 0.176693080836954);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1754533534086559);
    AssertAlmostEqual(&test, rTM, 0.1779075363694292);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1045073124618133);
    AssertAlmostEqual(&test, rTM, 0.247002890860913);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002567428195182713);
    AssertAlmostEqual(&test, rTM, 0.340396830476109);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.60607268236993e-05);
    AssertAlmostEqual(&test, rTM, 0.3426417877876062);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.00260484621798052);
    AssertAlmostEqual(&test, rTM, 0.00260484621798052);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.00260484621798052);
    AssertAlmostEqual(&test, rTM, 0.00260484621798052);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.00260484621798052);
    AssertAlmostEqual(&test, rTM, 0.00260484621798052);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.00260484621798052);
    AssertAlmostEqual(&test, rTM, 0.00260484621798052);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002604846217980494);
    AssertAlmostEqual(&test, rTM, 0.002604846217980546);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002604846217977929);
    AssertAlmostEqual(&test, rTM, 0.002604846217983111);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002604846217721389);
    AssertAlmostEqual(&test, rTM, 0.002604846218239651);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.00260484619206741);
    AssertAlmostEqual(&test, rTM, 0.00260484624389363);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.00260484362667207);
    AssertAlmostEqual(&test, rTM, 0.002604848809288969);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002604587112653849);
    AssertAlmostEqual(&test, rTM, 0.002605105323306841);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002579188354829645);
    AssertAlmostEqual(&test, rTM, 0.002630504077701696);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001305817924445615);
    AssertAlmostEqual(&test, rTM, 0.003903865720292092);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.592410012456382e-05);
    AssertAlmostEqual(&test, rTM, 0.005183733687239753);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619538782733352e-05);
    AssertAlmostEqual(&test, rTM, 2.619538782733352e-05);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619538782733352e-05);
    AssertAlmostEqual(&test, rTM, 2.619538782733352e-05);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619538782733352e-05);
    AssertAlmostEqual(&test, rTM, 2.619538782733352e-05);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619538782733352e-05);
    AssertAlmostEqual(&test, rTM, 2.619538782733352e-05);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619538782733352e-05);
    AssertAlmostEqual(&test, rTM, 2.619538782733352e-05);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619538782733326e-05);
    AssertAlmostEqual(&test, rTM, 2.619538782733378e-05);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619538782730733e-05);
    AssertAlmostEqual(&test, rTM, 2.619538782735972e-05);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619538782471412e-05);
    AssertAlmostEqual(&test, rTM, 2.619538782995292e-05);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619538756539337e-05);
    AssertAlmostEqual(&test, rTM, 2.619538808927367e-05);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619536163334425e-05);
    AssertAlmostEqual(&test, rTM, 2.61954140213228e-05);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619276868768711e-05);
    AssertAlmostEqual(&test, rTM, 2.619800696697994e-05);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.593604100502218e-05);
    AssertAlmostEqual(&test, rTM, 2.645473464964134e-05);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.309803701508532e-05);
    AssertAlmostEqual(&test, rTM, 3.929273863059458e-05);

    userdata[0] = 20/CAPS_HBAR_EV; /* 20eV */
    userdata[1] = 0.5/CAPS_HBAR_EV; /* 0.5eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999955799051647);
    AssertAlmostEqual(&test, rTM, 0.9999977899501402);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999685897483712);
    AssertAlmostEqual(&test, rTM, 0.9999996890025736);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999687484623442);
    AssertAlmostEqual(&test, rTM, 0.9999999687467034);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9968793930178583);
    AssertAlmostEqual(&test, rTM, 0.9999999968745118);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9692297573323667);
    AssertAlmostEqual(&test, rTM, 0.9999999996874133);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7325012616764145);
    AssertAlmostEqual(&test, rTM, 0.9999999999683657);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.08559395233802823);
    AssertAlmostEqual(&test, rTM, 0.9999999999942013);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001021591109598044);
    AssertAlmostEqual(&test, rTM, 0.9999999999951057);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.023660651352229e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999951156);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.023681399711864e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999951157);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.02368160720077e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999999951157);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.023681609275659e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999999951157);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.023681609296408e-13);
    AssertAlmostEqual(&test, rTM, 0.9999999999951157);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999900670994549);
    AssertAlmostEqual(&test, rTM, 0.9999901654445212);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999860224993959);
    AssertAlmostEqual(&test, rTM, 0.9999930112252764);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999006754342853);
    AssertAlmostEqual(&test, rTM, 0.9999990165400986);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9990120734906555);
    AssertAlmostEqual(&test, rTM, 0.9999999011683889);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9901650631976573);
    AssertAlmostEqual(&test, rTM, 0.9999999901162298);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9059271715297338);
    AssertAlmostEqual(&test, rTM, 0.9999999990104285);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3859662659567497);
    AssertAlmostEqual(&test, rTM, 0.9999999998897533);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01003244547668153);
    AssertAlmostEqual(&test, rTM, 0.9999999999501668);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001023472042125561);
    AssertAlmostEqual(&test, rTM, 0.9999999999511466);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.023679477454056e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999511566);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.023681552338141e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999511567);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.023681573087035e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999999511567);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.023681573294524e-12);
    AssertAlmostEqual(&test, rTM, 0.9999999999511567);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999011680982891);
    AssertAlmostEqual(&test, rTM, 0.9999011681971161);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999011632064777);
    AssertAlmostEqual(&test, rTM, 0.9999011730886804);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999900675242182);
    AssertAlmostEqual(&test, rTM, 0.9999016586072681);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999860233515102);
    AssertAlmostEqual(&test, rTM, 0.9999301143154612);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9990071962879781);
    AssertAlmostEqual(&test, rTM, 0.9999901654243105);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9901645598570864);
    AssertAlmostEqual(&test, rTM, 0.9999990116704709);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9059269542879639);
    AssertAlmostEqual(&test, rTM, 0.9999999010427033);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3859656027814508);
    AssertAlmostEqual(&test, rTM, 0.999999988975306);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01003240743741118);
    AssertAlmostEqual(&test, rTM, 0.999999995016653);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001023468083761056);
    AssertAlmostEqual(&test, rTM, 0.9999999951146499);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.023675517485889e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999951156398);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.023677592353931e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999951156496);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.023677613102665e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999951156497);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.99968749414025);
    AssertAlmostEqual(&test, rTM, 0.9996874941433747);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996874939855839);
    AssertAlmostEqual(&test, rTM, 0.9996874942980407);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999687478519352);
    AssertAlmostEqual(&test, rTM, 0.9996875097634919);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996859357442295);
    AssertAlmostEqual(&test, rTM, 0.9996890448077755);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995580785844999);
    AssertAlmostEqual(&test, rTM, 0.999779014872339);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.996863793637453);
    AssertAlmostEqual(&test, rTM, 0.9999689000910051);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9692276513126337);
    AssertAlmostEqual(&test, rTM, 0.9999968742325654);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7324967298060526);
    AssertAlmostEqual(&test, rTM, 0.999999683651835);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.08559113484309501);
    AssertAlmostEqual(&test, rTM, 0.9999999420106944);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001021551278195863);
    AssertAlmostEqual(&test, rTM, 0.9999999510548845);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.023620658551698e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999511537823);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.023641405291155e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999511547722);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.023641612763859e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999511547821);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999011929987588);
    AssertAlmostEqual(&test, rTM, 0.9990119299876867);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9990119299826995);
    AssertAlmostEqual(&test, rTM, 0.9990119299925753);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9990119294938467);
    AssertAlmostEqual(&test, rTM, 0.9990119304814278);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9990118806097915);
    AssertAlmostEqual(&test, rTM, 0.999011979363017);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9990070043750633);
    AssertAlmostEqual(&test, rTM, 0.9990168311794325);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9986029440464589);
    AssertAlmostEqual(&test, rTM, 0.9993012277966636);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9901143383217037);
    AssertAlmostEqual(&test, rTM, 0.9999016383994039);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.905905231315724);
    AssertAlmostEqual(&test, rTM, 0.9999901028914104);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3858992987056385);
    AssertAlmostEqual(&test, rTM, 0.9999988972768209);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01002860496666138);
    AssertAlmostEqual(&test, rTM, 0.9999995014765628);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001023072401874765);
    AssertAlmostEqual(&test, rTM, 0.9999995112762797);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.02327967532734e-06);
    AssertAlmostEqual(&test, rTM, 0.9999995113752694);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.023281748592045e-08);
    AssertAlmostEqual(&test, rTM, 0.9999995113762594);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9968733132349133);
    AssertAlmostEqual(&test, rTM, 0.9968733132349165);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9968733132347588);
    AssertAlmostEqual(&test, rTM, 0.996873313235071);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9968733132193059);
    AssertAlmostEqual(&test, rTM, 0.9968733132505239);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9968733116740198);
    AssertAlmostEqual(&test, rTM, 0.9968733147958092);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9968731571492778);
    AssertAlmostEqual(&test, rTM, 0.9968734693127727);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9968577432299596);
    AssertAlmostEqual(&test, rTM, 0.996888806210091);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9955810640974451);
    AssertAlmostEqual(&test, rTM, 0.9977880830579587);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9690192954727761);
    AssertAlmostEqual(&test, rTM, 0.999688406251657);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7320485839772266);
    AssertAlmostEqual(&test, rTM, 0.9999683047011457);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.08531309674234237);
    AssertAlmostEqual(&test, rTM, 0.9999941819286897);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001017622893703825);
    AssertAlmostEqual(&test, rTM, 0.9999950866177822);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.019676387102186e-05);
    AssertAlmostEqual(&test, rTM, 0.9999950965075342);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.019696974363473e-07);
    AssertAlmostEqual(&test, rTM, 0.9999950966065324);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9899757198640683);
    AssertAlmostEqual(&test, rTM, 0.9899757198640684);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9899757198640633);
    AssertAlmostEqual(&test, rTM, 0.9899757198640733);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9899757198635696);
    AssertAlmostEqual(&test, rTM, 0.989975719864567);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9899757198141994);
    AssertAlmostEqual(&test, rTM, 0.9899757199139372);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9899757148771776);
    AssertAlmostEqual(&test, rTM, 0.9899757248509565);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9899752211874635);
    AssertAlmostEqual(&test, rTM, 0.9899762185159917);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9899259762500822);
    AssertAlmostEqual(&test, rTM, 0.9900252190847729);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.985853076046832);
    AssertAlmostEqual(&test, rTM, 0.9929012528102582);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9037447336912444);
    AssertAlmostEqual(&test, rTM, 0.9989967546886463);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3794003703279432);
    AssertAlmostEqual(&test, rTM, 0.9998872036199007);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.009662383486966011);
    AssertAlmostEqual(&test, rTM, 0.9999482604680183);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -9.849917425365607e-05);
    AssertAlmostEqual(&test, rTM, 0.9999492407305135);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -9.851838815322372e-07);
    AssertAlmostEqual(&test, rTM, 0.9999492506287748);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9638141986077878);
    AssertAlmostEqual(&test, rTM, 0.9638141986077878);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9638141986077877);
    AssertAlmostEqual(&test, rTM, 0.9638141986077881);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9638141986077702);
    AssertAlmostEqual(&test, rTM, 0.9638141986078056);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9638141986060119);
    AssertAlmostEqual(&test, rTM, 0.9638141986095639);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9638141984301928);
    AssertAlmostEqual(&test, rTM, 0.963814198785383);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9638141808482767);
    AssertAlmostEqual(&test, rTM, 0.9638142163672905);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9638124227022616);
    AssertAlmostEqual(&test, rTM, 0.9638159744277673);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9636370616621383);
    AssertAlmostEqual(&test, rTM, 0.963990488479658);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9492146158950451);
    AssertAlmostEqual(&test, rTM, 0.9742721476077422);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6918813222287724);
    AssertAlmostEqual(&test, rTM, 0.9962782384739034);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.06442190879319917);
    AssertAlmostEqual(&test, rTM, 0.9992277256211911);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000734983960322071);
    AssertAlmostEqual(&test, rTM, 0.9993201762281116);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -7.360554484852106e-06);
    AssertAlmostEqual(&test, rTM, 0.9993211644846252);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8037109418147742);
    AssertAlmostEqual(&test, rTM, 0.8037109418147742);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8037109418147742);
    AssertAlmostEqual(&test, rTM, 0.8037109418147742);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8037109418147733);
    AssertAlmostEqual(&test, rTM, 0.8037109418147751);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8037109418146867);
    AssertAlmostEqual(&test, rTM, 0.8037109418148617);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8037109418060278);
    AssertAlmostEqual(&test, rTM, 0.8037109418235205);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8037109409401348);
    AssertAlmostEqual(&test, rTM, 0.8037109426894136);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8037108543508621);
    AssertAlmostEqual(&test, rTM, 0.8037110292786516);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8037021956896995);
    AssertAlmostEqual(&test, rTM, 0.803719687592568);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8028389773158187);
    AssertAlmostEqual(&test, rTM, 0.8045794679758373);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7346074057590293);
    AssertAlmostEqual(&test, rTM, 0.8563116402272659);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1494220180121431);
    AssertAlmostEqual(&test, rTM, 0.9684965343141831);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.00207710401508237);
    AssertAlmostEqual(&test, rTM, 0.976495111276882);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.085879165483031e-05);
    AssertAlmostEqual(&test, rTM, 0.9765904474506221);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1741990914141244);
    AssertAlmostEqual(&test, rTM, 0.1741990914141244);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1741990914141244);
    AssertAlmostEqual(&test, rTM, 0.1741990914141244);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1741990914141244);
    AssertAlmostEqual(&test, rTM, 0.1741990914141245);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1741990914141232);
    AssertAlmostEqual(&test, rTM, 0.1741990914141257);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1741990914140019);
    AssertAlmostEqual(&test, rTM, 0.1741990914142469);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1741990914018732);
    AssertAlmostEqual(&test, rTM, 0.1741990914263757);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.174199090189002);
    AssertAlmostEqual(&test, rTM, 0.1741990926392469);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1741989689019673);
    AssertAlmostEqual(&test, rTM, 0.1741992139262762);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1741868410780349);
    AssertAlmostEqual(&test, rTM, 0.1742113416962936);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1729827888457045);
    AssertAlmostEqual(&test, rTM, 0.1754148626672973);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1028097431990545);
    AssertAlmostEqual(&test, rTM, 0.2438030775206939);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.00251643257606916);
    AssertAlmostEqual(&test, rTM, 0.3359066875019723);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.554050975626928e-05);
    AssertAlmostEqual(&test, rTM, 0.3381146766909831);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.00259955434982049);
    AssertAlmostEqual(&test, rTM, 0.00259955434982049);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.00259955434982049);
    AssertAlmostEqual(&test, rTM, 0.00259955434982049);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.00259955434982049);
    AssertAlmostEqual(&test, rTM, 0.00259955434982049);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.00259955434982049);
    AssertAlmostEqual(&test, rTM, 0.00259955434982049);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002599554349820464);
    AssertAlmostEqual(&test, rTM, 0.002599554349820516);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002599554349817904);
    AssertAlmostEqual(&test, rTM, 0.002599554349823076);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002599554349561882);
    AssertAlmostEqual(&test, rTM, 0.002599554350079097);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.00259955432395975);
    AssertAlmostEqual(&test, rTM, 0.00259955437568123);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002599551763749036);
    AssertAlmostEqual(&test, rTM, 0.002599556935891945);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002599295768142039);
    AssertAlmostEqual(&test, rTM, 0.002599812931498593);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002573948343485792);
    AssertAlmostEqual(&test, rTM, 0.002625160352746278);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001303158206473866);
    AssertAlmostEqual(&test, rTM, 0.003895941755321524);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.587116230018697e-05);
    AssertAlmostEqual(&test, rTM, 0.005173203099477938);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.61900263329895e-05);
    AssertAlmostEqual(&test, rTM, 2.61900263329895e-05);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.61900263329895e-05);
    AssertAlmostEqual(&test, rTM, 2.61900263329895e-05);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.61900263329895e-05);
    AssertAlmostEqual(&test, rTM, 2.61900263329895e-05);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.61900263329895e-05);
    AssertAlmostEqual(&test, rTM, 2.61900263329895e-05);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619002633298949e-05);
    AssertAlmostEqual(&test, rTM, 2.61900263329895e-05);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619002633298924e-05);
    AssertAlmostEqual(&test, rTM, 2.619002633298976e-05);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619002633296331e-05);
    AssertAlmostEqual(&test, rTM, 2.619002633301569e-05);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619002633037063e-05);
    AssertAlmostEqual(&test, rTM, 2.619002633560836e-05);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619002607110295e-05);
    AssertAlmostEqual(&test, rTM, 2.619002659487604e-05);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.619000014436115e-05);
    AssertAlmostEqual(&test, rTM, 2.619005252161784e-05);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.618740772938275e-05);
    AssertAlmostEqual(&test, rTM, 2.619264493659625e-05);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.593073258927419e-05);
    AssertAlmostEqual(&test, rTM, 2.644932007670129e-05);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.309535612747987e-05);
    AssertAlmostEqual(&test, rTM, 3.928469652951749e-05);

    userdata[0] = 20/CAPS_HBAR_EV; /* 20eV */
    userdata[1] = 1/CAPS_HBAR_EV; /* 1eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999937490476655);
    AssertAlmostEqual(&test, rTM, 0.9999968745189484);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999555794851657);
    AssertAlmostEqual(&test, rTM, 0.9999995601832505);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995580651256658);
    AssertAlmostEqual(&test, rTM, 0.9999999558011637);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9955896510678277);
    AssertAlmostEqual(&test, rTM, 0.9999999955798868);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9567650267166847);
    AssertAlmostEqual(&test, rTM, 0.9999999995578817);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.645010223365552);
    AssertAlmostEqual(&test, rTM, 0.9999999999547323);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04653155397929333);
    AssertAlmostEqual(&test, rTM, 0.9999999999892779);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005113175131311039);
    AssertAlmostEqual(&test, rTM, 0.9999999999902214);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.118355660951478e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999902313);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.118407532521136e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999902314);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.11840805124347e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999999902314);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.118408056430694e-12);
    AssertAlmostEqual(&test, rTM, 0.9999999999902314);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.118408056482566e-14);
    AssertAlmostEqual(&test, rTM, 0.9999999999902314);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999859527863704);
    AssertAlmostEqual(&test, rTM, 0.9999860918667263);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999802328864937);
    AssertAlmostEqual(&test, rTM, 0.9999901163944038);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999859536743075);
    AssertAlmostEqual(&test, rTM, 0.9999986091779646);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9986031469209071);
    AssertAlmostEqual(&test, rTM, 0.9999998602309824);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9861197402277287);
    AssertAlmostEqual(&test, rTM, 0.9999999860220676);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8696517400748421);
    AssertAlmostEqual(&test, rTM, 0.9999999985988308);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2715803001233822);
    AssertAlmostEqual(&test, rTM, 0.9999999998294714);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.005066672765520763);
    AssertAlmostEqual(&test, rTM, 0.9999999999013185);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.11788407151749e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999023034);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.118402726869774e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999023133);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.118407914086893e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999999023134);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.11840796595913e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999999023134);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.118407966477853e-13);
    AssertAlmostEqual(&test, rTM, 0.9999999999023134);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998602335817469);
    AssertAlmostEqual(&test, rTM, 0.9998602337215035);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998602266639709);
    AssertAlmostEqual(&test, rTM, 0.9998602406389302);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998595366072429);
    AssertAlmostEqual(&test, rTM, 0.999860927237191);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998023462564433);
    AssertAlmostEqual(&test, rTM, 0.9999011682441223);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9985962537025436);
    AssertAlmostEqual(&test, rTM, 0.9999860918499129);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9861190446439768);
    AssertAlmostEqual(&test, rTM, 0.9999986022755624);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8696515627799781);
    AssertAlmostEqual(&test, rTM, 0.9999998598830222);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2715799976736923);
    AssertAlmostEqual(&test, rTM, 0.9999999829471189);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.005066663063914654);
    AssertAlmostEqual(&test, rTM, 0.9999999901318254);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.117874173558452e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999902303187);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.118392826909527e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999902313087);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.11839801410663e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999902313186);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.118398065978668e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999902313187);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995580828981702);
    AssertAlmostEqual(&test, rTM, 0.9995580829025884);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995580826794696);
    AssertAlmostEqual(&test, rTM, 0.9995580831212888);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995580608099601);
    AssertAlmostEqual(&test, rTM, 0.9995581049896944);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995558793009457);
    AssertAlmostEqual(&test, rTM, 0.9995602755685893);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993750920536224);
    AssertAlmostEqual(&test, rTM, 0.9996874971901797);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.995567662049303);
    AssertAlmostEqual(&test, rTM, 0.9999560187466479);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9567625000064116);
    AssertAlmostEqual(&test, rTM, 0.9999955790037893);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6450073650419468);
    AssertAlmostEqual(&test, rTM, 0.999999547319313);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04653072539308254);
    AssertAlmostEqual(&test, rTM, 0.9999998927767866);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000511307534707168);
    AssertAlmostEqual(&test, rTM, 0.999999902211529);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.118255674947114e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999023104779);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.118307544495251e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999023114678);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.118308063197368e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999023114777);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9986030803780677);
    AssertAlmostEqual(&test, rTM, 0.9986030803782073);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9986030803711577);
    AssertAlmostEqual(&test, rTM, 0.9986030803851172);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.998603079680166);
    AssertAlmostEqual(&test, rTM, 0.9986030810761086);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9986030105827224);
    AssertAlmostEqual(&test, rTM, 0.998603150170068);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9985961180487642);
    AssertAlmostEqual(&test, rTM, 0.9986100082029591);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9980250291891145);
    AssertAlmostEqual(&test, rTM, 0.9990120263075799);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9860496518561124);
    AssertAlmostEqual(&test, rTM, 0.999860910425646);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8696338336189254);
    AssertAlmostEqual(&test, rTM, 0.9999859877348259);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2715497563470077);
    AssertAlmostEqual(&test, rTM, 0.9999982944956872);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.005065693090885776);
    AssertAlmostEqual(&test, rTM, 0.9999990129945411);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.116884570957579e-05);
    AssertAlmostEqual(&test, rTM, 0.9999990228438748);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.117403024246292e-07);
    AssertAlmostEqual(&test, rTM, 0.9999990229428695);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.117408209442388e-09);
    AssertAlmostEqual(&test, rTM, 0.9999990229438595);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9955853565821303);
    AssertAlmostEqual(&test, rTM, 0.9955853565821348);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9955853565819123);
    AssertAlmostEqual(&test, rTM, 0.9955853565823528);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9955853565601082);
    AssertAlmostEqual(&test, rTM, 0.9955853566041569);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9955853543796944);
    AssertAlmostEqual(&test, rTM, 0.9955853587845696);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9955851363437966);
    AssertAlmostEqual(&test, rTM, 0.995585576809506);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9955633872255579);
    AssertAlmostEqual(&test, rTM, 0.9956072173896401);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.993762469624638);
    AssertAlmostEqual(&test, rTM, 0.9968763486057748);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9565127006900001);
    AssertAlmostEqual(&test, rTM, 0.9995597440214625);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6447245503733997);
    AssertAlmostEqual(&test, rTM, 0.9999546895080598);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04644883323063739);
    AssertAlmostEqual(&test, rTM, 0.9999892588123707);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005103214964257591);
    AssertAlmostEqual(&test, rTM, 0.9999902023533799);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.108375373802766e-06);
    AssertAlmostEqual(&test, rTM, 0.9999902122481318);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.108427043785762e-08);
    AssertAlmostEqual(&test, rTM, 0.9999902123471298);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.985985763784011);
    AssertAlmostEqual(&test, rTM, 0.9859857637840113);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9859857637840042);
    AssertAlmostEqual(&test, rTM, 0.9859857637840181);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9859857637833154);
    AssertAlmostEqual(&test, rTM, 0.9859857637847069);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9859857637144345);
    AssertAlmostEqual(&test, rTM, 0.9859857638535878);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9859857568263409);
    AssertAlmostEqual(&test, rTM, 0.9859857707416779);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.985985068034458);
    AssertAlmostEqual(&test, rTM, 0.9859864594992687);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9859163625934519);
    AssertAlmostEqual(&test, rTM, 0.9860548253816581);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9802387216219092);
    AssertAlmostEqual(&test, rTM, 0.9900698129487389);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8678641472443284);
    AssertAlmostEqual(&test, rTM, 0.9985931894313181);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2685615815029206);
    AssertAlmostEqual(&test, rTM, 0.9998272918299036);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.004970536016359937);
    AssertAlmostEqual(&test, rTM, 0.999899419880429);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.019820299633344e-05);
    AssertAlmostEqual(&test, rTM, 0.9999004047617686);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.020319318476625e-07);
    AssertAlmostEqual(&test, rTM, 0.9999004146597877);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9528272285883755);
    AssertAlmostEqual(&test, rTM, 0.9528272285883755);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9528272285883753);
    AssertAlmostEqual(&test, rTM, 0.9528272285883758);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9528272285883524);
    AssertAlmostEqual(&test, rTM, 0.9528272285883985);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9528272285860738);
    AssertAlmostEqual(&test, rTM, 0.9528272285906771);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9528272283582092);
    AssertAlmostEqual(&test, rTM, 0.9528272288185418);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9528272055717519);
    AssertAlmostEqual(&test, rTM, 0.9528272516049882);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9528249269857647);
    AssertAlmostEqual(&test, rTM, 0.9528295300814069);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9525976628424716);
    AssertAlmostEqual(&test, rTM, 0.9530557092947501);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9339517184132079);
    AssertAlmostEqual(&test, rTM, 0.9664021425179821);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6181505770534457);
    AssertAlmostEqual(&test, rTM, 0.995066679293197);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03949878908709462);
    AssertAlmostEqual(&test, rTM, 0.9987377742627292);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004278182072954507);
    AssertAlmostEqual(&test, rTM, 0.9988326443978766);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.281812562705112e-06);
    AssertAlmostEqual(&test, rTM, 0.9988336322379856);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7869023996018628);
    AssertAlmostEqual(&test, rTM, 0.7869023996018628);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7869023996018628);
    AssertAlmostEqual(&test, rTM, 0.7869023996018628);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7869023996018619);
    AssertAlmostEqual(&test, rTM, 0.7869023996018638);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.786902399601769);
    AssertAlmostEqual(&test, rTM, 0.7869023996019567);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7869023995924787);
    AssertAlmostEqual(&test, rTM, 0.7869023996112471);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7869023986634399);
    AssertAlmostEqual(&test, rTM, 0.7869024005402857);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7869023057596023);
    AssertAlmostEqual(&test, rTM, 0.786902493444087);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7868930156667507);
    AssertAlmostEqual(&test, rTM, 0.7869117831730392);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7859669008732498);
    AssertAlmostEqual(&test, rTM, 0.7878342951839098);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7131122135011656);
    AssertAlmostEqual(&test, rTM, 0.8434475090646397);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1298934502775395);
    AssertAlmostEqual(&test, rTM, 0.9637337121887914);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001726709294490991);
    AssertAlmostEqual(&test, rTM, 0.9718595374274999);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.732799307275379e-05);
    AssertAlmostEqual(&test, rTM, 0.9719542320427769);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1711963076294792);
    AssertAlmostEqual(&test, rTM, 0.1711963076294792);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1711963076294792);
    AssertAlmostEqual(&test, rTM, 0.1711963076294792);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1711963076294792);
    AssertAlmostEqual(&test, rTM, 0.1711963076294793);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.171196307629478);
    AssertAlmostEqual(&test, rTM, 0.1711963076294805);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1711963076293581);
    AssertAlmostEqual(&test, rTM, 0.1711963076296004);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1711963076173644);
    AssertAlmostEqual(&test, rTM, 0.171196307641594);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1711963064179989);
    AssertAlmostEqual(&test, rTM, 0.1711963088409596);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.171196186481532);
    AssertAlmostEqual(&test, rTM, 0.1711964287774213);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1711841937090562);
    AssertAlmostEqual(&test, rTM, 0.1712084214981403);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1699935934651517);
    AssertAlmostEqual(&test, rTM, 0.1723985117779658);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1007645713607537);
    AssertAlmostEqual(&test, rTM, 0.2399206949593257);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002455467839240692);
    AssertAlmostEqual(&test, rTM, 0.3304578913825476);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.49187336152622e-05);
    AssertAlmostEqual(&test, rTM, 0.3326212811592239);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002592969674522687);
    AssertAlmostEqual(&test, rTM, 0.002592969674522687);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002592969674522687);
    AssertAlmostEqual(&test, rTM, 0.002592969674522687);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002592969674522687);
    AssertAlmostEqual(&test, rTM, 0.002592969674522687);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002592969674522687);
    AssertAlmostEqual(&test, rTM, 0.002592969674522688);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002592969674522662);
    AssertAlmostEqual(&test, rTM, 0.002592969674522713);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002592969674520108);
    AssertAlmostEqual(&test, rTM, 0.002592969674525267);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002592969674264732);
    AssertAlmostEqual(&test, rTM, 0.002592969674780643);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002592969648727113);
    AssertAlmostEqual(&test, rTM, 0.002592969700318262);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002592967094967785);
    AssertAlmostEqual(&test, rTM, 0.00259297225407759);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002592711744435604);
    AssertAlmostEqual(&test, rTM, 0.002593227604609426);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002567428195182713);
    AssertAlmostEqual(&test, rTM, 0.002618511150479503);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001299848756696137);
    AssertAlmostEqual(&test, rTM, 0.003886081920619886);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.5805293278841e-05);
    AssertAlmostEqual(&test, rTM, 0.005160099878924726);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.618332755057905e-05);
    AssertAlmostEqual(&test, rTM, 2.618332755057905e-05);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.618332755057905e-05);
    AssertAlmostEqual(&test, rTM, 2.618332755057905e-05);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.618332755057905e-05);
    AssertAlmostEqual(&test, rTM, 2.618332755057905e-05);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.618332755057905e-05);
    AssertAlmostEqual(&test, rTM, 2.618332755057905e-05);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.618332755057905e-05);
    AssertAlmostEqual(&test, rTM, 2.618332755057905e-05);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.618332755057879e-05);
    AssertAlmostEqual(&test, rTM, 2.618332755057931e-05);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.618332755055287e-05);
    AssertAlmostEqual(&test, rTM, 2.618332755060523e-05);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.618332754796085e-05);
    AssertAlmostEqual(&test, rTM, 2.618332755319724e-05);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.618332728875949e-05);
    AssertAlmostEqual(&test, rTM, 2.618332781239861e-05);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.618330136864878e-05);
    AssertAlmostEqual(&test, rTM, 2.618335373250932e-05);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.618070961671341e-05);
    AssertAlmostEqual(&test, rTM, 2.618594548444469e-05);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.592410012456383e-05);
    AssertAlmostEqual(&test, rTM, 2.644255497659075e-05);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.309200656085408e-05);
    AssertAlmostEqual(&test, rTM, 3.927464853132928e-05);

    userdata[0] = 50/CAPS_HBAR_EV; /* 50eV */
    userdata[1] = 1e-05/CAPS_HBAR_EV; /* 1e-05eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999920923042);
    AssertAlmostEqual(&test, rTM, 0.9999999960461521);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999438052642);
    AssertAlmostEqual(&test, rTM, 0.9999999994436165);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999994408136641);
    AssertAlmostEqual(&test, rTM, 0.9999999999440869);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999944084274871);
    AssertAlmostEqual(&test, rTM, 0.9999999999944085);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999440857094902);
    AssertAlmostEqual(&test, rTM, 0.9999999999994409);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994409977722558);
    AssertAlmostEqual(&test, rTM, 0.999999999999944);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9944240257102441);
    AssertAlmostEqual(&test, rTM, 0.9999999999999944);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.945625588912994);
    AssertAlmostEqual(&test, rTM, 0.9999999999999994);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5757285262575373);
    AssertAlmostEqual(&test, rTM, 0.9999999999999999);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03008809315322166);
    AssertAlmostEqual(&test, rTM, 1);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003196335870951688);
    AssertAlmostEqual(&test, rTM, 1);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.198359704528605e-06);
    AssertAlmostEqual(&test, rTM, 1);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.198379959043661e-08);
    AssertAlmostEqual(&test, rTM, 1);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999822140505);
    AssertAlmostEqual(&test, rTM, 0.999999982390149);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999749716993);
    AssertAlmostEqual(&test, rTM, 0.9999999874858496);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999998221405194);
    AssertAlmostEqual(&test, rTM, 0.9999999982390149);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999982301449443);
    AssertAlmostEqual(&test, rTM, 0.999999999823032);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999823024663975);
    AssertAlmostEqual(&test, rTM, 0.9999999999823024);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998230388452478);
    AssertAlmostEqual(&test, rTM, 0.9999999999982302);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9982317972109481);
    AssertAlmostEqual(&test, rTM, 0.999999999999823);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9824582297374148);
    AssertAlmostEqual(&test, rTM, 0.9999999999999823);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8379920520080958);
    AssertAlmostEqual(&test, rTM, 0.9999999999999982);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2028723947946728);
    AssertAlmostEqual(&test, rTM, 0.9999999999999998);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.003172540993990228);
    AssertAlmostEqual(&test, rTM, 0.9999999999999999);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.192563369589839e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999999999);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.192765189818767e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999999999);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999998066943808);
    AssertAlmostEqual(&test, rTM, 0.9999998066945741);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999998066848124);
    AssertAlmostEqual(&test, rTM, 0.999999806704142);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999998057303542);
    AssertAlmostEqual(&test, rTM, 0.9999998076538159);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999997266247193);
    AssertAlmostEqual(&test, rTM, 0.9999998633123502);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999980573052407);
    AssertAlmostEqual(&test, rTM, 0.9999999807653799);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999806686662254);
    AssertAlmostEqual(&test, rTM, 0.9999999980670412);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998067130447388);
    AssertAlmostEqual(&test, rTM, 0.9999999998066945);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9980688120266561);
    AssertAlmostEqual(&test, rTM, 0.9999999999806695);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9808553781506657);
    AssertAlmostEqual(&test, rTM, 0.9999999999980669);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8244771669887669);
    AssertAlmostEqual(&test, rTM, 0.9999999999998058);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1799615787869014);
    AssertAlmostEqual(&test, rTM, 0.9999999999999731);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002661927294539429);
    AssertAlmostEqual(&test, rTM, 0.9999999999999812);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.676012569383426e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999999813);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999990391006285);
    AssertAlmostEqual(&test, rTM, 0.999999039100638);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999990391001528);
    AssertAlmostEqual(&test, rTM, 0.9999990391011137);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999990390525895);
    AssertAlmostEqual(&test, rTM, 0.9999990391486746);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999990343080903);
    AssertAlmostEqual(&test, rTM, 0.9999990438693918);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999986410833539);
    AssertAlmostEqual(&test, rTM, 0.9999993205414461);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999903431228681);
    AssertAlmostEqual(&test, rTM, 0.999999904386898);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999039098297726);
    AssertAlmostEqual(&test, rTM, 0.9999999903914821);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9990395612449341);
    AssertAlmostEqual(&test, rTM, 0.9999999990391005);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9904370571896501);
    AssertAlmostEqual(&test, rTM, 0.9999999999039089);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.90841582020948);
    AssertAlmostEqual(&test, rTM, 0.9999999999903799);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3956143581497837);
    AssertAlmostEqual(&test, rTM, 0.999999999998934);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01060195279104798);
    AssertAlmostEqual(&test, rTM, 0.9999999999995285);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001082803652635795);
    AssertAlmostEqual(&test, rTM, 0.9999999999995383);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999919875979775);
    AssertAlmostEqual(&test, rTM, 0.9999919875979782);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999919875979378);
    AssertAlmostEqual(&test, rTM, 0.999991987598018);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999919875939717);
    AssertAlmostEqual(&test, rTM, 0.999991987601984);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999919871973694);
    AssertAlmostEqual(&test, rTM, 0.9999919879985664);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999991947635786);
    AssertAlmostEqual(&test, rTM, 0.9999920273618466);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999886687711965);
    AssertAlmostEqual(&test, rTM, 0.9999943343695485);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999194792756448);
    AssertAlmostEqual(&test, rTM, 0.9999992027333237);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991990374899651);
    AssertAlmostEqual(&test, rTM, 0.9999999198796615);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9920195971558428);
    AssertAlmostEqual(&test, rTM, 0.9999999919875057);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9230213403381037);
    AssertAlmostEqual(&test, rTM, 0.9999999991981139);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4578448100384379);
    AssertAlmostEqual(&test, rTM, 0.9999999999136849);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01510939401642036);
    AssertAlmostEqual(&test, rTM, 0.9999999999669156);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001557169153161563);
    AssertAlmostEqual(&test, rTM, 0.9999999999678905);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999216540259609);
    AssertAlmostEqual(&test, rTM, 0.999921654025961);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999921654025957);
    AssertAlmostEqual(&test, rTM, 0.9999216540259649);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999216540255692);
    AssertAlmostEqual(&test, rTM, 0.9999216540263527);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999216539867896);
    AssertAlmostEqual(&test, rTM, 0.9999216540651323);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999216501089137);
    AssertAlmostEqual(&test, rTM, 0.9999216579428124);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999212632859332);
    AssertAlmostEqual(&test, rTM, 0.9999220428269718);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999889203858818);
    AssertAlmostEqual(&test, rTM, 0.9999446003948084);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9992129117970432);
    AssertAlmostEqual(&test, rTM, 0.99999220400861);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9921953397425468);
    AssertAlmostEqual(&test, rTM, 0.9999992165430349);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9246601109662327);
    AssertAlmostEqual(&test, rTM, 0.9999999215909032);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4654641649946627);
    AssertAlmostEqual(&test, rTM, 0.9999999915853555);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01578035128059074);
    AssertAlmostEqual(&test, rTM, 0.9999999968322918);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001628512672715897);
    AssertAlmostEqual(&test, rTM, 0.9999999969297139);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9992186125024936);
    AssertAlmostEqual(&test, rTM, 0.9992186125024937);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9992186125024932);
    AssertAlmostEqual(&test, rTM, 0.999218612502494);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9992186125024546);
    AssertAlmostEqual(&test, rTM, 0.9992186125025326);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9992186124985882);
    AssertAlmostEqual(&test, rTM, 0.999218612506399);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9992186121119526);
    AssertAlmostEqual(&test, rTM, 0.9992186128930344);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9992185734493659);
    AssertAlmostEqual(&test, rTM, 0.9992186515536703);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9992147168146259);
    AssertAlmostEqual(&test, rTM, 0.9992224888718759);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9988951300897304);
    AssertAlmostEqual(&test, rTM, 0.9994474123261246);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9921748800931141);
    AssertAlmostEqual(&test, rTM, 0.9999222210801165);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9248226283435526);
    AssertAlmostEqual(&test, rTM, 0.9999921775243819);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4662437845234542);
    AssertAlmostEqual(&test, rTM, 0.999999160722857);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585073974599303);
    AssertAlmostEqual(&test, rTM, 0.9999996846366638);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636008234961518);
    AssertAlmostEqual(&test, rTM, 0.999999694378168);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9922153486119466);
    AssertAlmostEqual(&test, rTM, 0.9922153486119466);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9922153486119465);
    AssertAlmostEqual(&test, rTM, 0.9922153486119466);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9922153486119427);
    AssertAlmostEqual(&test, rTM, 0.9922153486119505);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9922153486115588);
    AssertAlmostEqual(&test, rTM, 0.9922153486123343);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9922153485731754);
    AssertAlmostEqual(&test, rTM, 0.9922153486507177);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9922153447348312);
    AssertAlmostEqual(&test, rTM, 0.99221535248906);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9922149609100853);
    AssertAlmostEqual(&test, rTM, 0.9922157362945754);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9921766746504741);
    AssertAlmostEqual(&test, rTM, 0.9922538321352606);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9890086448715819);
    AssertAlmostEqual(&test, rTM, 0.9944890956778178);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9244827291610888);
    AssertAlmostEqual(&test, rTM, 0.9992220807015035);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4663051453488002);
    AssertAlmostEqual(&test, rTM, 0.9999161025242885);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0158577979593954);
    AssertAlmostEqual(&test, rTM, 0.9999684787096023);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636761571735556);
    AssertAlmostEqual(&test, rTM, 0.9999694528073518);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9248445355485698);
    AssertAlmostEqual(&test, rTM, 0.9248445355485698);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9248445355485698);
    AssertAlmostEqual(&test, rTM, 0.9248445355485698);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9248445355485695);
    AssertAlmostEqual(&test, rTM, 0.9248445355485702);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9248445355485337);
    AssertAlmostEqual(&test, rTM, 0.9248445355486059);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9248445355449588);
    AssertAlmostEqual(&test, rTM, 0.9248445355521809);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9248445351874647);
    AssertAlmostEqual(&test, rTM, 0.924844535909675);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9248444994380681);
    AssertAlmostEqual(&test, rTM, 0.9248445716590549);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9248409245948849);
    AssertAlmostEqual(&test, rTM, 0.924848146335543);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9244844002196141);
    AssertAlmostEqual(&test, rTM, 0.9252030201373301);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8954186459897242);
    AssertAlmostEqual(&test, rTM, 0.94622580424431);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4646405783465142);
    AssertAlmostEqual(&test, rTM, 0.9916931217592945);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585698482176891);
    AssertAlmostEqual(&test, rTM, 0.9968576737219106);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636835325256916);
    AssertAlmostEqual(&test, rTM, 0.9969546291904331);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4663307165800207);
    AssertAlmostEqual(&test, rTM, 0.4663307165800207);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4663307165800207);
    AssertAlmostEqual(&test, rTM, 0.4663307165800207);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4663307165800207);
    AssertAlmostEqual(&test, rTM, 0.4663307165800207);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.466330716580019);
    AssertAlmostEqual(&test, rTM, 0.4663307165800224);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.466330716579851);
    AssertAlmostEqual(&test, rTM, 0.4663307165801904);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4663307165630486);
    AssertAlmostEqual(&test, rTM, 0.4663307165969928);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4663307148828157);
    AssertAlmostEqual(&test, rTM, 0.4663307182772257);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4663305468596017);
    AssertAlmostEqual(&test, rTM, 0.4663308863004054);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4663137453195341);
    AssertAlmostEqual(&test, rTM, 0.4663476874972346);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4646413607083363);
    AssertAlmostEqual(&test, rTM, 0.4680166778516078);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3480137826144526);
    AssertAlmostEqual(&test, rTM, 0.5700251327901549);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01570643170365166);
    AssertAlmostEqual(&test, rTM, 0.7595008308331103);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636680884766755);
    AssertAlmostEqual(&test, rTM, 0.7660011651248743);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585859886139091);
    AssertAlmostEqual(&test, rTM, 0.01585859886139091);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585859886139091);
    AssertAlmostEqual(&test, rTM, 0.01585859886139091);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585859886139091);
    AssertAlmostEqual(&test, rTM, 0.01585859886139091);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0158585988613909);
    AssertAlmostEqual(&test, rTM, 0.01585859886139091);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585859886139075);
    AssertAlmostEqual(&test, rTM, 0.01585859886139106);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585859886137554);
    AssertAlmostEqual(&test, rTM, 0.01585859886140627);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585859885985456);
    AssertAlmostEqual(&test, rTM, 0.01585859886292725);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0158585987077563);
    AssertAlmostEqual(&test, rTM, 0.01585859901502551);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585858349794505);
    AssertAlmostEqual(&test, rTM, 0.01585861422483675);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585706266417749);
    AssertAlmostEqual(&test, rTM, 0.01586013505852946);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01570643871515853);
    AssertAlmostEqual(&test, rTM, 0.01601075827310302);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.008055537586807934);
    AssertAlmostEqual(&test, rTM, 0.02365972893895203);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001620644116518826);
    AssertAlmostEqual(&test, rTM, 0.03154732071476479);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636845328438441);
    AssertAlmostEqual(&test, rTM, 0.0001636845328438441);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636845328438441);
    AssertAlmostEqual(&test, rTM, 0.0001636845328438441);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636845328438441);
    AssertAlmostEqual(&test, rTM, 0.0001636845328438441);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636845328438441);
    AssertAlmostEqual(&test, rTM, 0.0001636845328438441);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636845328438441);
    AssertAlmostEqual(&test, rTM, 0.0001636845328438441);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636845328438425);
    AssertAlmostEqual(&test, rTM, 0.0001636845328438457);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636845328436805);
    AssertAlmostEqual(&test, rTM, 0.0001636845328440078);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000163684532827481);
    AssertAlmostEqual(&test, rTM, 0.0001636845328602072);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636845312075346);
    AssertAlmostEqual(&test, rTM, 0.0001636845344801537);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636843692130513);
    AssertAlmostEqual(&test, rTM, 0.0001636846964746369);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636681713838185);
    AssertAlmostEqual(&test, rTM, 0.0001637008943038696);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001620644191150693);
    AssertAlmostEqual(&test, rTM, 0.0001653046465717597);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.185566328317079e-05);
    AssertAlmostEqual(&test, rTM, 0.000245513400212466);

    userdata[0] = 50/CAPS_HBAR_EV; /* 50eV */
    userdata[1] = 0.0001/CAPS_HBAR_EV; /* 0.0001eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999749958686);
    AssertAlmostEqual(&test, rTM, 0.9999999874979342);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999998223122744);
    AssertAlmostEqual(&test, rTM, 0.9999999982407154);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999998231854053);
    AssertAlmostEqual(&test, rTM, 0.999999999823203);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999823195563665);
    AssertAlmostEqual(&test, rTM, 0.9999999999823194);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998232097176474);
    AssertAlmostEqual(&test, rTM, 0.999999999998232);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9982335032161127);
    AssertAlmostEqual(&test, rTM, 0.9999999999998231);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9824750196935174);
    AssertAlmostEqual(&test, rTM, 0.9999999999999823);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8381347223009239);
    AssertAlmostEqual(&test, rTM, 0.9999999999999982);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2031322693214775);
    AssertAlmostEqual(&test, rTM, 0.9999999999999998);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.003178638301479977);
    AssertAlmostEqual(&test, rTM, 0.9999999999999999);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.198737894471447e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999999999);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.198940496127948e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999999999);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.198942522306523e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999999999999);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999438052642);
    AssertAlmostEqual(&test, rTM, 0.9999999443616477);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999209230448);
    AssertAlmostEqual(&test, rTM, 0.9999999604615216);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999999438052785);
    AssertAlmostEqual(&test, rTM, 0.9999999944361646);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999944081507122);
    AssertAlmostEqual(&test, rTM, 0.9999999994408694);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999440856818135);
    AssertAlmostEqual(&test, rTM, 0.9999999999440842);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994409977694896);
    AssertAlmostEqual(&test, rTM, 0.9999999999944084);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9944240257099689);
    AssertAlmostEqual(&test, rTM, 0.9999999999994409);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9456255889129678);
    AssertAlmostEqual(&test, rTM, 0.999999999999944);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5757285262575358);
    AssertAlmostEqual(&test, rTM, 0.9999999999999942);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03008809315322166);
    AssertAlmostEqual(&test, rTM, 0.9999999999999983);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003196335870951688);
    AssertAlmostEqual(&test, rTM, 0.9999999999999984);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.198359704528606e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999999984);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.198379959043661e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999999984);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999994354606783);
    AssertAlmostEqual(&test, rTM, 0.9999994354612428);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999994354327343);
    AssertAlmostEqual(&test, rTM, 0.9999994354891854);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999994326452878);
    AssertAlmostEqual(&test, rTM, 0.9999994382626596);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999992016213273);
    AssertAlmostEqual(&test, rTM, 0.9999996008105839);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999943264673633);
    AssertAlmostEqual(&test, rTM, 0.9999999438262518);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999943544851153);
    AssertAlmostEqual(&test, rTM, 0.9999999943548903);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994356198488439);
    AssertAlmostEqual(&test, rTM, 0.999999999435461);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.994370520719086);
    AssertAlmostEqual(&test, rTM, 0.9999999999435458);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.94511711698103);
    AssertAlmostEqual(&test, rTM, 0.9999999999943524);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5727538834961188);
    AssertAlmostEqual(&test, rTM, 0.9999999999994134);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02955004094300236);
    AssertAlmostEqual(&test, rTM, 0.9999999999998309);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003135735232343372);
    AssertAlmostEqual(&test, rTM, 0.9999999999998406);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.137683034612468e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999998407);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999980669464463);
    AssertAlmostEqual(&test, rTM, 0.9999980669464656);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999980669454894);
    AssertAlmostEqual(&test, rTM, 0.9999980669474224);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999980668498057);
    AssertAlmostEqual(&test, rTM, 0.9999980670431012);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999980573052407);
    AssertAlmostEqual(&test, rTM, 0.9999980765398238);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999972662505556);
    AssertAlmostEqual(&test, rTM, 0.9999986331243437);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999805732222392);
    AssertAlmostEqual(&test, rTM, 0.9999998076538159);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998067034782055);
    AssertAlmostEqual(&test, rTM, 0.9999999806704124);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9980688110716422);
    AssertAlmostEqual(&test, rTM, 0.9999999980669446);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9808553780568157);
    AssertAlmostEqual(&test, rTM, 0.9999999998066854);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8244771669809144);
    AssertAlmostEqual(&test, rTM, 0.9999999999805793);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1799615787867777);
    AssertAlmostEqual(&test, rTM, 0.9999999999973116);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002661927294539403);
    AssertAlmostEqual(&test, rTM, 0.9999999999981217);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.676012569383426e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999981315);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999903910478817);
    AssertAlmostEqual(&test, rTM, 0.9999903910478827);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999903910478342);
    AssertAlmostEqual(&test, rTM, 0.9999903910479302);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999903910430777);
    AssertAlmostEqual(&test, rTM, 0.9999903910526866);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999903905674489);
    AssertAlmostEqual(&test, rTM, 0.9999903915282914);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999903431228681);
    AssertAlmostEqual(&test, rTM, 0.9999904387350559);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999864109166383);
    AssertAlmostEqual(&test, rTM, 0.999993205435236);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999034354250971);
    AssertAlmostEqual(&test, rTM, 0.9999990438693906);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9990395137272818);
    AssertAlmostEqual(&test, rTM, 0.9999999039148149);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9904370524787373);
    AssertAlmostEqual(&test, rTM, 0.9999999903908957);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9084158197778941);
    AssertAlmostEqual(&test, rTM, 0.9999999990379917);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3956143581328226);
    AssertAlmostEqual(&test, rTM, 0.9999999998933951);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0106019527910377);
    AssertAlmostEqual(&test, rTM, 0.9999999999528442);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001082803652635784);
    AssertAlmostEqual(&test, rTM, 0.9999999999538236);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999198788686747);
    AssertAlmostEqual(&test, rTM, 0.9999198788686748);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999198788686707);
    AssertAlmostEqual(&test, rTM, 0.9999198788686787);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999198788682742);
    AssertAlmostEqual(&test, rTM, 0.9999198788690754);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999198788286158);
    AssertAlmostEqual(&test, rTM, 0.9999198789087337);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999198748628788);
    AssertAlmostEqual(&test, rTM, 0.9999198828742705);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999194792756448);
    AssertAlmostEqual(&test, rTM, 0.999920276478759);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998866934897044);
    AssertAlmostEqual(&test, rTM, 0.9999433451399201);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991950844767474);
    AssertAlmostEqual(&test, rTM, 0.9999920273612131);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9920192037186747);
    AssertAlmostEqual(&test, rTM, 0.9999991987905391);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9230213037590002);
    AssertAlmostEqual(&test, rTM, 0.9999999198114291);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4578448083527941);
    AssertAlmostEqual(&test, rTM, 0.9999999913684932);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01510939401496906);
    AssertAlmostEqual(&test, rTM, 0.9999999966915559);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001557169153160022);
    AssertAlmostEqual(&test, rTM, 0.9999999967890452);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999216816435858);
    AssertAlmostEqual(&test, rTM, 0.999216816435858);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9992168164358577);
    AssertAlmostEqual(&test, rTM, 0.9992168164358585);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9992168164358189);
    AssertAlmostEqual(&test, rTM, 0.9992168164358972);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9992168164319437);
    AssertAlmostEqual(&test, rTM, 0.9992168164397724);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9992168160444198);
    AssertAlmostEqual(&test, rTM, 0.9992168168272961);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9992167772929996);
    AssertAlmostEqual(&test, rTM, 0.9992168555767611);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9992129117970432);
    AssertAlmostEqual(&test, rTM, 0.999220701711835);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9988925908913699);
    AssertAlmostEqual(&test, rTM, 0.9994461420238927);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9921569573703314);
    AssertAlmostEqual(&test, rTM, 0.9999220422347378);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9246565277236747);
    AssertAlmostEqual(&test, rTM, 0.9999921595094428);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4654639969120216);
    AssertAlmostEqual(&test, rTM, 0.9999991585363855);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01578035112921925);
    AssertAlmostEqual(&test, rTM, 0.9999996832292734);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001628512672554727);
    AssertAlmostEqual(&test, rTM, 0.9999996929714815);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9922135628908861);
    AssertAlmostEqual(&test, rTM, 0.9922135628908861);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9922135628908861);
    AssertAlmostEqual(&test, rTM, 0.9922135628908862);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9922135628908824);
    AssertAlmostEqual(&test, rTM, 0.99221356289089);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9922135628904983);
    AssertAlmostEqual(&test, rTM, 0.9922135628912739);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9922135628521062);
    AssertAlmostEqual(&test, rTM, 0.9922135629296662);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.992213559012885);
    AssertAlmostEqual(&test, rTM, 0.9922135667688855);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9922131751004404);
    AssertAlmostEqual(&test, rTM, 0.9922139506620953);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9921748800931141);
    AssertAlmostEqual(&test, rTM, 0.9922520552073317);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9890061276625164);
    AssertAlmostEqual(&test, rTM, 0.9944878300691093);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9244660208615183);
    AssertAlmostEqual(&test, rTM, 0.9992219013537522);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4662269823842481);
    AssertAlmostEqual(&test, rTM, 0.9999160806446602);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585072454348022);
    AssertAlmostEqual(&test, rTM, 0.9999684646365354);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636008218770335);
    AssertAlmostEqual(&test, rTM, 0.9999694387413369);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9248428721227684);
    AssertAlmostEqual(&test, rTM, 0.9248428721227684);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9248428721227684);
    AssertAlmostEqual(&test, rTM, 0.9248428721227684);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9248428721227681);
    AssertAlmostEqual(&test, rTM, 0.9248428721227687);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9248428721227323);
    AssertAlmostEqual(&test, rTM, 0.9248428721228045);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9248428721191573);
    AssertAlmostEqual(&test, rTM, 0.9248428721263795);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9248428717616556);
    AssertAlmostEqual(&test, rTM, 0.9248428724838812);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9248428360115012);
    AssertAlmostEqual(&test, rTM, 0.9248429082340189);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9248392610925361);
    AssertAlmostEqual(&test, rTM, 0.9248464829862857);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9244827291610888);
    AssertAlmostEqual(&test, rTM, 0.9252013643123451);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8954163701332467);
    AssertAlmostEqual(&test, rTM, 0.9462245990000647);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4646327549130935);
    AssertAlmostEqual(&test, rTM, 0.9916929063497899);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585627719857116);
    AssertAlmostEqual(&test, rTM, 0.9968575338585544);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636759951873572);
    AssertAlmostEqual(&test, rTM, 0.9969544893771103);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4663299347532068);
    AssertAlmostEqual(&test, rTM, 0.4663299347532068);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4663299347532068);
    AssertAlmostEqual(&test, rTM, 0.4663299347532068);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4663299347532068);
    AssertAlmostEqual(&test, rTM, 0.4663299347532068);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4663299347532051);
    AssertAlmostEqual(&test, rTM, 0.4663299347532085);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4663299347530371);
    AssertAlmostEqual(&test, rTM, 0.4663299347533765);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4663299347362347);
    AssertAlmostEqual(&test, rTM, 0.4663299347701789);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4663299330560013);
    AssertAlmostEqual(&test, rTM, 0.4663299364504123);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4663297650327332);
    AssertAlmostEqual(&test, rTM, 0.466330104473646);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4663129634872625);
    AssertAlmostEqual(&test, rTM, 0.4663469056758791);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4646405783465142);
    AssertAlmostEqual(&test, rTM, 0.4680158965664907);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3480130072308371);
    AssertAlmostEqual(&test, rTM, 0.57002437944144);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01570636158892745);
    AssertAlmostEqual(&test, rTM, 0.7595000149589196);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636673347792284);
    AssertAlmostEqual(&test, rTM, 0.7660003396996848);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0158585917841129);
    AssertAlmostEqual(&test, rTM, 0.0158585917841129);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0158585917841129);
    AssertAlmostEqual(&test, rTM, 0.0158585917841129);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0158585917841129);
    AssertAlmostEqual(&test, rTM, 0.0158585917841129);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0158585917841129);
    AssertAlmostEqual(&test, rTM, 0.0158585917841129);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585859178411275);
    AssertAlmostEqual(&test, rTM, 0.01585859178411306);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585859178409754);
    AssertAlmostEqual(&test, rTM, 0.01585859178412827);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585859178257656);
    AssertAlmostEqual(&test, rTM, 0.01585859178564925);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585859163047836);
    AssertAlmostEqual(&test, rTM, 0.01585859193774744);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585857642067369);
    AssertAlmostEqual(&test, rTM, 0.01585860714755211);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0158570555875633);
    AssertAlmostEqual(&test, rTM, 0.01586012798058764);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01570643170365166);
    AssertAlmostEqual(&test, rTM, 0.01601075113005484);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.008055533935280031);
    AssertAlmostEqual(&test, rTM, 0.02365971843848147);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001620643370200538);
    AssertAlmostEqual(&test, rTM, 0.03154730664529626);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636845253060745);
    AssertAlmostEqual(&test, rTM, 0.0001636845253060745);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636845253060745);
    AssertAlmostEqual(&test, rTM, 0.0001636845253060745);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636845253060745);
    AssertAlmostEqual(&test, rTM, 0.0001636845253060745);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636845253060745);
    AssertAlmostEqual(&test, rTM, 0.0001636845253060745);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636845253060744);
    AssertAlmostEqual(&test, rTM, 0.0001636845253060745);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636845253060728);
    AssertAlmostEqual(&test, rTM, 0.0001636845253060761);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636845253059108);
    AssertAlmostEqual(&test, rTM, 0.0001636845253062381);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636845252897113);
    AssertAlmostEqual(&test, rTM, 0.0001636845253224375);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000163684523669765);
    AssertAlmostEqual(&test, rTM, 0.0001636845269423839);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636843616752892);
    AssertAlmostEqual(&test, rTM, 0.0001636846889368597);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636681638468021);
    AssertAlmostEqual(&test, rTM, 0.0001637008867653467);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001620644116518827);
    AssertAlmostEqual(&test, rTM, 0.000165304638959407);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.185565951305205e-05);
    AssertAlmostEqual(&test, rTM, 0.0002455133889070457);

    userdata[0] = 50/CAPS_HBAR_EV; /* 50eV */
    userdata[1] = 0.001/CAPS_HBAR_EV; /* 0.001eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999209306911);
    AssertAlmostEqual(&test, rTM, 0.9999999604653448);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999994381071228);
    AssertAlmostEqual(&test, rTM, 0.9999999944367026);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999944086914176);
    AssertAlmostEqual(&test, rTM, 0.9999999994409234);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999440910883276);
    AssertAlmostEqual(&test, rTM, 0.9999999999440896);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994410518074021);
    AssertAlmostEqual(&test, rTM, 0.9999999999944089);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.994424563374559);
    AssertAlmostEqual(&test, rTM, 0.9999999999994409);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9456306997513363);
    AssertAlmostEqual(&test, rTM, 0.999999999999944);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5757585061076333);
    AssertAlmostEqual(&test, rTM, 0.9999999999999942);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0300935727322155);
    AssertAlmostEqual(&test, rTM, 0.9999999999999983);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003196953708308316);
    AssertAlmostEqual(&test, rTM, 0.9999999999999984);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.19897832454129e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999999984);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.198998586892293e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999999984);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.198998789517423e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999999999984);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999998223122744);
    AssertAlmostEqual(&test, rTM, 0.9999998240715586);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999997499587141);
    AssertAlmostEqual(&test, rTM, 0.9999998749793493);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999982231241646);
    AssertAlmostEqual(&test, rTM, 0.9999999824071545);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999823186812148);
    AssertAlmostEqual(&test, rTM, 0.9999999982320293);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998232096301439);
    AssertAlmostEqual(&test, rTM, 0.9999999998231942);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9982335032073762);
    AssertAlmostEqual(&test, rTM, 0.9999999999823194);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9824750196926575);
    AssertAlmostEqual(&test, rTM, 0.9999999999982319);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8381347223008508);
    AssertAlmostEqual(&test, rTM, 0.9999999999998225);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2031322693214762);
    AssertAlmostEqual(&test, rTM, 0.9999999999999764);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.003178638301479977);
    AssertAlmostEqual(&test, rTM, 0.9999999999999842);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.198737894471448e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999999843);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.198940496127948e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999999843);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.198942522306524e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999999999843);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999982302325454);
    AssertAlmostEqual(&test, rTM, 0.9999982302343152);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999982301449443);
    AssertAlmostEqual(&test, rTM, 0.9999982303219119);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999982214066175);
    AssertAlmostEqual(&test, rTM, 0.9999982390164375);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999974971730323);
    AssertAlmostEqual(&test, rTM, 0.9999987485857331);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999822142085272);
    AssertAlmostEqual(&test, rTM, 0.9999998239015042);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998230299990789);
    AssertAlmostEqual(&test, rTM, 0.9999999823032035);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9982317963277176);
    AssertAlmostEqual(&test, rTM, 0.9999999982302321);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9824582296504908);
    AssertAlmostEqual(&test, rTM, 0.9999999998230162);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8379920520007101);
    AssertAlmostEqual(&test, rTM, 0.9999999999822332);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2028723947945384);
    AssertAlmostEqual(&test, rTM, 0.9999999999976368);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.003172540993990196);
    AssertAlmostEqual(&test, rTM, 0.999999999998424);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.192563369589838e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999984338);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.192765189818767e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999984339);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999943546239188);
    AssertAlmostEqual(&test, rTM, 0.9999943546239753);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999943546211244);
    AssertAlmostEqual(&test, rTM, 0.9999943546267698);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999943543416862);
    AssertAlmostEqual(&test, rTM, 0.9999943549061939);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999943264673633);
    AssertAlmostEqual(&test, rTM, 0.999994382640796);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999920162419559);
    AssertAlmostEqual(&test, rTM, 0.9999960081130104);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999432661221221);
    AssertAlmostEqual(&test, rTM, 0.9999994382626594);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994355919206317);
    AssertAlmostEqual(&test, rTM, 0.999999943548902);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9943705179403601);
    AssertAlmostEqual(&test, rTM, 0.9999999943545883);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.945117116717025);
    AssertAlmostEqual(&test, rTM, 0.999999999435236);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5727538834807152);
    AssertAlmostEqual(&test, rTM, 0.9999999999413401);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02955004094297478);
    AssertAlmostEqual(&test, rTM, 0.9999999999830943);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003135735232343342);
    AssertAlmostEqual(&test, rTM, 0.9999999999840548);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.137683034612467e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999840646);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999806696327093);
    AssertAlmostEqual(&test, rTM, 0.9999806696327111);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999806696326136);
    AssertAlmostEqual(&test, rTM, 0.9999806696328069);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999806696230451);
    AssertAlmostEqual(&test, rTM, 0.9999806696423753);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999806686662254);
    AssertAlmostEqual(&test, rTM, 0.9999806705991467);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999805732222392);
    AssertAlmostEqual(&test, rTM, 0.9999807655647236);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999726628418574);
    AssertAlmostEqual(&test, rTM, 0.9999863313275117);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998057492048008);
    AssertAlmostEqual(&test, rTM, 0.9999980765398149);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9980687155726481);
    AssertAlmostEqual(&test, rTM, 0.9999998067040518);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9808553686718199);
    AssertAlmostEqual(&test, rTM, 0.9999999806685529);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8244771661956625);
    AssertAlmostEqual(&test, rTM, 0.9999999980579365);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1799615787743959);
    AssertAlmostEqual(&test, rTM, 0.999999999731161);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002661927294536782);
    AssertAlmostEqual(&test, rTM, 0.9999999998121675);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.6760125693834e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999998131548);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.99990391463369);
    AssertAlmostEqual(&test, rTM, 0.9999039146336901);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999039146336852);
    AssertAlmostEqual(&test, rTM, 0.9999039146336949);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999039146332096);
    AssertAlmostEqual(&test, rTM, 0.9999039146341705);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999039145856496);
    AssertAlmostEqual(&test, rTM, 0.9999039146817303);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999039098297726);
    AssertAlmostEqual(&test, rTM, 0.9999039194373672);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999034354250971);
    AssertAlmostEqual(&test, rTM, 0.9999043914642899);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998641174760285);
    AssertAlmostEqual(&test, rTM, 0.9999320564297715);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9990347737923193);
    AssertAlmostEqual(&test, rTM, 0.9999904387339632);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9904365813993382);
    AssertAlmostEqual(&test, rTM, 0.999999039137586);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9084157766193073);
    AssertAlmostEqual(&test, rTM, 0.9999999037992306);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.395614356436705);
    AssertAlmostEqual(&test, rTM, 0.9999999893395013);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01060195279001013);
    AssertAlmostEqual(&test, rTM, 0.9999999952844179);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001082803652634713);
    AssertAlmostEqual(&test, rTM, 0.9999999953823577);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991990775190444);
    AssertAlmostEqual(&test, rTM, 0.9991990775190444);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991990775190439);
    AssertAlmostEqual(&test, rTM, 0.9991990775190447);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991990775190043);
    AssertAlmostEqual(&test, rTM, 0.9991990775190843);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991990775150413);
    AssertAlmostEqual(&test, rTM, 0.9991990775230473);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991990771187436);
    AssertAlmostEqual(&test, rTM, 0.9991990779193448);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991990374899651);
    AssertAlmostEqual(&test, rTM, 0.9991991175461238);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991950844767474);
    AssertAlmostEqual(&test, rTM, 0.9992030507604673);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9988675125089027);
    AssertAlmostEqual(&test, rTM, 0.9994335958021791);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9919799586458241);
    AssertAlmostEqual(&test, rTM, 0.999920275845349);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9230176459475516);
    AssertAlmostEqual(&test, rTM, 0.9999919815722732);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4578446397884914);
    AssertAlmostEqual(&test, rTM, 0.9999991368501903);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01510939386983899);
    AssertAlmostEqual(&test, rTM, 0.9999996691556992);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000155716915300591);
    AssertAlmostEqual(&test, rTM, 0.9999996789046159);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9921957284177018);
    AssertAlmostEqual(&test, rTM, 0.9921957284177018);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9921957284177017);
    AssertAlmostEqual(&test, rTM, 0.9921957284177018);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9921957284176979);
    AssertAlmostEqual(&test, rTM, 0.9921957284177056);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9921957284173131);
    AssertAlmostEqual(&test, rTM, 0.9921957284180905);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9921957283788332);
    AssertAlmostEqual(&test, rTM, 0.9921957284565702);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9921957245308533);
    AssertAlmostEqual(&test, rTM, 0.9921957323045483);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9921953397425468);
    AssertAlmostEqual(&test, rTM, 0.9921961170735762);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9921569573703314);
    AssertAlmostEqual(&test, rTM, 0.9922343085526245);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9889809877266904);
    AssertAlmostEqual(&test, rTM, 0.9944751900598111);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.924299165850729);
    AssertAlmostEqual(&test, rTM, 0.9992201101336295);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4654471894304451);
    AssertAlmostEqual(&test, rTM, 0.9999158620320534);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01578033599208512);
    AssertAlmostEqual(&test, rTM, 0.9999683239062355);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001628512656437702);
    AssertAlmostEqual(&test, rTM, 0.999969298081209);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9248262401391451);
    AssertAlmostEqual(&test, rTM, 0.9248262401391451);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9248262401391451);
    AssertAlmostEqual(&test, rTM, 0.9248262401391451);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9248262401391447);
    AssertAlmostEqual(&test, rTM, 0.9248262401391455);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.924826240139109);
    AssertAlmostEqual(&test, rTM, 0.9248262401391812);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9248262401355332);
    AssertAlmostEqual(&test, rTM, 0.9248262401427569);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9248262397779557);
    AssertAlmostEqual(&test, rTM, 0.9248262405003344);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9248262040202241);
    AssertAlmostEqual(&test, rTM, 0.9248262762580494);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9248226283435526);
    AssertAlmostEqual(&test, rTM, 0.9248298517679904);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9244660208615183);
    AssertAlmostEqual(&test, rTM, 0.9251848083256504);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8953936147776036);
    AssertAlmostEqual(&test, rTM, 0.946212548166127);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4645545390535453);
    AssertAlmostEqual(&test, rTM, 0.9916907524400942);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01584920443948779);
    AssertAlmostEqual(&test, rTM, 0.9968561352274953);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636006599653682);
    AssertAlmostEqual(&test, rTM, 0.9969530912460389);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4663221166693163);
    AssertAlmostEqual(&test, rTM, 0.4663221166693163);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4663221166693163);
    AssertAlmostEqual(&test, rTM, 0.4663221166693163);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4663221166693163);
    AssertAlmostEqual(&test, rTM, 0.4663221166693163);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4663221166693146);
    AssertAlmostEqual(&test, rTM, 0.466322116669318);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4663221166691466);
    AssertAlmostEqual(&test, rTM, 0.466322116669486);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4663221166523442);
    AssertAlmostEqual(&test, rTM, 0.4663221166862884);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4663221149721053);
    AssertAlmostEqual(&test, rTM, 0.4663221183665273);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4663219469482969);
    AssertAlmostEqual(&test, rTM, 0.4663222863903014);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4663051453488002);
    AssertAlmostEqual(&test, rTM, 0.466339087646567);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4646327549130935);
    AssertAlmostEqual(&test, rTM, 0.4680080838990162);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3480052536108961);
    AssertAlmostEqual(&test, rTM, 0.5700168461024127);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01570566047612208);
    AssertAlmostEqual(&test, rTM, 0.7594918563136165);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636597981865275);
    AssertAlmostEqual(&test, rTM, 0.7659920855456303);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585852101168037);
    AssertAlmostEqual(&test, rTM, 0.01585852101168037);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585852101168037);
    AssertAlmostEqual(&test, rTM, 0.01585852101168037);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585852101168037);
    AssertAlmostEqual(&test, rTM, 0.01585852101168037);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585852101168037);
    AssertAlmostEqual(&test, rTM, 0.01585852101168038);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585852101168022);
    AssertAlmostEqual(&test, rTM, 0.01585852101168053);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585852101166501);
    AssertAlmostEqual(&test, rTM, 0.01585852101169574);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585852101014404);
    AssertAlmostEqual(&test, rTM, 0.01585852101321671);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0158585208580465);
    AssertAlmostEqual(&test, rTM, 0.01585852116531425);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585850564830754);
    AssertAlmostEqual(&test, rTM, 0.0158585363750532);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585698482176891);
    AssertAlmostEqual(&test, rTM, 0.01586005720151697);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01570636158892746);
    AssertAlmostEqual(&test, rTM, 0.01601067969992361);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.008055497420183097);
    AssertAlmostEqual(&test, rTM, 0.02365961343428855);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001620635907055461);
    AssertAlmostEqual(&test, rTM, 0.03154716595130123);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636844499284159);
    AssertAlmostEqual(&test, rTM, 0.0001636844499284159);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636844499284159);
    AssertAlmostEqual(&test, rTM, 0.0001636844499284159);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636844499284159);
    AssertAlmostEqual(&test, rTM, 0.0001636844499284159);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636844499284159);
    AssertAlmostEqual(&test, rTM, 0.0001636844499284159);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636844499284159);
    AssertAlmostEqual(&test, rTM, 0.0001636844499284159);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636844499284142);
    AssertAlmostEqual(&test, rTM, 0.0001636844499284175);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636844499282522);
    AssertAlmostEqual(&test, rTM, 0.0001636844499285795);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636844499120528);
    AssertAlmostEqual(&test, rTM, 0.000163684449944779);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636844482921071);
    AssertAlmostEqual(&test, rTM, 0.0001636844515647246);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636842862977059);
    AssertAlmostEqual(&test, rTM, 0.0001636846135591258);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636680884766756);
    AssertAlmostEqual(&test, rTM, 0.0001637008113801561);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001620643370200538);
    AssertAlmostEqual(&test, rTM, 0.0001653045628359186);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.185562181188385e-05);
    AssertAlmostEqual(&test, rTM, 0.0002455132758528998);

    userdata[0] = 50/CAPS_HBAR_EV; /* 50eV */
    userdata[1] = 0.003/CAPS_HBAR_EV; /* 0.003eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999998630480329);
    AssertAlmostEqual(&test, rTM, 0.9999999315240141);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999990267738221);
    AssertAlmostEqual(&test, rTM, 0.9999999903640926);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999903155955812);
    AssertAlmostEqual(&test, rTM, 0.9999999990316517);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999031649691645);
    AssertAlmostEqual(&test, rTM, 0.9999999999031604);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9990320720650626);
    AssertAlmostEqual(&test, rTM, 0.9999999999903161);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9903628089637092);
    AssertAlmostEqual(&test, rTM, 0.9999999999990316);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9077358367963199);
    AssertAlmostEqual(&test, rTM, 0.9999999999999031);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3929519797533362);
    AssertAlmostEqual(&test, rTM, 0.9999999999999892);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01044181648912094);
    AssertAlmostEqual(&test, rTM, 0.9999999999999952);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001066106966237186);
    AssertAlmostEqual(&test, rTM, 0.9999999999999953);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.066332045274953e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999999953);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.066334296665274e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999999953);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.066334319179238e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999999999953);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999996922378557);
    AssertAlmostEqual(&test, rTM, 0.9999996952850051);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999995669186489);
    AssertAlmostEqual(&test, rTM, 0.999999783459301);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999969223828186);
    AssertAlmostEqual(&test, rTM, 0.9999999695284963);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999693754551549);
    AssertAlmostEqual(&test, rTM, 0.9999999969378048);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996938119067094);
    AssertAlmostEqual(&test, rTM, 0.9999999996937653);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9969423371182083);
    AssertAlmostEqual(&test, rTM, 0.9999999999693765);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9698418265733565);
    AssertAlmostEqual(&test, rTM, 0.9999999999969373);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7370860267983762);
    AssertAlmostEqual(&test, rTM, 0.9999999999996902);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.08857868070875471);
    AssertAlmostEqual(&test, rTM, 0.999999999999944);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001064060002676456);
    AssertAlmostEqual(&test, rTM, 0.999999999999953);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.066305328946609e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999999531);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.066327842040375e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999999531);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.066328067177313e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999999999531);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999969366678642);
    AssertAlmostEqual(&test, rTM, 0.9999969366709275);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999969365162333);
    AssertAlmostEqual(&test, rTM, 0.9999969368225506);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999969213908677);
    AssertAlmostEqual(&test, rTM, 0.9999969518720998);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999995667799062);
    AssertAlmostEqual(&test, rTM, 0.999997833897185);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999692143351772);
    AssertAlmostEqual(&test, rTM, 0.9999996951867919);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996936980753028);
    AssertAlmostEqual(&test, rTM, 0.9999999693681787);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9969413515951139);
    AssertAlmostEqual(&test, rTM, 0.9999999969366626);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9698322549561235);
    AssertAlmostEqual(&test, rTM, 0.9999999996936305);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.737014116015315);
    AssertAlmostEqual(&test, rTM, 0.9999999999690093);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.08853089164207716);
    AssertAlmostEqual(&test, rTM, 0.9999999999943965);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.00106337587245613);
    AssertAlmostEqual(&test, rTM, 0.999999999995298);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.065618310154068e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999953079);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.065640794246652e-07);
    AssertAlmostEqual(&test, rTM, 0.999999999995308);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999902846012211);
    AssertAlmostEqual(&test, rTM, 0.9999902846013182);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999902845964119);
    AssertAlmostEqual(&test, rTM, 0.9999902846061273);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999902841155142);
    AssertAlmostEqual(&test, rTM, 0.9999902850870008);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999902361453515);
    AssertAlmostEqual(&test, rTM, 0.9999903328167125);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999862603789976);
    AssertAlmostEqual(&test, rTM, 0.9999931301659014);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999023657434212);
    AssertAlmostEqual(&test, rTM, 0.9999990332774646);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9990288787134606);
    AssertAlmostEqual(&test, rTM, 0.9999999028503913);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9903316295795606);
    AssertAlmostEqual(&test, rTM, 0.9999999902844443);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9074504723453435);
    AssertAlmostEqual(&test, rTM, 0.9999999990273097);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3918405751486475);
    AssertAlmostEqual(&test, rTM, 0.9999999998919891);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01037564892971561);
    AssertAlmostEqual(&test, rTM, 0.9999999999518154);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001059211080794791);
    AssertAlmostEqual(&test, rTM, 0.9999999999527951);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.059433257272113e-06);
    AssertAlmostEqual(&test, rTM, 0.999999999952805);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999683956784179);
    AssertAlmostEqual(&test, rTM, 0.9999683956784211);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999683956782615);
    AssertAlmostEqual(&test, rTM, 0.9999683956785775);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999683956626176);
    AssertAlmostEqual(&test, rTM, 0.9999683956942214);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999683940982679);
    AssertAlmostEqual(&test, rTM, 0.9999683972584921);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999968238052406);
    AssertAlmostEqual(&test, rTM, 0.9999685525221899);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999553050323464);
    AssertAlmostEqual(&test, rTM, 0.9999776522664598);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996824259184952);
    AssertAlmostEqual(&test, rTM, 0.9999968552076767);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9968443507552358);
    AssertAlmostEqual(&test, rTM, 0.9999996839672465);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9688906501664816);
    AssertAlmostEqual(&test, rTM, 0.9999999683912494);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7299732391336495);
    AssertAlmostEqual(&test, rTM, 0.9999999968003001);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.08400081574831304);
    AssertAlmostEqual(&test, rTM, 0.9999999994089678);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0009991370334859063);
    AssertAlmostEqual(&test, rTM, 0.9999999994995686);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.001116534354143e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999995005576);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999875568083562);
    AssertAlmostEqual(&test, rTM, 0.9998755680835621);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998755680835559);
    AssertAlmostEqual(&test, rTM, 0.9998755680835684);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.99987556808294);
    AssertAlmostEqual(&test, rTM, 0.9998755680841842);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.99987556802135);
    AssertAlmostEqual(&test, rTM, 0.9998755681457742);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998755618625089);
    AssertAlmostEqual(&test, rTM, 0.9998755743043043);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998749475104571);
    AssertAlmostEqual(&test, rTM, 0.9998761855772631);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998240312313593);
    AssertAlmostEqual(&test, rTM, 0.9999120117445428);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9987501786661654);
    AssertAlmostEqual(&test, rTM, 0.9999876178654409);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9876326049162913);
    AssertAlmostEqual(&test, rTM, 0.9999987556423179);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8830622612937662);
    AssertAlmostEqual(&test, rTM, 0.9999998753197722);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3086545149673364);
    AssertAlmostEqual(&test, rTM, 0.9999999853439311);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.006375684214289511);
    AssertAlmostEqual(&test, rTM, 0.9999999921580233);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.456933157647176e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999922563858);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991610009768893);
    AssertAlmostEqual(&test, rTM, 0.9991610009768893);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991610009768889);
    AssertAlmostEqual(&test, rTM, 0.9991610009768898);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991610009768473);
    AssertAlmostEqual(&test, rTM, 0.9991610009769312);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999161000972696);
    AssertAlmostEqual(&test, rTM, 0.9991610009810825);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999161000557566);
    AssertAlmostEqual(&test, rTM, 0.9991610013962124);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991609590455927);
    AssertAlmostEqual(&test, rTM, 0.9991610429060913);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991568181820641);
    AssertAlmostEqual(&test, rTM, 0.9991651630306762);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9988136824444971);
    AssertAlmostEqual(&test, rTM, 0.9994066651469198);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.991600127542975);
    AssertAlmostEqual(&test, rTM, 0.9999164841930486);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9195096923615729);
    AssertAlmostEqual(&test, rTM, 0.9999915995556);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4419835609199975);
    AssertAlmostEqual(&test, rTM, 0.9999990897294714);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01380505384813242);
    AssertAlmostEqual(&test, rTM, 0.9999996378829578);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001419022561743219);
    AssertAlmostEqual(&test, rTM, 0.9999996476449161);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9921562431441568);
    AssertAlmostEqual(&test, rTM, 0.9921562431441568);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9921562431441568);
    AssertAlmostEqual(&test, rTM, 0.992156243144157);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.992156243144153);
    AssertAlmostEqual(&test, rTM, 0.9921562431441607);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9921562431437663);
    AssertAlmostEqual(&test, rTM, 0.9921562431445475);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9921562431050925);
    AssertAlmostEqual(&test, rTM, 0.9921562431832213);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9921562392377211);
    AssertAlmostEqual(&test, rTM, 0.9921562470505907);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9921558525103258);
    AssertAlmostEqual(&test, rTM, 0.9921566337586112);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9921172767191527);
    AssertAlmostEqual(&test, rTM, 0.9921950177023019);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9889253289303815);
    AssertAlmostEqual(&test, rTM, 0.9944472050165467);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9239298497570086);
    AssertAlmostEqual(&test, rTM, 0.9992161442275752);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4637261696803843);
    AssertAlmostEqual(&test, rTM, 0.9999153774116525);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01562613385398764);
    AssertAlmostEqual(&test, rTM, 0.999968011174594);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001612099277045183);
    AssertAlmostEqual(&test, rTM, 0.9999689855032889);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9247892949694444);
    AssertAlmostEqual(&test, rTM, 0.9247892949694444);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9247892949694444);
    AssertAlmostEqual(&test, rTM, 0.9247892949694444);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9247892949694441);
    AssertAlmostEqual(&test, rTM, 0.9247892949694447);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9247892949694082);
    AssertAlmostEqual(&test, rTM, 0.9247892949694805);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9247892949658308);
    AssertAlmostEqual(&test, rTM, 0.924789294973058);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9247892946080851);
    AssertAlmostEqual(&test, rTM, 0.9247892953308037);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9247892588335223);
    AssertAlmostEqual(&test, rTM, 0.9247893311053499);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9247856814737876);
    AssertAlmostEqual(&test, rTM, 0.9247929082982824);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9244289061742692);
    AssertAlmostEqual(&test, rTM, 0.9251480319649249);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8953430681945774);
    AssertAlmostEqual(&test, rTM, 0.9461857789978304);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4643808461896428);
    AssertAlmostEqual(&test, rTM, 0.9916859671796187);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01583350977053832);
    AssertAlmostEqual(&test, rTM, 0.9968530271747694);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001634334963943454);
    AssertAlmostEqual(&test, rTM, 0.9969499843021428);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4663047443488285);
    AssertAlmostEqual(&test, rTM, 0.4663047443488285);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4663047443488285);
    AssertAlmostEqual(&test, rTM, 0.4663047443488285);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4663047443488285);
    AssertAlmostEqual(&test, rTM, 0.4663047443488285);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4663047443488268);
    AssertAlmostEqual(&test, rTM, 0.4663047443488302);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4663047443486588);
    AssertAlmostEqual(&test, rTM, 0.4663047443489982);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4663047443318563);
    AssertAlmostEqual(&test, rTM, 0.4663047443658007);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4663047426516054);
    AssertAlmostEqual(&test, rTM, 0.4663047460460515);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4663045746265965);
    AssertAlmostEqual(&test, rTM, 0.4663049140710261);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4662877729070781);
    AssertAlmostEqual(&test, rTM, 0.4663217154473285);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4646153707083515);
    AssertAlmostEqual(&test, rTM, 0.4679907236114146);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3479880247516823);
    AssertAlmostEqual(&test, rTM, 0.5700001063131444);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01570410267179941);
    AssertAlmostEqual(&test, rTM, 0.7594737266195462);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636430526875203);
    AssertAlmostEqual(&test, rTM, 0.7659737436179315);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585836374187018);
    AssertAlmostEqual(&test, rTM, 0.01585836374187018);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585836374187018);
    AssertAlmostEqual(&test, rTM, 0.01585836374187018);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585836374187018);
    AssertAlmostEqual(&test, rTM, 0.01585836374187018);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585836374187018);
    AssertAlmostEqual(&test, rTM, 0.01585836374187019);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585836374187003);
    AssertAlmostEqual(&test, rTM, 0.01585836374187034);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585836374185482);
    AssertAlmostEqual(&test, rTM, 0.01585836374188555);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585836374033386);
    AssertAlmostEqual(&test, rTM, 0.01585836374340651);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585836358823779);
    AssertAlmostEqual(&test, rTM, 0.01585836389550259);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585834837864488);
    AssertAlmostEqual(&test, rTM, 0.01585837910509548);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585682756670994);
    AssertAlmostEqual(&test, rTM, 0.01585989991695557);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01570620578067097);
    AssertAlmostEqual(&test, rTM, 0.01601052096858112);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.008055416276708513);
    AssertAlmostEqual(&test, rTM, 0.02365938009497492);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001620619322534714);
    AssertAlmostEqual(&test, rTM, 0.03154685330247185);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636842824227564);
    AssertAlmostEqual(&test, rTM, 0.0001636842824227564);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636842824227564);
    AssertAlmostEqual(&test, rTM, 0.0001636842824227564);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636842824227564);
    AssertAlmostEqual(&test, rTM, 0.0001636842824227564);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636842824227564);
    AssertAlmostEqual(&test, rTM, 0.0001636842824227564);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636842824227564);
    AssertAlmostEqual(&test, rTM, 0.0001636842824227564);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636842824227548);
    AssertAlmostEqual(&test, rTM, 0.0001636842824227581);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636842824225928);
    AssertAlmostEqual(&test, rTM, 0.0001636842824229201);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636842824063934);
    AssertAlmostEqual(&test, rTM, 0.0001636842824391195);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636842807864494);
    AssertAlmostEqual(&test, rTM, 0.0001636842840590635);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636841187922139);
    AssertAlmostEqual(&test, rTM, 0.000163684446053299);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636679209877541);
    AssertAlmostEqual(&test, rTM, 0.0001637006438577587);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001620641711717914);
    AssertAlmostEqual(&test, rTM, 0.0001653043936728622);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.18555380316344e-05);
    AssertAlmostEqual(&test, rTM, 0.0002455130246218371);

    userdata[0] = 50/CAPS_HBAR_EV; /* 50eV */
    userdata[1] = 0.035/CAPS_HBAR_EV; /* 0.035eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999995322201952);
    AssertAlmostEqual(&test, rTM, 0.9999997661100702);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999966758046543);
    AssertAlmostEqual(&test, rTM, 0.9999999670871206);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999669218583432);
    AssertAlmostEqual(&test, rTM, 0.9999999966924619);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996692841852414);
    AssertAlmostEqual(&test, rTM, 0.9999999996692298);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9966977624168986);
    AssertAlmostEqual(&test, rTM, 0.9999999999669229);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9674654868286583);
    AssertAlmostEqual(&test, rTM, 0.9999999999966919);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7194410220827709);
    AssertAlmostEqual(&test, rTM, 0.9999999999996647);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.07774138866062592);
    AssertAlmostEqual(&test, rTM, 0.9999999999999361);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0009123344003766438);
    AssertAlmostEqual(&test, rTM, 0.9999999999999452);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -9.139846818339741e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999999453);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -9.140012223433336e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999999453);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -9.140013877522064e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999999999453);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -9.140013894062955e-12);
    AssertAlmostEqual(&test, rTM, 0.9999999999999453);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999989487956733);
    AssertAlmostEqual(&test, rTM, 0.9999989592036315);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.99999852075075);
    AssertAlmostEqual(&test, rTM, 0.9999992603751015);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999894880064593);
    AssertAlmostEqual(&test, rTM, 0.9999998959203144);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998954014461137);
    AssertAlmostEqual(&test, rTM, 0.9999999895406435);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9989545584305453);
    AssertAlmostEqual(&test, rTM, 0.9999999989540125);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9895946819444899);
    AssertAlmostEqual(&test, rTM, 0.9999999998953998);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9007287059737825);
    AssertAlmostEqual(&test, rTM, 0.9999999999895258);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3666431524315321);
    AssertAlmostEqual(&test, rTM, 0.9999999999988196);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.008976652433493265);
    AssertAlmostEqual(&test, rTM, 0.999999999999443);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -9.138338888674621e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999994529);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -9.139992594480289e-07);
    AssertAlmostEqual(&test, rTM, 0.999999999999453);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -9.140009135316584e-09);
    AssertAlmostEqual(&test, rTM, 0.999999999999453);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -9.140009300725326e-11);
    AssertAlmostEqual(&test, rTM, 0.999999999999453);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999895398809674);
    AssertAlmostEqual(&test, rTM, 0.9999895398914274);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999895393632074);
    AssertAlmostEqual(&test, rTM, 0.9999895404091611);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999894877160043);
    AssertAlmostEqual(&test, rTM, 0.9999895917974824);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999985207197243);
    AssertAlmostEqual(&test, rTM, 0.9999926035712678);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998948821328166);
    AssertAlmostEqual(&test, rTM, 0.9999989591748719);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9989544778367094);
    AssertAlmostEqual(&test, rTM, 0.9999998954035357);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9895943908153837);
    AssertAlmostEqual(&test, rTM, 0.9999999895396937);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9007261058099789);
    AssertAlmostEqual(&test, rTM, 0.9999999989525535);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3666337626205961);
    AssertAlmostEqual(&test, rTM, 0.9999999998819558);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.008976165212925706);
    AssertAlmostEqual(&test, rTM, 0.9999999999443014);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -9.137833999696058e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999452824);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -9.139487522761592e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999452923);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -9.13950406176986e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999999452924);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999669142824964);
    AssertAlmostEqual(&test, rTM, 0.9999669142828272);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999669142661193);
    AssertAlmostEqual(&test, rTM, 0.9999669142992045);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999669126284447);
    AssertAlmostEqual(&test, rTM, 0.9999669159367963);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999667492683352);
    AssertAlmostEqual(&test, rTM, 0.9999670784780809);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999532100504436);
    AssertAlmostEqual(&test, rTM, 0.9999766047515498);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996675424329581);
    AssertAlmostEqual(&test, rTM, 0.9999967077989901);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9966966776281875);
    AssertAlmostEqual(&test, rTM, 0.9999996691534971);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9674565426329406);
    AssertAlmostEqual(&test, rTM, 0.9999999669092253);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7193755114966419);
    AssertAlmostEqual(&test, rTM, 0.9999999966464047);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.07770427485582414);
    AssertAlmostEqual(&test, rTM, 0.9999999993604199);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0009118263891542334);
    AssertAlmostEqual(&test, rTM, 0.9999999994516504);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -9.134748320494786e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999994526395);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -9.134913541102235e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999994526494);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998951152013665);
    AssertAlmostEqual(&test, rTM, 0.9998951152013771);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998951152008474);
    AssertAlmostEqual(&test, rTM, 0.9998951152018962);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998951151489321);
    AssertAlmostEqual(&test, rTM, 0.9998951152538115);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998951099575381);
    AssertAlmostEqual(&test, rTM, 0.9998951204449434);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998945921094959);
    AssertAlmostEqual(&test, rTM, 0.9998956356975138);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998516737174932);
    AssertAlmostEqual(&test, rTM, 0.9999258341083548);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9989464209897649);
    AssertAlmostEqual(&test, rTM, 0.9999895630781573);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9895653167193772);
    AssertAlmostEqual(&test, rTM, 0.9999989511355738);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9004664898279234);
    AssertAlmostEqual(&test, rTM, 0.9999998949656077);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3656975781134412);
    AssertAlmostEqual(&test, rTM, 0.9999999881559885);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.00892770882584094);
    AssertAlmostEqual(&test, rTM, 0.9999999943999054);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -9.087625292107215e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999944980127);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -9.089260693008256e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999944990026);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996601808184605);
    AssertAlmostEqual(&test, rTM, 0.9996601808184609);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996601808184438);
    AssertAlmostEqual(&test, rTM, 0.9996601808184777);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996601808167619);
    AssertAlmostEqual(&test, rTM, 0.9996601808201595);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996601806485801);
    AssertAlmostEqual(&test, rTM, 0.9996601809883413);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996601638308139);
    AssertAlmostEqual(&test, rTM, 0.9996601978052585);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996584862386458);
    AssertAlmostEqual(&test, rTM, 0.9996618669912494);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995194569317221);
    AssertAlmostEqual(&test, rTM, 0.999759699590249);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9965901076720459);
    AssertAlmostEqual(&test, rTM, 0.9999661815044885);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9665833385414461);
    AssertAlmostEqual(&test, rTM, 0.999996600915697);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7130083737546984);
    AssertAlmostEqual(&test, rTM, 0.9999996552505648);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.07419809425417916);
    AssertAlmostEqual(&test, rTM, 0.9999999329838198);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0008641829029129008);
    AssertAlmostEqual(&test, rTM, 0.9999999421419243);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.656634778982682e-06);
    AssertAlmostEqual(&test, rTM, 0.999999942240838);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9986951640129217);
    AssertAlmostEqual(&test, rTM, 0.9986951640129217);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.998695164012921);
    AssertAlmostEqual(&test, rTM, 0.9986951640129224);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9986951640128565);
    AssertAlmostEqual(&test, rTM, 0.9986951640129869);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9986951640064018);
    AssertAlmostEqual(&test, rTM, 0.9986951640194416);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9986951633609298);
    AssertAlmostEqual(&test, rTM, 0.9986951646649133);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9986950988153471);
    AssertAlmostEqual(&test, rTM, 0.998695229207241);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9986886603322496);
    AssertAlmostEqual(&test, rTM, 0.9987016354590886);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9981551821875493);
    AssertAlmostEqual(&test, rTM, 0.9990771650852485);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9869638078556993);
    AssertAlmostEqual(&test, rTM, 0.9998700848748099);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.877671628043325);
    AssertAlmostEqual(&test, rTM, 0.9999869160664047);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2931076760847879);
    AssertAlmostEqual(&test, rTM, 0.9999984406995305);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.005797896336966632);
    AssertAlmostEqual(&test, rTM, 0.9999991376479856);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.865028819463851e-05);
    AssertAlmostEqual(&test, rTM, 0.9999991474899999);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9915498225421121);
    AssertAlmostEqual(&test, rTM, 0.9915498225421121);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9915498225421121);
    AssertAlmostEqual(&test, rTM, 0.9915498225421122);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9915498225421079);
    AssertAlmostEqual(&test, rTM, 0.9915498225421163);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9915498225416914);
    AssertAlmostEqual(&test, rTM, 0.9915498225425329);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9915498225000405);
    AssertAlmostEqual(&test, rTM, 0.9915498225841838);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9915498183349516);
    AssertAlmostEqual(&test, rTM, 0.9915498267492706);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9915494018365579);
    AssertAlmostEqual(&test, rTM, 0.9915502432268107);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9915078564724084);
    AssertAlmostEqual(&test, rTM, 0.9915915821015066);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9880706288256497);
    AssertAlmostEqual(&test, rTM, 0.9940173650825808);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9182748744408944);
    AssertAlmostEqual(&test, rTM, 0.9991552055311254);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4382120415493209);
    AssertAlmostEqual(&test, rTM, 0.9999078257140519);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01351340595150167);
    AssertAlmostEqual(&test, rTM, 0.9999630078494124);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001388232761148957);
    AssertAlmostEqual(&test, rTM, 0.9999639842831838);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9242009228437906);
    AssertAlmostEqual(&test, rTM, 0.9242009228437906);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9242009228437906);
    AssertAlmostEqual(&test, rTM, 0.9242009228437906);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9242009228437903);
    AssertAlmostEqual(&test, rTM, 0.924200922843791);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9242009228437542);
    AssertAlmostEqual(&test, rTM, 0.924200922843827);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.92420092284015);
    AssertAlmostEqual(&test, rTM, 0.9242009228474313);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9242009224797249);
    AssertAlmostEqual(&test, rTM, 0.9242009232078565);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9242008864372193);
    AssertAlmostEqual(&test, rTM, 0.9242009592503452);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9241972822839986);
    AssertAlmostEqual(&test, rTM, 0.9242045632356257);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9238378354229477);
    AssertAlmostEqual(&test, rTM, 0.9245623471940999);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8945382038501931);
    AssertAlmostEqual(&test, rTM, 0.9457594176041217);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4616240746686532);
    AssertAlmostEqual(&test, rTM, 0.9916096269140164);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01558655747162134);
    AssertAlmostEqual(&test, rTM, 0.9968033013803909);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001608045906572129);
    AssertAlmostEqual(&test, rTM, 0.9969002758333856);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4660270119600489);
    AssertAlmostEqual(&test, rTM, 0.4660270119600489);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4660270119600489);
    AssertAlmostEqual(&test, rTM, 0.4660270119600489);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4660270119600489);
    AssertAlmostEqual(&test, rTM, 0.4660270119600489);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4660270119600472);
    AssertAlmostEqual(&test, rTM, 0.4660270119600506);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4660270119598792);
    AssertAlmostEqual(&test, rTM, 0.4660270119602187);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4660270119430747);
    AssertAlmostEqual(&test, rTM, 0.4660270119770231);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4660270102626325);
    AssertAlmostEqual(&test, rTM, 0.4660270136574653);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4660268422184833);
    AssertAlmostEqual(&test, rTM, 0.4660271817015803);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.466010038585318);
    AssertAlmostEqual(&test, rTM, 0.4660439849917692);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4643374488441311);
    AssertAlmostEqual(&test, rTM, 0.4677131830755972);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.347712626707824);
    AssertAlmostEqual(&test, rTM, 0.5697324503744117);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01567921977434143);
    AssertAlmostEqual(&test, rTM, 0.7591837694237781);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001633755899815873);
    AssertAlmostEqual(&test, rTM, 0.765680392192346);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585584784917219);
    AssertAlmostEqual(&test, rTM, 0.01585584784917219);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585584784917219);
    AssertAlmostEqual(&test, rTM, 0.01585584784917219);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585584784917219);
    AssertAlmostEqual(&test, rTM, 0.01585584784917219);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585584784917219);
    AssertAlmostEqual(&test, rTM, 0.01585584784917219);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585584784917204);
    AssertAlmostEqual(&test, rTM, 0.01585584784917235);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585584784915683);
    AssertAlmostEqual(&test, rTM, 0.01585584784918755);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585584784763611);
    AssertAlmostEqual(&test, rTM, 0.01585584785070828);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585584769556339);
    AssertAlmostEqual(&test, rTM, 0.01585584800278099);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585583248830692);
    AssertAlmostEqual(&test, rTM, 0.01585586321003746);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585431190999288);
    AssertAlmostEqual(&test, rTM, 0.01585738378827668);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01570371326901528);
    AssertAlmostEqual(&test, rTM, 0.01600798169518309);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.008054118203416429);
    AssertAlmostEqual(&test, rTM, 0.02365564729188245);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001620354016357701);
    AssertAlmostEqual(&test, rTM, 0.03154185176386357);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636816023788302);
    AssertAlmostEqual(&test, rTM, 0.0001636816023788302);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636816023788302);
    AssertAlmostEqual(&test, rTM, 0.0001636816023788302);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636816023788302);
    AssertAlmostEqual(&test, rTM, 0.0001636816023788302);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636816023788302);
    AssertAlmostEqual(&test, rTM, 0.0001636816023788302);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636816023788302);
    AssertAlmostEqual(&test, rTM, 0.0001636816023788302);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636816023788285);
    AssertAlmostEqual(&test, rTM, 0.0001636816023788318);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636816023786666);
    AssertAlmostEqual(&test, rTM, 0.0001636816023789938);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636816023624674);
    AssertAlmostEqual(&test, rTM, 0.000163681602395193);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636816007425499);
    AssertAlmostEqual(&test, rTM, 0.0001636816040151104);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636814387509659);
    AssertAlmostEqual(&test, rTM, 0.0001636817660066944);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.00016366524121163);
    AssertAlmostEqual(&test, rTM, 0.0001636979635460303);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001620615176457563);
    AssertAlmostEqual(&test, rTM, 0.0001653016871110448);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.185419757096688e-05);
    AssertAlmostEqual(&test, rTM, 0.0002455090049947597);

    userdata[0] = 50/CAPS_HBAR_EV; /* 50eV */
    userdata[1] = 0.05/CAPS_HBAR_EV; /* 0.05eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999994408962247);
    AssertAlmostEqual(&test, rTM, 0.9999997204480733);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999960268279424);
    AssertAlmostEqual(&test, rTM, 0.9999999606615855);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999604641867388);
    AssertAlmostEqual(&test, rTM, 0.9999999960467358);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996047317625507);
    AssertAlmostEqual(&test, rTM, 0.999999999604654);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960543453721507);
    AssertAlmostEqual(&test, rTM, 0.9999999999604653);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9612391516181658);
    AssertAlmostEqual(&test, rTM, 0.9999999999960457);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6751531272728585);
    AssertAlmostEqual(&test, rTM, 0.999999999999597);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05690562672065586);
    AssertAlmostEqual(&test, rTM, 0.9999999999999124);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006389835998701226);
    AssertAlmostEqual(&test, rTM, 0.9999999999999217);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.397927965353697e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999999218);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.398009014413405e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999999218);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.398009824916965e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999999999218);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.398009833022002e-12);
    AssertAlmostEqual(&test, rTM, 0.9999999999999218);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999987435707486);
    AssertAlmostEqual(&test, rTM, 0.9999987560106345);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999982319593794);
    AssertAlmostEqual(&test, rTM, 0.999999115979299);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999874357785234);
    AssertAlmostEqual(&test, rTM, 0.9999998756009938);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998749821029129);
    AssertAlmostEqual(&test, rTM, 0.9999999874986789);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9987505860073159);
    AssertAlmostEqual(&test, rTM, 0.9999999987498057);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9875759588410059);
    AssertAlmostEqual(&test, rTM, 0.9999999998749781);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8825514546238288);
    AssertAlmostEqual(&test, rTM, 0.9999999999874737);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3071397561617756);
    AssertAlmostEqual(&test, rTM, 0.9999999999985256);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.006317425059811036);
    AssertAlmostEqual(&test, rTM, 0.9999999999992085);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.397189024010338e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999992184);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.397999396217728e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999992185);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.398007501235839e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999999992185);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.39800758228615e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999999992185);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999874978839175);
    AssertAlmostEqual(&test, rTM, 0.9999874978964195);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999874972650825);
    AssertAlmostEqual(&test, rTM, 0.9999874985152232);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999874355355108);
    AssertAlmostEqual(&test, rTM, 0.9999875599353756);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999823193924982);
    AssertAlmostEqual(&test, rTM, 0.9999911596571731);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998743624589121);
    AssertAlmostEqual(&test, rTM, 0.9999987559865711);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9987505000496273);
    AssertAlmostEqual(&test, rTM, 0.9999998749843542);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9875757139287761);
    AssertAlmostEqual(&test, rTM, 0.9999999874975741);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8825493241444803);
    AssertAlmostEqual(&test, rTM, 0.9999999987473409);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3071334584751526);
    AssertAlmostEqual(&test, rTM, 0.9999999998525609);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.006317183754814284);
    AssertAlmostEqual(&test, rTM, 0.999999999920854);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.396941597098938e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999218376);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.397751906618395e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999218475);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.397760011009476e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999999218476);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999604584409699);
    AssertAlmostEqual(&test, rTM, 0.9999604584413654);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999604584213972);
    AssertAlmostEqual(&test, rTM, 0.9999604584609381);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999604564641783);
    AssertAlmostEqual(&test, rTM, 0.9999604604180583);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999602612291056);
    AssertAlmostEqual(&test, rTM, 0.9999606546745424);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999440802491779);
    AssertAlmostEqual(&test, rTM, 0.9999720397336952);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996026833487601);
    AssertAlmostEqual(&test, rTM, 0.9999960653977137);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.996053379266567);
    AssertAlmostEqual(&test, rTM, 0.9999996045956689);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.961231710948016);
    AssertAlmostEqual(&test, rTM, 0.9999999604499522);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6751019792608717);
    AssertAlmostEqual(&test, rTM, 0.9999999959692215);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05688579437741259);
    AssertAlmostEqual(&test, rTM, 0.9999999991238903);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006387343603501359);
    AssertAlmostEqual(&test, rTM, 0.9999999992172023);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.395429255772986e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999992181916);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.395510241537432e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999992182016);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998747443915053);
    AssertAlmostEqual(&test, rTM, 0.9998747443915178);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998747443908853);
    AssertAlmostEqual(&test, rTM, 0.9998747443921377);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998747443288877);
    AssertAlmostEqual(&test, rTM, 0.9998747444541354);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.99987473812928);
    AssertAlmostEqual(&test, rTM, 0.9998747506534301);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998741197107067);
    AssertAlmostEqual(&test, rTM, 0.9998753659725317);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998228664151326);
    AssertAlmostEqual(&test, rTM, 0.9999114292850069);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9987419100130764);
    AssertAlmostEqual(&test, rTM, 0.9999875358957557);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9875512451151104);
    AssertAlmostEqual(&test, rTM, 0.9999987474043096);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8823365104695963);
    AssertAlmostEqual(&test, rTM, 0.9999998744911701);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3065051262994088);
    AssertAlmostEqual(&test, rTM, 0.9999999852195851);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.006293145996911383);
    AssertAlmostEqual(&test, rTM, 0.999999992055163);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.372295188946901e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999921535337);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.373099266218996e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999921545236);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995970850286298);
    AssertAlmostEqual(&test, rTM, 0.9995970850286302);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995970850286099);
    AssertAlmostEqual(&test, rTM, 0.9995970850286501);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995970850266158);
    AssertAlmostEqual(&test, rTM, 0.9995970850306442);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995970848272131);
    AssertAlmostEqual(&test, rTM, 0.9995970852300468);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995970648874445);
    AssertAlmostEqual(&test, rTM, 0.999597105168809);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995950758721269);
    AssertAlmostEqual(&test, rTM, 0.9995990842180794);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994302397390252);
    AssertAlmostEqual(&test, rTM, 0.9997150792738209);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9959581318487825);
    AssertAlmostEqual(&test, rTM, 0.9999599011061032);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9605022976911151);
    AssertAlmostEqual(&test, rTM, 0.9999959694300381);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6701069337581168);
    AssertAlmostEqual(&test, rTM, 0.9999995889044099);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05498855451561764);
    AssertAlmostEqual(&test, rTM, 0.9999999093469385);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006149840301355362);
    AssertAlmostEqual(&test, rTM, 0.9999999186971131);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.157335566282118e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999187960517);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9985267332924739);
    AssertAlmostEqual(&test, rTM, 0.9985267332924739);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9985267332924731);
    AssertAlmostEqual(&test, rTM, 0.9985267332924745);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9985267332924003);
    AssertAlmostEqual(&test, rTM, 0.9985267332925475);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.998526733285113);
    AssertAlmostEqual(&test, rTM, 0.9985267332998348);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9985267325563837);
    AssertAlmostEqual(&test, rTM, 0.9985267340285636);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9985266596852842);
    AssertAlmostEqual(&test, rTM, 0.9985268068959888);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9985193907270478);
    AssertAlmostEqual(&test, rTM, 0.9985340394717167);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9979171223417294);
    AssertAlmostEqual(&test, rTM, 0.9989580180249674);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9852923001642376);
    AssertAlmostEqual(&test, rTM, 0.9998533031914099);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8630268644597795);
    AssertAlmostEqual(&test, rTM, 0.9999852173147101);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2551983188313561);
    AssertAlmostEqual(&test, rTM, 0.9999981683431081);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.004558567279078593);
    AssertAlmostEqual(&test, rTM, 0.9999989031881549);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.599991093963577e-05);
    AssertAlmostEqual(&test, rTM, 0.9999989130425576);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9912802432991631);
    AssertAlmostEqual(&test, rTM, 0.9912802432991631);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9912802432991631);
    AssertAlmostEqual(&test, rTM, 0.9912802432991632);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9912802432991588);
    AssertAlmostEqual(&test, rTM, 0.9912802432991674);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9912802432987291);
    AssertAlmostEqual(&test, rTM, 0.9912802432995972);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9912802432557553);
    AssertAlmostEqual(&test, rTM, 0.991280243342571);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9912802389583777);
    AssertAlmostEqual(&test, rTM, 0.9912802476399465);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9912798092314524);
    AssertAlmostEqual(&test, rTM, 0.9912806773453616);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9912369443616095);
    AssertAlmostEqual(&test, rTM, 0.991323329225551);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9876907488472469);
    AssertAlmostEqual(&test, rTM, 0.9938262582361664);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9157712544606512);
    AssertAlmostEqual(&test, rTM, 0.9991280975296164);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4274049181942227);
    AssertAlmostEqual(&test, rTM, 0.9999044011260969);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01270803740548173);
    AssertAlmostEqual(&test, rTM, 0.9999606627429268);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001303390325262255);
    AssertAlmostEqual(&test, rTM, 0.9999616399785003);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9239268837523154);
    AssertAlmostEqual(&test, rTM, 0.9239268837523154);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9239268837523154);
    AssertAlmostEqual(&test, rTM, 0.9239268837523154);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9239268837523149);
    AssertAlmostEqual(&test, rTM, 0.9239268837523157);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9239268837522788);
    AssertAlmostEqual(&test, rTM, 0.9239268837523519);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9239268837486621);
    AssertAlmostEqual(&test, rTM, 0.9239268837559685);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9239268833869896);
    AssertAlmostEqual(&test, rTM, 0.923926884117641);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9239268472197533);
    AssertAlmostEqual(&test, rTM, 0.9239269202848606);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9239232305938161);
    AssertAlmostEqual(&test, rTM, 0.9239305367423282);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9235625400894483);
    AssertAlmostEqual(&test, rTM, 0.9242895591038865);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8941634074220556);
    AssertAlmostEqual(&test, rTM, 0.9455608056702427);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.460346095331329);
    AssertAlmostEqual(&test, rTM, 0.9915739854969754);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01547343174925686);
    AssertAlmostEqual(&test, rTM, 0.9967799943835852);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001596011869647435);
    AssertAlmostEqual(&test, rTM, 0.9968769766950277);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4658969703223112);
    AssertAlmostEqual(&test, rTM, 0.4658969703223112);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4658969703223112);
    AssertAlmostEqual(&test, rTM, 0.4658969703223112);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4658969703223112);
    AssertAlmostEqual(&test, rTM, 0.4658969703223112);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4658969703223095);
    AssertAlmostEqual(&test, rTM, 0.4658969703223129);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4658969703221414);
    AssertAlmostEqual(&test, rTM, 0.465896970322481);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4658969703053361);
    AssertAlmostEqual(&test, rTM, 0.4658969703392863);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4658969686248046);
    AssertAlmostEqual(&test, rTM, 0.4658969720198178);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4658968005717267);
    AssertAlmostEqual(&test, rTM, 0.4658971400728614);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4658799960458733);
    AssertAlmostEqual(&test, rTM, 0.4659139442558509);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4642073188248005);
    AssertAlmostEqual(&test, rTM, 0.4675832309335322);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.347583704484941);
    AssertAlmostEqual(&test, rTM, 0.5696071035841493);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01566758304692755);
    AssertAlmostEqual(&test, rTM, 0.7590479283457969);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001632505175742134);
    AssertAlmostEqual(&test, rTM, 0.7655429610461992);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585466879931758);
    AssertAlmostEqual(&test, rTM, 0.01585466879931758);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585466879931758);
    AssertAlmostEqual(&test, rTM, 0.01585466879931758);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585466879931758);
    AssertAlmostEqual(&test, rTM, 0.01585466879931758);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585466879931758);
    AssertAlmostEqual(&test, rTM, 0.01585466879931758);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585466879931743);
    AssertAlmostEqual(&test, rTM, 0.01585466879931773);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585466879930222);
    AssertAlmostEqual(&test, rTM, 0.01585466879933294);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0158546687977816);
    AssertAlmostEqual(&test, rTM, 0.01585466880085356);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585466864571984);
    AssertAlmostEqual(&test, rTM, 0.01585466895291532);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585465343955832);
    AssertAlmostEqual(&test, rTM, 0.01585468415907683);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585313297072937);
    AssertAlmostEqual(&test, rTM, 0.01585620462783097);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01570254517655156);
    AssertAlmostEqual(&test, rTM, 0.01600679168809794);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.008053509875571532);
    AssertAlmostEqual(&test, rTM, 0.02365389794592083);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001620229683987114);
    AssertAlmostEqual(&test, rTM, 0.03153950783853469);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636803461384506);
    AssertAlmostEqual(&test, rTM, 0.0001636803461384506);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636803461384506);
    AssertAlmostEqual(&test, rTM, 0.0001636803461384506);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636803461384506);
    AssertAlmostEqual(&test, rTM, 0.0001636803461384506);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636803461384506);
    AssertAlmostEqual(&test, rTM, 0.0001636803461384506);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636803461384506);
    AssertAlmostEqual(&test, rTM, 0.0001636803461384506);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636803461384489);
    AssertAlmostEqual(&test, rTM, 0.0001636803461384522);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000163680346138287);
    AssertAlmostEqual(&test, rTM, 0.0001636803461386142);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636803461220879);
    AssertAlmostEqual(&test, rTM, 0.0001636803461548133);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636803445021829);
    AssertAlmostEqual(&test, rTM, 0.0001636803477747183);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636801825118418);
    AssertAlmostEqual(&test, rTM, 0.0001636805097650594);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636639850967797);
    AssertAlmostEqual(&test, rTM, 0.0001636967071801214);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001620602738353394);
    AssertAlmostEqual(&test, rTM, 0.0001653004184407026);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.18535692451418e-05);
    AssertAlmostEqual(&test, rTM, 0.0002455071208398761);

    userdata[0] = 50/CAPS_HBAR_EV; /* 50eV */
    userdata[1] = 0.1/CAPS_HBAR_EV; /* 0.1eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999992093079575);
    AssertAlmostEqual(&test, rTM, 0.9999996046539006);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999994381090869);
    AssertAlmostEqual(&test, rTM, 0.9999999443670816);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999440883750556);
    AssertAlmostEqual(&test, rTM, 0.9999999944092403);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994410520712059);
    AssertAlmostEqual(&test, rTM, 0.9999999994408963);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9944245687239477);
    AssertAlmostEqual(&test, rTM, 0.9999999999440894);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9456307508597414);
    AssertAlmostEqual(&test, rTM, 0.9999999999944068);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5757588059295672);
    AssertAlmostEqual(&test, rTM, 0.9999999999994195);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0300936275380934);
    AssertAlmostEqual(&test, rTM, 0.999999999999834);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000319695988788808);
    AssertAlmostEqual(&test, rTM, 0.9999999999998436);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.198984511949906e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999998437);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.199004774379291e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999998437);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.199004977005206e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999999998437);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.199004979031465e-12);
    AssertAlmostEqual(&test, rTM, 0.9999999999998437);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999982231413485);
    AssertAlmostEqual(&test, rTM, 0.9999982407339929);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999974996141354);
    AssertAlmostEqual(&test, rTM, 0.9999987498062862);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999822315555592);
    AssertAlmostEqual(&test, rTM, 0.99999982407326);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998232025896633);
    AssertAlmostEqual(&test, rTM, 0.9999999823204639);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9982335194021362);
    AssertAlmostEqual(&test, rTM, 0.9999999982319582);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9824751875896528);
    AssertAlmostEqual(&test, rTM, 0.9999999998231889);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8381361498210315);
    AssertAlmostEqual(&test, rTM, 0.9999999999822506);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2031348715735828);
    AssertAlmostEqual(&test, rTM, 0.9999999999976401);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.003178699392914327);
    AssertAlmostEqual(&test, rTM, 0.999999999998427);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.198799760334157e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999984369);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.199002369827839e-07);
    AssertAlmostEqual(&test, rTM, 0.999999999998437);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.199004396084795e-09);
    AssertAlmostEqual(&test, rTM, 0.999999999998437);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.199004416347381e-11);
    AssertAlmostEqual(&test, rTM, 0.999999999998437);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999823195563665);
    AssertAlmostEqual(&test, rTM, 0.9999823195740468);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999823186812148);
    AssertAlmostEqual(&test, rTM, 0.9999823204491542);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999822313837234);
    AssertAlmostEqual(&test, rTM, 0.9999824073090697);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999974996180885);
    AssertAlmostEqual(&test, rTM, 0.9999874980122921);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998223280443599);
    AssertAlmostEqual(&test, rTM, 0.9999982407169724);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9982334149716534);
    AssertAlmostEqual(&test, rTM, 0.9999998232028753);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.982475011008498);
    AssertAlmostEqual(&test, rTM, 0.999999982318727);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8381347215628672);
    AssertAlmostEqual(&test, rTM, 0.9999999982250456);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2031322693080235);
    AssertAlmostEqual(&test, rTM, 0.9999999997640115);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.003178638301476818);
    AssertAlmostEqual(&test, rTM, 0.9999999998427015);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.198737894471416e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999998436884);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.198940496127948e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999998436983);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.198942522306523e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999998436984);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999440857094902);
    AssertAlmostEqual(&test, rTM, 0.9999440857100493);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999440856818135);
    AssertAlmostEqual(&test, rTM, 0.9999440857377262);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999440829142033);
    AssertAlmostEqual(&test, rTM, 0.9999440885051966);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.99994380684161);
    AssertAlmostEqual(&test, rTM, 0.9999443631940371);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.99992092616815);
    AssertAlmostEqual(&test, rTM, 0.9999604623024447);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994382104973227);
    AssertAlmostEqual(&test, rTM, 0.9999944361798874);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9944237476979818);
    AssertAlmostEqual(&test, rTM, 0.9999994408673921);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9456255624855967);
    AssertAlmostEqual(&test, rTM, 0.9999999440623272);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5757285247073642);
    AssertAlmostEqual(&test, rTM, 0.999999994193994);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03008809315038863);
    AssertAlmostEqual(&test, rTM, 0.9999999983397174);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003196335870948494);
    AssertAlmostEqual(&test, rTM, 0.999999998435709);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.198359704528574e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999984366986);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.198379959043661e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999984367086);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998230388461237);
    AssertAlmostEqual(&test, rTM, 0.9998230388461413);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998230388452478);
    AssertAlmostEqual(&test, rTM, 0.9998230388470172);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998230387576598);
    AssertAlmostEqual(&test, rTM, 0.9998230389346051);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998230299990789);
    AssertAlmostEqual(&test, rTM, 0.9998230476927438);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998221563198759);
    AssertAlmostEqual(&test, rTM, 0.9998239169933523);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997497483088552);
    AssertAlmostEqual(&test, rTM, 0.9998748663247194);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9982229860325127);
    AssertAlmostEqual(&test, rTM, 0.9999823902970959);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9824573604319414);
    AssertAlmostEqual(&test, rTM, 0.9999982302526357);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8379919781441576);
    AssertAlmostEqual(&test, rTM, 0.9999998223317611);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2028723934502643);
    AssertAlmostEqual(&test, rTM, 0.9999999763683282);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.00317254099367498);
    AssertAlmostEqual(&test, rTM, 0.9999999842399212);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.192563369586647e-05);
    AssertAlmostEqual(&test, rTM, 0.999999984338604);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.192765189818735e-07);
    AssertAlmostEqual(&test, rTM, 0.999999984339594);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994356201309539);
    AssertAlmostEqual(&test, rTM, 0.9994356201309544);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994356201309259);
    AssertAlmostEqual(&test, rTM, 0.9994356201309823);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999435620128133);
    AssertAlmostEqual(&test, rTM, 0.9994356201337753);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994356198488439);
    AssertAlmostEqual(&test, rTM, 0.9994356204130642);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994355919206317);
    AssertAlmostEqual(&test, rTM, 0.999435648339867);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994328060498198);
    AssertAlmostEqual(&test, rTM, 0.9994384202542027);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999201939649448);
    AssertAlmostEqual(&test, rTM, 0.9996008901645034);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9943425230180266);
    AssertAlmostEqual(&test, rTM, 0.9999438276063516);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9451144503380328);
    AssertAlmostEqual(&test, rTM, 0.9999943526579772);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5727537279050048);
    AssertAlmostEqual(&test, rTM, 0.9999994134021204);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02955004066446507);
    AssertAlmostEqual(&test, rTM, 0.9999998309432747);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003135735232029995);
    AssertAlmostEqual(&test, rTM, 0.9999998405478033);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.137683034609329e-06);
    AssertAlmostEqual(&test, rTM, 0.9999998406467719);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9980688120363027);
    AssertAlmostEqual(&test, rTM, 0.9980688120363027);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9980688120363018);
    AssertAlmostEqual(&test, rTM, 0.9980688120363037);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9980688120362062);
    AssertAlmostEqual(&test, rTM, 0.9980688120363992);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9980688120266561);
    AssertAlmostEqual(&test, rTM, 0.9980688120459493);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9980688110716422);
    AssertAlmostEqual(&test, rTM, 0.9980688130009627);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9980687155726481);
    AssertAlmostEqual(&test, rTM, 0.998068908495144);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.998059189472306);
    AssertAlmostEqual(&test, rTM, 0.9980783869373847);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9972699809683816);
    AssertAlmostEqual(&test, rTM, 0.9986340569472715);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9807608205869989);
    AssertAlmostEqual(&test, rTM, 0.9998076634016611);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8244692353894005);
    AssertAlmostEqual(&test, rTM, 0.9999805805337584);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1799614537190144);
    AssertAlmostEqual(&test, rTM, 0.9999973116167852);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002661927268061498);
    AssertAlmostEqual(&test, rTM, 0.9999981216785244);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.676012569115839e-05);
    AssertAlmostEqual(&test, rTM, 0.99999813155188);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9904370572372352);
    AssertAlmostEqual(&test, rTM, 0.9904370572372352);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9904370572372351);
    AssertAlmostEqual(&test, rTM, 0.9904370572372352);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9904370572372304);
    AssertAlmostEqual(&test, rTM, 0.9904370572372398);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9904370572367593);
    AssertAlmostEqual(&test, rTM, 0.990437057237711);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9904370571896501);
    AssertAlmostEqual(&test, rTM, 0.9904370572848201);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9904370524787373);
    AssertAlmostEqual(&test, rTM, 0.9904370619957307);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9904365813993382);
    AssertAlmostEqual(&test, rTM, 0.99043753305157);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9903895917580132);
    AssertAlmostEqual(&test, rTM, 0.9904842894068421);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9865028434755639);
    AssertAlmostEqual(&test, rTM, 0.9932284172117347);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9079810657884386);
    AssertAlmostEqual(&test, rTM, 0.9990432350338768);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3955972265289487);
    AssertAlmostEqual(&test, rTM, 0.9998934074839777);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01060194241154991);
    AssertAlmostEqual(&test, rTM, 0.9999528463791604);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001082803641810103);
    AssertAlmostEqual(&test, rTM, 0.9999538257090033);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9230213407075897);
    AssertAlmostEqual(&test, rTM, 0.9230213407075897);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9230213407075897);
    AssertAlmostEqual(&test, rTM, 0.9230213407075897);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9230213407075893);
    AssertAlmostEqual(&test, rTM, 0.92302134070759);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9230213407075527);
    AssertAlmostEqual(&test, rTM, 0.9230213407076266);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9230213407038949);
    AssertAlmostEqual(&test, rTM, 0.9230213407112845);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9230213403381037);
    AssertAlmostEqual(&test, rTM, 0.9230213410770757);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9230213037590002);
    AssertAlmostEqual(&test, rTM, 0.9230213776561621);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9230176459475516);
    AssertAlmostEqual(&test, rTM, 0.9230250352973963);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.922652848888014);
    AssertAlmostEqual(&test, rTM, 0.9233881469375557);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8929252610373732);
    AssertAlmostEqual(&test, rTM, 0.9449043676073472);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4561501056131735);
    AssertAlmostEqual(&test, rTM, 0.9914558226901088);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01510792819843386);
    AssertAlmostEqual(&test, rTM, 0.9967023134157718);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001557167596478862);
    AssertAlmostEqual(&test, rTM, 0.9967993207655603);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4654641666924679);
    AssertAlmostEqual(&test, rTM, 0.4654641666924679);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4654641666924679);
    AssertAlmostEqual(&test, rTM, 0.4654641666924679);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4654641666924679);
    AssertAlmostEqual(&test, rTM, 0.465464166692468);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4654641666924663);
    AssertAlmostEqual(&test, rTM, 0.4654641666924696);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4654641666922982);
    AssertAlmostEqual(&test, rTM, 0.4654641666926377);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4654641666754899);
    AssertAlmostEqual(&test, rTM, 0.465464166709446);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4654641649946627);
    AssertAlmostEqual(&test, rTM, 0.4654641683902732);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4654639969120216);
    AssertAlmostEqual(&test, rTM, 0.46546433647288);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4654471894304451);
    AssertAlmostEqual(&test, rTM, 0.465481143611967);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4637742225875329);
    AssertAlmostEqual(&test, rTM, 0.4671507236229353);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3471547478425904);
    AssertAlmostEqual(&test, rTM, 0.5691898186124741);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0156289184273941);
    AssertAlmostEqual(&test, rTM, 0.7585954763440349);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001628349890755583);
    AssertAlmostEqual(&test, rTM, 0.7650852133191671);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585073989955392);
    AssertAlmostEqual(&test, rTM, 0.01585073989955392);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585073989955392);
    AssertAlmostEqual(&test, rTM, 0.01585073989955392);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585073989955392);
    AssertAlmostEqual(&test, rTM, 0.01585073989955392);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585073989955391);
    AssertAlmostEqual(&test, rTM, 0.01585073989955392);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585073989955376);
    AssertAlmostEqual(&test, rTM, 0.01585073989955407);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585073989953856);
    AssertAlmostEqual(&test, rTM, 0.01585073989956927);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585073989801831);
    AssertAlmostEqual(&test, rTM, 0.01585073990108953);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585073974599303);
    AssertAlmostEqual(&test, rTM, 0.0158507400531148);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01585072454348022);
    AssertAlmostEqual(&test, rTM, 0.01585075525562761);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01584920443948779);
    AssertAlmostEqual(&test, rTM, 0.01585227535954528);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01569865279003062);
    AssertAlmostEqual(&test, rTM, 0.01600282627562574);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.008051482779643753);
    AssertAlmostEqual(&test, rTM, 0.02364806866109231);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001619815380519808);
    AssertAlmostEqual(&test, rTM, 0.03153169726942747);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636761588097815);
    AssertAlmostEqual(&test, rTM, 0.0001636761588097815);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636761588097815);
    AssertAlmostEqual(&test, rTM, 0.0001636761588097815);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636761588097815);
    AssertAlmostEqual(&test, rTM, 0.0001636761588097815);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636761588097815);
    AssertAlmostEqual(&test, rTM, 0.0001636761588097815);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636761588097814);
    AssertAlmostEqual(&test, rTM, 0.0001636761588097815);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636761588097798);
    AssertAlmostEqual(&test, rTM, 0.0001636761588097831);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636761588096178);
    AssertAlmostEqual(&test, rTM, 0.0001636761588099451);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636761587934192);
    AssertAlmostEqual(&test, rTM, 0.0001636761588261437);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636761571735556);
    AssertAlmostEqual(&test, rTM, 0.0001636761604460073);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636759951873572);
    AssertAlmostEqual(&test, rTM, 0.0001636763224322057);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636597981865275);
    AssertAlmostEqual(&test, rTM, 0.0001636925194330353);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001620561279385016);
    AssertAlmostEqual(&test, rTM, 0.0001652961896802022);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.185147489539055e-05);
    AssertAlmostEqual(&test, rTM, 0.0002455008405324573);

    userdata[0] = 50/CAPS_HBAR_EV; /* 50eV */
    userdata[1] = 0.5/CAPS_HBAR_EV; /* 0.5eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999982319597214);
    AssertAlmostEqual(&test, rTM, 0.99999911597947);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999874357809536);
    AssertAlmostEqual(&test, rTM, 0.9999998756010179);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998749821270922);
    AssertAlmostEqual(&test, rTM, 0.9999999874986814);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9987505862488258);
    AssertAlmostEqual(&test, rTM, 0.9999999987498061);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9875759612290361);
    AssertAlmostEqual(&test, rTM, 0.9999999998749781);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.882551475923406);
    AssertAlmostEqual(&test, rTM, 0.9999999999874737);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3071398191399207);
    AssertAlmostEqual(&test, rTM, 0.9999999999985256);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.006317427472954042);
    AssertAlmostEqual(&test, rTM, 0.9999999999992085);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.397191498376112e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999992184);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.398001871210417e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999992185);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.398009976234799e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999999992185);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.398010057285172e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999999992185);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.398010058095676e-13);
    AssertAlmostEqual(&test, rTM, 0.9999999999992185);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999960268279424);
    AssertAlmostEqual(&test, rTM, 0.9999960661662022);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999944089763138);
    AssertAlmostEqual(&test, rTM, 0.9999972044842494);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999602689897934);
    AssertAlmostEqual(&test, rTM, 0.9999996066159238);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996047122011446);
    AssertAlmostEqual(&test, rTM, 0.9999999604673584);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960543434229129);
    AssertAlmostEqual(&test, rTM, 0.9999999960465324);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9612391514300914);
    AssertAlmostEqual(&test, rTM, 0.9999999996045766);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6751531272598968);
    AssertAlmostEqual(&test, rTM, 0.9999999999597003);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05690562672060559);
    AssertAlmostEqual(&test, rTM, 0.999999999991242);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006389835998701163);
    AssertAlmostEqual(&test, rTM, 0.999999999992175);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.397927965353697e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999921849);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.398009014413407e-08);
    AssertAlmostEqual(&test, rTM, 0.999999999992185);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.398009824916966e-10);
    AssertAlmostEqual(&test, rTM, 0.999999999992185);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.398009833022004e-12);
    AssertAlmostEqual(&test, rTM, 0.999999999992185);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999960466067111);
    AssertAlmostEqual(&test, rTM, 0.9999604661066441);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999604641102704);
    AssertAlmostEqual(&test, rTM, 0.9999604680633859);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999602689129474);
    AssertAlmostEqual(&test, rTM, 0.9999606622823095);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999440910616674);
    AssertAlmostEqual(&test, rTM, 0.9999720451400911);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996027601597024);
    AssertAlmostEqual(&test, rTM, 0.9999960661585173);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960541408870733);
    AssertAlmostEqual(&test, rTM, 0.9999996046721256);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9612390591333536);
    AssertAlmostEqual(&test, rTM, 0.9999999604576026);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6751526194909238);
    AssertAlmostEqual(&test, rTM, 0.9999999959700302);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05690543028779484);
    AssertAlmostEqual(&test, rTM, 0.9999999991241945);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000638981131198084);
    AssertAlmostEqual(&test, rTM, 0.9999999992175046);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.397903216084694e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999992184939);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.397984264517416e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999992185039);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.397985075014706e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999992185039);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998749859345295);
    AssertAlmostEqual(&test, rTM, 0.9998749859357795);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998749858726514);
    AssertAlmostEqual(&test, rTM, 0.9998749859976576);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998749796849983);
    AssertAlmostEqual(&test, rTM, 0.9998749921849983);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998743624589121);
    AssertAlmostEqual(&test, rTM, 0.9998756063175888);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998232079917215);
    AssertAlmostEqual(&test, rTM, 0.9999116000884158);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9987443347485403);
    AssertAlmostEqual(&test, rTM, 0.9999875599329692);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.987575102786905);
    AssertAlmostEqual(&test, rTM, 0.9999987498200664);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8825492696335979);
    AssertAlmostEqual(&test, rTM, 0.9999998747341602);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3071334568634238);
    AssertAlmostEqual(&test, rTM, 0.9999999852560996);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.006317183754196735);
    AssertAlmostEqual(&test, rTM, 0.9999999920853966);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.396941597092606e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999921837649);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.397751906618332e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999921847549);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.397760011009476e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999921847648);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996046547658574);
    AssertAlmostEqual(&test, rTM, 0.9996046547658969);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996046547639008);
    AssertAlmostEqual(&test, rTM, 0.9996046547678534);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996046545682437);
    AssertAlmostEqual(&test, rTM, 0.9996046549635105);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996046350030179);
    AssertAlmostEqual(&test, rTM, 0.9996046745277487);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996026833487601);
    AssertAlmostEqual(&test, rTM, 0.9996066164030847);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994409431938411);
    AssertAlmostEqual(&test, rTM, 0.9997204325124687);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.996033932268315);
    AssertAlmostEqual(&test, rTM, 0.9999606545984051);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9612298299020831);
    AssertAlmostEqual(&test, rTM, 0.9999960451987929);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6751018496294654);
    AssertAlmostEqual(&test, rTM, 0.9999995969224365);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05688579387486727);
    AssertAlmostEqual(&test, rTM, 0.9999999123890302);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000638734360286982);
    AssertAlmostEqual(&test, rTM, 0.9999999217202349);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.395429255766655e-06);
    AssertAlmostEqual(&test, rTM, 0.999999921819171);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.39551024153737e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999218201611);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9987481497638615);
    AssertAlmostEqual(&test, rTM, 0.9987481497638627);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9987481497637996);
    AssertAlmostEqual(&test, rTM, 0.9987481497639247);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9987481497576067);
    AssertAlmostEqual(&test, rTM, 0.9987481497701174);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9987481491383291);
    AssertAlmostEqual(&test, rTM, 0.9987481503893947);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9987480872121187);
    AssertAlmostEqual(&test, rTM, 0.998748212312482);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9987419100130764);
    AssertAlmostEqual(&test, rTM, 0.9987543585866331);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9982300756473217);
    AssertAlmostEqual(&test, rTM, 0.9991146457241442);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9874901685347249);
    AssertAlmostEqual(&test, rTM, 0.9998753635523809);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.88233105036032);
    AssertAlmostEqual(&test, rTM, 0.9999874498186433);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3065049652330585);
    AssertAlmostEqual(&test, rTM, 0.9999985219606891);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.006293145935388487);
    AssertAlmostEqual(&test, rTM, 0.999999205516917);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.372295188316124e-05);
    AssertAlmostEqual(&test, rTM, 0.9999992153539803);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.373099266212686e-07);
    AssertAlmostEqual(&test, rTM, 0.9999992154529738);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9959781504529461);
    AssertAlmostEqual(&test, rTM, 0.9959781504529461);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9959781504529441);
    AssertAlmostEqual(&test, rTM, 0.9959781504529481);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9959781504527454);
    AssertAlmostEqual(&test, rTM, 0.9959781504531469);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9959781504328774);
    AssertAlmostEqual(&test, rTM, 0.9959781504730149);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9959781484460738);
    AssertAlmostEqual(&test, rTM, 0.9959781524598175);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9959779497707026);
    AssertAlmostEqual(&test, rTM, 0.9959783511251967);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9959581318487825);
    AssertAlmostEqual(&test, rTM, 0.9959980701075651);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9943169910138882);
    AssertAlmostEqual(&test, rTM, 0.9971544411523519);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9603112330979782);
    AssertAlmostEqual(&test, rTM, 0.9995990036599511);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6700938301056443);
    AssertAlmostEqual(&test, rTM, 0.9999588933980421);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05498850575194267);
    AssertAlmostEqual(&test, rTM, 0.9999909347718501);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006149840240546782);
    AssertAlmostEqual(&test, rTM, 0.9999918697767141);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.15733556567255e-06);
    AssertAlmostEqual(&test, rTM, 0.9999918796704441);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9853647536094038);
    AssertAlmostEqual(&test, rTM, 0.9853647536094038);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9853647536094037);
    AssertAlmostEqual(&test, rTM, 0.9853647536094039);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9853647536093966);
    AssertAlmostEqual(&test, rTM, 0.985364753609411);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9853647536086774);
    AssertAlmostEqual(&test, rTM, 0.9853647536101302);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.985364753536767);
    AssertAlmostEqual(&test, rTM, 0.9853647536820406);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9853647463457248);
    AssertAlmostEqual(&test, rTM, 0.9853647608730792);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9853640272597451);
    AssertAlmostEqual(&test, rTM, 0.9853654799232811);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9852923001642376);
    AssertAlmostEqual(&test, rTM, 0.9854368527507725);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9793657362545369);
    AssertAlmostEqual(&test, rTM, 0.9896288099339652);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8624005418112569);
    AssertAlmostEqual(&test, rTM, 0.9985301042924382);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2551833284189762);
    AssertAlmostEqual(&test, rTM, 0.9998168666407895);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.004558562807060166);
    AssertAlmostEqual(&test, rTM, 0.99989033067081);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.599991048427856e-05);
    AssertAlmostEqual(&test, rTM, 0.9998913159505847);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9161709765580209);
    AssertAlmostEqual(&test, rTM, 0.9161709765580209);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9161709765580208);
    AssertAlmostEqual(&test, rTM, 0.9161709765580209);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9161709765580205);
    AssertAlmostEqual(&test, rTM, 0.9161709765580213);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9161709765579809);
    AssertAlmostEqual(&test, rTM, 0.916170976558061);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9161709765540128);
    AssertAlmostEqual(&test, rTM, 0.9161709765620289);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9161709761572127);
    AssertAlmostEqual(&test, rTM, 0.9161709769588291);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9161709364772044);
    AssertAlmostEqual(&test, rTM, 0.9161710166388191);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9161669685844318);
    AssertAlmostEqual(&test, rTM, 0.9161749843483752);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9157712544606512);
    AssertAlmostEqual(&test, rTM, 0.9165688843164358);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8835758543639037);
    AssertAlmostEqual(&test, rTM, 0.9399315052149816);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4257159219921694);
    AssertAlmostEqual(&test, rTM, 0.9905420312521959);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01270681100399399);
    AssertAlmostEqual(&test, rTM, 0.9960813531566147);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001303389035243447);
    AssertAlmostEqual(&test, rTM, 0.9961785086163738);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4620382716057925);
    AssertAlmostEqual(&test, rTM, 0.4620382716057925);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4620382716057925);
    AssertAlmostEqual(&test, rTM, 0.4620382716057925);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4620382716057925);
    AssertAlmostEqual(&test, rTM, 0.4620382716057926);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4620382716057909);
    AssertAlmostEqual(&test, rTM, 0.4620382716057942);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4620382716056226);
    AssertAlmostEqual(&test, rTM, 0.4620382716059626);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4620382715887917);
    AssertAlmostEqual(&test, rTM, 0.4620382716227934);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4620382699057077);
    AssertAlmostEqual(&test, rTM, 0.4620382733058774);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4620381015973901);
    AssertAlmostEqual(&test, rTM, 0.4620384416141611);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4620212715528882);
    AssertAlmostEqual(&test, rTM, 0.4620552713191579);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.460346095331329);
    AssertAlmostEqual(&test, rTM, 0.4637270902996011);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.34376589530848);
    AssertAlmostEqual(&test, rTM, 0.5658809561332179);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01532634006817997);
    AssertAlmostEqual(&test, rTM, 0.7549952245577721);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001595853930688824);
    AssertAlmostEqual(&test, rTM, 0.7614428444528057);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01581937868013319);
    AssertAlmostEqual(&test, rTM, 0.01581937868013319);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01581937868013319);
    AssertAlmostEqual(&test, rTM, 0.01581937868013319);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01581937868013319);
    AssertAlmostEqual(&test, rTM, 0.01581937868013319);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01581937868013318);
    AssertAlmostEqual(&test, rTM, 0.01581937868013319);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01581937868013303);
    AssertAlmostEqual(&test, rTM, 0.01581937868013334);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01581937868011786);
    AssertAlmostEqual(&test, rTM, 0.01581937868014851);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01581937867860052);
    AssertAlmostEqual(&test, rTM, 0.01581937868166585);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01581937852686651);
    AssertAlmostEqual(&test, rTM, 0.01581937883339986);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01581936335348046);
    AssertAlmostEqual(&test, rTM, 0.01581939400678591);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01581784616189099);
    AssertAlmostEqual(&test, rTM, 0.01582091119830106);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01566758304692755);
    AssertAlmostEqual(&test, rTM, 0.0159711735841423);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.008035302677105656);
    AssertAlmostEqual(&test, rTM, 0.02360153762504272);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001616508564900044);
    AssertAlmostEqual(&test, rTM, 0.03146935170652477);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636426678916148);
    AssertAlmostEqual(&test, rTM, 0.0001636426678916148);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636426678916148);
    AssertAlmostEqual(&test, rTM, 0.0001636426678916148);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636426678916148);
    AssertAlmostEqual(&test, rTM, 0.0001636426678916148);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636426678916148);
    AssertAlmostEqual(&test, rTM, 0.0001636426678916148);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636426678916148);
    AssertAlmostEqual(&test, rTM, 0.0001636426678916149);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636426678916132);
    AssertAlmostEqual(&test, rTM, 0.0001636426678916165);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636426678914513);
    AssertAlmostEqual(&test, rTM, 0.0001636426678917785);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636426678752559);
    AssertAlmostEqual(&test, rTM, 0.0001636426679079738);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636426662557237);
    AssertAlmostEqual(&test, rTM, 0.000163642669527506);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636425043026596);
    AssertAlmostEqual(&test, rTM, 0.0001636428314805701);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636263106149264);
    AssertAlmostEqual(&test, rTM, 0.0001636590251683032);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001620229683987114);
    AssertAlmostEqual(&test, rTM, 0.0001652623673836597);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.183472395486691e-05);
    AssertAlmostEqual(&test, rTM, 0.0002454506096379927);

    userdata[0] = 50/CAPS_HBAR_EV; /* 50eV */
    userdata[1] = 1/CAPS_HBAR_EV; /* 1eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999974996143772);
    AssertAlmostEqual(&test, rTM, 0.9999987498064071);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999822315572776);
    AssertAlmostEqual(&test, rTM, 0.999999824073277);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998232026067597);
    AssertAlmostEqual(&test, rTM, 0.9999999823204656);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9982335195728211);
    AssertAlmostEqual(&test, rTM, 0.9999999982319584);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.982475189269491);
    AssertAlmostEqual(&test, rTM, 0.9999999998231889);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8381361640963888);
    AssertAlmostEqual(&test, rTM, 0.9999999999822506);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2031348975964564);
    AssertAlmostEqual(&test, rTM, 0.9999999999976401);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.003178700003840529);
    AssertAlmostEqual(&test, rTM, 0.999999999998427);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.19880037900487e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999984369);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.199002988576925e-07);
    AssertAlmostEqual(&test, rTM, 0.999999999998437);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.199005014834665e-09);
    AssertAlmostEqual(&test, rTM, 0.999999999998437);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.199005035097259e-11);
    AssertAlmostEqual(&test, rTM, 0.999999999998437);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.199005035299884e-13);
    AssertAlmostEqual(&test, rTM, 0.999999999998437);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999994381090869);
    AssertAlmostEqual(&test, rTM, 0.999994436723478);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999920931077083);
    AssertAlmostEqual(&test, rTM, 0.9999960465460392);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999438123294226);
    AssertAlmostEqual(&test, rTM, 0.9999994436709548);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994410244117307);
    AssertAlmostEqual(&test, rTM, 0.9999999440924021);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.994424565971825);
    AssertAlmostEqual(&test, rTM, 0.9999999944089417);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9456307505981341);
    AssertAlmostEqual(&test, rTM, 0.9999999994406776);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5757588059142211);
    AssertAlmostEqual(&test, rTM, 0.999999999941946);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03009362753806535);
    AssertAlmostEqual(&test, rTM, 0.9999999999834003);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003196959887888048);
    AssertAlmostEqual(&test, rTM, 0.9999999999843602);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.198984511949906e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999843701);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.199004774379292e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999843702);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.199004977005206e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999999843702);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.199004979031465e-12);
    AssertAlmostEqual(&test, rTM, 0.9999999999843702);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999440910883276);
    AssertAlmostEqual(&test, rTM, 0.9999440911442349);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999944088320985);
    AssertAlmostEqual(&test, rTM, 0.9999440939114377);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999438122750852);
    AssertAlmostEqual(&test, rTM, 0.9999443685737186);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999209338139347);
    AssertAlmostEqual(&test, rTM, 0.9999604661254883);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999438264804601);
    AssertAlmostEqual(&test, rTM, 0.9999944367178825);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9944242853893039);
    AssertAlmostEqual(&test, rTM, 0.9999994409214582);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9456306733263757);
    AssertAlmostEqual(&test, rTM, 0.9999999440677403);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5757585045575202);
    AssertAlmostEqual(&test, rTM, 0.9999999941945961);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03009357272938198);
    AssertAlmostEqual(&test, rTM, 0.9999999983400203);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003196953708305122);
    AssertAlmostEqual(&test, rTM, 0.9999999984360113);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.198978324541258e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999984370009);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.198998586892293e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999984370109);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.198998789517424e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999984370109);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998232097176474);
    AssertAlmostEqual(&test, rTM, 0.9998232097194151);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998232096301439);
    AssertAlmostEqual(&test, rTM, 0.9998232098069184);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998232008800195);
    AssertAlmostEqual(&test, rTM, 0.9998232185566011);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998223280443599);
    AssertAlmostEqual(&test, rTM, 0.999824087017893);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997499899412128);
    AssertAlmostEqual(&test, rTM, 0.9998749871560124);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9982247005313509);
    AssertAlmostEqual(&test, rTM, 0.9999824073022634);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9824741512126053);
    AssertAlmostEqual(&test, rTM, 0.999998231961774);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8381346484951977);
    AssertAlmostEqual(&test, rTM, 0.9999998225046625);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2031322679760764);
    AssertAlmostEqual(&test, rTM, 0.9999999764011581);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.003178638301164128);
    AssertAlmostEqual(&test, rTM, 0.999999984270153);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.198737894468249e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999843688352);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.198940496127917e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999843698252);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.198942522306523e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999843698351);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994409977722558);
    AssertAlmostEqual(&test, rTM, 0.9994409977723118);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994409977694896);
    AssertAlmostEqual(&test, rTM, 0.999440997775078);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994409974928609);
    AssertAlmostEqual(&test, rTM, 0.9994409980517066);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994409698306856);
    AssertAlmostEqual(&test, rTM, 0.9994410257124858);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994382104973227);
    AssertAlmostEqual(&test, rTM, 0.9994437712222438);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9992095430127482);
    AssertAlmostEqual(&test, rTM, 0.9996046933572629);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9943962933315276);
    AssertAlmostEqual(&test, rTM, 0.9999443629787551);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9456229462423504);
    AssertAlmostEqual(&test, rTM, 0.9999944065252875);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5757283712402943);
    AssertAlmostEqual(&test, rTM, 0.9999994193998758);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03008809286991775);
    AssertAlmostEqual(&test, rTM, 0.9999998339717742);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003196335870632259);
    AssertAlmostEqual(&test, rTM, 0.9999998435709228);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.198359704525407e-06);
    AssertAlmostEqual(&test, rTM, 0.9999998436698908);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.19837995904363e-08);
    AssertAlmostEqual(&test, rTM, 0.9999998436708808);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9982317972110356);
    AssertAlmostEqual(&test, rTM, 0.9982317972110373);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9982317972109481);
    AssertAlmostEqual(&test, rTM, 0.9982317972111248);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9982317972022032);
    AssertAlmostEqual(&test, rTM, 0.9982317972198697);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9982317963277176);
    AssertAlmostEqual(&test, rTM, 0.9982317980943548);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9982317088813418);
    AssertAlmostEqual(&test, rTM, 0.9982318855363228);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9982229860325127);
    AssertAlmostEqual(&test, rTM, 0.9982405647385202);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9975003000197139);
    AssertAlmostEqual(&test, rTM, 0.9987493674802912);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9823715170732175);
    AssertAlmostEqual(&test, rTM, 0.9998239101685278);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8379846658306589);
    AssertAlmostEqual(&test, rTM, 0.9999822342186713);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2028722603539165);
    AssertAlmostEqual(&test, rTM, 0.9999976368380731);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.003172540962465482);
    AssertAlmostEqual(&test, rTM, 0.9999984239945744);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.192563369270603e-05);
    AssertAlmostEqual(&test, rTM, 0.9999984338628288);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.192765189815574e-07);
    AssertAlmostEqual(&test, rTM, 0.9999984339618254);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9943705207471539);
    AssertAlmostEqual(&test, rTM, 0.9943705207471539);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9943705207471512);
    AssertAlmostEqual(&test, rTM, 0.9943705207471567);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9943705207468733);
    AssertAlmostEqual(&test, rTM, 0.9943705207474346);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.994370520719086);
    AssertAlmostEqual(&test, rTM, 0.9943705207752219);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9943705179403601);
    AssertAlmostEqual(&test, rTM, 0.9943705235539464);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9943702400747598);
    AssertAlmostEqual(&test, rTM, 0.9943708014055945);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9943425230180266);
    AssertAlmostEqual(&test, rTM, 0.9943983803102521);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9920480169247347);
    AssertAlmostEqual(&test, rTM, 0.9960160567843067);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.944851146695737);
    AssertAlmostEqual(&test, rTM, 0.9994381988561888);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5727383249920092);
    AssertAlmostEqual(&test, rTM, 0.9999413450669437);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02955001308927253);
    AssertAlmostEqual(&test, rTM, 0.9999830946032282);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000313573520100568);
    AssertAlmostEqual(&test, rTM, 0.9999840550319525);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.137683034298701e-06);
    AssertAlmostEqual(&test, rTM, 0.9999840649285805);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9808553781516136);
    AssertAlmostEqual(&test, rTM, 0.9808553781516136);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9808553781516135);
    AssertAlmostEqual(&test, rTM, 0.9808553781516137);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9808553781516042);
    AssertAlmostEqual(&test, rTM, 0.9808553781516232);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9808553781506657);
    AssertAlmostEqual(&test, rTM, 0.9808553781525616);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9808553780568157);
    AssertAlmostEqual(&test, rTM, 0.9808553782464116);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9808553686718199);
    AssertAlmostEqual(&test, rTM, 0.9808553876314028);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9808544301961514);
    AssertAlmostEqual(&test, rTM, 0.9808563260605933);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9807608205869989);
    AssertAlmostEqual(&test, rTM, 0.9809494754502798);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9730335848255232);
    AssertAlmostEqual(&test, rTM, 0.9864240176165878);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8236863541185836);
    AssertAlmostEqual(&test, rTM, 0.9980695308463223);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1799490728872989);
    AssertAlmostEqual(&test, rTM, 0.9997312291806322);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002661924646748859);
    AssertAlmostEqual(&test, rTM, 0.9998122026823415);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.676012542624733e-05);
    AssertAlmostEqual(&test, rTM, 0.9998131897425551);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9084158202138395);
    AssertAlmostEqual(&test, rTM, 0.9084158202138395);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9084158202138395);
    AssertAlmostEqual(&test, rTM, 0.9084158202138395);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.908415820213839);
    AssertAlmostEqual(&test, rTM, 0.9084158202138399);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9084158202137959);
    AssertAlmostEqual(&test, rTM, 0.9084158202138831);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9084158202094801);
    AssertAlmostEqual(&test, rTM, 0.9084158202181989);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9084158197778941);
    AssertAlmostEqual(&test, rTM, 0.9084158206497849);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9084157766193073);
    AssertAlmostEqual(&test, rTM, 0.9084158638083519);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9084114608791127);
    AssertAlmostEqual(&test, rTM, 0.9084201793510323);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9079810657884386);
    AssertAlmostEqual(&test, rTM, 0.9088486187197226);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8730282072422574);
    AssertAlmostEqual(&test, rTM, 0.934286767451738);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3939098523036104);
    AssertAlmostEqual(&test, rTM, 0.989462728379661);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01060091494183379);
    AssertAlmostEqual(&test, rTM, 0.9953063287574211);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001082802570067692);
    AssertAlmostEqual(&test, rTM, 0.9954035800333161);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4578448100554646);
    AssertAlmostEqual(&test, rTM, 0.4578448100554646);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4578448100554646);
    AssertAlmostEqual(&test, rTM, 0.4578448100554646);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4578448100554646);
    AssertAlmostEqual(&test, rTM, 0.4578448100554646);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4578448100554629);
    AssertAlmostEqual(&test, rTM, 0.4578448100554663);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4578448100552943);
    AssertAlmostEqual(&test, rTM, 0.4578448100556349);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4578448100384379);
    AssertAlmostEqual(&test, rTM, 0.4578448100724913);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4578448083527941);
    AssertAlmostEqual(&test, rTM, 0.4578448117581351);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4578446397884914);
    AssertAlmostEqual(&test, rTM, 0.4578449803224042);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4578277841512294);
    AssertAlmostEqual(&test, rTM, 0.4578618356238654);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4561501056131735);
    AssertAlmostEqual(&test, rTM, 0.4595361936462414);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3396337341790006);
    AssertAlmostEqual(&test, rTM, 0.5618166329803777);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01496420695965761);
    AssertAlmostEqual(&test, rTM, 0.7505427726368086);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001557013500294668);
    AssertAlmostEqual(&test, rTM, 0.7569383646269029);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01578035128211975);
    AssertAlmostEqual(&test, rTM, 0.01578035128211975);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01578035128211975);
    AssertAlmostEqual(&test, rTM, 0.01578035128211975);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01578035128211975);
    AssertAlmostEqual(&test, rTM, 0.01578035128211975);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01578035128211975);
    AssertAlmostEqual(&test, rTM, 0.01578035128211975);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0157803512821196);
    AssertAlmostEqual(&test, rTM, 0.0157803512821199);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01578035128210446);
    AssertAlmostEqual(&test, rTM, 0.01578035128213504);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01578035128059074);
    AssertAlmostEqual(&test, rTM, 0.01578035128364876);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01578035112921925);
    AssertAlmostEqual(&test, rTM, 0.01578035143502024);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01578033599208513);
    AssertAlmostEqual(&test, rTM, 0.01578036657215437);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01577882242534768);
    AssertAlmostEqual(&test, rTM, 0.01578188013881803);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01562891842739411);
    AssertAlmostEqual(&test, rTM, 0.0159317834129214);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.008015168774702205);
    AssertAlmostEqual(&test, rTM, 0.02354363073291289);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001612393983638353);
    AssertAlmostEqual(&test, rTM, 0.03139176560008819);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636008235125066);
    AssertAlmostEqual(&test, rTM, 0.0001636008235125066);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636008235125066);
    AssertAlmostEqual(&test, rTM, 0.0001636008235125066);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636008235125066);
    AssertAlmostEqual(&test, rTM, 0.0001636008235125066);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636008235125066);
    AssertAlmostEqual(&test, rTM, 0.0001636008235125066);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636008235125066);
    AssertAlmostEqual(&test, rTM, 0.0001636008235125066);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000163600823512505);
    AssertAlmostEqual(&test, rTM, 0.0001636008235125082);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000163600823512343);
    AssertAlmostEqual(&test, rTM, 0.0001636008235126701);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636008234961518);
    AssertAlmostEqual(&test, rTM, 0.0001636008235288613);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636008218770336);
    AssertAlmostEqual(&test, rTM, 0.0001636008251479796);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001636006599653683);
    AssertAlmostEqual(&test, rTM, 0.0001636009870596449);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001635844704171002);
    AssertAlmostEqual(&test, rTM, 0.0001636171766079129);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001619815380519809);
    AssertAlmostEqual(&test, rTM, 0.0001652201089721743);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -8.181379491824241e-05);
    AssertAlmostEqual(&test, rTM, 0.0002453878499180803);

    userdata[0] = 100/CAPS_HBAR_EV; /* 100eV */
    userdata[1] = 1e-05/CAPS_HBAR_EV; /* 1e-05eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999960461521);
    AssertAlmostEqual(&test, rTM, 0.999999998023076);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999719026318);
    AssertAlmostEqual(&test, rTM, 0.9999999997218082);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999999720406793);
    AssertAlmostEqual(&test, rTM, 0.9999999999720435);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999972042098354);
    AssertAlmostEqual(&test, rTM, 0.9999999999972042);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999720424639305);
    AssertAlmostEqual(&test, rTM, 0.9999999999997204);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997204598120395);
    AssertAlmostEqual(&test, rTM, 0.999999999999972);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9972081128217084);
    AssertAlmostEqual(&test, rTM, 0.9999999999999972);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9724301645686362);
    AssertAlmostEqual(&test, rTM, 0.9999999999999997);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7567845829364064);
    AssertAlmostEqual(&test, rTM, 1);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1029494263746385);
    AssertAlmostEqual(&test, rTM, 1);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001276089014522639);
    AssertAlmostEqual(&test, rTM, 1);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279319331667342e-05);
    AssertAlmostEqual(&test, rTM, 1);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279351738106306e-07);
    AssertAlmostEqual(&test, rTM, 1);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999911070252);
    AssertAlmostEqual(&test, rTM, 0.9999999911950744);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999874858496);
    AssertAlmostEqual(&test, rTM, 0.9999999937429248);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999110702558);
    AssertAlmostEqual(&test, rTM, 0.9999999991195074);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999991150720806);
    AssertAlmostEqual(&test, rTM, 0.999999999911516);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999991151194048);
    AssertAlmostEqual(&test, rTM, 0.9999999999911512);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999115155077846);
    AssertAlmostEqual(&test, rTM, 0.9999999999991152);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991155073553979);
    AssertAlmostEqual(&test, rTM, 0.9999999999999115);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9911902237023318);
    AssertAlmostEqual(&test, rTM, 0.9999999999999911);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9153401244070482);
    AssertAlmostEqual(&test, rTM, 0.9999999999999991);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4238840386576299);
    AssertAlmostEqual(&test, rTM, 0.9999999999999999);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.012454924626766);
    AssertAlmostEqual(&test, rTM, 1);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001276780795136403);
    AssertAlmostEqual(&test, rTM, 1);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.277103629434253e-06);
    AssertAlmostEqual(&test, rTM, 1);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999033471857);
    AssertAlmostEqual(&test, rTM, 0.9999999033472824);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999033424015);
    AssertAlmostEqual(&test, rTM, 0.9999999033520663);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999028651724);
    AssertAlmostEqual(&test, rTM, 0.9999999038269033);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999998633123502);
    AssertAlmostEqual(&test, rTM, 0.9999999316561728);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999990286521486);
    AssertAlmostEqual(&test, rTM, 0.9999999903826899);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999903342863996);
    AssertAlmostEqual(&test, rTM, 0.9999999990335207);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999033518518242);
    AssertAlmostEqual(&test, rTM, 0.9999999999033473);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.99903393926401);
    AssertAlmostEqual(&test, rTM, 0.9999999999903347);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9903813188651513);
    AssertAlmostEqual(&test, rTM, 0.9999999999990334);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9079053108835915);
    AssertAlmostEqual(&test, rTM, 0.9999999999999032);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3936136762641851);
    AssertAlmostEqual(&test, rTM, 0.9999999999999892);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01048140030973246);
    AssertAlmostEqual(&test, rTM, 0.9999999999999952);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001070233201797371);
    AssertAlmostEqual(&test, rTM, 0.9999999999999953);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999995195501988);
    AssertAlmostEqual(&test, rTM, 0.9999995195502036);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999999519549961);
    AssertAlmostEqual(&test, rTM, 0.9999995195504414);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999995195261793);
    AssertAlmostEqual(&test, rTM, 0.9999995195742218);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999995171539285);
    AssertAlmostEqual(&test, rTM, 0.9999995219345816);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999993205414461);
    AssertAlmostEqual(&test, rTM, 0.9999996602706653);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999995171549777);
    AssertAlmostEqual(&test, rTM, 0.9999999521934478);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999519537606519);
    AssertAlmostEqual(&test, rTM, 0.9999999951957411);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995196652478804);
    AssertAlmostEqual(&test, rTM, 0.9999999995195503);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9952070285771343);
    AssertAlmostEqual(&test, rTM, 0.9999999999519549);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9530953082676863);
    AssertAlmostEqual(&test, rTM, 0.9999999999951941);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.62129766634881);
    AssertAlmostEqual(&test, rTM, 0.9999999999995058);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03993086986313568);
    AssertAlmostEqual(&test, rTM, 0.999999999999875);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004328403284718462);
    AssertAlmostEqual(&test, rTM, 0.9999999999998845);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999959937909639);
    AssertAlmostEqual(&test, rTM, 0.9999959937909643);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999959937909441);
    AssertAlmostEqual(&test, rTM, 0.9999959937909841);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999995993788961);
    AssertAlmostEqual(&test, rTM, 0.9999959937929672);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999995993590659);
    AssertAlmostEqual(&test, rTM, 0.9999959939912592);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999959738097879);
    AssertAlmostEqual(&test, rTM, 0.9999960136729779);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999943343695485);
    AssertAlmostEqual(&test, rTM, 0.9999971671807618);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999597388273332);
    AssertAlmostEqual(&test, rTM, 0.9999996013665826);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995994385121977);
    AssertAlmostEqual(&test, rTM, 0.9999999599398324);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960017977943237);
    AssertAlmostEqual(&test, rTM, 0.9999999959937769);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9607322814022283);
    AssertAlmostEqual(&test, rTM, 0.999999999599298);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6716688548350638);
    AssertAlmostEqual(&test, rTM, 0.999999999959142);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05557345736892789);
    AssertAlmostEqual(&test, rTM, 0.9999999999910307);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006222864841845773);
    AssertAlmostEqual(&test, rTM, 0.9999999999919651);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999608262456814);
    AssertAlmostEqual(&test, rTM, 0.9999608262456815);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999608262456795);
    AssertAlmostEqual(&test, rTM, 0.9999608262456834);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999608262454855);
    AssertAlmostEqual(&test, rTM, 0.9999608262458773);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999608262260949);
    AssertAlmostEqual(&test, rTM, 0.9999608262652679);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999608242870811);
    AssertAlmostEqual(&test, rTM, 0.999960828204184);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999606308679947);
    AssertAlmostEqual(&test, rTM, 0.9999610206537838);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999446003948296);
    AssertAlmostEqual(&test, rTM, 0.9999722998137593);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996063784219263);
    AssertAlmostEqual(&test, rTM, 0.9999961019969299);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960900184360915);
    AssertAlmostEqual(&test, rTM, 0.9999996082736948);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9615852669655287);
    AssertAlmostEqual(&test, rTM, 0.9999999608179846);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6775428043036372);
    AssertAlmostEqual(&test, rTM, 0.9999999960081065);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05784161747809035);
    AssertAlmostEqual(&test, rTM, 0.9999999991384626);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006507694559146436);
    AssertAlmostEqual(&test, rTM, 0.999999999231679);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996092298931512);
    AssertAlmostEqual(&test, rTM, 0.9996092298931512);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996092298931509);
    AssertAlmostEqual(&test, rTM, 0.9996092298931514);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996092298931316);
    AssertAlmostEqual(&test, rTM, 0.9996092298931707);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996092298911977);
    AssertAlmostEqual(&test, rTM, 0.9996092298951046);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996092296978043);
    AssertAlmostEqual(&test, rTM, 0.9996092300884979);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996092103589527);
    AssertAlmostEqual(&test, rTM, 0.9996092494263734);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996072812857492);
    AssertAlmostEqual(&test, rTM, 0.9996111688337552);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994474123472222);
    AssertAlmostEqual(&test, rTM, 0.9997236679886464);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960797483438886);
    AssertAlmostEqual(&test, rTM, 0.9999611100043976);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616698153960996);
    AssertAlmostEqual(&test, rTM, 0.9999960909921072);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6781405414440712);
    AssertAlmostEqual(&test, rTM, 0.9999996017604724);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05807869224247873);
    AssertAlmostEqual(&test, rTM, 0.9999999142003085);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006537618203483704);
    AssertAlmostEqual(&test, rTM, 0.9999999235195858);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9961000621483651);
    AssertAlmostEqual(&test, rTM, 0.9961000621483651);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9961000621483651);
    AssertAlmostEqual(&test, rTM, 0.9961000621483652);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9961000621483632);
    AssertAlmostEqual(&test, rTM, 0.9961000621483671);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9961000621481706);
    AssertAlmostEqual(&test, rTM, 0.9961000621485597);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9961000621289036);
    AssertAlmostEqual(&test, rTM, 0.9961000621678268);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9961000602022065);
    AssertAlmostEqual(&test, rTM, 0.9961000640945228);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960998675373376);
    AssertAlmostEqual(&test, rTM, 0.9961002567497009);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960806491587605);
    AssertAlmostEqual(&test, rTM, 0.9961193791701651);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9944891166556792);
    AssertAlmostEqual(&test, rTM, 0.997240746342882);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.961492976704328);
    AssertAlmostEqual(&test, rTM, 0.9996111848995725);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.678187561349761);
    AssertAlmostEqual(&test, rTM, 0.9999601883865873);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810245585873237);
    AssertAlmostEqual(&test, rTM, 0.9999914236410903);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540625645704668);
    AssertAlmostEqual(&test, rTM, 0.9999923555331179);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616812118685054);
    AssertAlmostEqual(&test, rTM, 0.9616812118685054);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616812118685054);
    AssertAlmostEqual(&test, rTM, 0.9616812118685054);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616812118685052);
    AssertAlmostEqual(&test, rTM, 0.9616812118685056);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616812118684867);
    AssertAlmostEqual(&test, rTM, 0.9616812118685242);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616812118666269);
    AssertAlmostEqual(&test, rTM, 0.9616812118703839);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.961681211680654);
    AssertAlmostEqual(&test, rTM, 0.9616812120563568);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616811930833691);
    AssertAlmostEqual(&test, rTM, 0.9616812306536328);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616793334031958);
    AssertAlmostEqual(&test, rTM, 0.9616830902435319);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9614938461845235);
    AssertAlmostEqual(&test, rTM, 0.9618676835804397);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9462457064406125);
    AssertAlmostEqual(&test, rTM, 0.9727464893294937);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6769106994107257);
    AssertAlmostEqual(&test, rTM, 0.9960470184002851);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05809971826867312);
    AssertAlmostEqual(&test, rTM, 0.9991430959026784);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540920081542526);
    AssertAlmostEqual(&test, rTM, 0.9992361661461727);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6782071551070262);
    AssertAlmostEqual(&test, rTM, 0.6782071551070262);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6782071551070262);
    AssertAlmostEqual(&test, rTM, 0.6782071551070262);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6782071551070262);
    AssertAlmostEqual(&test, rTM, 0.6782071551070262);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6782071551070249);
    AssertAlmostEqual(&test, rTM, 0.6782071551070274);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6782071551068961);
    AssertAlmostEqual(&test, rTM, 0.6782071551071562);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6782071550940217);
    AssertAlmostEqual(&test, rTM, 0.6782071551200307);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6782071538065776);
    AssertAlmostEqual(&test, rTM, 0.6782071564074748);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6782070250622152);
    AssertAlmostEqual(&test, rTM, 0.6782072851517947);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6781941510830253);
    AssertAlmostEqual(&test, rTM, 0.6782201587062983);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6769113001968924);
    AssertAlmostEqual(&test, rTM, 0.6794988059280355);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5793785588515646);
    AssertAlmostEqual(&test, rTM, 0.7573821884608083);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05759247204312549);
    AssertAlmostEqual(&test, rTM, 0.9207477559099844);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540303530407374);
    AssertAlmostEqual(&test, rTM, 0.928983663766342);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810515223361641);
    AssertAlmostEqual(&test, rTM, 0.05810515223361641);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810515223361641);
    AssertAlmostEqual(&test, rTM, 0.05810515223361641);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810515223361641);
    AssertAlmostEqual(&test, rTM, 0.05810515223361641);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810515223361641);
    AssertAlmostEqual(&test, rTM, 0.05810515223361642);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0581051522336159);
    AssertAlmostEqual(&test, rTM, 0.05810515223361693);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810515223356469);
    AssertAlmostEqual(&test, rTM, 0.05810515223366813);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810515222844406);
    AssertAlmostEqual(&test, rTM, 0.05810515223878877);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810515171638102);
    AssertAlmostEqual(&test, rTM, 0.0581051527508518);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810510051012322);
    AssertAlmostEqual(&test, rTM, 0.05810520395710929);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05809998034162416);
    AssertAlmostEqual(&test, rTM, 0.0581103241224897);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05759249568399737);
    AssertAlmostEqual(&test, rTM, 0.05861777813958861);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03076373860873307);
    AssertAlmostEqual(&test, rTM, 0.08535967522988967);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006476281566342813);
    AssertAlmostEqual(&test, rTM, 0.1151802856893036);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540960015838971);
    AssertAlmostEqual(&test, rTM, 0.0006540960015838971);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540960015838971);
    AssertAlmostEqual(&test, rTM, 0.0006540960015838971);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540960015838971);
    AssertAlmostEqual(&test, rTM, 0.0006540960015838971);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540960015838971);
    AssertAlmostEqual(&test, rTM, 0.0006540960015838971);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540960015838971);
    AssertAlmostEqual(&test, rTM, 0.0006540960015838972);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540960015838906);
    AssertAlmostEqual(&test, rTM, 0.0006540960015839038);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540960015832439);
    AssertAlmostEqual(&test, rTM, 0.0006540960015845505);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540960015185731);
    AssertAlmostEqual(&test, rTM, 0.0006540960016492213);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540959950514885);
    AssertAlmostEqual(&test, rTM, 0.0006540960081163059);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540953483436718);
    AssertAlmostEqual(&test, rTM, 0.0006540966548241226);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540306840193414);
    AssertAlmostEqual(&test, rTM, 0.0006541613191484474);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006476281864290911);
    AssertAlmostEqual(&test, rTM, 0.0006605638166839782);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003272619565398874);
    AssertAlmostEqual(&test, rTM, 0.0009809299068861922);

    userdata[0] = 100/CAPS_HBAR_EV; /* 100eV */
    userdata[1] = 0.0001/CAPS_HBAR_EV; /* 0.0001eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999874979342);
    AssertAlmostEqual(&test, rTM, 0.9999999937489671);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999111561333);
    AssertAlmostEqual(&test, rTM, 0.9999999991203578);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999991159266357);
    AssertAlmostEqual(&test, rTM, 0.9999999999116015);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999991159739108);
    AssertAlmostEqual(&test, rTM, 0.9999999999911597);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999116009515414);
    AssertAlmostEqual(&test, rTM, 0.9999999999991159);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991163611130081);
    AssertAlmostEqual(&test, rTM, 0.9999999999999116);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9911986935063987);
    AssertAlmostEqual(&test, rTM, 0.9999999999999911);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.915418268387898);
    AssertAlmostEqual(&test, rTM, 0.9999999999999991);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4242154357920784);
    AssertAlmostEqual(&test, rTM, 0.9999999999999999);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01247842060860464);
    AssertAlmostEqual(&test, rTM, 1);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001279249658356818);
    AssertAlmostEqual(&test, rTM, 1);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279573742484986e-06);
    AssertAlmostEqual(&test, rTM, 1);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.27957698436285e-08);
    AssertAlmostEqual(&test, rTM, 1);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999719026318);
    AssertAlmostEqual(&test, rTM, 0.9999999721808235);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999604615216);
    AssertAlmostEqual(&test, rTM, 0.9999999802307606);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999999719026353);
    AssertAlmostEqual(&test, rTM, 0.9999999972180823);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999972040714475);
    AssertAlmostEqual(&test, rTM, 0.9999999997204347);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999720424500917);
    AssertAlmostEqual(&test, rTM, 0.9999999999720421);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997204598106559);
    AssertAlmostEqual(&test, rTM, 0.9999999999972042);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9972081128215704);
    AssertAlmostEqual(&test, rTM, 0.9999999999997204);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9724301645686226);
    AssertAlmostEqual(&test, rTM, 0.999999999999972);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7567845829364053);
    AssertAlmostEqual(&test, rTM, 0.9999999999999972);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1029494263746385);
    AssertAlmostEqual(&test, rTM, 0.9999999999999996);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001276089014522639);
    AssertAlmostEqual(&test, rTM, 0.9999999999999996);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279319331667343e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999999996);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279351738106307e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999999996);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999997177302993);
    AssertAlmostEqual(&test, rTM, 0.9999997177305816);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999997177163273);
    AssertAlmostEqual(&test, rTM, 0.9999997177445529);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999997163226036);
    AssertAlmostEqual(&test, rTM, 0.9999997191312904);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999996008105839);
    AssertAlmostEqual(&test, rTM, 0.999999800405272);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999997163229658);
    AssertAlmostEqual(&test, rTM, 0.9999999719131255);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999717720271645);
    AssertAlmostEqual(&test, rTM, 0.9999999971774451);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997177700947526);
    AssertAlmostEqual(&test, rTM, 0.9999999997177306);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9971812849869506);
    AssertAlmostEqual(&test, rTM, 0.999999999971773);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9721686095633408);
    AssertAlmostEqual(&test, rTM, 0.999999999997177);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7547710571430476);
    AssertAlmostEqual(&test, rTM, 0.9999999999997149);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1013555584664559);
    AssertAlmostEqual(&test, rTM, 0.9999999999999512);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001251940483430572);
    AssertAlmostEqual(&test, rTM, 0.99999999999996);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.255049586343556e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999999601);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999990334727561);
    AssertAlmostEqual(&test, rTM, 0.9999990334727658);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999990334722776);
    AssertAlmostEqual(&test, rTM, 0.9999990334732441);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999990334244357);
    AssertAlmostEqual(&test, rTM, 0.9999990335210835);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999990286521486);
    AssertAlmostEqual(&test, rTM, 0.9999990382694495);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999986331243437);
    AssertAlmostEqual(&test, rTM, 0.9999993165619383);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999902865639441);
    AssertAlmostEqual(&test, rTM, 0.9999999038269033);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999033470680952);
    AssertAlmostEqual(&test, rTM, 0.9999999903352061);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9990339387860411);
    AssertAlmostEqual(&test, rTM, 0.9999999990334727);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9903813188177689);
    AssertAlmostEqual(&test, rTM, 0.9999999999033461);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9079053108792529);
    AssertAlmostEqual(&test, rTM, 0.9999999999903234);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3936136762640156);
    AssertAlmostEqual(&test, rTM, 0.9999999999989265);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01048140030973236);
    AssertAlmostEqual(&test, rTM, 0.999999999999523);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000107023320179737);
    AssertAlmostEqual(&test, rTM, 0.9999999999995328);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999951955123992);
    AssertAlmostEqual(&test, rTM, 0.9999951955123998);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999951955123755);
    AssertAlmostEqual(&test, rTM, 0.9999951955124236);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999951955099973);
    AssertAlmostEqual(&test, rTM, 0.9999951955148018);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999951952721817);
    AssertAlmostEqual(&test, rTM, 0.9999951957526053);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999995171549777);
    AssertAlmostEqual(&test, rTM, 0.9999952193561006);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999932054352361);
    AssertAlmostEqual(&test, rTM, 0.9999966027118472);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999517165468885);
    AssertAlmostEqual(&test, rTM, 0.9999995219345814);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995196414776343);
    AssertAlmostEqual(&test, rTM, 0.9999999519574104);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9952070262103134);
    AssertAlmostEqual(&test, rTM, 0.9999999951954894);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.953095308041084);
    AssertAlmostEqual(&test, rTM, 0.9999999995194114);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6212976663344429);
    AssertAlmostEqual(&test, rTM, 0.9999999999505882);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03993086986309919);
    AssertAlmostEqual(&test, rTM, 0.9999999999874983);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004328403284718419);
    AssertAlmostEqual(&test, rTM, 0.9999999999884484);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999599386318727);
    AssertAlmostEqual(&test, rTM, 0.9999599386318727);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999599386318707);
    AssertAlmostEqual(&test, rTM, 0.9999599386318747);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999599386316724);
    AssertAlmostEqual(&test, rTM, 0.999959938632073);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999599386118425);
    AssertAlmostEqual(&test, rTM, 0.999959938651903);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999599366288945);
    AssertAlmostEqual(&test, rTM, 0.9999599406347508);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999597388273332);
    AssertAlmostEqual(&test, rTM, 0.9999601374448599);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999433451399429);
    AssertAlmostEqual(&test, rTM, 0.9999716721687327);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999597461211484);
    AssertAlmostEqual(&test, rTM, 0.9999960136728987);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960016002848565);
    AssertAlmostEqual(&test, rTM, 0.9999995993976001);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9607322623539892);
    AssertAlmostEqual(&test, rTM, 0.9999999599298137);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6716688535290366);
    AssertAlmostEqual(&test, rTM, 0.9999999959141999);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05557345736400543);
    AssertAlmostEqual(&test, rTM, 0.9999999991030686);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000622286484183962);
    AssertAlmostEqual(&test, rTM, 0.9999999991965118);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996083315083164);
    AssertAlmostEqual(&test, rTM, 0.9996083315083164);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996083315083162);
    AssertAlmostEqual(&test, rTM, 0.9996083315083165);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996083315082968);
    AssertAlmostEqual(&test, rTM, 0.9996083315083359);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996083315063584);
    AssertAlmostEqual(&test, rTM, 0.9996083315102743);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996083313125205);
    AssertAlmostEqual(&test, rTM, 0.9996083317041121);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996083119292173);
    AssertAlmostEqual(&test, rTM, 0.999608351086437);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996063784219263);
    AssertAlmostEqual(&test, rTM, 0.9996102749056974);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994461420451362);
    AssertAlmostEqual(&test, rTM, 0.9997230326618041);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960707516207764);
    AssertAlmostEqual(&test, rTM, 0.9999610205797514);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9615834027246973);
    AssertAlmostEqual(&test, rTM, 0.9999960820000685);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6775426753688116);
    AssertAlmostEqual(&test, rTM, 0.9999996008109355);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05784161696808011);
    AssertAlmostEqual(&test, rTM, 0.9999999138462661);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006507694558503013);
    AssertAlmostEqual(&test, rTM, 0.9999999231679138);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960991657865778);
    AssertAlmostEqual(&test, rTM, 0.9960991657865778);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960991657865778);
    AssertAlmostEqual(&test, rTM, 0.9960991657865778);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960991657865758);
    AssertAlmostEqual(&test, rTM, 0.9960991657865796);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.996099165786383);
    AssertAlmostEqual(&test, rTM, 0.9960991657867724);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960991657671117);
    AssertAlmostEqual(&test, rTM, 0.9960991658060437);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960991638399727);
    AssertAlmostEqual(&test, rTM, 0.9960991677331819);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960989711309085);
    AssertAlmostEqual(&test, rTM, 0.996099360432553);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960797483438886);
    AssertAlmostEqual(&test, rTM, 0.9961184872395348);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9944878510614401);
    AssertAlmostEqual(&test, rTM, 0.9972401117910541);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9614842830471967);
    AssertAlmostEqual(&test, rTM, 0.999611095342902);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6781276655572938);
    AssertAlmostEqual(&test, rTM, 0.9999601788813732);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05807864105682105);
    AssertAlmostEqual(&test, rTM, 0.999991420100616);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006537618138845855);
    AssertAlmostEqual(&test, rTM, 0.9999923520164502);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616803465331276);
    AssertAlmostEqual(&test, rTM, 0.9616803465331276);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616803465331276);
    AssertAlmostEqual(&test, rTM, 0.9616803465331276);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616803465331274);
    AssertAlmostEqual(&test, rTM, 0.9616803465331278);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616803465331089);
    AssertAlmostEqual(&test, rTM, 0.9616803465331464);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616803465312491);
    AssertAlmostEqual(&test, rTM, 0.9616803465350062);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616803463452721);
    AssertAlmostEqual(&test, rTM, 0.9616803467209832);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616803277475757);
    AssertAlmostEqual(&test, rTM, 0.9616803653186705);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616784680262591);
    AssertAlmostEqual(&test, rTM, 0.9616822249497111);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.961492976704328);
    AssertAlmostEqual(&test, rTM, 0.961866822370922);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9462445025436315);
    AssertAlmostEqual(&test, rTM, 0.9727458701683818);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.676904691657316);
    AssertAlmostEqual(&test, rTM, 0.9960469242294955);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05809733589610714);
    AssertAlmostEqual(&test, rTM, 0.9991430605561675);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540619178956598);
    AssertAlmostEqual(&test, rTM, 0.9992361310326453);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6782065560479311);
    AssertAlmostEqual(&test, rTM, 0.6782065560479311);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6782065560479311);
    AssertAlmostEqual(&test, rTM, 0.6782065560479311);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6782065560479311);
    AssertAlmostEqual(&test, rTM, 0.6782065560479311);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6782065560479298);
    AssertAlmostEqual(&test, rTM, 0.6782065560479323);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.678206556047801);
    AssertAlmostEqual(&test, rTM, 0.6782065560480611);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6782065560349265);
    AssertAlmostEqual(&test, rTM, 0.6782065560609356);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6782065547474808);
    AssertAlmostEqual(&test, rTM, 0.6782065573483814);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6782064260029463);
    AssertAlmostEqual(&test, rTM, 0.6782066860928733);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6781935520065663);
    AssertAlmostEqual(&test, rTM, 0.6782195596645669);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6769106994107257);
    AssertAlmostEqual(&test, rTM, 0.6794982085948307);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5793778480571923);
    AssertAlmostEqual(&test, rTM, 0.7573816987141847);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05759223563547784);
    AssertAlmostEqual(&test, rTM, 0.9207474542940628);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540273441597037);
    AssertAlmostEqual(&test, rTM, 0.9289833602544622);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810512840683112);
    AssertAlmostEqual(&test, rTM, 0.05810512840683112);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810512840683112);
    AssertAlmostEqual(&test, rTM, 0.05810512840683112);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810512840683112);
    AssertAlmostEqual(&test, rTM, 0.05810512840683112);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810512840683112);
    AssertAlmostEqual(&test, rTM, 0.05810512840683113);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810512840683061);
    AssertAlmostEqual(&test, rTM, 0.05810512840683164);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0581051284067794);
    AssertAlmostEqual(&test, rTM, 0.05810512840688285);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810512840165877);
    AssertAlmostEqual(&test, rTM, 0.05810512841200348);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810512788959592);
    AssertAlmostEqual(&test, rTM, 0.05810512892406633);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810507668335668);
    AssertAlmostEqual(&test, rTM, 0.05810518013030527);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0580999565167124);
    AssertAlmostEqual(&test, rTM, 0.05811030029383089);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0575924720431255);
    AssertAlmostEqual(&test, rTM, 0.05861775412692477);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.030763725283131);
    AssertAlmostEqual(&test, rTM, 0.08535964100431837);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006476278586863367);
    AssertAlmostEqual(&test, rTM, 0.1151802388026324);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540959714919183);
    AssertAlmostEqual(&test, rTM, 0.0006540959714919183);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540959714919183);
    AssertAlmostEqual(&test, rTM, 0.0006540959714919183);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540959714919183);
    AssertAlmostEqual(&test, rTM, 0.0006540959714919183);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540959714919183);
    AssertAlmostEqual(&test, rTM, 0.0006540959714919183);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540959714919182);
    AssertAlmostEqual(&test, rTM, 0.0006540959714919184);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540959714919118);
    AssertAlmostEqual(&test, rTM, 0.0006540959714919248);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540959714912651);
    AssertAlmostEqual(&test, rTM, 0.0006540959714925715);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540959714265943);
    AssertAlmostEqual(&test, rTM, 0.0006540959715572424);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540959649595099);
    AssertAlmostEqual(&test, rTM, 0.0006540959780243267);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000654095318251723);
    AssertAlmostEqual(&test, rTM, 0.0006540966247321136);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540306539303635);
    AssertAlmostEqual(&test, rTM, 0.0006541612890534675);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006476281566342815);
    AssertAlmostEqual(&test, rTM, 0.00066056378629483);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.00032726194147421);
    AssertAlmostEqual(&test, rTM, 0.0009809298617679311);

    userdata[0] = 100/CAPS_HBAR_EV; /* 100eV */
    userdata[1] = 0.001/CAPS_HBAR_EV; /* 0.001eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999604653448);
    AssertAlmostEqual(&test, rTM, 0.9999999802326722);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999997190535219);
    AssertAlmostEqual(&test, rTM, 0.9999999972183513);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999972043418009);
    AssertAlmostEqual(&test, rTM, 0.9999999997204617);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999720451534243);
    AssertAlmostEqual(&test, rTM, 0.9999999999720448);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997204868371676);
    AssertAlmostEqual(&test, rTM, 0.9999999999972045);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9972083824072684);
    AssertAlmostEqual(&test, rTM, 0.9999999999997204);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.972432793189756);
    AssertAlmostEqual(&test, rTM, 0.999999999999972);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7568048451796882);
    AssertAlmostEqual(&test, rTM, 0.9999999999999972);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1029656209569059);
    AssertAlmostEqual(&test, rTM, 0.9999999999999996);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001276335205310115);
    AssertAlmostEqual(&test, rTM, 0.9999999999999996);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279566770174752e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999999996);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279599189150777e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999999996);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279599513350907e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999999999996);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999111561333);
    AssertAlmostEqual(&test, rTM, 0.9999999120357754);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999998749793493);
    AssertAlmostEqual(&test, rTM, 0.9999999374896726);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999991115616876);
    AssertAlmostEqual(&test, rTM, 0.9999999912035772);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999911593015284);
    AssertAlmostEqual(&test, rTM, 0.9999999991160147);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999116009077859);
    AssertAlmostEqual(&test, rTM, 0.999999999911597);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999116361108636);
    AssertAlmostEqual(&test, rTM, 0.9999999999911597);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9911986935059649);
    AssertAlmostEqual(&test, rTM, 0.9999999999991159);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.915418268387858);
    AssertAlmostEqual(&test, rTM, 0.9999999999999115);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4242154357920767);
    AssertAlmostEqual(&test, rTM, 0.9999999999999903);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01247842060860464);
    AssertAlmostEqual(&test, rTM, 0.999999999999996);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001279249658356818);
    AssertAlmostEqual(&test, rTM, 0.9999999999999961);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279573742484986e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999999961);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.27957698436285e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999999961);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999991151158812);
    AssertAlmostEqual(&test, rTM, 0.9999991151167661);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999991150720806);
    AssertAlmostEqual(&test, rTM, 0.9999991151605645);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999991107029134);
    AssertAlmostEqual(&test, rTM, 0.999999119507831);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999987485857331);
    AssertAlmostEqual(&test, rTM, 0.9999993742926708);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999911070647214);
    AssertAlmostEqual(&test, rTM, 0.9999999119507482);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999115110843088);
    AssertAlmostEqual(&test, rTM, 0.9999999911516018);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991155069133915);
    AssertAlmostEqual(&test, rTM, 0.9999999991151163);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9911902236584822);
    AssertAlmostEqual(&test, rTM, 0.9999999999115107);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9153401244030027);
    AssertAlmostEqual(&test, rTM, 0.9999999999911425);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4238840386574583);
    AssertAlmostEqual(&test, rTM, 0.9999999999990323);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01245492462676588);
    AssertAlmostEqual(&test, rTM, 0.9999999999995987);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001276780795136403);
    AssertAlmostEqual(&test, rTM, 0.9999999999996084);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.277103629434253e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999996085);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999971773079757);
    AssertAlmostEqual(&test, rTM, 0.9999971773080039);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999971773065784);
    AssertAlmostEqual(&test, rTM, 0.9999971773094011);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999971771668589);
    AssertAlmostEqual(&test, rTM, 0.9999971774491135);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999997163229658);
    AssertAlmostEqual(&test, rTM, 0.9999971913164536);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999960081130104);
    AssertAlmostEqual(&test, rTM, 0.9999980040545133);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999716326587051);
    AssertAlmostEqual(&test, rTM, 0.9999997191312904);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997177561267038);
    AssertAlmostEqual(&test, rTM, 0.9999999717744514);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9971812835936562);
    AssertAlmostEqual(&test, rTM, 0.9999999971773026);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9721686094275196);
    AssertAlmostEqual(&test, rTM, 0.9999999997177023);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7547710571326052);
    AssertAlmostEqual(&test, rTM, 0.9999999999714932);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.101355558466374);
    AssertAlmostEqual(&test, rTM, 0.9999999999951176);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.00125194048343056);
    AssertAlmostEqual(&test, rTM, 0.9999999999960062);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.255049586343556e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999960161);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999903347696462);
    AssertAlmostEqual(&test, rTM, 0.9999903347696472);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999903347695983);
    AssertAlmostEqual(&test, rTM, 0.999990334769695);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999990334764814);
    AssertAlmostEqual(&test, rTM, 0.9999903347744793);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999903342863996);
    AssertAlmostEqual(&test, rTM, 0.9999903352528696);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999902865639441);
    AssertAlmostEqual(&test, rTM, 0.9999903827361158);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999986331327512);
    AssertAlmostEqual(&test, rTM, 0.9999931656404017);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999028698851563);
    AssertAlmostEqual(&test, rTM, 0.9999990382694484);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9990338909903526);
    AssertAlmostEqual(&test, rTM, 0.999999903352055);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9903813140795321);
    AssertAlmostEqual(&test, rTM, 0.999999990334615);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.907905310445389);
    AssertAlmostEqual(&test, rTM, 0.9999999990323444);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3936136762470601);
    AssertAlmostEqual(&test, rTM, 0.9999999998926525);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0104814003097222);
    AssertAlmostEqual(&test, rTM, 0.9999999999523017);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000107023320179736);
    AssertAlmostEqual(&test, rTM, 0.9999999999532813);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999951956162726);
    AssertAlmostEqual(&test, rTM, 0.999951956162726);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999519561627236);
    AssertAlmostEqual(&test, rTM, 0.9999519561627284);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999519561624858);
    AssertAlmostEqual(&test, rTM, 0.9999519561629662);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999519561387047);
    AssertAlmostEqual(&test, rTM, 0.9999519561867474);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999519537606519);
    AssertAlmostEqual(&test, rTM, 0.99995195856468);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999517165468885);
    AssertAlmostEqual(&test, rTM, 0.9999521945894526);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999320564298108);
    AssertAlmostEqual(&test, rTM, 0.9999660276378348);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995172703681532);
    AssertAlmostEqual(&test, rTM, 0.999995219355964);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.995206789534171);
    AssertAlmostEqual(&test, rTM, 0.9999995195728358);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9530952853808567);
    AssertAlmostEqual(&test, rTM, 0.9999999519411729);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6212976648977295);
    AssertAlmostEqual(&test, rTM, 0.9999999950588161);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03993086985944962);
    AssertAlmostEqual(&test, rTM, 0.9999999987498325);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004328403284714138);
    AssertAlmostEqual(&test, rTM, 0.9999999988448398);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995994585347585);
    AssertAlmostEqual(&test, rTM, 0.9995994585347585);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995994585347583);
    AssertAlmostEqual(&test, rTM, 0.9995994585347587);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995994585347385);
    AssertAlmostEqual(&test, rTM, 0.9995994585347786);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995994585327562);
    AssertAlmostEqual(&test, rTM, 0.9995994585367608);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999599458334528);
    AssertAlmostEqual(&test, rTM, 0.999599458734989);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995994385121977);
    AssertAlmostEqual(&test, rTM, 0.9995994785563188);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999597461211484);
    AssertAlmostEqual(&test, rTM, 0.9996014459496585);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994335958248992);
    AssertAlmostEqual(&test, rTM, 0.9997167577936958);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9959818986610083);
    AssertAlmostEqual(&test, rTM, 0.9999601373656802);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9607303575796227);
    AssertAlmostEqual(&test, rTM, 0.9999959931877275);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6716687229263597);
    AssertAlmostEqual(&test, rTM, 0.9999995914202754);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05557345687175928);
    AssertAlmostEqual(&test, rTM, 0.9999999103068666);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006222864841224322);
    AssertAlmostEqual(&test, rTM, 0.9999999196511929);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960902135376087);
    AssertAlmostEqual(&test, rTM, 0.9960902135376087);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960902135376086);
    AssertAlmostEqual(&test, rTM, 0.9960902135376087);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960902135376067);
    AssertAlmostEqual(&test, rTM, 0.9960902135376106);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960902135374136);
    AssertAlmostEqual(&test, rTM, 0.9960902135378038);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.996090213518098);
    AssertAlmostEqual(&test, rTM, 0.9960902135571194);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960902115865451);
    AssertAlmostEqual(&test, rTM, 0.9960902154886714);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960900184360915);
    AssertAlmostEqual(&test, rTM, 0.9960904086294098);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960707516207764);
    AssertAlmostEqual(&test, rTM, 0.996109579245716);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9944752111970168);
    AssertAlmostEqual(&test, rTM, 0.9972337743118063);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9613974606664578);
    AssertAlmostEqual(&test, rTM, 0.9996102009068103);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6775297823443511);
    AssertAlmostEqual(&test, rTM, 0.9999600839366958);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05784156596710271);
    AssertAlmostEqual(&test, rTM, 0.9999913846969479);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006507694494160637);
    AssertAlmostEqual(&test, rTM, 0.999992316849775);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616716943184992);
    AssertAlmostEqual(&test, rTM, 0.9616716943184992);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616716943184992);
    AssertAlmostEqual(&test, rTM, 0.9616716943184992);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.961671694318499);
    AssertAlmostEqual(&test, rTM, 0.9616716943184994);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616716943184804);
    AssertAlmostEqual(&test, rTM, 0.961671694318518);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616716943166203);
    AssertAlmostEqual(&test, rTM, 0.9616716943203781);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616716941306021);
    AssertAlmostEqual(&test, rTM, 0.9616716945063963);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616716755287918);
    AssertAlmostEqual(&test, rTM, 0.9616717131081975);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616698153960996);
    AssertAlmostEqual(&test, rTM, 0.9616735731505947);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9614842830471968);
    AssertAlmostEqual(&test, rTM, 0.9618582114092465);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9462324651838999);
    AssertAlmostEqual(&test, rTM, 0.9727396793627803);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.676844624946098);
    AssertAlmostEqual(&test, rTM, 0.9960459826289628);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05807352294817291);
    AssertAlmostEqual(&test, rTM, 0.9991427070922717);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006537611675067434);
    AssertAlmostEqual(&test, rTM, 0.9992357798975066);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6782005655647596);
    AssertAlmostEqual(&test, rTM, 0.6782005655647596);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6782005655647596);
    AssertAlmostEqual(&test, rTM, 0.6782005655647596);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6782005655647596);
    AssertAlmostEqual(&test, rTM, 0.6782005655647596);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6782005655647583);
    AssertAlmostEqual(&test, rTM, 0.6782005655647609);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6782005655646296);
    AssertAlmostEqual(&test, rTM, 0.6782005655648897);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6782005655517549);
    AssertAlmostEqual(&test, rTM, 0.6782005655777643);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.678200564264292);
    AssertAlmostEqual(&test, rTM, 0.6782005668652273);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6782004355180385);
    AssertAlmostEqual(&test, rTM, 0.6782006956114383);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.678187561349761);
    AssertAlmostEqual(&test, rTM, 0.6782135693550282);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.676904691657316);
    AssertAlmostEqual(&test, rTM, 0.6794922353700856);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5793707402578565);
    AssertAlmostEqual(&test, rTM, 0.7573768013257771);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05758987166609775);
    AssertAlmostEqual(&test, rTM, 0.9207444381466187);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000653997256871964);
    AssertAlmostEqual(&test, rTM, 0.9289803251465715);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810489014005665);
    AssertAlmostEqual(&test, rTM, 0.05810489014005665);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810489014005665);
    AssertAlmostEqual(&test, rTM, 0.05810489014005665);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810489014005665);
    AssertAlmostEqual(&test, rTM, 0.05810489014005665);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810489014005664);
    AssertAlmostEqual(&test, rTM, 0.05810489014005665);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810489014005613);
    AssertAlmostEqual(&test, rTM, 0.05810489014005716);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810489014000492);
    AssertAlmostEqual(&test, rTM, 0.05810489014010837);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810489013488431);
    AssertAlmostEqual(&test, rTM, 0.05810489014522897);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810488962282331);
    AssertAlmostEqual(&test, rTM, 0.05810489065728997);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810483841676956);
    AssertAlmostEqual(&test, rTM, 0.05810494186334342);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05809971826867313);
    AssertAlmostEqual(&test, rTM, 0.05811006200832122);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05759223563547786);
    AssertAlmostEqual(&test, rTM, 0.05861751400137221);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03076359202774576);
    AssertAlmostEqual(&test, rTM, 0.08535929875011762);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006476248792219675);
    AssertAlmostEqual(&test, rTM, 0.1151797699380199);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000654095670572282);
    AssertAlmostEqual(&test, rTM, 0.000654095670572282);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000654095670572282);
    AssertAlmostEqual(&test, rTM, 0.000654095670572282);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000654095670572282);
    AssertAlmostEqual(&test, rTM, 0.000654095670572282);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000654095670572282);
    AssertAlmostEqual(&test, rTM, 0.000654095670572282);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540956705722819);
    AssertAlmostEqual(&test, rTM, 0.000654095670572282);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540956705722754);
    AssertAlmostEqual(&test, rTM, 0.0006540956705722885);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540956705716288);
    AssertAlmostEqual(&test, rTM, 0.0006540956705729352);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540956705069579);
    AssertAlmostEqual(&test, rTM, 0.000654095670637606);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540956640398765);
    AssertAlmostEqual(&test, rTM, 0.0006540956771046874);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540950173323868);
    AssertAlmostEqual(&test, rTM, 0.0006540963238121772);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540303530407375);
    AssertAlmostEqual(&test, rTM, 0.0006541609881038209);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006476278586863368);
    AssertAlmostEqual(&test, rTM, 0.0006605634824035021);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003272617908175133);
    AssertAlmostEqual(&test, rTM, 0.0009809294105855479);

    userdata[0] = 100/CAPS_HBAR_EV; /* 100eV */
    userdata[1] = 0.003/CAPS_HBAR_EV; /* 0.003eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999315240141);
    AssertAlmostEqual(&test, rTM, 0.9999999657620064);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999995133867927);
    AssertAlmostEqual(&test, rTM, 0.9999999951820463);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999951577860671);
    AssertAlmostEqual(&test, rTM, 0.9999999995158259);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999515813123835);
    AssertAlmostEqual(&test, rTM, 0.9999999999515802);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995159188510757);
    AssertAlmostEqual(&test, rTM, 0.999999999995158);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9951697246488874);
    AssertAlmostEqual(&test, rTM, 0.9999999999995158);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9527382167662036);
    AssertAlmostEqual(&test, rTM, 0.9999999999999516);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.61903779378409);
    AssertAlmostEqual(&test, rTM, 0.999999999999995);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03936164359493153);
    AssertAlmostEqual(&test, rTM, 0.9999999999999988);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004261702532566127);
    AssertAlmostEqual(&test, rTM, 0.9999999999999988);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.265300891810416e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999999988);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.265336913764603e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999999988);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.265337273987986e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999999999988);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999999846118916);
    AssertAlmostEqual(&test, rTM, 0.9999998476424909);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999999783459301);
    AssertAlmostEqual(&test, rTM, 0.9999998917296447);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999984611902253);
    AssertAlmostEqual(&test, rTM, 0.999999984764248);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999846876103423);
    AssertAlmostEqual(&test, rTM, 0.9999999984689024);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999846894232218);
    AssertAlmostEqual(&test, rTM, 0.9999999998468827);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9984699976581651);
    AssertAlmostEqual(&test, rTM, 0.9999999999846882);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9848050346626781);
    AssertAlmostEqual(&test, rTM, 0.9999999999984688);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.858156984856161);
    AssertAlmostEqual(&test, rTM, 0.9999999999998465);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2438650140596428);
    AssertAlmostEqual(&test, rTM, 0.9999999999999807);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.004229309916683889);
    AssertAlmostEqual(&test, rTM, 0.9999999999999882);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.264948458823696e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999999882);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.265308639231812e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999999882);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.26531224141992e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999999999882);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999984683327591);
    AssertAlmostEqual(&test, rTM, 0.9999984683342907);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999984682569436);
    AssertAlmostEqual(&test, rTM, 0.9999984684101024);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999984606942491);
    AssertAlmostEqual(&test, rTM, 0.9999984759348886);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999997833897185);
    AssertAlmostEqual(&test, rTM, 0.999998916948006);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999846070491166);
    AssertAlmostEqual(&test, rTM, 0.9999998475933843);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998468373077971);
    AssertAlmostEqual(&test, rTM, 0.9999999846840893);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9984695041409808);
    AssertAlmostEqual(&test, rTM, 0.9999999984683327);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.984800174576859);
    AssertAlmostEqual(&test, rTM, 0.9999999998468287);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8581147581225519);
    AssertAlmostEqual(&test, rTM, 0.9999999999846385);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.243769477223779);
    AssertAlmostEqual(&test, rTM, 0.9999999999980708);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.004226607859088998);
    AssertAlmostEqual(&test, rTM, 0.9999999999988171);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.262200735126949e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999988269);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.262560451572352e-07);
    AssertAlmostEqual(&test, rTM, 0.999999999998827);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999951422888118);
    AssertAlmostEqual(&test, rTM, 0.9999951422888604);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999951422864073);
    AssertAlmostEqual(&test, rTM, 0.999995142291265);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999951420459572);
    AssertAlmostEqual(&test, rTM, 0.9999951425317029);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999951180607591);
    AssertAlmostEqual(&test, rTM, 0.9999951663966744);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999931301659015);
    AssertAlmostEqual(&test, rTM, 0.9999965650770514);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999511816800818);
    AssertAlmostEqual(&test, rTM, 0.999999516638616);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995143214005623);
    AssertAlmostEqual(&test, rTM, 0.9999999514251988);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9951540590277822);
    AssertAlmostEqual(&test, rTM, 0.9999999951422651);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9525883171264946);
    AssertAlmostEqual(&test, rTM, 0.9999999995140845);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6180916313810569);
    AssertAlmostEqual(&test, rTM, 0.9999999999500104);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03912616221037463);
    AssertAlmostEqual(&test, rTM, 0.9999999999872404);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000423415411748362);
    AssertAlmostEqual(&test, rTM, 0.9999999999881912);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.23770609175919e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999882012);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999841977143523);
    AssertAlmostEqual(&test, rTM, 0.999984197714354);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999841977142742);
    AssertAlmostEqual(&test, rTM, 0.9999841977144321);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999841977064521);
    AssertAlmostEqual(&test, rTM, 0.9999841977222542);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999841969242649);
    AssertAlmostEqual(&test, rTM, 0.9999841985044019);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999841189000979);
    AssertAlmostEqual(&test, rTM, 0.9999842761374745);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999776522664612);
    AssertAlmostEqual(&test, rTM, 0.9999888260708019);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998412003500827);
    AssertAlmostEqual(&test, rTM, 0.9999984276026167);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.998420928151886);
    AssertAlmostEqual(&test, rTM, 0.9999998419837587);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9843219465503454);
    AssertAlmostEqual(&test, rTM, 0.9999999841971042);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8539692059339854);
    AssertAlmostEqual(&test, rTM, 0.999999998414834);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2346007465159731);
    AssertAlmostEqual(&test, rTM, 0.999999999798602);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.003972791069696647);
    AssertAlmostEqual(&test, rTM, 0.9999999998741459);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.004225621647318e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999998751319);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999377821062178);
    AssertAlmostEqual(&test, rTM, 0.9999377821062179);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999377821062146);
    AssertAlmostEqual(&test, rTM, 0.9999377821062209);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999377821059067);
    AssertAlmostEqual(&test, rTM, 0.9999377821065288);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999377820751099);
    AssertAlmostEqual(&test, rTM, 0.9999377821373258);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999377789954976);
    AssertAlmostEqual(&test, rTM, 0.9999377852167824);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999374718003101);
    AssertAlmostEqual(&test, rTM, 0.9999380908722318);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999912011744628);
    AssertAlmostEqual(&test, rTM, 0.9999560049045084);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993748939237559);
    AssertAlmostEqual(&test, rTM, 0.9999938089144456);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9937970343261191);
    AssertAlmostEqual(&test, rTM, 0.9999993778299966);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9396856932331351);
    AssertAlmostEqual(&test, rTM, 0.999999937750102);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5419533058350265);
    AssertAlmostEqual(&test, rTM, 0.9999999934838796);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02457697209689009);
    AssertAlmostEqual(&test, rTM, 0.9999999979668042);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002581773204230588);
    AssertAlmostEqual(&test, rTM, 0.9999999980633467);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995804124523577);
    AssertAlmostEqual(&test, rTM, 0.9995804124523577);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995804124523575);
    AssertAlmostEqual(&test, rTM, 0.999580412452358);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995804124523368);
    AssertAlmostEqual(&test, rTM, 0.9995804124523787);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995804124502603);
    AssertAlmostEqual(&test, rTM, 0.9995804124544553);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995804122426081);
    AssertAlmostEqual(&test, rTM, 0.9995804126621074);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995803914779072);
    AssertAlmostEqual(&test, rTM, 0.9995804334257601);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995783201747239);
    AssertAlmostEqual(&test, rTM, 0.9995824943507622);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994066651730377);
    AssertAlmostEqual(&test, rTM, 0.9997032885611504);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9957911974624619);
    AssertAlmostEqual(&test, rTM, 0.9999582414976849);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9589018276463681);
    AssertAlmostEqual(&test, rTM, 0.9999958025388939);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6592480396873562);
    AssertAlmostEqual(&test, rTM, 0.9999995711846857);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05112045603653249);
    AssertAlmostEqual(&test, rTM, 0.9999999024474082);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005671263367985099);
    AssertAlmostEqual(&test, rTM, 0.9999999118362589);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960703930968248);
    AssertAlmostEqual(&test, rTM, 0.9960703930968248);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960703930968248);
    AssertAlmostEqual(&test, rTM, 0.9960703930968249);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960703930968229);
    AssertAlmostEqual(&test, rTM, 0.9960703930968268);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960703930966287);
    AssertAlmostEqual(&test, rTM, 0.9960703930970209);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960703930772155);
    AssertAlmostEqual(&test, rTM, 0.9960703931164342);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960703911358899);
    AssertAlmostEqual(&test, rTM, 0.9960703950577587);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960701970082063);
    AssertAlmostEqual(&test, rTM, 0.9960705891756781);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960508327148748);
    AssertAlmostEqual(&test, rTM, 0.996089856785217);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9944472264768768);
    AssertAlmostEqual(&test, rTM, 0.997219742958623);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9612052597385256);
    AssertAlmostEqual(&test, rTM, 0.9996082205750589);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6762080939260635);
    AssertAlmostEqual(&test, rTM, 0.9999598736425622);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05732162222423347);
    AssertAlmostEqual(&test, rTM, 0.9999913060290286);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006442168367960049);
    AssertAlmostEqual(&test, rTM, 0.9999922387016175);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616524745845471);
    AssertAlmostEqual(&test, rTM, 0.9616524745845471);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616524745845471);
    AssertAlmostEqual(&test, rTM, 0.9616524745845471);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616524745845468);
    AssertAlmostEqual(&test, rTM, 0.9616524745845472);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616524745845282);
    AssertAlmostEqual(&test, rTM, 0.9616524745845658);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616524745826671);
    AssertAlmostEqual(&test, rTM, 0.9616524745864269);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616524743965575);
    AssertAlmostEqual(&test, rTM, 0.9616524747725365);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616524557856091);
    AssertAlmostEqual(&test, rTM, 0.9616524933834759);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.961650594739115);
    AssertAlmostEqual(&test, rTM, 0.9616543543396324);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9614649712557074);
    AssertAlmostEqual(&test, rTM, 0.961839083311792);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.94620572596846);
    AssertAlmostEqual(&test, rTM, 0.9727259272565366);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6767112137617135);
    AssertAlmostEqual(&test, rTM, 0.9960438908816714);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05802067534803731);
    AssertAlmostEqual(&test, rTM, 0.9991419216248369);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006530938225297406);
    AssertAlmostEqual(&test, rTM, 0.999234999598083);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6781872540814743);
    AssertAlmostEqual(&test, rTM, 0.6781872540814743);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6781872540814743);
    AssertAlmostEqual(&test, rTM, 0.6781872540814743);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6781872540814743);
    AssertAlmostEqual(&test, rTM, 0.6781872540814743);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.678187254081473);
    AssertAlmostEqual(&test, rTM, 0.6781872540814756);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6781872540813443);
    AssertAlmostEqual(&test, rTM, 0.6781872540816043);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6781872540684692);
    AssertAlmostEqual(&test, rTM, 0.6781872540944793);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.678187252780968);
    AssertAlmostEqual(&test, rTM, 0.6781872553819805);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6781871240308948);
    AssertAlmostEqual(&test, rTM, 0.6781873841320114);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6781742494806537);
    AssertAlmostEqual(&test, rTM, 0.678200258257562);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.676891341798834);
    AssertAlmostEqual(&test, rTM, 0.6794789622357582);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5793549460880401);
    AssertAlmostEqual(&test, rTM, 0.7573659187470126);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0575846190978614);
    AssertAlmostEqual(&test, rTM, 0.9207377356733667);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006539304061424348);
    AssertAlmostEqual(&test, rTM, 0.9289735805333743);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0581043606653553);
    AssertAlmostEqual(&test, rTM, 0.0581043606653553);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0581043606653553);
    AssertAlmostEqual(&test, rTM, 0.0581043606653553);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0581043606653553);
    AssertAlmostEqual(&test, rTM, 0.0581043606653553);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810436066535529);
    AssertAlmostEqual(&test, rTM, 0.0581043606653553);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810436066535478);
    AssertAlmostEqual(&test, rTM, 0.05810436066535581);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810436066530358);
    AssertAlmostEqual(&test, rTM, 0.05810436066540702);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810436066018301);
    AssertAlmostEqual(&test, rTM, 0.05810436067052759);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810436014812613);
    AssertAlmostEqual(&test, rTM, 0.05810436118258446);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810430894248458);
    AssertAlmostEqual(&test, rTM, 0.0581044123882257);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05809918883560513);
    AssertAlmostEqual(&test, rTM, 0.05810953249198661);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05759171029212145);
    AssertAlmostEqual(&test, rTM, 0.05861698039610089);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03076329590880442);
    AssertAlmostEqual(&test, rTM, 0.08535853819507198);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006476182582881861);
    AssertAlmostEqual(&test, rTM, 0.1151787280303254);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540950018629702);
    AssertAlmostEqual(&test, rTM, 0.0006540950018629702);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540950018629702);
    AssertAlmostEqual(&test, rTM, 0.0006540950018629702);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540950018629702);
    AssertAlmostEqual(&test, rTM, 0.0006540950018629702);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540950018629702);
    AssertAlmostEqual(&test, rTM, 0.0006540950018629702);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540950018629702);
    AssertAlmostEqual(&test, rTM, 0.0006540950018629703);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540950018629637);
    AssertAlmostEqual(&test, rTM, 0.0006540950018629767);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000654095001862317);
    AssertAlmostEqual(&test, rTM, 0.0006540950018636235);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540950017976463);
    AssertAlmostEqual(&test, rTM, 0.0006540950019282943);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540949953305715);
    AssertAlmostEqual(&test, rTM, 0.000654095008395369);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000654094348623742);
    AssertAlmostEqual(&test, rTM, 0.0006540956551021986);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540296843981153);
    AssertAlmostEqual(&test, rTM, 0.0006541603193278196);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006476271965807745);
    AssertAlmostEqual(&test, rTM, 0.0006605628070904411);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003272614560253506);
    AssertAlmostEqual(&test, rTM, 0.0009809284079595156);

    userdata[0] = 100/CAPS_HBAR_EV; /* 100eV */
    userdata[1] = 0.035/CAPS_HBAR_EV; /* 0.035eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999997661100702);
    AssertAlmostEqual(&test, rTM, 0.9999998830550283);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999983379009459);
    AssertAlmostEqual(&test, rTM, 0.9999999835435602);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999834607923984);
    AssertAlmostEqual(&test, rTM, 0.999999998346231);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998346284181754);
    AssertAlmostEqual(&test, rTM, 0.999999999834615);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9983475152920052);
    AssertAlmostEqual(&test, rTM, 0.9999999999834615);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9835976783608862);
    AssertAlmostEqual(&test, rTM, 0.9999999999983461);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8477264594605264);
    AssertAlmostEqual(&test, rTM, 0.999999999999834);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2215488748061893);
    AssertAlmostEqual(&test, rTM, 0.9999999999999786);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.003629514668034419);
    AssertAlmostEqual(&test, rTM, 0.9999999999999862);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.655738254590529e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999999863);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.656002884419129e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999999863);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.656005530959261e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999999999863);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.656005557424686e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999999999863);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999994743976985);
    AssertAlmostEqual(&test, rTM, 0.9999994796016803);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999992603751015);
    AssertAlmostEqual(&test, rTM, 0.9999996301874824);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999947439894168);
    AssertAlmostEqual(&test, rTM, 0.9999999479601559);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999476993553602);
    AssertAlmostEqual(&test, rTM, 0.9999999947703218);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994771425074312);
    AssertAlmostEqual(&test, rTM, 0.9999999994770062);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9947837184807941);
    AssertAlmostEqual(&test, rTM, 0.9999999999477004);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9490503377331097);
    AssertAlmostEqual(&test, rTM, 0.9999999999947683);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5961816931576353);
    AssertAlmostEqual(&test, rTM, 0.9999999999994594);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03410855111459814);
    AssertAlmostEqual(&test, rTM, 0.9999999999998536);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003653332889192101);
    AssertAlmostEqual(&test, rTM, 0.9999999999998631);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.655976988476368e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999998632);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.656003453631209e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999998632);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.656003718285176e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999999998632);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999947699268068);
    AssertAlmostEqual(&test, rTM, 0.9999947699320368);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999947696679256);
    AssertAlmostEqual(&test, rTM, 0.9999947701909051);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999947438441885);
    AssertAlmostEqual(&test, rTM, 0.9999947958851998);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999992603571268);
    AssertAlmostEqual(&test, rTM, 0.9999963017787955);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999474396850968);
    AssertAlmostEqual(&test, rTM, 0.9999994795873011);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994771021894278);
    AssertAlmostEqual(&test, rTM, 0.9999999477017719);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9947835721514474);
    AssertAlmostEqual(&test, rTM, 0.9999999947699005);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9490489665009747);
    AssertAlmostEqual(&test, rTM, 0.9999999994768127);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5961733581563153);
    AssertAlmostEqual(&test, rTM, 0.9999999999459405);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03410679061865233);
    AssertAlmostEqual(&test, rTM, 0.9999999999853573);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003653131154801474);
    AssertAlmostEqual(&test, rTM, 0.9999999999863131);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.655774962004651e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999863231);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.655801424234677e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999863232);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999834570044123);
    AssertAlmostEqual(&test, rTM, 0.9999834570045777);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999834569962236);
    AssertAlmostEqual(&test, rTM, 0.9999834570127665);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999834561773727);
    AssertAlmostEqual(&test, rTM, 0.9999834578315759);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999833744959633);
    AssertAlmostEqual(&test, rTM, 0.9999835391035593);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999766047515514);
    AssertAlmostEqual(&test, rTM, 0.9999883023073572);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998337573976034);
    AssertAlmostEqual(&test, rTM, 0.9999983538981569);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.998346971999163);
    AssertAlmostEqual(&test, rTM, 0.9999998345769047);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9835931312152221);
    AssertAlmostEqual(&test, rTM, 0.9999999834563101);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8476874712865232);
    AssertAlmostEqual(&test, rTM, 0.9999999983400372);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2214701010949898);
    AssertAlmostEqual(&test, rTM, 0.9999999997853094);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.003627504608166039);
    AssertAlmostEqual(&test, rTM, 0.999999999862166);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.65369907904166e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999998631524);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.653963413722959e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999998631622);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999475562254905);
    AssertAlmostEqual(&test, rTM, 0.9999475562254958);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999475562252309);
    AssertAlmostEqual(&test, rTM, 0.9999475562257554);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999947556199272);
    AssertAlmostEqual(&test, rTM, 0.9999475562517143);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999475536034387);
    AssertAlmostEqual(&test, rTM, 0.9999475588474165);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999472946658036);
    AssertAlmostEqual(&test, rTM, 0.9999478164871797);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999258341084059);
    AssertAlmostEqual(&test, rTM, 0.9999629163665922);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994730716498562);
    AssertAlmostEqual(&test, rTM, 0.9999947815259953);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9947689586172077);
    AssertAlmostEqual(&test, rTM, 0.9999994755730579);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.948912044097017);
    AssertAlmostEqual(&test, rTM, 0.9999999475368497);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5953416785755775);
    AssertAlmostEqual(&test, rTM, 0.99999999457817);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03393165512183162);
    AssertAlmostEqual(&test, rTM, 0.9999999985281463);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003633069608121025);
    AssertAlmostEqual(&test, rTM, 0.9999999986237535);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.635684449838099e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999986247431);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998300759715293);
    AssertAlmostEqual(&test, rTM, 0.9998300759715295);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998300759715208);
    AssertAlmostEqual(&test, rTM, 0.9998300759715378);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998300759706799);
    AssertAlmostEqual(&test, rTM, 0.9998300759723789);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998300758865746);
    AssertAlmostEqual(&test, rTM, 0.9998300760564841);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998300674762624);
    AssertAlmostEqual(&test, rTM, 0.9998300844663718);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998292285372542);
    AssertAlmostEqual(&test, rTM, 0.9998309192008624);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997596995919837);
    AssertAlmostEqual(&test, rTM, 0.999879842576655);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9982935973103945);
    AssertAlmostEqual(&test, rTM, 0.9999830906274106);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9831490999027764);
    AssertAlmostEqual(&test, rTM, 0.9999983006403973);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8438886474015775);
    AssertAlmostEqual(&test, rTM, 0.9999998294492779);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2139514847325651);
    AssertAlmostEqual(&test, rTM, 0.999999977699974);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.003438938691624532);
    AssertAlmostEqual(&test, rTM, 0.9999999854608027);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.462474075243879e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999855594589);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993473690081197);
    AssertAlmostEqual(&test, rTM, 0.9993473690081197);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993473690081194);
    AssertAlmostEqual(&test, rTM, 0.99934736900812);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993473690080872);
    AssertAlmostEqual(&test, rTM, 0.9993473690081524);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993473690048577);
    AssertAlmostEqual(&test, rTM, 0.9993473690113819);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993473686819109);
    AssertAlmostEqual(&test, rTM, 0.9993473693343284);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993473363880379);
    AssertAlmostEqual(&test, rTM, 0.9993474016265719);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993441150383259);
    AssertAlmostEqual(&test, rTM, 0.9993506068395953);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9990771651835323);
    AssertAlmostEqual(&test, rTM, 0.9995384760650239);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9934604864665758);
    AssertAlmostEqual(&test, rTM, 0.9999350413553729);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.93680879315744);
    AssertAlmostEqual(&test, rTM, 0.9999934684305082);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5263579385384508);
    AssertAlmostEqual(&test, rTM, 0.999999313256038);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02242247254453349);
    AssertAlmostEqual(&test, rTM, 0.9999997771215902);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002345186373606611);
    AssertAlmostEqual(&test, rTM, 0.9999997867973857);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9957659381632901);
    AssertAlmostEqual(&test, rTM, 0.9957659381632901);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.99576593816329);
    AssertAlmostEqual(&test, rTM, 0.9957659381632901);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.995765938163288);
    AssertAlmostEqual(&test, rTM, 0.9957659381632922);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9957659381630788);
    AssertAlmostEqual(&test, rTM, 0.9957659381635012);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9957659381421646);
    AssertAlmostEqual(&test, rTM, 0.9957659381844154);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9957659360507509);
    AssertAlmostEqual(&test, rTM, 0.995765940275828);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9957657269146345);
    AssertAlmostEqual(&test, rTM, 0.9957661494014286);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9957448655416614);
    AssertAlmostEqual(&test, rTM, 0.9957869066476771);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9940173919279891);
    AssertAlmostEqual(&test, rTM, 0.9970042018491809);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.958257320541029);
    AssertAlmostEqual(&test, rTM, 0.9995777954380271);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6562548747296851);
    AssertAlmostEqual(&test, rTM, 0.999956628306567);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05011674983738691);
    AssertAlmostEqual(&test, rTM, 0.9999900484582067);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005548311238611853);
    AssertAlmostEqual(&test, rTM, 0.9999909883329134);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9613463365138437);
    AssertAlmostEqual(&test, rTM, 0.9613463365138437);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9613463365138437);
    AssertAlmostEqual(&test, rTM, 0.9613463365138437);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9613463365138435);
    AssertAlmostEqual(&test, rTM, 0.9613463365138439);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9613463365138248);
    AssertAlmostEqual(&test, rTM, 0.9613463365138627);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9613463365119491);
    AssertAlmostEqual(&test, rTM, 0.9613463365157383);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9613463363243843);
    AssertAlmostEqual(&test, rTM, 0.9613463367033032);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9613463175679047);
    AssertAlmostEqual(&test, rTM, 0.9613463554597736);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9613444419686951);
    AssertAlmostEqual(&test, rTM, 0.9613482309679688);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9611573671276606);
    AssertAlmostEqual(&test, rTM, 0.9615344045956734);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9457798457226398);
    AssertAlmostEqual(&test, rTM, 0.9725068677392248);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6745897192177971);
    AssertAlmostEqual(&test, rTM, 0.9960105527255982);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05718804933251204);
    AssertAlmostEqual(&test, rTM, 0.9991293556050723);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006425986147753021);
    AssertAlmostEqual(&test, rTM, 0.9992225149732241);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6779744018264381);
    AssertAlmostEqual(&test, rTM, 0.6779744018264381);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6779744018264381);
    AssertAlmostEqual(&test, rTM, 0.6779744018264381);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6779744018264381);
    AssertAlmostEqual(&test, rTM, 0.6779744018264381);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6779744018264368);
    AssertAlmostEqual(&test, rTM, 0.6779744018264394);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.677974401826308);
    AssertAlmostEqual(&test, rTM, 0.6779744018265682);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6779744018134268);
    AssertAlmostEqual(&test, rTM, 0.6779744018394493);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6779744005253151);
    AssertAlmostEqual(&test, rTM, 0.6779744031275611);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6779742717141821);
    AssertAlmostEqual(&test, rTM, 0.6779745319386514);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6779613910583161);
    AssertAlmostEqual(&test, rTM, 0.6779874121697848);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.676677876123518);
    AssertAlmostEqual(&test, rTM, 0.6792667229829495);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5791024154995478);
    AssertAlmostEqual(&test, rTM, 0.7571918924290479);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05750070855437181);
    AssertAlmostEqual(&test, rTM, 0.9206305104711616);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006528626501186463);
    AssertAlmostEqual(&test, rTM, 0.9288656800399822);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05809589038672697);
    AssertAlmostEqual(&test, rTM, 0.05809589038672697);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05809589038672697);
    AssertAlmostEqual(&test, rTM, 0.05809589038672697);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05809589038672697);
    AssertAlmostEqual(&test, rTM, 0.05809589038672697);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05809589038672697);
    AssertAlmostEqual(&test, rTM, 0.05809589038672698);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05809589038672646);
    AssertAlmostEqual(&test, rTM, 0.05809589038672749);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05809589038667526);
    AssertAlmostEqual(&test, rTM, 0.05809589038677869);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05809589038155535);
    AssertAlmostEqual(&test, rTM, 0.0580958903918986);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05809588986956442);
    AssertAlmostEqual(&test, rTM, 0.05809589090388953);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0580958386705172);
    AssertAlmostEqual(&test, rTM, 0.05809594210293644);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05809071922301959);
    AssertAlmostEqual(&test, rTM, 0.05810106154731676);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05758330610600575);
    AssertAlmostEqual(&test, rTM, 0.05860844403735605);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03075855878164768);
    AssertAlmostEqual(&test, rTM, 0.08534637116081625);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006475123417559538);
    AssertAlmostEqual(&test, rTM, 0.1151620600704504);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540843026999323);
    AssertAlmostEqual(&test, rTM, 0.0006540843026999323);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540843026999323);
    AssertAlmostEqual(&test, rTM, 0.0006540843026999323);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540843026999323);
    AssertAlmostEqual(&test, rTM, 0.0006540843026999323);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540843026999323);
    AssertAlmostEqual(&test, rTM, 0.0006540843026999323);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540843026999323);
    AssertAlmostEqual(&test, rTM, 0.0006540843026999324);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540843026999258);
    AssertAlmostEqual(&test, rTM, 0.0006540843026999389);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000654084302699279);
    AssertAlmostEqual(&test, rTM, 0.0006540843027005855);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540843026346094);
    AssertAlmostEqual(&test, rTM, 0.0006540843027652552);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540842961676403);
    AssertAlmostEqual(&test, rTM, 0.0006540843092322243);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540836494713752);
    AssertAlmostEqual(&test, rTM, 0.0006540849559284893);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540189863020907);
    AssertAlmostEqual(&test, rTM, 0.0006541496190977683);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006476166030758934);
    AssertAlmostEqual(&test, rTM, 0.0006605520022692489);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003272560994439048);
    AssertAlmostEqual(&test, rTM, 0.0009809123662217398);

    userdata[0] = 100/CAPS_HBAR_EV; /* 100eV */
    userdata[1] = 0.05/CAPS_HBAR_EV; /* 0.05eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999997204480733);
    AssertAlmostEqual(&test, rTM, 0.9999998602240269);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999980134119979);
    AssertAlmostEqual(&test, rTM, 0.9999999803307925);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999802318979795);
    AssertAlmostEqual(&test, rTM, 0.9999999980233679);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999802346346827);
    AssertAlmostEqual(&test, rTM, 0.999999999802327);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9980252218500153);
    AssertAlmostEqual(&test, rTM, 0.9999999999802327);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9804270987041049);
    AssertAlmostEqual(&test, rTM, 0.9999999999980231);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8209010802727921);
    AssertAlmostEqual(&test, rTM, 0.9999999999998014);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1744276057158425);
    AssertAlmostEqual(&test, rTM, 0.9999999999999722);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002546188095571644);
    AssertAlmostEqual(&test, rTM, 0.9999999999999803);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559072951126295e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999999805);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559202623337432e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999999805);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559203920142499e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999999999805);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559203933110558e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999999999805);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999993717851769);
    AssertAlmostEqual(&test, rTM, 0.9999993780051237);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999999115979299);
    AssertAlmostEqual(&test, rTM, 0.9999995579895518);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999937178695292);
    AssertAlmostEqual(&test, rTM, 0.999999937800495);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999374890976195);
    AssertAlmostEqual(&test, rTM, 0.9999999937493395);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993750977217355);
    AssertAlmostEqual(&test, rTM, 0.999999999374903);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9937685336824269);
    AssertAlmostEqual(&test, rTM, 0.99999999993749);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9394134779717868);
    AssertAlmostEqual(&test, rTM, 0.999999999993746);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5404554800707418);
    AssertAlmostEqual(&test, rTM, 0.9999999999993451);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02436035542230869);
    AssertAlmostEqual(&test, rTM, 0.9999999999997948);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002557893966686372);
    AssertAlmostEqual(&test, rTM, 0.9999999999998045);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559189934285412e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999998046);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559202902251541e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999998046);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559203031932032e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999999998046);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999937489224207);
    AssertAlmostEqual(&test, rTM, 0.9999937489286718);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999937486130013);
    AssertAlmostEqual(&test, rTM, 0.9999937492380755);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999993717748022);
    AssertAlmostEqual(&test, rTM, 0.9999937799483433);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999911596571732);
    AssertAlmostEqual(&test, rTM, 0.9999955798188176);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999371792562022);
    AssertAlmostEqual(&test, rTM, 0.999999377993093);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993750547160096);
    AssertAlmostEqual(&test, rTM, 0.9999999374921843);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9937684104566401);
    AssertAlmostEqual(&test, rTM, 0.9999999937488786);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9394123424403014);
    AssertAlmostEqual(&test, rTM, 0.9999999993745854);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5404492432607952);
    AssertAlmostEqual(&test, rTM, 0.9999999999345068);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02435945792240269);
    AssertAlmostEqual(&test, rTM, 0.9999999999794863);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002557795071834589);
    AssertAlmostEqual(&test, rTM, 0.9999999999804519);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559090939205708e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999804619);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559103906168596e-08);
    AssertAlmostEqual(&test, rTM, 0.999999999980462);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999802290250382);
    AssertAlmostEqual(&test, rTM, 0.999980229025236);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999802290152517);
    AssertAlmostEqual(&test, rTM, 0.9999802290350225);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999802280366229);
    AssertAlmostEqual(&test, rTM, 0.999980230013602);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999801304171517);
    AssertAlmostEqual(&test, rTM, 0.9999803271437596);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999972039733698);
    AssertAlmostEqual(&test, rTM, 0.9999860197691248);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998013219369135);
    AssertAlmostEqual(&test, rTM, 0.9999980326969502);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.998024737840588);
    AssertAlmostEqual(&test, rTM, 0.9999998022981047);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9804233035415172);
    AssertAlmostEqual(&test, rTM, 0.9999999802278737);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8208695368346315);
    AssertAlmostEqual(&test, rTM, 0.9999999980132458);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1743797126236201);
    AssertAlmostEqual(&test, rTM, 0.9999999997219884);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002545198718730951);
    AssertAlmostEqual(&test, rTM, 0.9999999998035529);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.558073544008276e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999998045405);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.558203114954277e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999998045503);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999373702344782);
    AssertAlmostEqual(&test, rTM, 0.9999373702344844);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999373702341682);
    AssertAlmostEqual(&test, rTM, 0.9999373702347945);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999373702031674);
    AssertAlmostEqual(&test, rTM, 0.9999373702657952);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999373671031694);
    AssertAlmostEqual(&test, rTM, 0.9999373733656367);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999370578744666);
    AssertAlmostEqual(&test, rTM, 0.9999376810444095);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999114292850937);
    AssertAlmostEqual(&test, rTM, 0.9999557136618853);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993707570020295);
    AssertAlmostEqual(&test, rTM, 0.9999937679293661);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9937560990756683);
    AssertAlmostEqual(&test, rTM, 0.9999993737111704);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9392989069306317);
    AssertAlmostEqual(&test, rTM, 0.9999999373376031);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.539826586949107);
    AssertAlmostEqual(&test, rTM, 0.9999999934368994);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02427004087131591);
    AssertAlmostEqual(&test, rTM, 0.9999999979410604);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002547944055609949);
    AssertAlmostEqual(&test, rTM, 0.9999999980376336);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.549229958605782e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999980386234);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997985222166441);
    AssertAlmostEqual(&test, rTM, 0.9997985222166442);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997985222166341);
    AssertAlmostEqual(&test, rTM, 0.9997985222166542);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997985222156369);
    AssertAlmostEqual(&test, rTM, 0.9997985222176514);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997985221159155);
    AssertAlmostEqual(&test, rTM, 0.9997985223173729);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997985121440218);
    AssertAlmostEqual(&test, rTM, 0.999798532288763);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997975174354314);
    AssertAlmostEqual(&test, rTM, 0.9997995220123211);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997150792767125);
    AssertAlmostEqual(&test, rTM, 0.9998575294887101);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.997977018663828);
    AssertAlmostEqual(&test, rTM, 0.9999799503822805);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.980051189148295);
    AssertAlmostEqual(&test, rTM, 0.9999979850196947);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8177825156638334);
    AssertAlmostEqual(&test, rTM, 0.9999997974819818);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1697683503157829);
    AssertAlmostEqual(&test, rTM, 0.9999999713969455);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.00245090636066281);
    AssertAlmostEqual(&test, rTM, 0.9999999795995068);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.462843240599713e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999796982617);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9992630950818061);
    AssertAlmostEqual(&test, rTM, 0.9992630950818061);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9992630950818057);
    AssertAlmostEqual(&test, rTM, 0.9992630950818064);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9992630950817692);
    AssertAlmostEqual(&test, rTM, 0.9992630950818429);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9992630950781229);
    AssertAlmostEqual(&test, rTM, 0.9992630950854893);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9992630947134895);
    AssertAlmostEqual(&test, rTM, 0.9992630954501225);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9992630582510623);
    AssertAlmostEqual(&test, rTM, 0.9992631319107098);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9992594210842055);
    AssertAlmostEqual(&test, rTM, 0.9992667508594608);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9989580181664544);
    AssertAlmostEqual(&test, rTM, 0.9994788732613166);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9926188593844166);
    AssertAlmostEqual(&test, rTM, 0.9999266503853357);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.928946008285672);
    AssertAlmostEqual(&test, rTM, 0.9999926236248481);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.48605669512361);
    AssertAlmostEqual(&test, rTM, 0.9999992143429673);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01775404955741152);
    AssertAlmostEqual(&test, rTM, 0.9999997184629614);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001839488798028095);
    AssertAlmostEqual(&test, rTM, 0.9999997281854351);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9956305652649139);
    AssertAlmostEqual(&test, rTM, 0.9956305652649139);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9956305652649139);
    AssertAlmostEqual(&test, rTM, 0.9956305652649139);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9956305652649117);
    AssertAlmostEqual(&test, rTM, 0.995630565264916);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9956305652646958);
    AssertAlmostEqual(&test, rTM, 0.9956305652651318);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9956305652431146);
    AssertAlmostEqual(&test, rTM, 0.9956305652867132);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9956305630849805);
    AssertAlmostEqual(&test, rTM, 0.9956305674448461);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9956303472769946);
    AssertAlmostEqual(&test, rTM, 0.9956307832419822);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9956088203909117);
    AssertAlmostEqual(&test, rTM, 0.9956522026941244);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9938262877399902);
    AssertAlmostEqual(&test, rTM, 0.996908357366741);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9569491952531625);
    AssertAlmostEqual(&test, rTM, 0.9995642635780576);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6475901891213922);
    AssertAlmostEqual(&test, rTM, 0.9999551758886299);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04732957839202813);
    AssertAlmostEqual(&test, rTM, 0.9999894595630724);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005209488629198042);
    AssertAlmostEqual(&test, rTM, 0.99999040222374);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9612037159987618);
    AssertAlmostEqual(&test, rTM, 0.9612037159987618);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9612037159987618);
    AssertAlmostEqual(&test, rTM, 0.9612037159987618);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9612037159987615);
    AssertAlmostEqual(&test, rTM, 0.961203715998762);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9612037159987428);
    AssertAlmostEqual(&test, rTM, 0.9612037159987807);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9612037159968603);
    AssertAlmostEqual(&test, rTM, 0.9612037160006631);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9612037158086176);
    AssertAlmostEqual(&test, rTM, 0.9612037161889059);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9612036969843563);
    AssertAlmostEqual(&test, rTM, 0.961203735013158);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9612018146071538);
    AssertAlmostEqual(&test, rTM, 0.961205617299031);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9610140637906127);
    AssertAlmostEqual(&test, rTM, 0.9613924637823168);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9455814605533744);
    AssertAlmostEqual(&test, rTM, 0.9724048070640724);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6736036387750582);
    AssertAlmostEqual(&test, rTM, 0.9959950085003761);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05680595370816382);
    AssertAlmostEqual(&test, rTM, 0.9991234662104153);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006377942350022938);
    AssertAlmostEqual(&test, rTM, 0.9992166629128281);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6778747124158686);
    AssertAlmostEqual(&test, rTM, 0.6778747124158686);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6778747124158686);
    AssertAlmostEqual(&test, rTM, 0.6778747124158686);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6778747124158686);
    AssertAlmostEqual(&test, rTM, 0.6778747124158686);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6778747124158673);
    AssertAlmostEqual(&test, rTM, 0.6778747124158699);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6778747124157385);
    AssertAlmostEqual(&test, rTM, 0.6778747124159987);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6778747124028545);
    AssertAlmostEqual(&test, rTM, 0.6778747124288828);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6778747111144569);
    AssertAlmostEqual(&test, rTM, 0.6778747137172804);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6778745822747397);
    AssertAlmostEqual(&test, rTM, 0.677874842556955);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6778616987606082);
    AssertAlmostEqual(&test, rTM, 0.6778877256463338);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6765778995493489);
    AssertAlmostEqual(&test, rTM, 0.6791673205411608);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5789841557606329);
    AssertAlmostEqual(&test, rTM, 0.7571103790346985);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05746145988965208);
    AssertAlmostEqual(&test, rTM, 0.9205802579655716);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006523633388978311);
    AssertAlmostEqual(&test, rTM, 0.9288151103117858);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0580919207965516);
    AssertAlmostEqual(&test, rTM, 0.0580919207965516);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0580919207965516);
    AssertAlmostEqual(&test, rTM, 0.0580919207965516);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0580919207965516);
    AssertAlmostEqual(&test, rTM, 0.0580919207965516);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05809192079655159);
    AssertAlmostEqual(&test, rTM, 0.05809192079655161);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05809192079655108);
    AssertAlmostEqual(&test, rTM, 0.05809192079655211);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05809192079649989);
    AssertAlmostEqual(&test, rTM, 0.05809192079660331);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05809192079138029);
    AssertAlmostEqual(&test, rTM, 0.05809192080172292);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05809192027942026);
    AssertAlmostEqual(&test, rTM, 0.05809192131368294);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05809186908346355);
    AssertAlmostEqual(&test, rTM, 0.05809197250963934);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05808674994499304);
    AssertAlmostEqual(&test, rTM, 0.05809709164499315);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05757936749086084);
    AssertAlmostEqual(&test, rTM, 0.0586044434779586);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03075633875594337);
    AssertAlmostEqual(&test, rTM, 0.08534066905972153);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000647462705306637);
    AssertAlmostEqual(&test, rTM, 0.1151542486248119);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540792875877465);
    AssertAlmostEqual(&test, rTM, 0.0006540792875877465);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540792875877465);
    AssertAlmostEqual(&test, rTM, 0.0006540792875877465);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540792875877465);
    AssertAlmostEqual(&test, rTM, 0.0006540792875877465);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540792875877465);
    AssertAlmostEqual(&test, rTM, 0.0006540792875877465);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540792875877465);
    AssertAlmostEqual(&test, rTM, 0.0006540792875877466);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.00065407928758774);
    AssertAlmostEqual(&test, rTM, 0.0006540792875877531);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540792875870934);
    AssertAlmostEqual(&test, rTM, 0.0006540792875883997);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540792875224242);
    AssertAlmostEqual(&test, rTM, 0.0006540792876530689);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540792810555045);
    AssertAlmostEqual(&test, rTM, 0.0006540792941199886);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540786343641915);
    AssertAlmostEqual(&test, rTM, 0.0006540799408113016);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540139716900554);
    AssertAlmostEqual(&test, rTM, 0.000654144603485432);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006476116374897803);
    AssertAlmostEqual(&test, rTM, 0.0006605469376309918);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003272535886067144);
    AssertAlmostEqual(&test, rTM, 0.0009809048468377712);

    userdata[0] = 100/CAPS_HBAR_EV; /* 100eV */
    userdata[1] = 0.1/CAPS_HBAR_EV; /* 0.1eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999996046539006);
    AssertAlmostEqual(&test, rTM, 0.9999998023269308);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999971905414879);
    AssertAlmostEqual(&test, rTM, 0.9999999721835404);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999720437967504);
    AssertAlmostEqual(&test, rTM, 0.9999999972046202);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997204869691064);
    AssertAlmostEqual(&test, rTM, 0.9999999997204482);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9972083850894582);
    AssertAlmostEqual(&test, rTM, 0.9999999999720448);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9724328194759416);
    AssertAlmostEqual(&test, rTM, 0.9999999999972042);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7568050478148419);
    AssertAlmostEqual(&test, rTM, 0.9999999999997178);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1029657829287334);
    AssertAlmostEqual(&test, rTM, 0.9999999999999519);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001276337667697707);
    AssertAlmostEqual(&test, rTM, 0.9999999999999608);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279569245043194e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999999609);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279601664144626e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999999609);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.27960198834601e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999999999609);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279601991588025e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999999999609);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999991115702795);
    AssertAlmostEqual(&test, rTM, 0.9999991203666095);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999987498062862);
    AssertAlmostEqual(&test, rTM, 0.9999993749029478);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999911157383145);
    AssertAlmostEqual(&test, rTM, 0.9999999120366261);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999115973872343);
    AssertAlmostEqual(&test, rTM, 0.999999991160232);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991163692131798);
    AssertAlmostEqual(&test, rTM, 0.9999999991159794);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9911987782023435);
    AssertAlmostEqual(&test, rTM, 0.999999999911597);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9154190502395694);
    AssertAlmostEqual(&test, rTM, 0.9999999999911512);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4242187529543556);
    AssertAlmostEqual(&test, rTM, 0.9999999999990334);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01247865601618084);
    AssertAlmostEqual(&test, rTM, 0.9999999999995994);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001279274395206834);
    AssertAlmostEqual(&test, rTM, 0.9999999999996092);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279598491869935e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999996092);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279601733873209e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999996092);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279601766293345e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999999996092);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999991159739108);
    AssertAlmostEqual(&test, rTM, 0.9999911597479483);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999911593015284);
    AssertAlmostEqual(&test, rTM, 0.9999911601855059);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999911156523958);
    AssertAlmostEqual(&test, rTM, 0.9999912036158466);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999874980122924);
    AssertAlmostEqual(&test, rTM, 0.9999937489866085);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999111600758263);
    AssertAlmostEqual(&test, rTM, 0.9999991203581019);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999116316951742);
    AssertAlmostEqual(&test, rTM, 0.9999999116014596);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9911986891252023);
    AssertAlmostEqual(&test, rTM, 0.9999999911596226);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9154182679836648);
    AssertAlmostEqual(&test, rTM, 0.9999999991151073);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4242154357749282);
    AssertAlmostEqual(&test, rTM, 0.9999999999033461);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01247842060859247);
    AssertAlmostEqual(&test, rTM, 0.999999999959937);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001279249658356805);
    AssertAlmostEqual(&test, rTM, 0.9999999999609146);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279573742484986e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999609245);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.27957698436285e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999609246);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999720424639305);
    AssertAlmostEqual(&test, rTM, 0.99997204246421);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999720424500917);
    AssertAlmostEqual(&test, rTM, 0.9999720424780488);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999720410662479);
    AssertAlmostEqual(&test, rTM, 0.9999720438618227);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999719030260823);
    AssertAlmostEqual(&test, rTM, 0.9999721812100734);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999604623024525);
    AssertAlmostEqual(&test, rTM, 0.9999802309558168);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997190657838733);
    AssertAlmostEqual(&test, rTM, 0.9999972180861549);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9972079734259837);
    AssertAlmostEqual(&test, rTM, 0.9999997204344764);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9724301509764021);
    AssertAlmostEqual(&test, rTM, 0.9999999720393561);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7567845818886872);
    AssertAlmostEqual(&test, rTM, 0.999999997177023);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1029494263662654);
    AssertAlmostEqual(&test, rTM, 0.9999999995194722);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001276089014521366);
    AssertAlmostEqual(&test, rTM, 0.9999999996081784);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.27931933166733e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999996091672);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279351738106307e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999996091771);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999115155082225);
    AssertAlmostEqual(&test, rTM, 0.9999115155082314);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999115155077846);
    AssertAlmostEqual(&test, rTM, 0.9999115155086694);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999115154639867);
    AssertAlmostEqual(&test, rTM, 0.9999115155524673);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999115110843088);
    AssertAlmostEqual(&test, rTM, 0.9999115199319241);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999110742059516);
    AssertAlmostEqual(&test, rTM, 0.9999119546205965);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998748663249644);
    AssertAlmostEqual(&test, rTM, 0.9999374312049939);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991110978549883);
    AssertAlmostEqual(&test, rTM, 0.9999911951123446);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.99118978517347);
    AssertAlmostEqual(&test, rTM, 0.9999991151519049);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9153400839481458);
    AssertAlmostEqual(&test, rTM, 0.9999999114250736);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4238840369425579);
    AssertAlmostEqual(&test, rTM, 0.9999999903237414);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01245492462555115);
    AssertAlmostEqual(&test, rTM, 0.9999999959861464);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001276780795135126);
    AssertAlmostEqual(&test, rTM, 0.9999999960839011);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.27710362943424e-06);
    AssertAlmostEqual(&test, rTM, 0.999999996084891);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997177702358474);
    AssertAlmostEqual(&test, rTM, 0.9997177702358476);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997177702358334);
    AssertAlmostEqual(&test, rTM, 0.9997177702358616);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997177702344365);
    AssertAlmostEqual(&test, rTM, 0.9997177702372585);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997177700947526);
    AssertAlmostEqual(&test, rTM, 0.9997177703769423);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997177561267038);
    AssertAlmostEqual(&test, rTM, 0.999717784344286);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997163627970265);
    AssertAlmostEqual(&test, rTM, 0.999719170691784);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996008901724517);
    AssertAlmostEqual(&test, rTM, 0.9998004251691822);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9971672464252195);
    AssertAlmostEqual(&test, rTM, 0.9999719134918308);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9721672376683953);
    AssertAlmostEqual(&test, rTM, 0.9999971771680437);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7547709516640665);
    AssertAlmostEqual(&test, rTM, 0.9999997149331799);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1013555576394521);
    AssertAlmostEqual(&test, rTM, 0.9999999511754945);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001251940483305692);
    AssertAlmostEqual(&test, rTM, 0.9999999600620634);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.255049586342301e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999601609382);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9990339392688379);
    AssertAlmostEqual(&test, rTM, 0.9990339392688379);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9990339392688374);
    AssertAlmostEqual(&test, rTM, 0.9990339392688384);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9990339392687896);
    AssertAlmostEqual(&test, rTM, 0.9990339392688862);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.99903393926401);
    AssertAlmostEqual(&test, rTM, 0.9990339392736659);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9990339387860411);
    AssertAlmostEqual(&test, rTM, 0.9990339397516345);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9990338909903526);
    AssertAlmostEqual(&test, rTM, 0.9990339875449118);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999029123321052);
    AssertAlmostEqual(&test, rTM, 0.9990387313390288);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9986340572660607);
    AssertAlmostEqual(&test, rTM, 0.9993167951689124);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.990333578086697);
    AssertAlmostEqual(&test, rTM, 0.9999038304114183);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9079009285403404);
    AssertAlmostEqual(&test, rTM, 0.9999903239749219);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3936135049958998);
    AssertAlmostEqual(&test, rTM, 0.9999989265270348);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01048140020709287);
    AssertAlmostEqual(&test, rTM, 0.9999995230171358);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000107023320169037);
    AssertAlmostEqual(&test, rTM, 0.9999995328123256);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9952070286010416);
    AssertAlmostEqual(&test, rTM, 0.9952070286010416);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9952070286010416);
    AssertAlmostEqual(&test, rTM, 0.9952070286010416);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9952070286010392);
    AssertAlmostEqual(&test, rTM, 0.9952070286010439);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9952070286008026);
    AssertAlmostEqual(&test, rTM, 0.9952070286012806);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9952070285771343);
    AssertAlmostEqual(&test, rTM, 0.9952070286249489);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9952070262103134);
    AssertAlmostEqual(&test, rTM, 0.9952070309917685);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.995206789534171);
    AssertAlmostEqual(&test, rTM, 0.9952072676560172);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9951831810707509);
    AssertAlmostEqual(&test, rTM, 0.9952307583471078);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9932284561547626);
    AssertAlmostEqual(&test, rTM, 0.9966084670935594);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9528670140848164);
    AssertAlmostEqual(&test, rTM, 0.9995219122380034);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.621283154644505);
    AssertAlmostEqual(&test, rTM, 0.9999505920019873);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03993083299880097);
    AssertAlmostEqual(&test, rTM, 0.9999874984760788);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004328403241471884);
    AssertAlmostEqual(&test, rTM, 0.9999884485317057);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9607322815946349);
    AssertAlmostEqual(&test, rTM, 0.9607322815946349);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9607322815946349);
    AssertAlmostEqual(&test, rTM, 0.9607322815946349);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9607322815946346);
    AssertAlmostEqual(&test, rTM, 0.960732281594635);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9607322815946155);
    AssertAlmostEqual(&test, rTM, 0.9607322815946541);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9607322815927107);
    AssertAlmostEqual(&test, rTM, 0.9607322815965589);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9607322814022283);
    AssertAlmostEqual(&test, rTM, 0.9607322817870413);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9607322623539892);
    AssertAlmostEqual(&test, rTM, 0.9607323008352712);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9607303575796227);
    AssertAlmostEqual(&test, rTM, 0.9607342055172677);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.960540373076947);
    AssertAlmostEqual(&test, rTM, 0.9609232753844565);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9449257839727582);
    AssertAlmostEqual(&test, rTM, 0.9720674101900894);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.670354331861994);
    AssertAlmostEqual(&test, rTM, 0.9959435677173295);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05556848563178083);
    AssertAlmostEqual(&test, rTM, 0.9991038390080458);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006222858626727194);
    AssertAlmostEqual(&test, rTM, 0.9991971565403953);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6775428056060097);
    AssertAlmostEqual(&test, rTM, 0.6775428056060097);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6775428056060097);
    AssertAlmostEqual(&test, rTM, 0.6775428056060097);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6775428056060097);
    AssertAlmostEqual(&test, rTM, 0.6775428056060097);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6775428056060083);
    AssertAlmostEqual(&test, rTM, 0.677542805606011);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6775428056058794);
    AssertAlmostEqual(&test, rTM, 0.6775428056061399);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.677542805592986);
    AssertAlmostEqual(&test, rTM, 0.6775428056190334);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6775428043036372);
    AssertAlmostEqual(&test, rTM, 0.6775428069083821);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6775426753688116);
    AssertAlmostEqual(&test, rTM, 0.6775429358431652);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6775297823443511);
    AssertAlmostEqual(&test, rTM, 0.6775558284428077);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6762450372613528);
    AssertAlmostEqual(&test, rTM, 0.6788363685652938);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5785904806533552);
    AssertAlmostEqual(&test, rTM, 0.7568389502521059);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05733101837211198);
    AssertAlmostEqual(&test, rTM, 0.920412792491733);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006507044701049257);
    AssertAlmostEqual(&test, rTM, 0.9286465843119703);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05807869275950605);
    AssertAlmostEqual(&test, rTM, 0.05807869275950605);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05807869275950605);
    AssertAlmostEqual(&test, rTM, 0.05807869275950605);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05807869275950605);
    AssertAlmostEqual(&test, rTM, 0.05807869275950605);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05807869275950604);
    AssertAlmostEqual(&test, rTM, 0.05807869275950605);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05807869275950553);
    AssertAlmostEqual(&test, rTM, 0.05807869275950656);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05807869275945434);
    AssertAlmostEqual(&test, rTM, 0.05807869275955775);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05807869275433578);
    AssertAlmostEqual(&test, rTM, 0.05807869276467632);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05807869224247874);
    AssertAlmostEqual(&test, rTM, 0.05807869327653335);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05807864105682106);
    AssertAlmostEqual(&test, rTM, 0.05807874446219072);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05807352294817292);
    AssertAlmostEqual(&test, rTM, 0.05808386256772413);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05756624267702897);
    AssertAlmostEqual(&test, rTM, 0.05859111223704998);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03074894098636187);
    AssertAlmostEqual(&test, rTM, 0.08532166756813654);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006472973054225108);
    AssertAlmostEqual(&test, rTM, 0.1151282181243579);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540625711025423);
    AssertAlmostEqual(&test, rTM, 0.0006540625711025423);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540625711025423);
    AssertAlmostEqual(&test, rTM, 0.0006540625711025423);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540625711025423);
    AssertAlmostEqual(&test, rTM, 0.0006540625711025423);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540625711025423);
    AssertAlmostEqual(&test, rTM, 0.0006540625711025423);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540625711025422);
    AssertAlmostEqual(&test, rTM, 0.0006540625711025423);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540625711025357);
    AssertAlmostEqual(&test, rTM, 0.0006540625711025488);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000654062571101889);
    AssertAlmostEqual(&test, rTM, 0.0006540625711031954);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540625710372215);
    AssertAlmostEqual(&test, rTM, 0.000654062571167863);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540625645704669);
    AssertAlmostEqual(&test, rTM, 0.0006540625776346175);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540619178956599);
    AssertAlmostEqual(&test, rTM, 0.0006540632243094245);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006539972568719641);
    AssertAlmostEqual(&test, rTM, 0.0006541278853331148);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006475950860860073);
    AssertAlmostEqual(&test, rTM, 0.0006605300560643604);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003272452194276658);
    AssertAlmostEqual(&test, rTM, 0.0009808797830571198);

    userdata[0] = 100/CAPS_HBAR_EV; /* 100eV */
    userdata[1] = 0.5/CAPS_HBAR_EV; /* 0.5eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.99999911597947);
    AssertAlmostEqual(&test, rTM, 0.9999995579896372);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999937178707442);
    AssertAlmostEqual(&test, rTM, 0.999999937800507);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999374891097099);
    AssertAlmostEqual(&test, rTM, 0.9999999937493407);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993750978425661);
    AssertAlmostEqual(&test, rTM, 0.9999999993749031);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9937685348839466);
    AssertAlmostEqual(&test, rTM, 0.99999999993749);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9394134893243141);
    AssertAlmostEqual(&test, rTM, 0.999999999993746);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5404555424397085);
    AssertAlmostEqual(&test, rTM, 0.9999999999993451);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0243603643976417);
    AssertAlmostEqual(&test, rTM, 0.9999999999997948);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002557894955673509);
    AssertAlmostEqual(&test, rTM, 0.9999999999998045);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559190924274887e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999998046);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559203892251049e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999998046);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.55920402193164e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999999998046);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559204023228446e-12);
    AssertAlmostEqual(&test, rTM, 0.9999999999998046);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999980134119979);
    AssertAlmostEqual(&test, rTM, 0.9999980330811667);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999972044842494);
    AssertAlmostEqual(&test, rTM, 0.9999986022411478);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999801342975726);
    AssertAlmostEqual(&test, rTM, 0.9999998033079426);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.99980233656419);
    AssertAlmostEqual(&test, rTM, 0.9999999802336793);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9980252208734665);
    AssertAlmostEqual(&test, rTM, 0.9999999980232691);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9804270986081766);
    AssertAlmostEqual(&test, rTM, 0.9999999998023172);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8209010802647986);
    AssertAlmostEqual(&test, rTM, 0.9999999999801363);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1744276057157211);
    AssertAlmostEqual(&test, rTM, 0.9999999999972207);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002546188095571619);
    AssertAlmostEqual(&test, rTM, 0.9999999999980362);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559072951126295e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999980461);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559202623337433e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999980462);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.5592039201425e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999999980462);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559203933110559e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999999980462);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999802328381842);
    AssertAlmostEqual(&test, rTM, 0.9999802328579511);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999802318597445);
    AssertAlmostEqual(&test, rTM, 0.9999802338363414);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999801342591489);
    AssertAlmostEqual(&test, rTM, 0.999980330947718);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999720451400939);
    AssertAlmostEqual(&test, rTM, 0.9999860224723606);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998013603500163);
    AssertAlmostEqual(&test, rTM, 0.9999980330773528);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9980251194050156);
    AssertAlmostEqual(&test, rTM, 0.9999998023363329);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9804270515317117);
    AssertAlmostEqual(&test, rTM, 0.9999999802316973);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8209007671257478);
    AssertAlmostEqual(&test, rTM, 0.9999999980136337);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1744271313816801);
    AssertAlmostEqual(&test, rTM, 0.9999999997220687);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002546178295988669);
    AssertAlmostEqual(&test, rTM, 0.9999999998036285);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559063052178681e-05);
    AssertAlmostEqual(&test, rTM, 0.999999999804616);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559192723386637e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999998046258);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559194020181671e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999998046259);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999374910135476);
    AssertAlmostEqual(&test, rTM, 0.9999374910141726);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999374909826065);
    AssertAlmostEqual(&test, rTM, 0.9999374910451135);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999374878885866);
    AssertAlmostEqual(&test, rTM, 0.9999374941389773);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999371792562022);
    AssertAlmostEqual(&test, rTM, 0.9999378012244204);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999116000885022);
    AssertAlmostEqual(&test, rTM, 0.9999557990673683);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993719701325591);
    AssertAlmostEqual(&test, rTM, 0.9999937799480424);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9937681029650366);
    AssertAlmostEqual(&test, rTM, 0.9999993749189964);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9394123133863407);
    AssertAlmostEqual(&test, rTM, 0.9999999374585672);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5404492416646361);
    AssertAlmostEqual(&test, rTM, 0.9999999934506837);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0243594579201058);
    AssertAlmostEqual(&test, rTM, 0.9999999979486272);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002557795071832058);
    AssertAlmostEqual(&test, rTM, 0.9999999980451915);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559090939205683e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999980461812);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559103906168596e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999980461911);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998023078408681);
    AssertAlmostEqual(&test, rTM, 0.9998023078408879);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998023078398897);
    AssertAlmostEqual(&test, rTM, 0.9998023078418663);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998023077420417);
    AssertAlmostEqual(&test, rTM, 0.9998023079397143);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998022979574943);
    AssertAlmostEqual(&test, rTM, 0.9998023177237676);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998013219369135);
    AssertAlmostEqual(&test, rTM, 0.9998032888529536);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997204325152004);
    AssertAlmostEqual(&test, rTM, 0.999860206485804);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9980149950350995);
    AssertAlmostEqual(&test, rTM, 0.9999803271342422);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9804223440993476);
    AssertAlmostEqual(&test, rTM, 0.999998022887182);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8208694568880648);
    AssertAlmostEqual(&test, rTM, 0.9999998013246989);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1743797114099435);
    AssertAlmostEqual(&test, rTM, 0.9999999721988391);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002545198718480256);
    AssertAlmostEqual(&test, rTM, 0.9999999803552961);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.558073544005744e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999804540416);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.558203114954252e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999804550316);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993738788374031);
    AssertAlmostEqual(&test, rTM, 0.9993738788374037);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993738788373722);
    AssertAlmostEqual(&test, rTM, 0.9993738788374347);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993738788342738);
    AssertAlmostEqual(&test, rTM, 0.9993738788405331);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993738785244409);
    AssertAlmostEqual(&test, rTM, 0.9993738791503657);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993738475419319);
    AssertAlmostEqual(&test, rTM, 0.9993739101313113);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993707570020295);
    AssertAlmostEqual(&test, rTM, 0.9993769851893802);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991146458109309);
    AssertAlmostEqual(&test, rTM, 0.9995572248588559);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.993725367981775);
    AssertAlmostEqual(&test, rTM, 0.9999376807418694);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9392959963548961);
    AssertAlmostEqual(&test, rTM, 0.9999937340901998);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5398264272365774);
    AssertAlmostEqual(&test, rTM, 0.9999993436905067);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02427004064242905);
    AssertAlmostEqual(&test, rTM, 0.9999997941060814);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002547944055357831);
    AssertAlmostEqual(&test, rTM, 0.9999998037634036);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.549229958603258e-06);
    AssertAlmostEqual(&test, rTM, 0.9999998038623781);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.997987048220515);
    AssertAlmostEqual(&test, rTM, 0.9979870482205151);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9979870482205141);
    AssertAlmostEqual(&test, rTM, 0.9979870482205161);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9979870482204145);
    AssertAlmostEqual(&test, rTM, 0.9979870482206156);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9979870482104605);
    AssertAlmostEqual(&test, rTM, 0.9979870482305697);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9979870472150534);
    AssertAlmostEqual(&test, rTM, 0.9979870492259761);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9979869476768461);
    AssertAlmostEqual(&test, rTM, 0.9979871487591673);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.997977018663828);
    AssertAlmostEqual(&test, rTM, 0.9979970281024166);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9971544440365619);
    AssertAlmostEqual(&test, rTM, 0.9985762077049744);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9799536927423428);
    AssertAlmostEqual(&test, rTM, 0.9997995119397154);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.817774400305614);
    AssertAlmostEqual(&test, rTM, 0.9999797494138307);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1697682310293579);
    AssertAlmostEqual(&test, rTM, 0.9999971397021812);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002450906336517484);
    AssertAlmostEqual(&test, rTM, 0.9999979599547867);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.462843240355904e-05);
    AssertAlmostEqual(&test, rTM, 0.9999979698302499);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.992655355562703);
    AssertAlmostEqual(&test, rTM, 0.992655355562703);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9926553555627029);
    AssertAlmostEqual(&test, rTM, 0.992655355562703);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9926553555626993);
    AssertAlmostEqual(&test, rTM, 0.9926553555627067);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9926553555623371);
    AssertAlmostEqual(&test, rTM, 0.9926553555630688);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9926553555261151);
    AssertAlmostEqual(&test, rTM, 0.9926553555992909);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9926553519039173);
    AssertAlmostEqual(&test, rTM, 0.9926553592214868);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9926549896932609);
    AssertAlmostEqual(&test, rTM, 0.9926557214139875);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9926188593844166);
    AssertAlmostEqual(&test, rTM, 0.9926916719468588);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9896289500854522);
    AssertAlmostEqual(&test, rTM, 0.9948009248105845);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9286081773572921);
    AssertAlmostEqual(&test, rTM, 0.9992662580646426);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4860400540226439);
    AssertAlmostEqual(&test, rTM, 0.9999214418319045);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01775403259414011);
    AssertAlmostEqual(&test, rTM, 0.9999718470680882);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001839488779823855);
    AssertAlmostEqual(&test, rTM, 0.999972819274806);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9571581711352075);
    AssertAlmostEqual(&test, rTM, 0.9571581711352075);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9571581711352075);
    AssertAlmostEqual(&test, rTM, 0.9571581711352075);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9571581711352073);
    AssertAlmostEqual(&test, rTM, 0.9571581711352077);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9571581711351866);
    AssertAlmostEqual(&test, rTM, 0.9571581711352285);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9571581711331123);
    AssertAlmostEqual(&test, rTM, 0.9571581711373027);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9571581709256874);
    AssertAlmostEqual(&test, rTM, 0.9571581713447277);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9571581501831984);
    AssertAlmostEqual(&test, rTM, 0.9571581920872066);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9571560759884438);
    AssertAlmostEqual(&test, rTM, 0.9571602661817574);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9569491952531625);
    AssertAlmostEqual(&test, rTM, 0.9573661547126846);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9399593104596057);
    AssertAlmostEqual(&test, rTM, 0.9695077966435803);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6462239950852067);
    AssertAlmostEqual(&test, rTM, 0.9955505386483062);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04732531664650582);
    AssertAlmostEqual(&test, rTM, 0.9989470144453345);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005209483477180125);
    AssertAlmostEqual(&test, rTM, 0.999041132996711);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6749089561704219);
    AssertAlmostEqual(&test, rTM, 0.6749089561704219);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6749089561704219);
    AssertAlmostEqual(&test, rTM, 0.6749089561704219);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6749089561704219);
    AssertAlmostEqual(&test, rTM, 0.6749089561704219);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6749089561704206);
    AssertAlmostEqual(&test, rTM, 0.6749089561704232);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6749089561702909);
    AssertAlmostEqual(&test, rTM, 0.6749089561705529);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6749089561573223);
    AssertAlmostEqual(&test, rTM, 0.6749089561835215);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.674908954860459);
    AssertAlmostEqual(&test, rTM, 0.6749089574803848);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6749088251741799);
    AssertAlmostEqual(&test, rTM, 0.6749090871666213);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6748958570084913);
    AssertAlmostEqual(&test, rTM, 0.6749220549069971);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6736036387750582);
    AssertAlmostEqual(&test, rTM, 0.6762100633130772);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5754697389583573);
    AssertAlmostEqual(&test, rTM, 0.7546829817756419);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05630849257406233);
    AssertAlmostEqual(&test, rTM, 0.9190754354120528);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006377311801619547);
    AssertAlmostEqual(&test, rTM, 0.9273005747410497);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05797308567284013);
    AssertAlmostEqual(&test, rTM, 0.05797308567284013);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05797308567284013);
    AssertAlmostEqual(&test, rTM, 0.05797308567284013);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05797308567284013);
    AssertAlmostEqual(&test, rTM, 0.05797308567284013);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05797308567284012);
    AssertAlmostEqual(&test, rTM, 0.05797308567284014);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05797308567283962);
    AssertAlmostEqual(&test, rTM, 0.05797308567284064);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05797308567278851);
    AssertAlmostEqual(&test, rTM, 0.05797308567289175);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05797308566767816);
    AssertAlmostEqual(&test, rTM, 0.0579730856780021);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05797308515664357);
    AssertAlmostEqual(&test, rTM, 0.05797308618903669);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05797303405323);
    AssertAlmostEqual(&test, rTM, 0.05797313729244996);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05796792416834833);
    AssertAlmostEqual(&test, rTM, 0.05797824717423258);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05746145988965209);
    AssertAlmostEqual(&test, rTM, 0.05848468100531435);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03068988681905722);
    AssertAlmostEqual(&test, rTM, 0.08516996028550133);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006459771423488475);
    AssertAlmostEqual(&test, rTM, 0.1149203970164662);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000653928869975037);
    AssertAlmostEqual(&test, rTM, 0.000653928869975037);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000653928869975037);
    AssertAlmostEqual(&test, rTM, 0.000653928869975037);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000653928869975037);
    AssertAlmostEqual(&test, rTM, 0.000653928869975037);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000653928869975037);
    AssertAlmostEqual(&test, rTM, 0.000653928869975037);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000653928869975037);
    AssertAlmostEqual(&test, rTM, 0.0006539288699750371);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006539288699750305);
    AssertAlmostEqual(&test, rTM, 0.0006539288699750435);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000653928869974384);
    AssertAlmostEqual(&test, rTM, 0.0006539288699756901);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006539288699097296);
    AssertAlmostEqual(&test, rTM, 0.0006539288700403445);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006539288634442952);
    AssertAlmostEqual(&test, rTM, 0.0006539288765057788);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006539282169015063);
    AssertAlmostEqual(&test, rTM, 0.0006539295230485677);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006538635690783001);
    AssertAlmostEqual(&test, rTM, 0.0006539941708717684);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006474627053066371);
    AssertAlmostEqual(&test, rTM, 0.0006603950345887537);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003271782814025222);
    AssertAlmostEqual(&test, rTM, 0.0009806793189128815);

    userdata[0] = 100/CAPS_HBAR_EV; /* 100eV */
    userdata[1] = 1/CAPS_HBAR_EV; /* 1eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999987498064071);
    AssertAlmostEqual(&test, rTM, 0.9999993749030082);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999911157391737);
    AssertAlmostEqual(&test, rTM, 0.9999999120366346);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999115973957833);
    AssertAlmostEqual(&test, rTM, 0.9999999911602329);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991163692985978);
    AssertAlmostEqual(&test, rTM, 0.9999999991159795);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9911987790497451);
    AssertAlmostEqual(&test, rTM, 0.999999999911597);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9154190580581681);
    AssertAlmostEqual(&test, rTM, 0.9999999999911512);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4242187861262995);
    AssertAlmostEqual(&test, rTM, 0.9999999999990334);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01247865837030146);
    AssertAlmostEqual(&test, rTM, 0.9999999999995994);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001279274642580166);
    AssertAlmostEqual(&test, rTM, 0.9999999999996092);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279598739368619e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999996092);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279601981373147e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999996092);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279602013793296e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999999996092);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279602014117498e-12);
    AssertAlmostEqual(&test, rTM, 0.9999999999996092);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999971905414879);
    AssertAlmostEqual(&test, rTM, 0.9999972183578703);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999960465460392);
    AssertAlmostEqual(&test, rTM, 0.9999980232710659);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999719057700657);
    AssertAlmostEqual(&test, rTM, 0.9999997218354388);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997204731355016);
    AssertAlmostEqual(&test, rTM, 0.9999999720462015);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9972083837095407);
    AssertAlmostEqual(&test, rTM, 0.9999999972044791);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9724328193413913);
    AssertAlmostEqual(&test, rTM, 0.9999999997204208);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7568050478044702);
    AssertAlmostEqual(&test, rTM, 0.999999999971773);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1029657829286505);
    AssertAlmostEqual(&test, rTM, 0.9999999999951955);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001276337667697694);
    AssertAlmostEqual(&test, rTM, 0.9999999999960826);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279569245043194e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999960925);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279601664144627e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999960926);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279601988346011e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999999960926);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279601991588026e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999999960926);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999720451534243);
    AssertAlmostEqual(&test, rTM, 0.9999720451813787);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999720437697144);
    AssertAlmostEqual(&test, rTM, 0.9999720465650188);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999719057428962);
    AssertAlmostEqual(&test, rTM, 0.9999721838999889);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999604661254959);
    AssertAlmostEqual(&test, rTM, 0.9999802328673763);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997190929451434);
    AssertAlmostEqual(&test, rTM, 0.9999972183551532);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9972082430251229);
    AssertAlmostEqual(&test, rTM, 0.9999997204615092);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9724327795988127);
    AssertAlmostEqual(&test, rTM, 0.9999999720420603);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7568048441320414);
    AssertAlmostEqual(&test, rTM, 0.9999999971773013);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1029656209485318);
    AssertAlmostEqual(&test, rTM, 0.9999999995195493);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001276335205308842);
    AssertAlmostEqual(&test, rTM, 0.999999999608254);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.27956677017474e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999996092428);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279599189150777e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999996092527);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279599513350907e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999996092528);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999116009515414);
    AssertAlmostEqual(&test, rTM, 0.9999116009524254);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999116009077859);
    AssertAlmostEqual(&test, rTM, 0.9999116009961809);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999115965323369);
    AssertAlmostEqual(&test, rTM, 0.999911605371409);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999111600758263);
    AssertAlmostEqual(&test, rTM, 0.999912039640349);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998749871562567);
    AssertAlmostEqual(&test, rTM, 0.9999374916244187);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991119558669819);
    AssertAlmostEqual(&test, rTM, 0.9999912036149958);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9911982553972627);
    AssertAlmostEqual(&test, rTM, 0.9999991160063996);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.915418227964539);
    AssertAlmostEqual(&test, rTM, 0.9999999115107754);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4242154340770521);
    AssertAlmostEqual(&test, rTM, 0.9999999903346132);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01247842060738756);
    AssertAlmostEqual(&test, rTM, 0.9999999959937066);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000127924965835554);
    AssertAlmostEqual(&test, rTM, 0.9999999960914588);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279573742484973e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999960924487);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.27957698436285e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999960924586);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997204598120395);
    AssertAlmostEqual(&test, rTM, 0.9997204598120674);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997204598106559);
    AssertAlmostEqual(&test, rTM, 0.9997204598134509);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997204596723029);
    AssertAlmostEqual(&test, rTM, 0.9997204599518039);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997204458373473);
    AssertAlmostEqual(&test, rTM, 0.9997204737860611);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997190657838733);
    AssertAlmostEqual(&test, rTM, 0.9997218469238661);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999604693364986);
    AssertAlmostEqual(&test, rTM, 0.9998023271432831);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9971942076732973);
    AssertAlmostEqual(&test, rTM, 0.9999721811831623);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9724288053798036);
    AssertAlmostEqual(&test, rTM, 0.9999972040779022);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7567844781645293);
    AssertAlmostEqual(&test, rTM, 0.9999997177024833);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1029494255373305);
    AssertAlmostEqual(&test, rTM, 0.999999951947213);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001276089014395356);
    AssertAlmostEqual(&test, rTM, 0.9999999608178457);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279319331666063e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999609167182);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279351738106294e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999609177082);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991155073554416);
    AssertAlmostEqual(&test, rTM, 0.9991155073554425);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991155073553979);
    AssertAlmostEqual(&test, rTM, 0.9991155073554863);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991155073510215);
    AssertAlmostEqual(&test, rTM, 0.9991155073598625);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991155069133915);
    AssertAlmostEqual(&test, rTM, 0.9991155077974924);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991154631514827);
    AssertAlmostEqual(&test, rTM, 0.9991155515571933);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991110978549883);
    AssertAlmostEqual(&test, rTM, 0.9991198949916958);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9987493677249552);
    AssertAlmostEqual(&test, rTM, 0.999374488168786);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9911464797673536);
    AssertAlmostEqual(&test, rTM, 0.9999119537674048);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9153360786259461);
    AssertAlmostEqual(&test, rTM, 0.9999911429854678);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4238838671505173);
    AssertAlmostEqual(&test, rTM, 0.9999990323751941);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01245492450528109);
    AssertAlmostEqual(&test, rTM, 0.9999995986148017);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001276780795008757);
    AssertAlmostEqual(&test, rTM, 0.9999996083902594);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.277103629432975e-06);
    AssertAlmostEqual(&test, rTM, 0.9999996084892465);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9971812850010242);
    AssertAlmostEqual(&test, rTM, 0.9971812850010242);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9971812850010228);
    AssertAlmostEqual(&test, rTM, 0.9971812850010257);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9971812850008834);
    AssertAlmostEqual(&test, rTM, 0.997181285001165);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9971812849869506);
    AssertAlmostEqual(&test, rTM, 0.997181285015098);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9971812835936562);
    AssertAlmostEqual(&test, rTM, 0.9971812864083915);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9971811442677116);
    AssertAlmostEqual(&test, rTM, 0.9971814257273205);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9971672464252195);
    AssertAlmostEqual(&test, rTM, 0.9971952541020823);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960160647039784);
    AssertAlmostEqual(&test, rTM, 0.9980060424386694);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9720317673843616);
    AssertAlmostEqual(&test, rTM, 0.9997191430048321);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7547605095735995);
    AssertAlmostEqual(&test, rTM, 0.9999714951598181);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1013554757660668);
    AssertAlmostEqual(&test, rTM, 0.9999951175716815);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001251940470942476);
    AssertAlmostEqual(&test, rTM, 0.9999960062221125);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.255049586218054e-05);
    AssertAlmostEqual(&test, rTM, 0.9999960161095351);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.99038131886563);
    AssertAlmostEqual(&test, rTM, 0.99038131886563);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9903813188656299);
    AssertAlmostEqual(&test, rTM, 0.99038131886563);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9903813188656252);
    AssertAlmostEqual(&test, rTM, 0.9903813188656347);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9903813188651513);
    AssertAlmostEqual(&test, rTM, 0.9903813188661086);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9903813188177689);
    AssertAlmostEqual(&test, rTM, 0.9903813189134909);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9903813140795321);
    AssertAlmostEqual(&test, rTM, 0.9903813236517254);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9903808402678071);
    AssertAlmostEqual(&test, rTM, 0.9903817974397554);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.990333578086697);
    AssertAlmostEqual(&test, rTM, 0.9904288249949897);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9864243324534478);
    AssertAlmostEqual(&test, rTM, 0.9931888919097651);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9074682624586705);
    AssertAlmostEqual(&test, rTM, 0.9990376211884398);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3935965503084503);
    AssertAlmostEqual(&test, rTM, 0.9998926651956794);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01048139004578263);
    AssertAlmostEqual(&test, rTM, 0.9999523039434599);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001070233191097329);
    AssertAlmostEqual(&test, rTM, 0.9999532833930372);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9530953082699752);
    AssertAlmostEqual(&test, rTM, 0.9530953082699752);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9530953082699752);
    AssertAlmostEqual(&test, rTM, 0.9530953082699752);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.953095308269975);
    AssertAlmostEqual(&test, rTM, 0.9530953082699755);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9530953082699523);
    AssertAlmostEqual(&test, rTM, 0.9530953082699981);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9530953082676863);
    AssertAlmostEqual(&test, rTM, 0.9530953082722641);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.953095308041084);
    AssertAlmostEqual(&test, rTM, 0.9530953084988665);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9530952853808567);
    AssertAlmostEqual(&test, rTM, 0.9530953311590827);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9530930194175289);
    AssertAlmostEqual(&test, rTM, 0.9530975970134177);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9528670140848164);
    AssertAlmostEqual(&test, rTM, 0.9533225231154185);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9343232438085881);
    AssertAlmostEqual(&test, rTM, 0.9665945077003363);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6198519326646841);
    AssertAlmostEqual(&test, rTM, 0.9950968834115199);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03992718376706489);
    AssertAlmostEqual(&test, rTM, 0.9987513428028746);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004328398960064892);
    AssertAlmostEqual(&test, rTM, 0.9988461721128812);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.671668854848256);
    AssertAlmostEqual(&test, rTM, 0.671668854848256);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.671668854848256);
    AssertAlmostEqual(&test, rTM, 0.671668854848256);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.671668854848256);
    AssertAlmostEqual(&test, rTM, 0.671668854848256);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6716688548482547);
    AssertAlmostEqual(&test, rTM, 0.6716688548482573);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6716688548481241);
    AssertAlmostEqual(&test, rTM, 0.6716688548483879);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6716688548350638);
    AssertAlmostEqual(&test, rTM, 0.6716688548614482);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6716688535290366);
    AssertAlmostEqual(&test, rTM, 0.6716688561674754);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6716687229263597);
    AssertAlmostEqual(&test, rTM, 0.6716689867701098);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6716556631259593);
    AssertAlmostEqual(&test, rTM, 0.6716820461446487);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.670354331861994);
    AssertAlmostEqual(&test, rTM, 0.6729791621875731);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.571638658760516);
    AssertAlmostEqual(&test, rTM, 0.7520257533964058);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05508066163348156);
    AssertAlmostEqual(&test, rTM, 0.9174096156137859);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006222243391428708);
    AssertAlmostEqual(&test, rTM, 0.925623539957793);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05784161748324198);
    AssertAlmostEqual(&test, rTM, 0.05784161748324198);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05784161748324198);
    AssertAlmostEqual(&test, rTM, 0.05784161748324198);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05784161748324198);
    AssertAlmostEqual(&test, rTM, 0.05784161748324198);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05784161748324197);
    AssertAlmostEqual(&test, rTM, 0.05784161748324199);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05784161748324147);
    AssertAlmostEqual(&test, rTM, 0.05784161748324249);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05784161748319046);
    AssertAlmostEqual(&test, rTM, 0.05784161748329349);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05784161747809036);
    AssertAlmostEqual(&test, rTM, 0.05784161748839359);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05784161696808013);
    AssertAlmostEqual(&test, rTM, 0.05784161799840383);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05784156596710273);
    AssertAlmostEqual(&test, rTM, 0.05784166899938092);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05783646632503715);
    AssertAlmostEqual(&test, rTM, 0.05784676863836691);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.057331018372112);
    AssertAlmostEqual(&test, rTM, 0.0583521863349777);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0306163876245729);
    AssertAlmostEqual(&test, rTM, 0.08498108458560805);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006443344918340589);
    AssertAlmostEqual(&test, rTM, 0.1146616733485741);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006537618204136613);
    AssertAlmostEqual(&test, rTM, 0.0006537618204136613);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006537618204136613);
    AssertAlmostEqual(&test, rTM, 0.0006537618204136613);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006537618204136613);
    AssertAlmostEqual(&test, rTM, 0.0006537618204136613);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006537618204136613);
    AssertAlmostEqual(&test, rTM, 0.0006537618204136613);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006537618204136613);
    AssertAlmostEqual(&test, rTM, 0.0006537618204136614);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006537618204136548);
    AssertAlmostEqual(&test, rTM, 0.0006537618204136679);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006537618204130084);
    AssertAlmostEqual(&test, rTM, 0.0006537618204143142);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006537618203483705);
    AssertAlmostEqual(&test, rTM, 0.000653761820478952);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006537618138845857);
    AssertAlmostEqual(&test, rTM, 0.0006537618269427369);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006537611675067435);
    AssertAlmostEqual(&test, rTM, 0.0006537624733205791);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006536965361765718);
    AssertAlmostEqual(&test, rTM, 0.0006538271046507452);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006472973054225109);
    AssertAlmostEqual(&test, rTM, 0.0006602263353501704);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003270946473704986);
    AssertAlmostEqual(&test, rTM, 0.0009804288539290908);

    userdata[0] = 1000/CAPS_HBAR_EV; /* 1000eV */
    userdata[1] = 1e-05/CAPS_HBAR_EV; /* 1e-05eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999996046152);
    AssertAlmostEqual(&test, rTM, 0.9999999998023076);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999971902631);
    AssertAlmostEqual(&test, rTM, 0.9999999999721808);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999720406758);
    AssertAlmostEqual(&test, rTM, 0.9999999999972043);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999997204206318);
    AssertAlmostEqual(&test, rTM, 0.9999999999997204);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999972042112193);
    AssertAlmostEqual(&test, rTM, 0.999999999999972);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999720424640689);
    AssertAlmostEqual(&test, rTM, 0.9999999999999972);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997204598120533);
    AssertAlmostEqual(&test, rTM, 0.9999999999999997);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9972081128217098);
    AssertAlmostEqual(&test, rTM, 1);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9724301645686363);
    AssertAlmostEqual(&test, rTM, 1);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7567845829364064);
    AssertAlmostEqual(&test, rTM, 1);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1029494263746385);
    AssertAlmostEqual(&test, rTM, 1);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001276089014522639);
    AssertAlmostEqual(&test, rTM, 1);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279319331667342e-05);
    AssertAlmostEqual(&test, rTM, 1);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999991107025);
    AssertAlmostEqual(&test, rTM, 0.9999999991195074);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999987485849);
    AssertAlmostEqual(&test, rTM, 0.9999999993742925);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999911070252);
    AssertAlmostEqual(&test, rTM, 0.9999999999119508);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999115071728);
    AssertAlmostEqual(&test, rTM, 0.9999999999911516);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999991151158812);
    AssertAlmostEqual(&test, rTM, 0.9999999999991152);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999911511984281);
    AssertAlmostEqual(&test, rTM, 0.9999999999999115);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999115155082225);
    AssertAlmostEqual(&test, rTM, 0.9999999999999911);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991155073554416);
    AssertAlmostEqual(&test, rTM, 0.9999999999999991);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9911902237023361);
    AssertAlmostEqual(&test, rTM, 0.9999999999999999);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9153401244070486);
    AssertAlmostEqual(&test, rTM, 1);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4238840386576299);
    AssertAlmostEqual(&test, rTM, 1);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.012454924626766);
    AssertAlmostEqual(&test, rTM, 1);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001276780795136403);
    AssertAlmostEqual(&test, rTM, 1);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999903347182);
    AssertAlmostEqual(&test, rTM, 0.9999999903347279);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999903342397);
    AssertAlmostEqual(&test, rTM, 0.9999999903352063);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999902865168);
    AssertAlmostEqual(&test, rTM, 0.9999999903826899);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999863312342);
    AssertAlmostEqual(&test, rTM, 0.9999999931656171);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999028651724);
    AssertAlmostEqual(&test, rTM, 0.999999999038269);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999990334244357);
    AssertAlmostEqual(&test, rTM, 0.9999999999033521);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999990334764814);
    AssertAlmostEqual(&test, rTM, 0.9999999999903347);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999033518996627);
    AssertAlmostEqual(&test, rTM, 0.9999999999990334);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9990339392687896);
    AssertAlmostEqual(&test, rTM, 0.9999999999999033);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9903813188656252);
    AssertAlmostEqual(&test, rTM, 0.9999999999999903);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9079053108836349);
    AssertAlmostEqual(&test, rTM, 0.999999999999999);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3936136762641869);
    AssertAlmostEqual(&test, rTM, 0.9999999999999999);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01048140030973247);
    AssertAlmostEqual(&test, rTM, 1);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999519550095);
    AssertAlmostEqual(&test, rTM, 0.99999995195501);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999519549857);
    AssertAlmostEqual(&test, rTM, 0.9999999519550338);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999519526075);
    AssertAlmostEqual(&test, rTM, 0.9999999519574118);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999517153824);
    AssertAlmostEqual(&test, rTM, 0.9999999521934478);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999320541239);
    AssertAlmostEqual(&test, rTM, 0.9999999660270613);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999995171539285);
    AssertAlmostEqual(&test, rTM, 0.9999999952193447);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999951952721817);
    AssertAlmostEqual(&test, rTM, 0.9999999995195741);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999519561387047);
    AssertAlmostEqual(&test, rTM, 0.999999999951955);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995196654855888);
    AssertAlmostEqual(&test, rTM, 0.9999999999951955);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9952070286008026);
    AssertAlmostEqual(&test, rTM, 0.9999999999995195);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9530953082699523);
    AssertAlmostEqual(&test, rTM, 0.9999999999999519);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6212976663489538);
    AssertAlmostEqual(&test, rTM, 0.999999999999995);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03993086986313605);
    AssertAlmostEqual(&test, rTM, 0.9999999999999988);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999995993783741);
    AssertAlmostEqual(&test, rTM, 0.9999995993783742);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999995993783721);
    AssertAlmostEqual(&test, rTM, 0.9999995993783761);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999995993781738);
    AssertAlmostEqual(&test, rTM, 0.9999995993785745);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999995993583436);
    AssertAlmostEqual(&test, rTM, 0.9999995993984038);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999995973802493);
    AssertAlmostEqual(&test, rTM, 0.9999996013665827);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999994334355103);
    AssertAlmostEqual(&test, rTM, 0.999999716717715);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999959738097879);
    AssertAlmostEqual(&test, rTM, 0.9999999601366512);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999599366288945);
    AssertAlmostEqual(&test, rTM, 0.9999999959939833);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999599458334528);
    AssertAlmostEqual(&test, rTM, 0.9999999995993785);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.996001799769468);
    AssertAlmostEqual(&test, rTM, 0.9999999999599377);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9607322815927107);
    AssertAlmostEqual(&test, rTM, 0.999999999995993);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6716688548481241);
    AssertAlmostEqual(&test, rTM, 0.9999999999995914);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05557345736897712);
    AssertAlmostEqual(&test, rTM, 0.9999999999999103);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.99999608255551);
    AssertAlmostEqual(&test, rTM, 0.99999608255551);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999960825555098);
    AssertAlmostEqual(&test, rTM, 0.9999960825555101);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999960825554903);
    AssertAlmostEqual(&test, rTM, 0.9999960825555295);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999960825535512);
    AssertAlmostEqual(&test, rTM, 0.9999960825574686);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999996082359643);
    AssertAlmostEqual(&test, rTM, 0.9999960827513671);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999960630170507);
    AssertAlmostEqual(&test, rTM, 0.9999961019970039);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999944599013671);
    AssertAlmostEqual(&test, rTM, 0.999997229946847);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999606308679947);
    AssertAlmostEqual(&test, rTM, 0.9999996101990166);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996083119292173);
    AssertAlmostEqual(&test, rTM, 0.9999999608274369);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.996090211586545);
    AssertAlmostEqual(&test, rTM, 0.9999999960825423);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9615852856084215);
    AssertAlmostEqual(&test, rTM, 0.9999999996081796);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.677542805592986);
    AssertAlmostEqual(&test, rTM, 0.999999999960081);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05784161748319045);
    AssertAlmostEqual(&test, rTM, 0.9999999999913847);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999609161158103);
    AssertAlmostEqual(&test, rTM, 0.9999609161158103);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999609161158103);
    AssertAlmostEqual(&test, rTM, 0.9999609161158103);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999609161158083);
    AssertAlmostEqual(&test, rTM, 0.9999609161158123);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999609161156149);
    AssertAlmostEqual(&test, rTM, 0.9999609161160057);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999609160962687);
    AssertAlmostEqual(&test, rTM, 0.9999609161353519);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999609141617031);
    AssertAlmostEqual(&test, rTM, 0.9999609180698198);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999607211863387);
    AssertAlmostEqual(&test, rTM, 0.9999611100779217);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999447274883246);
    AssertAlmostEqual(&test, rTM, 0.9999723633622651);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996072812857492);
    AssertAlmostEqual(&test, rTM, 0.9999961109396576);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960989711309085);
    AssertAlmostEqual(&test, rTM, 0.9999996091723912);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616716755287918);
    AssertAlmostEqual(&test, rTM, 0.9999999609079098);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6781406702075106);
    AssertAlmostEqual(&test, rTM, 0.9999999960176019);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05807869275433576);
    AssertAlmostEqual(&test, rTM, 0.999999999142003);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996093198453243);
    AssertAlmostEqual(&test, rTM, 0.9996093198453243);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996093198453243);
    AssertAlmostEqual(&test, rTM, 0.9996093198453243);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996093198453242);
    AssertAlmostEqual(&test, rTM, 0.9996093198453245);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996093198453048);
    AssertAlmostEqual(&test, rTM, 0.9996093198453438);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996093198433713);
    AssertAlmostEqual(&test, rTM, 0.9996093198472774);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996093196500225);
    AssertAlmostEqual(&test, rTM, 0.9996093200406261);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996093003156216);
    AssertAlmostEqual(&test, rTM, 0.9996093393740512);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996073716863881);
    AssertAlmostEqual(&test, rTM, 0.9996112583396866);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994475395382123);
    AssertAlmostEqual(&test, rTM, 0.9997237316017215);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960806491587605);
    AssertAlmostEqual(&test, rTM, 0.9999611189581747);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616784680262591);
    AssertAlmostEqual(&test, rTM, 0.9999960918924472);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6782004355180385);
    AssertAlmostEqual(&test, rTM, 0.9999996018555335);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810250706293128);
    AssertAlmostEqual(&test, rTM, 0.9999999142357139);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9961001517959418);
    AssertAlmostEqual(&test, rTM, 0.9961001517959418);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9961001517959418);
    AssertAlmostEqual(&test, rTM, 0.9961001517959418);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9961001517959418);
    AssertAlmostEqual(&test, rTM, 0.9961001517959419);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9961001517959399);
    AssertAlmostEqual(&test, rTM, 0.9961001517959438);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9961001517957473);
    AssertAlmostEqual(&test, rTM, 0.9961001517961364);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9961001517764807);
    AssertAlmostEqual(&test, rTM, 0.996100151815403);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9961001498498279);
    AssertAlmostEqual(&test, rTM, 0.9961001537420549);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960999571893789);
    AssertAlmostEqual(&test, rTM, 0.9961003463928131);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960807392517025);
    AssertAlmostEqual(&test, rTM, 0.9961194683745695);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9944892432312221);
    AssertAlmostEqual(&test, rTM, 0.9972408098061243);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9614938461845235);
    AssertAlmostEqual(&test, rTM, 0.9996111938563731);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6781935520065663);
    AssertAlmostEqual(&test, rTM, 0.9999601893372164);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810483841676955);
    AssertAlmostEqual(&test, rTM, 0.9999914239951389);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616812984031826);
    AssertAlmostEqual(&test, rTM, 0.9616812984031826);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616812984031826);
    AssertAlmostEqual(&test, rTM, 0.9616812984031826);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616812984031826);
    AssertAlmostEqual(&test, rTM, 0.9616812984031826);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616812984031824);
    AssertAlmostEqual(&test, rTM, 0.9616812984031828);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616812984031639);
    AssertAlmostEqual(&test, rTM, 0.9616812984032014);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616812984013041);
    AssertAlmostEqual(&test, rTM, 0.9616812984050611);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616812982153317);
    AssertAlmostEqual(&test, rTM, 0.9616812985910336);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616812796180878);
    AssertAlmostEqual(&test, rTM, 0.9616813171882683);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616794199420289);
    AssertAlmostEqual(&test, rTM, 0.9616831767740535);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9614939331336882);
    AssertAlmostEqual(&test, rTM, 0.9618677697025253);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.946245826831921);
    AssertAlmostEqual(&test, rTM, 0.9727465512464106);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6769113001968924);
    AssertAlmostEqual(&test, rTM, 0.9960470278174715);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05809995651671238);
    AssertAlmostEqual(&test, rTM, 0.9991430994373307);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6782072150130435);
    AssertAlmostEqual(&test, rTM, 0.6782072150130435);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6782072150130435);
    AssertAlmostEqual(&test, rTM, 0.6782072150130435);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6782072150130435);
    AssertAlmostEqual(&test, rTM, 0.6782072150130435);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6782072150130435);
    AssertAlmostEqual(&test, rTM, 0.6782072150130435);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6782072150130422);
    AssertAlmostEqual(&test, rTM, 0.6782072150130448);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6782072150129135);
    AssertAlmostEqual(&test, rTM, 0.6782072150131736);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.678207215000039);
    AssertAlmostEqual(&test, rTM, 0.678207215026048);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6782072137125951);
    AssertAlmostEqual(&test, rTM, 0.6782072163134919);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6782070849682498);
    AssertAlmostEqual(&test, rTM, 0.6782073450577947);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6781942109907789);
    AssertAlmostEqual(&test, rTM, 0.6782202186105792);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6769113602756173);
    AssertAlmostEqual(&test, rTM, 0.6794988656614633);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5793786299311463);
    AssertAlmostEqual(&test, rTM, 0.7573822374355484);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05759249568399736);
    AssertAlmostEqual(&test, rTM, 0.9207477860715882);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810515461629602);
    AssertAlmostEqual(&test, rTM, 0.05810515461629602);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810515461629602);
    AssertAlmostEqual(&test, rTM, 0.05810515461629602);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810515461629602);
    AssertAlmostEqual(&test, rTM, 0.05810515461629602);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810515461629602);
    AssertAlmostEqual(&test, rTM, 0.05810515461629602);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810515461629601);
    AssertAlmostEqual(&test, rTM, 0.05810515461629603);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0581051546162955);
    AssertAlmostEqual(&test, rTM, 0.05810515461629654);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0581051546162443);
    AssertAlmostEqual(&test, rTM, 0.05810515461634774);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810515461112366);
    AssertAlmostEqual(&test, rTM, 0.05810515462146838);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810515409906061);
    AssertAlmostEqual(&test, rTM, 0.05810515513353143);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810510289280096);
    AssertAlmostEqual(&test, rTM, 0.05810520633979077);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05809998272411641);
    AssertAlmostEqual(&test, rTM, 0.05811032650535666);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05759249804808563);
    AssertAlmostEqual(&test, rTM, 0.05861778054085608);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03076373994129392);
    AssertAlmostEqual(&test, rTM, 0.08535967865244831);

    userdata[0] = 1000/CAPS_HBAR_EV; /* 1000eV */
    userdata[1] = 0.0001/CAPS_HBAR_EV; /* 0.0001eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999987497934);
    AssertAlmostEqual(&test, rTM, 0.9999999993748967);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999999991115613);
    AssertAlmostEqual(&test, rTM, 0.9999999999120358);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999115926284);
    AssertAlmostEqual(&test, rTM, 0.9999999999911602);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999999115970394);
    AssertAlmostEqual(&test, rTM, 0.9999999999991159);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999991159743484);
    AssertAlmostEqual(&test, rTM, 0.9999999999999116);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999911600951979);
    AssertAlmostEqual(&test, rTM, 0.9999999999999911);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991163611130518);
    AssertAlmostEqual(&test, rTM, 0.9999999999999991);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.991198693506403);
    AssertAlmostEqual(&test, rTM, 0.9999999999999999);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9154182683878984);
    AssertAlmostEqual(&test, rTM, 1);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4242154357920784);
    AssertAlmostEqual(&test, rTM, 1);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01247842060860464);
    AssertAlmostEqual(&test, rTM, 1);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001279249658356818);
    AssertAlmostEqual(&test, rTM, 1);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279573742484986e-06);
    AssertAlmostEqual(&test, rTM, 1);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999971902631);
    AssertAlmostEqual(&test, rTM, 0.9999999972180823);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999960461521);
    AssertAlmostEqual(&test, rTM, 0.999999998023076);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999719026318);
    AssertAlmostEqual(&test, rTM, 0.9999999997218082);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999999720406793);
    AssertAlmostEqual(&test, rTM, 0.9999999999720435);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999972042098354);
    AssertAlmostEqual(&test, rTM, 0.9999999999972042);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999720424639305);
    AssertAlmostEqual(&test, rTM, 0.9999999999997204);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997204598120395);
    AssertAlmostEqual(&test, rTM, 0.999999999999972);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9972081128217084);
    AssertAlmostEqual(&test, rTM, 0.9999999999999972);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9724301645686362);
    AssertAlmostEqual(&test, rTM, 0.9999999999999997);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7567845829364064);
    AssertAlmostEqual(&test, rTM, 1);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1029494263746385);
    AssertAlmostEqual(&test, rTM, 1);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001276089014522639);
    AssertAlmostEqual(&test, rTM, 1);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279319331667343e-05);
    AssertAlmostEqual(&test, rTM, 1);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999717730264);
    AssertAlmostEqual(&test, rTM, 0.9999999717730546);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999717716291);
    AssertAlmostEqual(&test, rTM, 0.9999999717744517);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999716322567);
    AssertAlmostEqual(&test, rTM, 0.9999999719131255);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999600810512);
    AssertAlmostEqual(&test, rTM, 0.9999999800405254);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999997163226036);
    AssertAlmostEqual(&test, rTM, 0.9999999971913125);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999971771668589);
    AssertAlmostEqual(&test, rTM, 0.9999999997177446);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999717734243243);
    AssertAlmostEqual(&test, rTM, 0.999999999971773);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997177702344365);
    AssertAlmostEqual(&test, rTM, 0.9999999999971773);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9971812850008834);
    AssertAlmostEqual(&test, rTM, 0.9999999999997178);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9721686095646991);
    AssertAlmostEqual(&test, rTM, 0.9999999999999718);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7547710571431521);
    AssertAlmostEqual(&test, rTM, 0.9999999999999971);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1013555584664567);
    AssertAlmostEqual(&test, rTM, 0.9999999999999996);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001251940483430573);
    AssertAlmostEqual(&test, rTM, 0.9999999999999996);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999033472335);
    AssertAlmostEqual(&test, rTM, 0.9999999033472345);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999033471857);
    AssertAlmostEqual(&test, rTM, 0.9999999033472824);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999033424015);
    AssertAlmostEqual(&test, rTM, 0.9999999033520663);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999028651724);
    AssertAlmostEqual(&test, rTM, 0.9999999038269033);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999998633123502);
    AssertAlmostEqual(&test, rTM, 0.9999999316561728);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999990286521486);
    AssertAlmostEqual(&test, rTM, 0.9999999903826899);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999903342863996);
    AssertAlmostEqual(&test, rTM, 0.9999999990335207);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999033518518242);
    AssertAlmostEqual(&test, rTM, 0.9999999999033473);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.99903393926401);
    AssertAlmostEqual(&test, rTM, 0.9999999999903347);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9903813188651513);
    AssertAlmostEqual(&test, rTM, 0.9999999999990334);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9079053108835915);
    AssertAlmostEqual(&test, rTM, 0.9999999999999032);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3936136762641852);
    AssertAlmostEqual(&test, rTM, 0.9999999999999892);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01048140030973247);
    AssertAlmostEqual(&test, rTM, 0.9999999999999952);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999995195502012);
    AssertAlmostEqual(&test, rTM, 0.9999995195502013);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999995195501988);
    AssertAlmostEqual(&test, rTM, 0.9999995195502036);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999999519549961);
    AssertAlmostEqual(&test, rTM, 0.9999995195504414);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999995195261793);
    AssertAlmostEqual(&test, rTM, 0.9999995195742218);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999995171539285);
    AssertAlmostEqual(&test, rTM, 0.9999995219345816);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999993205414461);
    AssertAlmostEqual(&test, rTM, 0.9999996602706653);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999995171549777);
    AssertAlmostEqual(&test, rTM, 0.9999999521934478);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999519537606519);
    AssertAlmostEqual(&test, rTM, 0.9999999951957411);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995196652478804);
    AssertAlmostEqual(&test, rTM, 0.9999999995195503);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9952070285771343);
    AssertAlmostEqual(&test, rTM, 0.9999999999519549);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9530953082676863);
    AssertAlmostEqual(&test, rTM, 0.9999999999951941);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6212976663488101);
    AssertAlmostEqual(&test, rTM, 0.9999999999995058);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03993086986313569);
    AssertAlmostEqual(&test, rTM, 0.999999999999875);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999995993790964);
    AssertAlmostEqual(&test, rTM, 0.999995993790964);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999959937909639);
    AssertAlmostEqual(&test, rTM, 0.9999959937909643);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999959937909441);
    AssertAlmostEqual(&test, rTM, 0.9999959937909841);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999995993788961);
    AssertAlmostEqual(&test, rTM, 0.9999959937929672);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999995993590659);
    AssertAlmostEqual(&test, rTM, 0.9999959939912592);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999959738097879);
    AssertAlmostEqual(&test, rTM, 0.9999960136729779);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999943343695485);
    AssertAlmostEqual(&test, rTM, 0.9999971671807618);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999597388273332);
    AssertAlmostEqual(&test, rTM, 0.9999996013665826);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995994385121977);
    AssertAlmostEqual(&test, rTM, 0.9999999599398324);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960017977943237);
    AssertAlmostEqual(&test, rTM, 0.9999999959937769);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9607322814022283);
    AssertAlmostEqual(&test, rTM, 0.999999999599298);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6716688548350638);
    AssertAlmostEqual(&test, rTM, 0.999999999959142);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05557345736892789);
    AssertAlmostEqual(&test, rTM, 0.9999999999910307);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999608262456815);
    AssertAlmostEqual(&test, rTM, 0.9999608262456815);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999608262456814);
    AssertAlmostEqual(&test, rTM, 0.9999608262456815);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999608262456795);
    AssertAlmostEqual(&test, rTM, 0.9999608262456834);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999608262454855);
    AssertAlmostEqual(&test, rTM, 0.9999608262458773);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999608262260949);
    AssertAlmostEqual(&test, rTM, 0.9999608262652679);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999608242870811);
    AssertAlmostEqual(&test, rTM, 0.999960828204184);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999606308679947);
    AssertAlmostEqual(&test, rTM, 0.9999610206537838);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999446003948296);
    AssertAlmostEqual(&test, rTM, 0.9999722998137593);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996063784219263);
    AssertAlmostEqual(&test, rTM, 0.9999961019969299);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960900184360915);
    AssertAlmostEqual(&test, rTM, 0.9999996082736948);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9615852669655287);
    AssertAlmostEqual(&test, rTM, 0.9999999608179846);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6775428043036372);
    AssertAlmostEqual(&test, rTM, 0.9999999960081065);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05784161747809035);
    AssertAlmostEqual(&test, rTM, 0.9999999991384626);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996092298931512);
    AssertAlmostEqual(&test, rTM, 0.9996092298931512);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996092298931512);
    AssertAlmostEqual(&test, rTM, 0.9996092298931512);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996092298931509);
    AssertAlmostEqual(&test, rTM, 0.9996092298931514);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996092298931316);
    AssertAlmostEqual(&test, rTM, 0.9996092298931707);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996092298911977);
    AssertAlmostEqual(&test, rTM, 0.9996092298951046);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996092296978043);
    AssertAlmostEqual(&test, rTM, 0.9996092300884979);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996092103589527);
    AssertAlmostEqual(&test, rTM, 0.9996092494263734);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996072812857492);
    AssertAlmostEqual(&test, rTM, 0.9996111688337552);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994474123472222);
    AssertAlmostEqual(&test, rTM, 0.9997236679886464);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960797483438886);
    AssertAlmostEqual(&test, rTM, 0.9999611100043976);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616698153960996);
    AssertAlmostEqual(&test, rTM, 0.9999960909921072);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6781405414440712);
    AssertAlmostEqual(&test, rTM, 0.9999996017604724);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05807869224247873);
    AssertAlmostEqual(&test, rTM, 0.9999999142003085);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9961000621483651);
    AssertAlmostEqual(&test, rTM, 0.9961000621483651);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9961000621483651);
    AssertAlmostEqual(&test, rTM, 0.9961000621483651);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9961000621483651);
    AssertAlmostEqual(&test, rTM, 0.9961000621483652);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9961000621483632);
    AssertAlmostEqual(&test, rTM, 0.9961000621483671);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9961000621481706);
    AssertAlmostEqual(&test, rTM, 0.9961000621485597);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9961000621289036);
    AssertAlmostEqual(&test, rTM, 0.9961000621678268);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9961000602022065);
    AssertAlmostEqual(&test, rTM, 0.9961000640945228);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960998675373376);
    AssertAlmostEqual(&test, rTM, 0.9961002567497009);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960806491587605);
    AssertAlmostEqual(&test, rTM, 0.9961193791701651);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9944891166556792);
    AssertAlmostEqual(&test, rTM, 0.997240746342882);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.961492976704328);
    AssertAlmostEqual(&test, rTM, 0.9996111848995725);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.678187561349761);
    AssertAlmostEqual(&test, rTM, 0.9999601883865873);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810245585873238);
    AssertAlmostEqual(&test, rTM, 0.9999914236410903);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616812118685054);
    AssertAlmostEqual(&test, rTM, 0.9616812118685054);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616812118685054);
    AssertAlmostEqual(&test, rTM, 0.9616812118685054);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616812118685054);
    AssertAlmostEqual(&test, rTM, 0.9616812118685054);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616812118685052);
    AssertAlmostEqual(&test, rTM, 0.9616812118685056);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616812118684867);
    AssertAlmostEqual(&test, rTM, 0.9616812118685242);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616812118666269);
    AssertAlmostEqual(&test, rTM, 0.9616812118703839);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.961681211680654);
    AssertAlmostEqual(&test, rTM, 0.9616812120563568);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616811930833691);
    AssertAlmostEqual(&test, rTM, 0.9616812306536328);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616793334031958);
    AssertAlmostEqual(&test, rTM, 0.9616830902435319);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9614938461845235);
    AssertAlmostEqual(&test, rTM, 0.9618676835804397);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9462457064406125);
    AssertAlmostEqual(&test, rTM, 0.9727464893294937);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6769106994107257);
    AssertAlmostEqual(&test, rTM, 0.9960470184002851);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05809971826867312);
    AssertAlmostEqual(&test, rTM, 0.9991430959026784);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6782071551070262);
    AssertAlmostEqual(&test, rTM, 0.6782071551070262);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6782071551070262);
    AssertAlmostEqual(&test, rTM, 0.6782071551070262);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6782071551070262);
    AssertAlmostEqual(&test, rTM, 0.6782071551070262);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6782071551070262);
    AssertAlmostEqual(&test, rTM, 0.6782071551070262);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6782071551070249);
    AssertAlmostEqual(&test, rTM, 0.6782071551070276);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6782071551068962);
    AssertAlmostEqual(&test, rTM, 0.6782071551071562);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6782071550940217);
    AssertAlmostEqual(&test, rTM, 0.6782071551200307);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6782071538065777);
    AssertAlmostEqual(&test, rTM, 0.6782071564074748);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6782070250622152);
    AssertAlmostEqual(&test, rTM, 0.6782072851517947);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6781941510830253);
    AssertAlmostEqual(&test, rTM, 0.6782201587062983);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6769113001968924);
    AssertAlmostEqual(&test, rTM, 0.6794988059280356);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5793785588515646);
    AssertAlmostEqual(&test, rTM, 0.7573821884608083);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05759247204312549);
    AssertAlmostEqual(&test, rTM, 0.9207477559099844);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810515223361641);
    AssertAlmostEqual(&test, rTM, 0.05810515223361641);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810515223361641);
    AssertAlmostEqual(&test, rTM, 0.05810515223361641);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810515223361641);
    AssertAlmostEqual(&test, rTM, 0.05810515223361641);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810515223361641);
    AssertAlmostEqual(&test, rTM, 0.05810515223361641);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810515223361641);
    AssertAlmostEqual(&test, rTM, 0.05810515223361642);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0581051522336159);
    AssertAlmostEqual(&test, rTM, 0.05810515223361693);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810515223356469);
    AssertAlmostEqual(&test, rTM, 0.05810515223366813);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810515222844406);
    AssertAlmostEqual(&test, rTM, 0.05810515223878877);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810515171638102);
    AssertAlmostEqual(&test, rTM, 0.0581051527508518);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810510051012322);
    AssertAlmostEqual(&test, rTM, 0.05810520395710929);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05809998034162416);
    AssertAlmostEqual(&test, rTM, 0.0581103241224897);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05759249568399737);
    AssertAlmostEqual(&test, rTM, 0.05861777813958861);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03076373860873308);
    AssertAlmostEqual(&test, rTM, 0.08535967522988967);

    userdata[0] = 1000/CAPS_HBAR_EV; /* 1000eV */
    userdata[1] = 0.001/CAPS_HBAR_EV; /* 0.001eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999960465344);
    AssertAlmostEqual(&test, rTM, 0.9999999980232672);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999719053486);
    AssertAlmostEqual(&test, rTM, 0.9999999997218352);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999997204338283);
    AssertAlmostEqual(&test, rTM, 0.9999999999720461);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999972044801754);
    AssertAlmostEqual(&test, rTM, 0.9999999999972045);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999720451672618);
    AssertAlmostEqual(&test, rTM, 0.9999999999997204);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999720486838551);
    AssertAlmostEqual(&test, rTM, 0.999999999999972);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9972083824074064);
    AssertAlmostEqual(&test, rTM, 0.9999999999999972);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9724327931897694);
    AssertAlmostEqual(&test, rTM, 0.9999999999999997);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7568048451796893);
    AssertAlmostEqual(&test, rTM, 1);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1029656209569059);
    AssertAlmostEqual(&test, rTM, 1);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001276335205310115);
    AssertAlmostEqual(&test, rTM, 1);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279566770174752e-05);
    AssertAlmostEqual(&test, rTM, 1);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279599189150777e-07);
    AssertAlmostEqual(&test, rTM, 1);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999999991115613);
    AssertAlmostEqual(&test, rTM, 0.9999999912035772);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999874979342);
    AssertAlmostEqual(&test, rTM, 0.9999999937489671);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999111561333);
    AssertAlmostEqual(&test, rTM, 0.9999999991203578);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999991159266357);
    AssertAlmostEqual(&test, rTM, 0.9999999999116015);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999991159739108);
    AssertAlmostEqual(&test, rTM, 0.9999999999911597);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999116009515414);
    AssertAlmostEqual(&test, rTM, 0.9999999999991159);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991163611130081);
    AssertAlmostEqual(&test, rTM, 0.9999999999999116);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9911986935063987);
    AssertAlmostEqual(&test, rTM, 0.9999999999999911);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.915418268387898);
    AssertAlmostEqual(&test, rTM, 0.9999999999999991);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4242154357920784);
    AssertAlmostEqual(&test, rTM, 0.9999999999999999);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01247842060860464);
    AssertAlmostEqual(&test, rTM, 1);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001279249658356818);
    AssertAlmostEqual(&test, rTM, 1);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279573742484986e-06);
    AssertAlmostEqual(&test, rTM, 1);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999115115529);
    AssertAlmostEqual(&test, rTM, 0.9999999115116414);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999115071728);
    AssertAlmostEqual(&test, rTM, 0.9999999115160212);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999110702558);
    AssertAlmostEqual(&test, rTM, 0.9999999119507482);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999998748585028);
    AssertAlmostEqual(&test, rTM, 0.9999999374292494);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999991107029134);
    AssertAlmostEqual(&test, rTM, 0.9999999911950744);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999911507560453);
    AssertAlmostEqual(&test, rTM, 0.9999999991151601);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999115154639867);
    AssertAlmostEqual(&test, rTM, 0.9999999999115117);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991155073510215);
    AssertAlmostEqual(&test, rTM, 0.9999999999911512);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9911902237018976);
    AssertAlmostEqual(&test, rTM, 0.9999999999991152);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9153401244070082);
    AssertAlmostEqual(&test, rTM, 0.9999999999999114);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4238840386576281);
    AssertAlmostEqual(&test, rTM, 0.9999999999999903);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.012454924626766);
    AssertAlmostEqual(&test, rTM, 0.999999999999996);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001276780795136403);
    AssertAlmostEqual(&test, rTM, 0.9999999999999961);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999997177304391);
    AssertAlmostEqual(&test, rTM, 0.9999997177304418);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999997177302993);
    AssertAlmostEqual(&test, rTM, 0.9999997177305816);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999997177163273);
    AssertAlmostEqual(&test, rTM, 0.9999997177445529);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999997163226036);
    AssertAlmostEqual(&test, rTM, 0.9999997191312904);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999996008105839);
    AssertAlmostEqual(&test, rTM, 0.999999800405272);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999997163229658);
    AssertAlmostEqual(&test, rTM, 0.9999999719131255);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999717720271645);
    AssertAlmostEqual(&test, rTM, 0.9999999971774451);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997177700947526);
    AssertAlmostEqual(&test, rTM, 0.9999999997177306);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9971812849869506);
    AssertAlmostEqual(&test, rTM, 0.999999999971773);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9721686095633408);
    AssertAlmostEqual(&test, rTM, 0.999999999997177);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7547710571430476);
    AssertAlmostEqual(&test, rTM, 0.9999999999997149);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1013555584664559);
    AssertAlmostEqual(&test, rTM, 0.9999999999999512);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001251940483430573);
    AssertAlmostEqual(&test, rTM, 0.99999999999996);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999990334727609);
    AssertAlmostEqual(&test, rTM, 0.999999033472761);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999990334727561);
    AssertAlmostEqual(&test, rTM, 0.9999990334727658);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999990334722776);
    AssertAlmostEqual(&test, rTM, 0.9999990334732441);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999990334244357);
    AssertAlmostEqual(&test, rTM, 0.9999990335210835);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999990286521486);
    AssertAlmostEqual(&test, rTM, 0.9999990382694495);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999986331243437);
    AssertAlmostEqual(&test, rTM, 0.9999993165619383);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999902865639441);
    AssertAlmostEqual(&test, rTM, 0.9999999038269033);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999033470680952);
    AssertAlmostEqual(&test, rTM, 0.9999999903352061);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9990339387860411);
    AssertAlmostEqual(&test, rTM, 0.9999999990334727);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9903813188177689);
    AssertAlmostEqual(&test, rTM, 0.9999999999033461);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9079053108792529);
    AssertAlmostEqual(&test, rTM, 0.9999999999903234);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3936136762640156);
    AssertAlmostEqual(&test, rTM, 0.9999999999989265);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01048140030973236);
    AssertAlmostEqual(&test, rTM, 0.999999999999523);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999951955123996);
    AssertAlmostEqual(&test, rTM, 0.9999951955123996);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999951955123992);
    AssertAlmostEqual(&test, rTM, 0.9999951955123998);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999951955123755);
    AssertAlmostEqual(&test, rTM, 0.9999951955124236);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999951955099973);
    AssertAlmostEqual(&test, rTM, 0.9999951955148018);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999951952721817);
    AssertAlmostEqual(&test, rTM, 0.9999951957526053);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999995171549777);
    AssertAlmostEqual(&test, rTM, 0.9999952193561006);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999932054352361);
    AssertAlmostEqual(&test, rTM, 0.9999966027118472);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999517165468885);
    AssertAlmostEqual(&test, rTM, 0.9999995219345814);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995196414776343);
    AssertAlmostEqual(&test, rTM, 0.9999999519574104);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9952070262103134);
    AssertAlmostEqual(&test, rTM, 0.9999999951954894);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.953095308041084);
    AssertAlmostEqual(&test, rTM, 0.9999999995194114);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6212976663344429);
    AssertAlmostEqual(&test, rTM, 0.9999999999505882);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03993086986309919);
    AssertAlmostEqual(&test, rTM, 0.9999999999874983);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999599386318727);
    AssertAlmostEqual(&test, rTM, 0.9999599386318727);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999599386318727);
    AssertAlmostEqual(&test, rTM, 0.9999599386318727);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999599386318707);
    AssertAlmostEqual(&test, rTM, 0.9999599386318747);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999599386316724);
    AssertAlmostEqual(&test, rTM, 0.999959938632073);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999599386118425);
    AssertAlmostEqual(&test, rTM, 0.999959938651903);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999599366288945);
    AssertAlmostEqual(&test, rTM, 0.9999599406347508);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999597388273332);
    AssertAlmostEqual(&test, rTM, 0.9999601374448599);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999433451399429);
    AssertAlmostEqual(&test, rTM, 0.9999716721687327);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999597461211484);
    AssertAlmostEqual(&test, rTM, 0.9999960136728987);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960016002848565);
    AssertAlmostEqual(&test, rTM, 0.9999995993976001);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9607322623539892);
    AssertAlmostEqual(&test, rTM, 0.9999999599298137);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6716688535290366);
    AssertAlmostEqual(&test, rTM, 0.9999999959141999);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05557345736400544);
    AssertAlmostEqual(&test, rTM, 0.9999999991030686);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996083315083164);
    AssertAlmostEqual(&test, rTM, 0.9996083315083164);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996083315083164);
    AssertAlmostEqual(&test, rTM, 0.9996083315083164);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996083315083162);
    AssertAlmostEqual(&test, rTM, 0.9996083315083165);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996083315082968);
    AssertAlmostEqual(&test, rTM, 0.9996083315083359);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996083315063584);
    AssertAlmostEqual(&test, rTM, 0.9996083315102743);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996083313125205);
    AssertAlmostEqual(&test, rTM, 0.9996083317041121);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996083119292173);
    AssertAlmostEqual(&test, rTM, 0.999608351086437);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996063784219263);
    AssertAlmostEqual(&test, rTM, 0.9996102749056974);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994461420451362);
    AssertAlmostEqual(&test, rTM, 0.9997230326618041);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960707516207764);
    AssertAlmostEqual(&test, rTM, 0.9999610205797514);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9615834027246973);
    AssertAlmostEqual(&test, rTM, 0.9999960820000685);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6775426753688116);
    AssertAlmostEqual(&test, rTM, 0.9999996008109355);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05784161696808012);
    AssertAlmostEqual(&test, rTM, 0.9999999138462661);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960991657865778);
    AssertAlmostEqual(&test, rTM, 0.9960991657865778);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960991657865778);
    AssertAlmostEqual(&test, rTM, 0.9960991657865778);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960991657865778);
    AssertAlmostEqual(&test, rTM, 0.9960991657865778);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960991657865758);
    AssertAlmostEqual(&test, rTM, 0.9960991657865796);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.996099165786383);
    AssertAlmostEqual(&test, rTM, 0.9960991657867724);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960991657671117);
    AssertAlmostEqual(&test, rTM, 0.9960991658060437);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960991638399727);
    AssertAlmostEqual(&test, rTM, 0.9960991677331819);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960989711309085);
    AssertAlmostEqual(&test, rTM, 0.996099360432553);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960797483438886);
    AssertAlmostEqual(&test, rTM, 0.9961184872395348);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9944878510614401);
    AssertAlmostEqual(&test, rTM, 0.9972401117910541);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9614842830471967);
    AssertAlmostEqual(&test, rTM, 0.999611095342902);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6781276655572938);
    AssertAlmostEqual(&test, rTM, 0.9999601788813732);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05807864105682105);
    AssertAlmostEqual(&test, rTM, 0.999991420100616);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616803465331276);
    AssertAlmostEqual(&test, rTM, 0.9616803465331276);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616803465331276);
    AssertAlmostEqual(&test, rTM, 0.9616803465331276);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616803465331276);
    AssertAlmostEqual(&test, rTM, 0.9616803465331276);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616803465331274);
    AssertAlmostEqual(&test, rTM, 0.9616803465331278);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616803465331089);
    AssertAlmostEqual(&test, rTM, 0.9616803465331464);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616803465312491);
    AssertAlmostEqual(&test, rTM, 0.9616803465350062);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616803463452721);
    AssertAlmostEqual(&test, rTM, 0.9616803467209832);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616803277475757);
    AssertAlmostEqual(&test, rTM, 0.9616803653186705);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616784680262591);
    AssertAlmostEqual(&test, rTM, 0.9616822249497111);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.961492976704328);
    AssertAlmostEqual(&test, rTM, 0.961866822370922);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9462445025436315);
    AssertAlmostEqual(&test, rTM, 0.9727458701683818);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.676904691657316);
    AssertAlmostEqual(&test, rTM, 0.9960469242294955);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05809733589610714);
    AssertAlmostEqual(&test, rTM, 0.9991430605561675);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6782065560479311);
    AssertAlmostEqual(&test, rTM, 0.6782065560479311);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6782065560479311);
    AssertAlmostEqual(&test, rTM, 0.6782065560479311);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6782065560479311);
    AssertAlmostEqual(&test, rTM, 0.6782065560479311);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6782065560479311);
    AssertAlmostEqual(&test, rTM, 0.6782065560479311);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6782065560479298);
    AssertAlmostEqual(&test, rTM, 0.6782065560479325);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6782065560478011);
    AssertAlmostEqual(&test, rTM, 0.6782065560480611);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6782065560349266);
    AssertAlmostEqual(&test, rTM, 0.6782065560609356);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6782065547474808);
    AssertAlmostEqual(&test, rTM, 0.6782065573483814);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6782064260029464);
    AssertAlmostEqual(&test, rTM, 0.6782066860928733);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6781935520065663);
    AssertAlmostEqual(&test, rTM, 0.6782195596645669);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6769106994107257);
    AssertAlmostEqual(&test, rTM, 0.6794982085948307);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5793778480571923);
    AssertAlmostEqual(&test, rTM, 0.7573816987141847);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05759223563547784);
    AssertAlmostEqual(&test, rTM, 0.9207474542940628);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810512840683112);
    AssertAlmostEqual(&test, rTM, 0.05810512840683112);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810512840683112);
    AssertAlmostEqual(&test, rTM, 0.05810512840683112);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810512840683112);
    AssertAlmostEqual(&test, rTM, 0.05810512840683112);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810512840683112);
    AssertAlmostEqual(&test, rTM, 0.05810512840683112);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810512840683112);
    AssertAlmostEqual(&test, rTM, 0.05810512840683113);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810512840683061);
    AssertAlmostEqual(&test, rTM, 0.05810512840683164);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0581051284067794);
    AssertAlmostEqual(&test, rTM, 0.05810512840688285);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810512840165877);
    AssertAlmostEqual(&test, rTM, 0.05810512841200348);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810512788959592);
    AssertAlmostEqual(&test, rTM, 0.05810512892406633);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810507668335668);
    AssertAlmostEqual(&test, rTM, 0.05810518013030527);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0580999565167124);
    AssertAlmostEqual(&test, rTM, 0.05811030029383089);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0575924720431255);
    AssertAlmostEqual(&test, rTM, 0.05861775412692477);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.030763725283131);
    AssertAlmostEqual(&test, rTM, 0.08535964100431837);

    userdata[0] = 1000/CAPS_HBAR_EV; /* 1000eV */
    userdata[1] = 0.003/CAPS_HBAR_EV; /* 0.003eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999931524012);
    AssertAlmostEqual(&test, rTM, 0.9999999965762006);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999513386686);
    AssertAlmostEqual(&test, rTM, 0.9999999995182046);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999995157775516);
    AssertAlmostEqual(&test, rTM, 0.9999999999515826);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999995158025738);
    AssertAlmostEqual(&test, rTM, 0.999999999995158);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999515813363501);
    AssertAlmostEqual(&test, rTM, 0.9999999999995158);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995159188534714);
    AssertAlmostEqual(&test, rTM, 0.9999999999999516);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9951697246491259);
    AssertAlmostEqual(&test, rTM, 0.9999999999999951);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9527382167662265);
    AssertAlmostEqual(&test, rTM, 0.9999999999999996);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6190377937840914);
    AssertAlmostEqual(&test, rTM, 1);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03936164359493153);
    AssertAlmostEqual(&test, rTM, 1);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004261702532566127);
    AssertAlmostEqual(&test, rTM, 1);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.265300891810416e-06);
    AssertAlmostEqual(&test, rTM, 1);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.265336913764603e-08);
    AssertAlmostEqual(&test, rTM, 1);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999846118905);
    AssertAlmostEqual(&test, rTM, 0.999999984764248);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999999978345928);
    AssertAlmostEqual(&test, rTM, 0.999999989172964);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999999846118916);
    AssertAlmostEqual(&test, rTM, 0.9999999984764248);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999998468750483);
    AssertAlmostEqual(&test, rTM, 0.9999999998468903);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999846883682427);
    AssertAlmostEqual(&test, rTM, 0.9999999999846882);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998468943079994);
    AssertAlmostEqual(&test, rTM, 0.9999999999984688);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9984699976657329);
    AssertAlmostEqual(&test, rTM, 0.9999999999998469);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9848050346634244);
    AssertAlmostEqual(&test, rTM, 0.9999999999999847);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8581569848562258);
    AssertAlmostEqual(&test, rTM, 0.9999999999999984);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2438650140596443);
    AssertAlmostEqual(&test, rTM, 0.9999999999999998);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.004229309916683889);
    AssertAlmostEqual(&test, rTM, 0.9999999999999999);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.264948458823696e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999999999);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.265308639231812e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999999999);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999998468331703);
    AssertAlmostEqual(&test, rTM, 0.9999998468333235);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999998468255887);
    AssertAlmostEqual(&test, rTM, 0.9999998468409047);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999998460693182);
    AssertAlmostEqual(&test, rTM, 0.9999998475933843);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999997833895073);
    AssertAlmostEqual(&test, rTM, 0.9999998916947478);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999984606942491);
    AssertAlmostEqual(&test, rTM, 0.9999999847593374);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999846826750161);
    AssertAlmostEqual(&test, rTM, 0.9999999984684089);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998468448881994);
    AssertAlmostEqual(&test, rTM, 0.9999999998468333);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9984695048979955);
    AssertAlmostEqual(&test, rTM, 0.9999999999846834);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9848001746515219);
    AssertAlmostEqual(&test, rTM, 0.9999999999984683);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8581147581290389);
    AssertAlmostEqual(&test, rTM, 0.9999999999998463);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2437694772239258);
    AssertAlmostEqual(&test, rTM, 0.9999999999999807);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.00422660785908904);
    AssertAlmostEqual(&test, rTM, 0.9999999999999881);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.26220073512695e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999999882);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999995142278193);
    AssertAlmostEqual(&test, rTM, 0.9999995142278242);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999995142275788);
    AssertAlmostEqual(&test, rTM, 0.9999995142280647);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999995142035337);
    AssertAlmostEqual(&test, rTM, 0.9999995142521085);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999995118050035);
    AssertAlmostEqual(&test, rTM, 0.9999995166386161);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999993130144664);
    AssertAlmostEqual(&test, rTM, 0.9999996565071742);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999951180607591);
    AssertAlmostEqual(&test, rTM, 0.9999999516638511);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999514215215505);
    AssertAlmostEqual(&test, rTM, 0.9999999951425199);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995143454340052);
    AssertAlmostEqual(&test, rTM, 0.9999999995142279);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.995154061420695);
    AssertAlmostEqual(&test, rTM, 0.9999999999514226);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9525883173554839);
    AssertAlmostEqual(&test, rTM, 0.9999999999951409);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6180916313954995);
    AssertAlmostEqual(&test, rTM, 0.9999999999995001);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03912616221041045);
    AssertAlmostEqual(&test, rTM, 0.9999999999998724);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004234154117483662);
    AssertAlmostEqual(&test, rTM, 0.9999999999998819);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999984197601981);
    AssertAlmostEqual(&test, rTM, 0.9999984197601982);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999984197601902);
    AssertAlmostEqual(&test, rTM, 0.9999984197602061);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999984197594081);
    AssertAlmostEqual(&test, rTM, 0.9999984197609882);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999984196811882);
    AssertAlmostEqual(&test, rTM, 0.9999984198392041);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999984118786602);
    AssertAlmostEqual(&test, rTM, 0.9999984276026215);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999977652041718);
    AssertAlmostEqual(&test, rTM, 0.9999988826014616);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999841189000979);
    AssertAlmostEqual(&test, rTM, 0.9999998427601509);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998419804805119);
    AssertAlmostEqual(&test, rTM, 0.9999999841983797);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9984210062483067);
    AssertAlmostEqual(&test, rTM, 0.9999999984197593);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9843219542496596);
    AssertAlmostEqual(&test, rTM, 0.999999999841971);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8539692065999012);
    AssertAlmostEqual(&test, rTM, 0.9999999999841483);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2346007465303719);
    AssertAlmostEqual(&test, rTM, 0.9999999999979861);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.003972791069700549);
    AssertAlmostEqual(&test, rTM, 0.9999999999987415);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999993778036416);
    AssertAlmostEqual(&test, rTM, 0.999993778036416);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999937780364156);
    AssertAlmostEqual(&test, rTM, 0.9999937780364162);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999937780363848);
    AssertAlmostEqual(&test, rTM, 0.9999937780364471);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999937780333049);
    AssertAlmostEqual(&test, rTM, 0.9999937780395269);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999937777253265);
    AssertAlmostEqual(&test, rTM, 0.9999937783474898);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999937470040832);
    AssertAlmostEqual(&test, rTM, 0.9999938089147421);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999912008260535);
    AssertAlmostEqual(&test, rTM, 0.9999956004033486);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999374718003101);
    AssertAlmostEqual(&test, rTM, 0.999999380889749);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993779641514078);
    AssertAlmostEqual(&test, rTM, 0.9999999377832802);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9937973403946725);
    AssertAlmostEqual(&test, rTM, 0.9999999937779901);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9396857221603396);
    AssertAlmostEqual(&test, rTM, 0.9999999993775007);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5419533074288331);
    AssertAlmostEqual(&test, rTM, 0.9999999999348388);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02457697209920648);
    AssertAlmostEqual(&test, rTM, 0.999999999979668);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999958033320408);
    AssertAlmostEqual(&test, rTM, 0.999958033320408);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999958033320408);
    AssertAlmostEqual(&test, rTM, 0.999958033320408);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999580333204059);
    AssertAlmostEqual(&test, rTM, 0.9999580333204101);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999580333201982);
    AssertAlmostEqual(&test, rTM, 0.9999580333206178);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999580332994251);
    AssertAlmostEqual(&test, rTM, 0.9999580333413909);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999580312221705);
    AssertAlmostEqual(&test, rTM, 0.9999580354185406);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999578240134009);
    AssertAlmostEqual(&test, rTM, 0.9999582415887077);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999940650668406);
    AssertAlmostEqual(&test, rTM, 0.9999703248938905);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995783201747239);
    AssertAlmostEqual(&test, rTM, 0.999995824080308);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9958118321656215);
    AssertAlmostEqual(&test, rTM, 0.9999995803445443);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9589038191768372);
    AssertAlmostEqual(&test, rTM, 0.9999999580232232);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6592481737200708);
    AssertAlmostEqual(&test, rTM, 0.9999999957118437);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05112045649339815);
    AssertAlmostEqual(&test, rTM, 0.999999999024474);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996063424421957);
    AssertAlmostEqual(&test, rTM, 0.9996063424421957);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996063424421956);
    AssertAlmostEqual(&test, rTM, 0.9996063424421957);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996063424421955);
    AssertAlmostEqual(&test, rTM, 0.9996063424421958);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996063424421759);
    AssertAlmostEqual(&test, rTM, 0.9996063424422154);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996063424402277);
    AssertAlmostEqual(&test, rTM, 0.9996063424441636);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996063422454057);
    AssertAlmostEqual(&test, rTM, 0.9996063426389855);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996063227636848);
    AssertAlmostEqual(&test, rTM, 0.999606362119723);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996043794391308);
    AssertAlmostEqual(&test, rTM, 0.9996082957070754);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999443329538477);
    AssertAlmostEqual(&test, rTM, 0.9997216260178093);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960508327148748);
    AssertAlmostEqual(&test, rTM, 0.9999608225891287);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9613921086418024);
    AssertAlmostEqual(&test, rTM, 0.9999960620911604);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6762210247288634);
    AssertAlmostEqual(&test, rTM, 0.9999995987077943);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05732167281951884);
    AssertAlmostEqual(&test, rTM, 0.9999999130595737);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960971746128815);
    AssertAlmostEqual(&test, rTM, 0.9960971746128815);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960971746128815);
    AssertAlmostEqual(&test, rTM, 0.9960971746128815);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960971746128815);
    AssertAlmostEqual(&test, rTM, 0.9960971746128816);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960971746128796);
    AssertAlmostEqual(&test, rTM, 0.9960971746128835);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960971746126868);
    AssertAlmostEqual(&test, rTM, 0.9960971746130763);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960971745934055);
    AssertAlmostEqual(&test, rTM, 0.9960971746323575);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960971726652847);
    AssertAlmostEqual(&test, rTM, 0.9960971765604774);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960969798580457);
    AssertAlmostEqual(&test, rTM, 0.9960973693580184);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960777472781466);
    AssertAlmostEqual(&test, rTM, 0.9961165059091751);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9944850396782712);
    AssertAlmostEqual(&test, rTM, 0.997238702200121);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9614649712557074);
    AssertAlmostEqual(&test, rTM, 0.9996108964018081);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6779946338847714);
    AssertAlmostEqual(&test, rTM, 0.9999601577656837);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0580257893415138);
    AssertAlmostEqual(&test, rTM, 0.9999914122329657);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616784236397882);
    AssertAlmostEqual(&test, rTM, 0.9616784236397882);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616784236397882);
    AssertAlmostEqual(&test, rTM, 0.9616784236397882);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616784236397882);
    AssertAlmostEqual(&test, rTM, 0.9616784236397882);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616784236397879);
    AssertAlmostEqual(&test, rTM, 0.9616784236397883);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616784236397694);
    AssertAlmostEqual(&test, rTM, 0.9616784236398069);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616784236379095);
    AssertAlmostEqual(&test, rTM, 0.9616784236416668);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616784234519233);
    AssertAlmostEqual(&test, rTM, 0.9616784238276529);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616784048533127);
    AssertAlmostEqual(&test, rTM, 0.9616784424262546);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616765450405704);
    AssertAlmostEqual(&test, rTM, 0.9616803021487166);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9614910446006518);
    AssertAlmostEqual(&test, rTM, 0.9618649086457927);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9462418273218345);
    AssertAlmostEqual(&test, rTM, 0.9727444943072447);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.676891341798834);
    AssertAlmostEqual(&test, rTM, 0.9960467149680642);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.058092042436655);
    AssertAlmostEqual(&test, rTM, 0.9991429820084444);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6782052248125137);
    AssertAlmostEqual(&test, rTM, 0.6782052248125137);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6782052248125137);
    AssertAlmostEqual(&test, rTM, 0.6782052248125137);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6782052248125137);
    AssertAlmostEqual(&test, rTM, 0.6782052248125137);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6782052248125137);
    AssertAlmostEqual(&test, rTM, 0.6782052248125137);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6782052248125123);
    AssertAlmostEqual(&test, rTM, 0.6782052248125149);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6782052248123835);
    AssertAlmostEqual(&test, rTM, 0.6782052248126437);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6782052247995091);
    AssertAlmostEqual(&test, rTM, 0.6782052248255181);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6782052235120595);
    AssertAlmostEqual(&test, rTM, 0.6782052261129677);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6782050947671431);
    AssertAlmostEqual(&test, rTM, 0.6782053548578417);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6781922207325628);
    AssertAlmostEqual(&test, rTM, 0.6782182284677353);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6769093643374025);
    AssertAlmostEqual(&test, rTM, 0.679496881194694);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5793762685235418);
    AssertAlmostEqual(&test, rTM, 0.757380610393421);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05759171029212144);
    AssertAlmostEqual(&test, rTM, 0.9207467840372257);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810507545848957);
    AssertAlmostEqual(&test, rTM, 0.05810507545848957);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810507545848957);
    AssertAlmostEqual(&test, rTM, 0.05810507545848957);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810507545848957);
    AssertAlmostEqual(&test, rTM, 0.05810507545848957);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810507545848957);
    AssertAlmostEqual(&test, rTM, 0.05810507545848957);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810507545848957);
    AssertAlmostEqual(&test, rTM, 0.05810507545848958);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810507545848906);
    AssertAlmostEqual(&test, rTM, 0.05810507545849009);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810507545843785);
    AssertAlmostEqual(&test, rTM, 0.0581050754585413);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810507545331723);
    AssertAlmostEqual(&test, rTM, 0.05810507546366192);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810507494125479);
    AssertAlmostEqual(&test, rTM, 0.05810507597572436);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810502373505676);
    AssertAlmostEqual(&test, rTM, 0.05810512718192207);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05809990357253424);
    AssertAlmostEqual(&test, rTM, 0.05811024734132595);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05759241950792441);
    AssertAlmostEqual(&test, rTM, 0.05861770076552027);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03076369567072331);
    AssertAlmostEqual(&test, rTM, 0.08535956494759167);

    userdata[0] = 1000/CAPS_HBAR_EV; /* 1000eV */
    userdata[1] = 0.035/CAPS_HBAR_EV; /* 0.035eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999766110046);
    AssertAlmostEqual(&test, rTM, 0.9999999883055022);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999998337899703);
    AssertAlmostEqual(&test, rTM, 0.999999998354356);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999983460669302);
    AssertAlmostEqual(&test, rTM, 0.9999999998346231);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999834616110208);
    AssertAlmostEqual(&test, rTM, 0.9999999999834615);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998346285000275);
    AssertAlmostEqual(&test, rTM, 0.9999999999983461);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9983475153001782);
    AssertAlmostEqual(&test, rTM, 0.9999999999998346);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9835976783616913);
    AssertAlmostEqual(&test, rTM, 0.9999999999999835);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8477264594605955);
    AssertAlmostEqual(&test, rTM, 0.9999999999999983);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2215488748061907);
    AssertAlmostEqual(&test, rTM, 0.9999999999999998);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.003629514668034419);
    AssertAlmostEqual(&test, rTM, 0.9999999999999999);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.655738254590529e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999999999);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.656002884419129e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999999999);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.656005530959261e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999999999999);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999474397574);
    AssertAlmostEqual(&test, rTM, 0.9999999479601559);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999260374856);
    AssertAlmostEqual(&test, rTM, 0.9999999630187421);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999994743976985);
    AssertAlmostEqual(&test, rTM, 0.9999999947960154);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999947698124403);
    AssertAlmostEqual(&test, rTM, 0.9999999994770322);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999477019439796);
    AssertAlmostEqual(&test, rTM, 0.9999999999477006);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994771427661778);
    AssertAlmostEqual(&test, rTM, 0.9999999999947701);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9947837185065471);
    AssertAlmostEqual(&test, rTM, 0.999999999999477);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9490503377355657);
    AssertAlmostEqual(&test, rTM, 0.9999999999999477);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5961816931577846);
    AssertAlmostEqual(&test, rTM, 0.9999999999999946);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03410855111459845);
    AssertAlmostEqual(&test, rTM, 0.9999999999999986);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003653332889192102);
    AssertAlmostEqual(&test, rTM, 0.9999999999999987);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.655976988476368e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999999987);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.656003453631209e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999999987);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999994769914498);
    AssertAlmostEqual(&test, rTM, 0.9999994769919728);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999994769655615);
    AssertAlmostEqual(&test, rTM, 0.9999994770178597);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999994743831756);
    AssertAlmostEqual(&test, rTM, 0.9999994795873013);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999992603546649);
    AssertAlmostEqual(&test, rTM, 0.9999996301772641);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999947438441885);
    AssertAlmostEqual(&test, rTM, 0.9999999479587179);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999476979102809);
    AssertAlmostEqual(&test, rTM, 0.9999999947701772);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994771280641537);
    AssertAlmostEqual(&test, rTM, 0.9999999994769918);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9947835747268249);
    AssertAlmostEqual(&test, rTM, 0.9999999999476989);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9490489667465892);
    AssertAlmostEqual(&test, rTM, 0.9999999999947681);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5961733581712474);
    AssertAlmostEqual(&test, rTM, 0.9999999999994594);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03410679061868387);
    AssertAlmostEqual(&test, rTM, 0.9999999999998536);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003653131154801511);
    AssertAlmostEqual(&test, rTM, 0.9999999999998631);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.655774962004651e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999998632);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999998345688126);
    AssertAlmostEqual(&test, rTM, 0.9999983456881425);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999983456873071);
    AssertAlmostEqual(&test, rTM, 0.9999983456889613);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999983456054207);
    AssertAlmostEqual(&test, rTM, 0.9999983457708435);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999983374371578);
    AssertAlmostEqual(&test, rTM, 0.9999983538981625);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999976604505245);
    AssertAlmostEqual(&test, rTM, 0.999998830224578);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999833744959633);
    AssertAlmostEqual(&test, rTM, 0.9999998353896943);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998345740897839);
    AssertAlmostEqual(&test, rTM, 0.9999999834576948);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9983470537502153);
    AssertAlmostEqual(&test, rTM, 0.999999998345687);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9835931392694416);
    AssertAlmostEqual(&test, rTM, 0.999999999834563);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8476874719783193);
    AssertAlmostEqual(&test, rTM, 0.9999999999834004);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2214701011089645);
    AssertAlmostEqual(&test, rTM, 0.9999999999978531);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.003627504608169605);
    AssertAlmostEqual(&test, rTM, 0.9999999999986217);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.653699079041697e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999986315);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999947554987786);
    AssertAlmostEqual(&test, rTM, 0.9999947554987791);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999947554987526);
    AssertAlmostEqual(&test, rTM, 0.9999947554988051);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999947554961567);
    AssertAlmostEqual(&test, rTM, 0.9999947555014012);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999947552365611);
    AssertAlmostEqual(&test, rTM, 0.9999947557609836);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999947293415722);
    AssertAlmostEqual(&test, rTM, 0.9999947815261729);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999925831633012);
    AssertAlmostEqual(&test, rTM, 0.9999962915747744);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999472946658036);
    AssertAlmostEqual(&test, rTM, 0.9999994781513917);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994756598011288);
    AssertAlmostEqual(&test, rTM, 0.9999999475574719);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9947692168553276);
    AssertAlmostEqual(&test, rTM, 0.9999999947554696);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9489120687226339);
    AssertAlmostEqual(&test, rTM, 0.9999999994753682);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5953416800705605);
    AssertAlmostEqual(&test, rTM, 0.9999999999457817);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03393165512497037);
    AssertAlmostEqual(&test, rTM, 0.9999999999852814);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000363306960812462);
    AssertAlmostEqual(&test, rTM, 0.9999999999862376);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999830062976549);
    AssertAlmostEqual(&test, rTM, 0.9999830062976549);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999830062976541);
    AssertAlmostEqual(&test, rTM, 0.9999830062976558);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.99998300629757);
    AssertAlmostEqual(&test, rTM, 0.99998300629774);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999830062891581);
    AssertAlmostEqual(&test, rTM, 0.9999830063061517);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999830054479983);
    AssertAlmostEqual(&test, rTM, 0.9999830071472692);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999829215412328);
    AssertAlmostEqual(&test, rTM, 0.9999830906334543);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999759673602527);
    AssertAlmostEqual(&test, rTM, 0.9999879836079291);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998292285372542);
    AssertAlmostEqual(&test, rTM, 0.9999983090504725);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9983019738438856);
    AssertAlmostEqual(&test, rTM, 0.9999998300699819);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9831499268729031);
    AssertAlmostEqual(&test, rTM, 0.9999999830055485);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.843888718134211);
    AssertAlmostEqual(&test, rTM, 0.9999999982944918);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2139514861040736);
    AssertAlmostEqual(&test, rTM, 0.9999999997769997);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.003438938691962653);
    AssertAlmostEqual(&test, rTM, 0.9999999998546081);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999347177250137);
    AssertAlmostEqual(&test, rTM, 0.9999347177250137);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999347177250137);
    AssertAlmostEqual(&test, rTM, 0.9999347177250139);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999347177250105);
    AssertAlmostEqual(&test, rTM, 0.9999347177250171);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999347177246873);
    AssertAlmostEqual(&test, rTM, 0.9999347177253401);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999347176923737);
    AssertAlmostEqual(&test, rTM, 0.9999347177576539);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999347144610882);
    AssertAlmostEqual(&test, rTM, 0.9999347209887762);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999343921362938);
    AssertAlmostEqual(&test, rTM, 0.9999350416980042);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999076781696093);
    AssertAlmostEqual(&test, rTM, 0.9999538380193158);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993441150383259);
    AssertAlmostEqual(&test, rTM, 0.9999935039795677);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9934925106018195);
    AssertAlmostEqual(&test, rTM, 0.9999993471853155);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.93681181884506);
    AssertAlmostEqual(&test, rTM, 0.9999999346808573);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5263581002384415);
    AssertAlmostEqual(&test, rTM, 0.9999999931325543);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0224224727567795);
    AssertAlmostEqual(&test, rTM, 0.9999999977712154);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995757846038104);
    AssertAlmostEqual(&test, rTM, 0.9995757846038104);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995757846038104);
    AssertAlmostEqual(&test, rTM, 0.9995757846038104);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995757846038101);
    AssertAlmostEqual(&test, rTM, 0.9995757846038106);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995757846037892);
    AssertAlmostEqual(&test, rTM, 0.9995757846038316);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995757846016897);
    AssertAlmostEqual(&test, rTM, 0.999575784605931);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995757843917477);
    AssertAlmostEqual(&test, rTM, 0.9995757848158728);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995757633980707);
    AssertAlmostEqual(&test, rTM, 0.9995758058084901);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995736692542843);
    AssertAlmostEqual(&test, rTM, 0.9995778894597019);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994001215508901);
    AssertAlmostEqual(&test, rTM, 0.999700015773429);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9957448655416614);
    AssertAlmostEqual(&test, rTM, 0.9999577808314682);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9584580544158956);
    AssertAlmostEqual(&test, rTM, 0.9999957562124774);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6562683578174263);
    AssertAlmostEqual(&test, rTM, 0.9999995662512772);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05011679471716414);
    AssertAlmostEqual(&test, rTM, 0.9999999004836395);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.996065453679612);
    AssertAlmostEqual(&test, rTM, 0.996065453679612);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.996065453679612);
    AssertAlmostEqual(&test, rTM, 0.996065453679612);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960654536796119);
    AssertAlmostEqual(&test, rTM, 0.996065453679612);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.99606545367961);
    AssertAlmostEqual(&test, rTM, 0.9960654536796139);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960654536794156);
    AssertAlmostEqual(&test, rTM, 0.9960654536798083);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.996065453659978);
    AssertAlmostEqual(&test, rTM, 0.9960654536992459);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960654517162171);
    AssertAlmostEqual(&test, rTM, 0.9960654556430059);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960652573450027);
    AssertAlmostEqual(&test, rTM, 0.9960656500044438);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960458687596514);
    AssertAlmostEqual(&test, rTM, 0.9960849417851949);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9944402524899426);
    AssertAlmostEqual(&test, rTM, 0.9972162462169422);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9611573671276606);
    AssertAlmostEqual(&test, rTM, 0.999607727052745);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6758791544011049);
    AssertAlmostEqual(&test, rTM, 0.9999598212172749);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05719309836716478);
    AssertAlmostEqual(&test, rTM, 0.9999912863635128);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616476712465818);
    AssertAlmostEqual(&test, rTM, 0.9616476712465818);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616476712465818);
    AssertAlmostEqual(&test, rTM, 0.9616476712465818);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616476712465818);
    AssertAlmostEqual(&test, rTM, 0.9616476712465818);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616476712465816);
    AssertAlmostEqual(&test, rTM, 0.9616476712465819);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616476712465629);
    AssertAlmostEqual(&test, rTM, 0.9616476712466006);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616476712447016);
    AssertAlmostEqual(&test, rTM, 0.9616476712484618);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616476710585693);
    AssertAlmostEqual(&test, rTM, 0.9616476714345943);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.961647652445337);
    AssertAlmostEqual(&test, rTM, 0.9616476900478175);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616457911704712);
    AssertAlmostEqual(&test, rTM, 0.961649551232335);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9614601449113065);
    AssertAlmostEqual(&test, rTM, 0.9618343028750418);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9461990434197175);
    AssertAlmostEqual(&test, rTM, 0.9727224903582048);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.676677876123518);
    AssertAlmostEqual(&test, rTM, 0.9960433680952168);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05800747852404772);
    AssertAlmostEqual(&test, rTM, 0.9991417252596762);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6781839263618333);
    AssertAlmostEqual(&test, rTM, 0.6781839263618333);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6781839263618333);
    AssertAlmostEqual(&test, rTM, 0.6781839263618333);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6781839263618333);
    AssertAlmostEqual(&test, rTM, 0.6781839263618333);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6781839263618333);
    AssertAlmostEqual(&test, rTM, 0.6781839263618333);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.678183926361832);
    AssertAlmostEqual(&test, rTM, 0.6781839263618347);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6781839263617033);
    AssertAlmostEqual(&test, rTM, 0.6781839263619633);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6781839263488282);
    AssertAlmostEqual(&test, rTM, 0.6781839263748385);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6781839250613174);
    AssertAlmostEqual(&test, rTM, 0.6781839276623493);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6781837963102892);
    AssertAlmostEqual(&test, rTM, 0.6781840564133349);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6781709216645641);
    AssertAlmostEqual(&test, rTM, 0.6781969306343691);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6768880044860642);
    AssertAlmostEqual(&test, rTM, 0.6794756441026886);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5793509977481143);
    AssertAlmostEqual(&test, rTM, 0.7573631982114899);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05758330610600575);
    AssertAlmostEqual(&test, rTM, 0.9207360600715669);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810422829819281);
    AssertAlmostEqual(&test, rTM, 0.05810422829819281);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810422829819281);
    AssertAlmostEqual(&test, rTM, 0.05810422829819281);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810422829819281);
    AssertAlmostEqual(&test, rTM, 0.05810422829819281);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810422829819281);
    AssertAlmostEqual(&test, rTM, 0.05810422829819281);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0581042282981928);
    AssertAlmostEqual(&test, rTM, 0.05810422829819281);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810422829819229);
    AssertAlmostEqual(&test, rTM, 0.05810422829819333);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810422829814109);
    AssertAlmostEqual(&test, rTM, 0.05810422829824453);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810422829302053);
    AssertAlmostEqual(&test, rTM, 0.05810422830336509);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810422778096468);
    AssertAlmostEqual(&test, rTM, 0.05810422881542093);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810417657542618);
    AssertAlmostEqual(&test, rTM, 0.05810428002095912);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05809905647885087);
    AssertAlmostEqual(&test, rTM, 0.05810940011441591);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05759157895778485);
    AssertAlmostEqual(&test, rTM, 0.05861684699630626);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03076322187996065);
    AssertAlmostEqual(&test, rTM, 0.08535834805843227);

    userdata[0] = 1000/CAPS_HBAR_EV; /* 1000eV */
    userdata[1] = 0.05/CAPS_HBAR_EV; /* 0.05eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999720448038);
    AssertAlmostEqual(&test, rTM, 0.9999999860224018);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999998013410222);
    AssertAlmostEqual(&test, rTM, 0.9999999980330793);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999980231722126);
    AssertAlmostEqual(&test, rTM, 0.9999999998023368);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999802328764172);
    AssertAlmostEqual(&test, rTM, 0.9999999999802327);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998023464446557);
    AssertAlmostEqual(&test, rTM, 0.9999999999980232);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9980252218597807);
    AssertAlmostEqual(&test, rTM, 0.9999999999998024);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9804270987050642);
    AssertAlmostEqual(&test, rTM, 0.9999999999999802);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.820901080272872);
    AssertAlmostEqual(&test, rTM, 0.999999999999998);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1744276057158437);
    AssertAlmostEqual(&test, rTM, 0.9999999999999997);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002546188095571644);
    AssertAlmostEqual(&test, rTM, 0.9999999999999998);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559072951126295e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999999998);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559202623337432e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999999998);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559203920142499e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999999999998);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999371784999);
    AssertAlmostEqual(&test, rTM, 0.999999937800495);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999115978947);
    AssertAlmostEqual(&test, rTM, 0.9999999557989464);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999993717851769);
    AssertAlmostEqual(&test, rTM, 0.9999999937800493);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999937487339114);
    AssertAlmostEqual(&test, rTM, 0.9999999993749339);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999374921915796);
    AssertAlmostEqual(&test, rTM, 0.9999999999374903);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993750980309652);
    AssertAlmostEqual(&test, rTM, 0.999999999993749);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9937685337131762);
    AssertAlmostEqual(&test, rTM, 0.9999999999993749);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9394134779746921);
    AssertAlmostEqual(&test, rTM, 0.9999999999999375);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5404554800709014);
    AssertAlmostEqual(&test, rTM, 0.9999999999999934);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02436035542230892);
    AssertAlmostEqual(&test, rTM, 0.999999999999998);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002557893966686372);
    AssertAlmostEqual(&test, rTM, 0.999999999999998);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559189934285412e-06);
    AssertAlmostEqual(&test, rTM, 0.999999999999998);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559202902251541e-08);
    AssertAlmostEqual(&test, rTM, 0.999999999999998);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999993748904836);
    AssertAlmostEqual(&test, rTM, 0.9999993748911088);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999993748595415);
    AssertAlmostEqual(&test, rTM, 0.9999993749220493);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999993717730262);
    AssertAlmostEqual(&test, rTM, 0.9999993779930934);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999991159622005);
    AssertAlmostEqual(&test, rTM, 0.9999995579810026);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999993717748022);
    AssertAlmostEqual(&test, rTM, 0.999999937799292);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999374878885866);
    AssertAlmostEqual(&test, rTM, 0.9999999937492186);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993750856388054);
    AssertAlmostEqual(&test, rTM, 0.9999999993748909);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9937684135316335);
    AssertAlmostEqual(&test, rTM, 0.9999999999374888);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9394123427308411);
    AssertAlmostEqual(&test, rTM, 0.9999999999937459);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5404492432767569);
    AssertAlmostEqual(&test, rTM, 0.9999999999993451);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02435945792242566);
    AssertAlmostEqual(&test, rTM, 0.9999999999997948);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002557795071834614);
    AssertAlmostEqual(&test, rTM, 0.9999999999998045);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559090939205709e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999998046);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999980228849135);
    AssertAlmostEqual(&test, rTM, 0.9999980228849332);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999980228839348);
    AssertAlmostEqual(&test, rTM, 0.9999980228859119);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999980227860702);
    AssertAlmostEqual(&test, rTM, 0.9999980229837716);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999980130239489);
    AssertAlmostEqual(&test, rTM, 0.9999980326969597);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999972039381891);
    AssertAlmostEqual(&test, rTM, 0.9999986019681173);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999801304171517);
    AssertAlmostEqual(&test, rTM, 0.9999998032695218);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998022979574943);
    AssertAlmostEqual(&test, rTM, 0.9999999802298183);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9980248355120585);
    AssertAlmostEqual(&test, rTM, 0.999999998022883);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9804233131361835);
    AssertAlmostEqual(&test, rTM, 0.9999999998022786);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8208695376340974);
    AssertAlmostEqual(&test, rTM, 0.9999999999801324);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1743797126357569);
    AssertAlmostEqual(&test, rTM, 0.9999999999972199);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002545198718733458);
    AssertAlmostEqual(&test, rTM, 0.9999999999980356);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.558073544008301e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999980455);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999937368469278);
    AssertAlmostEqual(&test, rTM, 0.9999937368469285);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999937368468969);
    AssertAlmostEqual(&test, rTM, 0.9999937368469595);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999937368437966);
    AssertAlmostEqual(&test, rTM, 0.9999937368500598);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999937365337793);
    AssertAlmostEqual(&test, rTM, 0.9999937371600613);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999937056091616);
    AssertAlmostEqual(&test, rTM, 0.9999937679296687);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999911425754719);
    AssertAlmostEqual(&test, rTM, 0.9999955712779292);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999370578744666);
    AssertAlmostEqual(&test, rTM, 0.9999993767912189);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993738475419319);
    AssertAlmostEqual(&test, rTM, 0.9999999373714034);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9937564071576962);
    AssertAlmostEqual(&test, rTM, 0.9999999937367997);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9392989360371629);
    AssertAlmostEqual(&test, rTM, 0.9999999993733757);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.539826588546233);
    AssertAlmostEqual(&test, rTM, 0.9999999999343689);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02427004087360478);
    AssertAlmostEqual(&test, rTM, 0.9999999999794106);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000254794405561247);
    AssertAlmostEqual(&test, rTM, 0.9999999999803764);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999798503946992);
    AssertAlmostEqual(&test, rTM, 0.9999798503946992);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999798503946982);
    AssertAlmostEqual(&test, rTM, 0.9999798503947002);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999798503945985);
    AssertAlmostEqual(&test, rTM, 0.9999798503948);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999798503846244);
    AssertAlmostEqual(&test, rTM, 0.9999798504047739);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999798493872543);
    AssertAlmostEqual(&test, rTM, 0.9999798514020938);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999797498983087);
    AssertAlmostEqual(&test, rTM, 0.9999799503923551);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999715042738246);
    AssertAlmostEqual(&test, rTM, 0.9999857520354093);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997975174354314);
    AssertAlmostEqual(&test, rTM, 0.9999979950211357);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9979869476768461);
    AssertAlmostEqual(&test, rTM, 0.9999997985119091);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9800521665927509);
    AssertAlmostEqual(&test, rTM, 0.9999999798491793);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8177825968198713);
    AssertAlmostEqual(&test, rTM, 0.9999999979748186);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.169768351508648);
    AssertAlmostEqual(&test, rTM, 0.9999999997139695);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002450906360904263);
    AssertAlmostEqual(&test, rTM, 0.9999999997959951);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999926285058819);
    AssertAlmostEqual(&test, rTM, 0.999926285058819);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999262850588189);
    AssertAlmostEqual(&test, rTM, 0.999926285058819);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999262850588152);
    AssertAlmostEqual(&test, rTM, 0.9999262850588226);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999262850584504);
    AssertAlmostEqual(&test, rTM, 0.9999262850591875);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999262850219628);
    AssertAlmostEqual(&test, rTM, 0.999926285095675);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999262813732999);
    AssertAlmostEqual(&test, rTM, 0.9999262887441538);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999259174145902);
    AssertAlmostEqual(&test, rTM, 0.9999266508786334);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999895752922029);
    AssertAlmostEqual(&test, rTM, 0.9999478751024766);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9992594210842055);
    AssertAlmostEqual(&test, rTM, 0.999992664845253);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9926549896932609);
    AssertAlmostEqual(&test, rTM, 0.9999992628555382);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.928949395652295);
    AssertAlmostEqual(&test, rTM, 0.9999999262323229);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4860568615421543);
    AssertAlmostEqual(&test, rTM, 0.9999999921434222);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0177540497270444);
    AssertAlmostEqual(&test, rTM, 0.9999999971846288);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995621946570106);
    AssertAlmostEqual(&test, rTM, 0.9995621946570106);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995621946570106);
    AssertAlmostEqual(&test, rTM, 0.9995621946570106);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995621946570103);
    AssertAlmostEqual(&test, rTM, 0.9995621946570108);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995621946569887);
    AssertAlmostEqual(&test, rTM, 0.9995621946570324);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999562194654822);
    AssertAlmostEqual(&test, rTM, 0.9995621946591992);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995621944381559);
    AssertAlmostEqual(&test, rTM, 0.9995621948758652);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995621727720836);
    AssertAlmostEqual(&test, rTM, 0.9995622165408438);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995600115561502);
    AssertAlmostEqual(&test, rTM, 0.9995643669282888);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993809058958837);
    AssertAlmostEqual(&test, rTM, 0.9996904050159974);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9956088203909117);
    AssertAlmostEqual(&test, rTM, 0.9999564280467992);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9571560759884438);
    AssertAlmostEqual(&test, rTM, 0.9999956201670613);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6476039013062314);
    AssertAlmostEqual(&test, rTM, 0.9999995517256403);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04732962101336823);
    AssertAlmostEqual(&test, rTM, 0.9999998945945715);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960506727134292);
    AssertAlmostEqual(&test, rTM, 0.9960506727134292);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960506727134292);
    AssertAlmostEqual(&test, rTM, 0.9960506727134292);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960506727134292);
    AssertAlmostEqual(&test, rTM, 0.9960506727134292);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960506727134272);
    AssertAlmostEqual(&test, rTM, 0.9960506727134312);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960506727132321);
    AssertAlmostEqual(&test, rTM, 0.9960506727136262);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960506726937216);
    AssertAlmostEqual(&test, rTM, 0.9960506727331367);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960506707426731);
    AssertAlmostEqual(&test, rTM, 0.9960506746841843);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960504756427121);
    AssertAlmostEqual(&test, rTM, 0.9960508697743323);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960310143653981);
    AssertAlmostEqual(&test, rTM, 0.9960702338855461);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9944193832584296);
    AssertAlmostEqual(&test, rTM, 0.997205782356699);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9610140637906127);
    AssertAlmostEqual(&test, rTM, 0.9996062501937255);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6748958570084913);
    AssertAlmostEqual(&test, rTM, 0.9999596642935031);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0568109728551861);
    AssertAlmostEqual(&test, rTM, 0.9999912273704158);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616332650580273);
    AssertAlmostEqual(&test, rTM, 0.9616332650580273);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616332650580273);
    AssertAlmostEqual(&test, rTM, 0.9616332650580273);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616332650580273);
    AssertAlmostEqual(&test, rTM, 0.9616332650580273);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.961633265058027);
    AssertAlmostEqual(&test, rTM, 0.9616332650580275);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616332650580085);
    AssertAlmostEqual(&test, rTM, 0.9616332650580461);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616332650561464);
    AssertAlmostEqual(&test, rTM, 0.9616332650599081);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616332648699456);
    AssertAlmostEqual(&test, rTM, 0.9616332652461089);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616332462498639);
    AssertAlmostEqual(&test, rTM, 0.9616332838661816);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616313842900726);
    AssertAlmostEqual(&test, rTM, 0.9616351457355928);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.961445669722502);
    AssertAlmostEqual(&test, rTM, 0.9618199653711695);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9461790011802387);
    AssertAlmostEqual(&test, rTM, 0.972712182368192);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6765778995493489);
    AssertAlmostEqual(&test, rTM, 0.9960418000963548);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05796792416834832);
    AssertAlmostEqual(&test, rTM, 0.9991411361682621);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6781739435657047);
    AssertAlmostEqual(&test, rTM, 0.6781739435657047);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6781739435657047);
    AssertAlmostEqual(&test, rTM, 0.6781739435657047);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6781739435657047);
    AssertAlmostEqual(&test, rTM, 0.6781739435657047);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6781739435657047);
    AssertAlmostEqual(&test, rTM, 0.6781739435657048);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6781739435657035);
    AssertAlmostEqual(&test, rTM, 0.678173943565706);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6781739435655747);
    AssertAlmostEqual(&test, rTM, 0.6781739435658348);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6781739435526993);
    AssertAlmostEqual(&test, rTM, 0.6781739435787102);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6781739422651599);
    AssertAlmostEqual(&test, rTM, 0.6781739448662496);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6781738135112672);
    AssertAlmostEqual(&test, rTM, 0.6781740736200998);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6781609385791054);
    AssertAlmostEqual(&test, rTM, 0.6781869481275686);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6768779929121573);
    AssertAlmostEqual(&test, rTM, 0.6794656900646702);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5793391532143511);
    AssertAlmostEqual(&test, rTM, 0.7573550368668979);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05757936749086082);
    AssertAlmostEqual(&test, rTM, 0.9207310333057988);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810383120033612);
    AssertAlmostEqual(&test, rTM, 0.05810383120033612);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810383120033612);
    AssertAlmostEqual(&test, rTM, 0.05810383120033612);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810383120033612);
    AssertAlmostEqual(&test, rTM, 0.05810383120033612);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810383120033612);
    AssertAlmostEqual(&test, rTM, 0.05810383120033612);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810383120033611);
    AssertAlmostEqual(&test, rTM, 0.05810383120033612);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0581038312003356);
    AssertAlmostEqual(&test, rTM, 0.05810383120033663);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810383120028439);
    AssertAlmostEqual(&test, rTM, 0.05810383120038784);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810383119516387);
    AssertAlmostEqual(&test, rTM, 0.05810383120550836);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810383068311111);
    AssertAlmostEqual(&test, rTM, 0.05810383171756112);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810377947788176);
    AssertAlmostEqual(&test, rTM, 0.05810388292279017);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05809865941221862);
    AssertAlmostEqual(&test, rTM, 0.05810900298533483);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05759118495838098);
    AssertAlmostEqual(&test, rTM, 0.05861644680057796);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03076299979556908);
    AssertAlmostEqual(&test, rTM, 0.08535777765360518);

    userdata[0] = 1000/CAPS_HBAR_EV; /* 1000eV */
    userdata[1] = 0.1/CAPS_HBAR_EV; /* 0.1eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999999960465383);
    AssertAlmostEqual(&test, rTM, 0.9999999802326913);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999997190537936);
    AssertAlmostEqual(&test, rTM, 0.999999997218354);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999972043445046);
    AssertAlmostEqual(&test, rTM, 0.9999999997204621);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999972045180459);
    AssertAlmostEqual(&test, rTM, 0.9999999999720448);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999720487107446);
    AssertAlmostEqual(&test, rTM, 0.9999999999972045);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9972083851032574);
    AssertAlmostEqual(&test, rTM, 0.9999999999997204);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9724328194772871);
    AssertAlmostEqual(&test, rTM, 0.999999999999972);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7568050478149456);
    AssertAlmostEqual(&test, rTM, 0.9999999999999972);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1029657829287342);
    AssertAlmostEqual(&test, rTM, 0.9999999999999996);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001276337667697707);
    AssertAlmostEqual(&test, rTM, 0.9999999999999996);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279569245043194e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999999996);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279601664144626e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999999996);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.27960198834601e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999999999996);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999111569924);
    AssertAlmostEqual(&test, rTM, 0.9999999120366262);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999998749805583);
    AssertAlmostEqual(&test, rTM, 0.9999999374902772);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999991115702795);
    AssertAlmostEqual(&test, rTM, 0.9999999912036622);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999911593870249);
    AssertAlmostEqual(&test, rTM, 0.9999999991160232);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999116017626409);
    AssertAlmostEqual(&test, rTM, 0.9999999999115979);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991163696503834);
    AssertAlmostEqual(&test, rTM, 0.9999999999911597);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9911987782457169);
    AssertAlmostEqual(&test, rTM, 0.9999999999991159);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9154190502435713);
    AssertAlmostEqual(&test, rTM, 0.9999999999999115);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4242187529545254);
    AssertAlmostEqual(&test, rTM, 0.9999999999999903);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01247865601618096);
    AssertAlmostEqual(&test, rTM, 0.999999999999996);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001279274395206834);
    AssertAlmostEqual(&test, rTM, 0.9999999999999961);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279598491869935e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999999961);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279601733873209e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999999961);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999999115970394);
    AssertAlmostEqual(&test, rTM, 0.9999991159712781);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999991159266357);
    AssertAlmostEqual(&test, rTM, 0.9999991160150342);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999991115616876);
    AssertAlmostEqual(&test, rTM, 0.9999991203581027);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999987497941957);
    AssertAlmostEqual(&test, rTM, 0.9999993748969025);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999911156523958);
    AssertAlmostEqual(&test, rTM, 0.9999999120357754);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999115965323369);
    AssertAlmostEqual(&test, rTM, 0.9999999911601465);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991163606714282);
    AssertAlmostEqual(&test, rTM, 0.9999999991159708);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.991198693462591);
    AssertAlmostEqual(&test, rTM, 0.9999999999115962);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9154182683838561);
    AssertAlmostEqual(&test, rTM, 0.9999999999911511);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4242154357919069);
    AssertAlmostEqual(&test, rTM, 0.9999999999990334);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01247842060860452);
    AssertAlmostEqual(&test, rTM, 0.9999999999995993);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001279249658356818);
    AssertAlmostEqual(&test, rTM, 0.9999999999996091);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279573742484986e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999996092);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999972042112193);
    AssertAlmostEqual(&test, rTM, 0.9999972042112473);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999972042098354);
    AssertAlmostEqual(&test, rTM, 0.9999972042126312);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999972040714475);
    AssertAlmostEqual(&test, rTM, 0.999997204351012);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999971902670827);
    AssertAlmostEqual(&test, rTM, 0.9999972180861818);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999960461598979);
    AssertAlmostEqual(&test, rTM, 0.9999980230779948);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999719030260823);
    AssertAlmostEqual(&test, rTM, 0.9999997218082699);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997204458373473);
    AssertAlmostEqual(&test, rTM, 0.9999999720434711);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9972081114277179);
    AssertAlmostEqual(&test, rTM, 0.999999997204206);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9724301644327139);
    AssertAlmostEqual(&test, rTM, 0.9999999997203934);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7567845829259292);
    AssertAlmostEqual(&test, rTM, 0.9999999999717702);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1029494263745548);
    AssertAlmostEqual(&test, rTM, 0.9999999999951947);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001276089014522627);
    AssertAlmostEqual(&test, rTM, 0.9999999999960818);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279319331667342e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999960917);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999911511984719);
    AssertAlmostEqual(&test, rTM, 0.9999911511984728);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999911511984281);
    AssertAlmostEqual(&test, rTM, 0.9999911511985166);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999991151194048);
    AssertAlmostEqual(&test, rTM, 0.9999911512028967);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999911507560453);
    AssertAlmostEqual(&test, rTM, 0.9999911516408773);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999911070647214);
    AssertAlmostEqual(&test, rTM, 0.9999911951131979);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999874859278028);
    AssertAlmostEqual(&test, rTM, 0.999993742944326);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999110742059516);
    AssertAlmostEqual(&test, rTM, 0.9999991195078303);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991154631514827);
    AssertAlmostEqual(&test, rTM, 0.9999999115160125);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.991190219316938);
    AssertAlmostEqual(&test, rTM, 0.9999999911510772);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9153401240024595);
    AssertAlmostEqual(&test, rTM, 0.9999999991142503);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4238840386404791);
    AssertAlmostEqual(&test, rTM, 0.9999999999032374);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01245492462675385);
    AssertAlmostEqual(&test, rTM, 0.9999999999598614);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000127678079513639);
    AssertAlmostEqual(&test, rTM, 0.999999999960839);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999717734384374);
    AssertAlmostEqual(&test, rTM, 0.9999717734384374);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999717734384359);
    AssertAlmostEqual(&test, rTM, 0.9999717734384388);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999717734382962);
    AssertAlmostEqual(&test, rTM, 0.9999717734385785);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999717734243243);
    AssertAlmostEqual(&test, rTM, 0.9999717734525504);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999717720271645);
    AssertAlmostEqual(&test, rTM, 0.9999717748496397);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999716326587051);
    AssertAlmostEqual(&test, rTM, 0.9999719135195262);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999960081847181);
    AssertAlmostEqual(&test, rTM, 0.9999800407244022);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997163627970265);
    AssertAlmostEqual(&test, rTM, 0.9999971913164259);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9971811442677116);
    AssertAlmostEqual(&test, rTM, 0.9999997177442718);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9721685958454004);
    AssertAlmostEqual(&test, rTM, 0.9999999717702435);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7547710560883618);
    AssertAlmostEqual(&test, rTM, 0.99999999714933);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1013555584581867);
    AssertAlmostEqual(&test, rTM, 0.9999999995117549);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001251940483429324);
    AssertAlmostEqual(&test, rTM, 0.9999999996006206);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999033519001459);
    AssertAlmostEqual(&test, rTM, 0.9999033519001459);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999033519001459);
    AssertAlmostEqual(&test, rTM, 0.999903351900146);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999033519001411);
    AssertAlmostEqual(&test, rTM, 0.9999033519001508);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999033518996627);
    AssertAlmostEqual(&test, rTM, 0.9999033519006292);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999033518518242);
    AssertAlmostEqual(&test, rTM, 0.9999033519484676);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999033470680952);
    AssertAlmostEqual(&test, rTM, 0.9999033567319551);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999028698851563);
    AssertAlmostEqual(&test, rTM, 0.9999038315232176);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998633216823868);
    AssertAlmostEqual(&test, rTM, 0.9999316585058337);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999029123321052);
    AssertAlmostEqual(&test, rTM, 0.999990382735004);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9903808402678071);
    AssertAlmostEqual(&test, rTM, 0.999999033509799);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9079052670590105);
    AssertAlmostEqual(&test, rTM, 0.9999999032344851);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3936136745515031);
    AssertAlmostEqual(&test, rTM, 0.9999999892652579);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01048140030870607);
    AssertAlmostEqual(&test, rTM, 0.9999999952301691);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995196654879899);
    AssertAlmostEqual(&test, rTM, 0.9995196654879899);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995196654879899);
    AssertAlmostEqual(&test, rTM, 0.9995196654879899);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995196654879897);
    AssertAlmostEqual(&test, rTM, 0.9995196654879901);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995196654879659);
    AssertAlmostEqual(&test, rTM, 0.9995196654880139);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995196654855888);
    AssertAlmostEqual(&test, rTM, 0.999519665490391);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995196652478804);
    AssertAlmostEqual(&test, rTM, 0.9995196657280992);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995196414776343);
    AssertAlmostEqual(&test, rTM, 0.9995196894971456);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995172703681532);
    AssertAlmostEqual(&test, rTM, 0.9995220487269985);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993207720081969);
    AssertAlmostEqual(&test, rTM, 0.9996603283058727);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9951831810707509);
    AssertAlmostEqual(&test, rTM, 0.9999521944528841);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9530930194175289);
    AssertAlmostEqual(&test, rTM, 0.999995194366729);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6212975212264453);
    AssertAlmostEqual(&test, rTM, 0.9999995058819905);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03993086949449236);
    AssertAlmostEqual(&test, rTM, 0.9999998749832638);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960017997894189);
    AssertAlmostEqual(&test, rTM, 0.9960017997894189);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960017997894189);
    AssertAlmostEqual(&test, rTM, 0.9960017997894189);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960017997894189);
    AssertAlmostEqual(&test, rTM, 0.9960017997894189);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960017997894169);
    AssertAlmostEqual(&test, rTM, 0.9960017997894209);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960017997892194);
    AssertAlmostEqual(&test, rTM, 0.9960017997896184);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.996001799769468);
    AssertAlmostEqual(&test, rTM, 0.9960017998093699);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960017977943237);
    AssertAlmostEqual(&test, rTM, 0.9960018017845131);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960016002848565);
    AssertAlmostEqual(&test, rTM, 0.9960019992840468);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9959818986610083);
    AssertAlmostEqual(&test, rTM, 0.9960216025466188);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.994350380540905);
    AssertAlmostEqual(&test, rTM, 0.9971711835179783);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.960540373076947);
    AssertAlmostEqual(&test, rTM, 0.9996013668068183);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6716556631259593);
    AssertAlmostEqual(&test, rTM, 0.9999591449603746);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05557340764718826);
    AssertAlmostEqual(&test, rTM, 0.9999910307629954);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9615852857967336);
    AssertAlmostEqual(&test, rTM, 0.9615852857967336);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9615852857967336);
    AssertAlmostEqual(&test, rTM, 0.9615852857967336);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9615852857967335);
    AssertAlmostEqual(&test, rTM, 0.9615852857967336);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9615852857967334);
    AssertAlmostEqual(&test, rTM, 0.9615852857967337);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9615852857967148);
    AssertAlmostEqual(&test, rTM, 0.9615852857967524);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9615852857948505);
    AssertAlmostEqual(&test, rTM, 0.9615852857986167);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9615852856084215);
    AssertAlmostEqual(&test, rTM, 0.9615852859850457);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9615852669655287);
    AssertAlmostEqual(&test, rTM, 0.9615853046279293);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9615834027246973);
    AssertAlmostEqual(&test, rTM, 0.9615871687782745);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9613974606664578);
    AssertAlmostEqual(&test, rTM, 0.9617722148537505);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9461122521838218);
    AssertAlmostEqual(&test, rTM, 0.9726778516531526);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6762450372613528);
    AssertAlmostEqual(&test, rTM, 0.9960365773317024);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05783646632503714);
    AssertAlmostEqual(&test, rTM, 0.9991391725741638);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6781406715081518);
    AssertAlmostEqual(&test, rTM, 0.6781406715081518);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6781406715081518);
    AssertAlmostEqual(&test, rTM, 0.6781406715081518);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6781406715081518);
    AssertAlmostEqual(&test, rTM, 0.6781406715081518);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6781406715081518);
    AssertAlmostEqual(&test, rTM, 0.6781406715081518);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6781406715081506);
    AssertAlmostEqual(&test, rTM, 0.6781406715081532);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6781406715080218);
    AssertAlmostEqual(&test, rTM, 0.6781406715082819);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6781406714951455);
    AssertAlmostEqual(&test, rTM, 0.6781406715211583);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6781406702075106);
    AssertAlmostEqual(&test, rTM, 0.6781406728087931);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6781405414440712);
    AssertAlmostEqual(&test, rTM, 0.67814080157219);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6781276655572938);
    AssertAlmostEqual(&test, rTM, 0.6781536770342679);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6768446249460981);
    AssertAlmostEqual(&test, rTM, 0.6794325138501163);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5792996766992881);
    AssertAlmostEqual(&test, rTM, 0.7573278352224876);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05756624267702896);
    AssertAlmostEqual(&test, rTM, 0.9207142778492156);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810250758014588);
    AssertAlmostEqual(&test, rTM, 0.05810250758014588);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810250758014588);
    AssertAlmostEqual(&test, rTM, 0.05810250758014588);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810250758014588);
    AssertAlmostEqual(&test, rTM, 0.05810250758014588);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810250758014588);
    AssertAlmostEqual(&test, rTM, 0.05810250758014588);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810250758014588);
    AssertAlmostEqual(&test, rTM, 0.05810250758014589);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810250758014537);
    AssertAlmostEqual(&test, rTM, 0.0581025075801464);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810250758009416);
    AssertAlmostEqual(&test, rTM, 0.0581025075801976);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810250757497374);
    AssertAlmostEqual(&test, rTM, 0.05810250758531803);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810250706293129);
    AssertAlmostEqual(&test, rTM, 0.05810250809736048);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810245585873239);
    AssertAlmostEqual(&test, rTM, 0.05810255930155906);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05809733589610715);
    AssertAlmostEqual(&test, rTM, 0.05810767926106603);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05758987166609777);
    AssertAlmostEqual(&test, rTM, 0.05861511285441797);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03076225953744343);
    AssertAlmostEqual(&test, rTM, 0.08535587635934321);

    userdata[0] = 1000/CAPS_HBAR_EV; /* 1000eV */
    userdata[1] = 0.5/CAPS_HBAR_EV; /* 0.5eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999115979118);
    AssertAlmostEqual(&test, rTM, 0.999999955798955);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999993717852985);
    AssertAlmostEqual(&test, rTM, 0.9999999937800506);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999937487351205);
    AssertAlmostEqual(&test, rTM, 0.9999999993749341);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999374922036695);
    AssertAlmostEqual(&test, rTM, 0.9999999999374903);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993750981517957);
    AssertAlmostEqual(&test, rTM, 0.999999999993749);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.993768534914696);
    AssertAlmostEqual(&test, rTM, 0.9999999999993749);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9394134893272195);
    AssertAlmostEqual(&test, rTM, 0.9999999999999375);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5404555424398682);
    AssertAlmostEqual(&test, rTM, 0.9999999999999934);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02436036439764193);
    AssertAlmostEqual(&test, rTM, 0.999999999999998);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002557894955673509);
    AssertAlmostEqual(&test, rTM, 0.999999999999998);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559190924274887e-06);
    AssertAlmostEqual(&test, rTM, 0.999999999999998);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559203892251049e-08);
    AssertAlmostEqual(&test, rTM, 0.999999999999998);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.55920402193164e-10);
    AssertAlmostEqual(&test, rTM, 0.999999999999998);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999998013410222);
    AssertAlmostEqual(&test, rTM, 0.9999998033079426);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999997204480733);
    AssertAlmostEqual(&test, rTM, 0.9999998602240269);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999980134119979);
    AssertAlmostEqual(&test, rTM, 0.9999999803307925);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999802318979795);
    AssertAlmostEqual(&test, rTM, 0.9999999980233679);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999802346346827);
    AssertAlmostEqual(&test, rTM, 0.999999999802327);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9980252218500153);
    AssertAlmostEqual(&test, rTM, 0.9999999999802327);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9804270987041049);
    AssertAlmostEqual(&test, rTM, 0.9999999999980231);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8209010802727921);
    AssertAlmostEqual(&test, rTM, 0.9999999999998014);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1744276057158425);
    AssertAlmostEqual(&test, rTM, 0.9999999999999722);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002546188095571644);
    AssertAlmostEqual(&test, rTM, 0.9999999999999803);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559072951126295e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999999805);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559202623337433e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999999805);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.5592039201425e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999999999805);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999980232662349);
    AssertAlmostEqual(&test, rTM, 0.9999980232682115);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999980231683891);
    AssertAlmostEqual(&test, rTM, 0.9999980233660524);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999980134081555);
    AssertAlmostEqual(&test, rTM, 0.9999980330773623);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999972044788423);
    AssertAlmostEqual(&test, rTM, 0.9999986022384443);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999801342591489);
    AssertAlmostEqual(&test, rTM, 0.9999998033075621);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998023361819086);
    AssertAlmostEqual(&test, rTM, 0.9999999802336411);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9980252170576374);
    AssertAlmostEqual(&test, rTM, 0.9999999980232653);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9804270611245596);
    AssertAlmostEqual(&test, rTM, 0.9999999998023169);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.820900767925091);
    AssertAlmostEqual(&test, rTM, 0.9999999999801363);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.174427131393819);
    AssertAlmostEqual(&test, rTM, 0.9999999999972207);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002546178295991177);
    AssertAlmostEqual(&test, rTM, 0.9999999999980362);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559063052178707e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999980461);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559192723386638e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999980462);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999993748925515);
    AssertAlmostEqual(&test, rTM, 0.9999937489255775);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999937489224207);
    AssertAlmostEqual(&test, rTM, 0.9999937489286718);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999937486130013);
    AssertAlmostEqual(&test, rTM, 0.9999937492380755);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999993717748022);
    AssertAlmostEqual(&test, rTM, 0.9999937799483433);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999911596571732);
    AssertAlmostEqual(&test, rTM, 0.9999955798188176);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999371792562022);
    AssertAlmostEqual(&test, rTM, 0.999999377993093);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993750547160096);
    AssertAlmostEqual(&test, rTM, 0.9999999374921843);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9937684104566401);
    AssertAlmostEqual(&test, rTM, 0.9999999937488786);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9394123424403014);
    AssertAlmostEqual(&test, rTM, 0.9999999993745854);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5404492432607952);
    AssertAlmostEqual(&test, rTM, 0.9999999999345068);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02435945792240269);
    AssertAlmostEqual(&test, rTM, 0.9999999999794863);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002557795071834589);
    AssertAlmostEqual(&test, rTM, 0.9999999999804519);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559090939205709e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999804619);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999802290251362);
    AssertAlmostEqual(&test, rTM, 0.9999802290251382);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999802290250382);
    AssertAlmostEqual(&test, rTM, 0.999980229025236);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999802290152517);
    AssertAlmostEqual(&test, rTM, 0.9999802290350225);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999802280366229);
    AssertAlmostEqual(&test, rTM, 0.999980230013602);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999801304171517);
    AssertAlmostEqual(&test, rTM, 0.9999803271437596);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999972039733698);
    AssertAlmostEqual(&test, rTM, 0.9999860197691248);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998013219369135);
    AssertAlmostEqual(&test, rTM, 0.9999980326969502);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.998024737840588);
    AssertAlmostEqual(&test, rTM, 0.9999998022981047);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9804233035415172);
    AssertAlmostEqual(&test, rTM, 0.9999999802278737);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8208695368346315);
    AssertAlmostEqual(&test, rTM, 0.9999999980132458);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1743797126236201);
    AssertAlmostEqual(&test, rTM, 0.9999999997219884);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002545198718730952);
    AssertAlmostEqual(&test, rTM, 0.9999999998035529);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.558073544008276e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999998045405);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999373702344813);
    AssertAlmostEqual(&test, rTM, 0.9999373702344814);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999373702344782);
    AssertAlmostEqual(&test, rTM, 0.9999373702344844);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999373702341682);
    AssertAlmostEqual(&test, rTM, 0.9999373702347945);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999373702031674);
    AssertAlmostEqual(&test, rTM, 0.9999373702657952);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999373671031694);
    AssertAlmostEqual(&test, rTM, 0.9999373733656367);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999370578744666);
    AssertAlmostEqual(&test, rTM, 0.9999376810444095);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999114292850937);
    AssertAlmostEqual(&test, rTM, 0.9999557136618853);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993707570020295);
    AssertAlmostEqual(&test, rTM, 0.9999937679293661);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9937560990756683);
    AssertAlmostEqual(&test, rTM, 0.9999993737111704);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9392989069306317);
    AssertAlmostEqual(&test, rTM, 0.9999999373376031);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.539826586949107);
    AssertAlmostEqual(&test, rTM, 0.9999999934368994);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02427004087131591);
    AssertAlmostEqual(&test, rTM, 0.9999999979410604);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002547944055609949);
    AssertAlmostEqual(&test, rTM, 0.9999999980376336);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997985222166441);
    AssertAlmostEqual(&test, rTM, 0.9997985222166442);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997985222166441);
    AssertAlmostEqual(&test, rTM, 0.9997985222166442);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997985222166341);
    AssertAlmostEqual(&test, rTM, 0.9997985222166542);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997985222156369);
    AssertAlmostEqual(&test, rTM, 0.9997985222176514);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997985221159155);
    AssertAlmostEqual(&test, rTM, 0.9997985223173729);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997985121440218);
    AssertAlmostEqual(&test, rTM, 0.999798532288763);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997975174354314);
    AssertAlmostEqual(&test, rTM, 0.9997995220123211);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997150792767125);
    AssertAlmostEqual(&test, rTM, 0.9998575294887101);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.997977018663828);
    AssertAlmostEqual(&test, rTM, 0.9999799503822805);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.980051189148295);
    AssertAlmostEqual(&test, rTM, 0.9999979850196947);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8177825156638334);
    AssertAlmostEqual(&test, rTM, 0.9999997974819818);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1697683503157829);
    AssertAlmostEqual(&test, rTM, 0.9999999713969455);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.00245090636066281);
    AssertAlmostEqual(&test, rTM, 0.9999999795995068);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9992630950818061);
    AssertAlmostEqual(&test, rTM, 0.9992630950818061);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9992630950818061);
    AssertAlmostEqual(&test, rTM, 0.9992630950818061);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9992630950818057);
    AssertAlmostEqual(&test, rTM, 0.9992630950818064);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9992630950817692);
    AssertAlmostEqual(&test, rTM, 0.9992630950818429);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9992630950781229);
    AssertAlmostEqual(&test, rTM, 0.9992630950854893);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9992630947134895);
    AssertAlmostEqual(&test, rTM, 0.9992630954501225);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9992630582510623);
    AssertAlmostEqual(&test, rTM, 0.9992631319107098);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9992594210842055);
    AssertAlmostEqual(&test, rTM, 0.9992667508594608);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9989580181664544);
    AssertAlmostEqual(&test, rTM, 0.9994788732613166);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9926188593844166);
    AssertAlmostEqual(&test, rTM, 0.9999266503853357);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.928946008285672);
    AssertAlmostEqual(&test, rTM, 0.9999926236248481);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.48605669512361);
    AssertAlmostEqual(&test, rTM, 0.9999992143429673);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01775404955741152);
    AssertAlmostEqual(&test, rTM, 0.9999997184629614);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9956305652649139);
    AssertAlmostEqual(&test, rTM, 0.9956305652649139);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9956305652649139);
    AssertAlmostEqual(&test, rTM, 0.9956305652649139);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9956305652649139);
    AssertAlmostEqual(&test, rTM, 0.9956305652649139);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9956305652649117);
    AssertAlmostEqual(&test, rTM, 0.995630565264916);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9956305652646958);
    AssertAlmostEqual(&test, rTM, 0.9956305652651318);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9956305652431146);
    AssertAlmostEqual(&test, rTM, 0.9956305652867132);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9956305630849805);
    AssertAlmostEqual(&test, rTM, 0.9956305674448461);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9956303472769946);
    AssertAlmostEqual(&test, rTM, 0.9956307832419822);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9956088203909117);
    AssertAlmostEqual(&test, rTM, 0.9956522026941244);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9938262877399902);
    AssertAlmostEqual(&test, rTM, 0.996908357366741);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9569491952531625);
    AssertAlmostEqual(&test, rTM, 0.9995642635780576);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6475901891213922);
    AssertAlmostEqual(&test, rTM, 0.9999551758886299);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.04732957839202813);
    AssertAlmostEqual(&test, rTM, 0.9999894595630724);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9612037159987618);
    AssertAlmostEqual(&test, rTM, 0.9612037159987618);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9612037159987618);
    AssertAlmostEqual(&test, rTM, 0.9612037159987618);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9612037159987618);
    AssertAlmostEqual(&test, rTM, 0.9612037159987618);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9612037159987615);
    AssertAlmostEqual(&test, rTM, 0.961203715998762);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9612037159987428);
    AssertAlmostEqual(&test, rTM, 0.9612037159987807);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9612037159968603);
    AssertAlmostEqual(&test, rTM, 0.9612037160006631);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9612037158086176);
    AssertAlmostEqual(&test, rTM, 0.9612037161889059);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9612036969843563);
    AssertAlmostEqual(&test, rTM, 0.961203735013158);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9612018146071538);
    AssertAlmostEqual(&test, rTM, 0.961205617299031);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9610140637906127);
    AssertAlmostEqual(&test, rTM, 0.9613924637823168);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9455814605533744);
    AssertAlmostEqual(&test, rTM, 0.9724048070640724);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6736036387750582);
    AssertAlmostEqual(&test, rTM, 0.9959950085003761);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05680595370816383);
    AssertAlmostEqual(&test, rTM, 0.9991234662104153);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6778747124158686);
    AssertAlmostEqual(&test, rTM, 0.6778747124158686);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6778747124158686);
    AssertAlmostEqual(&test, rTM, 0.6778747124158686);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6778747124158686);
    AssertAlmostEqual(&test, rTM, 0.6778747124158686);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6778747124158686);
    AssertAlmostEqual(&test, rTM, 0.6778747124158686);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6778747124158673);
    AssertAlmostEqual(&test, rTM, 0.6778747124158699);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6778747124157385);
    AssertAlmostEqual(&test, rTM, 0.6778747124159987);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6778747124028545);
    AssertAlmostEqual(&test, rTM, 0.6778747124288828);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6778747111144569);
    AssertAlmostEqual(&test, rTM, 0.6778747137172804);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6778745822747397);
    AssertAlmostEqual(&test, rTM, 0.677874842556955);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6778616987606083);
    AssertAlmostEqual(&test, rTM, 0.6778877256463338);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.676577899549349);
    AssertAlmostEqual(&test, rTM, 0.6791673205411609);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5789841557606329);
    AssertAlmostEqual(&test, rTM, 0.7571103790346986);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05746145988965209);
    AssertAlmostEqual(&test, rTM, 0.9205802579655717);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0580919207965516);
    AssertAlmostEqual(&test, rTM, 0.0580919207965516);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0580919207965516);
    AssertAlmostEqual(&test, rTM, 0.0580919207965516);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0580919207965516);
    AssertAlmostEqual(&test, rTM, 0.0580919207965516);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0580919207965516);
    AssertAlmostEqual(&test, rTM, 0.0580919207965516);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05809192079655159);
    AssertAlmostEqual(&test, rTM, 0.05809192079655161);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05809192079655108);
    AssertAlmostEqual(&test, rTM, 0.05809192079655211);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05809192079649989);
    AssertAlmostEqual(&test, rTM, 0.05809192079660331);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05809192079138029);
    AssertAlmostEqual(&test, rTM, 0.05809192080172292);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05809192027942026);
    AssertAlmostEqual(&test, rTM, 0.05809192131368294);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05809186908346355);
    AssertAlmostEqual(&test, rTM, 0.05809197250963934);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05808674994499304);
    AssertAlmostEqual(&test, rTM, 0.05809709164499315);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05757936749086084);
    AssertAlmostEqual(&test, rTM, 0.0586044434779586);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03075633875594337);
    AssertAlmostEqual(&test, rTM, 0.08534066905972153);

    userdata[0] = 1000/CAPS_HBAR_EV; /* 1000eV */
    userdata[1] = 1/CAPS_HBAR_EV; /* 1eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999998749805704);
    AssertAlmostEqual(&test, rTM, 0.9999999374902833);

    caps_fresnel(caps, 1e-06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999991115703655);
    AssertAlmostEqual(&test, rTM, 0.9999999912036631);

    caps_fresnel(caps, 1e-06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999911593878799);
    AssertAlmostEqual(&test, rTM, 0.9999999991160233);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999116017711895);
    AssertAlmostEqual(&test, rTM, 0.9999999999115979);

    caps_fresnel(caps, 1e-06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991163697358013);
    AssertAlmostEqual(&test, rTM, 0.9999999999911597);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9911987790931186);
    AssertAlmostEqual(&test, rTM, 0.9999999999991159);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9154190580621701);
    AssertAlmostEqual(&test, rTM, 0.9999999999999115);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4242187861264693);
    AssertAlmostEqual(&test, rTM, 0.9999999999999903);

    caps_fresnel(caps, 1e-06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01247865837030158);
    AssertAlmostEqual(&test, rTM, 0.999999999999996);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001279274642580166);
    AssertAlmostEqual(&test, rTM, 0.9999999999999961);

    caps_fresnel(caps, 1e-06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279598739368619e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999999961);

    caps_fresnel(caps, 1e-06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279601981373147e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999999961);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279602013793296e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999999999961);

    caps_fresnel(caps, 1e-05, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999997190537936);
    AssertAlmostEqual(&test, rTM, 0.9999997218354388);

    caps_fresnel(caps, 1e-05, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999996046539006);
    AssertAlmostEqual(&test, rTM, 0.9999998023269308);

    caps_fresnel(caps, 1e-05, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999971905414879);
    AssertAlmostEqual(&test, rTM, 0.9999999721835404);

    caps_fresnel(caps, 1e-05, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999720437967504);
    AssertAlmostEqual(&test, rTM, 0.9999999972046202);

    caps_fresnel(caps, 1e-05, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997204869691064);
    AssertAlmostEqual(&test, rTM, 0.9999999997204482);

    caps_fresnel(caps, 1e-05, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9972083850894582);
    AssertAlmostEqual(&test, rTM, 0.9999999999720448);

    caps_fresnel(caps, 1e-05, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9724328194759416);
    AssertAlmostEqual(&test, rTM, 0.9999999999972042);

    caps_fresnel(caps, 1e-05, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7568050478148419);
    AssertAlmostEqual(&test, rTM, 0.9999999999997178);

    caps_fresnel(caps, 1e-05, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1029657829287334);
    AssertAlmostEqual(&test, rTM, 0.9999999999999519);

    caps_fresnel(caps, 1e-05, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001276337667697707);
    AssertAlmostEqual(&test, rTM, 0.9999999999999608);

    caps_fresnel(caps, 1e-05, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279569245043194e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999999609);

    caps_fresnel(caps, 1e-05, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279601664144627e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999999609);

    caps_fresnel(caps, 1e-05, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279601988346011e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999999999609);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999972044801754);
    AssertAlmostEqual(&test, rTM, 0.9999972044829709);

    caps_fresnel(caps, 0.001, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999972043418009);
    AssertAlmostEqual(&test, rTM, 0.9999972046213385);

    caps_fresnel(caps, 0.001, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999997190538771);
    AssertAlmostEqual(&test, rTM, 0.9999972183551801);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999960465422159);
    AssertAlmostEqual(&test, rTM, 0.9999980232691542);

    caps_fresnel(caps, 0.001, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999719057428962);
    AssertAlmostEqual(&test, rTM, 0.9999997218351698);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997204728652098);
    AssertAlmostEqual(&test, rTM, 0.9999999720461744);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9972083810135504);
    AssertAlmostEqual(&test, rTM, 0.9999999972044763);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.97243279305386);
    AssertAlmostEqual(&test, rTM, 0.9999999997204204);

    caps_fresnel(caps, 0.001, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7568048451692128);
    AssertAlmostEqual(&test, rTM, 0.999999999971773);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1029656209568222);
    AssertAlmostEqual(&test, rTM, 0.9999999999951955);

    caps_fresnel(caps, 0.001, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001276335205310102);
    AssertAlmostEqual(&test, rTM, 0.9999999999960826);

    caps_fresnel(caps, 0.001, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279566770174752e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999960925);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279599189150777e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999960926);

    caps_fresnel(caps, 0.01, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999991159743484);
    AssertAlmostEqual(&test, rTM, 0.9999911597435723);

    caps_fresnel(caps, 0.01, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999991159739108);
    AssertAlmostEqual(&test, rTM, 0.9999911597479483);

    caps_fresnel(caps, 0.01, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999911593015284);
    AssertAlmostEqual(&test, rTM, 0.9999911601855059);

    caps_fresnel(caps, 0.01, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999911156523958);
    AssertAlmostEqual(&test, rTM, 0.9999912036158466);

    caps_fresnel(caps, 0.01, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999874980122924);
    AssertAlmostEqual(&test, rTM, 0.9999937489866085);

    caps_fresnel(caps, 0.01, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999111600758263);
    AssertAlmostEqual(&test, rTM, 0.9999991203581019);

    caps_fresnel(caps, 0.01, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999116316951742);
    AssertAlmostEqual(&test, rTM, 0.9999999116014596);

    caps_fresnel(caps, 0.01, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9911986891252023);
    AssertAlmostEqual(&test, rTM, 0.9999999911596226);

    caps_fresnel(caps, 0.01, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9154182679836648);
    AssertAlmostEqual(&test, rTM, 0.9999999991151073);

    caps_fresnel(caps, 0.01, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4242154357749282);
    AssertAlmostEqual(&test, rTM, 0.9999999999033461);

    caps_fresnel(caps, 0.01, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01247842060859247);
    AssertAlmostEqual(&test, rTM, 0.999999999959937);

    caps_fresnel(caps, 0.01, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001279249658356806);
    AssertAlmostEqual(&test, rTM, 0.9999999999609146);

    caps_fresnel(caps, 0.01, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279573742484986e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999609245);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999720424640689);
    AssertAlmostEqual(&test, rTM, 0.9999720424640717);

    caps_fresnel(caps, 0.1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999720424639305);
    AssertAlmostEqual(&test, rTM, 0.99997204246421);

    caps_fresnel(caps, 0.1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999720424500917);
    AssertAlmostEqual(&test, rTM, 0.9999720424780488);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999720410662479);
    AssertAlmostEqual(&test, rTM, 0.9999720438618227);

    caps_fresnel(caps, 0.1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999719030260823);
    AssertAlmostEqual(&test, rTM, 0.9999721812100734);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999604623024525);
    AssertAlmostEqual(&test, rTM, 0.9999802309558168);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997190657838733);
    AssertAlmostEqual(&test, rTM, 0.9999972180861549);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9972079734259837);
    AssertAlmostEqual(&test, rTM, 0.9999997204344764);

    caps_fresnel(caps, 0.1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9724301509764021);
    AssertAlmostEqual(&test, rTM, 0.9999999720393561);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7567845818886872);
    AssertAlmostEqual(&test, rTM, 0.999999997177023);

    caps_fresnel(caps, 0.1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1029494263662654);
    AssertAlmostEqual(&test, rTM, 0.9999999995194722);

    caps_fresnel(caps, 0.1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001276089014521367);
    AssertAlmostEqual(&test, rTM, 0.9999999996081784);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.27931933166733e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999996091672);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999911515508227);
    AssertAlmostEqual(&test, rTM, 0.9999115155082271);

    caps_fresnel(caps, 1, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999115155082225);
    AssertAlmostEqual(&test, rTM, 0.9999115155082314);

    caps_fresnel(caps, 1, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999115155077846);
    AssertAlmostEqual(&test, rTM, 0.9999115155086694);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999115154639867);
    AssertAlmostEqual(&test, rTM, 0.9999115155524673);

    caps_fresnel(caps, 1, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999115110843088);
    AssertAlmostEqual(&test, rTM, 0.9999115199319241);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999110742059516);
    AssertAlmostEqual(&test, rTM, 0.9999119546205965);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998748663249644);
    AssertAlmostEqual(&test, rTM, 0.9999374312049939);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991110978549883);
    AssertAlmostEqual(&test, rTM, 0.9999911951123446);

    caps_fresnel(caps, 1, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.99118978517347);
    AssertAlmostEqual(&test, rTM, 0.9999991151519049);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9153400839481458);
    AssertAlmostEqual(&test, rTM, 0.9999999114250736);

    caps_fresnel(caps, 1, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4238840369425579);
    AssertAlmostEqual(&test, rTM, 0.9999999903237414);

    caps_fresnel(caps, 1, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01245492462555115);
    AssertAlmostEqual(&test, rTM, 0.9999999959861464);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001276780795135126);
    AssertAlmostEqual(&test, rTM, 0.9999999960839011);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997177702358475);
    AssertAlmostEqual(&test, rTM, 0.9997177702358475);

    caps_fresnel(caps, 10, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997177702358474);
    AssertAlmostEqual(&test, rTM, 0.9997177702358476);

    caps_fresnel(caps, 10, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997177702358334);
    AssertAlmostEqual(&test, rTM, 0.9997177702358616);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997177702344365);
    AssertAlmostEqual(&test, rTM, 0.9997177702372585);

    caps_fresnel(caps, 10, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997177700947526);
    AssertAlmostEqual(&test, rTM, 0.9997177703769423);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997177561267038);
    AssertAlmostEqual(&test, rTM, 0.999717784344286);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997163627970265);
    AssertAlmostEqual(&test, rTM, 0.999719170691784);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996008901724517);
    AssertAlmostEqual(&test, rTM, 0.9998004251691822);

    caps_fresnel(caps, 10, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9971672464252195);
    AssertAlmostEqual(&test, rTM, 0.9999719134918308);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9721672376683953);
    AssertAlmostEqual(&test, rTM, 0.9999971771680437);

    caps_fresnel(caps, 10, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7547709516640665);
    AssertAlmostEqual(&test, rTM, 0.9999997149331799);

    caps_fresnel(caps, 10, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1013555576394521);
    AssertAlmostEqual(&test, rTM, 0.9999999511754945);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001251940483305692);
    AssertAlmostEqual(&test, rTM, 0.9999999600620634);

    caps_fresnel(caps, 100, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9990339392688379);
    AssertAlmostEqual(&test, rTM, 0.9990339392688379);

    caps_fresnel(caps, 100, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9990339392688379);
    AssertAlmostEqual(&test, rTM, 0.9990339392688379);

    caps_fresnel(caps, 100, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9990339392688374);
    AssertAlmostEqual(&test, rTM, 0.9990339392688384);

    caps_fresnel(caps, 100, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9990339392687896);
    AssertAlmostEqual(&test, rTM, 0.9990339392688862);

    caps_fresnel(caps, 100, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.99903393926401);
    AssertAlmostEqual(&test, rTM, 0.9990339392736659);

    caps_fresnel(caps, 100, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9990339387860411);
    AssertAlmostEqual(&test, rTM, 0.9990339397516345);

    caps_fresnel(caps, 100, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9990338909903526);
    AssertAlmostEqual(&test, rTM, 0.9990339875449118);

    caps_fresnel(caps, 100, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999029123321052);
    AssertAlmostEqual(&test, rTM, 0.9990387313390288);

    caps_fresnel(caps, 100, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9986340572660607);
    AssertAlmostEqual(&test, rTM, 0.9993167951689124);

    caps_fresnel(caps, 100, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.990333578086697);
    AssertAlmostEqual(&test, rTM, 0.9999038304114183);

    caps_fresnel(caps, 100, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9079009285403404);
    AssertAlmostEqual(&test, rTM, 0.9999903239749219);

    caps_fresnel(caps, 100, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3936135049958998);
    AssertAlmostEqual(&test, rTM, 0.9999989265270348);

    caps_fresnel(caps, 100, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01048140020709287);
    AssertAlmostEqual(&test, rTM, 0.9999995230171358);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9952070286010416);
    AssertAlmostEqual(&test, rTM, 0.9952070286010416);

    caps_fresnel(caps, 1000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9952070286010416);
    AssertAlmostEqual(&test, rTM, 0.9952070286010416);

    caps_fresnel(caps, 1000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9952070286010416);
    AssertAlmostEqual(&test, rTM, 0.9952070286010416);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9952070286010392);
    AssertAlmostEqual(&test, rTM, 0.9952070286010439);

    caps_fresnel(caps, 1000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9952070286008026);
    AssertAlmostEqual(&test, rTM, 0.9952070286012806);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9952070285771343);
    AssertAlmostEqual(&test, rTM, 0.9952070286249489);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9952070262103134);
    AssertAlmostEqual(&test, rTM, 0.9952070309917685);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.995206789534171);
    AssertAlmostEqual(&test, rTM, 0.9952072676560172);

    caps_fresnel(caps, 1000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9951831810707509);
    AssertAlmostEqual(&test, rTM, 0.9952307583471078);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9932284561547626);
    AssertAlmostEqual(&test, rTM, 0.9966084670935594);

    caps_fresnel(caps, 1000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9528670140848164);
    AssertAlmostEqual(&test, rTM, 0.9995219122380034);

    caps_fresnel(caps, 1000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6212831546445051);
    AssertAlmostEqual(&test, rTM, 0.9999505920019873);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03993083299880097);
    AssertAlmostEqual(&test, rTM, 0.9999874984760788);

    caps_fresnel(caps, 10000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9607322815946349);
    AssertAlmostEqual(&test, rTM, 0.9607322815946349);

    caps_fresnel(caps, 10000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9607322815946349);
    AssertAlmostEqual(&test, rTM, 0.9607322815946349);

    caps_fresnel(caps, 10000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9607322815946349);
    AssertAlmostEqual(&test, rTM, 0.9607322815946349);

    caps_fresnel(caps, 10000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9607322815946346);
    AssertAlmostEqual(&test, rTM, 0.960732281594635);

    caps_fresnel(caps, 10000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9607322815946155);
    AssertAlmostEqual(&test, rTM, 0.9607322815946541);

    caps_fresnel(caps, 10000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9607322815927107);
    AssertAlmostEqual(&test, rTM, 0.9607322815965589);

    caps_fresnel(caps, 10000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9607322814022283);
    AssertAlmostEqual(&test, rTM, 0.9607322817870413);

    caps_fresnel(caps, 10000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9607322623539892);
    AssertAlmostEqual(&test, rTM, 0.9607323008352712);

    caps_fresnel(caps, 10000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9607303575796227);
    AssertAlmostEqual(&test, rTM, 0.9607342055172677);

    caps_fresnel(caps, 10000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.960540373076947);
    AssertAlmostEqual(&test, rTM, 0.9609232753844565);

    caps_fresnel(caps, 10000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9449257839727582);
    AssertAlmostEqual(&test, rTM, 0.9720674101900894);

    caps_fresnel(caps, 10000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.670354331861994);
    AssertAlmostEqual(&test, rTM, 0.9959435677173295);

    caps_fresnel(caps, 10000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05556848563178083);
    AssertAlmostEqual(&test, rTM, 0.9991038390080458);

    caps_fresnel(caps, 100000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6775428056060097);
    AssertAlmostEqual(&test, rTM, 0.6775428056060097);

    caps_fresnel(caps, 100000, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6775428056060097);
    AssertAlmostEqual(&test, rTM, 0.6775428056060097);

    caps_fresnel(caps, 100000, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6775428056060097);
    AssertAlmostEqual(&test, rTM, 0.6775428056060097);

    caps_fresnel(caps, 100000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6775428056060097);
    AssertAlmostEqual(&test, rTM, 0.6775428056060098);

    caps_fresnel(caps, 100000, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6775428056060084);
    AssertAlmostEqual(&test, rTM, 0.677542805606011);

    caps_fresnel(caps, 100000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6775428056058794);
    AssertAlmostEqual(&test, rTM, 0.6775428056061399);

    caps_fresnel(caps, 100000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.677542805592986);
    AssertAlmostEqual(&test, rTM, 0.6775428056190335);

    caps_fresnel(caps, 100000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6775428043036372);
    AssertAlmostEqual(&test, rTM, 0.6775428069083821);

    caps_fresnel(caps, 100000, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6775426753688117);
    AssertAlmostEqual(&test, rTM, 0.6775429358431653);

    caps_fresnel(caps, 100000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6775297823443511);
    AssertAlmostEqual(&test, rTM, 0.6775558284428077);

    caps_fresnel(caps, 100000, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6762450372613529);
    AssertAlmostEqual(&test, rTM, 0.6788363685652938);

    caps_fresnel(caps, 100000, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5785904806533552);
    AssertAlmostEqual(&test, rTM, 0.756838950252106);

    caps_fresnel(caps, 100000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05733101837211198);
    AssertAlmostEqual(&test, rTM, 0.9204127924917331);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05807869275950605);
    AssertAlmostEqual(&test, rTM, 0.05807869275950605);

    caps_fresnel(caps, 1e+06, 1e-05, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05807869275950605);
    AssertAlmostEqual(&test, rTM, 0.05807869275950605);

    caps_fresnel(caps, 1e+06, 0.0001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05807869275950605);
    AssertAlmostEqual(&test, rTM, 0.05807869275950605);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05807869275950605);
    AssertAlmostEqual(&test, rTM, 0.05807869275950605);

    caps_fresnel(caps, 1e+06, 0.01, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05807869275950604);
    AssertAlmostEqual(&test, rTM, 0.05807869275950605);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05807869275950553);
    AssertAlmostEqual(&test, rTM, 0.05807869275950656);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05807869275945434);
    AssertAlmostEqual(&test, rTM, 0.05807869275955775);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05807869275433578);
    AssertAlmostEqual(&test, rTM, 0.05807869276467632);

    caps_fresnel(caps, 1e+06, 100, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05807869224247874);
    AssertAlmostEqual(&test, rTM, 0.05807869327653335);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05807864105682106);
    AssertAlmostEqual(&test, rTM, 0.05807874446219072);

    caps_fresnel(caps, 1e+06, 10000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05807352294817292);
    AssertAlmostEqual(&test, rTM, 0.05808386256772413);

    caps_fresnel(caps, 1e+06, 100000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05756624267702897);
    AssertAlmostEqual(&test, rTM, 0.05859111223704998);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03074894098636187);
    AssertAlmostEqual(&test, rTM, 0.08532166756813654);

    caps_free(caps);

    return test_results(&test, stderr);
}
