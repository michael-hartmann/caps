#include "libcasimir.h"
#include "unittest.h"

#include "test_logdet_HT.h"

double data[][5] =
{
    /* L/R, m, lmax, EE, MM */
    { 1, 0, 30, -0.039359509611808, -0.020914358073834 },
    { 1, 1, 30, -0.020914358073834, -0.011383372269677 },
    { 1, 2, 30, -0.0014890154006822, -0.0010439636682519 },
    { 1, 3, 30, -0.00010684253505352, -8.3068160092048e-05 },
    { 1, 4, 30, -7.6706194831114e-06, -6.3114778894253e-06 },
    { 1, 5, 30, -5.5072400278604e-07, -4.6967304805243e-07 },

    { 0.5, 0, 30, -0.11933466080803, -0.066894561496325 },
    { 0.5, 1, 30, -0.066894561496325, -0.039189251736552 },
    { 0.5, 2, 30, -0.0095534474374675, -0.0070091590402225 },
    { 0.5, 3, 30, -0.0013895949379127, -0.0011164478044288 },
    { 0.5, 4, 30, -0.00020264950726963, -0.00017108137032858 },
    { 0.5, 5, 30, -2.956425727734e-05, -2.5751203034666e-05 },

    { 0.1, 0, 70, -0.75828376979107, -0.49961137357808 },
    { 0.1, 1, 70, -0.49961137357808, -0.3573053616443 },
    { 0.1, 2, 70, -0.19269085420424, -0.15998670819642 },
    { 0.1, 3, 70, -0.077455287593816, -0.068141090725342 },
    { 0.1, 4, 70, -0.031594057315748, -0.028649692906629 },
    { 0.1, 5, 70, -0.012960911806234, -0.0119739786861 },
    { 0.1, 10, 70, -0.00015308014069914, -0.00014697822234303 },

    { 0.05, 0, 140, -1.3749797476683, -0.9694233921872 },
    { 0.05, 1, 140, -0.9694233921872, -0.74467655849187 },
    { 0.05, 2, 140, -0.4771458271671, -0.41345956145742 },
    { 0.05, 3, 140, -0.24510602026388, -0.22243384729425 },
    { 0.05, 4, 140, -0.12822540178201, -0.11916294785761 },
    { 0.05, 5, 140, -0.067670093717447, -0.063797765614983 },
    { 0.05, 10, 140, -0.002873275570792, -0.0027885662851516 },
    { 0.05, 20, 140, -5.2645534486518e-06, -5.1854350584135e-06 },

    { 0.01, 0, 700, -4.3048450418521, -3.4532099788902 },
    { 0.01, 1, 700, -3.4532099788902, -2.9812019427519 },
    { 0.01, 2, 700, -2.3904996551467, -2.2135940506283 },
    { 0.01, 3, 700, -1.71054769975, -1.6265233090635 },
    { 0.01, 4, 700, -1.245489510134, -1.200199258596 },
    { 0.01, 5, 700, -0.91650602436872, -0.89015700648576 },
    { 0.01, 10, 700, -0.2120863667775, -0.20911973313748 },
    { 0.01, 20, 700, -0.012389178792763, -0.0123028576521 },

    { -1, -1, -1, -1, -1}
};

static void _logdet(double LbyR, int m, int lmax, double *EE, double *MM)
{
    casimir_t casimir;

    casimir_init(&casimir, LbyR, 1);
    casimir_set_lmax(&casimir, lmax);
    casimir_logdetD0(&casimir, m, EE, MM);
    casimir_free(&casimir);
}

int test_logdet_HT(void)
{
    unittest_t test;
    unittest_init(&test, "logdetD (HT)", "calculate logdetD for T→∞");

    for(int i = 0; ; i++)
    {
        double LbyR, EE_correct, MM_correct, EE_computed = 0, MM_computed = 0;
        int lmax,m;
        
        LbyR = data[i][0];
        m    = data[i][1];
        lmax = data[i][2];
        EE_correct = data[i][3];
        MM_correct = data[i][4];

        if(LbyR <= 0)
            break;

        _logdet(LbyR, m, lmax, &EE_computed, &MM_computed);

        AssertAlmostEqual(&test, EE_correct, EE_computed);
        AssertAlmostEqual(&test, MM_correct, MM_computed);
    }

    return test_results(&test, stderr);
}
