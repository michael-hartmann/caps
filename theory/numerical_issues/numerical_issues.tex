\documentclass[superscriptaddress,prb]{revtex4-1}

\usepackage[english]{babel}
\usepackage[utf8]{inputenc}
\usepackage{amssymb,amsmath}
\usepackage{prettyref}
\usepackage{bbm}
\usepackage{txfonts}

\usepackage[babel]{csquotes}
\usepackage[hidelinks]{hyperref}

\newcommand{\imag}{i} % imaginary unit
\newcommand{\e}{e}    % euler's number
\newcommand{\sol}{\mathrm{c}} % speed of light
\DeclareMathOperator{\trace}{tr}

% real/imaginary part
\renewcommand{\Re}{\mathrm{Re}}
\renewcommand{\Im}{\mathrm{Im}}

% TE, TM
\newcommand{\TE}{\mathrm{TE}}
\newcommand{\TM}{\mathrm{TM}}

\newcommand{\Plm}[2]{{\text{P}_{#1}^{#2}}}

\newcommand{\lmax}{{\ell_\text{max}}}
\newcommand{\tmax}{{\text{max}}}

\renewcommand{\vec}[1]{{\mathbf{#1}}}


\begin{document}

\title{Numerical issues in the plane-sphere geometry within the multipole-approach}

\author{Michael Hartmann}
\affiliation{Universität Augsburg, Institut für Physik, 86135 Augsburg, Germany}

\date{\today}

\begin{abstract}
We briefly describe how to evaluate the integration over the wavevector $k$ in the plane-sphere geometry.
\end{abstract}

\maketitle
\section{Integration}

In this document we briefly describe how to evaluate the integration over $k$.
After substitution, the problem is to calculate the integrals
\begin{align}
\label{eq:A}
A_{\ell_1,\ell_2,p}^{m}(\tau) &= A_0 \int_0^\infty \mathrm{d}z \, r_p \, \frac{\e^{-\tau z}}{z^2+2z} \, \Plm{\ell_1}{m}(1+z) \Plm{\ell_2}{m}(1+z), \\
\label{eq:B}
B_{\ell_1,\ell_2,p}^{m}(\tau) &= B_0 \int_0^\infty \mathrm{d}z \, r_p \, \e^{-\tau z} \, (z^2+2z) \, \Plm{\ell_1}{m}^\prime(1+z) \Plm{\ell_2}{m}^\prime(1+z), \\
\label{eq:C}
C_{\ell_1,\ell_2,p}^{m}(\tau) &= C_0 \int_0^\infty \mathrm{d}z \, r_p \, \e^{-\tau z} \, \Plm{\ell_1}{m}(1+z) \Plm{\ell_2}{m}^\prime(1+z), \\
\label{eq:D}
D_{\ell_1,\ell_2,p}^{m}(\tau) &= (-1)^{\ell_1+\ell_2+1} C_{\ell_2\ell_1,p}^{m},
\end{align}
where
\begin{align}
A_0 &= (-1)^{\ell_2+m} \Lambda_{\ell_1,\ell_2}^m m^2 \e^{-\tau}, \\
B_0 &= (-1)^{\ell_2+m+1} \Lambda_{\ell_1,\ell_2}^m \e^{-\tau}, \\
C_0 &= (-1)^{\ell_2+m} \Lambda_{\ell_1,\ell_2}^m \imag m \e^{-\tau},
\end{align}
and $\tau \equiv 2nT$. The prefactor $\Lambda_{\ell_1,\ell_2}^m$ is defined as
\begin{equation}
\Lambda_{\ell_1,\ell_2}^m = -2 \frac{N_{\ell_1}^m N_{\ell_2}^m}{\sqrt{\ell_1 (\ell_1+1) \ell_2 (\ell_2+1)}},
\end{equation}
and
\begin{equation}
N_\ell^m = \sqrt{\frac{2\ell+1}{2} \frac{(\ell-m)!}{(\ell+m)!}}
\end{equation}
is the normalizing factor of spherical harmonics.
The integrals \eqref{eq:A}--\eqref{eq:D} are identical to (6.11)--(6.14) in
\cite{hartmann} after the substitution $z = x/\tau$.


\subsection{Eliminating the derivatives}

Using the recurrence relation \eqref{appendix:dPlm} we can express derivatives
of associated Legendre polynomials as a sum of associated Legendre polynomials:
\begin{align}
\frac{A_{\ell_1,\ell_2,p}^{m}}{A_0} =& \mathcal{I}_{\ell_1,\ell_2,p}^{m} \\
\frac{B_{\ell_1,\ell_2,p}^{m}}{B_0} =& \frac{(\ell_1+1)(\ell_1+m)(\ell_2+1)(\ell_2+m)}{(2\ell_1+1)(2\ell_2+1)} \mathcal{I}_{\ell_1-1,\ell_2-1,p}^{m} \nonumber \\
                                     & -\frac{\ell_1(\ell_1-m+1)(\ell_2+1)(\ell_2+m)}{(2\ell_1+1)(2\ell_2+1)} \mathcal{I}_{\ell_1+1,\ell_2-1,p}^{m} \nonumber \\
                                     & - \frac{(\ell_1+1)(\ell_1+m)\ell_2(\ell_2-m+1)}{(2\ell_1+1)(2\ell_2+1)} \mathcal{I}_{\ell_1-1,\ell_2+1,p}^{m} \nonumber \\
                                     & + \frac{\ell_1(\ell_1-m+1)\ell_2(\ell_2-m+1)}{(2\ell_1+1)(2\ell_2+1)} \mathcal{I}_{\ell_1+1,\ell_2+1,p}^{m} \\
\frac{C_{\ell_1,\ell_2,p}^{m}}{C_0} =&  \frac{\ell_2 (\ell_2-m+1)}{2\ell_2+1} \mathcal{I}_{\ell_1,\ell_2+1,p}^{m} - \frac{(\ell_2+1)(\ell_2+m)}{2\ell_2+1} \mathcal{I}_{\ell_1,\ell_2-1,p}^{m}
\end{align}
where we have defined
\begin{equation}
\mathcal{I}_{\ell_1,\ell_2,p}^{m}(\tau) = \int_0^\infty \mathrm{d}z \, r_p \, \frac{\e^{-\tau z}}{z^2+2z} \, \Plm{\ell_1}{m}(1+z) \Plm{\ell_2}{m}(1+z) \,.
\end{equation}
So, we reduced the problem of calculating the integrals $A,B,C,D$ to the
problem of calculating the integral $\mathcal{I}$. The integral is symmetric
with respect to $\ell_1$ and $\ell_2$
\begin{equation}
\mathcal{I}_{\ell_1,\ell_2,p}^{m} = \mathcal{I}_{\ell_2,\ell_1,p}^{m} \,.
\end{equation}

Using Gaunt coefficients a product of associated Legendre polynomials can be
expressed as a sum of associated Legendre polynomials \cite{gaunt}
\begin{equation}
\Plm{\ell_1}{m}(x) \Plm{\ell_2}{m}(x) = a_0 \sum_{q=0}^{q_\tmax} \tilde a_q \Plm{\ell_1+\ell_2-2q}{2m}(x) \,.
\end{equation}
Thus we can express the integral $\mathcal{I}_{\ell_1,\ell_2,p}^{m}$ as
\begin{align}
\nonumber
\mathcal{I}_{\ell_1,\ell_2,p}^{m}(\tau) &= \int_0^\infty \mathrm{d}z \, r_p \, \frac{\e^{-\tau z}}{z^2+2z} \, \Plm{\ell_1}{m}(1+z) \Plm{\ell_2}{m}(1+z) \\
& = a_0 \sum_{q=0}^{q_\tmax} \tilde a_q \, \mathcal{K}_{\ell_1+\ell_2-2q}^{2m}(1+z)
\end{align}
where we have defined
\begin{equation}
\mathcal{K}_{\nu,p}^m = \int_0^\infty \mathrm{d}z \, r_p \frac{\e^{-\tau z}}{z^2+2z} \Plm{\nu}{2m}(1+z) \,.
\end{equation}
The advantage is that for a scattering matrix $\mathcal{M}^m(\xi)$ we only have
to evaluate $\mathcal{O}(\lmax)$ instead of $\mathcal{O}(\ell_\tmax^2)$
integrals.

\subsection{Shape of integrand}

To estimate the shape and the maximum of $\mathcal{K}_{\nu,p}^m$ we assume that
the Fresnel coefficient $r_p$ varies slowly and ignore it.

\subsubsection{Large values}
For large values of $z$ we can approximate the integrand of
$\mathcal{K}_{\nu,p}^m$ using \eqref{appendix:Plm_gg}
\begin{equation}
k(z) = r_p \frac{\e^{-\tau z}}{z^2+2z} \Plm{\nu}{2m}(1+z) \overset{z \gg 1}{\approx} c \e^{-\tau z} z^\nu ,
\end{equation}
where $c$ is a constant. We find that the maximum of the integrand is
approximately at $z_\tmax \approx \nu/\tau$. As
\begin{equation}
\Plm{\nu}{2m}(1+z_\tmax) \approx \frac{(2\nu)!}{2^\nu \, \nu! \, (\nu-2m)!} z_\tmax^\nu
\end{equation}
the integrand at $z_\tmax$ is approximately
\begin{equation}
k(z_\tmax) \approx \frac{(2\nu)!}{2^\nu \nu! (\nu-2m)!} \e^{-\tau z_\tmax} z_\tmax^\nu \,.
\end{equation}

\subsubsection{Small values}
For small values of $z$ we can approximate the integrand of
$\mathcal{K}_{\nu,p}^m$ using \eqref{appendix:Plm_1}
\begin{equation}
k(z) = r_p \frac{\e^{-\tau z}}{z^2+2z} \Plm{\nu}{2m}(1+z) \overset{z \ll 1}{\approx} c \e^{-\tau z} z^{m-1}
\end{equation}
where $c$ is a constant. The maximum of the integrand is approximately at $z_\tmax \approx m/\tau$ and the
integrand at $z_\tmax$ is approximately
\begin{equation}
k(z_\tmax) \approx \frac{(\nu+2m)!}{(2m)! \, (\nu-2m)!} \frac{\e^{-\tau z_\tmax}}{z^2+2z} \left(\frac{z}{2}\right)^m \,.
\end{equation}


\section{Mie coefficients}

The Mie coefficients for complex frequencies are given by
\begin{align}
a_\ell(\imag\chi) &= (-1)^{\ell+1} \frac{\pi}{2} \frac{n^2 s_\ell^{(a)} - s_\ell^{(b)}}{n^2 s_\ell^{(c)} - s_\ell^{(d)}} \\
b_\ell(\imag\chi) &= (-1)^{\ell+1} \frac{\pi}{2} \frac{s_\ell^{(a)} - s_\ell^{(b)}}{s_\ell^{(c)} - s_\ell^{(d)}}
\end{align}
using the abbrevations
\begin{align}
s_\ell^{(a)} &= I_{\ell+1/2}(n\chi) \left[\ell I_{\ell+1/2}(\chi)  -  \chi I_{\ell-1/2}(\chi) \right], \\
s_\ell^{(b)} &= I_{\ell+1/2}(\chi)  \left[\ell I_{\ell+1/2}(n\chi) - n\chi I_{\ell-1/2}(n\chi)\right], \\
s_\ell^{(c)} &= I_{\ell+1/2}(n\chi) \left[\ell K_{\ell+1/2}(\chi)  +  \chi K_{\ell-1/2}(\chi) \right], \\
s_\ell^{(d)} &= K_{\ell+1/2}(\chi)  \left[\ell I_{\ell+1/2}(n\chi) - n\chi I_{\ell-1/2}(n\chi)\right] \,.
\end{align}
Here, $n=\sqrt{\epsilon}$ denotes the refraction index, and $\chi=\xi R/\sol$. However, it is easier to express
the Mie coefficients as
\begin{align}
a_\ell(\imag\chi) &= (-1)^\ell \frac{\pi}{2} \frac{\gamma^{(a)}_\ell-\gamma^{(b)}_\ell}{\gamma^{(c)}_\ell+\gamma^{(d)}_\ell} \\
b_\ell(\imag\chi) &= (-1)^{\ell+1} \frac{\pi}{2} \frac{\gamma^{(b)}_\ell}{\gamma^{(d)}_\ell}
\end{align}
with
\begin{align}
\gamma_\ell^{(a)} &= (n^2-1) I_{\ell+1/2}(n\chi) I_{\ell+1/2}(\chi) \left[\chi \frac{I_{\ell-1/2}(\chi)}{I_{\ell+1/2)}(\chi)} - \ell\right], \\
\gamma_\ell^{(b)} &= I_{\ell+1/2}(n\chi) I_{\ell+1/2}(\chi) \left[n\chi\frac{I_{\ell-1/2}(n\chi)}{I_{\ell+1/2}(n\chi)}-\chi\frac{I_{\ell-1/2}(\chi)}{I_{\ell+1/2}(\chi)}\right], \\
\gamma_\ell^{(c)} &= (n^2-1) I_{\ell+1/2}(n\chi) \left[\ell K_{\ell+1/2}(\chi) + \chi K_{\ell-1/2}(\chi)\right], \\
\gamma_\ell^{(d)} &= \chi \left[I_{\ell+1/2}(n\chi) K_{\ell-1/2}(\chi) + n K_{\ell+1/2}(\chi) I_{\ell-1/2}(n\chi)\right] \,.
\end{align}
The modified Bessel functions $I_\nu(x)$ and $K_\nu(x)$ are positive for $x \ge
0$. Therefore, $\gamma_\ell^{(c)}$ and $\gamma_\ell^{(d)}$ are positive.
The fractions of $\gamma_\ell^{(b)}$ can be calculated using a continued
fraction.

Defining
\begin{equation}
g_\nu(x) = x \frac{I_\nu(x)}{I_{\nu+1}(x)}
\end{equation}
we find for $x\to0$
\begin{equation}
\lim_{x\to0} g_\nu(x) = 2(\nu+1)
\end{equation}
and for $x\to\infty$
\begin{equation}
\lim_{x\to\infty} g_\nu(x) = x \,.
\end{equation}
Using the Mittag Leffler expansion
\begin{equation}
\frac{1}{x} \frac{I_{\nu+1}(x)}{I_\nu(x)} = g_\nu^{-1}(x) = \sum_{k=0}^\infty \frac{2}{J_{\nu,k}^2+x^2}
\end{equation}
we find for the derivative
\begin{equation}
\frac{\mathrm{d}}{\mathrm{d}x} g_\nu^{-1}(x) = -\frac{1}{g_\nu^2(x)} \frac{\mathrm{d}}{\mathrm{d}x} g_\nu(x) = \sum_{k=0}^\infty \frac{-4x}{\left(J_{\nu,k}^2+x^2\right)^2}
\end{equation}
and thus
\begin{equation}
\frac{\mathrm{d}}{\mathrm{d}x} g_\nu(x) = g_\nu^2(x) \sum_{k=0}^\infty \frac{4x}{(J^2_{\nu,k}+x^2)^2} > 0 \,.
\end{equation}

Combining both results we find $g_\nu(x) \ge 2(\nu+1)$ and thus
$\gamma_\ell^{(a)} > 0$. Also, as the derivative is always positive, it is easy
to see that $\gamma_\ell^{(b)}$ is also positive.
The difference is given by
\begin{equation}
\gamma_\ell^{(a)} - \gamma_\ell^{(b)} = I_{\ell+1/2}(n\chi) I_{\ell+1/2}(\chi) \left[ n^2 g_{\ell-1/2}(\chi) - (n^2-1)\ell - g_{\ell-1/2}(n\chi) \right] \,.
\end{equation}
As $g_\nu(x)$ is a monotonic function, the ratio $g_\nu(nx)/g_\nu(x)$ for $n>1$
is also monotonic and the maximum is obtained for $n\to\infty$
\begin{equation}
\frac{g_\nu(nx)}{g_\nu(x)} = n \frac{I_\nu(nx)}{I_{\nu+1}(nx)} \frac{I_{\nu+1}(x)}{I_\nu(x)} \overset{n\gg1}{=} n \frac{I_{\nu+1}(x)}{I_\nu(x)} < n \,.
\end{equation}
The difference becomes with $\nu=\ell-1/2$
\begin{align}
n^2 g_\nu(\chi) - (n^2-1)(\nu+1/2) - g_\nu(n\chi) &> n^2 g_\nu(\chi) -n g_\nu(\chi) - (n^2-1)(\nu+1/2) \\
&> n(n-1) g_\nu(\chi) - (n+1)(n-1)(\nu+1) \\
&= (n-1) \left[ ng_\nu(\chi) - (n+1)(\nu+1) \right] \\
&> (n-1) \left[ 2n(\nu+1) - (n+1)(\nu+1) \right] \\
&= (n-1)(\nu+1) \left[ 2n - (n+1) \right] \\
&= (n-1)^2 (\nu+1) > 0
\end{align}
Moreover,
\begin{equation}
\lim_{\chi\to0} \left[ n^2 g_{\ell-1/2}(\chi) - (n^2-1)\ell - g_{\ell-1/2}(n\chi) \right] = (n^2-1)(\ell+1) > 0
\end{equation}
and
\begin{equation}
\lim_{\chi\to\infty} \left[ n^2 g_{\ell-1/2}(\chi) - (n^2-1)\ell - g_{\ell-1/2}(n\chi) \right] = n\chi(n-1)
\end{equation}
Thus, $\gamma_\ell^{(a)}-\gamma_\ell^{(b)} > 0$.

So, the Mie coefficients are:
\begin{align}
a_\ell(\chi) &= (-1)^\ell | a_\ell(\chi) | \\
b_\ell(\chi) &= (-1)^{\ell+1} | b_\ell(\chi) |
\end{align}

\section{Calculating the determinant}

In order to calculate
\begin{equation}
\log\det\mathcal{D} = \trace\log\mathcal{D}
\end{equation}
one has to perform a LU decomposition:
\begin{equation}
\log\det\mathcal{D} = \log\det\left(PLU\right) = \log\left(\det L + \det U\right) = \log\left(\prod_j L_{jj} U_{jj}\right) = \sum_j \log\left(L_{jj} U_{jj}\right)
\end{equation}

If the value of the determinant is small, one may also make use of the mercator series
\begin{equation}
\trace\log \mathcal{D} = \trace\log\left(\mathbbm{1}-\mathcal{M}\right) = \sum_{k=1}^\infty \frac{1}{k} \trace\mathcal{M}^k \,.
\end{equation}
The first two terms can be calculated in $\mathcal{O}(N^2)$ steps, where $N$ is the dimension of the round-trip matrix:
\begin{equation}
\trace\log\mathcal{D} = \trace\mathcal{M} + \frac{1}{2} \trace\mathcal{M}^2 + E \,.
\end{equation}
The error can be estimated
\begin{align}
|E| &=  \left|\sum_{k=3}^\infty \frac{\trace\mathcal{M}^k}{k}\right|
\le \sum_{k=3}^\infty \frac{1}{k} \left| \trace\mathcal{M}^k \right|
= \sum_{k=3}^\infty \frac{1}{k} \left| \sum_j \lambda_j^k \right|
\le \sum_{k=3}^\infty \frac{1}{k} \left(\sum_j |\lambda_j|^2\right)^{k/2}
\le \sum_{k=3}^\infty \frac{1}{k} \left(||\mathcal{M}||_F^2\right)^{k/2} \\
&= \sum_{k=3}^\infty \frac{1}{k} ||\mathcal{M}||_F = -\left[\frac{1}{2}||\mathcal{M}||_F^2+||\mathcal{M}||_F -\log\left(1-||\mathcal{M}||_F\right)\right)
\end{align}
This estimation is true if all eigenvalues $|\lambda_j| < 1$. If the Frobenius
norm is smaller than $1$, then the modulus of all eigenvalues is smaller than
one. So, a sufficient condition is that the Frobenius norm is smaller than $1$.

\section{Fresnel coefficients}
\section{Truncation of the vector space}

\section{Numerical differentiation}

In order to compute the first and second derivative of the free energy we use a
finite difference formula \cite{finitediff} of order 4
\begin{equation}
\label{eq:finitediff1}
f^\prime(x) \approx \frac{f(x-2h) -8f(x-h) + 8f(x+h)  -f(x+2h)}{12h}
\end{equation}
and
\begin{equation}
\label{eq:finitediff2}
f^{\prime\prime}(x) \approx \frac{-f(x-2h) +16f(x-h) -30f(x) + 16f(x+h) -f(x+2h)}{12h^2}
\end{equation}

Using an argument from \cite{NumericalRecipes} for \eqref{eq:finitediff1} the truncation error
is $\epsilon_t \sim h^4 f^{(5)}$ and the roundoff error is $\epsilon_r \sim \epsilon_F |f|/h$ where $\epsilon_F$
is the fractional accuracy with which $f$ is calculated. We find the optimal value of $h$ by looking
for the minimum of $\epsilon_t + \epsilon_r$ anf find:
\begin{equation}
h_\text{opt} \sim \left( \epsilon_F \frac{|f|}{4f^{(5)}} \right)^\frac{1}{5} .
\end{equation}

Assuming perfect reflectors, $T=0$ and that $L/R \ll 1$ so that PFA is valid, the free energy is approximately
\begin{equation}
\mathcal{F}_\text{PFA}^{T=0}\left(x=\frac{L}{R}\right) = -\frac{\pi^3}{720x^2}
\end{equation}
So, we find
\begin{equation}
h_\text{opt} \sim \frac{L}{R} \left(\frac{\epsilon_F}{720}\right)^\frac{1}{5} \,.
\end{equation}

\appendix

\section{Formulae}


\section{Associated Legendre polynomials}

We define associated Legendre polynomials for $x>1$ as
\begin{equation}
\Plm{\ell}{m}(x) = \frac{(-\imag)^m}{2^\ell \ell!} \left(x^2-1\right)^{m/2} \frac{\mathrm{d}^{\ell+m}}{\mathrm{d}x^{\ell+m}} \left(x^2-1\right)^\ell \,.
\end{equation}
The associated Legendre polynomials fullfil many recurrence relations, but we will only need this one:
\begin{equation}
\label{appendix:dPlm}
\frac{\mathrm{d}}{\mathrm{d}x} \Plm{\ell}{m}(x) = \frac{1}{x^2-1} \left[
\frac{\ell(\ell-m+1)}{2\ell+1} \Plm{\ell+1}{m}(x)
-\frac{(\ell+1)(\ell+m)}{2\ell+1} \Plm{\ell-1}{m}(x)
\right]
\end{equation}
For large arguments $x\gg 1$ the associated Legendre polynomials may be approximated by
\begin{equation}
\label{appendix:Plm_gg}
\Plm{\ell}{m}(x) \approx (-\imag)^m \frac{(2\ell)!}{2^\ell \, \ell! \, (\ell-m)!} x^\ell,
\end{equation}
for $x\sim1$ they may be approximated by
\begin{equation}
\label{appendix:Plm_1}
\Plm{\ell}{m}(x) \approx \frac{(\ell+m)!}{m! \, (\ell-m)!} \left(\frac{x-1}{2}\right)^{m/2} \,.
\end{equation}

\addcontentsline{toc}{chapter}{Bibliography}


\begin{thebibliography}{99}

\bibitem{hartmann}
  Michael Hartmann,
  \emph{Negative Casimir entropies in the plane–sphere geometry}, master thesis, 2014

\bibitem{gaunt}
  Yu-lin Xu,
  \emph{Fast evaluation of Gaunt coefficients: recursive approach}, Journal of Computational and Applied Mathematics, 1997

\bibitem{finitediff}
  Bengt Fornberg,
  \emph{Generation of Finite Difference Formulas on Arbitrarily Spaced Grids}, Mathematics of Computation \textbf{51} 184 (1988)

\bibitem{NumericalRecipes}
  William Press, Saul Teukolsky, William Vetterling and Brian Flannery
  \emph{Numerical Recipes in C}, Camebridge University Press (2002)

\end{thebibliography}

\end{document}
